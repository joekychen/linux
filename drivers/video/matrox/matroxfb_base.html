<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › matrox › matroxfb_base.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>matroxfb_base.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Hardware accelerated Matrox Millennium I, II, Mystique, G100, G200 and G400</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 1998-2002 Petr Vandrovec &lt;vandrove@vc.cvut.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Portions Copyright (c) 2001 Matrox Graphics Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Version: 1.65 2002/08/14</span>
<span class="cm"> *</span>
<span class="cm"> * MTRR stuff: 1998 Tom Rini &lt;trini@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Contributors: &quot;menion?&quot; &lt;menion@mindless.com&gt;</span>
<span class="cm"> *                     Betatesting, fixes, ideas</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Kurt Garloff&quot; &lt;garloff@suse.de&gt;</span>
<span class="cm"> *                     Betatesting, fixes, ideas, videomodes, videomodes timmings</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Tom Rini&quot; &lt;trini@kernel.crashing.org&gt;</span>
<span class="cm"> *                     MTRR stuff, PPC cleanups, betatesting, fixes, ideas</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Bibek Sahu&quot; &lt;scorpio@dodds.net&gt;</span>
<span class="cm"> *                     Access device through readb|w|l and write b|w|l</span>
<span class="cm"> *                     Extensive debugging stuff</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Daniel Haun&quot; &lt;haund@usa.net&gt;</span>
<span class="cm"> *                     Testing, hardware cursor fixes</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Scott Wood&quot; &lt;sawst46+@pitt.edu&gt;</span>
<span class="cm"> *                     Fixes</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Gerd Knorr&quot; &lt;kraxel@goldbach.isdn.cs.tu-berlin.de&gt;</span>
<span class="cm"> *                     Betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Kelly French&quot; &lt;targon@hazmat.com&gt;</span>
<span class="cm"> *               &quot;Fernando Herrera&quot; &lt;fherrera@eurielec.etsit.upm.es&gt;</span>
<span class="cm"> *                     Betatesting, bug reporting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Pablo Bianucci&quot; &lt;pbian@pccp.com.ar&gt;</span>
<span class="cm"> *                     Fixes, ideas, betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Inaky Perez Gonzalez&quot; &lt;inaky@peloncho.fis.ucm.es&gt;</span>
<span class="cm"> *                     Fixes, enhandcements, ideas, betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Ryuichi Oikawa&quot; &lt;roikawa@rr.iiij4u.or.jp&gt;</span>
<span class="cm"> *                     PPC betatesting, PPC support, backward compatibility</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Paul Womar&quot; &lt;Paul@pwomar.demon.co.uk&gt;</span>
<span class="cm"> *               &quot;Owen Waller&quot; &lt;O.Waller@ee.qub.ac.uk&gt;</span>
<span class="cm"> *                     PPC betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Thomas Pornin&quot; &lt;pornin@bolet.ens.fr&gt;</span>
<span class="cm"> *                     Alpha betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Pieter van Leuven&quot; &lt;pvl@iae.nl&gt;</span>
<span class="cm"> *               &quot;Ulf Jaenicke-Roessler&quot; &lt;ujr@physik.phy.tu-dresden.de&gt;</span>
<span class="cm"> *                     G100 testing</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;H. Peter Arvin&quot; &lt;hpa@transmeta.com&gt;</span>
<span class="cm"> *                     Ideas</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Cort Dougan&quot; &lt;cort@cs.nmt.edu&gt;</span>
<span class="cm"> *                     CHRP fixes and PReP cleanup</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Mark Vojkovich&quot; &lt;mvojkovi@ucsd.edu&gt;</span>
<span class="cm"> *                     G400 support</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Samuel Hocevar&quot; &lt;sam@via.ecp.fr&gt;</span>
<span class="cm"> *                     Fixes</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Anton Altaparmakov&quot; &lt;AntonA@bigfoot.com&gt;</span>
<span class="cm"> *                     G400 MAX/non-MAX distinction</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Ken Aaker&quot; &lt;kdaaker@rchland.vnet.ibm.com&gt;</span>
<span class="cm"> *                     memtype extension (needed for GXT130P RS/6000 adapter)</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Uns Lider&quot; &lt;unslider@miranda.org&gt;</span>
<span class="cm"> *                     G100 PLNWT fixes</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Denis Zaitsev&quot; &lt;zzz@cd-club.ru&gt;</span>
<span class="cm"> *                     Fixes</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Mike Pieper&quot; &lt;mike@pieper-family.de&gt;</span>
<span class="cm"> *                     TVOut enhandcements, V4L2 control interface.</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Diego Biurrun&quot; &lt;diego@biurrun.de&gt;</span>
<span class="cm"> *                     DFP testing</span>
<span class="cm"> *</span>
<span class="cm"> * (following author is not in any relation with this code, but his code</span>
<span class="cm"> *  is included in this driver)</span>
<span class="cm"> *</span>
<span class="cm"> * Based on framebuffer driver for VBE 2.0 compliant graphic boards</span>
<span class="cm"> *     (c) 1998 Gerd Knorr &lt;kraxel@cs.tu-berlin.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * (following author is not in any relation with this code, but his ideas</span>
<span class="cm"> *  were used when writing this driver)</span>
<span class="cm"> *</span>
<span class="cm"> *		 FreeVBE/AF (Matrox), &quot;Shawn Hargreaves&quot; &lt;shawn@talula.demon.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/version.h&gt;</span>

<span class="cp">#include &quot;matroxfb_base.h&quot;</span>
<span class="cp">#include &quot;matroxfb_misc.h&quot;</span>
<span class="cp">#include &quot;matroxfb_accel.h&quot;</span>
<span class="cp">#include &quot;matroxfb_DAC1064.h&quot;</span>
<span class="cp">#include &quot;matroxfb_Ti3026.h&quot;</span>
<span class="cp">#include &quot;matroxfb_maven.h&quot;</span>
<span class="cp">#include &quot;matroxfb_crtc2.h&quot;</span>
<span class="cp">#include &quot;matroxfb_g450.h&quot;</span>
<span class="cp">#include &lt;linux/matroxfb.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nvram_read_byte</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_NVRAM</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_NVRAM</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">matroxfb_unregister_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span><span class="o">*</span> <span class="n">minfo</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * card parameters</span>
<span class="cm"> */</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">vesafb_defined</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">640</span><span class="p">,</span><span class="mi">480</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="mi">480</span><span class="p">,</span><span class="cm">/* W,H, W, H (virtual) load xres,xres_virtual*/</span>
	<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>		<span class="cm">/* virtual -&gt; visible no offset */</span>
	<span class="mi">8</span><span class="p">,</span>		<span class="cm">/* depth -&gt; load bits_per_pixel */</span>
	<span class="mi">0</span><span class="p">,</span>		<span class="cm">/* greyscale ? */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>	<span class="cm">/* R */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>	<span class="cm">/* G */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>	<span class="cm">/* B */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>	<span class="cm">/* transparency */</span>
	<span class="mi">0</span><span class="p">,</span>		<span class="cm">/* standard pixel format */</span>
	<span class="n">FB_ACTIVATE_NOW</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">FB_ACCELF_TEXT</span><span class="p">,</span>	<span class="cm">/* accel flags */</span>
	<span class="mi">39721L</span><span class="p">,</span><span class="mi">48L</span><span class="p">,</span><span class="mi">16L</span><span class="p">,</span><span class="mi">33L</span><span class="p">,</span><span class="mi">10L</span><span class="p">,</span>
	<span class="mi">96L</span><span class="p">,</span><span class="mi">2L</span><span class="p">,</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span>	<span class="cm">/* No sync info */</span>
	<span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
<span class="p">};</span>



<span class="cm">/* --------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_crtc2</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matroxfb_dh_fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>

	<span class="cm">/* Make sure that displays are compatible */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">==</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
		 <span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">16</span>:
			<span class="k">case</span> <span class="mi">32</span>:
				<span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mga_outl</span><span class="p">(</span><span class="mh">0x3C2C</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
					<span class="n">mga_outl</span><span class="p">(</span><span class="mh">0x3C28</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">mga_outl</span><span class="p">(</span><span class="mh">0x3C28</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">matroxfb_crtc1_panpos</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">panpos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">panpos</span><span class="p">;</span>

		<span class="n">matroxfb_DAC_lock_irqsave</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">panpos</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">panpos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">panpos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extvga_reg</span><span class="p">;</span>

			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">panpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* No update pending anymore */</span>
			<span class="n">extvga_reg</span> <span class="o">=</span> <span class="n">mga_inb</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">);</span>
			<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">panpos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">extvga_reg</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="n">extvga_reg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">matroxfb_DAC_unlock_irqrestore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">matrox_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int32_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">mga_inl</span><span class="p">(</span><span class="n">M_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_ICLEAR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">vsync</span><span class="p">.</span><span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">matroxfb_crtc1_panpos</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">vsync</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_ICLEAR</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">vsync</span><span class="p">.</span><span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">vsync</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">matroxfb_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reenable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int32_t</span> <span class="n">bm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">accelerator</span> <span class="o">==</span> <span class="n">FB_ACCEL_MATROX_MGAG400</span><span class="p">)</span>
		<span class="n">bm</span> <span class="o">=</span> <span class="mh">0x220</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bm</span> <span class="o">=</span> <span class="mh">0x020</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">matrox_irq</span><span class="p">,</span>
				<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;matroxfb&quot;</span><span class="p">,</span> <span class="n">minfo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Clear any pending field interrupts */</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_ICLEAR</span><span class="p">,</span> <span class="n">bm</span><span class="p">);</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_IEN</span><span class="p">,</span> <span class="n">mga_inl</span><span class="p">(</span><span class="n">M_IEN</span><span class="p">)</span> <span class="o">|</span> <span class="n">bm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reenable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int32_t</span> <span class="n">ien</span><span class="p">;</span>

		<span class="n">ien</span> <span class="o">=</span> <span class="n">mga_inl</span><span class="p">(</span><span class="n">M_IEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ien</span> <span class="o">&amp;</span> <span class="n">bm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;matroxfb: someone disabled IRQ [%08X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ien</span><span class="p">);</span>
			<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_IEN</span><span class="p">,</span> <span class="n">ien</span> <span class="o">|</span> <span class="n">bm</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">matroxfb_disable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Flush pending pan-at-vbl request... */</span>
		<span class="n">matroxfb_crtc1_panpos</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">accelerator</span> <span class="o">==</span> <span class="n">FB_ACCEL_MATROX_MGAG400</span><span class="p">)</span>
			<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_IEN</span><span class="p">,</span> <span class="n">mga_inl</span><span class="p">(</span><span class="n">M_IEN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x220</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_IEN</span><span class="p">,</span> <span class="n">mga_inl</span><span class="p">(</span><span class="n">M_IEN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">minfo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">matroxfb_wait_for_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="n">u_int32_t</span> <span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_vsync</span> <span class="o">*</span><span class="n">vs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">vs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">vsync</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">accelerator</span> <span class="o">!=</span> <span class="n">FB_ACCEL_MATROX_MGAG400</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">vsync</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">matroxfb_enable_irq</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">vs</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">vs</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">!=</span> <span class="n">vs</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">,</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">matroxfb_enable_irq</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">matrox_pan_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vbl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">CRITFLAGS</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span><span class="p">)</span> <span class="o">*</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">final_bppShift</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">ydstorg</span><span class="p">.</span><span class="n">chunks</span><span class="p">;</span>
	<span class="n">p0</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x0D</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">p1</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x0C</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">p2</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xB0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">p3</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">;</span>

	<span class="cm">/* FB_ACTIVATE_VBL and we can acquire interrupts? Honor FB_ACTIVATE_VBL then... */</span>
	<span class="n">vbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_VBL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">matroxfb_enable_irq</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">CRITBEGIN</span>

	<span class="n">matroxfb_DAC_lock_irqsave</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_CRTC_INDEX</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="n">p0</span><span class="p">);</span>
	<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_CRTC_INDEX</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="n">p1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">support32MB</span><span class="p">)</span>
		<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">p3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">panpos</span> <span class="o">=</span> <span class="n">p2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Abort any pending change */</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">panpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">p2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">matroxfb_DAC_unlock_irqrestore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">update_crtc2</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>

	<span class="n">CRITEND</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">matroxfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Currently we are holding big kernel lock on all dead &amp; usecount updates.</span>
<span class="cm">	 * Destroy everything after all users release it. Especially do not unregister</span>
<span class="cm">	 * framebuffer and iounmap memory, neither fbmem nor fbcon-cfb* does not check</span>
<span class="cm">	 * for device unplugged when in use.</span>
<span class="cm">	 * In future we should point mmio.vbase &amp; video.vbase somewhere where we can</span>
<span class="cm">	 * write data without causing too much damage...</span>
<span class="cm">	 */</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">dead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">usecount</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* destroy it later */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">matroxfb_unregister_device</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">);</span>
	<span class="n">matroxfb_g450_shutdown</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mtrr</span><span class="p">.</span><span class="n">vram_valid</span><span class="p">)</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mtrr</span><span class="p">.</span><span class="n">vram</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">mga_iounmap</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">vbase</span><span class="p">);</span>
	<span class="n">mga_iounmap</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len_maximum</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">16384</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Open/Release the frame buffer device</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span> <span class="o">=</span> <span class="n">info2minfo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">DBG_LOOP</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">usecount</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">userusecount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span> <span class="o">=</span> <span class="n">info2minfo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">DBG_LOOP</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="o">--</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">userusecount</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">matroxfb_disable_irq</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">--</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">usecount</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">matroxfb_remove</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span><span class="o">*</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span> <span class="o">=</span> <span class="n">info2minfo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">matrox_pan_var</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_get_final_bppShift</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bppshft2</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">bppshft2</span> <span class="o">=</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bppshft2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isInterleave</span><span class="p">(</span><span class="n">minfo</span><span class="p">))</span>
		<span class="n">bppshft2</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">video64bits</span><span class="p">)</span>
		<span class="n">bppshft2</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bppshft2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_test_and_set_rounding</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">over</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rounding</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="k">return</span> <span class="n">xres</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:		<span class="n">rounding</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:		<span class="n">rounding</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>	<span class="cm">/* doc says 64; 32 is OK for G400 */</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:	<span class="n">rounding</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>:	<span class="n">rounding</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>	<span class="cm">/* doc says 64; 32 is OK for G400 */</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="n">rounding</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
				<span class="cm">/* on G400, 16 really does not work */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">accelerator</span> <span class="o">==</span> <span class="n">FB_ACCEL_MATROX_MGAG400</span><span class="p">)</span>
					<span class="n">rounding</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isInterleave</span><span class="p">(</span><span class="n">minfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rounding</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">over</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">%</span> <span class="n">rounding</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">over</span><span class="p">)</span>
		<span class="n">xres</span> <span class="o">+=</span> <span class="n">rounding</span><span class="o">-</span><span class="n">over</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">xres</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_pitch_adjust</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xres</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="n">width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xres_new</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bpp</span><span class="p">)</span> <span class="k">return</span> <span class="n">xres</span><span class="p">;</span>

	<span class="n">width</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">vxres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">precise_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">xres</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">matroxfb_test_and_set_rounding</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">bpp</span><span class="p">)</span> <span class="o">==</span> <span class="o">*</span><span class="n">width</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">width</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">xres_new</span> <span class="o">=</span> <span class="o">*</span><span class="n">width</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xres_new</span> <span class="o">=</span> <span class="n">matroxfb_test_and_set_rounding</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">xres_new</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_get_cmap_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* pseudocolor... 16 entries HW palette */</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="k">return</span> <span class="mi">256</span><span class="p">;</span>	<span class="cm">/* pseudocolor... 256 entries HW palette */</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* directcolor... 16 entries SW palette */</span>
					<span class="cm">/* Mystique: truecolor, 16 entries SW palette, HW palette hardwired into 1:1 mapping */</span>
		<span class="k">case</span> <span class="mi">24</span>:
			<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* directcolor... 16 entries SW palette */</span>
					<span class="cm">/* Mystique: truecolor, 16 entries SW palette, HW palette hardwired into 1:1 mapping */</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* directcolor... 16 entries SW palette */</span>
					<span class="cm">/* Mystique: truecolor, 16 entries SW palette, HW palette hardwired into 1:1 mapping */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* return something reasonable... or panic()? */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_decode_var</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">visual</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">video_cmap_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">ydstorg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">RGBT</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bpp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="n">length</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">red</span><span class="p">,</span>
		  <span class="n">green</span><span class="p">,</span>
		  <span class="n">blue</span><span class="p">,</span>
		  <span class="n">transp</span><span class="p">;</span>
		<span class="kt">signed</span> <span class="kt">char</span> <span class="n">visual</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">RGBT</span> <span class="n">table</span><span class="p">[]</span><span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">8</span><span class="p">,{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span><span class="n">MX_VISUAL_PSEUDOCOLOR</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">15</span><span class="p">,{</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">},{</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">},{</span><span class="mi">15</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span><span class="n">MX_VISUAL_DIRECTCOLOR</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">16</span><span class="p">,{</span><span class="mi">11</span><span class="p">,</span><span class="mi">5</span><span class="p">},{</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">},{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span><span class="n">MX_VISUAL_DIRECTCOLOR</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">24</span><span class="p">,{</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span><span class="n">MX_VISUAL_DIRECTCOLOR</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">32</span><span class="p">,{</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">24</span><span class="p">,</span><span class="mi">8</span><span class="p">},</span><span class="n">MX_VISUAL_DIRECTCOLOR</span><span class="p">}</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">RGBT</span> <span class="k">const</span> <span class="o">*</span><span class="n">rgbt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vramlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">memlen</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>:	 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">cfb4</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			 <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:	 <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>: <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>: <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>: <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ydstorg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vramlen</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len_usable</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">matroxfb_pitch_adjust</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
	<span class="n">memlen</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memlen</span> <span class="o">&gt;</span> <span class="n">vramlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">vramlen</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">);</span>
		<span class="n">memlen</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* There is hardware bug that no line can cross 4MB boundary */</span>
	<span class="cm">/* give up for CFB24, it is impossible to easy workaround it */</span>
	<span class="cm">/* for other try to do something */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">cross4MB</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">memlen</span> <span class="o">&gt;</span> <span class="mh">0x400000</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* sorry */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">linelen</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">linelen</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m2</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>	<span class="cm">/* or 128 if you do not need PAGE ALIGNED address */</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_yres</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">m1</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>

				<span class="k">while</span> <span class="p">(</span><span class="n">m2</span> <span class="o">&gt;=</span> <span class="n">m1</span><span class="p">)</span> <span class="n">m2</span> <span class="o">-=</span> <span class="n">m1</span><span class="p">;</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">m1</span><span class="p">;</span>
				<span class="n">m1</span> <span class="o">=</span> <span class="n">m2</span><span class="p">;</span>
				<span class="n">m2</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">m2</span> <span class="o">=</span> <span class="n">linelen</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">m2</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ydstorg</span> <span class="o">=</span> <span class="n">m2</span> <span class="o">=</span> <span class="mh">0x400000</span> <span class="o">%</span> <span class="n">m2</span><span class="p">;</span>
			<span class="n">max_yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">vramlen</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="n">linelen</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">max_yres</span><span class="p">)</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">max_yres</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* YDSTLEN contains only signed 16bit value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">;</span>
	<span class="cm">/* we must round yres/xres down, we already rounded y/xres_virtual up</span>
<span class="cm">	   if it was possible. We should return -EINVAL, but I disagree */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* an artificial value - 15 */</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rgbt</span> <span class="o">=</span> <span class="n">table</span><span class="p">;</span> <span class="n">rgbt</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">&lt;</span> <span class="n">bpp</span><span class="p">;</span> <span class="n">rgbt</span><span class="o">++</span><span class="p">);</span>
<span class="cp">#define	SETCLR(clr)\</span>
<span class="cp">	var-&gt;clr.offset = rgbt-&gt;clr.offset;\</span>
<span class="cp">	var-&gt;clr.length = rgbt-&gt;clr.length</span>
	<span class="n">SETCLR</span><span class="p">(</span><span class="n">red</span><span class="p">);</span>
	<span class="n">SETCLR</span><span class="p">(</span><span class="n">green</span><span class="p">);</span>
	<span class="n">SETCLR</span><span class="p">(</span><span class="n">blue</span><span class="p">);</span>
	<span class="n">SETCLR</span><span class="p">(</span><span class="n">transp</span><span class="p">);</span>
<span class="cp">#undef	SETCLR</span>
	<span class="o">*</span><span class="n">visual</span> <span class="o">=</span> <span class="n">rgbt</span><span class="o">-&gt;</span><span class="n">visual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;matroxfb: truecolor: &quot;</span>
			<span class="s">&quot;size=%d:%d:%d:%d, shift=%d:%d:%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>

	<span class="o">*</span><span class="n">video_cmap_len</span> <span class="o">=</span> <span class="n">matroxfb_get_cmap_len</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;requested %d*%d/%dbpp (%d*%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span><span class="o">*</span> <span class="n">minfo</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">fb_info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">matrox_fb_info</span><span class="p">,</span> <span class="n">fbcon</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Set a single color register. The values supplied are</span>
<span class="cm">	 *  already rounded down to the hardware&#39;s capabilities</span>
<span class="cm">	 *  (according to the entries in the `var&#39; structure). Return</span>
<span class="cm">	 *  != 0 for invalid regno.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">cmap_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* gray = 0.30*R + 0.59*G + 0.11*B */</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">green</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">*</span> <span class="mi">77</span> <span class="o">+</span> <span class="n">green</span> <span class="o">*</span> <span class="mi">151</span> <span class="o">+</span> <span class="n">blue</span> <span class="o">*</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">red</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">green</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">blue</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">transp</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">transp</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_DAC_REG</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_DAC_VAL</span><span class="p">,</span> <span class="n">red</span><span class="p">);</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_DAC_VAL</span><span class="p">,</span> <span class="n">green</span><span class="p">);</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_DAC_VAL</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">{</span>
			<span class="n">u_int16_t</span> <span class="n">col</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>     <span class="o">|</span>
				<span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">blue</span> <span class="o">&lt;&lt;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>   <span class="o">|</span>
				<span class="p">(</span><span class="n">transp</span> <span class="o">&lt;&lt;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span> <span class="cm">/* for 1:5:5:5 */</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span> <span class="o">|</span> <span class="p">(</span><span class="n">col</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">red</span>   <span class="o">&lt;&lt;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>   <span class="o">|</span>
			<span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">blue</span>  <span class="o">&lt;&lt;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>  <span class="o">|</span>
			<span class="p">(</span><span class="n">transp</span> <span class="o">&lt;&lt;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>	<span class="cm">/* 8:8:8:8 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">matroxfb_init_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">fix</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span><span class="s">&quot;MATROX&quot;</span><span class="p">);</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* 8 for 8bpp, 4 for 16bpp, 2 for 32bpp */</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">accelerator</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">matroxfb_update_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">fix</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">ydstorg</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len_usable</span> <span class="o">-</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">ydstorg</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">mm_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">visual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmap_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ydstorg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span> <span class="o">=</span> <span class="n">info2minfo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">matroxfb_decode_var</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">visual</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ydstorg</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">visual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmap_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ydstorg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span> <span class="o">=</span> <span class="n">info2minfo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">matroxfb_decode_var</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">visual</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ydstorg</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">vaddr_va</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">)</span> <span class="o">+</span> <span class="n">ydstorg</span><span class="p">;</span>
	<span class="n">matroxfb_update_fix</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">visual</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">cmap_len</span> <span class="o">=</span> <span class="n">cmap_len</span><span class="p">;</span>
		<span class="n">ydstorg</span> <span class="o">+=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">ydstorg</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">ydstorg</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ydstorg</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">ydstorg</span><span class="p">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">ydstorg</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">isInterleave</span><span class="p">(</span><span class="n">minfo</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">ydstorg</span><span class="p">.</span><span class="n">pixels</span> <span class="o">=</span> <span class="n">ydstorg</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">ydstorg</span><span class="p">.</span><span class="n">pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">ydstorg</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">final_bppShift</span> <span class="o">=</span> <span class="n">matroxfb_get_final_bppShift</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="p">{</span>	<span class="k">struct</span> <span class="n">my_timming</span> <span class="n">mt</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">matrox_hw_state</span><span class="o">*</span> <span class="n">hw</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">matroxfb_var2my</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt</span><span class="p">);</span>
			<span class="n">mt</span><span class="p">.</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">;</span>
			<span class="cm">/* CRTC1 delays */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span>  <span class="mi">0</span>:	<span class="n">mt</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">16</span>:	<span class="n">mt</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">21</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">24</span>:	<span class="n">mt</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">17</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">32</span>:	<span class="n">mt</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>	<span class="n">mt</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

			<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">out</span> <span class="o">&lt;</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">;</span> <span class="n">out</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC1</span> <span class="o">&amp;&amp;</span>
				    <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">compute</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">compute</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">mt</span><span class="p">.</span><span class="n">pixclock</span><span class="p">;</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">mnp</span> <span class="o">=</span> <span class="n">mt</span><span class="p">.</span><span class="n">mnp</span><span class="p">;</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw_switch</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt</span><span class="p">);</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">)</span> <span class="o">*</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">final_bppShift</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">ydstorg</span><span class="p">.</span><span class="n">chunks</span><span class="p">;</span>

			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x0D</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x0C</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">;</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw_switch</span><span class="o">-&gt;</span><span class="n">restore</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
			<span class="n">update_crtc2</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
			<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">out</span> <span class="o">&lt;</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">;</span> <span class="n">out</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC1</span> <span class="o">&amp;&amp;</span>
				    <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">program</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">program</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">out</span> <span class="o">&lt;</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">;</span> <span class="n">out</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC1</span> <span class="o">&amp;&amp;</span>
				    <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">matrox_cfbX_init</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_get_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fb_vblank</span> <span class="o">*</span><span class="n">vblank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sts1</span><span class="p">;</span>

	<span class="n">matroxfb_enable_irq</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vblank</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vblank</span><span class="p">));</span>
	<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FB_VBLANK_HAVE_VCOUNT</span> <span class="o">|</span> <span class="n">FB_VBLANK_HAVE_VSYNC</span> <span class="o">|</span>
			<span class="n">FB_VBLANK_HAVE_VBLANK</span> <span class="o">|</span> <span class="n">FB_VBLANK_HAVE_HBLANK</span><span class="p">;</span>
	<span class="n">sts1</span> <span class="o">=</span> <span class="n">mga_inb</span><span class="p">(</span><span class="n">M_INSTS1</span><span class="p">);</span>
	<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="n">mga_inl</span><span class="p">(</span><span class="n">M_VCOUNT</span><span class="p">);</span>
	<span class="cm">/* BTW, on my PIII/450 with G400, reading M_INSTS1</span>
<span class="cm">	   byte makes this call about 12% slower (1.70 vs. 2.05 us</span>
<span class="cm">	   per ioctl()) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FB_VBLANK_HBLANKING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts1</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FB_VBLANK_VSYNCING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vblank</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">&gt;=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FB_VBLANK_VBLANKING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FB_VBLANK_HAVE_COUNT</span><span class="p">;</span>
		<span class="cm">/* Only one writer, aligned int value...</span>
<span class="cm">		   it should work without lock and without atomic_t */</span>
		<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">vsync</span><span class="p">.</span><span class="n">cnt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">matrox_altout</span> <span class="n">panellink_output</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	 <span class="o">=</span> <span class="s">&quot;Panellink output&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span> <span class="o">=</span> <span class="n">info2minfo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FBIOGET_VBLANK</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">fb_vblank</span> <span class="n">vblank</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

				<span class="n">err</span> <span class="o">=</span> <span class="n">matroxfb_get_vblank</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vblank</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vblank</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vblank</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">FBIO_WAITFORVSYNC</span>:
			<span class="p">{</span>
				<span class="n">u_int32_t</span> <span class="n">crt</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">crt</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

				<span class="k">return</span> <span class="n">matroxfb_wait_for_sync</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">crt</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">MATROXFB_SET_OUTPUT_MODE</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">matroxioc_output_mode</span> <span class="n">mom</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">matrox_altout</span> <span class="o">*</span><span class="n">oproc</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mom</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mom</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mom</span><span class="p">.</span><span class="n">output</span> <span class="o">&gt;=</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
				<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">oproc</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">mom</span><span class="p">.</span><span class="n">output</span><span class="p">].</span><span class="n">output</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oproc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oproc</span><span class="o">-&gt;</span><span class="n">verifymode</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mom</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MATROXFB_OUTPUT_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">oproc</span><span class="o">-&gt;</span><span class="n">verifymode</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">mom</span><span class="p">.</span><span class="n">output</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="n">mom</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">mom</span><span class="p">.</span><span class="n">output</span><span class="p">].</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">mom</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">mom</span><span class="p">.</span><span class="n">output</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mom</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
						<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">mom</span><span class="p">.</span><span class="n">output</span><span class="p">].</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">MATROXFB_SRC_CRTC1</span>:
						<span class="n">matroxfb_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">MATROXFB_SRC_CRTC2</span>:
						<span class="p">{</span>
							<span class="k">struct</span> <span class="n">matroxfb_dh_fb_info</span><span class="o">*</span> <span class="n">crtc2</span><span class="p">;</span>

							<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
							<span class="n">crtc2</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">crtc2</span><span class="p">)</span>
								<span class="n">crtc2</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_set_par</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crtc2</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">);</span>
							<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">MATROXFB_GET_OUTPUT_MODE</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">matroxioc_output_mode</span> <span class="n">mom</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">matrox_altout</span> <span class="o">*</span><span class="n">oproc</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mom</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mom</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mom</span><span class="p">.</span><span class="n">output</span> <span class="o">&gt;=</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
				<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">oproc</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">mom</span><span class="p">.</span><span class="n">output</span><span class="p">].</span><span class="n">output</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oproc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">mom</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">mom</span><span class="p">.</span><span class="n">output</span><span class="p">].</span><span class="n">mode</span><span class="p">;</span>
					<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mom</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mom</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">MATROXFB_SET_OUTPUT_CONNECTION</span>:
			<span class="p">{</span>
				<span class="n">u_int32_t</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">changes</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">)</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">output</span><span class="p">)</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
						<span class="k">switch</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">case</span> <span class="n">MATROXFB_SRC_NONE</span>:
							<span class="k">case</span> <span class="n">MATROXFB_SRC_CRTC1</span>:
								<span class="k">break</span><span class="p">;</span>
							<span class="nl">default:</span>
								<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">panellink</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MATROXFB_OUTPUT_CONN_DFP</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MATROXFB_OUTPUT_CONN_SECONDARY</span><span class="p">)</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC2</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">changes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span> <span class="o">!=</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">changes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">changes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">MATROXFB_SRC_NONE</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">changes</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">matroxfb_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">MATROXFB_GET_OUTPUT_CONNECTION</span>:
			<span class="p">{</span>
				<span class="n">u_int32_t</span> <span class="n">conn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">conn</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">MATROXFB_GET_AVAILABLE_OUTPUTS</span>:
			<span class="p">{</span>
				<span class="n">u_int32_t</span> <span class="n">conn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">switch</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">case</span> <span class="n">MATROXFB_SRC_NONE</span>:
							<span class="k">case</span> <span class="n">MATROXFB_SRC_CRTC1</span>:
								<span class="n">conn</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">panellink</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="n">MATROXFB_OUTPUT_CONN_DFP</span><span class="p">)</span>
						<span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MATROXFB_OUTPUT_CONN_SECONDARY</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="n">MATROXFB_OUTPUT_CONN_SECONDARY</span><span class="p">)</span>
						<span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MATROXFB_OUTPUT_CONN_DFP</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">MATROXFB_GET_ALL_OUTPUTS</span>:
			<span class="p">{</span>
				<span class="n">u_int32_t</span> <span class="n">conn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">conn</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">VIDIOC_QUERYCAP</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="n">r</span><span class="p">;</span>

				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;matroxfb&quot;</span><span class="p">);</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Matrox&quot;</span><span class="p">);</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;PCI:%s&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">));</span>
				<span class="n">r</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">KERNEL_VERSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">r</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="k">case</span> <span class="n">VIDIOC_QUERYCTRL</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">qctrl</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qctrl</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qctrl</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

				<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">getqueryctrl</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">getqueryctrl</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qctrl</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qctrl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qctrl</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">VIDIOC_G_CTRL</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="n">ctrl</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

				<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">getctrl</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">getctrl</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">VIDIOC_S_CTRL</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="n">ctrl</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

				<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">setctrl</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">setctrl</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 0 unblank, 1 blank, 2 no vsync, 3 no hsync, 4 off */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">seq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">crtc</span><span class="p">;</span>
	<span class="n">CRITFLAGS</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span> <span class="o">=</span> <span class="n">info2minfo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:  <span class="n">seq</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">crtc</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* works ??? */</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:  <span class="n">seq</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">crtc</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:  <span class="n">seq</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">crtc</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:  <span class="n">seq</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">crtc</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">seq</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">crtc</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CRITBEGIN</span>

	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_SEQ_INDEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_SEQ_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">mga_inb</span><span class="p">(</span><span class="n">M_SEQ_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">|</span> <span class="n">seq</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_EXTVGA_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">mga_inb</span><span class="p">(</span><span class="n">M_EXTVGA_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">|</span> <span class="n">crtc</span><span class="p">);</span>

	<span class="n">CRITEND</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">matroxfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span> <span class="o">=</span>	<span class="n">matroxfb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span> <span class="o">=</span>	<span class="n">matroxfb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span> <span class="o">=</span>	<span class="n">matroxfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span> <span class="o">=</span>	<span class="n">matroxfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span>	<span class="n">matroxfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span><span class="n">matroxfb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span> <span class="o">=</span>	<span class="n">matroxfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span> <span class="o">=</span>	<span class="n">matroxfb_ioctl</span><span class="p">,</span>
<span class="cm">/*	.fb_fillrect =	&lt;set by matrox_cfbX_init&gt;, */</span>
<span class="cm">/*	.fb_copyarea =	&lt;set by matrox_cfbX_init&gt;, */</span>
<span class="cm">/*	.fb_imageblit =	&lt;set by matrox_cfbX_init&gt;, */</span>
<span class="cm">/*	.fb_cursor =	&lt;set by matrox_cfbX_init&gt;, */</span>
<span class="p">};</span>

<span class="cp">#define RSDepth(X)	(((X) &gt;&gt; 8) &amp; 0x0F)</span>
<span class="cp">#define RS8bpp		0x1</span>
<span class="cp">#define RS15bpp		0x2</span>
<span class="cp">#define RS16bpp		0x3</span>
<span class="cp">#define RS32bpp		0x4</span>
<span class="cp">#define RS4bpp		0x5</span>
<span class="cp">#define RS24bpp		0x6</span>
<span class="cp">#define RSText		0x7</span>
<span class="cp">#define RSText8		0x8</span>
<span class="cm">/* 9-F */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span> <span class="k">struct</span> <span class="n">fb_bitfield</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">transp</span><span class="p">;</span> <span class="kt">int</span> <span class="n">bits_per_pixel</span><span class="p">;</span> <span class="p">}</span> <span class="n">colors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>  <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">32</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>  <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">24</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>  <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* textmode with (default) VGA8x16 */</span>
	<span class="p">{</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>  <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* textmode hardwired to VGA8x8 */</span>
<span class="p">};</span>

<span class="cm">/* initialized by setup, see explanation at end of file (search for MODULE_PARM_DESC) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mem</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:mem:xxxxxM&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">option_precise_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* cannot be changed, option_precise_width==0 must imply noaccel */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">inv24</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:inv24&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cross4MB</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:cross4MB&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disabled</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:disabled&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">noaccel</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:noaccel&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nopan</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:nopan&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">no_pci_retry</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:nopciretry&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">novga</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:novga&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nobios</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:nobios&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">noinit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:init&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">inverse</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:inverse&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sgram</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:sgram&quot; */</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mtrr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:nomtrr&quot; */</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">grayscale</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:grayscale&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:dev:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vesa</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:vesa:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:depth:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xres</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:xres:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">yres</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:yres:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">upper</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:upper:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lower</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:lower:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vslen</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:vslen:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:left:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:right:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hslen</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:hslen:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixclock</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:pixclock:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sync</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:sync:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fv</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:fv:xxxxx&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fh</span><span class="p">;</span>			<span class="cm">/* &quot;matroxfb:fh:xxxxxk&quot; */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxclk</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:maxclk:xxxxM&quot; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dfp</span><span class="p">;</span>				<span class="cm">/* &quot;matroxfb:dfp */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dfp_type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:dfp:xxx */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">memtype</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* &quot;matroxfb:memtype:xxx&quot; */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>			<span class="cm">/* &quot;matroxfb:outputs:xxx&quot; */</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">videomode</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>		<span class="cm">/* &quot;matroxfb:mode:xxxxx&quot; or &quot;matroxfb:xxxxx&quot; */</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_getmemory</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxSize</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">realSize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vaddr_t</span> <span class="n">vm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offs2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">orig</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">vm</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">;</span>
	<span class="n">maxSize</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1FFFFF</span><span class="p">;</span>	<span class="cm">/* must be X*2MB (really it must be 2 or X*4MB) */</span>
	<span class="cm">/* at least 2MB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxSize</span> <span class="o">&lt;</span> <span class="mh">0x0200000</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxSize</span> <span class="o">&gt;</span> <span class="mh">0x2000000</span><span class="p">)</span> <span class="n">maxSize</span> <span class="o">=</span> <span class="mh">0x2000000</span><span class="p">;</span>

	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">orig</span> <span class="o">=</span> <span class="n">mga_inb</span><span class="p">(</span><span class="n">M_EXTVGA_DATA</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_EXTVGA_DATA</span><span class="p">,</span> <span class="n">orig</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offs</span> <span class="o">=</span> <span class="mh">0x100000</span><span class="p">;</span> <span class="n">offs</span> <span class="o">&lt;</span> <span class="n">maxSize</span><span class="p">;</span> <span class="n">offs</span> <span class="o">+=</span> <span class="mh">0x200000</span><span class="p">)</span>
		<span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="n">mga_readb</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">offs</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offs</span> <span class="o">=</span> <span class="mh">0x100000</span><span class="p">;</span> <span class="n">offs</span> <span class="o">&lt;</span> <span class="n">maxSize</span><span class="p">;</span> <span class="n">offs</span> <span class="o">+=</span> <span class="mh">0x200000</span><span class="p">)</span>
		<span class="n">mga_writeb</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_CACHEFLUSH</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offs</span> <span class="o">=</span> <span class="mh">0x100000</span><span class="p">;</span> <span class="n">offs</span> <span class="o">&lt;</span> <span class="n">maxSize</span><span class="p">;</span> <span class="n">offs</span> <span class="o">+=</span> <span class="mh">0x200000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mga_readb</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">offs</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">mga_writeb</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">mga_readb</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">offs</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mga_readb</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">offs</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offs2</span> <span class="o">=</span> <span class="mh">0x100000</span><span class="p">;</span> <span class="n">offs2</span> <span class="o">&lt;</span> <span class="n">maxSize</span><span class="p">;</span> <span class="n">offs2</span> <span class="o">+=</span> <span class="mh">0x200000</span><span class="p">)</span>
		<span class="n">mga_writeb</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">offs2</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="o">++</span><span class="p">);</span>

	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_EXTVGA_DATA</span><span class="p">,</span> <span class="n">orig</span><span class="p">);</span>

	<span class="o">*</span><span class="n">realSize</span> <span class="o">=</span> <span class="n">offs</span> <span class="o">-</span> <span class="mh">0x100000</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_MATROX_MILLENIUM</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">interleave</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="n">isMillenium</span><span class="p">(</span><span class="n">minfo</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">offs</span> <span class="o">-</span> <span class="mh">0x100000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3FFFFF</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">video_board</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">maxvram</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxdisplayable</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">accelID</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_switch</span><span class="o">*</span> <span class="n">lowlevel</span><span class="p">;</span>
		 <span class="p">};</span>
<span class="cp">#ifdef CONFIG_FB_MATROX_MILLENIUM</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">video_board</span> <span class="n">vbMillennium</span>		<span class="o">=</span> <span class="p">{</span><span class="mh">0x0800000</span><span class="p">,</span> <span class="mh">0x0800000</span><span class="p">,</span> <span class="n">FB_ACCEL_MATROX_MGA2064W</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">matrox_millennium</span><span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">video_board</span> <span class="n">vbMillennium2</span>		<span class="o">=</span> <span class="p">{</span><span class="mh">0x1000000</span><span class="p">,</span> <span class="mh">0x0800000</span><span class="p">,</span> <span class="n">FB_ACCEL_MATROX_MGA2164W</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">matrox_millennium</span><span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">video_board</span> <span class="n">vbMillennium2A</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0x1000000</span><span class="p">,</span> <span class="mh">0x0800000</span><span class="p">,</span> <span class="n">FB_ACCEL_MATROX_MGA2164W_AGP</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">matrox_millennium</span><span class="p">};</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_FB_MATROX_MILLENIUM */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_FB_MATROX_MYSTIQUE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">video_board</span> <span class="n">vbMystique</span>		<span class="o">=</span> <span class="p">{</span><span class="mh">0x0800000</span><span class="p">,</span> <span class="mh">0x0800000</span><span class="p">,</span> <span class="n">FB_ACCEL_MATROX_MGA1064SG</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">matrox_mystique</span><span class="p">};</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_FB_MATROX_MYSTIQUE */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_FB_MATROX_G</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">video_board</span> <span class="n">vbG100</span>		<span class="o">=</span> <span class="p">{</span><span class="mh">0x0800000</span><span class="p">,</span> <span class="mh">0x0800000</span><span class="p">,</span> <span class="n">FB_ACCEL_MATROX_MGAG100</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">matrox_G100</span><span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">video_board</span> <span class="n">vbG200</span>		<span class="o">=</span> <span class="p">{</span><span class="mh">0x1000000</span><span class="p">,</span> <span class="mh">0x1000000</span><span class="p">,</span> <span class="n">FB_ACCEL_MATROX_MGAG200</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">matrox_G100</span><span class="p">};</span>
<span class="cm">/* from doc it looks like that accelerator can draw only to low 16MB :-( Direct accesses &amp; displaying are OK for</span>
<span class="cm">   whole 32MB */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">video_board</span> <span class="n">vbG400</span>		<span class="o">=</span> <span class="p">{</span><span class="mh">0x2000000</span><span class="p">,</span> <span class="mh">0x1000000</span><span class="p">,</span> <span class="n">FB_ACCEL_MATROX_MGAG400</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">matrox_G100</span><span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#define DEVF_VIDEO64BIT		0x0001</span>
<span class="cp">#define	DEVF_SWAPS		0x0002</span>
<span class="cp">#define DEVF_SRCORG		0x0004</span>
<span class="cp">#define DEVF_DUALHEAD		0x0008</span>
<span class="cp">#define DEVF_CROSS4MB		0x0010</span>
<span class="cp">#define DEVF_TEXT4B		0x0020</span>
<span class="cm">/* #define DEVF_recycled	0x0040	*/</span>
<span class="cm">/* #define DEVF_recycled	0x0080	*/</span>
<span class="cp">#define DEVF_SUPPORT32MB	0x0100</span>
<span class="cp">#define DEVF_ANY_VXRES		0x0200</span>
<span class="cp">#define DEVF_TEXT16B		0x0400</span>
<span class="cp">#define DEVF_CRTC2		0x0800</span>
<span class="cp">#define DEVF_MAVEN_CAPABLE	0x1000</span>
<span class="cp">#define DEVF_PANELLINK_CAPABLE	0x2000</span>
<span class="cp">#define DEVF_G450DAC		0x4000</span>

<span class="cp">#define DEVF_GCORE	(DEVF_VIDEO64BIT | DEVF_SWAPS | DEVF_CROSS4MB)</span>
<span class="cp">#define DEVF_G2CORE	(DEVF_GCORE | DEVF_ANY_VXRES | DEVF_MAVEN_CAPABLE | DEVF_PANELLINK_CAPABLE | DEVF_SRCORG | DEVF_DUALHEAD)</span>
<span class="cp">#define DEVF_G100	(DEVF_GCORE) </span><span class="cm">/* no doc, no vxres... */</span><span class="cp"></span>
<span class="cp">#define DEVF_G200	(DEVF_G2CORE)</span>
<span class="cp">#define DEVF_G400	(DEVF_G2CORE | DEVF_SUPPORT32MB | DEVF_TEXT16B | DEVF_CRTC2)</span>
<span class="cm">/* if you&#39;ll find how to drive DFP... */</span>
<span class="cp">#define DEVF_G450	(DEVF_GCORE | DEVF_ANY_VXRES | DEVF_SUPPORT32MB | DEVF_TEXT16B | DEVF_CRTC2 | DEVF_G450DAC | DEVF_SRCORG | DEVF_DUALHEAD)</span>
<span class="cp">#define DEVF_G550	(DEVF_G450)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">board</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">svid</span><span class="p">,</span> <span class="n">sid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxclk</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">mga_chip</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_board</span><span class="o">*</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">dev_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_MATROX_MILLENIUM</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_MIL</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_TEXT4B</span><span class="p">,</span>
		<span class="mi">230000</span><span class="p">,</span>
		<span class="n">MGA_2064</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbMillennium</span><span class="p">,</span>
		<span class="s">&quot;Millennium (PCI)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_MIL_2</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_SWAPS</span><span class="p">,</span>
		<span class="mi">220000</span><span class="p">,</span>
		<span class="n">MGA_2164</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbMillennium2</span><span class="p">,</span>
		<span class="s">&quot;Millennium II (PCI)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_MIL_2_AGP</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_SWAPS</span><span class="p">,</span>
		<span class="mi">250000</span><span class="p">,</span>
		<span class="n">MGA_2164</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbMillennium2A</span><span class="p">,</span>
		<span class="s">&quot;Millennium II (AGP)&quot;</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_MATROX_MYSTIQUE</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_MYS</span><span class="p">,</span>	<span class="mh">0x02</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_VIDEO64BIT</span> <span class="o">|</span> <span class="n">DEVF_CROSS4MB</span><span class="p">,</span>
		<span class="mi">180000</span><span class="p">,</span>
		<span class="n">MGA_1064</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbMystique</span><span class="p">,</span>
		<span class="s">&quot;Mystique (PCI)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_MYS</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_VIDEO64BIT</span> <span class="o">|</span> <span class="n">DEVF_SWAPS</span> <span class="o">|</span> <span class="n">DEVF_CROSS4MB</span><span class="p">,</span>
		<span class="mi">220000</span><span class="p">,</span>
		<span class="n">MGA_1164</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbMystique</span><span class="p">,</span>
		<span class="s">&quot;Mystique 220 (PCI)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_MYS_AGP</span><span class="p">,</span>	<span class="mh">0x02</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_VIDEO64BIT</span> <span class="o">|</span> <span class="n">DEVF_CROSS4MB</span><span class="p">,</span>
		<span class="mi">180000</span><span class="p">,</span>
		<span class="n">MGA_1064</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbMystique</span><span class="p">,</span>
		<span class="s">&quot;Mystique (AGP)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_MYS_AGP</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_VIDEO64BIT</span> <span class="o">|</span> <span class="n">DEVF_SWAPS</span> <span class="o">|</span> <span class="n">DEVF_CROSS4MB</span><span class="p">,</span>
		<span class="mi">220000</span><span class="p">,</span>
		<span class="n">MGA_1164</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbMystique</span><span class="p">,</span>
		<span class="s">&quot;Mystique 220 (AGP)&quot;</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_MATROX_G</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G100_MM</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_G100</span><span class="p">,</span>
		<span class="mi">230000</span><span class="p">,</span>
		<span class="n">MGA_G100</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG100</span><span class="p">,</span>
		<span class="s">&quot;MGA-G100 (PCI)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G100_AGP</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_G100</span><span class="p">,</span>
		<span class="mi">230000</span><span class="p">,</span>
		<span class="n">MGA_G100</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG100</span><span class="p">,</span>
		<span class="s">&quot;MGA-G100 (AGP)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G200_PCI</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_G200</span><span class="p">,</span>
		<span class="mi">250000</span><span class="p">,</span>
		<span class="n">MGA_G200</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG200</span><span class="p">,</span>
		<span class="s">&quot;MGA-G200 (PCI)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G200_AGP</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="n">PCI_SS_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_SS_ID_MATROX_GENERIC</span><span class="p">,</span>
		<span class="n">DEVF_G200</span><span class="p">,</span>
		<span class="mi">220000</span><span class="p">,</span>
		<span class="n">MGA_G200</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG200</span><span class="p">,</span>
		<span class="s">&quot;MGA-G200 (AGP)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G200_AGP</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="n">PCI_SS_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_SS_ID_MATROX_MYSTIQUE_G200_AGP</span><span class="p">,</span>
		<span class="n">DEVF_G200</span><span class="p">,</span>
		<span class="mi">230000</span><span class="p">,</span>
		<span class="n">MGA_G200</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG200</span><span class="p">,</span>
		<span class="s">&quot;Mystique G200 (AGP)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G200_AGP</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="n">PCI_SS_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_SS_ID_MATROX_MILLENIUM_G200_AGP</span><span class="p">,</span>
		<span class="n">DEVF_G200</span><span class="p">,</span>
		<span class="mi">250000</span><span class="p">,</span>
		<span class="n">MGA_G200</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG200</span><span class="p">,</span>
		<span class="s">&quot;Millennium G200 (AGP)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G200_AGP</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="n">PCI_SS_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_SS_ID_MATROX_MARVEL_G200_AGP</span><span class="p">,</span>
		<span class="n">DEVF_G200</span><span class="p">,</span>
		<span class="mi">230000</span><span class="p">,</span>
		<span class="n">MGA_G200</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG200</span><span class="p">,</span>
		<span class="s">&quot;Marvel G200 (AGP)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G200_AGP</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="n">PCI_SS_VENDOR_ID_SIEMENS_NIXDORF</span><span class="p">,</span>	<span class="n">PCI_SS_ID_SIEMENS_MGA_G200_AGP</span><span class="p">,</span>
		<span class="n">DEVF_G200</span><span class="p">,</span>
		<span class="mi">230000</span><span class="p">,</span>
		<span class="n">MGA_G200</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG200</span><span class="p">,</span>
		<span class="s">&quot;MGA-G200 (AGP)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G200_AGP</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_G200</span><span class="p">,</span>
		<span class="mi">230000</span><span class="p">,</span>
		<span class="n">MGA_G200</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG200</span><span class="p">,</span>
		<span class="s">&quot;G200 (AGP)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G400</span><span class="p">,</span>	<span class="mh">0x80</span><span class="p">,</span>
		<span class="n">PCI_SS_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_SS_ID_MATROX_MILLENNIUM_G400_MAX_AGP</span><span class="p">,</span>
		<span class="n">DEVF_G400</span><span class="p">,</span>
		<span class="mi">360000</span><span class="p">,</span>
		<span class="n">MGA_G400</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG400</span><span class="p">,</span>
		<span class="s">&quot;Millennium G400 MAX (AGP)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G400</span><span class="p">,</span>	<span class="mh">0x80</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_G400</span><span class="p">,</span>
		<span class="mi">300000</span><span class="p">,</span>
		<span class="n">MGA_G400</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG400</span><span class="p">,</span>
		<span class="s">&quot;G400 (AGP)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G400</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_G450</span><span class="p">,</span>
		<span class="mi">360000</span><span class="p">,</span>
		<span class="n">MGA_G450</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG400</span><span class="p">,</span>
		<span class="s">&quot;G450&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G550</span><span class="p">,</span>	<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="n">DEVF_G550</span><span class="p">,</span>
		<span class="mi">360000</span><span class="p">,</span>
		<span class="n">MGA_G550</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vbG400</span><span class="p">,</span>
		<span class="s">&quot;G550&quot;</span><span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>				<span class="mh">0xFF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">}};</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">defaultmode</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 640x480 @ 60Hz, 31.5 kHz */</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">39721</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* !MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hotplug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setDefaultOutputs</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">default_src</span> <span class="o">=</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">g450dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">default_src</span> <span class="o">=</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">default_src</span> <span class="o">=</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dfp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">default_src</span> <span class="o">=</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MATROXFB_MAX_OUTPUTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_src</span> <span class="o">=</span> <span class="n">MATROXFB_SRC_NONE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_src</span> <span class="o">=</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;2&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">crtc2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_src</span> <span class="o">=</span> <span class="n">MATROXFB_SRC_CRTC2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: Unknown outputs setting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Nullify this option for subsequent adapters */</span>
	<span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">initMatrox2</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">board</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctrlptr_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">video_base_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">memsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">intel_82437</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82437</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="cm">/* set default values... */</span>
	<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw_switch</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lowlevel</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">accelerator</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">accelID</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">max_pixel_clock</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">maxclk</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;matroxfb: Matrox %s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">plnwt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">srcorg</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_SRCORG</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">video64bits</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_VIDEO64BIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_TEXT4B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">vgastep</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">textmode</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">text_type_aux</span> <span class="o">=</span> <span class="n">FB_AUX_TEXT_MGA_STEP16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_TEXT16B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">vgastep</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">textmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">text_type_aux</span> <span class="o">=</span> <span class="n">FB_AUX_TEXT_MGA_STEP16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">vgastep</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">textmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">text_type_aux</span> <span class="o">=</span> <span class="n">FB_AUX_TEXT_MGA_STEP8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">support32MB</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_SUPPORT32MB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">precise_width</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_ANY_VXRES</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">crtc2</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_CRTC2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">maven_capable</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_MAVEN_CAPABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">dualhead</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_DUALHEAD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">dfp_type</span> <span class="o">=</span> <span class="n">dfp_type</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">g450dac</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_G450DAC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">textstep</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">vgastep</span> <span class="o">*</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">textmode</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">textvram</span> <span class="o">=</span> <span class="mi">65536</span> <span class="o">/</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">textmode</span><span class="p">;</span>
	<span class="n">setDefaultOutputs</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_PANELLINK_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">minfo</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">output</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">panellink_output</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">default_src</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MATROXFB_OUTPUT_MODE_MONITOR</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">panellink</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">cross4MB</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">cross4MB</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_CROSS4MB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVF_SWAPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrlptr_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">video_base_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">fbResource</span> <span class="o">=</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctrlptr_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">video_base_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">fbResource</span> <span class="o">=</span> <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrlptr_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: control registers are not available, matroxfb disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">video_base_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: video RAM is not available in PCI address space, matroxfb disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memsize</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">maxvram</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">ctrlptr_phys</span><span class="p">,</span> <span class="mi">16384</span><span class="p">,</span> <span class="s">&quot;matroxfb MMIO&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">video_base_phys</span><span class="p">,</span> <span class="n">memsize</span><span class="p">,</span> <span class="s">&quot;matroxfb FB&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">failCtrlMR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len_maximum</span> <span class="o">=</span> <span class="n">memsize</span><span class="p">;</span>
	<span class="cm">/* convert mem (autodetect k, M) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="n">mem</span> <span class="o">*=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">&lt;</span> <span class="mh">0x00100000</span><span class="p">)</span> <span class="n">mem</span> <span class="o">*=</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mem</span> <span class="o">&lt;</span> <span class="n">memsize</span><span class="p">))</span>
		<span class="n">memsize</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mga_ioremap</span><span class="p">(</span><span class="n">ctrlptr_phys</span><span class="p">,</span> <span class="mi">16384</span><span class="p">,</span> <span class="n">MGA_IOREMAP_MMIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">vbase</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: cannot ioremap(%lX, 16384), matroxfb disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrlptr_phys</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failVideoMR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">ctrlptr_phys</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">16384</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">video_base_phys</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mga_ioremap</span><span class="p">(</span><span class="n">video_base_phys</span><span class="p">,</span> <span class="n">memsize</span><span class="p">,</span> <span class="n">MGA_IOREMAP_FB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: cannot ioremap(%lX, %d), matroxfb disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">video_base_phys</span><span class="p">,</span> <span class="n">memsize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failCtrlIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">{</span>
		<span class="n">u_int32_t</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">u_int32_t</span> <span class="n">mga_option</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mga_option</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">mga_option</span> <span class="o">&amp;=</span> <span class="mh">0x7FFFFFFF</span><span class="p">;</span> <span class="cm">/* clear BIG_ENDIAN */</span>
		<span class="n">mga_option</span> <span class="o">|=</span> <span class="n">MX_OPTION_BSWAP</span><span class="p">;</span>
		<span class="cm">/* disable palette snooping */</span>
		<span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_VGA_PALETTE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev_present</span><span class="p">(</span><span class="n">intel_82437</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mga_option</span> <span class="o">&amp;</span> <span class="mh">0x20000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nopciretry</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;matroxfb: Disabling PCI retries due to i82437 present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mga_option</span> <span class="o">|=</span> <span class="mh">0x20000000</span><span class="p">;</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nopciretry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">mga_option</span><span class="p">);</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">=</span> <span class="n">mga_option</span><span class="p">;</span>

		<span class="cm">/* select non-DMA memory for PCI_MGA_DATA, otherwise dump of PCI cfg space can lock PCI bus */</span>
		<span class="cm">/* maybe preinit() candidate, but it is same... for all devices... at this time... */</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_MGA_INDEX</span><span class="p">,</span> <span class="mh">0x00003C00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">matroxfb_read_pins</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw_switch</span><span class="o">-&gt;</span><span class="n">preinit</span><span class="p">(</span><span class="n">minfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">failVideoIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">matroxfb_getmemory</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">memsize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: cannot determine memory size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failVideoIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">ydstorg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">video_base_phys</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len_usable</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len_usable</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">maxdisplayable</span><span class="p">)</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len_usable</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">maxdisplayable</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtrr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mtrr</span><span class="p">.</span><span class="n">vram</span> <span class="o">=</span> <span class="n">mtrr_add</span><span class="p">(</span><span class="n">video_base_phys</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">MTRR_TYPE_WRCOMB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mtrr</span><span class="p">.</span><span class="n">vram_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;matroxfb: MTRR&#39;s turned on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_MTRR */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">novga</span><span class="p">)</span>
		<span class="n">request_region</span><span class="p">(</span><span class="mh">0x3C0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;matrox&quot;</span><span class="p">);</span>
	<span class="n">matroxfb_g450_connect</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw_switch</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="n">fv</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* TBD */</span>

	<span class="cm">/* static settings */</span>
	<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">red</span><span class="p">;</span>
	<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">green</span><span class="p">;</span>
	<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">blue</span><span class="p">;</span>
	<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">grayscale</span> <span class="o">=</span> <span class="n">grayscale</span><span class="p">;</span>
	<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">vmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">noaccel</span><span class="p">)</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="n">matroxfb_ops</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">;</span>
	<span class="cm">/* after __init time we are like module... no logo */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">hotplug</span> <span class="o">?</span> <span class="n">FBINFO_FLAG_MODULE</span> <span class="o">:</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_PARTIAL_PAN_OK</span> <span class="o">|</span> 	 <span class="cm">/* Prefer panning for scroll under MC viewer/edit */</span>
				      <span class="n">FBINFO_HWACCEL_COPYAREA</span> <span class="o">|</span>  <span class="cm">/* We have hw-assisted bmove */</span>
				      <span class="n">FBINFO_HWACCEL_FILLRECT</span> <span class="o">|</span>  <span class="cm">/* And fillrect */</span>
				      <span class="n">FBINFO_HWACCEL_IMAGEBLIT</span> <span class="o">|</span> <span class="cm">/* And imageblit */</span>
				      <span class="n">FBINFO_HWACCEL_XPAN</span> <span class="o">|</span>      <span class="cm">/* And we support both horizontal */</span>
				      <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>       <span class="cm">/* And vertical panning */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len_usable</span> <span class="o">&amp;=</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifndef MODULE</span>
	<span class="cm">/* mode database is marked __init!!! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hotplug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vesafb_defined</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">,</span> <span class="n">videomode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">videomode</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">defaultmode</span><span class="p">,</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !MODULE */</span><span class="cp"></span>

	<span class="cm">/* mode modifiers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hslen</span><span class="p">)</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">hslen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vslen</span><span class="p">)</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">vslen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">upper</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">upper</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lower</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">lower</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">sync</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vesafb_defined</span><span class="p">.</span><span class="n">sync</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">)</span>
			<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="mi">480</span><span class="p">)</span>
			<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fv, fh, maxclk limits was specified */</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">fv</span> <span class="o">*</span> <span class="p">(</span><span class="n">vesafb_defined</span><span class="p">.</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">yres</span>
				  <span class="o">+</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">fh</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">fh</span> <span class="o">*</span> <span class="p">(</span><span class="n">vesafb_defined</span><span class="p">.</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">xres</span>
				  <span class="o">+</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">maxclk</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">maxclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="n">maxclk</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxclk</span> <span class="o">+</span> <span class="mi">499</span><span class="p">)</span> <span class="o">/</span> <span class="mi">500</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2000000000</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">pixclock</span><span class="p">)</span> <span class="n">pixclock</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pixclock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pixclock</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">)</span>		<span class="cm">/* &gt; 500MHz */</span>
			<span class="n">pixclock</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>	<span class="cm">/* 250MHz */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pixclock</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">)</span>
			<span class="n">pixclock</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>	<span class="cm">/* 1MHz */</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">pixclock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: Where to move this?! */</span>
<span class="cp">#if defined(CONFIG_PPC_PMAC)</span>
<span class="cp">#ifndef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">var</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">default_vmode</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">default_vmode</span> <span class="o">&gt;</span> <span class="n">VMODE_MAX</span><span class="p">)</span>
			<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_640_480_60</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_NVRAM</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">default_cmode</span> <span class="o">==</span> <span class="n">CMODE_NVRAM</span><span class="p">)</span>
			<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">nvram_read_byte</span><span class="p">(</span><span class="n">NV_CMODE</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">default_cmode</span> <span class="o">&lt;</span> <span class="n">CMODE_8</span> <span class="o">||</span> <span class="n">default_cmode</span> <span class="o">&gt;</span> <span class="n">CMODE_32</span><span class="p">)</span>
			<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac_vmode_to_var</span><span class="p">(</span><span class="n">default_vmode</span><span class="p">,</span> <span class="n">default_cmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">accel_flags</span><span class="p">;</span>
			<span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Note: mac_vmode_to_var() does not set all parameters */</span>
			<span class="n">vesafb_defined</span> <span class="o">=</span> <span class="n">var</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !MODULE */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>
	<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nopan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span> <span class="cm">/* large enough to be INF, but small enough</span>
<span class="cm">							to yres_virtual * xres_virtual &lt; 2^32 */</span>
	<span class="p">}</span>
	<span class="n">matroxfb_init_fix</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">vaddr_va</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">);</span>
	<span class="cm">/* Normalize values (namely yres_virtual) */</span>
	<span class="n">matroxfb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vesafb_defined</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">);</span>
	<span class="cm">/* And put it into &quot;current&quot; var. Do NOT program hardware yet, or we&#39;ll not take over</span>
<span class="cm">	 * vgacon correctly. fbcon_startup will call fb_set_par for us, WITHOUT check_var,</span>
<span class="cm">	 * and unfortunately it will do it BEFORE vgacon contents is saved, so it won&#39;t work</span>
<span class="cm">	 * anyway. But we at least tried... */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">vesafb_defined</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;matroxfb: %dx%dx%dbpp (virtual: %dx%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">vesafb_defined</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;matroxfb: framebuffer at 0x%lX, mapped to 0x%p, size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">vaddr_va</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">),</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

<span class="cm">/* We do not have to set currcon to 0... register_framebuffer do it for us on first console</span>
<span class="cm"> * and we do not want currcon == 0 for subsequent framebuffers */</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">failVideoIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fb%d: %s frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/* there is no console on this fb... but we have to initialize hardware</span>
<span class="cm">	 * until someone tells me what is proper thing to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: initializing hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>
		<span class="cm">/* We have to use FB_ACTIVATE_FORCE, as we had to put vesafb_defined to the fbcon.var</span>
<span class="cm">		 * already before, so register_framebuffer works correctly. */</span>
		<span class="n">vesafb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">|=</span> <span class="n">FB_ACTIVATE_FORCE</span><span class="p">;</span>
		<span class="n">fb_set_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vesafb_defined</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">failVideoIO:</span><span class="p">;</span>
	<span class="n">matroxfb_g450_shutdown</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="n">mga_iounmap</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">);</span>
<span class="nl">failCtrlIO:</span><span class="p">;</span>
	<span class="n">mga_iounmap</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">vbase</span><span class="p">);</span>
<span class="nl">failVideoMR:</span><span class="p">;</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">video_base_phys</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len_maximum</span><span class="p">);</span>
<span class="nl">failCtrlMR:</span><span class="p">;</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">ctrlptr_phys</span><span class="p">,</span> <span class="mi">16384</span><span class="p">);</span>
<span class="nl">fail:</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">matroxfb_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">matroxfb_driver_list</span><span class="p">);</span>

<span class="cp">#define matroxfb_l(x) list_entry(x, struct matrox_fb_info, next_fb)</span>
<span class="cp">#define matroxfb_driver_l(x) list_entry(x, struct matroxfb_driver, node)</span>
<span class="kt">int</span> <span class="nf">matroxfb_register_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">matroxfb_driver</span><span class="o">*</span> <span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span><span class="o">*</span> <span class="n">minfo</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">matroxfb_driver_list</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">minfo</span> <span class="o">=</span> <span class="n">matroxfb_l</span><span class="p">(</span><span class="n">matroxfb_list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	     <span class="n">minfo</span> <span class="o">!=</span> <span class="n">matroxfb_l</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matroxfb_list</span><span class="p">);</span>
	     <span class="n">minfo</span> <span class="o">=</span> <span class="n">matroxfb_l</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">next_fb</span><span class="p">.</span><span class="n">next</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_count</span> <span class="o">==</span> <span class="n">MATROXFB_MAX_FB_DRIVERS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_data</span><span class="p">[</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers</span><span class="p">[</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">drv</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">matroxfb_unregister_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">matroxfb_driver</span><span class="o">*</span> <span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span><span class="o">*</span> <span class="n">minfo</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">minfo</span> <span class="o">=</span> <span class="n">matroxfb_l</span><span class="p">(</span><span class="n">matroxfb_list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	     <span class="n">minfo</span> <span class="o">!=</span> <span class="n">matroxfb_l</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matroxfb_list</span><span class="p">);</span>
	     <span class="n">minfo</span> <span class="o">=</span> <span class="n">matroxfb_l</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">next_fb</span><span class="p">.</span><span class="n">next</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_count</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
					<span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers</span><span class="p">[</span><span class="o">--</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_count</span><span class="p">];</span>
				<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_data</span><span class="p">[</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_count</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">matroxfb_register_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span><span class="o">*</span> <span class="n">minfo</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">matroxfb_driver</span><span class="o">*</span> <span class="n">drv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">next_fb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">matroxfb_list</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">drv</span> <span class="o">=</span> <span class="n">matroxfb_driver_l</span><span class="p">(</span><span class="n">matroxfb_driver_list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	     <span class="n">drv</span> <span class="o">!=</span> <span class="n">matroxfb_driver_l</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matroxfb_driver_list</span><span class="p">);</span>
	     <span class="n">drv</span> <span class="o">=</span> <span class="n">matroxfb_driver_l</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">next</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
				<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">drv</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MATROXFB_MAX_FB_DRIVERS</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">matroxfb_unregister_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span><span class="o">*</span> <span class="n">minfo</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">next_fb</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">matroxfb_driver</span><span class="o">*</span> <span class="n">drv</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">drivers_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span><span class="o">*</span> <span class="n">dummy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">board</span><span class="o">*</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">u_int16_t</span> <span class="n">svid</span><span class="p">;</span>
	<span class="n">u_int16_t</span> <span class="n">sid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span><span class="o">*</span> <span class="n">minfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u_int32_t</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">svid</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
	<span class="n">sid</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="n">dev_list</span><span class="p">;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">svid</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">svid</span> <span class="o">!=</span> <span class="n">svid</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">!=</span> <span class="n">sid</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* not match... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not requested one... */</span>
		<span class="n">dev</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">minfo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">minfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">minfo</span><span class="p">));</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">dead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">usecount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">userusecount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">minfo</span><span class="p">);</span>
	<span class="cm">/* DEVFLAGS */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">memtype</span> <span class="o">=</span> <span class="n">memtype</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memtype</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">noinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_MEMORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">novga</span> <span class="o">=</span> <span class="n">novga</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nobios</span> <span class="o">=</span> <span class="n">nobios</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">noinit</span> <span class="o">=</span> <span class="n">noinit</span><span class="p">;</span>
		<span class="cm">/* subsequent heads always needs initialization and must not enable BIOS */</span>
		<span class="n">novga</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nobios</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">noinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">novga</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nobios</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">noinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nopciretry</span> <span class="o">=</span> <span class="n">no_pci_retry</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">mga_24bpp_fix</span> <span class="o">=</span> <span class="n">inv24</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">precise_width</span> <span class="o">=</span> <span class="n">option_precise_width</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">sgram</span> <span class="o">=</span> <span class="n">sgram</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">cross4MB</span> <span class="o">=</span> <span class="n">cross4MB</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">DAC</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">accel</span><span class="p">);</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">altout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">vsync</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">vsync</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">panpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">initMatrox2</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">matroxfb_register_device</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_remove_matrox</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_fb_info</span><span class="o">*</span> <span class="n">minfo</span><span class="p">;</span>

	<span class="n">minfo</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">matroxfb_remove</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">matroxfb_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_MATROX_MILLENIUM</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_MIL</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_MIL_2</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_MIL_2_AGP</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_MATROX_MYSTIQUE</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_MYS</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_MATROX_G</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G100_MM</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G100_AGP</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G200_PCI</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G200_AGP</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G400</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MATROX</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_MATROX_G550</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span>			<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">matroxfb_devices</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">matroxfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;matroxfb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">matroxfb_devices</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">matroxfb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">pci_remove_matrox</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* **************************** init-time only **************************** */</span>

<span class="cp">#define RSResolution(X)	((X) &amp; 0x0F)</span>
<span class="cp">#define RS640x400	1</span>
<span class="cp">#define RS640x480	2</span>
<span class="cp">#define RS800x600	3</span>
<span class="cp">#define RS1024x768	4</span>
<span class="cp">#define RS1280x1024	5</span>
<span class="cp">#define RS1600x1200	6</span>
<span class="cp">#define RS768x576	7</span>
<span class="cp">#define RS960x720	8</span>
<span class="cp">#define RS1152x864	9</span>
<span class="cp">#define RS1408x1056	10</span>
<span class="cp">#define RS640x350	11</span>
<span class="cp">#define RS1056x344	12	</span><span class="cm">/* 132 x 43 text */</span><span class="cp"></span>
<span class="cp">#define RS1056x400	13	</span><span class="cm">/* 132 x 50 text */</span><span class="cp"></span>
<span class="cp">#define RS1056x480	14	</span><span class="cm">/* 132 x 60 text */</span><span class="cp"></span>
<span class="cp">#define RSNoxNo		15</span>
<span class="cm">/* 10-FF */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">hslen</span><span class="p">,</span> <span class="n">vslen</span><span class="p">,</span> <span class="n">vfreq</span><span class="p">;</span> <span class="p">}</span> <span class="n">timmings</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>  <span class="mi">640</span><span class="p">,</span>  <span class="mi">400</span><span class="p">,</span>  <span class="mi">48</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">70</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">640</span><span class="p">,</span>  <span class="mi">480</span><span class="p">,</span>  <span class="mi">48</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">800</span><span class="p">,</span>  <span class="mi">600</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">768</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">272</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">768</span><span class="p">,</span>  <span class="mi">576</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">960</span><span class="p">,</span>  <span class="mi">720</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1152</span><span class="p">,</span>  <span class="mi">864</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1408</span><span class="p">,</span> <span class="mi">1056</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">640</span><span class="p">,</span>  <span class="mi">350</span><span class="p">,</span>  <span class="mi">48</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1056</span><span class="p">,</span>  <span class="mi">344</span><span class="p">,</span>  <span class="mi">96</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1056</span><span class="p">,</span>  <span class="mi">400</span><span class="p">,</span>  <span class="mi">96</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1056</span><span class="p">,</span>  <span class="mi">480</span><span class="p">,</span>  <span class="mi">96</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span>    <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define RSCreate(X,Y)	((X) | ((Y) &lt;&lt; 8))</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vesa</span><span class="p">;</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">info</span><span class="p">;</span> <span class="p">}</span> <span class="o">*</span><span class="n">RSptr</span><span class="p">,</span> <span class="n">vesamap</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* default must be first */</span>
	<span class="p">{</span>    <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RSNoxNo</span><span class="p">,</span>     <span class="n">RS8bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x101</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS640x480</span><span class="p">,</span>   <span class="n">RS8bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS640x400</span><span class="p">,</span>   <span class="n">RS8bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x180</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS768x576</span><span class="p">,</span>   <span class="n">RS8bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x103</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS800x600</span><span class="p">,</span>   <span class="n">RS8bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x188</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS960x720</span><span class="p">,</span>   <span class="n">RS8bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x105</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1024x768</span><span class="p">,</span>  <span class="n">RS8bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x190</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1152x864</span><span class="p">,</span>  <span class="n">RS8bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x107</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1280x1024</span><span class="p">,</span> <span class="n">RS8bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x198</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1408x1056</span><span class="p">,</span> <span class="n">RS8bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x11C</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1600x1200</span><span class="p">,</span> <span class="n">RS8bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x110</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS640x480</span><span class="p">,</span>   <span class="n">RS15bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x181</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS768x576</span><span class="p">,</span>   <span class="n">RS15bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x113</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS800x600</span><span class="p">,</span>   <span class="n">RS15bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x189</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS960x720</span><span class="p">,</span>   <span class="n">RS15bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x116</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1024x768</span><span class="p">,</span>  <span class="n">RS15bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x191</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1152x864</span><span class="p">,</span>  <span class="n">RS15bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x119</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1280x1024</span><span class="p">,</span> <span class="n">RS15bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x199</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1408x1056</span><span class="p">,</span> <span class="n">RS15bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x11D</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1600x1200</span><span class="p">,</span> <span class="n">RS15bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x111</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS640x480</span><span class="p">,</span>   <span class="n">RS16bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x182</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS768x576</span><span class="p">,</span>   <span class="n">RS16bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x114</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS800x600</span><span class="p">,</span>   <span class="n">RS16bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x18A</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS960x720</span><span class="p">,</span>   <span class="n">RS16bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x117</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1024x768</span><span class="p">,</span>  <span class="n">RS16bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x192</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1152x864</span><span class="p">,</span>  <span class="n">RS16bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x11A</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1280x1024</span><span class="p">,</span> <span class="n">RS16bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x19A</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1408x1056</span><span class="p">,</span> <span class="n">RS16bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x11E</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1600x1200</span><span class="p">,</span> <span class="n">RS16bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1B2</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS640x480</span><span class="p">,</span>   <span class="n">RS24bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x184</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS768x576</span><span class="p">,</span>   <span class="n">RS24bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1B5</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS800x600</span><span class="p">,</span>   <span class="n">RS24bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x18C</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS960x720</span><span class="p">,</span>   <span class="n">RS24bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1B8</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1024x768</span><span class="p">,</span>  <span class="n">RS24bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x194</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1152x864</span><span class="p">,</span>  <span class="n">RS24bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1BB</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1280x1024</span><span class="p">,</span> <span class="n">RS24bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x19C</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1408x1056</span><span class="p">,</span> <span class="n">RS24bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1BF</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1600x1200</span><span class="p">,</span> <span class="n">RS24bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x112</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS640x480</span><span class="p">,</span>   <span class="n">RS32bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x183</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS768x576</span><span class="p">,</span>   <span class="n">RS32bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x115</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS800x600</span><span class="p">,</span>   <span class="n">RS32bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x18B</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS960x720</span><span class="p">,</span>   <span class="n">RS32bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x118</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1024x768</span><span class="p">,</span>  <span class="n">RS32bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x193</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1152x864</span><span class="p">,</span>  <span class="n">RS32bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x11B</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1280x1024</span><span class="p">,</span> <span class="n">RS32bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x19B</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1408x1056</span><span class="p">,</span> <span class="n">RS32bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x11F</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1600x1200</span><span class="p">,</span> <span class="n">RS32bpp</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x010</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS640x350</span><span class="p">,</span>   <span class="n">RS4bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x012</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS640x480</span><span class="p">,</span>   <span class="n">RS4bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x102</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS800x600</span><span class="p">,</span>   <span class="n">RS4bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x104</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1024x768</span><span class="p">,</span>  <span class="n">RS4bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x106</span><span class="p">,</span> <span class="n">RSCreate</span><span class="p">(</span><span class="n">RS1280x1024</span><span class="p">,</span> <span class="n">RS4bpp</span> <span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span>     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>				<span class="p">}};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">matroxfb_init_params</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* fh from kHz to Hz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">fh</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* 1kHz minimum */</span>
	<span class="cm">/* maxclk */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxclk</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="n">maxclk</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* kHz -&gt; Hz, MHz -&gt; kHz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxclk</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">)</span> <span class="n">maxclk</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* kHz -&gt; Hz, 1MHz minimum */</span>
	<span class="cm">/* fix VESA number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vesa</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">vesa</span> <span class="o">&amp;=</span> <span class="mh">0x1DFF</span><span class="p">;</span>		<span class="cm">/* mask out clearscreen, acceleration and so on */</span>

	<span class="cm">/* static settings */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">RSptr</span> <span class="o">=</span> <span class="n">vesamap</span><span class="p">;</span> <span class="n">RSptr</span><span class="o">-&gt;</span><span class="n">vesa</span><span class="p">;</span> <span class="n">RSptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RSptr</span><span class="o">-&gt;</span><span class="n">vesa</span> <span class="o">==</span> <span class="n">vesa</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RSptr</span><span class="o">-&gt;</span><span class="n">vesa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid vesa mode 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vesa</span><span class="p">);</span>
		<span class="n">RSptr</span> <span class="o">=</span> <span class="n">vesamap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">RSResolution</span><span class="p">(</span><span class="n">RSptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">timmings</span><span class="p">[</span><span class="n">res</span><span class="p">].</span><span class="n">left</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xres</span><span class="p">)</span>
			<span class="n">xres</span> <span class="o">=</span> <span class="n">timmings</span><span class="p">[</span><span class="n">res</span><span class="p">].</span><span class="n">xres</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">right</span> <span class="o">=</span> <span class="n">timmings</span><span class="p">[</span><span class="n">res</span><span class="p">].</span><span class="n">right</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hslen</span><span class="p">)</span>
			<span class="n">hslen</span> <span class="o">=</span> <span class="n">timmings</span><span class="p">[</span><span class="n">res</span><span class="p">].</span><span class="n">hslen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">upper</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">upper</span> <span class="o">=</span> <span class="n">timmings</span><span class="p">[</span><span class="n">res</span><span class="p">].</span><span class="n">upper</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">yres</span><span class="p">)</span>
			<span class="n">yres</span> <span class="o">=</span> <span class="n">timmings</span><span class="p">[</span><span class="n">res</span><span class="p">].</span><span class="n">yres</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lower</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">lower</span> <span class="o">=</span> <span class="n">timmings</span><span class="p">[</span><span class="n">res</span><span class="p">].</span><span class="n">lower</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vslen</span><span class="p">)</span>
			<span class="n">vslen</span> <span class="o">=</span> <span class="n">timmings</span><span class="p">[</span><span class="n">res</span><span class="p">].</span><span class="n">vslen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fv</span><span class="o">||</span><span class="n">fh</span><span class="o">||</span><span class="n">maxclk</span><span class="o">||</span><span class="n">pixclock</span><span class="p">))</span>
			<span class="n">fv</span> <span class="o">=</span> <span class="n">timmings</span><span class="p">[</span><span class="n">res</span><span class="p">].</span><span class="n">vfreq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="n">RSDepth</span><span class="p">(</span><span class="n">RSptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">matrox_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">matroxfb_init_params</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matroxfb_driver</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* accept all new devices... */</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* **************************** exit-time only **************************** */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">matrox_done</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matroxfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>

<span class="cm">/* ************************* init in-kernel code ************************** */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">matroxfb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;matroxfb_setup: option %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">this_opt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;dev:&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;depth:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>: <span class="n">depth</span> <span class="o">=</span> <span class="n">RSText</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">4</span>: <span class="n">depth</span> <span class="o">=</span> <span class="n">RS4bpp</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">8</span>: <span class="n">depth</span> <span class="o">=</span> <span class="n">RS8bpp</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">15</span>:<span class="n">depth</span> <span class="o">=</span> <span class="n">RS15bpp</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">16</span>:<span class="n">depth</span> <span class="o">=</span> <span class="n">RS16bpp</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">24</span>:<span class="n">depth</span> <span class="o">=</span> <span class="n">RS24bpp</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">32</span>:<span class="n">depth</span> <span class="o">=</span> <span class="n">RS32bpp</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: unsupported color depth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;xres:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">xres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;yres:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">yres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vslen:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">vslen</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;hslen:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">hslen</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;left:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;right:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">right</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;upper:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">upper</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;lower:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">lower</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;pixclock:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
			<span class="n">pixclock</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;sync:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">sync</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vesa:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">vesa</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;maxclk:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">maxclk</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;fh:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">fh</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;fv:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">fv</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mem:&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">mem</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mode:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">videomode</span><span class="p">,</span> <span class="n">this_opt</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">videomode</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;outputs:&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">this_opt</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">outputs</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;dfp:&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dfp_type</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dfp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vmode:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vmode</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">vmode</span> <span class="o">&lt;=</span> <span class="n">VMODE_MAX</span><span class="p">)</span>
				<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">vmode</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;cmode:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmode</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmode</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
				<span class="k">case</span> <span class="mi">8</span>:
					<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_8</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">15</span>:
				<span class="k">case</span> <span class="mi">16</span>:
					<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_16</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">24</span>:
				<span class="k">case</span> <span class="mi">32</span>:
					<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_32</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;disabled&quot;</span><span class="p">))</span>	<span class="cm">/* nodisabled does not exist */</span>
			<span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;enabled&quot;</span><span class="p">))</span>	<span class="cm">/* noenabled does not exist */</span>
			<span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;sgram&quot;</span><span class="p">))</span>	<span class="cm">/* nosgram == sdram */</span>
			<span class="n">sgram</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;sdram&quot;</span><span class="p">))</span>
			<span class="n">sgram</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;memtype:&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">memtype</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;no&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">this_opt</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;inverse&quot;</span><span class="p">))</span>
				<span class="n">inverse</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;accel&quot;</span><span class="p">))</span>
				<span class="n">noaccel</span> <span class="o">=</span> <span class="o">!</span><span class="n">value</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;pan&quot;</span><span class="p">))</span>
				<span class="n">nopan</span> <span class="o">=</span> <span class="o">!</span><span class="n">value</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;pciretry&quot;</span><span class="p">))</span>
				<span class="n">no_pci_retry</span> <span class="o">=</span> <span class="o">!</span><span class="n">value</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vga&quot;</span><span class="p">))</span>
				<span class="n">novga</span> <span class="o">=</span> <span class="o">!</span><span class="n">value</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;bios&quot;</span><span class="p">))</span>
				<span class="n">nobios</span> <span class="o">=</span> <span class="o">!</span><span class="n">value</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;init&quot;</span><span class="p">))</span>
				<span class="n">noinit</span> <span class="o">=</span> <span class="o">!</span><span class="n">value</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mtrr&quot;</span><span class="p">))</span>
				<span class="n">mtrr</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;inv24&quot;</span><span class="p">))</span>
				<span class="n">inv24</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;cross4MB&quot;</span><span class="p">))</span>
				<span class="n">cross4MB</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;grayscale&quot;</span><span class="p">))</span>
				<span class="n">grayscale</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;dfp&quot;</span><span class="p">))</span>
				<span class="n">dfp</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">strlcpy</span><span class="p">(</span><span class="n">videomode</span><span class="p">,</span> <span class="n">this_opt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">videomode</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">matroxfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;matroxfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">matroxfb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">matrox_init</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">hotplug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* never return failure, user can hotplug matrox later... */</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">matroxfb_init</span><span class="p">);</span>

<span class="cp">#else</span>

<span class="cm">/* *************************** init module code **************************** */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;(c) 1998-2002 Petr Vandrovec &lt;vandrove@vc.cvut.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Accelerated FBDev driver for Matrox Millennium/Mystique/G100/G200/G400/G450/G550&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="s">&quot;Size of available memory in MB, KB or B (2,4,8,12,16MB, default=autodetect)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disabled</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disabled</span><span class="p">,</span> <span class="s">&quot;Disabled (0 or 1=disabled) (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="s">&quot;Do not use accelerating engine (0 or 1=disabled) (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nopan</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nopan</span><span class="p">,</span> <span class="s">&quot;Disable pan on startup (0 or 1=disabled) (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">no_pci_retry</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">no_pci_retry</span><span class="p">,</span> <span class="s">&quot;PCI retries enabled (0 or 1=disabled) (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">novga</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">novga</span><span class="p">,</span> <span class="s">&quot;VGA I/O (0x3C0-0x3DF) disabled (0 or 1=disabled) (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nobios</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nobios</span><span class="p">,</span> <span class="s">&quot;Disables ROM BIOS (0 or 1=disabled) (default=do not change BIOS state)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">noinit</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noinit</span><span class="p">,</span> <span class="s">&quot;Disables W/SG/SD-RAM and bus interface initialization (0 or 1=do not initialize) (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">memtype</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">memtype</span><span class="p">,</span> <span class="s">&quot;Memory type for G200/G400 (see Documentation/fb/matroxfb.txt for explanation) (default=3 for G200, 0 for G400)&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mtrr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mtrr</span><span class="p">,</span> <span class="s">&quot;This speeds up video memory accesses (0=disabled or 1) (default=1)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">sgram</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sgram</span><span class="p">,</span> <span class="s">&quot;Indicates that G100/G200/G400 has SGRAM memory (0=SDRAM, 1=SGRAM) (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">inv24</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">inv24</span><span class="p">,</span> <span class="s">&quot;Inverts clock polarity for 24bpp and loop frequency &gt; 100MHz (default=do not invert polarity)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">inverse</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">inverse</span><span class="p">,</span> <span class="s">&quot;Inverse (0 or 1) (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Multihead support, attach to device ID (0..N) (default=all working)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vesa</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vesa</span><span class="p">,</span> <span class="s">&quot;Startup videomode (0x000-0x1FF) (default=0x101)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="s">&quot;Horizontal resolution (px), overrides xres from vesa (default=vesa)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">yres</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">yres</span><span class="p">,</span> <span class="s">&quot;Vertical resolution (scans), overrides yres from vesa (default=vesa)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="s">&quot;Upper blank space (scans), overrides upper from vesa (default=vesa)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="s">&quot;Lower blank space (scans), overrides lower from vesa (default=vesa)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vslen</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vslen</span><span class="p">,</span> <span class="s">&quot;Vertical sync length (scans), overrides lower from vesa (default=vesa)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="s">&quot;Left blank space (px), overrides left from vesa (default=vesa)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="s">&quot;Right blank space (px), overrides right from vesa (default=vesa)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hslen</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hslen</span><span class="p">,</span> <span class="s">&quot;Horizontal sync length (px), overrides hslen from vesa (default=vesa)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pixclock</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pixclock</span><span class="p">,</span> <span class="s">&quot;Pixelclock (ns), overrides pixclock from vesa (default=vesa)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="s">&quot;Sync polarity, overrides sync from vesa (default=vesa)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s">&quot;Color depth (0=text,8,15,16,24,32) (default=vesa)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">maxclk</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">maxclk</span><span class="p">,</span> <span class="s">&quot;Startup maximal clock, 0-999MHz, 1000-999999kHz, 1000000-INF Hz&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s">&quot;Startup horizontal frequency, 0-999kHz, 1000-INF Hz&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fv</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fv</span><span class="p">,</span> <span class="s">&quot;Startup vertical frequency, 0-INF Hz</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;You should specify </span><span class="se">\&quot;</span><span class="s">fv:max_monitor_vsync,fh:max_monitor_hsync,maxclk:max_monitor_dotclock</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">grayscale</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">grayscale</span><span class="p">,</span> <span class="s">&quot;Sets display into grayscale. Works perfectly with paletized videomode (4, 8bpp), some limitations apply to 16, 24 and 32bpp videomodes (default=nograyscale)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cross4MB</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cross4MB</span><span class="p">,</span> <span class="s">&quot;Specifies that 4MB boundary can be in middle of line. (default=autodetected)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dfp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dfp</span><span class="p">,</span> <span class="s">&quot;Specifies whether to use digital flat panel interface of G200/G400 (0 or 1) (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dfp_type</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dfp_type</span><span class="p">,</span> <span class="s">&quot;Specifies DFP interface type (0 to 255) (default=read from hardware)&quot;</span><span class="p">);</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">outputs</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="s">&quot;Specifies which CRTC is mapped to which output (string of up to three letters, consisting of 0 (disabled), 1 (CRTC1), 2 (CRTC2)) (default=111 for Gx50, 101 for G200/G400 with DFP, and 100 for all other devices)&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">vmode</span><span class="p">,</span> <span class="n">default_vmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vmode</span><span class="p">,</span> <span class="s">&quot;Specify the vmode mode number that should be used (640x480 default)&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">cmode</span><span class="p">,</span> <span class="n">default_cmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cmode</span><span class="p">,</span> <span class="s">&quot;Specify the video depth that should be used (8bit default)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="n">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">RSText</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">RS4bpp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">RS8bpp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">RS15bpp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">RS16bpp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">RS24bpp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">RS32bpp</span><span class="p">;</span>
	<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: depth %d is not supported, using default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">matrox_init</span><span class="p">();</span>
	<span class="cm">/* never return failure; user can hotplug matrox later... */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">matrox_done</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matroxfb_register_driver</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matroxfb_unregister_driver</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matroxfb_wait_for_sync</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matroxfb_enable_irq</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Overrides for Emacs so that we follow Linus&#39;s tabbing style.</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
