<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › matrox › matroxfb_Ti3026.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>matroxfb_Ti3026.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Hardware accelerated Matrox Millennium I, II, Mystique, G100, G200 and G400</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 1998-2002 Petr Vandrovec &lt;vandrove@vc.cvut.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Portions Copyright (c) 2001 Matrox Graphics Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Version: 1.65 2002/08/14</span>
<span class="cm"> *</span>
<span class="cm"> * MTRR stuff: 1998 Tom Rini &lt;trini@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Contributors: &quot;menion?&quot; &lt;menion@mindless.com&gt;</span>
<span class="cm"> *                     Betatesting, fixes, ideas</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Kurt Garloff&quot; &lt;garloff@suse.de&gt;</span>
<span class="cm"> *                     Betatesting, fixes, ideas, videomodes, videomodes timmings</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Tom Rini&quot; &lt;trini@kernel.crashing.org&gt;</span>
<span class="cm"> *                     MTRR stuff, PPC cleanups, betatesting, fixes, ideas</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Bibek Sahu&quot; &lt;scorpio@dodds.net&gt;</span>
<span class="cm"> *                     Access device through readb|w|l and write b|w|l</span>
<span class="cm"> *                     Extensive debugging stuff</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Daniel Haun&quot; &lt;haund@usa.net&gt;</span>
<span class="cm"> *                     Testing, hardware cursor fixes</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Scott Wood&quot; &lt;sawst46+@pitt.edu&gt;</span>
<span class="cm"> *                     Fixes</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Gerd Knorr&quot; &lt;kraxel@goldbach.isdn.cs.tu-berlin.de&gt;</span>
<span class="cm"> *                     Betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Kelly French&quot; &lt;targon@hazmat.com&gt;</span>
<span class="cm"> *               &quot;Fernando Herrera&quot; &lt;fherrera@eurielec.etsit.upm.es&gt;</span>
<span class="cm"> *                     Betatesting, bug reporting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Pablo Bianucci&quot; &lt;pbian@pccp.com.ar&gt;</span>
<span class="cm"> *                     Fixes, ideas, betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Inaky Perez Gonzalez&quot; &lt;inaky@peloncho.fis.ucm.es&gt;</span>
<span class="cm"> *                     Fixes, enhandcements, ideas, betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Ryuichi Oikawa&quot; &lt;roikawa@rr.iiij4u.or.jp&gt;</span>
<span class="cm"> *                     PPC betatesting, PPC support, backward compatibility</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Paul Womar&quot; &lt;Paul@pwomar.demon.co.uk&gt;</span>
<span class="cm"> *               &quot;Owen Waller&quot; &lt;O.Waller@ee.qub.ac.uk&gt;</span>
<span class="cm"> *                     PPC betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Thomas Pornin&quot; &lt;pornin@bolet.ens.fr&gt;</span>
<span class="cm"> *                     Alpha betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Pieter van Leuven&quot; &lt;pvl@iae.nl&gt;</span>
<span class="cm"> *               &quot;Ulf Jaenicke-Roessler&quot; &lt;ujr@physik.phy.tu-dresden.de&gt;</span>
<span class="cm"> *                     G100 testing</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;H. Peter Arvin&quot; &lt;hpa@transmeta.com&gt;</span>
<span class="cm"> *                     Ideas</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Cort Dougan&quot; &lt;cort@cs.nmt.edu&gt;</span>
<span class="cm"> *                     CHRP fixes and PReP cleanup</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Mark Vojkovich&quot; &lt;mvojkovi@ucsd.edu&gt;</span>
<span class="cm"> *                     G400 support</span>
<span class="cm"> *</span>
<span class="cm"> * (following author is not in any relation with this code, but his code</span>
<span class="cm"> *  is included in this driver)</span>
<span class="cm"> *</span>
<span class="cm"> * Based on framebuffer driver for VBE 2.0 compliant graphic boards</span>
<span class="cm"> *     (c) 1998 Gerd Knorr &lt;kraxel@cs.tu-berlin.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * (following author is not in any relation with this code, but his ideas</span>
<span class="cm"> *  were used when writing this driver)</span>
<span class="cm"> *</span>
<span class="cm"> *		 FreeVBE/AF (Matrox), &quot;Shawn Hargreaves&quot; &lt;shawn@talula.demon.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#include &quot;matroxfb_Ti3026.h&quot;</span>
<span class="cp">#include &quot;matroxfb_misc.h&quot;</span>
<span class="cp">#include &quot;matroxfb_accel.h&quot;</span>
<span class="cp">#include &lt;linux/matroxfb.h&gt;</span>

<span class="cp">#ifdef CONFIG_FB_MATROX_MILLENIUM</span>
<span class="cp">#define outTi3026 matroxfb_DAC_out</span>
<span class="cp">#define inTi3026 matroxfb_DAC_in</span>

<span class="cp">#define TVP3026_INDEX		0x00</span>
<span class="cp">#define TVP3026_PALWRADD	0x00</span>
<span class="cp">#define TVP3026_PALDATA		0x01</span>
<span class="cp">#define TVP3026_PIXRDMSK	0x02</span>
<span class="cp">#define TVP3026_PALRDADD	0x03</span>
<span class="cp">#define TVP3026_CURCOLWRADD	0x04</span>
<span class="cp">#define     TVP3026_CLOVERSCAN		0x00</span>
<span class="cp">#define     TVP3026_CLCOLOR0		0x01</span>
<span class="cp">#define     TVP3026_CLCOLOR1		0x02</span>
<span class="cp">#define     TVP3026_CLCOLOR2		0x03</span>
<span class="cp">#define TVP3026_CURCOLDATA	0x05</span>
<span class="cp">#define TVP3026_CURCOLRDADD	0x07</span>
<span class="cp">#define TVP3026_CURCTRL		0x09</span>
<span class="cp">#define TVP3026_X_DATAREG	0x0A</span>
<span class="cp">#define TVP3026_CURRAMDATA	0x0B</span>
<span class="cp">#define TVP3026_CURPOSXL	0x0C</span>
<span class="cp">#define TVP3026_CURPOSXH	0x0D</span>
<span class="cp">#define TVP3026_CURPOSYL	0x0E</span>
<span class="cp">#define TVP3026_CURPOSYH	0x0F</span>

<span class="cp">#define TVP3026_XSILICONREV	0x01</span>
<span class="cp">#define TVP3026_XCURCTRL	0x06</span>
<span class="cp">#define     TVP3026_XCURCTRL_DIS	0x00	</span><span class="cm">/* transparent, transparent, transparent, transparent */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XCURCTRL_3COLOR	0x01	</span><span class="cm">/* transparent, 0, 1, 2 */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XCURCTRL_XGA	0x02	</span><span class="cm">/* 0, 1, transparent, complement */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XCURCTRL_XWIN	0x03	</span><span class="cm">/* transparent, transparent, 0, 1 */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XCURCTRL_BLANK2048	0x00</span>
<span class="cp">#define     TVP3026_XCURCTRL_BLANK4096	0x10</span>
<span class="cp">#define     TVP3026_XCURCTRL_INTERLACED	0x20</span>
<span class="cp">#define     TVP3026_XCURCTRL_ODD	0x00 </span><span class="cm">/* ext.signal ODD/\EVEN */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XCURCTRL_EVEN	0x40 </span><span class="cm">/* ext.signal EVEN/\ODD */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XCURCTRL_INDIRECT	0x00</span>
<span class="cp">#define     TVP3026_XCURCTRL_DIRECT	0x80</span>
<span class="cp">#define TVP3026_XLATCHCTRL	0x0F</span>
<span class="cp">#define     TVP3026_XLATCHCTRL_1_1	0x06</span>
<span class="cp">#define     TVP3026_XLATCHCTRL_2_1	0x07</span>
<span class="cp">#define     TVP3026_XLATCHCTRL_4_1	0x06</span>
<span class="cp">#define     TVP3026_XLATCHCTRL_8_1	0x06</span>
<span class="cp">#define     TVP3026_XLATCHCTRL_16_1	0x06</span>
<span class="cp">#define     TVP3026A_XLATCHCTRL_4_3	0x06	</span><span class="cm">/* ??? do not understand... but it works... !!! */</span><span class="cp"></span>
<span class="cp">#define     TVP3026A_XLATCHCTRL_8_3	0x07</span>
<span class="cp">#define     TVP3026B_XLATCHCTRL_4_3	0x08</span>
<span class="cp">#define     TVP3026B_XLATCHCTRL_8_3	0x06	</span><span class="cm">/* ??? do not understand... but it works... !!! */</span><span class="cp"></span>
<span class="cp">#define TVP3026_XTRUECOLORCTRL	0x18</span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_VRAM_SHIFT_ACCEL	0x00</span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_VRAM_SHIFT_TVP	0x20</span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_PSEUDOCOLOR		0x80</span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_TRUECOLOR		0x40 </span><span class="cm">/* paletized */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_DIRECTCOLOR		0x00</span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_24_ALTERNATE		0x08 </span><span class="cm">/* 5:4/5:2 instead of 4:3/8:3 */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_RGB_888		0x16 </span><span class="cm">/* 4:3/8:3 (or 5:4/5:2) */</span><span class="cp"></span>
<span class="cp">#define	    TVP3026_XTRUECOLORCTRL_BGR_888		0x17</span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_ORGB_8888		0x06</span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_BGRO_8888		0x07</span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_RGB_565		0x05</span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_ORGB_1555		0x04</span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_RGB_664		0x03</span>
<span class="cp">#define     TVP3026_XTRUECOLORCTRL_RGBO_4444		0x01</span>
<span class="cp">#define TVP3026_XMUXCTRL	0x19</span>
<span class="cp">#define     TVP3026_XMUXCTRL_MEMORY_8BIT			0x01 </span><span class="cm">/* - */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XMUXCTRL_MEMORY_16BIT			0x02 </span><span class="cm">/* - */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XMUXCTRL_MEMORY_32BIT			0x03 </span><span class="cm">/* 2MB RAM, 512K * 4 */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XMUXCTRL_MEMORY_64BIT			0x04 </span><span class="cm">/* &gt;2MB RAM, 512K * 8 &amp; more */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XMUXCTRL_PIXEL_4BIT				0x40 </span><span class="cm">/* L0,H0,L1,H1... */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XMUXCTRL_PIXEL_4BIT_SWAPPED			0x60 </span><span class="cm">/* H0,L0,H1,L1... */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XMUXCTRL_PIXEL_8BIT				0x48</span>
<span class="cp">#define     TVP3026_XMUXCTRL_PIXEL_16BIT			0x50</span>
<span class="cp">#define     TVP3026_XMUXCTRL_PIXEL_32BIT			0x58</span>
<span class="cp">#define     TVP3026_XMUXCTRL_VGA				0x98 </span><span class="cm">/* VGA MEMORY, 8BIT PIXEL */</span><span class="cp"></span>
<span class="cp">#define TVP3026_XCLKCTRL	0x1A</span>
<span class="cp">#define     TVP3026_XCLKCTRL_DIV1	0x00</span>
<span class="cp">#define     TVP3026_XCLKCTRL_DIV2	0x10</span>
<span class="cp">#define     TVP3026_XCLKCTRL_DIV4	0x20</span>
<span class="cp">#define     TVP3026_XCLKCTRL_DIV8	0x30</span>
<span class="cp">#define     TVP3026_XCLKCTRL_DIV16	0x40</span>
<span class="cp">#define     TVP3026_XCLKCTRL_DIV32	0x50</span>
<span class="cp">#define     TVP3026_XCLKCTRL_DIV64	0x60</span>
<span class="cp">#define     TVP3026_XCLKCTRL_CLKSTOPPED	0x70</span>
<span class="cp">#define     TVP3026_XCLKCTRL_SRC_CLK0	0x00</span>
<span class="cp">#define     TVP3026_XCLKCTRL_SRC_CLK1   0x01</span>
<span class="cp">#define     TVP3026_XCLKCTRL_SRC_CLK2	0x02	</span><span class="cm">/* CLK2 is TTL source*/</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XCLKCTRL_SRC_NCLK2	0x03	</span><span class="cm">/* not CLK2 is TTL source */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XCLKCTRL_SRC_ECLK2	0x04	</span><span class="cm">/* CLK2 and not CLK2 is ECL source */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XCLKCTRL_SRC_PLL	0x05</span>
<span class="cp">#define     TVP3026_XCLKCTRL_SRC_DIS	0x06	</span><span class="cm">/* disable &amp; poweroff internal clock */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XCLKCTRL_SRC_CLK0VGA 0x07</span>
<span class="cp">#define TVP3026_XPALETTEPAGE	0x1C</span>
<span class="cp">#define TVP3026_XGENCTRL	0x1D</span>
<span class="cp">#define     TVP3026_XGENCTRL_HSYNC_POS	0x00</span>
<span class="cp">#define     TVP3026_XGENCTRL_HSYNC_NEG	0x01</span>
<span class="cp">#define     TVP3026_XGENCTRL_VSYNC_POS	0x00</span>
<span class="cp">#define     TVP3026_XGENCTRL_VSYNC_NEG	0x02</span>
<span class="cp">#define     TVP3026_XGENCTRL_LITTLE_ENDIAN 0x00</span>
<span class="cp">#define     TVP3026_XGENCTRL_BIG_ENDIAN    0x08</span>
<span class="cp">#define     TVP3026_XGENCTRL_BLACK_0IRE		0x00</span>
<span class="cp">#define     TVP3026_XGENCTRL_BLACK_75IRE	0x10</span>
<span class="cp">#define     TVP3026_XGENCTRL_NO_SYNC_ON_GREEN	0x00</span>
<span class="cp">#define     TVP3026_XGENCTRL_SYNC_ON_GREEN	0x20</span>
<span class="cp">#define     TVP3026_XGENCTRL_OVERSCAN_DIS	0x00</span>
<span class="cp">#define     TVP3026_XGENCTRL_OVERSCAN_EN	0x40</span>
<span class="cp">#define TVP3026_XMISCCTRL	0x1E</span>
<span class="cp">#define     TVP3026_XMISCCTRL_DAC_PUP	0x00</span>
<span class="cp">#define     TVP3026_XMISCCTRL_DAC_PDOWN	0x01</span>
<span class="cp">#define     TVP3026_XMISCCTRL_DAC_EXT	0x00 </span><span class="cm">/* or 8, bit 3 is ignored */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XMISCCTRL_DAC_6BIT	0x04</span>
<span class="cp">#define     TVP3026_XMISCCTRL_DAC_8BIT	0x0C</span>
<span class="cp">#define     TVP3026_XMISCCTRL_PSEL_DIS	0x00</span>
<span class="cp">#define     TVP3026_XMISCCTRL_PSEL_EN	0x10</span>
<span class="cp">#define     TVP3026_XMISCCTRL_PSEL_LOW	0x00 </span><span class="cm">/* PSEL high selects directcolor */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XMISCCTRL_PSEL_HIGH 0x20 </span><span class="cm">/* PSEL high selects truecolor or pseudocolor */</span><span class="cp"></span>
<span class="cp">#define TVP3026_XGENIOCTRL	0x2A</span>
<span class="cp">#define TVP3026_XGENIODATA	0x2B</span>
<span class="cp">#define TVP3026_XPLLADDR	0x2C</span>
<span class="cp">#define     TVP3026_XPLLADDR_X(LOOP,MCLK,PIX) (((LOOP)&lt;&lt;4) | ((MCLK)&lt;&lt;2) | (PIX))</span>
<span class="cp">#define     TVP3026_XPLLDATA_N		0x00</span>
<span class="cp">#define     TVP3026_XPLLDATA_M		0x01</span>
<span class="cp">#define     TVP3026_XPLLDATA_P		0x02</span>
<span class="cp">#define     TVP3026_XPLLDATA_STAT	0x03</span>
<span class="cp">#define TVP3026_XPIXPLLDATA	0x2D</span>
<span class="cp">#define TVP3026_XMEMPLLDATA	0x2E</span>
<span class="cp">#define TVP3026_XLOOPPLLDATA	0x2F</span>
<span class="cp">#define TVP3026_XCOLKEYOVRMIN	0x30</span>
<span class="cp">#define TVP3026_XCOLKEYOVRMAX	0x31</span>
<span class="cp">#define TVP3026_XCOLKEYREDMIN	0x32</span>
<span class="cp">#define TVP3026_XCOLKEYREDMAX	0x33</span>
<span class="cp">#define TVP3026_XCOLKEYGREENMIN	0x34</span>
<span class="cp">#define TVP3026_XCOLKEYGREENMAX	0x35</span>
<span class="cp">#define TVP3026_XCOLKEYBLUEMIN	0x36</span>
<span class="cp">#define TVP3026_XCOLKEYBLUEMAX	0x37</span>
<span class="cp">#define TVP3026_XCOLKEYCTRL	0x38</span>
<span class="cp">#define     TVP3026_XCOLKEYCTRL_OVR_EN	0x01</span>
<span class="cp">#define     TVP3026_XCOLKEYCTRL_RED_EN	0x02</span>
<span class="cp">#define     TVP3026_XCOLKEYCTRL_GREEN_EN 0x04</span>
<span class="cp">#define     TVP3026_XCOLKEYCTRL_BLUE_EN	0x08</span>
<span class="cp">#define     TVP3026_XCOLKEYCTRL_NEGATE	0x10</span>
<span class="cp">#define     TVP3026_XCOLKEYCTRL_ZOOM1	0x00</span>
<span class="cp">#define     TVP3026_XCOLKEYCTRL_ZOOM2	0x20</span>
<span class="cp">#define     TVP3026_XCOLKEYCTRL_ZOOM4	0x40</span>
<span class="cp">#define     TVP3026_XCOLKEYCTRL_ZOOM8	0x60</span>
<span class="cp">#define     TVP3026_XCOLKEYCTRL_ZOOM16	0x80</span>
<span class="cp">#define     TVP3026_XCOLKEYCTRL_ZOOM32	0xA0</span>
<span class="cp">#define TVP3026_XMEMPLLCTRL	0x39</span>
<span class="cp">#define     TVP3026_XMEMPLLCTRL_DIV(X)	(((X)-1)&gt;&gt;1)	</span><span class="cm">/* 2,4,6,8,10,12,14,16, division applied to LOOP PLL after divide by 2^P */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XMEMPLLCTRL_STROBEMKC4	0x08</span>
<span class="cp">#define     TVP3026_XMEMPLLCTRL_MCLK_DOTCLOCK	0x00	</span><span class="cm">/* MKC4 */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XMEMPLLCTRL_MCLK_MCLKPLL	0x10	</span><span class="cm">/* MKC4 */</span><span class="cp"></span>
<span class="cp">#define     TVP3026_XMEMPLLCTRL_RCLK_PIXPLL	0x00</span>
<span class="cp">#define     TVP3026_XMEMPLLCTRL_RCLK_LOOPPLL	0x20</span>
<span class="cp">#define     TVP3026_XMEMPLLCTRL_RCLK_DOTDIVN	0x40	</span><span class="cm">/* dot clock divided by loop pclk N prescaler */</span><span class="cp"></span>
<span class="cp">#define TVP3026_XSENSETEST	0x3A</span>
<span class="cp">#define TVP3026_XTESTMODEDATA	0x3B</span>
<span class="cp">#define TVP3026_XCRCREML	0x3C</span>
<span class="cp">#define TVP3026_XCRCREMH	0x3D</span>
<span class="cp">#define TVP3026_XCRCBITSEL	0x3E</span>
<span class="cp">#define TVP3026_XID		0x3F</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">DACseq</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span> <span class="n">TVP3026_XLATCHCTRL</span><span class="p">,</span> <span class="n">TVP3026_XTRUECOLORCTRL</span><span class="p">,</span>
  <span class="n">TVP3026_XMUXCTRL</span><span class="p">,</span> <span class="n">TVP3026_XCLKCTRL</span><span class="p">,</span>
  <span class="n">TVP3026_XPALETTEPAGE</span><span class="p">,</span>
  <span class="n">TVP3026_XGENCTRL</span><span class="p">,</span>
  <span class="n">TVP3026_XMISCCTRL</span><span class="p">,</span>
  <span class="n">TVP3026_XGENIOCTRL</span><span class="p">,</span>
  <span class="n">TVP3026_XGENIODATA</span><span class="p">,</span>
  <span class="n">TVP3026_XCOLKEYOVRMIN</span><span class="p">,</span> <span class="n">TVP3026_XCOLKEYOVRMAX</span><span class="p">,</span> <span class="n">TVP3026_XCOLKEYREDMIN</span><span class="p">,</span> <span class="n">TVP3026_XCOLKEYREDMAX</span><span class="p">,</span>
  <span class="n">TVP3026_XCOLKEYGREENMIN</span><span class="p">,</span> <span class="n">TVP3026_XCOLKEYGREENMAX</span><span class="p">,</span> <span class="n">TVP3026_XCOLKEYBLUEMIN</span><span class="p">,</span> <span class="n">TVP3026_XCOLKEYBLUEMAX</span><span class="p">,</span>
  <span class="n">TVP3026_XCOLKEYCTRL</span><span class="p">,</span>
  <span class="n">TVP3026_XMEMPLLCTRL</span><span class="p">,</span> <span class="n">TVP3026_XSENSETEST</span><span class="p">,</span> <span class="n">TVP3026_XCURCTRL</span> <span class="p">};</span>

<span class="cp">#define POS3026_XLATCHCTRL	0</span>
<span class="cp">#define POS3026_XTRUECOLORCTRL	1</span>
<span class="cp">#define POS3026_XMUXCTRL	2</span>
<span class="cp">#define POS3026_XCLKCTRL	3</span>
<span class="cp">#define POS3026_XGENCTRL	5</span>
<span class="cp">#define POS3026_XMISCCTRL	6</span>
<span class="cp">#define POS3026_XMEMPLLCTRL	18</span>
<span class="cp">#define POS3026_XCURCTRL	20</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">MGADACbpp32</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span> <span class="n">TVP3026_XLATCHCTRL_2_1</span><span class="p">,</span> <span class="n">TVP3026_XTRUECOLORCTRL_DIRECTCOLOR</span> <span class="o">|</span> <span class="n">TVP3026_XTRUECOLORCTRL_ORGB_8888</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP3026_XCLKCTRL_DIV1</span> <span class="o">|</span> <span class="n">TVP3026_XCLKCTRL_SRC_PLL</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span>
  <span class="n">TVP3026_XGENCTRL_HSYNC_POS</span> <span class="o">|</span> <span class="n">TVP3026_XGENCTRL_VSYNC_POS</span> <span class="o">|</span> <span class="n">TVP3026_XGENCTRL_LITTLE_ENDIAN</span> <span class="o">|</span> <span class="n">TVP3026_XGENCTRL_BLACK_0IRE</span> <span class="o">|</span> <span class="n">TVP3026_XGENCTRL_NO_SYNC_ON_GREEN</span> <span class="o">|</span> <span class="n">TVP3026_XGENCTRL_OVERSCAN_DIS</span><span class="p">,</span>
  <span class="n">TVP3026_XMISCCTRL_DAC_PUP</span> <span class="o">|</span> <span class="n">TVP3026_XMISCCTRL_DAC_8BIT</span> <span class="o">|</span> <span class="n">TVP3026_XMISCCTRL_PSEL_DIS</span> <span class="o">|</span> <span class="n">TVP3026_XMISCCTRL_PSEL_HIGH</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span>
  <span class="mh">0x1E</span><span class="p">,</span>
  <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
  <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
  <span class="n">TVP3026_XCOLKEYCTRL_ZOOM1</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TVP3026_XCURCTRL_DIS</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Ti3026_calcclock</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmax</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="o">*</span><span class="n">feed</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">post</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fvco</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lin</span><span class="p">,</span> <span class="n">lfeed</span><span class="p">,</span> <span class="n">lpost</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">fvco</span> <span class="o">=</span> <span class="n">PLL_calcclock</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lfeed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpost</span><span class="p">);</span>
	<span class="n">fvco</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="o">*</span><span class="n">post</span> <span class="o">=</span> <span class="n">lpost</span><span class="p">);</span>
	<span class="o">*</span><span class="n">in</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">-</span> <span class="n">lin</span><span class="p">;</span>
	<span class="o">*</span><span class="n">feed</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">-</span> <span class="n">lfeed</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fvco</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Ti3026_setpclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">f_pll</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixfeed</span><span class="p">,</span> <span class="n">pixin</span><span class="p">,</span> <span class="n">pixpost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">f_pll</span> <span class="o">=</span> <span class="n">Ti3026_calcclock</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">max_pixel_clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pixin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pixfeed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pixpost</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixin</span> <span class="o">|</span> <span class="mh">0xC0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixfeed</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixpost</span> <span class="o">|</span> <span class="mh">0xB0</span><span class="p">;</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loopfeed</span><span class="p">,</span> <span class="n">loopin</span><span class="p">,</span> <span class="n">looppost</span><span class="p">,</span> <span class="n">loopdiv</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Bpp</span><span class="p">;</span>

		<span class="n">Bpp</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">final_bppShift</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">loopfeed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* set lm to any possible value */</span>
			<span class="n">loopin</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">/</span> <span class="n">Bpp</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">loopfeed</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">loopin</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">/</span> <span class="n">Bpp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="mi">110000</span> <span class="o">*</span> <span class="n">loopin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">f_pll</span> <span class="o">*</span> <span class="n">loopfeed</span><span class="p">);</span>
		<span class="n">loopdiv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* div 2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">looppost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">looppost</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">looppost</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">looppost</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">loopdiv</span> <span class="o">=</span> <span class="n">z</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">65</span> <span class="o">-</span> <span class="n">loopin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xC0</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">65</span> <span class="o">-</span> <span class="n">loopfeed</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">accel</span><span class="p">.</span><span class="n">ramdac_rev</span> <span class="o">&gt;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">isInterleave</span><span class="p">(</span><span class="n">minfo</span><span class="p">))</span>
					<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XLATCHCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026B_XLATCHCTRL_8_3</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xC0</span><span class="p">;</span>
					<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XLATCHCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026B_XLATCHCTRL_4_3</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">isInterleave</span><span class="p">(</span><span class="n">minfo</span><span class="p">))</span>
					<span class="p">;</span>	<span class="cm">/* default... */</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xC0</span><span class="p">;</span>	<span class="cm">/* change from 0x80 to 0x40 */</span>
					<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XLATCHCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026A_XLATCHCTRL_4_3</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">looppost</span> <span class="o">|</span> <span class="mh">0xF8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">mga_24bpp_fix</span><span class="p">)</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">65</span> <span class="o">-</span> <span class="n">loopin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xC0</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">65</span> <span class="o">-</span> <span class="n">loopfeed</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">looppost</span> <span class="o">|</span> <span class="mh">0xF0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XMEMPLLCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">loopdiv</span> <span class="o">|</span> <span class="n">TVP3026_XMEMPLLCTRL_MCLK_MCLKPLL</span> <span class="o">|</span> <span class="n">TVP3026_XMEMPLLCTRL_RCLK_LOOPPLL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Ti3026_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">my_timming</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int8_t</span> <span class="n">muxctrl</span> <span class="o">=</span> <span class="n">isInterleave</span><span class="p">(</span><span class="n">minfo</span><span class="p">)</span> <span class="o">?</span> <span class="n">TVP3026_XMUXCTRL_MEMORY_64BIT</span> <span class="o">:</span> <span class="n">TVP3026_XMUXCTRL_MEMORY_32BIT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">,</span> <span class="n">MGADACbpp32</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>:	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XLATCHCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026_XLATCHCTRL_16_1</span><span class="p">;</span>	<span class="cm">/* or _8_1, they are same */</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XTRUECOLORCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026_XTRUECOLORCTRL_PSEUDOCOLOR</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XMUXCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">muxctrl</span> <span class="o">|</span> <span class="n">TVP3026_XMUXCTRL_PIXEL_4BIT</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XCLKCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026_XCLKCTRL_SRC_PLL</span> <span class="o">|</span> <span class="n">TVP3026_XCLKCTRL_DIV8</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XMISCCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026_XMISCCTRL_DAC_PUP</span> <span class="o">|</span> <span class="n">TVP3026_XMISCCTRL_DAC_8BIT</span> <span class="o">|</span> <span class="n">TVP3026_XMISCCTRL_PSEL_DIS</span> <span class="o">|</span> <span class="n">TVP3026_XMISCCTRL_PSEL_LOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>: <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XLATCHCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026_XLATCHCTRL_8_1</span><span class="p">;</span>	<span class="cm">/* or _4_1, they are same */</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XTRUECOLORCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026_XTRUECOLORCTRL_PSEUDOCOLOR</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XMUXCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">muxctrl</span> <span class="o">|</span> <span class="n">TVP3026_XMUXCTRL_PIXEL_8BIT</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XCLKCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026_XCLKCTRL_SRC_PLL</span> <span class="o">|</span> <span class="n">TVP3026_XCLKCTRL_DIV4</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XMISCCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026_XMISCCTRL_DAC_PUP</span> <span class="o">|</span> <span class="n">TVP3026_XMISCCTRL_DAC_8BIT</span> <span class="o">|</span> <span class="n">TVP3026_XMISCCTRL_PSEL_DIS</span> <span class="o">|</span> <span class="n">TVP3026_XMISCCTRL_PSEL_LOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="cm">/* XLATCHCTRL should be _4_1 / _2_1... Why is not? (_2_1 is used every time) */</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XTRUECOLORCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">TVP3026_XTRUECOLORCTRL_DIRECTCOLOR</span> <span class="o">|</span> <span class="n">TVP3026_XTRUECOLORCTRL_ORGB_1555</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">TVP3026_XTRUECOLORCTRL_DIRECTCOLOR</span> <span class="o">|</span> <span class="n">TVP3026_XTRUECOLORCTRL_RGB_565</span><span class="p">);</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XMUXCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">muxctrl</span> <span class="o">|</span> <span class="n">TVP3026_XMUXCTRL_PIXEL_16BIT</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XCLKCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026_XCLKCTRL_SRC_PLL</span> <span class="o">|</span> <span class="n">TVP3026_XCLKCTRL_DIV2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>:
			<span class="cm">/* XLATCHCTRL is: for (A) use _4_3 (?_8_3 is same? TBD), for (B) it is set in setpclk */</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XTRUECOLORCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026_XTRUECOLORCTRL_DIRECTCOLOR</span> <span class="o">|</span> <span class="n">TVP3026_XTRUECOLORCTRL_RGB_888</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XMUXCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">muxctrl</span> <span class="o">|</span> <span class="n">TVP3026_XMUXCTRL_PIXEL_32BIT</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XCLKCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVP3026_XCLKCTRL_SRC_PLL</span> <span class="o">|</span> <span class="n">TVP3026_XCLKCTRL_DIV4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="cm">/* XLATCHCTRL should be _2_1 / _1_1... Why is not? (_2_1 is used every time) */</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XMUXCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">muxctrl</span> <span class="o">|</span> <span class="n">TVP3026_XMUXCTRL_PIXEL_32BIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* TODO: failed */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">matroxfb_vgaHWinit</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* set SYNC */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">=</span> <span class="mh">0xCB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XGENCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TVP3026_XGENCTRL_HSYNC_NEG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XGENCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TVP3026_XGENCTRL_VSYNC_NEG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_ON_GREEN</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XGENCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TVP3026_XGENCTRL_SYNC_ON_GREEN</span><span class="p">;</span>

	<span class="cm">/* set DELAY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mh">0x400000</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mh">0x400000</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="cm">/* set HWCURSOR */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XCURCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TVP3026_XCURCTRL_INTERLACED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">HTotal</span> <span class="o">&gt;=</span> <span class="mi">1536</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XCURCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TVP3026_XCURCTRL_BLANK4096</span><span class="p">;</span>

	<span class="cm">/* set interleaving */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00001000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isInterleave</span><span class="p">(</span><span class="n">minfo</span><span class="p">))</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x00001000</span><span class="p">;</span>

	<span class="cm">/* set DAC */</span>
	<span class="n">Ti3026_setpclk</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti3026_setMCLK</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">f_pll</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pclk_m</span><span class="p">,</span> <span class="n">pclk_n</span><span class="p">,</span> <span class="n">pclk_p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mclk_m</span><span class="p">,</span> <span class="n">mclk_n</span><span class="p">,</span> <span class="n">mclk_p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rfhcnt</span><span class="p">,</span> <span class="n">mclk_ctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmout</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">f_pll</span> <span class="o">=</span> <span class="n">Ti3026_calcclock</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">fout</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">max_pixel_clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mclk_n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mclk_m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mclk_p</span><span class="p">);</span>

	<span class="cm">/* save pclk */</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">);</span>
	<span class="n">pclk_n</span> <span class="o">=</span> <span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">);</span>
	<span class="n">pclk_m</span> <span class="o">=</span> <span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">);</span>
	<span class="n">pclk_p</span> <span class="o">=</span> <span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">);</span>

	<span class="cm">/* stop pclk */</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* set pclk to new mclk */</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">,</span> <span class="n">mclk_n</span> <span class="o">|</span> <span class="mh">0xC0</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">,</span> <span class="n">mclk_m</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">,</span> <span class="n">mclk_p</span> <span class="o">|</span> <span class="mh">0xB0</span><span class="p">);</span>

	<span class="cm">/* wait for PLL to lock */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tmout</span><span class="p">;</span> <span class="n">tmout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmout</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: Temporary pixel PLL not locked after 5 secs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* output pclk on mclk pin */</span>
	<span class="n">mclk_ctl</span> <span class="o">=</span> <span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLCTRL</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLCTRL</span><span class="p">,</span> <span class="n">mclk_ctl</span> <span class="o">&amp;</span> <span class="mh">0xE7</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLCTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">mclk_ctl</span> <span class="o">&amp;</span> <span class="mh">0xE7</span><span class="p">)</span> <span class="o">|</span> <span class="n">TVP3026_XMEMPLLCTRL_STROBEMKC4</span><span class="p">);</span>

	<span class="cm">/* stop MCLK */</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLDATA</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* set mclk to new freq */</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLDATA</span><span class="p">,</span> <span class="n">mclk_n</span> <span class="o">|</span> <span class="mh">0xC0</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLDATA</span><span class="p">,</span> <span class="n">mclk_m</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLDATA</span><span class="p">,</span> <span class="n">mclk_p</span> <span class="o">|</span> <span class="mh">0xB0</span><span class="p">);</span>

	<span class="cm">/* wait for PLL to lock */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tmout</span><span class="p">;</span> <span class="n">tmout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLDATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmout</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: Memory PLL not locked after 5 secs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">f_pll</span> <span class="o">=</span> <span class="n">f_pll</span> <span class="o">*</span> <span class="mi">333</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">&lt;&lt;</span> <span class="n">mclk_p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isMilleniumII</span><span class="p">(</span><span class="n">minfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rfhcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_pll</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfhcnt</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">rfhcnt</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rfhcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_pll</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfhcnt</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">rfhcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">=</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x000F0000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rfhcnt</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span><span class="p">);</span>

	<span class="cm">/* output MCLK to MCLK pin */</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLCTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">mclk_ctl</span> <span class="o">&amp;</span> <span class="mh">0xE7</span><span class="p">)</span> <span class="o">|</span> <span class="n">TVP3026_XMEMPLLCTRL_MCLK_MCLKPLL</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLCTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">mclk_ctl</span>       <span class="p">)</span> <span class="o">|</span> <span class="n">TVP3026_XMEMPLLCTRL_MCLK_MCLKPLL</span> <span class="o">|</span> <span class="n">TVP3026_XMEMPLLCTRL_STROBEMKC4</span><span class="p">);</span>

	<span class="cm">/* stop PCLK */</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* restore pclk */</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">,</span> <span class="n">pclk_n</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">,</span> <span class="n">pclk_m</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">,</span> <span class="n">pclk_p</span><span class="p">);</span>

	<span class="cm">/* wait for PLL to lock */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tmout</span><span class="p">;</span> <span class="n">tmout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmout</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: Pixel PLL not locked after 5 secs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti3026_ramdac_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">vco_freq_min</span> <span class="o">=</span> <span class="mi">110000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	 <span class="o">=</span> <span class="mi">114545</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">feed_div_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">feed_div_max</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">in_div_min</span>	 <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">in_div_max</span>	 <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">post_shift_max</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">noinit</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ti3026_setMCLK</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">60000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">Ti3026_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">progdac</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">CRITFLAGS</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;EXTVGA regs: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%02X:&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">CRITBEGIN</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span><span class="p">);</span>

	<span class="n">CRITEND</span>

	<span class="n">matroxfb_vgaHWrestore</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>

	<span class="n">CRITBEGIN</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">panpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DACseq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">progdac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">);</span>
	<span class="n">progdac</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XLOOPPLLDATA</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
	<span class="n">progdac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">);</span>
	<span class="n">progdac</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XLOOPPLLDATA</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">);</span>
	<span class="n">progdac</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">);</span>
	<span class="n">progdac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XLOOPPLLDATA</span><span class="p">);</span>

	<span class="n">CRITEND</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">,</span> <span class="n">progdac</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* agrhh... setting up PLL is very slow on Millennium... */</span>
		<span class="cm">/* Mystique PLL is locked in few ms, but Millennium PLL lock takes about 0.15 s... */</span>
		<span class="cm">/* Maybe even we should call schedule() ? */</span>

		<span class="n">CRITBEGIN</span>
		<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XCLKCTRL</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XCLKCTRL</span><span class="p">]);</span>
		<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">);</span>
		<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XLOOPPLLDATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="cm">/* wait for PLL only if PLL clock requested (always for PowerMode, never for VGA) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tmout</span><span class="p">;</span>
			<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tmout</span><span class="p">;</span> <span class="o">--</span><span class="n">tmout</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">CRITEND</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmout</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: Pixel PLL not locked after 5 secs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PixelPLL: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">500000</span><span class="o">-</span><span class="n">tmout</span><span class="p">);</span>
			<span class="n">CRITBEGIN</span>
		<span class="p">}</span>
		<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLCTRL</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS3026_XMEMPLLCTRL</span><span class="p">]);</span>
		<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XLOOPPLLDATA</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">CRITEND</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tmout</span><span class="p">;</span>

			<span class="n">CRITBEGIN</span>
			<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tmout</span><span class="p">;</span> <span class="o">--</span><span class="n">tmout</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XLOOPPLLDATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">CRITEND</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmout</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: Loop PLL not locked after 5 secs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;LoopPLL: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">500000</span><span class="o">-</span><span class="n">tmout</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;3026DACregs &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;R%02X=%02X &quot;</span><span class="p">,</span> <span class="n">DACseq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span> <span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;continuing... &quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DACclk &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;C%02X=%02X &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">Ti3026_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">ti3026_ramdac_init</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">matrox_altout</span> <span class="n">ti3026_output</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	 <span class="o">=</span> <span class="s">&quot;Primary output&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Ti3026_preinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">vxres_mill2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">512</span><span class="p">,</span>        <span class="mi">640</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>  <span class="mi">800</span><span class="p">,</span>  <span class="mi">832</span><span class="p">,</span>  <span class="mi">960</span><span class="p">,</span>
					  <span class="mi">1024</span><span class="p">,</span> <span class="mi">1152</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span>      <span class="mi">1600</span><span class="p">,</span> <span class="mi">1664</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span>
					  <span class="mi">2048</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">vxres_mill1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>             <span class="mi">640</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>  <span class="mi">800</span><span class="p">,</span>        <span class="mi">960</span><span class="p">,</span>
					  <span class="mi">1024</span><span class="p">,</span> <span class="mi">1152</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span>      <span class="mi">1600</span><span class="p">,</span>       <span class="mi">1920</span><span class="p">,</span>
					  <span class="mi">2048</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">millenium</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">milleniumII</span> <span class="o">=</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_MATROX_MIL</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">cfb4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* isMilleniumII(minfo); */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">vxres</span> <span class="o">=</span> <span class="n">isMilleniumII</span><span class="p">(</span><span class="n">minfo</span><span class="p">)</span> <span class="o">?</span> <span class="n">vxres_mill2</span> <span class="o">:</span> <span class="n">vxres_mill1</span><span class="p">;</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">minfo</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">output</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ti3026_output</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">default_src</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MATROXFB_OUTPUT_MODE_MONITOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">noinit</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* preserve VGA I/O, BIOS and PPC */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="mh">0xC0000100</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x002C0000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">novga</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00000100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nobios</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nopciretry</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span>  <span class="mh">0x20000000</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span><span class="p">);</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">accel</span><span class="p">.</span><span class="n">ramdac_rev</span> <span class="o">=</span> <span class="n">inTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XSILICONREV</span><span class="p">);</span>

	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XCLKCTRL</span><span class="p">,</span> <span class="n">TVP3026_XCLKCTRL_SRC_CLK0VGA</span> <span class="o">|</span> <span class="n">TVP3026_XCLKCTRL_CLKSTOPPED</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XTRUECOLORCTRL</span><span class="p">,</span> <span class="n">TVP3026_XTRUECOLORCTRL_PSEUDOCOLOR</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMUXCTRL</span><span class="p">,</span> <span class="n">TVP3026_XMUXCTRL_VGA</span><span class="p">);</span>

	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPLLADDR</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XLOOPPLLDATA</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XPIXPLLDATA</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_MISC_REG</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">);</span>

	<span class="n">outTi3026</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLCTRL</span><span class="p">,</span> <span class="n">TVP3026_XMEMPLLCTRL_STROBEMKC4</span> <span class="o">|</span> <span class="n">TVP3026_XMEMPLLCTRL_MCLK_MCLKPLL</span><span class="p">);</span>

	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MACCESS</span><span class="p">,</span> <span class="mh">0x00008000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">matrox_switch</span> <span class="n">matrox_millennium</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">Ti3026_preinit</span><span class="p">,</span> <span class="n">Ti3026_reset</span><span class="p">,</span> <span class="n">Ti3026_init</span><span class="p">,</span> <span class="n">Ti3026_restore</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matrox_millennium</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
