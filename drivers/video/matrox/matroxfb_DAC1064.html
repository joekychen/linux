<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › matrox › matroxfb_DAC1064.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>matroxfb_DAC1064.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Hardware accelerated Matrox Millennium I, II, Mystique, G100, G200, G400 and G450.</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 1998-2002 Petr Vandrovec &lt;vandrove@vc.cvut.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Portions Copyright (c) 2001 Matrox Graphics Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Version: 1.65 2002/08/14</span>
<span class="cm"> *</span>
<span class="cm"> * See matroxfb_base.c for contributors.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#include &quot;matroxfb_DAC1064.h&quot;</span>
<span class="cp">#include &quot;matroxfb_misc.h&quot;</span>
<span class="cp">#include &quot;matroxfb_accel.h&quot;</span>
<span class="cp">#include &quot;g450_pll.h&quot;</span>
<span class="cp">#include &lt;linux/matroxfb.h&gt;</span>

<span class="cp">#ifdef NEED_DAC1064</span>
<span class="cp">#define outDAC1064 matroxfb_DAC_out</span>
<span class="cp">#define inDAC1064 matroxfb_DAC_in</span>

<span class="cp">#define DAC1064_OPT_SCLK_PCI	0x00</span>
<span class="cp">#define DAC1064_OPT_SCLK_PLL	0x01</span>
<span class="cp">#define DAC1064_OPT_SCLK_EXT	0x02</span>
<span class="cp">#define DAC1064_OPT_SCLK_MASK	0x03</span>
<span class="cp">#define DAC1064_OPT_GDIV1	0x04	</span><span class="cm">/* maybe it is GDIV2 on G100 ?! */</span><span class="cp"></span>
<span class="cp">#define DAC1064_OPT_GDIV3	0x00</span>
<span class="cp">#define DAC1064_OPT_MDIV1	0x08</span>
<span class="cp">#define DAC1064_OPT_MDIV2	0x00</span>
<span class="cp">#define DAC1064_OPT_RESERVED	0x10</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC1064_calcclock</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmax</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">feed</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">post</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fvco</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>
	
	<span class="cm">/* only for devices older than G450 */</span>

	<span class="n">fvco</span> <span class="o">=</span> <span class="n">PLL_calcclock</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
	
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fvco</span> <span class="o">&lt;=</span> <span class="mi">100000</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fvco</span> <span class="o">&lt;=</span> <span class="mi">140000</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fvco</span> <span class="o">&lt;=</span> <span class="mi">180000</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">p</span> <span class="o">|=</span> <span class="mh">0x18</span><span class="p">;</span>
	<span class="o">*</span><span class="n">post</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* they must be in POS order */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">MGA1064_DAC_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">M1064_XCURADDL</span><span class="p">,</span> <span class="n">M1064_XCURADDH</span><span class="p">,</span> <span class="n">M1064_XCURCTRL</span><span class="p">,</span>
		<span class="n">M1064_XCURCOL0RED</span><span class="p">,</span> <span class="n">M1064_XCURCOL0GREEN</span><span class="p">,</span> <span class="n">M1064_XCURCOL0BLUE</span><span class="p">,</span>
		<span class="n">M1064_XCURCOL1RED</span><span class="p">,</span> <span class="n">M1064_XCURCOL1GREEN</span><span class="p">,</span> <span class="n">M1064_XCURCOL1BLUE</span><span class="p">,</span>
		<span class="n">M1064_XCURCOL2RED</span><span class="p">,</span> <span class="n">M1064_XCURCOL2GREEN</span><span class="p">,</span> <span class="n">M1064_XCURCOL2BLUE</span><span class="p">,</span>
		<span class="n">DAC1064_XVREFCTRL</span><span class="p">,</span> <span class="n">M1064_XMULCTRL</span><span class="p">,</span> <span class="n">M1064_XPIXCLKCTRL</span><span class="p">,</span> <span class="n">M1064_XGENCTRL</span><span class="p">,</span>
		<span class="n">M1064_XMISCCTRL</span><span class="p">,</span>
		<span class="n">M1064_XGENIOCTRL</span><span class="p">,</span> <span class="n">M1064_XGENIODATA</span><span class="p">,</span> <span class="n">M1064_XZOOMCTRL</span><span class="p">,</span> <span class="n">M1064_XSENSETEST</span><span class="p">,</span>
		<span class="n">M1064_XCRCBITSEL</span><span class="p">,</span>
		<span class="n">M1064_XCOLKEYMASKL</span><span class="p">,</span> <span class="n">M1064_XCOLKEYMASKH</span><span class="p">,</span> <span class="n">M1064_XCOLKEYL</span><span class="p">,</span> <span class="n">M1064_XCOLKEYH</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">MGA1064_DAC</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">M1064_XCURCTRL_DIS</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> 	<span class="cm">/* black */</span>
		<span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>	<span class="cm">/* white */</span>
		<span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* red */</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">M1064_XPIXCLKCTRL_PLL_UP</span> <span class="o">|</span> <span class="n">M1064_XPIXCLKCTRL_EN</span> <span class="o">|</span> <span class="n">M1064_XPIXCLKCTRL_SRC_PLL</span><span class="p">,</span>
		<span class="n">M1064_XGENCTRL_VS_0</span> <span class="o">|</span> <span class="n">M1064_XGENCTRL_ALPHA_DIS</span> <span class="o">|</span> <span class="n">M1064_XGENCTRL_BLACK_0IRE</span> <span class="o">|</span> <span class="n">M1064_XGENCTRL_NO_SYNC_ON_GREEN</span><span class="p">,</span>
		<span class="n">M1064_XMISCCTRL_DAC_8BIT</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">M1064_XZOOMCTRL_1</span><span class="p">,</span> <span class="n">M1064_XSENSETEST_BCOMP</span> <span class="o">|</span> <span class="n">M1064_XSENSETEST_GCOMP</span> <span class="o">|</span> <span class="n">M1064_XSENSETEST_RCOMP</span> <span class="o">|</span> <span class="n">M1064_XSENSETEST_PDOWN</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC1064_setpclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">DAC1064_calcclock</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">fout</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">max_pixel_clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC1064_setmclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oscinfo</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fmem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int32_t</span> <span class="n">mx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">noinit</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read MCLK and give up... */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLM</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLN</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLP</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mx</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|</span> <span class="mh">0x00000004</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">mx</span><span class="p">);</span>
	<span class="n">mx</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x000000BB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oscinfo</span> <span class="o">&amp;</span> <span class="n">DAC1064_OPT_GDIV1</span><span class="p">)</span>
		<span class="n">mx</span> <span class="o">|=</span> <span class="mh">0x00000008</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oscinfo</span> <span class="o">&amp;</span> <span class="n">DAC1064_OPT_MDIV1</span><span class="p">)</span>
		<span class="n">mx</span> <span class="o">|=</span> <span class="mh">0x00000010</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oscinfo</span> <span class="o">&amp;</span> <span class="n">DAC1064_OPT_RESERVED</span><span class="p">)</span>
		<span class="n">mx</span> <span class="o">|=</span> <span class="mh">0x00000080</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">oscinfo</span> <span class="o">&amp;</span> <span class="n">DAC1064_OPT_SCLK_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">DAC1064_OPT_SCLK_PLL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* select PCI clock until we have setup oscilator... */</span>
		<span class="kt">int</span> <span class="n">clk</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>

		<span class="cm">/* powerup system PLL, select PCI clock */</span>
		<span class="n">mx</span> <span class="o">|=</span> <span class="mh">0x00000020</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">mx</span><span class="p">);</span>
		<span class="n">mx</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00000004</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">mx</span><span class="p">);</span>

		<span class="cm">/* !!! you must not access device if MCLK is not running !!!</span>
<span class="cm">		   Doing so cause immediate PCI lockup :-( Maybe they should</span>
<span class="cm">		   generate ABORT or I/O (parity...) error and Linux should</span>
<span class="cm">		   recover from this... (kill driver/process). But world is not</span>
<span class="cm">		   perfect... */</span>
		<span class="cm">/* (bit 2 of PCI_OPTION_REG must be 0... and bits 0,1 must not</span>
<span class="cm">		   select PLL... because of PLL can be stopped at this time) */</span>
		<span class="n">DAC1064_calcclock</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">fmem</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">max_pixel_clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLM</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLN</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLP</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">clk</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span> <span class="n">clk</span><span class="p">;</span> <span class="o">--</span><span class="n">clk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clk</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: aiee, SYSPLL not locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* select PLL */</span>
		<span class="n">mx</span> <span class="o">|=</span> <span class="mh">0x00000005</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* select specified system clock source */</span>
		<span class="n">mx</span> <span class="o">|=</span> <span class="n">oscinfo</span> <span class="o">&amp;</span> <span class="n">DAC1064_OPT_SCLK_MASK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">mx</span><span class="p">);</span>
	<span class="n">mx</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00000004</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">mx</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">=</span> <span class="n">mx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_MATROX_G</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">g450_set_plls</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int32_t</span> <span class="n">c2_ctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pxc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pixelmnp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">videomnp</span><span class="p">;</span>
	
	<span class="n">c2_ctl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x4007</span><span class="p">;</span>	<span class="cm">/* Clear PLL + enable for CRTC2 */</span>
	<span class="n">c2_ctl</span> <span class="o">|=</span> <span class="mh">0x0001</span><span class="p">;</span>			<span class="cm">/* Enable CRTC2 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPWRCTRL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>	<span class="cm">/* Stop VIDEO PLL */</span>
	<span class="n">pixelmnp</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">mnp</span><span class="p">;</span>
	<span class="n">videomnp</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">mnp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">videomnp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c2_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0001</span><span class="p">;</span>			<span class="cm">/* Disable CRTC2 */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPWRCTRL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* Powerdown CRTC2 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">==</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c2_ctl</span> <span class="o">|=</span>  <span class="mh">0x4002</span><span class="p">;</span>	<span class="cm">/* Use reference directly */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">videomnp</span> <span class="o">==</span> <span class="n">pixelmnp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c2_ctl</span> <span class="o">|=</span>  <span class="mh">0x0004</span><span class="p">;</span>	<span class="cm">/* Use pixel PLL */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">((</span><span class="n">videomnp</span> <span class="o">^</span> <span class="n">pixelmnp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF00</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* PIXEL and VIDEO PLL must not use same frequency. We modify N</span>
<span class="cm">			   of PIXEL PLL in such case because of VIDEO PLL may be source</span>
<span class="cm">			   of TVO clocks, and chroma subcarrier is derived from its</span>
<span class="cm">			   pixel clocks */</span>
			<span class="n">pixelmnp</span> <span class="o">+=</span> <span class="mh">0x000100</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">c2_ctl</span> <span class="o">|=</span>  <span class="mh">0x0006</span><span class="p">;</span>	<span class="cm">/* Use video PLL */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPWRCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		
		<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPWRCTRL</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPWRCTRL</span><span class="p">]);</span>
		<span class="n">matroxfb_g450_setpll_cond</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">videomnp</span><span class="p">,</span> <span class="n">M_VIDEO_PLL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPIXCLKCTRL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M1064_XPIXCLKCTRL_PLL_UP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pixelmnp</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPIXCLKCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">M1064_XPIXCLKCTRL_PLL_UP</span><span class="p">;</span>
		
		<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPIXCLKCTRL</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPIXCLKCTRL</span><span class="p">]);</span>
		<span class="n">matroxfb_g450_setpll_cond</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">pixelmnp</span><span class="p">,</span> <span class="n">M_PIXEL_PLL_C</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c2_ctl</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">ctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">c2_ctl</span><span class="p">;</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="mh">0x3C10</span><span class="p">,</span> <span class="n">c2_ctl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pxc</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">pixclock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pxc</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc2</span><span class="p">.</span><span class="n">pixclock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">MGA_G550</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">45000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 0-50 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">55000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>	<span class="cm">/* 34-62 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">70000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* 42-78 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">85000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>	<span class="cm">/* 62-92 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* 74-108 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">115000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>	<span class="cm">/* 94-122 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">125000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>	<span class="cm">/* 108-132 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>	<span class="cm">/* 120-168 */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* G450 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">45000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 0-54 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">65000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>	<span class="cm">/* 38-70 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">85000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* 56-96 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">105000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>	<span class="cm">/* 80-114 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">135000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* 102-144 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">160000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>	<span class="cm">/* 132-166 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pxc</span> <span class="o">&lt;</span> <span class="mi">175000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>	<span class="cm">/* 154-182 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>	<span class="cm">/* 170-204 */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">DAC1064_global_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMISCCTRL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">M1064_XMISCCTRL_DAC_WIDTHMASK</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMISCCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">M1064_XMISCCTRL_LUT_EN</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPIXCLKCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1064_XPIXCLKCTRL_PLL_UP</span> <span class="o">|</span> <span class="n">M1064_XPIXCLKCTRL_EN</span> <span class="o">|</span> <span class="n">M1064_XPIXCLKCTRL_SRC_PLL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_MATROX_G</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">g450dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPWRCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>	<span class="cm">/* powerup everything */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XOUTPUTCONN</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* disable outputs */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMISCCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">M1064_XMISCCTRL_DAC_EN</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MATROXFB_SRC_CRTC1</span>:
			<span class="k">case</span> <span class="n">MATROXFB_SRC_CRTC2</span>:
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XOUTPUTCONN</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* enable output; CRTC1/2 selection is in CRTC2 ctl */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MATROXFB_SRC_NONE</span>:
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMISCCTRL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M1064_XMISCCTRL_DAC_EN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MATROXFB_SRC_CRTC1</span>:
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XOUTPUTCONN</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MATROXFB_SRC_CRTC2</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MATROXFB_OUTPUT_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XOUTPUTCONN</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XOUTPUTCONN</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x0C</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MATROXFB_SRC_NONE</span>:
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPWRCTRL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>		<span class="cm">/* Poweroff DAC2 */</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MATROXFB_SRC_CRTC1</span>:
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XOUTPUTCONN</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MATROXFB_SRC_CRTC2</span>:
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XOUTPUTCONN</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MATROXFB_SRC_NONE</span>:
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">				/* HELP! If we boot without DFP connected to DVI, we can</span>
<span class="c">				   poweroff TMDS. But if we boot with DFP connected,</span>
<span class="c">				   TMDS generated clocks are used instead of ALL pixclocks</span>
<span class="c">				   available... If someone knows which register</span>
<span class="c">				   handles it, please reveal this secret to me... */			</span>
<span class="c">				hw-&gt;DACreg[POS1064_XPWRCTRL] &amp;= ~0x04;		/* Poweroff TMDS */</span>
<span class="cp">#endif				</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Now set timming related variables... */</span>
		<span class="n">g450_set_plls</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPIXCLKCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1064_XPIXCLKCTRL_PLL_UP</span> <span class="o">|</span> <span class="n">M1064_XPIXCLKCTRL_EN</span> <span class="o">|</span> <span class="n">M1064_XPIXCLKCTRL_SRC_EXT</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMISCCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">GX00_XMISCCTRL_MFC_MAFC</span> <span class="o">|</span> <span class="n">G400_XMISCCTRL_VDO_MAFC12</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMISCCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">GX00_XMISCCTRL_MFC_MAFC</span> <span class="o">|</span> <span class="n">G400_XMISCCTRL_VDO_C2_MAFC12</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMISCCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">GX00_XMISCCTRL_MFC_PANELLINK</span> <span class="o">|</span> <span class="n">G400_XMISCCTRL_VDO_MAFC12</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMISCCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">GX00_XMISCCTRL_MFC_DIS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">src</span> <span class="o">!=</span> <span class="n">MATROXFB_SRC_NONE</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMISCCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">M1064_XMISCCTRL_DAC_EN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">DAC1064_global_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPIXCLKCTRL</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPIXCLKCTRL</span><span class="p">]);</span>
	<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XMISCCTRL</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMISCCTRL</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">accelerator</span> <span class="o">==</span> <span class="n">FB_ACCEL_MATROX_MGAG400</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">dfp_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">g450dac</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XSYNCCTRL</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">);</span>
			<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPWRCTRL</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPWRCTRL</span><span class="p">]);</span>
			<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPANMODE</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XPANMODE</span><span class="p">]);</span>
			<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XOUTPUTCONN</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XOUTPUTCONN</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DAC1064_init_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">my_timming</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">,</span> <span class="n">MGA1064_DAC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MGA1064_DAC_regs</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* case 4: not supported by MGA1064 DAC */</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMULCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1064_XMULCTRL_DEPTH_8BPP</span> <span class="o">|</span> <span class="n">M1064_XMULCTRL_GRAPHICS_PALETIZED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMULCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1064_XMULCTRL_DEPTH_15BPP_1BPP</span> <span class="o">|</span> <span class="n">M1064_XMULCTRL_GRAPHICS_PALETIZED</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMULCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1064_XMULCTRL_DEPTH_16BPP</span> <span class="o">|</span> <span class="n">M1064_XMULCTRL_GRAPHICS_PALETIZED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>:
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMULCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1064_XMULCTRL_DEPTH_24BPP</span> <span class="o">|</span> <span class="n">M1064_XMULCTRL_GRAPHICS_PALETIZED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XMULCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1064_XMULCTRL_DEPTH_32BPP</span> <span class="o">|</span> <span class="n">M1064_XMULCTRL_GRAPHICS_PALETIZED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* unsupported depth */</span>
	<span class="p">}</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XVREFCTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">DAC1064</span><span class="p">.</span><span class="n">xvrefctrl</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XGENCTRL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M1064_XGENCTRL_SYNC_ON_GREEN_MASK</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XGENCTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_ON_GREEN</span><span class="p">)</span><span class="o">?</span><span class="n">M1064_XGENCTRL_SYNC_ON_GREEN</span><span class="o">:</span><span class="n">M1064_XGENCTRL_NO_SYNC_ON_GREEN</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XCURADDL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">POS1064_XCURADDH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DAC1064_global_init</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DAC1064_init_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">my_timming</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 256 entries */</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 0..31, 128..159 */</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* with p15 == 0 */</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
				<span class="cm">/* with p15 == 1 */</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* 0..63 */</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">768</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC1064_restore_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">CRITFLAGS</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">CRITBEGIN</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLM</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLN</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLP</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLM</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLN</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLP</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MGA1064_DAC_regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">!=</span> <span class="n">POS1064_XPIXCLKCTRL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">POS1064_XMISCCTRL</span><span class="p">))</span>
				<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">MGA1064_DAC_regs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACreg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DAC1064_global_restore</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>

	<span class="n">CRITEND</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC1064_restore_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DAC1064regs &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MGA1064_DAC_regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;R%02X=%02X &quot;</span><span class="p">,</span> <span class="n">MGA1064_DAC_regs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">DACreg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span> <span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;continuing... &quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DAC1064clk &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;C%02X=%02X &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">DACclk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m1064_compute</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">out</span><span class="p">,</span> <span class="k">struct</span> <span class="n">my_timming</span><span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#define minfo ((struct matrox_fb_info*)out)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tmout</span><span class="p">;</span>
		<span class="n">CRITFLAGS</span>

		<span class="n">DAC1064_setpclk</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>

		<span class="n">CRITBEGIN</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPIXPLLCM</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">DACclk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tmout</span><span class="p">;</span> <span class="n">tmout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPIXPLLSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">};</span>

		<span class="n">CRITEND</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmout</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: Pixel PLL not locked after 5 secs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#undef minfo</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">matrox_altout</span> <span class="n">m1064</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	 <span class="o">=</span> <span class="s">&quot;Primary output&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compute</span> <span class="o">=</span> <span class="n">m1064_compute</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_FB_MATROX_G</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">g450_compute</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">out</span><span class="p">,</span> <span class="k">struct</span> <span class="n">my_timming</span><span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#define minfo ((struct matrox_fb_info*)out)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mnp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">mnp</span> <span class="o">=</span> <span class="n">matroxfb_g450_setclk</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">)</span> <span class="o">?</span> <span class="n">M_PIXEL_PLL_C</span> <span class="o">:</span> <span class="n">M_VIDEO_PLL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mnp</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">g450_mnp2f</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mnp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#undef minfo</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">matrox_altout</span> <span class="n">g450out</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	 <span class="o">=</span> <span class="s">&quot;Primary output&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compute</span> <span class="o">=</span> <span class="n">g450_compute</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* NEED_DAC1064 */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_FB_MATROX_MYSTIQUE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">MGA1064_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">my_timming</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DAC1064_init_1</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">matroxfb_vgaHWinit</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">=</span> <span class="mh">0xCB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span><span class="p">)</span> <span class="cm">/* should be only FB_SYNC_COMP */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DAC1064_init_2</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_MATROX_G</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">MGAG100_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">my_timming</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DAC1064_init_1</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x2000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">matroxfb_vgaHWinit</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">=</span> <span class="mh">0xEF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span><span class="p">)</span> <span class="cm">/* should be only FB_SYNC_COMP */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DAC1064_init_2</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* G */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_FB_MATROX_MYSTIQUE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">MGA1064_ramdac_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="cm">/* minfo-&gt;features.DAC1064.vco_freq_min = 120000; */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">vco_freq_min</span> <span class="o">=</span> <span class="mi">62000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	 <span class="o">=</span> <span class="mi">14318</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">feed_div_min</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">feed_div_max</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">in_div_min</span>	 <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">in_div_max</span>	 <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">post_shift_max</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">DAC1064</span><span class="p">.</span><span class="n">xvrefctrl</span> <span class="o">=</span> <span class="n">DAC1064_XVREFCTRL_EXTERNAL</span><span class="p">;</span>
	<span class="cm">/* maybe cmdline MCLK= ?, doc says gclk=44MHz, mclk=66MHz... it was 55/83 with old values */</span>
	<span class="n">DAC1064_setmclk</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_OPT_MDIV2</span> <span class="o">|</span> <span class="n">DAC1064_OPT_GDIV3</span> <span class="o">|</span> <span class="n">DAC1064_OPT_SCLK_PLL</span><span class="p">,</span> <span class="mi">133333</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_MATROX_G</span>
<span class="cm">/* BIOS environ */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">x7AF4</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* flags, maybe 0x10 = SDRAM, 0x00 = SGRAM??? */</span>
				<span class="cm">/* G100 wants 0x10, G200 SGRAM does not care... */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int def50 = 0;	/* reg50, &amp; 0x0F, &amp; 0x3000 (only 0x0000, 0x1000, 0x2000 (0x3000 disallowed and treated as 0) */</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MGAG100_progPixClock</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">selClk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clk</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPIXCLKCTRL</span><span class="p">,</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPIXCLKCTRL</span><span class="p">)</span> <span class="o">|</span> <span class="n">M1064_XPIXCLKCTRL_DIS</span> <span class="o">|</span>
		   <span class="n">M1064_XPIXCLKCTRL_PLL_UP</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="n">reg</span> <span class="o">=</span> <span class="n">M1064_XPIXPLLAM</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:		<span class="n">reg</span> <span class="o">=</span> <span class="n">M1064_XPIXPLLBM</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="n">reg</span> <span class="o">=</span> <span class="n">M1064_XPIXPLLCM</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">reg</span><span class="o">++</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">reg</span><span class="o">++</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">selClk</span> <span class="o">=</span> <span class="n">mga_inb</span><span class="p">(</span><span class="n">M_MISC_REG_READ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xC</span><span class="p">;</span>
	<span class="cm">/* there should be flags &amp; 0x03 &amp; case 0/1/else */</span>
	<span class="cm">/* and we should first select source and after that we should wait for PLL */</span>
	<span class="cm">/* and we are waiting for PLL with oscilator disabled... Is it right? */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:	<span class="n">selClk</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="n">selClk</span> <span class="o">|=</span> <span class="mh">0x0C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_MISC_REG</span><span class="p">,</span> <span class="n">selClk</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">clk</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">clk</span><span class="p">;</span> <span class="n">clk</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPIXPLLSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clk</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;matroxfb: Pixel PLL%c not locked after usual time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span><span class="o">-</span><span class="n">M1064_XPIXPLLAM</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="sc">&#39;A&#39;</span><span class="p">);</span>
	<span class="n">selClk</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPIXCLKCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">M1064_XPIXCLKCTRL_SRC_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:	<span class="n">selClk</span> <span class="o">|=</span> <span class="n">M1064_XPIXCLKCTRL_SRC_PCI</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:	<span class="n">selClk</span> <span class="o">|=</span> <span class="n">M1064_XPIXCLKCTRL_SRC_PLL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="n">selClk</span> <span class="o">|=</span> <span class="n">M1064_XPIXCLKCTRL_SRC_EXT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPIXCLKCTRL</span><span class="p">,</span> <span class="n">selClk</span><span class="p">);</span>
	<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPIXCLKCTRL</span><span class="p">,</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPIXCLKCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">M1064_XPIXCLKCTRL_DIS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MGAG100_setPixClock</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">DAC1064_calcclock</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">max_pixel_clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
	<span class="n">MGAG100_progPixClock</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_MATROX_MYSTIQUE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">MGA1064_preinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">vxres_mystique</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">512</span><span class="p">,</span>        <span class="mi">640</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>  <span class="mi">800</span><span class="p">,</span>  <span class="mi">832</span><span class="p">,</span>  <span class="mi">960</span><span class="p">,</span>
					     <span class="mi">1024</span><span class="p">,</span> <span class="mi">1152</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span>      <span class="mi">1600</span><span class="p">,</span> <span class="mi">1664</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span>
					     <span class="mi">2048</span><span class="p">,</span>    <span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="cm">/* minfo-&gt;capable.cfb4 = 0; ... preinitialized by 0 */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">vxres</span> <span class="o">=</span> <span class="n">vxres_mystique</span><span class="p">;</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">output</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m1064</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">default_src</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">minfo</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MATROXFB_OUTPUT_MODE_MONITOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">noinit</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* do not modify settings */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="mh">0xC0000100</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x00094E20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">novga</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00000100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nobios</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nopciretry</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span>  <span class="mh">0x20000000</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span><span class="p">);</span>
	<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_SEQ_INDEX</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_CTLWTST</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MACCESS</span><span class="p">,</span> <span class="mh">0x00008000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MACCESS</span><span class="p">,</span> <span class="mh">0x0000C000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MGA1064_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">);</span>

	<span class="n">MGA1064_ramdac_init</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_MATROX_G</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">g450_mclk_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* switch all clocks to PCI source */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION3_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00300C03</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt3</span> <span class="o">&amp;</span> <span class="mh">0x000003</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x000003</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt3</span> <span class="o">&amp;</span> <span class="mh">0x000C00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x000C00</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt3</span> <span class="o">&amp;</span> <span class="mh">0x300000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x300000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">matroxfb_g450_setclk</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">video</span><span class="p">,</span> <span class="n">M_VIDEO_PLL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pwr</span><span class="p">;</span>
		
		<span class="n">matroxfb_DAC_lock_irqsave</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPWRCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>
		<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XPWRCTRL</span><span class="p">,</span> <span class="n">pwr</span><span class="p">);</span>
		<span class="n">matroxfb_DAC_unlock_irqrestore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">matroxfb_g450_setclk</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">system</span><span class="p">,</span> <span class="n">M_SYSTEM_PLL</span><span class="p">);</span>
	
	<span class="cm">/* switch clocks to their real PLL source(s) */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION3_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt3</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">g450_memory_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable memory refresh */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x001F8000</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span><span class="p">);</span>
	
	<span class="cm">/* set memory interface parameters */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00207E00</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x00207E00</span> <span class="o">&amp;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION2_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt2</span><span class="p">);</span>
	
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_CTLWTST</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span><span class="p">);</span>
	
	<span class="cm">/* first set up memory interface with disabled memory interface clocks */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_MEMMISC_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memmisc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80000000U</span><span class="p">);</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MEMRDBK</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span><span class="p">);</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MACCESS</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">maccess</span><span class="p">);</span>
	<span class="cm">/* start memory clocks */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_MEMMISC_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memmisc</span> <span class="o">|</span> <span class="mh">0x80000000U</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">ddr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">emrswen</span> <span class="o">||</span> <span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">dll</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MEMRDBK</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MACCESS</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">maccess</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
	
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x001F8000</span> <span class="o">&amp;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span><span class="p">);</span>
	
	<span class="cm">/* value is written to memory chips only if old != new */</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_PLNWT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_PLNWT</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span> <span class="o">!=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst_core</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_CTLWTST</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst_core</span><span class="p">);</span>
	<span class="p">}</span>
	
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">g450_preinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int32_t</span> <span class="n">c2ctl</span><span class="p">;</span>
	<span class="n">u_int8_t</span> <span class="n">curctl</span><span class="p">;</span>
	<span class="n">u_int8_t</span> <span class="n">c1ctl</span><span class="p">;</span>
	
	<span class="cm">/* minfo-&gt;hw.MXoptionReg = minfo-&gt;values.reg.opt; */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="mh">0xC0000100</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x00000020</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">novga</span><span class="p">)</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00000100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nobios</span><span class="p">)</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nopciretry</span><span class="p">)</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">|=</span>  <span class="mh">0x20000000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="mh">0x03400040</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MXoptionReg</span><span class="p">);</span>

	<span class="cm">/* Init system clocks */</span>
		
	<span class="cm">/* stop crtc2 */</span>
	<span class="n">c2ctl</span> <span class="o">=</span> <span class="n">mga_inl</span><span class="p">(</span><span class="n">M_C2CTL</span><span class="p">);</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_C2CTL</span><span class="p">,</span> <span class="n">c2ctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* stop cursor */</span>
	<span class="n">curctl</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XCURCTRL</span><span class="p">);</span>
	<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XCURCTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* stop crtc1 */</span>
	<span class="n">c1ctl</span> <span class="o">=</span> <span class="n">mga_readr</span><span class="p">(</span><span class="n">M_SEQ_INDEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_SEQ_INDEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c1ctl</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">g450_mclk_init</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="n">g450_memory_init</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	
	<span class="cm">/* set legacy VGA clock sources for DOSEmu or VMware... */</span>
	<span class="n">matroxfb_g450_setclk</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">25175</span><span class="p">,</span> <span class="n">M_PIXEL_PLL_A</span><span class="p">);</span>
	<span class="n">matroxfb_g450_setclk</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">28322</span><span class="p">,</span> <span class="n">M_PIXEL_PLL_B</span><span class="p">);</span>

	<span class="cm">/* restore crtc1 */</span>
	<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_SEQ_INDEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c1ctl</span><span class="p">);</span>
	
	<span class="cm">/* restore cursor */</span>
	<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XCURCTRL</span><span class="p">,</span> <span class="n">curctl</span><span class="p">);</span>

	<span class="cm">/* restore crtc2 */</span>
	<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_C2CTL</span><span class="p">,</span> <span class="n">c2ctl</span><span class="p">);</span>
	
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MGAG100_preinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">vxres_g100</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">512</span><span class="p">,</span>        <span class="mi">640</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>  <span class="mi">800</span><span class="p">,</span>  <span class="mi">832</span><span class="p">,</span>  <span class="mi">960</span><span class="p">,</span>
                                          <span class="mi">1024</span><span class="p">,</span> <span class="mi">1152</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span>      <span class="mi">1600</span><span class="p">,</span> <span class="mi">1664</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span>
                                          <span class="mi">2048</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

        <span class="n">u_int32_t</span> <span class="n">reg50</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	u_int32_t q;</span>
<span class="cp">#endif</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="cm">/* there are some instabilities if in_div &gt; 19 &amp;&amp; vco &lt; 61000 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">g450dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">vco_freq_min</span> <span class="o">=</span> <span class="mi">130000</span><span class="p">;</span>	<span class="cm">/* my sample: &gt;118 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">vco_freq_min</span> <span class="o">=</span> <span class="mi">62000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	 <span class="o">=</span> <span class="mi">27000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">feed_div_min</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">feed_div_max</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">in_div_min</span>	 <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">in_div_max</span>	 <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">post_shift_max</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">DAC1064</span><span class="p">.</span><span class="n">xvrefctrl</span> <span class="o">=</span> <span class="n">DAC1064_XVREFCTRL_G100_DEFAULT</span><span class="p">;</span>
	<span class="cm">/* minfo-&gt;capable.cfb4 = 0; ... preinitialized by 0 */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">vxres</span> <span class="o">=</span> <span class="n">vxres_g100</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">capable</span><span class="p">.</span><span class="n">plnwt</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">accelerator</span> <span class="o">==</span> <span class="n">FB_ACCEL_MATROX_MGAG100</span>
			<span class="o">?</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">sgram</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">g450dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">output</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g450out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">output</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m1064</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">default_src</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">minfo</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MATROXFB_OUTPUT_MODE_MONITOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">g450dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we must do this always, BIOS does not do it for us</span>
<span class="cm">		   and accelerator dies without it */</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="mh">0x1C0C</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">noinit</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">g450dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">g450_preinit</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="mh">0xC0000100</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x00000020</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">novga</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00000100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nobios</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">nopciretry</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span>  <span class="mh">0x20000000</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span><span class="p">);</span>
	<span class="n">DAC1064_setmclk</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_OPT_MDIV2</span> <span class="o">|</span> <span class="n">DAC1064_OPT_GDIV3</span> <span class="o">|</span> <span class="n">DAC1064_OPT_SCLK_PCI</span><span class="p">,</span> <span class="mi">133333</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">accelerator</span> <span class="o">==</span> <span class="n">FB_ACCEL_MATROX_MGAG100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION2_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg50</span><span class="p">);</span>
		<span class="n">reg50</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3000</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION2_REG</span><span class="p">,</span> <span class="n">reg50</span><span class="p">);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x1080</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span><span class="p">);</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_CTLWTST</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="mh">0x1C05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="mh">0x1C05</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="mh">0x1C05</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="mh">0x1C05</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">reg50</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">reg50</span> <span class="o">|=</span>  <span class="mh">0x07</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION2_REG</span><span class="p">,</span> <span class="n">reg50</span><span class="p">);</span>
		<span class="cm">/* it should help with G100 */</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_GRAPHICS_INDEX</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_GRAPHICS_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">mga_inb</span><span class="p">(</span><span class="n">M_GRAPHICS_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>
		<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">mga_writeb</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">);</span>
		<span class="n">mga_writeb</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">mga_writeb</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		if (mga_readb(minfo-&gt;video.vbase, 0x0000) != 0xAA) {</span>
<span class="c">			hw-&gt;MXoptionReg &amp;= ~0x1000;</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x00078020</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">accelerator</span> <span class="o">==</span> <span class="n">FB_ACCEL_MATROX_MGAG200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION2_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg50</span><span class="p">);</span>
		<span class="n">reg50</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3000</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION2_REG</span><span class="p">,</span> <span class="n">reg50</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">memtype</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="mh">0x1C00</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">memtype</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">sgram</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x4000</span><span class="p">;</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_CTLWTST</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span><span class="p">);</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MEMRDBK</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MACCESS</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MACCESS</span><span class="p">,</span> <span class="mh">0x00008000</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">mga_outw</span><span class="p">(</span><span class="n">M_MEMRDBK</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x00078020</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION2_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg50</span><span class="p">);</span>
		<span class="n">reg50</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00000100</span><span class="p">;</span>
		<span class="n">reg50</span> <span class="o">|=</span>  <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION2_REG</span><span class="p">,</span> <span class="n">reg50</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">memtype</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="mh">0x1C00</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">memtype</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">sgram</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x4000</span><span class="p">;</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_CTLWTST</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span><span class="p">);</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MEMRDBK</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MACCESS</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MACCESS</span><span class="p">,</span> <span class="mh">0x00008000</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">mga_outl</span><span class="p">(</span><span class="n">M_MEMRDBK</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x00040020</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MGAG100_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int8_t</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="p">{</span>
<span class="cp">#ifdef G100_BROKEN_IBM_82351</span>
		<span class="n">u_int32_t</span> <span class="n">d</span><span class="p">;</span>

		<span class="n">find</span> <span class="mi">1014</span><span class="o">/</span><span class="mi">22</span> <span class="p">(</span><span class="n">IBM</span><span class="o">/</span><span class="mi">82351</span><span class="p">);</span> <span class="cm">/* if found and bridging Matrox, do some strange stuff */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">ibm</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">ibm</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* disable back-to-back &amp; SERR */</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">ibm</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">);</span>		<span class="cm">/* ??? */</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">ibm</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">);</span>	<span class="cm">/* ??? */</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">ibm</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* ??? */</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">noinit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x7AF4</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>	<span class="cm">/* FIXME... */</span>
				<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">g450dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* either leave MCLK as is... or they were set in preinit */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLM</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLN</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACclk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_XSYSPLLP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DAC1064_setmclk</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">DAC1064_OPT_RESERVED</span> <span class="o">|</span> <span class="n">DAC1064_OPT_MDIV2</span> <span class="o">|</span> <span class="n">DAC1064_OPT_GDIV1</span> <span class="o">|</span> <span class="n">DAC1064_OPT_SCLK_PLL</span><span class="p">,</span> <span class="mi">133333</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">accelerator</span> <span class="o">==</span> <span class="n">FB_ACCEL_MATROX_MGAG400</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">dfp_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">dfp_type</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">noinit</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">g450dac</span><span class="p">)</span> <span class="p">{</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">MGAG100_setPixClock</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">25175</span><span class="p">);</span>
		<span class="n">MGAG100_setPixClock</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">28322</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x7AF4</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XGENIODATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XGENIODATA</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">inDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XGENIOCTRL</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">outDAC1064</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">M1064_XGENIOCTRL</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_MATROX_MYSTIQUE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">MGA1064_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">CRITFLAGS</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">CRITBEGIN</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_IEN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_CACHEFLUSH</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">CRITEND</span>

	<span class="n">DAC1064_restore_1</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="n">matroxfb_vgaHWrestore</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">panpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">DAC1064_restore_2</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_MATROX_G</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">MGAG100_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">CRITFLAGS</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">CRITBEGIN</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MXoptionReg</span><span class="p">);</span>
	<span class="n">CRITEND</span>

	<span class="n">DAC1064_restore_1</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="n">matroxfb_vgaHWrestore</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">support32MB</span><span class="p">)</span>
		<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtc1</span><span class="p">.</span><span class="n">panpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_EXTVGA_INDEX</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">DAC1064_restore_2</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_MATROX_MYSTIQUE</span>
<span class="k">struct</span> <span class="n">matrox_switch</span> <span class="n">matrox_mystique</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MGA1064_preinit</span><span class="p">,</span> <span class="n">MGA1064_reset</span><span class="p">,</span> <span class="n">MGA1064_init</span><span class="p">,</span> <span class="n">MGA1064_restore</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matrox_mystique</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_MATROX_G</span>
<span class="k">struct</span> <span class="n">matrox_switch</span> <span class="n">matrox_G100</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MGAG100_preinit</span><span class="p">,</span> <span class="n">MGAG100_reset</span><span class="p">,</span> <span class="n">MGAG100_init</span><span class="p">,</span> <span class="n">MGAG100_restore</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matrox_G100</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef NEED_DAC1064</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">DAC1064_global_init</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">DAC1064_global_restore</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
