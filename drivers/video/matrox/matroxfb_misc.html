<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › matrox › matroxfb_misc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>matroxfb_misc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Hardware accelerated Matrox Millennium I, II, Mystique, G100, G200 and G400</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 1998-2002 Petr Vandrovec &lt;vandrove@vc.cvut.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Portions Copyright (c) 2001 Matrox Graphics Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Version: 1.65 2002/08/14</span>
<span class="cm"> *</span>
<span class="cm"> * MTRR stuff: 1998 Tom Rini &lt;trini@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Contributors: &quot;menion?&quot; &lt;menion@mindless.com&gt;</span>
<span class="cm"> *                     Betatesting, fixes, ideas</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Kurt Garloff&quot; &lt;garloff@suse.de&gt;</span>
<span class="cm"> *                     Betatesting, fixes, ideas, videomodes, videomodes timmings</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Tom Rini&quot; &lt;trini@kernel.crashing.org&gt;</span>
<span class="cm"> *                     MTRR stuff, PPC cleanups, betatesting, fixes, ideas</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Bibek Sahu&quot; &lt;scorpio@dodds.net&gt;</span>
<span class="cm"> *                     Access device through readb|w|l and write b|w|l</span>
<span class="cm"> *                     Extensive debugging stuff</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Daniel Haun&quot; &lt;haund@usa.net&gt;</span>
<span class="cm"> *                     Testing, hardware cursor fixes</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Scott Wood&quot; &lt;sawst46+@pitt.edu&gt;</span>
<span class="cm"> *                     Fixes</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Gerd Knorr&quot; &lt;kraxel@goldbach.isdn.cs.tu-berlin.de&gt;</span>
<span class="cm"> *                     Betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Kelly French&quot; &lt;targon@hazmat.com&gt;</span>
<span class="cm"> *               &quot;Fernando Herrera&quot; &lt;fherrera@eurielec.etsit.upm.es&gt;</span>
<span class="cm"> *                     Betatesting, bug reporting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Pablo Bianucci&quot; &lt;pbian@pccp.com.ar&gt;</span>
<span class="cm"> *                     Fixes, ideas, betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Inaky Perez Gonzalez&quot; &lt;inaky@peloncho.fis.ucm.es&gt;</span>
<span class="cm"> *                     Fixes, enhandcements, ideas, betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Ryuichi Oikawa&quot; &lt;roikawa@rr.iiij4u.or.jp&gt;</span>
<span class="cm"> *                     PPC betatesting, PPC support, backward compatibility</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Paul Womar&quot; &lt;Paul@pwomar.demon.co.uk&gt;</span>
<span class="cm"> *               &quot;Owen Waller&quot; &lt;O.Waller@ee.qub.ac.uk&gt;</span>
<span class="cm"> *                     PPC betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Thomas Pornin&quot; &lt;pornin@bolet.ens.fr&gt;</span>
<span class="cm"> *                     Alpha betatesting</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Pieter van Leuven&quot; &lt;pvl@iae.nl&gt;</span>
<span class="cm"> *               &quot;Ulf Jaenicke-Roessler&quot; &lt;ujr@physik.phy.tu-dresden.de&gt;</span>
<span class="cm"> *                     G100 testing</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;H. Peter Arvin&quot; &lt;hpa@transmeta.com&gt;</span>
<span class="cm"> *                     Ideas</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Cort Dougan&quot; &lt;cort@cs.nmt.edu&gt;</span>
<span class="cm"> *                     CHRP fixes and PReP cleanup</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Mark Vojkovich&quot; &lt;mvojkovi@ucsd.edu&gt;</span>
<span class="cm"> *                     G400 support</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;David C. Hansen&quot; &lt;haveblue@us.ibm.com&gt;</span>
<span class="cm"> *                     Fixes</span>
<span class="cm"> *</span>
<span class="cm"> *               &quot;Ian Romanick&quot; &lt;idr@us.ibm.com&gt;</span>
<span class="cm"> *                     Find PInS data in BIOS on PowerPC systems.</span>
<span class="cm"> *</span>
<span class="cm"> * (following author is not in any relation with this code, but his code</span>
<span class="cm"> *  is included in this driver)</span>
<span class="cm"> *</span>
<span class="cm"> * Based on framebuffer driver for VBE 2.0 compliant graphic boards</span>
<span class="cm"> *     (c) 1998 Gerd Knorr &lt;kraxel@cs.tu-berlin.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * (following author is not in any relation with this code, but his ideas</span>
<span class="cm"> *  were used when writing this driver)</span>
<span class="cm"> *</span>
<span class="cm"> *		 FreeVBE/AF (Matrox), &quot;Shawn Hargreaves&quot; &lt;shawn@talula.demon.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#include &quot;matroxfb_misc.h&quot;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/matroxfb.h&gt;</span>

<span class="kt">void</span> <span class="nf">matroxfb_DAC_out</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG_REG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_RAMDAC_BASE</span><span class="o">+</span><span class="n">M_X_INDEX</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_RAMDAC_BASE</span><span class="o">+</span><span class="n">M_X_DATAREG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">matroxfb_DAC_in</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG_REG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_RAMDAC_BASE</span><span class="o">+</span><span class="n">M_X_INDEX</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mga_inb</span><span class="p">(</span><span class="n">M_RAMDAC_BASE</span><span class="o">+</span><span class="n">M_X_DATAREG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">matroxfb_var2my</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span><span class="o">*</span> <span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">my_timming</span><span class="o">*</span> <span class="n">mt</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixclock</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pixclock</span><span class="p">)</span> <span class="n">pixclock</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>	<span class="cm">/* 10ns = 100MHz */</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">pixclock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mt</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">mt</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">mnp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">dblscan</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">interlaced</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">HDisplay</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">HSyncStart</span> <span class="o">=</span> <span class="n">mt</span><span class="o">-&gt;</span><span class="n">HDisplay</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">HSyncEnd</span> <span class="o">=</span> <span class="n">mt</span><span class="o">-&gt;</span><span class="n">HSyncStart</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">HTotal</span> <span class="o">=</span> <span class="n">mt</span><span class="o">-&gt;</span><span class="n">HSyncEnd</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">VDisplay</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">VSyncStart</span> <span class="o">=</span> <span class="n">mt</span><span class="o">-&gt;</span><span class="n">VDisplay</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">VSyncEnd</span> <span class="o">=</span> <span class="n">mt</span><span class="o">-&gt;</span><span class="n">VSyncStart</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">VTotal</span> <span class="o">=</span> <span class="n">mt</span><span class="o">-&gt;</span><span class="n">VSyncEnd</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">mt</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">matroxfb_PLL_calcclock</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_pll_features</span><span class="o">*</span> <span class="n">pll</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmax</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">feed</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">post</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bestdiff</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bestvco</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fxtal</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ref_freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fwant</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">fwant</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;post_shift_max: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">post_shift_max</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ref_freq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ref_freq</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;freq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vco_freq_min: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vco_freq_min</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;in_div_min: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">in_div_min</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;in_div_max: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">in_div_max</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;feed_div_min: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">feed_div_min</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;feed_div_max: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">feed_div_max</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;fmax: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmax</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">post_shift_max</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fwant</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">fmax</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">fwant</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwant</span> <span class="o">&lt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vco_freq_min</span><span class="p">)</span> <span class="n">fwant</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vco_freq_min</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwant</span> <span class="o">&gt;</span> <span class="n">fmax</span><span class="p">)</span> <span class="n">fwant</span> <span class="o">=</span> <span class="n">fmax</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">p</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fwant</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bestdiff</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fwant</span> <span class="o">&lt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vco_freq_min</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">in_div_min</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">in_div_max</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">diff</span><span class="p">,</span> <span class="n">fvco</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

			<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">fwant</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">fxtal</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">fxtal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">feed_div_max</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">feed_div_min</span><span class="p">)</span>
				<span class="n">n</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">feed_div_min</span><span class="p">;</span>
			<span class="n">fvco</span> <span class="o">=</span> <span class="p">(</span><span class="n">fxtal</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fvco</span> <span class="o">&lt;</span> <span class="n">fwant</span><span class="p">)</span>
				<span class="n">diff</span> <span class="o">=</span> <span class="n">fwant</span> <span class="o">-</span> <span class="n">fvco</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">diff</span> <span class="o">=</span> <span class="n">fvco</span> <span class="o">-</span> <span class="n">fwant</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="n">bestdiff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bestdiff</span> <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>
				<span class="o">*</span><span class="n">post</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
				<span class="o">*</span><span class="n">in</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
				<span class="o">*</span><span class="n">feed</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
				<span class="n">bestvco</span> <span class="o">=</span> <span class="n">fvco</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;clk: %02X %02X %02X %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="o">*</span><span class="n">feed</span><span class="p">,</span> <span class="o">*</span><span class="n">post</span><span class="p">,</span> <span class="n">fxtal</span><span class="p">,</span> <span class="n">bestvco</span><span class="p">,</span> <span class="n">fwant</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bestvco</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">matroxfb_vgaHWinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">my_timming</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hd</span><span class="p">,</span> <span class="n">hs</span><span class="p">,</span> <span class="n">he</span><span class="p">,</span> <span class="n">hbe</span><span class="p">,</span> <span class="n">ht</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vd</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">ve</span><span class="p">,</span> <span class="n">vt</span><span class="p">,</span> <span class="n">lc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divider</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span> <span class="k">const</span> <span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">SEQ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">SEQ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* or 0x09 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">SEQ</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>	<span class="cm">/* bitplanes */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">SEQ</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">SEQ</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0E</span><span class="p">;</span>
	<span class="cm">/* CRTC 0..7, 9, 16..19, 21, 22 are reprogrammed by Matrox Millennium code... Hope that by MGA1064 too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">dblscan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">VTotal</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">VDisplay</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">VSyncStart</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">VSyncEnd</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">VTotal</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">VDisplay</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">VSyncStart</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">VSyncEnd</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* GCTL is ignored when not using 0xA0000 aperture */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">GCTL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">GCTL</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">GCTL</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">GCTL</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">GCTL</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">GCTL</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">GCTL</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">GCTL</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">GCTL</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="cm">/* Whole ATTR is ignored in PowerGraphics mode */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ATTR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ATTR</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ATTR</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ATTR</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ATTR</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ATTR</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">HDisplay</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">hs</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">HSyncStart</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">he</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">HSyncEnd</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ht</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">HTotal</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="cm">/* standard timmings are in 8pixels, but for interleaved we cannot */</span>
	<span class="cm">/* do it for 4bpp (because of (4bpp &gt;&gt; 1(interleaved))/4 == 0) */</span>
	<span class="cm">/* using 16 or more pixels per unit can save us */</span>
	<span class="n">divider</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">final_bppShift</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hd</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hs</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">he</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ht</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">divider</span> <span class="o">=</span> <span class="n">divider</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="cm">/* divider can be from 1 to 8 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hd</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hs</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">he</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ht</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hd</span> <span class="o">=</span> <span class="n">hd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hs</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">he</span> <span class="o">=</span> <span class="n">he</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ht</span> <span class="o">=</span> <span class="n">ht</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vd</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">VDisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vs</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">VSyncStart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ve</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">VSyncEnd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vt</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">VTotal</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lc</span> <span class="o">=</span> <span class="n">vd</span><span class="p">;</span>
	<span class="cm">/* G200 cannot work with (ht &amp; 7) == 6 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ht</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">ht</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">))</span>
		<span class="n">ht</span><span class="o">++</span><span class="p">;</span>
	<span class="n">hbe</span> <span class="o">=</span> <span class="n">ht</span><span class="p">;</span>
	<span class="n">wd</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">fbcon</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">final_bppShift</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hs</span> <span class="o">+</span> <span class="n">he</span> <span class="o">-</span> <span class="n">ht</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">dblscan</span><span class="p">)</span>
			<span class="n">wd</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">wd</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">ht</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">((</span><span class="n">hd</span>      <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* blanking */</span>
			  <span class="p">((</span><span class="n">hs</span>      <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* sync start */</span>
			   <span class="p">(</span><span class="n">hbe</span>     <span class="o">&amp;</span> <span class="mh">0x040</span><span class="p">);</span>	 <span class="cm">/* end hor. blanking */</span>
	<span class="cm">/* FIXME: Enable vidrst only on G400, and only if TV-out is used */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">MATROXFB_SRC_CRTC1</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x88</span><span class="p">;</span>		<span class="cm">/* enable horizontal and vertical vidrst */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="p">((</span><span class="n">vt</span> <span class="o">&amp;</span> <span class="mh">0xC00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">((</span><span class="n">vd</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* disp end */</span>
			  <span class="p">((</span><span class="n">vd</span> <span class="o">&amp;</span> <span class="mh">0xC00</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* vblanking start */</span>
			  <span class="p">((</span><span class="n">vs</span> <span class="o">&amp;</span> <span class="mh">0xC00</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">((</span><span class="n">lc</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">3</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">divider</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTCEXT</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ht</span><span class="o">-</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hd</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hd</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hbe</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">hs</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">hbe</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">he</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">vt</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">vd</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">vs</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">vd</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">lc</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">vt</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">vd</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">vs</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">vd</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">lc</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">dblscan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">vs</span> <span class="cm">/* &amp; 0xFF */</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ve</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">vd</span> <span class="cm">/* &amp; 0xFF */</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">wd</span> <span class="cm">/* &amp; 0xFF */</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">vd</span> <span class="cm">/* &amp; 0xFF */</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* &amp; 0xFF */</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC3</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">matroxfb_vgaHWrestore</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">matrox_hw_state</span> <span class="o">*</span> <span class="k">const</span> <span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">CRITFLAGS</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">__func__</span><span class="p">)</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;MiscOutReg: %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SEQ regs:   &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%02X:&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">SEQ</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;GDC regs:   &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%02X:&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">GCTL</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;CRTC regs: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%02X:&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ATTR regs: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%02X:&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ATTR</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">CRITBEGIN</span>

	<span class="n">mga_inb</span><span class="p">(</span><span class="n">M_ATTR_RESET</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_ATTR_INDEX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_MISC_REG</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_SEQ_INDEX</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">SEQ</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_CRTC_INDEX</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_CRTC_INDEX</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mga_setr</span><span class="p">(</span><span class="n">M_GRAPHICS_INDEX</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">GCTL</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_inb</span><span class="p">(</span><span class="n">M_ATTR_RESET</span><span class="p">);</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_ATTR_INDEX</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_ATTR_INDEX</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ATTR</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_PALETTE_MASK</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_DAC_REG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">768</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_DAC_VAL</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">DACpal</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">mga_inb</span><span class="p">(</span><span class="n">M_ATTR_RESET</span><span class="p">);</span>
	<span class="n">mga_outb</span><span class="p">(</span><span class="n">M_ATTR_INDEX</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">CRITEND</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span><span class="o">*</span> <span class="n">pins</span><span class="p">,</span> <span class="k">struct</span> <span class="n">matrox_bios</span><span class="o">*</span> <span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">b0</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">b0</span> <span class="o">==</span> <span class="mh">0x2E</span> <span class="o">&amp;&amp;</span> <span class="n">readb</span><span class="p">(</span><span class="n">pins</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x41</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pins_len</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pins</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cksum</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pins_len</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">pins_len</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x2E</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">pins_len</span><span class="p">;</span>
		<span class="n">cksum</span> <span class="o">=</span> <span class="mh">0x2E</span> <span class="o">+</span> <span class="mh">0x41</span> <span class="o">+</span> <span class="n">pins_len</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pins_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cksum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pins</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cksum</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins_len</span> <span class="o">=</span> <span class="n">pins_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b0</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">&amp;&amp;</span> <span class="n">readb</span><span class="p">(</span><span class="n">pins</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">;</span>

		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pins</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins_len</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_bios_version</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">vbios</span><span class="p">,</span> <span class="k">struct</span> <span class="n">matrox_bios</span><span class="o">*</span> <span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pcir_offset</span><span class="p">;</span>
	
	<span class="n">pcir_offset</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcir_offset</span> <span class="o">&gt;=</span> <span class="mi">26</span> <span class="o">&amp;&amp;</span> <span class="n">pcir_offset</span> <span class="o">&lt;</span> <span class="mh">0xFFE0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">pcir_offset</span>    <span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;P&#39;</span> <span class="o">&amp;&amp;</span>
	    <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">pcir_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span> <span class="o">&amp;&amp;</span>
	    <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">pcir_offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;I&#39;</span> <span class="o">&amp;&amp;</span>
	    <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">pcir_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">h</span><span class="p">;</span>

		<span class="n">h</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">pcir_offset</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">);</span>
		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">vMaj</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">vMin</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">vRev</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">pcir_offset</span> <span class="o">+</span> <span class="mh">0x13</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">h</span><span class="p">;</span>

		<span class="n">h</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">vMaj</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">vMin</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">vRev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_bios_output</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span><span class="o">*</span> <span class="n">vbios</span><span class="p">,</span> <span class="k">struct</span> <span class="n">matrox_bios</span><span class="o">*</span> <span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">;</span>
	
	<span class="n">b</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="mh">0x7FF1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_bios_tvout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span><span class="o">*</span> <span class="n">vbios</span><span class="p">,</span> <span class="k">struct</span> <span class="n">matrox_bios</span><span class="o">*</span> <span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="cm">/* Check for &#39;IBM .*(V....TVO&#39; string - it means TVO BIOS */</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">tvout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="mh">0x1D</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span>
	    <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="mh">0x1E</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;B&#39;</span> <span class="o">||</span>
	    <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;M&#39;</span> <span class="o">||</span>
	    <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
	    	<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x2D</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x2D</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="sc">&#39;(&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;O&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bd</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">tvout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_bios</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span><span class="o">*</span> <span class="n">vbios</span><span class="p">,</span> <span class="k">struct</span> <span class="n">matrox_bios</span><span class="o">*</span> <span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pins_offset</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">vbios</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span> <span class="o">||</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">bios_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">get_bios_version</span><span class="p">(</span><span class="n">vbios</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
	<span class="n">get_bios_output</span><span class="p">(</span><span class="n">vbios</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
	<span class="n">get_bios_tvout</span><span class="p">(</span><span class="n">vbios</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
<span class="cp">#if defined(__powerpc__)</span>
	<span class="cm">/* On PowerPC cards, the PInS offset isn&#39;t stored at the end of the</span>
<span class="cm">	 * BIOS image.  Instead, you must search the entire BIOS image for</span>
<span class="cm">	 * the magic PInS signature.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This actually applies to all OpenFirmware base cards.  Since these</span>
<span class="cm">	 * cards could be put in a MIPS or SPARC system, should the condition</span>
<span class="cm">	 * be something different?</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">pins_offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">pins_offset</span> <span class="o">&lt;=</span> <span class="mh">0xFF80</span> <span class="p">;</span> <span class="n">pins_offset</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">header</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">pins_offset</span><span class="p">);</span>
		<span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">pins_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">pins_offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x2E</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x41</span><span class="p">)</span>
		     <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PInS data found at offset %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pins_offset</span><span class="p">);</span>
			<span class="n">get_pins</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">pins_offset</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">pins_offset</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="mh">0x7FFC</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="mh">0x7FFD</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins_offset</span> <span class="o">&lt;=</span> <span class="mh">0xFF80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_pins</span><span class="p">(</span><span class="n">vbios</span> <span class="o">+</span> <span class="n">pins_offset</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_pins1</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_bios</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxdac</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">22</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="n">maxdac</span> <span class="o">=</span> <span class="mi">175000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:		<span class="n">maxdac</span> <span class="o">=</span> <span class="mi">220000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="n">maxdac</span> <span class="o">=</span> <span class="mi">240000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">maxdac</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">24</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span> <span class="o">=</span> <span class="n">maxdac</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">28</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">28</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">:</span> <span class="mi">50000</span><span class="p">;</span>
	<span class="cm">/* ignore 4MB, 8MB, module clocks */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span> <span class="o">=</span> <span class="mi">14318</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span>	<span class="o">=</span> <span class="mh">0x00030101</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">default_pins1</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Millennium */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="mi">220000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">system</span>	<span class="o">=</span>  <span class="mi">50000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	<span class="o">=</span>  <span class="mi">14318</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span>	<span class="o">=</span> <span class="mh">0x00030101</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_pins2</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_bios</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">230000</span> <span class="o">:</span> <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span>	<span class="o">=</span> <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00000001</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00000100</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00010000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00020000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">system</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">50000</span> <span class="o">:</span> <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	<span class="o">=</span> <span class="mi">14318</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">default_pins2</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Millennium II, Mystique */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="mi">230000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span>	<span class="o">=</span> <span class="mh">0x00030101</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">system</span>	<span class="o">=</span>  <span class="mi">50000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	<span class="o">=</span>  <span class="mi">14318</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_pins3</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_bios</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">230000</span>			<span class="o">:</span> <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span>	<span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">48</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span> <span class="o">?</span>
		<span class="mh">0x01250A21</span> <span class="o">:</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>
	<span class="cm">/* memory config */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span>	<span class="o">=</span> <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1E000000</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00C00000</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000001E0</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span>        <span class="o">&amp;</span> <span class="mh">0x0000000F</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span>		<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">54</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt2</span>		<span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">58</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">52</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="mi">14318</span> <span class="o">:</span> <span class="mi">27000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">default_pins3</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* G100, G200 */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="mi">230000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span>	<span class="o">=</span> <span class="mh">0x01250A21</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span>	<span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span>		<span class="o">=</span> <span class="mh">0x00000C00</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt2</span>		<span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	<span class="o">=</span>  <span class="mi">27000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_pins4</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_bios</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">39</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">230000</span>			<span class="o">:</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">39</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">38</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">:</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">38</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span>	<span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">71</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span>	<span class="o">=</span> <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">87</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1E000000</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">87</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00C00000</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">86</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000001E0</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">86</span><span class="p">]</span>        <span class="o">&amp;</span> <span class="mh">0x0000000F</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span>		<span class="o">=</span> <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00400000</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">((</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00001C00</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt3</span>		<span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">67</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">system</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">65</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">200000</span> 			<span class="o">:</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">65</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">92</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">14318</span> <span class="o">:</span> <span class="mi">27000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">default_pins4</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* G400 */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="mi">252000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span>	<span class="o">=</span> <span class="mh">0x04A450A1</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span>	<span class="o">=</span> <span class="mh">0x000000E7</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span>		<span class="o">=</span> <span class="mh">0x10000400</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt3</span>		<span class="o">=</span> <span class="mh">0x0190A419</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">system</span>	<span class="o">=</span> <span class="mi">200000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	<span class="o">=</span> <span class="mi">27000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_pins5</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_bios</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mult</span><span class="p">;</span>
	
	<span class="n">mult</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">?</span><span class="mi">8000</span><span class="o">:</span><span class="mi">6000</span><span class="p">;</span>
	
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">38</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">600000</span>			<span class="o">:</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">38</span><span class="p">]</span> <span class="o">*</span> <span class="n">mult</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">36</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">:</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">36</span><span class="p">]</span> <span class="o">*</span> <span class="n">mult</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">video</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">37</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">:</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">37</span><span class="p">]</span> <span class="o">*</span> <span class="n">mult</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomin</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">123</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256000</span>			<span class="o">:</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">123</span><span class="p">]</span> <span class="o">*</span> <span class="n">mult</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomin</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">121</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomin</span>	<span class="o">:</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">121</span><span class="p">]</span> <span class="o">*</span> <span class="n">mult</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">video</span><span class="p">.</span><span class="n">vcomin</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">122</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomin</span>	<span class="o">:</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">122</span><span class="p">]</span> <span class="o">*</span> <span class="n">mult</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">system</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">video</span>		<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">92</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">284000</span>			<span class="o">:</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span> <span class="mi">92</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span>		<span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt2</span>		<span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">52</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt3</span>		<span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">94</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span>	<span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">98</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memmisc</span>	<span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">102</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span>	<span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span> <span class="o">+</span> <span class="mi">106</span><span class="p">);</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">110</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">14318</span> <span class="o">:</span> <span class="mi">27000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">ddr</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">114</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">dll</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">115</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">emrswen</span>	<span class="o">=</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">115</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">maccess</span>	<span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">emrswen</span> <span class="o">?</span> <span class="mh">0x00004000</span> <span class="o">:</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">115</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst_core</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_int32_t</span> <span class="n">wtst_xlat</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst_core</span> <span class="o">=</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
						  <span class="n">wtst_xlat</span><span class="p">[</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">max_pixel_clock_panellink</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">47</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">default_pins5</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Mine 16MB G450 with SDRAM DDR */</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">video</span><span class="p">.</span><span class="n">vcomax</span>	<span class="o">=</span> <span class="mi">600000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">pixel</span><span class="p">.</span><span class="n">vcomin</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">system</span><span class="p">.</span><span class="n">vcomin</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">video</span><span class="p">.</span><span class="n">vcomin</span>	<span class="o">=</span> <span class="mi">256000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">system</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">video</span>		<span class="o">=</span> <span class="mi">284000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span>		<span class="o">=</span> <span class="mh">0x404A1160</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt2</span>		<span class="o">=</span> <span class="mh">0x0000AC00</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt3</span>		<span class="o">=</span> <span class="mh">0x0090A409</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst_core</span>	<span class="o">=</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">mctlwtst</span>	<span class="o">=</span> <span class="mh">0x0C81462B</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memmisc</span>	<span class="o">=</span> <span class="mh">0x80000004</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">memrdbk</span>	<span class="o">=</span> <span class="mh">0x01001103</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_freq</span>	<span class="o">=</span> <span class="mi">27000</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">ddr</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">dll</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">emrswen</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">maccess</span>	<span class="o">=</span> <span class="mh">0x00004000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">matroxfb_set_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">matrox_bios</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pins_version</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pinslen</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span> <span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MGA_2064</span>:	<span class="n">default_pins1</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGA_2164</span>:
		<span class="k">case</span> <span class="n">MGA_1064</span>:
		<span class="k">case</span> <span class="n">MGA_1164</span>:	<span class="n">default_pins2</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGA_G100</span>:
		<span class="k">case</span> <span class="n">MGA_G200</span>:	<span class="n">default_pins3</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGA_G400</span>:	<span class="n">default_pins4</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGA_G450</span>:
		<span class="k">case</span> <span class="n">MGA_G550</span>:	<span class="n">default_pins5</span><span class="p">(</span><span class="n">minfo</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bios_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;matroxfb: Your Matrox device does not have BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins_len</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;matroxfb: BIOS on your Matrox device does not contain powerup info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x2E</span> <span class="o">&amp;&amp;</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x41</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pins_version</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pins_version</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">pins_version</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;matroxfb: Unknown version (%u) of powerup info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pins_version</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pins_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">pins_len</span> <span class="o">!=</span> <span class="n">pinslen</span><span class="p">[</span><span class="n">pins_version</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;matroxfb: Invalid powerup info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pins_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">return</span> <span class="n">parse_pins1</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">return</span> <span class="n">parse_pins2</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="k">return</span> <span class="n">parse_pins3</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="k">return</span> <span class="n">parse_pins4</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="k">return</span> <span class="n">parse_pins5</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;matroxfb: Powerup info version %u is not yet supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pins_version</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">matroxfb_read_pins</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrox_fb_info</span> <span class="o">*</span><span class="n">minfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">opt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">biosbase</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fbbase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">));</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">opt</span> <span class="o">|</span> <span class="n">PCI_OPTION_ENABLE_ROM</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_ROM_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">biosbase</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">.</span><span class="n">fbResource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbbase</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_ROM_ADDRESS</span><span class="p">,</span> <span class="p">(</span><span class="n">fbbase</span> <span class="o">&amp;</span> <span class="n">PCI_ROM_ADDRESS_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">PCI_ROM_ADDRESS_ENABLE</span><span class="p">);</span>
	<span class="n">parse_bios</span><span class="p">(</span><span class="n">vaddr_va</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_ROM_ADDRESS</span><span class="p">,</span> <span class="n">biosbase</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_OPTION_REG</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_X86</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">.</span><span class="n">bios_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span><span class="o">*</span> <span class="n">b</span><span class="p">;</span>

		<span class="n">b</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="mh">0x000C0000</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;matroxfb: Unable to map legacy BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ven</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mh">0x64</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mh">0x64</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mh">0x64</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mh">0x64</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">ven</span> <span class="o">!=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">!=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;matroxfb: Legacy BIOS is for %04X:%04X, while this device is %04X:%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ven</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">parse_bios</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">matroxfb_set_limits</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PInS memtype = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">.</span><span class="n">reg</span><span class="p">.</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="mh">0x1C00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matroxfb_DAC_in</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matroxfb_DAC_out</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matroxfb_var2my</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matroxfb_PLL_calcclock</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matroxfb_vgaHWinit</span><span class="p">);</span>		<span class="cm">/* DAC1064, Ti3026 */</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matroxfb_vgaHWrestore</span><span class="p">);</span>		<span class="cm">/* DAC1064, Ti3026 */</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">matroxfb_read_pins</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;(c) 1999-2002 Petr Vandrovec &lt;vandrove@vc.cvut.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Miscellaneous support for Matrox video cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
