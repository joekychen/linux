<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › imsttfb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>imsttfb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/video/imsttfb.c -- frame buffer device for IMS TwinTurbo</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is derived from the powermac console &quot;imstt&quot; driver:</span>
<span class="cm"> *  Copyright (C) 1997 Sigurdur Asgeirsson</span>
<span class="cm"> *  With additional hacking by Jeffrey Kuskin (jsk@mojave.stanford.edu)</span>
<span class="cm"> *  Modified by Danilo Beuche 1998</span>
<span class="cm"> *  Some register values added by Damien Doligez, INRIA Rocquencourt</span>
<span class="cm"> *  Various cleanups by Paul Mundt (lethal@chaoticdreams.org)</span>
<span class="cm"> *</span>
<span class="cm"> *  This file was written by Ryan Nielsen (ran@krazynet.com)</span>
<span class="cm"> *  Most of the frame buffer device stuff was copied from atyfb.c</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> *  License. See the file COPYING in the main directory of this archive for</span>
<span class="cm"> *  more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#if defined(CONFIG_PPC)</span>
<span class="cp">#include &lt;linux/nvram.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#include &quot;macmodes.h&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef __powerpc__</span>
<span class="cp">#define eieio()		</span><span class="cm">/* Enforce In-order Execution of I/O */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cm">/* TwinTurbo (Cosmo) registers */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">S1SA</span>	<span class="o">=</span>  <span class="mi">0</span><span class="p">,</span> <span class="cm">/* 0x00 */</span>
	<span class="n">S2SA</span>	<span class="o">=</span>  <span class="mi">1</span><span class="p">,</span> <span class="cm">/* 0x04 */</span>
	<span class="n">SP</span>	<span class="o">=</span>  <span class="mi">2</span><span class="p">,</span> <span class="cm">/* 0x08 */</span>
	<span class="n">DSA</span>	<span class="o">=</span>  <span class="mi">3</span><span class="p">,</span> <span class="cm">/* 0x0C */</span>
	<span class="n">CNT</span>	<span class="o">=</span>  <span class="mi">4</span><span class="p">,</span> <span class="cm">/* 0x10 */</span>
	<span class="n">DP_OCTL</span>	<span class="o">=</span>  <span class="mi">5</span><span class="p">,</span> <span class="cm">/* 0x14 */</span>
	<span class="n">CLR</span>	<span class="o">=</span>  <span class="mi">6</span><span class="p">,</span> <span class="cm">/* 0x18 */</span>
	<span class="n">BI</span>	<span class="o">=</span>  <span class="mi">8</span><span class="p">,</span> <span class="cm">/* 0x20 */</span>
	<span class="n">MBC</span>	<span class="o">=</span>  <span class="mi">9</span><span class="p">,</span> <span class="cm">/* 0x24 */</span>
	<span class="n">BLTCTL</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="cm">/* 0x28 */</span>

	<span class="cm">/* Scan Timing Generator Registers */</span>
	<span class="n">HES</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="cm">/* 0x30 */</span>
	<span class="n">HEB</span>	<span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="cm">/* 0x34 */</span>
	<span class="n">HSB</span>	<span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="cm">/* 0x38 */</span>
	<span class="n">HT</span>	<span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="cm">/* 0x3C */</span>
	<span class="n">VES</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="cm">/* 0x40 */</span>
	<span class="n">VEB</span>	<span class="o">=</span> <span class="mi">17</span><span class="p">,</span> <span class="cm">/* 0x44 */</span>
	<span class="n">VSB</span>	<span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="cm">/* 0x48 */</span>
	<span class="n">VT</span>	<span class="o">=</span> <span class="mi">19</span><span class="p">,</span> <span class="cm">/* 0x4C */</span>
	<span class="n">HCIV</span>	<span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="cm">/* 0x50 */</span>
	<span class="n">VCIV</span>	<span class="o">=</span> <span class="mi">21</span><span class="p">,</span> <span class="cm">/* 0x54 */</span>
	<span class="n">TCDR</span>	<span class="o">=</span> <span class="mi">22</span><span class="p">,</span> <span class="cm">/* 0x58 */</span>
	<span class="n">VIL</span>	<span class="o">=</span> <span class="mi">23</span><span class="p">,</span> <span class="cm">/* 0x5C */</span>
	<span class="n">STGCTL</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span> <span class="cm">/* 0x60 */</span>

	<span class="cm">/* Screen Refresh Generator Registers */</span>
	<span class="n">SSR</span>	<span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="cm">/* 0x64 */</span>
	<span class="n">HRIR</span>	<span class="o">=</span> <span class="mi">26</span><span class="p">,</span> <span class="cm">/* 0x68 */</span>
	<span class="n">SPR</span>	<span class="o">=</span> <span class="mi">27</span><span class="p">,</span> <span class="cm">/* 0x6C */</span>
	<span class="n">CMR</span>	<span class="o">=</span> <span class="mi">28</span><span class="p">,</span> <span class="cm">/* 0x70 */</span>
	<span class="n">SRGCTL</span>	<span class="o">=</span> <span class="mi">29</span><span class="p">,</span> <span class="cm">/* 0x74 */</span>

	<span class="cm">/* RAM Refresh Generator Registers */</span>
	<span class="n">RRCIV</span>	<span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="cm">/* 0x78 */</span>
	<span class="n">RRSC</span>	<span class="o">=</span> <span class="mi">31</span><span class="p">,</span> <span class="cm">/* 0x7C */</span>
	<span class="n">RRCR</span>	<span class="o">=</span> <span class="mi">34</span><span class="p">,</span> <span class="cm">/* 0x88 */</span>

	<span class="cm">/* System Registers */</span>
	<span class="n">GIOE</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="cm">/* 0x80 */</span>
	<span class="n">GIO</span>	<span class="o">=</span> <span class="mi">33</span><span class="p">,</span> <span class="cm">/* 0x84 */</span>
	<span class="n">SCR</span>	<span class="o">=</span> <span class="mi">35</span><span class="p">,</span> <span class="cm">/* 0x8C */</span>
	<span class="n">SSTATUS</span>	<span class="o">=</span> <span class="mi">36</span><span class="p">,</span> <span class="cm">/* 0x90 */</span>
	<span class="n">PRC</span>	<span class="o">=</span> <span class="mi">37</span><span class="p">,</span> <span class="cm">/* 0x94 */</span>

<span class="cp">#if 0</span><span class="c">	</span>
<span class="c">	/* PCI Registers */</span>
<span class="c">	DVID	= 0x00000000L,</span>
<span class="c">	SC	= 0x00000004L,</span>
<span class="c">	CCR	= 0x00000008L,</span>
<span class="c">	OG	= 0x0000000CL,</span>
<span class="c">	BARM	= 0x00000010L,</span>
<span class="c">	BARER	= 0x00000030L,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* IBM 624 RAMDAC Direct Registers */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PADDRW</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">PDATA</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">PPMASK</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">PADDRR</span>	<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="n">PIDXLO</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>	
	<span class="n">PIDXHI</span>	<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>	
	<span class="n">PIDXDATA</span><span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
	<span class="n">PIDXCTL</span>	<span class="o">=</span> <span class="mh">0x1c</span>
<span class="p">};</span>

<span class="cm">/* IBM 624 RAMDAC Indirect Registers */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CLKCTL</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>	<span class="cm">/* (0x01) Miscellaneous Clock Control */</span>
	<span class="n">SYNCCTL</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>	<span class="cm">/* (0x00) Sync Control */</span>
	<span class="n">HSYNCPOS</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>	<span class="cm">/* (0x00) Horizontal Sync Position */</span>
	<span class="n">PWRMNGMT</span>	<span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>	<span class="cm">/* (0x00) Power Management */</span>
	<span class="n">DACOP</span>		<span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>	<span class="cm">/* (0x02) DAC Operation */</span>
	<span class="n">PALETCTL</span>	<span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>	<span class="cm">/* (0x00) Palette Control */</span>
	<span class="n">SYSCLKCTL</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>	<span class="cm">/* (0x01) System Clock Control */</span>
	<span class="n">PIXFMT</span>		<span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>	<span class="cm">/* () Pixel Format  [bpp &gt;&gt; 3 + 2] */</span>
	<span class="n">BPP8</span>		<span class="o">=</span> <span class="mh">0x0b</span><span class="p">,</span>	<span class="cm">/* () 8 Bits/Pixel Control */</span>
	<span class="n">BPP16</span>		<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="cm">/* () 16 Bits/Pixel Control  [bit 1=1 for 565] */</span>
	<span class="n">BPP24</span>		<span class="o">=</span> <span class="mh">0x0d</span><span class="p">,</span>	<span class="cm">/* () 24 Bits/Pixel Control */</span>
	<span class="n">BPP32</span>		<span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>	<span class="cm">/* () 32 Bits/Pixel Control */</span>
	<span class="n">PIXCTL1</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="cm">/* (0x05) Pixel PLL Control 1 */</span>
	<span class="n">PIXCTL2</span>		<span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>	<span class="cm">/* (0x00) Pixel PLL Control 2 */</span>
	<span class="n">SYSCLKN</span>		<span class="o">=</span> <span class="mh">0x15</span><span class="p">,</span>	<span class="cm">/* () System Clock N (System PLL Reference Divider) */</span>
	<span class="n">SYSCLKM</span>		<span class="o">=</span> <span class="mh">0x16</span><span class="p">,</span>	<span class="cm">/* () System Clock M (System PLL VCO Divider) */</span>
	<span class="n">SYSCLKP</span>		<span class="o">=</span> <span class="mh">0x17</span><span class="p">,</span>	<span class="cm">/* () System Clock P */</span>
	<span class="n">SYSCLKC</span>		<span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>	<span class="cm">/* () System Clock C */</span>
	<span class="cm">/*</span>
<span class="cm">	 * Dot clock rate is 20MHz * (m + 1) / ((n + 1) * (p ? 2 * p : 1)</span>
<span class="cm">	 * c is charge pump bias which depends on the VCO frequency  </span>
<span class="cm">	 */</span>
	<span class="n">PIXM0</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>	<span class="cm">/* () Pixel M 0 */</span>
	<span class="n">PIXN0</span>		<span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span>	<span class="cm">/* () Pixel N 0 */</span>
	<span class="n">PIXP0</span>		<span class="o">=</span> <span class="mh">0x22</span><span class="p">,</span>	<span class="cm">/* () Pixel P 0 */</span>
	<span class="n">PIXC0</span>		<span class="o">=</span> <span class="mh">0x23</span><span class="p">,</span>	<span class="cm">/* () Pixel C 0 */</span>
	<span class="n">CURSCTL</span>		<span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>	<span class="cm">/* (0x00) Cursor Control */</span>
	<span class="n">CURSXLO</span>		<span class="o">=</span> <span class="mh">0x31</span><span class="p">,</span>	<span class="cm">/* () Cursor X position, low 8 bits */</span>
	<span class="n">CURSXHI</span>		<span class="o">=</span> <span class="mh">0x32</span><span class="p">,</span>	<span class="cm">/* () Cursor X position, high 8 bits */</span>
	<span class="n">CURSYLO</span>		<span class="o">=</span> <span class="mh">0x33</span><span class="p">,</span>	<span class="cm">/* () Cursor Y position, low 8 bits */</span>
	<span class="n">CURSYHI</span>		<span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span>	<span class="cm">/* () Cursor Y position, high 8 bits */</span>
	<span class="n">CURSHOTX</span>	<span class="o">=</span> <span class="mh">0x35</span><span class="p">,</span>	<span class="cm">/* () Cursor Hot Spot X */</span>
	<span class="n">CURSHOTY</span>	<span class="o">=</span> <span class="mh">0x36</span><span class="p">,</span>	<span class="cm">/* () Cursor Hot Spot Y */</span>
	<span class="n">CURSACCTL</span>	<span class="o">=</span> <span class="mh">0x37</span><span class="p">,</span>	<span class="cm">/* () Advanced Cursor Control Enable */</span>
	<span class="n">CURSACATTR</span>	<span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>	<span class="cm">/* () Advanced Cursor Attribute */</span>
	<span class="n">CURS1R</span>		<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>	<span class="cm">/* () Cursor 1 Red */</span>
	<span class="n">CURS1G</span>		<span class="o">=</span> <span class="mh">0x41</span><span class="p">,</span>	<span class="cm">/* () Cursor 1 Green */</span>
	<span class="n">CURS1B</span>		<span class="o">=</span> <span class="mh">0x42</span><span class="p">,</span>	<span class="cm">/* () Cursor 1 Blue */</span>
	<span class="n">CURS2R</span>		<span class="o">=</span> <span class="mh">0x43</span><span class="p">,</span>	<span class="cm">/* () Cursor 2 Red */</span>
	<span class="n">CURS2G</span>		<span class="o">=</span> <span class="mh">0x44</span><span class="p">,</span>	<span class="cm">/* () Cursor 2 Green */</span>
	<span class="n">CURS2B</span>		<span class="o">=</span> <span class="mh">0x45</span><span class="p">,</span>	<span class="cm">/* () Cursor 2 Blue */</span>
	<span class="n">CURS3R</span>		<span class="o">=</span> <span class="mh">0x46</span><span class="p">,</span>	<span class="cm">/* () Cursor 3 Red */</span>
	<span class="n">CURS3G</span>		<span class="o">=</span> <span class="mh">0x47</span><span class="p">,</span>	<span class="cm">/* () Cursor 3 Green */</span>
	<span class="n">CURS3B</span>		<span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span>	<span class="cm">/* () Cursor 3 Blue */</span>
	<span class="n">BORDR</span>		<span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>	<span class="cm">/* () Border Color Red */</span>
	<span class="n">BORDG</span>		<span class="o">=</span> <span class="mh">0x61</span><span class="p">,</span>	<span class="cm">/* () Border Color Green */</span>
	<span class="n">BORDB</span>		<span class="o">=</span> <span class="mh">0x62</span><span class="p">,</span>	<span class="cm">/* () Border Color Blue */</span>
	<span class="n">MISCTL1</span>		<span class="o">=</span> <span class="mh">0x70</span><span class="p">,</span>	<span class="cm">/* (0x00) Miscellaneous Control 1 */</span>
	<span class="n">MISCTL2</span>		<span class="o">=</span> <span class="mh">0x71</span><span class="p">,</span>	<span class="cm">/* (0x00) Miscellaneous Control 2 */</span>
	<span class="n">MISCTL3</span>		<span class="o">=</span> <span class="mh">0x72</span><span class="p">,</span>	<span class="cm">/* (0x00) Miscellaneous Control 3 */</span>
	<span class="n">KEYCTL</span>		<span class="o">=</span> <span class="mh">0x78</span>	<span class="cm">/* (0x00) Key Control/DB Operation */</span>
<span class="p">};</span>

<span class="cm">/* TI TVP 3030 RAMDAC Direct Registers */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TVPADDRW</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* 0  Palette/Cursor RAM Write Address/Index */</span>
	<span class="n">TVPPDATA</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>	<span class="cm">/* 1  Palette Data RAM Data */</span>
	<span class="n">TVPPMASK</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>	<span class="cm">/* 2  Pixel Read-Mask */</span>
	<span class="n">TVPPADRR</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>	<span class="cm">/* 3  Palette/Cursor RAM Read Address */</span>
	<span class="n">TVPCADRW</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>	<span class="cm">/* 4  Cursor/Overscan Color Write Address */</span>
	<span class="n">TVPCDATA</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>	<span class="cm">/* 5  Cursor/Overscan Color Data */</span>
				<span class="cm">/* 6  reserved */</span>
	<span class="n">TVPCADRR</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>	<span class="cm">/* 7  Cursor/Overscan Color Read Address */</span>
				<span class="cm">/* 8  reserved */</span>
	<span class="n">TVPDCCTL</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>	<span class="cm">/* 9  Direct Cursor Control */</span>
	<span class="n">TVPIDATA</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>	<span class="cm">/* 10 Index Data */</span>
	<span class="n">TVPCRDAT</span> <span class="o">=</span> <span class="mh">0x2c</span><span class="p">,</span>	<span class="cm">/* 11 Cursor RAM Data */</span>
	<span class="n">TVPCXPOL</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>	<span class="cm">/* 12 Cursor-Position X LSB */</span>
	<span class="n">TVPCXPOH</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span>	<span class="cm">/* 13 Cursor-Position X MSB */</span>
	<span class="n">TVPCYPOL</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>	<span class="cm">/* 14 Cursor-Position Y LSB */</span>
	<span class="n">TVPCYPOH</span> <span class="o">=</span> <span class="mh">0x3c</span><span class="p">,</span>	<span class="cm">/* 15 Cursor-Position Y MSB */</span>
<span class="p">};</span>

<span class="cm">/* TI TVP 3030 RAMDAC Indirect Registers */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TVPIRREV</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="cm">/* Silicon Revision [RO] */</span>
	<span class="n">TVPIRICC</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>	<span class="cm">/* Indirect Cursor Control 	(0x00) */</span>
	<span class="n">TVPIRBRC</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>	<span class="cm">/* Byte Router Control 	(0xe4) */</span>
	<span class="n">TVPIRLAC</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>	<span class="cm">/* Latch Control 		(0x06) */</span>
	<span class="n">TVPIRTCC</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>	<span class="cm">/* True Color Control  	(0x80) */</span>
	<span class="n">TVPIRMXC</span> <span class="o">=</span> <span class="mh">0x19</span><span class="p">,</span>	<span class="cm">/* Multiplex Control		(0x98) */</span>
	<span class="n">TVPIRCLS</span> <span class="o">=</span> <span class="mh">0x1a</span><span class="p">,</span>	<span class="cm">/* Clock Selection		(0x07) */</span>
	<span class="n">TVPIRPPG</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>	<span class="cm">/* Palette Page		(0x00) */</span>
	<span class="n">TVPIRGEC</span> <span class="o">=</span> <span class="mh">0x1d</span><span class="p">,</span>	<span class="cm">/* General Control 		(0x00) */</span>
	<span class="n">TVPIRMIC</span> <span class="o">=</span> <span class="mh">0x1e</span><span class="p">,</span>	<span class="cm">/* Miscellaneous Control	(0x00) */</span>
	<span class="n">TVPIRPLA</span> <span class="o">=</span> <span class="mh">0x2c</span><span class="p">,</span>	<span class="cm">/* PLL Address */</span>
	<span class="n">TVPIRPPD</span> <span class="o">=</span> <span class="mh">0x2d</span><span class="p">,</span>	<span class="cm">/* Pixel Clock PLL Data */</span>
	<span class="n">TVPIRMPD</span> <span class="o">=</span> <span class="mh">0x2e</span><span class="p">,</span>	<span class="cm">/* Memory Clock PLL Data */</span>
	<span class="n">TVPIRLPD</span> <span class="o">=</span> <span class="mh">0x2f</span><span class="p">,</span>	<span class="cm">/* Loop Clock PLL Data */</span>
	<span class="n">TVPIRCKL</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>	<span class="cm">/* Color-Key Overlay Low */</span>
	<span class="n">TVPIRCKH</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">,</span>	<span class="cm">/* Color-Key Overlay High */</span>
	<span class="n">TVPIRCRL</span> <span class="o">=</span> <span class="mh">0x32</span><span class="p">,</span>	<span class="cm">/* Color-Key Red Low */</span>
	<span class="n">TVPIRCRH</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">,</span>	<span class="cm">/* Color-Key Red High */</span>
	<span class="n">TVPIRCGL</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span>	<span class="cm">/* Color-Key Green Low */</span>
	<span class="n">TVPIRCGH</span> <span class="o">=</span> <span class="mh">0x35</span><span class="p">,</span>	<span class="cm">/* Color-Key Green High */</span>
	<span class="n">TVPIRCBL</span> <span class="o">=</span> <span class="mh">0x36</span><span class="p">,</span>	<span class="cm">/* Color-Key Blue Low */</span>
	<span class="n">TVPIRCBH</span> <span class="o">=</span> <span class="mh">0x37</span><span class="p">,</span>	<span class="cm">/* Color-Key Blue High */</span>
	<span class="n">TVPIRCKC</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>	<span class="cm">/* Color-Key Control 		(0x00) */</span>
	<span class="n">TVPIRMLC</span> <span class="o">=</span> <span class="mh">0x39</span><span class="p">,</span>	<span class="cm">/* MCLK/Loop Clock Control	(0x18) */</span>
	<span class="n">TVPIRSEN</span> <span class="o">=</span> <span class="mh">0x3a</span><span class="p">,</span>	<span class="cm">/* Sense Test			(0x00) */</span>
	<span class="n">TVPIRTMD</span> <span class="o">=</span> <span class="mh">0x3b</span><span class="p">,</span>	<span class="cm">/* Test Mode Data */</span>
	<span class="n">TVPIRRML</span> <span class="o">=</span> <span class="mh">0x3c</span><span class="p">,</span>	<span class="cm">/* CRC Remainder LSB [RO] */</span>
	<span class="n">TVPIRRMM</span> <span class="o">=</span> <span class="mh">0x3d</span><span class="p">,</span>	<span class="cm">/* CRC Remainder MSB [RO] */</span>
	<span class="n">TVPIRRMS</span> <span class="o">=</span> <span class="mh">0x3e</span><span class="p">,</span>	<span class="cm">/* CRC  Bit Select [WO] */</span>
	<span class="n">TVPIRDID</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">,</span>	<span class="cm">/* Device ID [RO] 		(0x30) */</span>
	<span class="n">TVPIRRES</span> <span class="o">=</span> <span class="mh">0xff</span>		<span class="cm">/* Software Reset [WO] */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">initvalues</span> <span class="p">{</span>
	<span class="n">__u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">initvalues</span> <span class="n">ibm_initregs</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">CLKCTL</span><span class="p">,</span>	<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SYNCCTL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HSYNCPOS</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PWRMNGMT</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DACOP</span><span class="p">,</span>	<span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PALETCTL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SYSCLKCTL</span><span class="p">,</span>	<span class="mh">0x01</span> <span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note that colors in X are correct only if all video data is</span>
<span class="cm">	 * passed through the palette in the DAC.  That is, &quot;indirect</span>
<span class="cm">	 * color&quot; must be configured.  This is the case for the IBM DAC</span>
<span class="cm">	 * used in the 2MB and 4MB cards, at least.</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="n">BPP8</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPP16</span><span class="p">,</span>	<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPP24</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BPP32</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PIXCTL1</span><span class="p">,</span>	<span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PIXCTL2</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SYSCLKN</span><span class="p">,</span>	<span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SYSCLKM</span><span class="p">,</span>	<span class="mh">0x4f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SYSCLKP</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SYSCLKC</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURSCTL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURSACCTL</span><span class="p">,</span>	<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURSACATTR</span><span class="p">,</span>	<span class="mh">0xa8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURS1R</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURS1G</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURS1B</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURS2R</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURS2G</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURS2B</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURS3R</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURS3G</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CURS3B</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BORDR</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BORDG</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BORDB</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MISCTL1</span><span class="p">,</span>	<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MISCTL2</span><span class="p">,</span>	<span class="mh">0x45</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MISCTL3</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">KEYCTL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">initvalues</span> <span class="n">tvp_initregs</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TVPIRICC</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRBRC</span><span class="p">,</span>	<span class="mh">0xe4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRLAC</span><span class="p">,</span>	<span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRTCC</span><span class="p">,</span>	<span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRMXC</span><span class="p">,</span>	<span class="mh">0x4d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRCLS</span><span class="p">,</span>	<span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRPPG</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRGEC</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRMIC</span><span class="p">,</span>	<span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRCKL</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRCKH</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRCRL</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRCRH</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRCGL</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRCGH</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRCBL</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRCBH</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRCKC</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRPLA</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRPPD</span><span class="p">,</span>	<span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRPPD</span><span class="p">,</span>	<span class="mh">0xd5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRPPD</span><span class="p">,</span>	<span class="mh">0xea</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRPLA</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRMPD</span><span class="p">,</span>	<span class="mh">0xb9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRMPD</span><span class="p">,</span>	<span class="mh">0x3a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRMPD</span><span class="p">,</span>	<span class="mh">0xb1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRPLA</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRLPD</span><span class="p">,</span>	<span class="mh">0xc1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRLPD</span><span class="p">,</span>	<span class="mh">0x3d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TVPIRLPD</span><span class="p">,</span>	<span class="mh">0xf3</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="p">{</span>
	<span class="n">__u32</span> <span class="n">pitch</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">hes</span><span class="p">,</span> <span class="n">heb</span><span class="p">,</span> <span class="n">hsb</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">ves</span><span class="p">,</span> <span class="n">veb</span><span class="p">,</span> <span class="n">vsb</span><span class="p">,</span> <span class="n">vt</span><span class="p">,</span> <span class="n">vil</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">pclk_m</span><span class="p">,</span> <span class="n">pclk_n</span><span class="p">,</span> <span class="n">pclk_p</span><span class="p">;</span>
	<span class="cm">/* Values of the tvp which change depending on colormode x resolution */</span>
	<span class="n">__u8</span> <span class="n">mlc</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* Memory Loop Config 0x39 */</span>
	<span class="n">__u8</span> <span class="n">lckl_p</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* P value of LCKL PLL */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">imstt_par</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="n">init</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dc_regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmap_regs_phys</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">cmap_regs</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">ramdac</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>
 
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">IBM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TVP</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="cp">#define USE_NV_MODES		1</span>
<span class="cp">#define INIT_BPP		8</span>
<span class="cp">#define INIT_XRES		640</span>
<span class="cp">#define INIT_YRES		480</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">inverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">fontname</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
<span class="cp">#if defined(CONFIG_PPC)</span>
<span class="k">static</span> <span class="kt">signed</span> <span class="kt">char</span> <span class="n">init_vmode</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">init_cmode</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="n">tvp_reg_init_2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">512</span><span class="p">,</span>
	<span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="mh">0x0196</span><span class="p">,</span> <span class="mh">0x0197</span><span class="p">,</span> <span class="mh">0x0196</span><span class="p">,</span>
	<span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span>
	<span class="p">{</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x39</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf3</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="n">tvp_reg_init_6</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">640</span><span class="p">,</span>
	<span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x002a</span><span class="p">,</span> <span class="mh">0x020a</span><span class="p">,</span> <span class="mh">0x020d</span><span class="p">,</span> <span class="mh">0x020a</span><span class="p">,</span>
	<span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span>
	<span class="p">{</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x38</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf3</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="n">tvp_reg_init_12</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">800</span><span class="p">,</span>
	<span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="mh">0x0042</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x018</span><span class="p">,</span> <span class="mh">0x270</span><span class="p">,</span> <span class="mh">0x271</span><span class="p">,</span> <span class="mh">0x270</span><span class="p">,</span>
	<span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span>
	<span class="p">{</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x38</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf3</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="n">tvp_reg_init_13</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">832</span><span class="p">,</span>
	<span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0045</span><span class="p">,</span> <span class="mh">0x0048</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x002a</span><span class="p">,</span> <span class="mh">0x029a</span><span class="p">,</span> <span class="mh">0x029b</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span>
	<span class="p">{</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x38</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf2</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="n">tvp_reg_init_17</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1024</span><span class="p">,</span>
	<span class="mh">0x0006</span><span class="p">,</span> <span class="mh">0x0210</span><span class="p">,</span> <span class="mh">0x0250</span><span class="p">,</span> <span class="mh">0x0053</span><span class="p">,</span> <span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">,</span> <span class="mh">0x0321</span><span class="p">,</span> <span class="mh">0x0324</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span>
	<span class="p">{</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x38</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf2</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="n">tvp_reg_init_18</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1152</span><span class="p">,</span>
  	<span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x059</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="mh">0x0397</span><span class="p">,</span> <span class="mh">0x039a</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> 
	<span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span>
	<span class="p">{</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x38</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf2</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="n">tvp_reg_init_19</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1280</span><span class="p">,</span>
	<span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="mh">0x0066</span><span class="p">,</span> <span class="mh">0x0069</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">,</span> <span class="mh">0x03e7</span><span class="p">,</span> <span class="mh">0x03e8</span><span class="p">,</span> <span class="mh">0x03e7</span><span class="p">,</span>
	<span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>
	<span class="p">{</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x38</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xf1</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="n">tvp_reg_init_20</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1280</span><span class="p">,</span>
	<span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="mh">0x0068</span><span class="p">,</span> <span class="mh">0x006a</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0029</span><span class="p">,</span> <span class="mh">0x0429</span><span class="p">,</span> <span class="mh">0x042a</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>
	<span class="p">{</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x38</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xf1</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * PCI driver prototypes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">imsttfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">imsttfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Register access</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">read_reg_le32</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regindex</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef __powerpc__</span>
	<span class="k">return</span> <span class="n">in_le32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">regindex</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">regindex</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_reg_le32</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regindex</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef __powerpc__</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">regindex</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">regindex</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u32</span>
<span class="nf">getclkMHz</span><span class="p">(</span><span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">clk_m</span><span class="p">,</span> <span class="n">clk_n</span><span class="p">,</span> <span class="n">clk_p</span><span class="p">;</span>

	<span class="n">clk_m</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">pclk_m</span><span class="p">;</span>
	<span class="n">clk_n</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">pclk_n</span><span class="p">;</span>
	<span class="n">clk_p</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">pclk_p</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">20</span> <span class="o">*</span> <span class="p">(</span><span class="n">clk_m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">clk_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">clk_p</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">clk_p</span> <span class="o">:</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">setclkMHz</span><span class="p">(</span><span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">MHz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">clk_m</span><span class="p">,</span> <span class="n">clk_n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">spilled</span><span class="p">;</span>

	<span class="n">clk_m</span> <span class="o">=</span> <span class="n">clk_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stage</span> <span class="o">=</span> <span class="n">spilled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">stage</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">clk_m</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">clk_n</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">x</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="p">(</span><span class="n">clk_m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">clk_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">MHz</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">MHz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spilled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">stage</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spilled</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">MHz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">pclk_m</span> <span class="o">=</span> <span class="n">clk_m</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">pclk_n</span> <span class="o">=</span> <span class="n">clk_n</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">pclk_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="o">*</span>
<span class="nf">compute_imstt_regvals_ibm</span><span class="p">(</span><span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">yres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="o">*</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">MHz</span><span class="p">,</span> <span class="n">hes</span><span class="p">,</span> <span class="n">heb</span><span class="p">,</span> <span class="n">veb</span><span class="p">,</span> <span class="n">htp</span><span class="p">,</span> <span class="n">vtp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">xres</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">640</span>:
			<span class="n">hes</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">;</span> <span class="n">heb</span> <span class="o">=</span> <span class="mh">0x0012</span><span class="p">;</span> <span class="n">veb</span> <span class="o">=</span> <span class="mh">0x002a</span><span class="p">;</span> <span class="n">htp</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">vtp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">MHz</span> <span class="o">=</span> <span class="mi">30</span> <span class="cm">/* .25 */</span> <span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">832</span>:
			<span class="n">hes</span> <span class="o">=</span> <span class="mh">0x0005</span><span class="p">;</span> <span class="n">heb</span> <span class="o">=</span> <span class="mh">0x0020</span><span class="p">;</span> <span class="n">veb</span> <span class="o">=</span> <span class="mh">0x0028</span><span class="p">;</span> <span class="n">htp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">vtp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">MHz</span> <span class="o">=</span> <span class="mi">57</span> <span class="cm">/* .27_ */</span> <span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1024</span>:
			<span class="n">hes</span> <span class="o">=</span> <span class="mh">0x000a</span><span class="p">;</span> <span class="n">heb</span> <span class="o">=</span> <span class="mh">0x001c</span><span class="p">;</span> <span class="n">veb</span> <span class="o">=</span> <span class="mh">0x0020</span><span class="p">;</span> <span class="n">htp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">vtp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">MHz</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1152</span>:
			<span class="n">hes</span> <span class="o">=</span> <span class="mh">0x0012</span><span class="p">;</span> <span class="n">heb</span> <span class="o">=</span> <span class="mh">0x0022</span><span class="p">;</span> <span class="n">veb</span> <span class="o">=</span> <span class="mh">0x0031</span><span class="p">;</span> <span class="n">htp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">vtp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">MHz</span> <span class="o">=</span> <span class="mi">101</span> <span class="cm">/* .6_ */</span> <span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1280</span>:
			<span class="n">hes</span> <span class="o">=</span> <span class="mh">0x0012</span><span class="p">;</span> <span class="n">heb</span> <span class="o">=</span> <span class="mh">0x002f</span><span class="p">;</span> <span class="n">veb</span> <span class="o">=</span> <span class="mh">0x0029</span><span class="p">;</span> <span class="n">htp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">vtp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">MHz</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">==</span> <span class="mi">960</span> <span class="o">?</span> <span class="mi">126</span> <span class="o">:</span> <span class="mi">135</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1600</span>:
			<span class="n">hes</span> <span class="o">=</span> <span class="mh">0x0018</span><span class="p">;</span> <span class="n">heb</span> <span class="o">=</span> <span class="mh">0x0040</span><span class="p">;</span> <span class="n">veb</span> <span class="o">=</span> <span class="mh">0x002a</span><span class="p">;</span> <span class="n">htp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">vtp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">MHz</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setclkMHz</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MHz</span><span class="p">);</span>

	<span class="n">init</span><span class="o">-&gt;</span><span class="n">hes</span> <span class="o">=</span> <span class="n">hes</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">heb</span> <span class="o">=</span> <span class="n">heb</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">hsb</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">heb</span> <span class="o">+</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">ht</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">hsb</span> <span class="o">+</span> <span class="n">htp</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">ves</span> <span class="o">=</span> <span class="mh">0x0003</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">veb</span> <span class="o">=</span> <span class="n">veb</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">vsb</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">veb</span> <span class="o">+</span> <span class="n">yres</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">vt</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">vsb</span> <span class="o">+</span> <span class="n">vtp</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">vil</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">vsb</span><span class="p">;</span>

	<span class="n">init</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">init</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="o">*</span>
<span class="nf">compute_imstt_regvals_tvp</span><span class="p">(</span><span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">yres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="o">*</span><span class="n">init</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">xres</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">512</span>:
			<span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp_reg_init_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">640</span>:
			<span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp_reg_init_6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">800</span>:
			<span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp_reg_init_12</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">832</span>:
			<span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp_reg_init_13</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1024</span>:
			<span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp_reg_init_17</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1152</span>:
			<span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp_reg_init_18</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1280</span>:
			<span class="n">init</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">==</span> <span class="mi">960</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">tvp_reg_init_19</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">tvp_reg_init_20</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="o">*</span><span class="n">init</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">init</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="o">*</span>
<span class="nf">compute_imstt_regvals</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">xres</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">yres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">IBM</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">compute_imstt_regvals_ibm</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">compute_imstt_regvals_tvp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_imstt_regvals_ibm</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="o">*</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">pformat</span> <span class="o">=</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXHI</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">PIXM0</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">pclk_m</span><span class="p">;</span><span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">PIXN0</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">pclk_n</span><span class="p">;</span><span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">PIXP0</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">pclk_p</span><span class="p">;</span><span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">PIXC0</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">PIXFMT</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_imstt_regvals_tvp</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="o">*</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">tcc</span><span class="p">,</span> <span class="n">mxc</span><span class="p">,</span> <span class="n">lckl_n</span><span class="p">,</span> <span class="n">mic</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">mlc</span><span class="p">,</span> <span class="n">lckl_p</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">tcc</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">mxc</span> <span class="o">=</span> <span class="mh">0x4d</span><span class="p">;</span>
			<span class="n">lckl_n</span> <span class="o">=</span> <span class="mh">0xc1</span><span class="p">;</span>
			<span class="n">mlc</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">mlc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">lckl_p</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">lckl_p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">tcc</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
			<span class="n">mxc</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
			<span class="n">lckl_n</span> <span class="o">=</span> <span class="mh">0xe1</span><span class="p">;</span>
			<span class="n">mlc</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">mlc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">lckl_p</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">lckl_p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>:
			<span class="n">tcc</span> <span class="o">=</span> <span class="mh">0x5e</span><span class="p">;</span>
			<span class="n">mxc</span> <span class="o">=</span> <span class="mh">0x5d</span><span class="p">;</span>
			<span class="n">lckl_n</span> <span class="o">=</span> <span class="mh">0xf1</span><span class="p">;</span>
			<span class="n">mlc</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">mlc</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">lckl_p</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">lckl_p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">tcc</span> <span class="o">=</span> <span class="mh">0x46</span><span class="p">;</span>
			<span class="n">mxc</span> <span class="o">=</span> <span class="mh">0x5d</span><span class="p">;</span>
			<span class="n">lckl_n</span> <span class="o">=</span> <span class="mh">0xf1</span><span class="p">;</span>
			<span class="n">mlc</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">mlc</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">lckl_p</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">lckl_p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mic</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRPLA</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRPPD</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">pclk_m</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRPPD</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">pclk_n</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRPPD</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">pclk_p</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRTCC</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcc</span><span class="p">;</span>			<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRMXC</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxc</span><span class="p">;</span>			<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRMIC</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">mic</span><span class="p">;</span>			<span class="n">eieio</span><span class="p">();</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRPLA</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRLPD</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">lckl_n</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRPLA</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRMLC</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlc</span><span class="p">;</span>			<span class="n">eieio</span><span class="p">();</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRPLA</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2a</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRLPD</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">lckl_p</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_imstt_regvals</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imstt_regvals</span> <span class="o">*</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">ctl</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">byteswap</span><span class="p">,</span> <span class="n">scr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">IBM</span><span class="p">)</span>
		<span class="n">set_imstt_regvals_ibm</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_imstt_regvals_tvp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * From what I (jsk) can gather poking around with MacsBug,</span>
<span class="cm">   * bits 8 and 9 in the SCR register control endianness</span>
<span class="cm">   * correction (byte swapping).  These bits must be set according</span>
<span class="cm">   * to the color depth as follows:</span>
<span class="cm">   *     Color depth    Bit 9   Bit 8</span>
<span class="cm">   *     ==========     =====   =====</span>
<span class="cm">   *        8bpp          0       0</span>
<span class="cm">   *       16bpp          0       1</span>
<span class="cm">   *       32bpp          1       1</span>
<span class="cm">   */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">ctl</span> <span class="o">=</span> <span class="mh">0x17b1</span><span class="p">;</span>
			<span class="n">pitch</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">byteswap</span> <span class="o">=</span> <span class="mh">0x000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">ctl</span> <span class="o">=</span> <span class="mh">0x17b3</span><span class="p">;</span>
			<span class="n">pitch</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">byteswap</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>:
			<span class="n">ctl</span> <span class="o">=</span> <span class="mh">0x17b9</span><span class="p">;</span>
			<span class="n">pitch</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">-</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">byteswap</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">ctl</span> <span class="o">=</span> <span class="mh">0x17b5</span><span class="p">;</span>
			<span class="n">pitch</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="p">;</span>
			<span class="n">byteswap</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">TVP</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">-=</span> <span class="mh">0x30</span><span class="p">;</span>

	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">HES</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">hes</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">HEB</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">heb</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">HSB</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">hsb</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">HT</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">VES</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">ves</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">VEB</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">veb</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">VSB</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">vsb</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">vt</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">VIL</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">vil</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">HCIV</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">VCIV</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">TCDR</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">RRCIV</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">RRSC</span><span class="p">,</span> <span class="mh">0x980</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">RRCR</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">IBM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">HRIR</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">CMR</span><span class="p">,</span> <span class="mh">0x00ff</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SRGCTL</span><span class="p">,</span> <span class="mh">0x0073</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">HRIR</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">CMR</span><span class="p">,</span> <span class="mh">0x01ff</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SRGCTL</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x200000</span>:
			<span class="n">scr</span> <span class="o">=</span> <span class="mh">0x059d</span> <span class="o">|</span> <span class="n">byteswap</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* case 0x400000:</span>
<span class="cm">		   case 0x800000: */</span>
		<span class="nl">default:</span>
			<span class="n">pitch</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">scr</span> <span class="o">=</span> <span class="mh">0x150dd</span> <span class="o">|</span> <span class="n">byteswap</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SCR</span><span class="p">,</span> <span class="n">scr</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SPR</span><span class="p">,</span> <span class="n">pitch</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">STGCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">set_offset</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">off</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>
		    <span class="o">+</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSR</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">set_555</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">IBM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXHI</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">BPP16</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRTCC</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">set_565</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">IBM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXHI</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">BPP16</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">TVPIRTCC</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x45</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">imsttfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">16</span>
	    <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">24</span> <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span>
	    <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:	<span class="cm">/* RGB 555 or 565 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>:	<span class="cm">/* RGB 888 */</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:	<span class="cm">/* RGBA 8888 */</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">vram</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">-</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="p">((</span><span class="n">vram</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">imsttfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compute_imstt_regvals</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">set_565</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_555</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">set_imstt_regvals</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="n">getclkMHz</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">imsttfb_setcolreg</span> <span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
		   <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* PADDRW/PDATA are the same as TVPPADDRW/TVPPDATA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>	<span class="cm">/* screws up X */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">regno</span><span class="p">;</span>
	<span class="n">eieio</span><span class="p">();</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">red</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">green</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">blue</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">16</span>:
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span>
					<span class="mi">5</span> <span class="o">?</span> <span class="mi">10</span> <span class="o">:</span> <span class="mi">11</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">24</span>:
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">32</span>: <span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span><span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">imsttfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span>
	    <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="n">set_offset</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">imsttfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">STGCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00000380</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">IBM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXHI</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">MISCTL2</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">MISCTL1</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYNCCTL</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWRMNGMT</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">CLKCTL</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00000020</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00000010</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">IBM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="mh">0x000017b0</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXHI</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">CLKCTL</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWRMNGMT</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYNCCTL</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">MISCTL1</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">MISCTL2</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x45</span><span class="p">;</span>	<span class="n">eieio</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="mh">0x00001780</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">STGCTL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">imsttfb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span> 
	<span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">Bpp</span><span class="p">,</span> <span class="n">line_pitch</span><span class="p">,</span> <span class="n">bgc</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>

	<span class="n">bgc</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>
	<span class="n">bgc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bgc</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">bgc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bgc</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">Bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">line_pitch</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>

	<span class="n">dy</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">line_pitch</span><span class="p">;</span>
	<span class="n">dx</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">*</span> <span class="n">Bpp</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">height</span><span class="o">--</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">Bpp</span><span class="p">;</span>
	<span class="n">width</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">==</span> <span class="n">ROP_COPY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span><span class="p">(</span><span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">DSA</span><span class="p">,</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">dx</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">CNT</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">width</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">DP_OCTL</span><span class="p">,</span> <span class="n">line_pitch</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">BI</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">MBC</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">CLR</span><span class="p">,</span> <span class="n">bgc</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">BLTCTL</span><span class="p">,</span> <span class="mh">0x840</span><span class="p">);</span> <span class="cm">/* 0x200000 */</span>
		<span class="k">while</span><span class="p">(</span><span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span><span class="p">(</span><span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">DSA</span><span class="p">,</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">dx</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">S1SA</span><span class="p">,</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">dx</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">CNT</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">width</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">DP_OCTL</span><span class="p">,</span> <span class="n">line_pitch</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SP</span><span class="p">,</span> <span class="n">line_pitch</span><span class="p">);</span>
		<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">BLTCTL</span><span class="p">,</span> <span class="mh">0x40005</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">imsttfb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">Bpp</span><span class="p">,</span> <span class="n">line_pitch</span><span class="p">,</span> <span class="n">fb_offset_old</span><span class="p">,</span> <span class="n">fb_offset_new</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">dp_octl</span><span class="p">;</span>
 	<span class="n">__u32</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">bltctl</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">;</span>

	<span class="n">Bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span>

	<span class="n">sx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">*</span> <span class="n">Bpp</span><span class="p">;</span>
	<span class="n">sy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">;</span>
	<span class="n">dx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">*</span> <span class="n">Bpp</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">height</span><span class="o">--</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">Bpp</span><span class="p">;</span>
	<span class="n">width</span><span class="o">--</span><span class="p">;</span>

	<span class="n">line_pitch</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="n">bltctl</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">line_pitch</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sy</span> <span class="o">&lt;</span> <span class="n">dy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sy</span> <span class="o">+=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">dy</span> <span class="o">+=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">sp</span> <span class="o">|=</span> <span class="o">-</span><span class="p">(</span><span class="n">line_pitch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">dp_octl</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">line_pitch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">|=</span> <span class="n">line_pitch</span><span class="p">;</span>
		<span class="n">dp_octl</span> <span class="o">=</span> <span class="n">line_pitch</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sx</span> <span class="o">&lt;</span> <span class="n">dx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sx</span> <span class="o">+=</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">dx</span> <span class="o">+=</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">bltctl</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">|=</span> <span class="o">-</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">|=</span> <span class="n">width</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fb_offset_old</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">line_pitch</span> <span class="o">+</span> <span class="n">sx</span><span class="p">;</span>
	<span class="n">fb_offset_new</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">line_pitch</span> <span class="o">+</span> <span class="n">dx</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">S1SA</span><span class="p">,</span> <span class="n">fb_offset_old</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SP</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">DSA</span><span class="p">,</span> <span class="n">fb_offset_new</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">CNT</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">DP_OCTL</span><span class="p">,</span> <span class="n">dp_octl</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">BLTCTL</span><span class="p">,</span> <span class="n">bltctl</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int</span>
<span class="c">imsttfb_load_cursor_image(struct imstt_par *par, int width, int height, __u8 fgc)</span>
<span class="c">{</span>
<span class="c">	u_int x, y;</span>

<span class="c">	if (width &gt; 32 || height &gt; 32)</span>
<span class="c">		return -EINVAL;</span>

<span class="c">	if (par-&gt;ramdac == IBM) {</span>
<span class="c">		par-&gt;cmap_regs[PIDXHI] = 1;	eieio();</span>
<span class="c">		for (x = 0; x &lt; 0x100; x++) {</span>
<span class="c">			par-&gt;cmap_regs[PIDXLO] = x;		eieio();</span>
<span class="c">			par-&gt;cmap_regs[PIDXDATA] = 0x00;	eieio();</span>
<span class="c">		}</span>
<span class="c">		par-&gt;cmap_regs[PIDXHI] = 1;	eieio();</span>
<span class="c">		for (y = 0; y &lt; height; y++)</span>
<span class="c">			for (x = 0; x &lt; width &gt;&gt; 2; x++) {</span>
<span class="c">				par-&gt;cmap_regs[PIDXLO] = x + y * 8;	eieio();</span>
<span class="c">				par-&gt;cmap_regs[PIDXDATA] = 0xff;	eieio();</span>
<span class="c">			}</span>
<span class="c">		par-&gt;cmap_regs[PIDXHI] = 0;		eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXLO] = CURS1R;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXDATA] = fgc;		eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXLO] = CURS1G;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXDATA] = fgc;		eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXLO] = CURS1B;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXDATA] = fgc;		eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXLO] = CURS2R;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXDATA] = fgc;		eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXLO] = CURS2G;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXDATA] = fgc;		eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXLO] = CURS2B;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXDATA] = fgc;		eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXLO] = CURS3R;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXDATA] = fgc;		eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXLO] = CURS3G;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXDATA] = fgc;		eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXLO] = CURS3B;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[PIDXDATA] = fgc;		eieio();</span>
<span class="c">	} else {</span>
<span class="c">		par-&gt;cmap_regs[TVPADDRW] = TVPIRICC;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[TVPIDATA] &amp;= 0x03;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[TVPADDRW] = 0;		eieio();</span>
<span class="c">		for (x = 0; x &lt; 0x200; x++) {</span>
<span class="c">			par-&gt;cmap_regs[TVPCRDAT] = 0x00;	eieio();</span>
<span class="c">		}</span>
<span class="c">		for (x = 0; x &lt; 0x200; x++) {</span>
<span class="c">			par-&gt;cmap_regs[TVPCRDAT] = 0xff;	eieio();</span>
<span class="c">		}</span>
<span class="c">		par-&gt;cmap_regs[TVPADDRW] = TVPIRICC;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[TVPIDATA] &amp;= 0x03;	eieio();</span>
<span class="c">		for (y = 0; y &lt; height; y++)</span>
<span class="c">			for (x = 0; x &lt; width &gt;&gt; 3; x++) {</span>
<span class="c">				par-&gt;cmap_regs[TVPADDRW] = x + y * 8;	eieio();</span>
<span class="c">				par-&gt;cmap_regs[TVPCRDAT] = 0xff;		eieio();</span>
<span class="c">			}</span>
<span class="c">		par-&gt;cmap_regs[TVPADDRW] = TVPIRICC;	eieio();</span>
<span class="c">		par-&gt;cmap_regs[TVPIDATA] |= 0x08;	eieio();</span>
<span class="c">		for (y = 0; y &lt; height; y++)</span>
<span class="c">			for (x = 0; x &lt; width &gt;&gt; 3; x++) {</span>
<span class="c">				par-&gt;cmap_regs[TVPADDRW] = x + y * 8;	eieio();</span>
<span class="c">				par-&gt;cmap_regs[TVPCRDAT] = 0xff;		eieio();</span>
<span class="c">			}</span>
<span class="c">		par-&gt;cmap_regs[TVPCADRW] = 0x00;	eieio();</span>
<span class="c">		for (x = 0; x &lt; 12; x++) {</span>
<span class="c">			par-&gt;cmap_regs[TVPCDATA] = fgc;</span>
<span class="c">			eieio();</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">	return 1;</span>
<span class="c">}</span>

<span class="c">static void</span>
<span class="c">imstt_set_cursor(struct imstt_par *par, struct fb_image *d, int on)</span>
<span class="c">{</span>
<span class="c">	if (par-&gt;ramdac == IBM) {</span>
<span class="c">		par-&gt;cmap_regs[PIDXHI] = 0;	eieio();</span>
<span class="c">		if (!on) {</span>
<span class="c">			par-&gt;cmap_regs[PIDXLO] = CURSCTL;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[PIDXDATA] = 0x00;	eieio();</span>
<span class="c">		} else {</span>
<span class="c">			par-&gt;cmap_regs[PIDXLO] = CURSXHI;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[PIDXDATA] = d-&gt;dx &gt;&gt; 8;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[PIDXLO] = CURSXLO;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[PIDXDATA] = d-&gt;dx &amp; 0xff;eieio();</span>
<span class="c">			par-&gt;cmap_regs[PIDXLO] = CURSYHI;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[PIDXDATA] = d-&gt;dy &gt;&gt; 8;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[PIDXLO] = CURSYLO;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[PIDXDATA] = d-&gt;dy &amp; 0xff;eieio();</span>
<span class="c">			par-&gt;cmap_regs[PIDXLO] = CURSCTL;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[PIDXDATA] = 0x02;	eieio();</span>
<span class="c">		}</span>
<span class="c">	} else {</span>
<span class="c">		if (!on) {</span>
<span class="c">			par-&gt;cmap_regs[TVPADDRW] = TVPIRICC;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[TVPIDATA] = 0x00;	eieio();</span>
<span class="c">		} else {</span>
<span class="c">			__u16 x = d-&gt;dx + 0x40, y = d-&gt;dy + 0x40;</span>

<span class="c">			par-&gt;cmap_regs[TVPCXPOH] = x &gt;&gt; 8;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[TVPCXPOL] = x &amp; 0xff;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[TVPCYPOH] = y &gt;&gt; 8;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[TVPCYPOL] = y &amp; 0xff;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[TVPADDRW] = TVPIRICC;	eieio();</span>
<span class="c">			par-&gt;cmap_regs[TVPIDATA] = 0x02;	eieio();</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">}</span>

<span class="c">static int </span>
<span class="c">imsttfb_cursor(struct fb_info *info, struct fb_cursor *cursor)</span>
<span class="c">{</span>
<span class="c">	struct imstt_par *par = info-&gt;par;</span>
<span class="c">        u32 flags = cursor-&gt;set, fg, bg, xx, yy;</span>

<span class="c">	if (cursor-&gt;dest == NULL &amp;&amp; cursor-&gt;rop == ROP_XOR)</span>
<span class="c">		return 1;</span>
<span class="c">	</span>
<span class="c">	imstt_set_cursor(info, cursor, 0);</span>

<span class="c">	if (flags &amp; FB_CUR_SETPOS) {</span>
<span class="c">		xx = cursor-&gt;image.dx - info-&gt;var.xoffset;</span>
<span class="c">		yy = cursor-&gt;image.dy - info-&gt;var.yoffset;</span>
<span class="c">	}</span>

<span class="c">	if (flags &amp; FB_CUR_SETSIZE) {</span>
<span class="c">        }</span>

<span class="c">        if (flags &amp; (FB_CUR_SETSHAPE | FB_CUR_SETCMAP)) {</span>
<span class="c">                int fg_idx = cursor-&gt;image.fg_color;</span>
<span class="c">                int width = (cursor-&gt;image.width+7)/8;</span>
<span class="c">                u8 *dat = (u8 *) cursor-&gt;image.data;</span>
<span class="c">                u8 *dst = (u8 *) cursor-&gt;dest;</span>
<span class="c">                u8 *msk = (u8 *) cursor-&gt;mask;</span>

<span class="c">                switch (cursor-&gt;rop) {</span>
<span class="c">                case ROP_XOR:</span>
<span class="c">                        for (i = 0; i &lt; cursor-&gt;image.height; i++) {</span>
<span class="c">                                for (j = 0; j &lt; width; j++) {</span>
<span class="c">                                        d_idx = i * MAX_CURS/8  + j;</span>
<span class="c">                                        data[d_idx] =  byte_rev[dat[s_idx] ^</span>
<span class="c">                                                                dst[s_idx]];</span>
<span class="c">                                        mask[d_idx] = byte_rev[msk[s_idx]];</span>
<span class="c">                                        s_idx++;</span>
<span class="c">                                }</span>
<span class="c">                        }</span>
<span class="c">                        break;</span>
<span class="c">                case ROP_COPY:</span>
<span class="c">                default:</span>
<span class="c">                        for (i = 0; i &lt; cursor-&gt;image.height; i++) {</span>
<span class="c">                                for (j = 0; j &lt; width; j++) {</span>
<span class="c">                                        d_idx = i * MAX_CURS/8 + j;</span>
<span class="c">                                        data[d_idx] = byte_rev[dat[s_idx]];</span>
<span class="c">                                        mask[d_idx] = byte_rev[msk[s_idx]];</span>
<span class="c">                                        s_idx++;</span>
<span class="c">                                }</span>
<span class="c">			}</span>
<span class="c">			break;</span>
<span class="c">		}</span>

<span class="c">		fg = ((info-&gt;cmap.red[fg_idx] &amp; 0xf8) &lt;&lt; 7) |</span>
<span class="c">                     ((info-&gt;cmap.green[fg_idx] &amp; 0xf8) &lt;&lt; 2) |</span>
<span class="c">                     ((info-&gt;cmap.blue[fg_idx] &amp; 0xf8) &gt;&gt; 3) | 1 &lt;&lt; 15;</span>

<span class="c">		imsttfb_load_cursor_image(par, xx, yy, fgc);</span>
<span class="c">	}</span>
<span class="c">	if (cursor-&gt;enable)</span>
<span class="c">		imstt_set_cursor(info, cursor, 1);</span>
<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cp">#define FBIMSTT_SETREG		0x545401</span>
<span class="cp">#define FBIMSTT_GETREG		0x545402</span>
<span class="cp">#define FBIMSTT_SETCMAPREG	0x545403</span>
<span class="cp">#define FBIMSTT_GETCMAPREG	0x545404</span>
<span class="cp">#define FBIMSTT_SETIDXREG	0x545405</span>
<span class="cp">#define FBIMSTT_GETIDXREG	0x545406</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">imsttfb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">reg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">idx</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FBIMSTT_SETREG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mh">0x1000</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBIMSTT_GETREG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mh">0x1000</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBIMSTT_SETCMAPREG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mh">0x1000</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">write_reg_le32</span><span class="p">(((</span><span class="n">u_int</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">),</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBIMSTT_GETCMAPREG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mh">0x1000</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_reg_le32</span><span class="p">(((</span><span class="n">u_int</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">),</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBIMSTT_SETIDXREG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXHI</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBIMSTT_GETIDXREG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXHI</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="n">eieio</span><span class="p">();</span>
			<span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">imsttfb_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IMS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IMS_TT128</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IBM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IMS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IMS_TT3D</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TVP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">imsttfb_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">imsttfb_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;imsttfb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">imsttfb_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">imsttfb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">__devexit_p</span><span class="p">(</span><span class="n">imsttfb_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">imsttfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> 		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">imsttfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span> 	<span class="o">=</span> <span class="n">imsttfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span> 	<span class="o">=</span> <span class="n">imsttfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">imsttfb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span> 	<span class="o">=</span> <span class="n">imsttfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">imsttfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">imsttfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span> 	<span class="o">=</span> <span class="n">imsttfb_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">init_imstt</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">PRC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">IBM</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x400000</span> <span class="o">:</span> <span class="mh">0x200000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x800000</span><span class="p">;</span>

	<span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ip</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ip</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* initialize the card */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">STGCTL</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">STGCTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span>
	<span class="n">write_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* set default values for DAC registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">IBM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PPMASK</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">eieio</span><span class="p">();</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXHI</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">eieio</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ibm_initregs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXLO</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibm_initregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">PIDXDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibm_initregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
			<span class="n">eieio</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tvp_initregs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPADDRW</span><span class="p">]</span> <span class="o">=</span> <span class="n">tvp_initregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">eieio</span><span class="p">();</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">[</span><span class="n">TVPIDATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">tvp_initregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
			<span class="n">eieio</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#if USE_NV_MODES &amp;&amp; defined(CONFIG_PPC32)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">vmode</span> <span class="o">=</span> <span class="n">init_vmode</span><span class="p">,</span> <span class="n">cmode</span> <span class="o">=</span> <span class="n">init_cmode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vmode</span> <span class="o">=</span> <span class="n">nvram_read_byte</span><span class="p">(</span><span class="n">NV_VMODE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vmode</span> <span class="o">&gt;</span> <span class="n">VMODE_MAX</span><span class="p">)</span>
				<span class="n">vmode</span> <span class="o">=</span> <span class="n">VMODE_640_480_67</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmode</span> <span class="o">=</span> <span class="n">nvram_read_byte</span><span class="p">(</span><span class="n">NV_CMODE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmode</span> <span class="o">&lt;</span> <span class="n">CMODE_8</span> <span class="o">||</span> <span class="n">cmode</span> <span class="o">&gt;</span> <span class="n">CMODE_32</span><span class="p">)</span>
				<span class="n">cmode</span> <span class="o">=</span> <span class="n">CMODE_8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_vmode_to_var</span><span class="p">(</span><span class="n">vmode</span><span class="p">,</span> <span class="n">cmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">INIT_XRES</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">INIT_YRES</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">INIT_BPP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">INIT_XRES</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">INIT_YRES</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">INIT_BPP</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span>
	    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">compute_imstt_regvals</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;imsttfb: %ux%ux%u not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;IMS TT (%s)&quot;</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">IBM</span> <span class="o">?</span> <span class="s">&quot;IBM&quot;</span> <span class="o">:</span> <span class="s">&quot;TVP&quot;</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_IMS_TWINTURBO</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>
							<span class="o">:</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>if (par->ramdac == IBM)
    imstt<em>cursor</em>init(info);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">set_565</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_555</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">set_imstt_regvals</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="n">getclkMHz</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imsttfb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span>
                      <span class="n">FBINFO_HWACCEL_COPYAREA</span> <span class="o">|</span>
	              <span class="n">FBINFO_HWACCEL_FILLRECT</span> <span class="o">|</span>
	              <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>

	<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_reg_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">,</span> <span class="n">SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fb%u: %s frame buffer; %uMB vram; chip version %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">imsttfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_OF</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	
	<span class="n">dp</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: OF name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;imsttfb: no OF node for pci device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_OF */</span><span class="cp"></span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">imstt_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;imsttfb: Can&#39;t allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">pci_resource_len</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;imsttfb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;imsttfb: Can&#39;t reserve memory region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_IMS_TT128</span>: <span class="cm">/* IMS,tt128mbA */</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">=</span> <span class="n">IBM</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_OF</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;IMS,tt128mb8&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
				   <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;IMS,tt128mb8A&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">=</span> <span class="n">TVP</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_OF */</span><span class="cp"></span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_IMS_TT3D</span>:  <span class="cm">/* IMS,tt3d */</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">=</span> <span class="n">TVP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;imsttfb: Device 0x%x unknown, &quot;</span>
					 <span class="s">&quot;contact maintainer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ramdac</span> <span class="o">==</span> <span class="n">IBM</span> <span class="o">?</span>
					    <span class="mh">0x400000</span> <span class="o">:</span> <span class="mh">0x800000</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x800000</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x800000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs_phys</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x840000</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x840000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>
	<span class="n">init_imstt</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">imsttfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imstt_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_regs</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dc_regs</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">imsttfb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;font:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">p</span> <span class="o">=</span> <span class="n">this_opt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fontname</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">fontname</span><span class="p">,</span> <span class="n">this_opt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">fontname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;inverse&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">inverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">fb_invert_cmaps</span><span class="p">();</span>
		<span class="p">}</span>
<span class="cp">#if defined(CONFIG_PPC)</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vmode:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">vmode</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">vmode</span> <span class="o">&lt;=</span> <span class="n">VMODE_MAX</span><span class="p">)</span>
				<span class="n">init_vmode</span> <span class="o">=</span> <span class="n">vmode</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;cmode:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">cmode</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmode</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">CMODE_8</span>:
				<span class="k">case</span> <span class="mi">8</span>:
					<span class="n">init_cmode</span> <span class="o">=</span> <span class="n">CMODE_8</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CMODE_16</span>:
				<span class="k">case</span> <span class="mi">15</span>:
				<span class="k">case</span> <span class="mi">16</span>:
					<span class="n">init_cmode</span> <span class="o">=</span> <span class="n">CMODE_16</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CMODE_32</span>:
				<span class="k">case</span> <span class="mi">24</span>:
				<span class="k">case</span> <span class="mi">32</span>:
					<span class="n">init_cmode</span> <span class="o">=</span> <span class="n">CMODE_32</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">imsttfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;imsttfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">imsttfb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imsttfb_pci_driver</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">imsttfb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imsttfb_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">imsttfb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">imsttfb_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
