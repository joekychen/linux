<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › cirrusfb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cirrusfb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/video/cirrusfb.c - driver for Cirrus Logic chipsets</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1999-2001 Jeff Garzik &lt;jgarzik@pobox.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Contributors (thanks, all!)</span>
<span class="cm"> *</span>
<span class="cm"> *	David Eger:</span>
<span class="cm"> *	Overhaul for Linux 2.6</span>
<span class="cm"> *</span>
<span class="cm"> *      Jeff Rugen:</span>
<span class="cm"> *      Major contributions;  Motorola PowerStack (PPC and PCI) support,</span>
<span class="cm"> *      GD54xx, 1280x1024 mode support, change MCLK based on VCLK.</span>
<span class="cm"> *</span>
<span class="cm"> *	Geert Uytterhoeven:</span>
<span class="cm"> *	Excellent code review.</span>
<span class="cm"> *</span>
<span class="cm"> *	Lars Hecking:</span>
<span class="cm"> *	Amiga updates and testing.</span>
<span class="cm"> *</span>
<span class="cm"> * Original cirrusfb author:  Frank Neumann</span>
<span class="cm"> *</span>
<span class="cm"> * Based on retz3fb.c and cirrusfb.c:</span>
<span class="cm"> *      Copyright (C) 1997 Jes Sorensen</span>
<span class="cm"> *      Copyright (C) 1996 Frank Neumann</span>
<span class="cm"> *</span>
<span class="cm"> ***************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Format this code with GNU indent &#39;-kr -i8 -pcs&#39; options.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>

<span class="cp">#ifdef CONFIG_ZORRO</span>
<span class="cp">#include &lt;linux/zorro.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_AMIGA</span>
<span class="cp">#include &lt;asm/amigahw.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PPC_PREP</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#define isPReP machine_is(prep)</span>
<span class="cp">#else</span>
<span class="cp">#define isPReP 0</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;video/vga.h&gt;</span>
<span class="cp">#include &lt;video/cirrus.h&gt;</span>

<span class="cm">/*****************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * debugging and utility macros</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* disable runtime assertions? */</span>
<span class="cm">/* #define CIRRUSFB_NDEBUG */</span>

<span class="cm">/* debugging assertions */</span>
<span class="cp">#ifndef CIRRUSFB_NDEBUG</span>
<span class="cp">#define assert(expr) \</span>
<span class="cp">	if (!(expr)) { \</span>
<span class="cp">		printk(&quot;Assertion failed! %s,%s,%s,line=%d\n&quot;, \</span>
<span class="cp">		#expr, __FILE__, __func__, __LINE__); \</span>
<span class="cp">	}</span>
<span class="cp">#else</span>
<span class="cp">#define assert(expr)</span>
<span class="cp">#endif</span>

<span class="cp">#define MB_ (1024 * 1024)</span>

<span class="cm">/*****************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * chipset information</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* board types */</span>
<span class="k">enum</span> <span class="n">cirrus_board</span> <span class="p">{</span>
	<span class="n">BT_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">BT_SD64</span><span class="p">,</span>	<span class="cm">/* GD5434 */</span>
	<span class="n">BT_PICCOLO</span><span class="p">,</span>	<span class="cm">/* GD5426 */</span>
	<span class="n">BT_PICASSO</span><span class="p">,</span>	<span class="cm">/* GD5426 or GD5428 */</span>
	<span class="n">BT_SPECTRUM</span><span class="p">,</span>	<span class="cm">/* GD5426 or GD5428 */</span>
	<span class="n">BT_PICASSO4</span><span class="p">,</span>	<span class="cm">/* GD5446 */</span>
	<span class="n">BT_ALPINE</span><span class="p">,</span>	<span class="cm">/* GD543x/4x */</span>
	<span class="n">BT_GD5480</span><span class="p">,</span>
	<span class="n">BT_LAGUNA</span><span class="p">,</span>	<span class="cm">/* GD5462/64 */</span>
	<span class="n">BT_LAGUNAB</span><span class="p">,</span>	<span class="cm">/* GD5465 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * per-board-type information, used for enumerating and abstracting</span>
<span class="cm"> * chip-specific information</span>
<span class="cm"> * NOTE: MUST be in the same order as enum cirrus_board in order to</span>
<span class="cm"> * use direct indexing on this array</span>
<span class="cm"> * NOTE: &#39;__initdata&#39; cannot be used as some of this info</span>
<span class="cm"> * is required at runtime.  Maybe separate into an init-only and</span>
<span class="cm"> * a run-time table?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_board_info_rec</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>		<span class="cm">/* ASCII name of chipset */</span>
	<span class="kt">long</span> <span class="n">maxclock</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>		<span class="cm">/* maximum video clock */</span>
	<span class="cm">/* for  1/4bpp, 8bpp 15/16bpp, 24bpp, 32bpp - numbers from xorg code */</span>
	<span class="n">bool</span> <span class="n">init_sr07</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* init SR07 during init_vgachip() */</span>
	<span class="n">bool</span> <span class="n">init_sr1f</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* write SR1F during init_vgachip() */</span>
	<span class="cm">/* construct bit 19 of screen start address */</span>
	<span class="n">bool</span> <span class="n">scrn_start_bit19</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* initial SR07 value, then for each mode */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sr07</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sr07_1bpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sr07_1bpp_mux</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sr07_8bpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sr07_8bpp_mux</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sr1f</span><span class="p">;</span>	<span class="cm">/* SR1F VGA initial register value */</span>
<span class="p">}</span> <span class="n">cirrusfb_board_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">BT_SD64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;CL SD64&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxclock</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* guess */</span>
			<span class="cm">/* the SD64/P4 have a higher max. videoclock */</span>
			<span class="mi">135100</span><span class="p">,</span> <span class="mi">135100</span><span class="p">,</span> <span class="mi">85500</span><span class="p">,</span> <span class="mi">85500</span><span class="p">,</span> <span class="mi">0</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">init_sr07</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_sr1f</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scrn_start_bit19</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07</span>			<span class="o">=</span> <span class="mh">0xF0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_1bpp</span>		<span class="o">=</span> <span class="mh">0xF0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_1bpp_mux</span>		<span class="o">=</span> <span class="mh">0xF6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_8bpp</span>		<span class="o">=</span> <span class="mh">0xF1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_8bpp_mux</span>		<span class="o">=</span> <span class="mh">0xF7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr1f</span>			<span class="o">=</span> <span class="mh">0x1E</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">BT_PICCOLO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;CL Piccolo&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxclock</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* guess */</span>
			<span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">init_sr07</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_sr1f</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scrn_start_bit19</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07</span>			<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_1bpp</span>		<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_8bpp</span>		<span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr1f</span>			<span class="o">=</span> <span class="mh">0x22</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">BT_PICASSO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;CL Picasso&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxclock</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* guess */</span>
			<span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">init_sr07</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_sr1f</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scrn_start_bit19</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07</span>			<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_1bpp</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_8bpp</span>		<span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr1f</span>			<span class="o">=</span> <span class="mh">0x22</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">BT_SPECTRUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;CL Spectrum&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxclock</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* guess */</span>
			<span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">,</span> <span class="mi">90000</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">init_sr07</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_sr1f</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scrn_start_bit19</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07</span>			<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_1bpp</span>		<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_8bpp</span>		<span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr1f</span>			<span class="o">=</span> <span class="mh">0x22</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">BT_PICASSO4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;CL Picasso4&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxclock</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="mi">135100</span><span class="p">,</span> <span class="mi">135100</span><span class="p">,</span> <span class="mi">85500</span><span class="p">,</span> <span class="mi">85500</span><span class="p">,</span> <span class="mi">0</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">init_sr07</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_sr1f</span>		<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scrn_start_bit19</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07</span>			<span class="o">=</span> <span class="mh">0xA0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_1bpp</span>		<span class="o">=</span> <span class="mh">0xA0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_1bpp_mux</span>		<span class="o">=</span> <span class="mh">0xA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_8bpp</span>		<span class="o">=</span> <span class="mh">0xA1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_8bpp_mux</span>		<span class="o">=</span> <span class="mh">0xA7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr1f</span>			<span class="o">=</span> <span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">BT_ALPINE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;CL Alpine&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxclock</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* for the GD5430.  GD5446 can do more... */</span>
			<span class="mi">85500</span><span class="p">,</span> <span class="mi">85500</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="mi">28500</span><span class="p">,</span> <span class="mi">0</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">init_sr07</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_sr1f</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scrn_start_bit19</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07</span>			<span class="o">=</span> <span class="mh">0xA0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_1bpp</span>		<span class="o">=</span> <span class="mh">0xA0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_1bpp_mux</span>		<span class="o">=</span> <span class="mh">0xA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_8bpp</span>		<span class="o">=</span> <span class="mh">0xA1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_8bpp_mux</span>		<span class="o">=</span> <span class="mh">0xA7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr1f</span>			<span class="o">=</span> <span class="mh">0x1C</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">BT_GD5480</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;CL GD5480&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxclock</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="mi">135100</span><span class="p">,</span> <span class="mi">200000</span><span class="p">,</span> <span class="mi">200000</span><span class="p">,</span> <span class="mi">135100</span><span class="p">,</span> <span class="mi">135100</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">init_sr07</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_sr1f</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scrn_start_bit19</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07</span>			<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_1bpp</span>		<span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr07_8bpp</span>		<span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sr1f</span>			<span class="o">=</span> <span class="mh">0x1C</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">BT_LAGUNA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;CL Laguna&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxclock</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* taken from X11 code */</span>
			<span class="mi">170000</span><span class="p">,</span> <span class="mi">170000</span><span class="p">,</span> <span class="mi">170000</span><span class="p">,</span> <span class="mi">170000</span><span class="p">,</span> <span class="mi">135100</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">init_sr07</span>		<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_sr1f</span>		<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scrn_start_bit19</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">BT_LAGUNAB</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;CL Laguna AGP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxclock</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* taken from X11 code */</span>
			<span class="mi">170000</span><span class="p">,</span> <span class="mi">250000</span><span class="p">,</span> <span class="mi">170000</span><span class="p">,</span> <span class="mi">170000</span><span class="p">,</span> <span class="mi">135100</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">init_sr07</span>		<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_sr1f</span>		<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scrn_start_bit19</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cp">#define CHIP(id, btype) \</span>
<span class="cp">	{ PCI_VENDOR_ID_CIRRUS, id, PCI_ANY_ID, PCI_ANY_ID, 0, 0, (btype) }</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">cirrusfb_pci_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHIP</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_CIRRUS_5436</span><span class="p">,</span> <span class="n">BT_ALPINE</span><span class="p">),</span>
	<span class="n">CHIP</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_CIRRUS_5434_8</span><span class="p">,</span> <span class="n">BT_SD64</span><span class="p">),</span>
	<span class="n">CHIP</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_CIRRUS_5434_4</span><span class="p">,</span> <span class="n">BT_SD64</span><span class="p">),</span>
	<span class="n">CHIP</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_CIRRUS_5430</span><span class="p">,</span> <span class="n">BT_ALPINE</span><span class="p">),</span> <span class="cm">/* GD-5440 is same id */</span>
	<span class="n">CHIP</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_CIRRUS_7543</span><span class="p">,</span> <span class="n">BT_ALPINE</span><span class="p">),</span>
	<span class="n">CHIP</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_CIRRUS_7548</span><span class="p">,</span> <span class="n">BT_ALPINE</span><span class="p">),</span>
	<span class="n">CHIP</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_CIRRUS_5480</span><span class="p">,</span> <span class="n">BT_GD5480</span><span class="p">),</span> <span class="cm">/* MacPicasso likely */</span>
	<span class="n">CHIP</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_CIRRUS_5446</span><span class="p">,</span> <span class="n">BT_PICASSO4</span><span class="p">),</span> <span class="cm">/* Picasso 4 is 5446 */</span>
	<span class="n">CHIP</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_CIRRUS_5462</span><span class="p">,</span> <span class="n">BT_LAGUNA</span><span class="p">),</span> <span class="cm">/* CL Laguna */</span>
	<span class="n">CHIP</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_CIRRUS_5464</span><span class="p">,</span> <span class="n">BT_LAGUNA</span><span class="p">),</span> <span class="cm">/* CL Laguna 3D */</span>
	<span class="n">CHIP</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_CIRRUS_5465</span><span class="p">,</span> <span class="n">BT_LAGUNAB</span><span class="p">),</span> <span class="cm">/* CL Laguna 3DA*/</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">cirrusfb_pci_table</span><span class="p">);</span>
<span class="cp">#undef CHIP</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ZORRO</span>
<span class="k">struct</span> <span class="n">zorrocl</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">cirrus_board</span> <span class="n">type</span><span class="p">;</span>	<span class="cm">/* Board type */</span>
	<span class="n">u32</span> <span class="n">regoffset</span><span class="p">;</span>		<span class="cm">/* Offset of registers in first Zorro device */</span>
	<span class="n">u32</span> <span class="n">ramsize</span><span class="p">;</span>		<span class="cm">/* Size of video RAM in first Zorro device */</span>
				<span class="cm">/* If zero, use autoprobe on RAM device */</span>
	<span class="n">u32</span> <span class="n">ramoffset</span><span class="p">;</span>		<span class="cm">/* Offset of video RAM in first Zorro device */</span>
	<span class="n">zorro_id</span> <span class="n">ramid</span><span class="p">;</span>		<span class="cm">/* Zorro ID of RAM device */</span>
	<span class="n">zorro_id</span> <span class="n">ramid2</span><span class="p">;</span>	<span class="cm">/* Zorro ID of optional second RAM device */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zorrocl</span> <span class="n">zcl_sd64</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">BT_SD64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ramid</span>		<span class="o">=</span> <span class="n">ZORRO_PROD_HELFRICH_SD64_RAM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zorrocl</span> <span class="n">zcl_piccolo</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">BT_PICCOLO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ramid</span>		<span class="o">=</span> <span class="n">ZORRO_PROD_HELFRICH_PICCOLO_RAM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zorrocl</span> <span class="n">zcl_picasso</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">BT_PICASSO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ramid</span>		<span class="o">=</span> <span class="n">ZORRO_PROD_VILLAGE_TRONIC_PICASSO_II_II_PLUS_RAM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zorrocl</span> <span class="n">zcl_spectrum</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">BT_SPECTRUM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ramid</span>		<span class="o">=</span> <span class="n">ZORRO_PROD_GVP_EGS_28_24_SPECTRUM_RAM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zorrocl</span> <span class="n">zcl_picasso4_z3</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">BT_PICASSO4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">regoffset</span>	<span class="o">=</span> <span class="mh">0x00600000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ramsize</span>	<span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">MB_</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ramoffset</span>	<span class="o">=</span> <span class="mh">0x01000000</span><span class="p">,</span>	<span class="cm">/* 0x02000000 for 64 MiB boards */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zorrocl</span> <span class="n">zcl_picasso4_z2</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">BT_PICASSO4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">regoffset</span>	<span class="o">=</span> <span class="mh">0x10000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ramid</span>		<span class="o">=</span> <span class="n">ZORRO_PROD_VILLAGE_TRONIC_PICASSO_IV_Z2_RAM1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ramid2</span>		<span class="o">=</span> <span class="n">ZORRO_PROD_VILLAGE_TRONIC_PICASSO_IV_Z2_RAM2</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zorro_device_id</span> <span class="n">cirrusfb_zorro_table</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">ZORRO_PROD_HELFRICH_SD64_REG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">zcl_sd64</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">ZORRO_PROD_HELFRICH_PICCOLO_REG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">zcl_piccolo</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">ZORRO_PROD_VILLAGE_TRONIC_PICASSO_II_II_PLUS_REG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">zcl_picasso</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">ZORRO_PROD_GVP_EGS_28_24_SPECTRUM_REG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">zcl_spectrum</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">ZORRO_PROD_VILLAGE_TRONIC_PICASSO_IV_Z3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">zcl_picasso4_z3</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">ZORRO_PROD_VILLAGE_TRONIC_PICASSO_IV_Z2_REG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">zcl_picasso4_z2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">zorro</span><span class="p">,</span> <span class="n">cirrusfb_zorro_table</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ZORRO */</span><span class="cp"></span>

<span class="cp">#ifdef CIRRUSFB_DEBUG</span>
<span class="k">enum</span> <span class="n">cirrusfb_dbg_reg_class</span> <span class="p">{</span>
	<span class="n">CRT</span><span class="p">,</span>
	<span class="n">SEQ</span>
<span class="p">};</span>
<span class="cp">#endif		</span><span class="cm">/* CIRRUSFB_DEBUG */</span><span class="cp"></span>

<span class="cm">/* info about board */</span>
<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regbase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">laguna_mmio</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">cirrus_board</span> <span class="n">btype</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SFR</span><span class="p">;</span>	<span class="cm">/* Shadow of special function register */</span>

	<span class="kt">int</span> <span class="n">multiplexing</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">doubleVCLK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blank_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">unmap</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">noaccel</span> <span class="n">__devinitdata</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;640x480@60&quot;</span><span class="p">;</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**** BEGIN PROTOTYPES ******************************************************/</span>

<span class="cm">/*--- Interface used by the world ------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cirrusfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="cm">/*--- Internal routines ----------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_vgachip</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">switch_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">WGen</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RGen</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">AttrOn</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">WHDR</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">WSFR</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">WSFR2</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">WClut</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">regnum</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">blue</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void RClut(struct cirrusfb_info *cinfo, unsigned char regnum,</span>
<span class="c">		  unsigned char *red, unsigned char *green,</span>
<span class="c">		  unsigned char *blue);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cirrusfb_WaitBLT</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regbase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cirrusfb_BitBLT</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regbase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits_per_pixel</span><span class="p">,</span>
			    <span class="n">u_short</span> <span class="n">curx</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">cury</span><span class="p">,</span>
			    <span class="n">u_short</span> <span class="n">destx</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">desty</span><span class="p">,</span>
			    <span class="n">u_short</span> <span class="n">width</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">height</span><span class="p">,</span>
			    <span class="n">u_short</span> <span class="n">line_length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cirrusfb_RectFill</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regbase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits_per_pixel</span><span class="p">,</span>
			      <span class="n">u_short</span> <span class="n">x</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">y</span><span class="p">,</span>
			      <span class="n">u_short</span> <span class="n">width</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">height</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">fg_color</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bg_color</span><span class="p">,</span>
			      <span class="n">u_short</span> <span class="n">line_length</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">blitmode</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bestclock</span><span class="p">(</span><span class="kt">long</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nom</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">den</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">div</span><span class="p">);</span>

<span class="cp">#ifdef CIRRUSFB_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cirrusfb_dbg_reg_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">caddr_t</span> <span class="n">regbase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cirrusfb_dbg_print_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="n">caddr_t</span> <span class="n">regbase</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">cirrusfb_dbg_reg_class</span> <span class="n">reg_class</span><span class="p">,</span> <span class="p">...);</span>
<span class="cp">#endif </span><span class="cm">/* CIRRUSFB_DEBUG */</span><span class="cp"></span>

<span class="cm">/*** END   PROTOTYPES ********************************************************/</span>
<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*** BEGIN Interface Used by the World ***************************************/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_laguna</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_LAGUNA</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_LAGUNAB</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">opencount</span><span class="p">;</span>

<span class="cm">/*--- Open /dev/fbx ---------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrusfb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opencount</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">switch_monitor</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*--- Close /dev/fbx --------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrusfb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">opencount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">switch_monitor</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**** END   Interface used by the World *************************************/</span>
<span class="cm">/****************************************************************************/</span>
<span class="cm">/**** BEGIN Hardware specific Routines **************************************/</span>

<span class="cm">/* Check if the MCLK is not a better clock source */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrusfb_check_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">mclk</span> <span class="o">=</span> <span class="n">vga_rseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR1F</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="cm">/* Read MCLK value */</span>
	<span class="n">mclk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14318</span> <span class="o">*</span> <span class="n">mclk</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Read MCLK of %ld kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mclk</span><span class="p">);</span>

	<span class="cm">/* Determine if we should use MCLK instead of VCLK, and if so, what we</span>
<span class="cm">	 * should divide it by to get VCLK</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="n">mclk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">250</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Using VCLK = MCLK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="p">(</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">250</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Using VCLK = MCLK/2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrusfb_check_pixclock</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">maxclock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">maxclockidx</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* convert from ps to kHz */</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;desired pixclock: %ld kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="n">maxclock</span> <span class="o">=</span> <span class="n">cirrusfb_board_info</span><span class="p">[</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">].</span><span class="n">maxclock</span><span class="p">[</span><span class="n">maxclockidx</span><span class="p">];</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">multiplexing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If the frequency is greater than we can support, we might be able</span>
<span class="cm">	 * to use multiplexing for the video mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">maxclock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="s">&quot;Frequency greater than maxclock (%ld kHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">maxclock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Additional constraint: 8bpp uses DAC clock doubling to allow maximum</span>
<span class="cm">	 * pixel clock</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BT_ALPINE</span>:
		<span class="k">case</span> <span class="n">BT_SD64</span>:
		<span class="k">case</span> <span class="n">BT_PICASSO4</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">85500</span><span class="p">)</span>
				<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">multiplexing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BT_GD5480</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">135100</span><span class="p">)</span>
				<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">multiplexing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If we have a 1MB 5434, we need to put ourselves in a mode where</span>
<span class="cm">	 * the VCLK is double the pixel clock. */</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">doubleVCLK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_SD64</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&lt;=</span> <span class="n">MB_</span> <span class="o">&amp;&amp;</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">doubleVCLK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrusfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">yres</span><span class="p">;</span>
	<span class="cm">/* memory size in pixels */</span>
	<span class="kt">unsigned</span> <span class="n">pixels</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">isPReP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">24</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">isPReP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="s">&quot;Unsupported bpp size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="cm">/* use highest possible virtual resolution */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">pixels</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			 <span class="s">&quot;virtual resolution set to maximum of %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">pixels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;mode %dx%dx%d rejected... &quot;</span>
		      <span class="s">&quot;virtual resolution too high to fit into video memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* truncate xoffset and yoffset to maximum if too high */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
		<span class="n">yres</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">yres</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&gt;=</span> <span class="mi">1280</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;ERROR: VerticalTotal &gt;= 1280; &quot;</span>
			<span class="s">&quot;special treatment required! (TODO)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cirrusfb_check_pixclock</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_set_mclk_as_source</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old1f</span><span class="p">,</span> <span class="n">old1e</span><span class="p">;</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">cinfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">old1f</span> <span class="o">=</span> <span class="n">vga_rseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR1F</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">div</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Set %s as pixclock source.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">div</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;MCLK/2&quot;</span> <span class="o">:</span> <span class="s">&quot;MCLK&quot;</span><span class="p">);</span>
		<span class="n">old1f</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">old1e</span> <span class="o">=</span> <span class="n">vga_rseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR1E</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">old1e</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR1E</span><span class="p">,</span> <span class="n">old1e</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR1F</span><span class="p">,</span> <span class="n">old1f</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*************************************************************************</span>
<span class="cm">	cirrusfb_set_par_foo()</span>

<span class="cm">	actually writes the values for a new video mode into the hardware,</span>
<span class="cm">**************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrusfb_set_par_foo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regbase</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pitch</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_board_info_rec</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdispend</span><span class="p">,</span> <span class="n">hsyncstart</span><span class="p">,</span> <span class="n">hsyncend</span><span class="p">,</span> <span class="n">htotal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yres</span><span class="p">,</span> <span class="n">vdispend</span><span class="p">,</span> <span class="n">vsyncstart</span><span class="p">,</span> <span class="n">vsyncend</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nom</span><span class="p">,</span> <span class="n">den</span><span class="p">,</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Requested mode: %dx%dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_MONO10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">16</span>:
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span>
					<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>

	<span class="n">init_vgachip</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">bi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cirrusfb_board_info</span><span class="p">[</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">];</span>

	<span class="n">hsyncstart</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">hsyncend</span> <span class="o">=</span> <span class="n">hsyncstart</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">htotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsyncend</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">hdispend</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">hsyncstart</span> <span class="o">=</span> <span class="n">hsyncstart</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">hsyncend</span> <span class="o">=</span> <span class="n">hsyncend</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">vdispend</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">vsyncstart</span> <span class="o">=</span> <span class="n">vdispend</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">vsyncend</span> <span class="o">=</span> <span class="n">vsyncstart</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">vtotal</span> <span class="o">=</span> <span class="n">vsyncend</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vdispend</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vsyncstart</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vsyncend</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vtotal</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vdispend</span> <span class="o">=</span> <span class="p">(</span><span class="n">vdispend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vsyncstart</span> <span class="o">=</span> <span class="p">(</span><span class="n">vsyncstart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vsyncend</span> <span class="o">=</span> <span class="p">(</span><span class="n">vsyncend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vtotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">yres</span> <span class="o">=</span> <span class="n">vdispend</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vtotal</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vsyncstart</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vsyncend</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vdispend</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdispend</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vsyncstart</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vsyncend</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vtotal</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">multiplexing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">htotal</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">hsyncstart</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">hsyncend</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">hdispend</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">htotal</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">hdispend</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hsyncstart</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hsyncend</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* unlock register VGA_CRTC_H_TOTAL..CRT7 */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>	<span class="cm">/* previously: 0x00) */</span>

	<span class="cm">/* if debugging is enabled, all parameters get output before writing */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT0: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">htotal</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_H_TOTAL</span><span class="p">,</span> <span class="n">htotal</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT1: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdispend</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_H_DISP</span><span class="p">,</span> <span class="n">hdispend</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT2: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_H_BLANK_START</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/*  + 128: Compatible read */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT3: 128+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">%</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_H_BLANK_END</span><span class="p">,</span>
		 <span class="mi">128</span> <span class="o">+</span> <span class="p">((</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">%</span> <span class="mi">32</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT4: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hsyncstart</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_H_SYNC_START</span><span class="p">,</span> <span class="n">hsyncstart</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">hsyncend</span> <span class="o">%</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT5: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_H_SYNC_END</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT6: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_V_TOTAL</span><span class="p">,</span> <span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>		<span class="cm">/* LineCompare bit #9 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vsyncstart</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vdispend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vsyncstart</span> <span class="o">&amp;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT7: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_OVERFLOW</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>		<span class="cm">/* LineCompare bit #8 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vdispend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT9: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_MAX_SCAN</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT10: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vsyncstart</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_V_SYNC_START</span><span class="p">,</span> <span class="n">vsyncstart</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT11: 64+32+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vsyncend</span> <span class="o">%</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">,</span> <span class="n">vsyncend</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">64</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT12: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_V_DISP_END</span><span class="p">,</span> <span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT15: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">vdispend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_V_BLANK_START</span><span class="p">,</span> <span class="p">(</span><span class="n">vdispend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT16: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_V_BLANK_END</span><span class="p">,</span> <span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT18: 0xff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_LINE_COMPARE</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT1a: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_CRT1A</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_ALPINE</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_SD64</span><span class="p">)</span>
			<span class="n">freq</span> <span class="o">*=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">multiplexing</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">doubleVCLK</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">bestclock</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nom</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">den</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;VCLK freq: %ld kHz  nom: %d  den: %d  div: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">freq</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">den</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>

	<span class="cm">/* set VCLK0 */</span>
	<span class="cm">/* hardware RefClock: 14.31818 MHz */</span>
	<span class="cm">/* formula: VClk = (OSC * N) / (D * (1+P)) */</span>
	<span class="cm">/* Example: VClk = (14.31818 * 91) / (23 * (1+1)) = 28.325 MHz */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_ALPINE</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_PICASSO4</span> <span class="o">||</span>
	    <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_SD64</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if freq is close to mclk or mclk/2 select mclk</span>
<span class="cm">		 * as clock source</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">divMCLK</span> <span class="o">=</span> <span class="n">cirrusfb_check_mclk</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">divMCLK</span><span class="p">)</span>
			<span class="n">nom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cirrusfb_set_mclk_as_source</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">divMCLK</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">pcifc</span> <span class="o">=</span> <span class="n">fb_readl</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">+</span> <span class="mh">0x3fc</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tile</span> <span class="o">=</span> <span class="n">fb_readb</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">+</span> <span class="mh">0x407</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tile_control</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_LAGUNAB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tile_control</span> <span class="o">=</span> <span class="n">fb_readw</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">+</span> <span class="mh">0x2c4</span><span class="p">);</span>
			<span class="n">tile_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
			<span class="n">fb_writew</span><span class="p">(</span><span class="n">tile_control</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">+</span> <span class="mh">0x2c4</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">fb_writel</span><span class="p">(</span><span class="n">pcifc</span> <span class="o">|</span> <span class="mh">0x10000000l</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">+</span> <span class="mh">0x3fc</span><span class="p">);</span>
		<span class="n">fb_writeb</span><span class="p">(</span><span class="n">tile</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">+</span> <span class="mh">0x407</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">=</span> <span class="n">fb_readw</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">+</span> <span class="mh">0x402</span><span class="p">);</span>
		<span class="n">threshold</span> <span class="o">=</span> <span class="n">fb_readw</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">+</span> <span class="mh">0xea</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x6800</span><span class="p">;</span>
		<span class="n">format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">threshold</span> <span class="o">&amp;=</span> <span class="mh">0xffc0</span> <span class="o">&amp;</span> <span class="mh">0x3fbf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">den</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* 6 bit denom; ONLY 5434!!! (bugged me 10 days) */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_SD64</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_ALPINE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_GD5480</span><span class="p">))</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

		<span class="cm">/* Laguna chipset has reversed clock registers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRE</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR1E</span><span class="p">,</span> <span class="n">nom</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRE</span><span class="p">,</span> <span class="n">nom</span><span class="p">);</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR1E</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="cm">/* 1280x1024 */</span>
		<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_MODE</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* mode control: VGA_CRTC_START_HI enable, ROTATE(?), 16bit</span>
<span class="cm">		 * address wrap, no compat. */</span>
		<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_MODE</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">);</span>

	<span class="cm">/* don&#39;t know if it would hurt to also program this if no interlaced */</span>
	<span class="cm">/* mode is used, but I feel better this way.. :-) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_REGS</span><span class="p">,</span> <span class="n">htotal</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_REGS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* interlace control */</span>

	<span class="cm">/* adjust horizontal/vertical sync type (low/high), use VCLK3 */</span>
	<span class="cm">/* enable display memory &amp; CRTC I/O address for color mode */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x03</span> <span class="o">|</span> <span class="mh">0xc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">WGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_MIS_W</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* text cursor on and start line */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_CURSOR_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* text cursor end line */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_CURSOR_END</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>

	<span class="cm">/******************************************************</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1 bpp</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="cm">/* programming for different color depths */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;preparing for 1 bit deep display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* mode register */</span>

		<span class="cm">/* SR07 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BT_SD64</span>:
		<span class="k">case</span> <span class="n">BT_PICCOLO</span>:
		<span class="k">case</span> <span class="n">BT_PICASSO</span>:
		<span class="k">case</span> <span class="n">BT_SPECTRUM</span>:
		<span class="k">case</span> <span class="n">BT_PICASSO4</span>:
		<span class="k">case</span> <span class="n">BT_ALPINE</span>:
		<span class="k">case</span> <span class="n">BT_GD5480</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span>
				 <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">multiplexing</span> <span class="o">?</span>
					<span class="n">bi</span><span class="o">-&gt;</span><span class="n">sr07_1bpp_mux</span> <span class="o">:</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">sr07_1bpp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_LAGUNA</span>:
		<span class="k">case</span> <span class="n">BT_LAGUNAB</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span>
				<span class="n">vga_rseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;unknown Board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Extended Sequencer Mode */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">BT_PICCOLO</span>:
		<span class="k">case</span> <span class="n">BT_SPECTRUM</span>:
			<span class="cm">/* evtl d0 bei 1 bit? avoid FIFO underruns..? */</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_PICASSO</span>:
			<span class="cm">/* ## vorher d0 avoid FIFO underruns..? */</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_SD64</span>:
		<span class="k">case</span> <span class="n">BT_PICASSO4</span>:
		<span class="k">case</span> <span class="n">BT_ALPINE</span>:
		<span class="k">case</span> <span class="n">BT_GD5480</span>:
		<span class="k">case</span> <span class="n">BT_LAGUNA</span>:
		<span class="k">case</span> <span class="n">BT_LAGUNAB</span>:
			<span class="cm">/* do nothing */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;unknown Board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* pixel mask: pass-through for first plane */</span>
		<span class="n">WGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">multiplexing</span><span class="p">)</span>
			<span class="cm">/* hidden dac reg: 1280x1024 */</span>
			<span class="n">WHDR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* hidden dac: nothing */</span>
			<span class="n">WHDR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* memory mode: odd/even, ext. memory */</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_SEQ_MEMORY_MODE</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
		<span class="cm">/* plane mask: only write to first plane */</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_SEQ_PLANE_WRITE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/******************************************************</span>
<span class="cm">	 *</span>
<span class="cm">	 * 8 bpp</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;preparing for 8 bit deep display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BT_SD64</span>:
		<span class="k">case</span> <span class="n">BT_PICCOLO</span>:
		<span class="k">case</span> <span class="n">BT_PICASSO</span>:
		<span class="k">case</span> <span class="n">BT_SPECTRUM</span>:
		<span class="k">case</span> <span class="n">BT_PICASSO4</span>:
		<span class="k">case</span> <span class="n">BT_ALPINE</span>:
		<span class="k">case</span> <span class="n">BT_GD5480</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span>
				  <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">multiplexing</span> <span class="o">?</span>
					<span class="n">bi</span><span class="o">-&gt;</span><span class="n">sr07_8bpp_mux</span> <span class="o">:</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">sr07_8bpp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_LAGUNA</span>:
		<span class="k">case</span> <span class="n">BT_LAGUNAB</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span>
				<span class="n">vga_rseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
			<span class="n">threshold</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;unknown Board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BT_PICCOLO</span>:
		<span class="k">case</span> <span class="n">BT_PICASSO</span>:
		<span class="k">case</span> <span class="n">BT_SPECTRUM</span>:
			<span class="cm">/* Fast Page-Mode writes */</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_PICASSO4</span>:
<span class="cp">#ifdef CONFIG_ZORRO</span>
			<span class="cm">/* ### INCOMPLETE!! */</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">BT_ALPINE</span>:
		<span class="k">case</span> <span class="n">BT_SD64</span>:
		<span class="k">case</span> <span class="n">BT_GD5480</span>:
		<span class="k">case</span> <span class="n">BT_LAGUNA</span>:
		<span class="k">case</span> <span class="n">BT_LAGUNAB</span>:
			<span class="cm">/* do nothing */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;unknown board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* mode register: 256 color mode */</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_MODE</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">multiplexing</span><span class="p">)</span>
			<span class="cm">/* hidden dac reg: 1280x1024 */</span>
			<span class="n">WHDR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* hidden dac: nothing */</span>
			<span class="n">WHDR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/******************************************************</span>
<span class="cm">	 *</span>
<span class="cm">	 * 16 bpp</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;preparing for 16 bit deep display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BT_PICCOLO</span>:
		<span class="k">case</span> <span class="n">BT_SPECTRUM</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">);</span>
			<span class="cm">/* Fast Page-Mode writes */</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_PICASSO</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">);</span>
			<span class="cm">/* Fast Page-Mode writes */</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_SD64</span>:
		<span class="k">case</span> <span class="n">BT_PICASSO4</span>:
		<span class="k">case</span> <span class="n">BT_ALPINE</span>:
			<span class="cm">/* Extended Sequencer Mode: 256c col. mode */</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span>
					<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">doubleVCLK</span> <span class="o">?</span> <span class="mh">0xa3</span> <span class="o">:</span> <span class="mh">0xa7</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_GD5480</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
			<span class="cm">/* We already set SRF and SR1F */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_LAGUNA</span>:
		<span class="k">case</span> <span class="n">BT_LAGUNAB</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span>
				<span class="n">vga_rseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">);</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="mh">0x2000</span><span class="p">;</span>
			<span class="n">format</span> <span class="o">|=</span> <span class="mh">0x1400</span><span class="p">;</span>
			<span class="n">threshold</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;unknown Board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* mode register: 256 color mode */</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_MODE</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PCI</span>
		<span class="n">WHDR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">doubleVCLK</span> <span class="o">?</span> <span class="mh">0xe1</span> <span class="o">:</span> <span class="mh">0xc1</span><span class="p">);</span>
<span class="cp">#elif defined(CONFIG_ZORRO)</span>
		<span class="cm">/* FIXME: CONFIG_PCI and CONFIG_ZORRO may be defined both */</span>
		<span class="n">WHDR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>	<span class="cm">/* hidden dac reg: nothing special */</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/******************************************************</span>
<span class="cm">	 *</span>
<span class="cm">	 * 24 bpp</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;preparing for 24 bit deep display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BT_PICCOLO</span>:
		<span class="k">case</span> <span class="n">BT_SPECTRUM</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
			<span class="cm">/* Fast Page-Mode writes */</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_PICASSO</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>
			<span class="cm">/* Fast Page-Mode writes */</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_SD64</span>:
		<span class="k">case</span> <span class="n">BT_PICASSO4</span>:
		<span class="k">case</span> <span class="n">BT_ALPINE</span>:
			<span class="cm">/* Extended Sequencer Mode: 256c col. mode */</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_GD5480</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
			<span class="cm">/* We already set SRF and SR1F */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BT_LAGUNA</span>:
		<span class="k">case</span> <span class="n">BT_LAGUNAB</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span>
				<span class="n">vga_rseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">);</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="mh">0x4000</span><span class="p">;</span>
			<span class="n">format</span> <span class="o">|=</span> <span class="mh">0x2400</span><span class="p">;</span>
			<span class="n">threshold</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;unknown Board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* mode register: 256 color mode */</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_MODE</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="cm">/* hidden dac reg: 8-8-8 mode (24 or 32) */</span>
		<span class="n">WHDR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/******************************************************</span>
<span class="cm">	 *</span>
<span class="cm">	 * unknown/unsupported bpp</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="s">&quot;What&#39;s this? requested color depth == %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="n">pitch</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_OFFSET</span><span class="p">,</span> <span class="n">pitch</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* offset overflow bit */</span>

	<span class="cm">/* screen start addr #16-18, fastpagemode cycles */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_CRT1B</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* screen start address bit 19 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cirrusfb_board_info</span><span class="p">[</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">].</span><span class="n">scrn_start_bit19</span><span class="p">)</span>
		<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_CRT1D</span><span class="p">,</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdispend</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hsyncstart</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mi">1024</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mi">1024</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vsyncstart</span> <span class="o">&amp;</span> <span class="mi">1024</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>

		<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_CRT1E</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CRT1e: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* pixel panning */</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_AR33</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* [ EGS: SetOffset(); ] */</span>
	<span class="cm">/* From SetOffset(): Turn on VideoEnable bit in Attribute controller */</span>
	<span class="n">AttrOn</span><span class="p">(</span><span class="n">cinfo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* no tiles */</span>
		<span class="n">fb_writew</span><span class="p">(</span><span class="n">control</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">+</span> <span class="mh">0x402</span><span class="p">);</span>
		<span class="n">fb_writew</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">+</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="n">fb_writew</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">+</span> <span class="mh">0xea</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* finally, turn on everything - turn off &quot;FullBandwidth&quot; bit */</span>
	<span class="cm">/* also, set &quot;DotClock%2&quot; bit where requested */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

<span class="cm">/*** FB_VMODE_CLOCK_HALVE in linux/fb.h not defined anymore ?</span>
<span class="cm">    if (var-&gt;vmode &amp; FB_VMODE_CLOCK_HALVE)</span>
<span class="cm">	tmp |= 0x08;</span>
<span class="cm">*/</span>

	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CL_SEQR1: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

<span class="cp">#ifdef CIRRUSFB_DEBUG</span>
	<span class="n">cirrusfb_dbg_reg_dump</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* for some reason incomprehensible to me, cirrusfb requires that you write</span>
<span class="cm"> * the registers twice for the settings to take..grr. -dte */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrusfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cirrusfb_set_par_foo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cirrusfb_set_par_foo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrusfb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">blue</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>

		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">WClut</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*************************************************************************</span>
<span class="cm">	cirrusfb_pan_display()</span>

<span class="cm">	performs display panning - provided hardware permits this</span>
<span class="cm">**************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrusfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xoffset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">xpix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="cm">/* no range checks for xoffset and yoffset,   */</span>
	<span class="cm">/* as fb_pan_display has already done this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* base is already correct */</span>
		<span class="n">xpix</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">%</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">base</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">xpix</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">xoffset</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span>
		<span class="n">cirrusfb_WaitBLT</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">);</span>

	<span class="cm">/* lower 8 + 8 bits of screen start address */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_START_LO</span><span class="p">,</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_START_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* 0xf2 is %11110010, exclude tmp bits */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">vga_rcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_CRT1B</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf2</span><span class="p">;</span>
	<span class="cm">/* construct bits 16, 17 and 18 of screen start address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x20000</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x40000</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_CRT1B</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* construct bit 19 of screen start address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cirrusfb_board_info</span><span class="p">[</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">].</span><span class="n">scrn_start_bit19</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">vga_rcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_CRT1D</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x18</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_CRT1D</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* write pixel panning value to AR33; this does not quite work in 8bpp</span>
<span class="cm">	 *</span>
<span class="cm">	 * ### Piccolo..? Will this work?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_AR33</span><span class="p">,</span> <span class="n">xpix</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrusfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Blank the screen if blank_mode != 0, else unblank. If blank == NULL</span>
<span class="cm">	 * then the caller blanks by setting the CLUT (Color Look Up Table)</span>
<span class="cm">	 * to all black. Return 0 if blanking succeeded, != 0 if un-/blanking</span>
<span class="cm">	 * failed due to e.g. a video mode which doesn&#39;t support it.</span>
<span class="cm">	 * Implements VESA suspend and powerdown modes on hardware that</span>
<span class="cm">	 * supports disabling hsync/vsync:</span>
<span class="cm">	 *   blank_mode == 2: suspend vsync</span>
<span class="cm">	 *   blank_mode == 3: suspend hsync</span>
<span class="cm">	 *   blank_mode == 4: powerdown</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_mode</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">blank_mode</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;ENTER, blank mode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blank_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span> <span class="o">||</span>
	    <span class="n">current_mode</span> <span class="o">==</span> <span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;EXIT, returning 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Undo current */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_mode</span> <span class="o">==</span> <span class="n">FB_BLANK_NORMAL</span> <span class="o">||</span>
	    <span class="n">current_mode</span> <span class="o">==</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span>
		<span class="cm">/* clear &quot;FullBandwidth&quot; bit */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* set &quot;FullBandwidth&quot; bit */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">vga_rseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xdf</span><span class="p">;</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;EXIT, returning 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GRE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">blank_mode</span> <span class="o">=</span> <span class="n">blank_mode</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;EXIT, returning 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Let fbcon do a soft blank for us */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">blank_mode</span> <span class="o">==</span> <span class="n">FB_BLANK_NORMAL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**** END   Hardware specific Routines **************************************/</span>
<span class="cm">/****************************************************************************/</span>
<span class="cm">/**** BEGIN Internal Routines ***********************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_vgachip</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_board_info_rec</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">cinfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">bi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cirrusfb_board_info</span><span class="p">[</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">];</span>

	<span class="cm">/* reset board globally */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BT_PICCOLO</span>:
		<span class="n">WSFR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">WSFR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BT_PICASSO</span>:
		<span class="n">WSFR2</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BT_SD64</span>:
	<span class="k">case</span> <span class="n">BT_SPECTRUM</span>:
		<span class="n">WSFR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">WSFR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BT_PICASSO4</span>:
		<span class="cm">/* disable flickerfixer */</span>
		<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_CRT51</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="cm">/* mode */</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR31</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BT_GD5480</span>:  <span class="cm">/* fall through */</span>
		<span class="cm">/* from Klaus&#39; NetBSD driver: */</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR2F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BT_ALPINE</span>:  <span class="cm">/* fall through */</span>
		<span class="cm">/* put blitter into 542x compat */</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR33</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BT_LAGUNA</span>:
	<span class="k">case</span> <span class="n">BT_LAGUNAB</span>:
		<span class="cm">/* Nothing to do to reset the board. */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Warning: Unknown board type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure RAM size set by this point */</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* the P4 is not fully initialized here; I rely on it having been */</span>
	<span class="cm">/* inited under AmigaOS already, which seems to work just fine    */</span>
	<span class="cm">/* (Klaus advised to do it this way)			      */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">!=</span> <span class="n">BT_PICASSO4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">CL_VSSM</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>	<span class="cm">/* EGS: 0x16 */</span>
		<span class="n">WGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">CL_POS102</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">WGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">CL_VSSM</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>	<span class="cm">/* EGS: 0x0e */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">!=</span> <span class="n">BT_SD64</span><span class="p">)</span>
			<span class="n">WGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">CL_VSSM2</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

		<span class="cm">/* reset sequencer logic */</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_SEQ_RESET</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

		<span class="cm">/* FullBandwidth (video off) and 8/9 dot clock */</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>

		<span class="cm">/* &quot;magic cookie&quot; - doesn&#39;t make any sense to me.. */</span>
<span class="cm">/*      vga_wgfx(cinfo-&gt;regbase, CL_GRA, 0xce);   */</span>
		<span class="cm">/* unlock all extension registers */</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR6</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BT_GD5480</span>:
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BT_ALPINE</span>:
		<span class="k">case</span> <span class="n">BT_LAGUNA</span>:
		<span class="k">case</span> <span class="n">BT_LAGUNAB</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BT_SD64</span>:
<span class="cp">#ifdef CONFIG_ZORRO</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR16</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
			<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* plane mask: nothing */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_SEQ_PLANE_WRITE</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="cm">/* character map select: doesn&#39;t even matter in gx mode */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_SEQ_CHARACTER_MAP</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* memory mode: chain4, ext. memory */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_SEQ_MEMORY_MODE</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>

	<span class="cm">/* controller-internal base address of video memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">init_sr07</span><span class="p">)</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR7</span><span class="p">,</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">sr07</span><span class="p">);</span>

	<span class="cm">/*  vga_wseq(cinfo-&gt;regbase, CL_SEQR8, 0x00); */</span>
	<span class="cm">/* EEPROM control: shouldn&#39;t be necessary to write to this at all.. */</span>

	<span class="cm">/* graphics cursor X position (incomplete; position gives rem. 3 bits */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* graphics cursor Y position (...&quot;... ) */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* graphics cursor attributes */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR12</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* graphics cursor pattern address */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* writing these on a P4 might give problems..  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">!=</span> <span class="n">BT_PICASSO4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* configuration readback and ext. color */</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR17</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="cm">/* signature generator */</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR18</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Screen A preset row scan: none */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_PRESET_ROW</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* Text cursor start: disable text cursor */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_CURSOR_START</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="cm">/* Text cursor end: - */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_CURSOR_END</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* text cursor location high: 0 */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_CURSOR_HI</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* text cursor location low: 0 */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_CURSOR_LO</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Underline Row scanline: - */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_CRTC_UNDERLINE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* ### add 0x40 for text modes with &gt; 30 MHz pixclock */</span>
	<span class="cm">/* ext. display controls: ext.adr. wrap */</span>
	<span class="n">vga_wcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_CRT1B</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>

	<span class="cm">/* Set/Reset registes: - */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_SR_VALUE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* Set/Reset enable: - */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_SR_ENABLE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* Color Compare: - */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_COMPARE_VALUE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* Data Rotate: - */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_DATA_ROTATE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* Read Map Select: - */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_PLANE_READ</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* Mode: conf. for 16/4/2 color mode, no odd/even, read/write mode 0 */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_MODE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* Miscellaneous: memory map base address, graphics mode */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_MISC</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="cm">/* Color Don&#39;t care: involve all planes */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_COMPARE_MASK</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="cm">/* Bit Mask: no mask at all */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_BIT_MASK</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_ALPINE</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_SD64</span> <span class="o">||</span>
	    <span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span>
		<span class="cm">/* (5434 can&#39;t have bit 3 set for bitblt) */</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GRB</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">else</span>
	<span class="cm">/* Graphics controller mode extensions: finer granularity,</span>
<span class="cm">	 * 8byte data latches</span>
<span class="cm">	 */</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GRB</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>

	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GRC</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/* Color Key compare: - */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GRD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* Color Key compare mask: - */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GRE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* Miscellaneous control: - */</span>
	<span class="cm">/* Background color byte 1: - */</span>
	<span class="cm">/*  vga_wgfx (cinfo-&gt;regbase, CL_GR10, 0x00); */</span>
	<span class="cm">/*  vga_wgfx (cinfo-&gt;regbase, CL_GR11, 0x00); */</span>

	<span class="cm">/* Attribute Controller palette registers: &quot;identity mapping&quot; */</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTE0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTE1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTE2</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTE3</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTE4</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTE5</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTE6</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTE7</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTE8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTE9</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTEA</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTEB</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTEC</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTED</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTEE</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PALETTEF</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>

	<span class="cm">/* Attribute Controller mode: graphics mode */</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_MODE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="cm">/* Overscan color reg.: reg. 0 */</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_OVERSCAN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* Color Plane enable: Enable all 4 planes */</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_PLANE_ENABLE</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="cm">/* Color Select: - */</span>
	<span class="n">vga_wattr</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATC_COLOR_PAGE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">WGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/* Pixel mask: no mask */</span>

	<span class="cm">/* BLT Start/status: Blitter reset */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR31</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="cm">/* - &quot; -	   : &quot;end-of-reset&quot; */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR31</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* misc... */</span>
	<span class="n">WHDR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Hidden DAC register: - */</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">switch_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ZORRO </span><span class="cm">/* only works on Zorro boards */</span><span class="cp"></span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">IsOn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* XXX not ok for multiple boards */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_PICASSO4</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* nothing to switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_ALPINE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* nothing to switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_GD5480</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* nothing to switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_PICASSO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">on</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IsOn</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span> <span class="o">&amp;&amp;</span> <span class="n">IsOn</span><span class="p">))</span>
			<span class="n">WSFR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BT_SD64</span>:
			<span class="n">WSFR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">SFR</span> <span class="o">|</span> <span class="mh">0x21</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BT_PICCOLO</span>:
			<span class="n">WSFR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">SFR</span> <span class="o">|</span> <span class="mh">0x28</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BT_SPECTRUM</span>:
			<span class="n">WSFR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* do nothing */</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BT_SD64</span>:
			<span class="n">WSFR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">SFR</span> <span class="o">&amp;</span> <span class="mh">0xde</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BT_PICCOLO</span>:
			<span class="n">WSFR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">SFR</span> <span class="o">&amp;</span> <span class="mh">0xd7</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BT_SPECTRUM</span>:
			<span class="n">WSFR</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* do nothing */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ZORRO */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cm">/******************************************/</span>
<span class="cm">/* Linux 2.6-style  accelerated functions */</span>
<span class="cm">/******************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrusfb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">vga_rgfx</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">region</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="n">modded</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">[</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">]</span> <span class="o">:</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">region</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modded</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fillrect</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">||</span>
	   <span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">&gt;=</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">&gt;=</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span>  <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span><span class="p">;</span>

	<span class="n">cirrusfb_RectFill</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span>
			  <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
			  <span class="n">color</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span>
			  <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="n">modded</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modded</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_copyarea</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">||</span>
	   <span class="n">modded</span><span class="p">.</span><span class="n">sx</span> <span class="o">&gt;=</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">modded</span><span class="p">.</span><span class="n">sy</span> <span class="o">&gt;=</span> <span class="n">vyres</span> <span class="o">||</span>
	   <span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">&gt;=</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">&gt;=</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">sx</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">sx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">sy</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">sy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span><span class="p">;</span>

	<span class="n">cirrusfb_BitBLT</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
			<span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">,</span>
			<span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span>
			<span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">op</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xc</span> <span class="o">:</span> <span class="mh">0x4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Alpine/SD64 does not work at 24bpp ??? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span> <span class="o">||</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_ALPINE</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_SD64</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">op</span> <span class="o">==</span> <span class="mh">0xc</span><span class="p">)</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fg</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">;</span>
			<span class="n">bg</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">];</span>
			<span class="n">bg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clear background first */</span>
			<span class="n">cirrusfb_RectFill</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span>
					  <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span>
					  <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
					  <span class="n">bg</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span>
					  <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cirrusfb_RectFill</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
				  <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC_PREP</span>
<span class="cp">#define PREP_VIDEO_BASE ((volatile unsigned long) 0xC0000000)</span>
<span class="cp">#define PREP_IO_BASE    ((volatile unsigned char *) 0x80000000)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_prep_addrs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">display</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">registers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">display</span> <span class="o">=</span> <span class="n">PREP_VIDEO_BASE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">registers</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">PREP_IO_BASE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_PPC_PREP */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">release_io_ports</span><span class="p">;</span>

<span class="cm">/* Pulled the logic from XFree86 Cirrus driver to get the memory size,</span>
<span class="cm"> * based on the DRAM bandwidth bit and DRAM bank switching bit.  This</span>
<span class="cm"> * works with 1MB, 2MB and 4MB configurations (which the Motorola boards</span>
<span class="cm"> * seem to have. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cirrusfb_get_memsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
						   <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regbase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SR14</span> <span class="o">=</span> <span class="n">vga_rseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR14</span><span class="p">);</span>

		<span class="n">mem</span> <span class="o">=</span> <span class="p">((</span><span class="n">SR14</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SRF</span> <span class="o">=</span> <span class="n">vga_rseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQRF</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">SRF</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="n">mem</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x10</span>:
			<span class="n">mem</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* 64-bit DRAM data bus width; assume 2MB.</span>
<span class="cm">		 * Also indicates 2MB memory on the 5430.</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="mh">0x18</span>:
			<span class="n">mem</span> <span class="o">=</span> <span class="mi">2048</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Unknown memory size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mem</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* If DRAM bank switching is enabled, there must be</span>
<span class="cm">		 * twice as much memory installed. (4MB on the 5434)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">!=</span> <span class="n">BT_ALPINE</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SRF</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mem</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: Handling of GD5446/5480 (see XF86 sources ...) */</span>
	<span class="k">return</span> <span class="n">mem</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_pci_addrs</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">display</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">registers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">pdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">display</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">registers</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="o">*</span><span class="n">display</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">registers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This is a best-guess for now */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">display</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="o">*</span><span class="n">registers</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">display</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">registers</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">assert</span><span class="p">(</span><span class="o">*</span><span class="n">display</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_pci_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"> /* if system didn&#39;t claim this region, we would... */</span>
<span class="c">	release_mem_region(0xA0000, 65535);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">release_io_ports</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="mh">0x3C0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ZORRO</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_zorro_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zorro_dev</span> <span class="o">*</span><span class="n">zdev</span> <span class="o">=</span> <span class="n">to_zorro_dev</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">MB_</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">MB_</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">);</span>

	<span class="n">zorro_release_device</span><span class="p">(</span><span class="n">zdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ZORRO */</span><span class="cp"></span>

<span class="cm">/* function table of the above functions */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">cirrusfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>	<span class="o">=</span> <span class="n">cirrusfb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>	<span class="o">=</span> <span class="n">cirrusfb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">cirrusfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">cirrusfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">cirrusfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">cirrusfb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">cirrusfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cirrusfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cirrusfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_sync</span>	<span class="o">=</span> <span class="n">cirrusfb_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cirrusfb_imageblit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cirrusfb_set_fbinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span>
		    <span class="o">|</span> <span class="n">FBINFO_HWACCEL_XPAN</span>
		    <span class="o">|</span> <span class="n">FBINFO_HWACCEL_YPAN</span>
		    <span class="o">|</span> <span class="n">FBINFO_HWACCEL_FILLRECT</span>
		    <span class="o">|</span> <span class="n">FBINFO_HWACCEL_IMAGEBLIT</span>
		    <span class="o">|</span> <span class="n">FBINFO_HWACCEL_COPYAREA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">noaccel</span> <span class="o">||</span> <span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_CIRRUS_ALPINE</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cirrusfb_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_GD5480</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">MB_</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">MB_</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill fix common fields */</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cirrusfb_board_info</span><span class="p">[</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>

	<span class="cm">/* monochrome: only 1 memory plane */</span>
	<span class="cm">/* 8 bit and above: Use whole memory area */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span>   <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* FIXME: map region at 0xB8000 if available, fill in here */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cirrusfb_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* sanity checks */</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">!=</span> <span class="n">BT_NONE</span><span class="p">);</span>

	<span class="cm">/* set all the vital stuff */</span>
	<span class="n">cirrusfb_set_fbinfo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;(RAM start set to: 0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;wrong initial video mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dealloc_cmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cirrusfb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* should never happen */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="s">&quot;choking on default var... umm, no good.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dealloc_cmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="s">&quot;could not register fb device; err = %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dealloc_cmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_dealloc_cmap:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">cirrusfb_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">switch_monitor</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Framebuffer unregistered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">unmap</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cirrusfb_pci_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">board_addr</span><span class="p">,</span> <span class="n">board_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cirrusfb: Cannot enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrusfb_info</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cirrusfb: could not allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">cirrus_board</span><span class="p">)</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		<span class="s">&quot; Found PCI device, base address 0 is 0x%Lx, btype set to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>  <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot; base address 1 is 0x%Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isPReP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PPC_PREP</span>
		<span class="n">get_prep_addrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* PReP dies if we ioremap the IO registers, but it works w/out... */</span>
		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="s">&quot;Attempt to get PCI info for Cirrus Graphics Card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">get_pci_addrs</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">board_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">);</span>
		<span class="cm">/* FIXME: this forces VGA.  alternatives? */</span>
		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Board address: 0x%lx, register address: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">board_addr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">);</span>

	<span class="n">board_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_GD5480</span><span class="p">)</span> <span class="o">?</span>
		<span class="mi">32</span> <span class="o">*</span> <span class="n">MB_</span> <span class="o">:</span> <span class="n">cirrusfb_get_memsize</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;cirrusfb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;cannot reserve region 0x%lx, abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">board_addr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release_fb</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"> /* if the system didn&#39;t claim this region, we would... */</span>
<span class="c">	if (!request_mem_region(0xA0000, 65535, &quot;cirrusfb&quot;)) {</span>
<span class="c">		dev_err(info-&gt;device, &quot;cannot reserve region 0x%lx, abort\n&quot;,</span>
<span class="c">			0xA0000L);</span>
<span class="c">		ret = -EBUSY;</span>
<span class="c">		goto err_release_regions;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="mh">0x3C0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;cirrusfb&quot;</span><span class="p">))</span>
		<span class="n">release_io_ports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">board_addr</span><span class="p">,</span> <span class="n">board_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release_legacy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">board_addr</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">=</span> <span class="n">board_size</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">unmap</span> <span class="o">=</span> <span class="n">cirrusfb_pci_unmap</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		 <span class="s">&quot;Cirrus Logic chipset on PCI bus, RAM (%lu kB) at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">board_addr</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cirrusfb_register</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="nl">err_release_legacy:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">release_io_ports</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="mh">0x3C0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	release_mem_region(0xA0000, 65535);</span>
<span class="c">err_release_regions:</span>
<span class="cp">#endif</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_release_fb:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">laguna_mmio</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">cirrusfb_pci_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">cirrusfb_cleanup</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cirrusfb_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cirrusfb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">cirrusfb_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">cirrusfb_pci_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">cirrusfb_pci_unregister</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	.suspend	= cirrusfb_pci_suspend,</span>
<span class="c">	.resume		= cirrusfb_pci_resume,</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ZORRO</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cirrusfb_zorro_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">zorro_dev</span> <span class="o">*</span><span class="n">z</span><span class="p">,</span>
					     <span class="k">const</span> <span class="k">struct</span> <span class="n">zorro_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">zorrocl</span> <span class="o">*</span><span class="n">zcl</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">cirrus_board</span> <span class="n">btype</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regbase</span><span class="p">,</span> <span class="n">ramsize</span><span class="p">,</span> <span class="n">rambase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrusfb_info</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cirrusfb: could not allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zcl</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">zorrocl</span> <span class="o">*</span><span class="p">)</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">btype</span> <span class="o">=</span> <span class="n">zcl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">regbase</span> <span class="o">=</span> <span class="n">zorro_resource_start</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">zcl</span><span class="o">-&gt;</span><span class="n">regoffset</span><span class="p">;</span>
	<span class="n">ramsize</span> <span class="o">=</span> <span class="n">zcl</span><span class="o">-&gt;</span><span class="n">ramsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ramsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rambase</span> <span class="o">=</span> <span class="n">zorro_resource_start</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">zcl</span><span class="o">-&gt;</span><span class="n">ramoffset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zorro_resource_len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">==</span> <span class="mi">64</span> <span class="o">*</span> <span class="n">MB_</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Quirk for 64 MiB Picasso IV */</span>
			<span class="n">rambase</span> <span class="o">+=</span> <span class="n">zcl</span><span class="o">-&gt;</span><span class="n">ramoffset</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">zorro_dev</span> <span class="o">*</span><span class="n">ram</span> <span class="o">=</span> <span class="n">zorro_find_device</span><span class="p">(</span><span class="n">zcl</span><span class="o">-&gt;</span><span class="n">ramid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ram</span> <span class="o">||</span> <span class="o">!</span><span class="n">zorro_resource_len</span><span class="p">(</span><span class="n">ram</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;No video RAM found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_release_fb</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rambase</span> <span class="o">=</span> <span class="n">zorro_resource_start</span><span class="p">(</span><span class="n">ram</span><span class="p">);</span>
		<span class="n">ramsize</span> <span class="o">=</span> <span class="n">zorro_resource_len</span><span class="p">(</span><span class="n">ram</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zcl</span><span class="o">-&gt;</span><span class="n">ramid2</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ram</span> <span class="o">=</span> <span class="n">zorro_find_device</span><span class="p">(</span><span class="n">zcl</span><span class="o">-&gt;</span><span class="n">ramid2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">zorro_resource_start</span><span class="p">(</span><span class="n">ram</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rambase</span> <span class="o">+</span> <span class="n">ramsize</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
					 <span class="s">&quot;Skipping non-contiguous RAM at %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">ram</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ramsize</span> <span class="o">+=</span> <span class="n">zorro_resource_len</span><span class="p">(</span><span class="n">ram</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		 <span class="s">&quot;%s board detected, REG at 0x%lx, %lu MiB RAM at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">cirrusfb_board_info</span><span class="p">[</span><span class="n">btype</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">regbase</span><span class="p">,</span> <span class="n">ramsize</span> <span class="o">/</span> <span class="n">MB_</span><span class="p">,</span>
		 <span class="n">rambase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zorro_request_device</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="s">&quot;cirrusfb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Cannot reserve %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release_fb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">=</span> <span class="n">btype</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">regbase</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">=</span> <span class="n">regbase</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">MB_</span> <span class="o">?</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
					    <span class="o">:</span> <span class="p">(</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">ZTWO_VADDR</span><span class="p">(</span><span class="n">regbase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Cannot map registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">rambase</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">=</span> <span class="n">ramsize</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">rambase</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">MB_</span> <span class="o">?</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">rambase</span><span class="p">,</span> <span class="n">ramsize</span><span class="p">)</span>
					       <span class="o">:</span> <span class="p">(</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">ZTWO_VADDR</span><span class="p">(</span><span class="n">rambase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Cannot map video RAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">unmap</span> <span class="o">=</span> <span class="n">cirrusfb_zorro_unmap</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		 <span class="s">&quot;Cirrus Logic chipset on Zorro bus, RAM (%lu MiB) at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ramsize</span> <span class="o">/</span> <span class="n">MB_</span><span class="p">,</span> <span class="n">rambase</span><span class="p">);</span>

	<span class="cm">/* MCLK select etc. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cirrusfb_board_info</span><span class="p">[</span><span class="n">btype</span><span class="p">].</span><span class="n">init_sr1f</span><span class="p">)</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_SEQR1F</span><span class="p">,</span>
			 <span class="n">cirrusfb_board_info</span><span class="p">[</span><span class="n">btype</span><span class="p">].</span><span class="n">sr1f</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">cirrusfb_register</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Failed to register device, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_ram</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zorro_set_drvdata</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unmap_ram:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rambase</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">MB_</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>

<span class="nl">err_unmap_reg:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regbase</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">MB_</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">);</span>
<span class="nl">err_release_dev:</span>
	<span class="n">zorro_release_device</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
<span class="nl">err_release_fb:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">cirrusfb_zorro_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">zorro_dev</span> <span class="o">*</span><span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">zorro_get_drvdata</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>

	<span class="n">cirrusfb_cleanup</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">zorro_set_drvdata</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">zorro_driver</span> <span class="n">cirrusfb_zorro_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cirrusfb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">cirrusfb_zorro_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">cirrusfb_zorro_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">cirrusfb_zorro_unregister</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ZORRO */</span><span class="cp"></span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cirrusfb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;noaccel&quot;</span><span class="p">))</span>
			<span class="n">noaccel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mode:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

    <span class="cm">/*</span>
<span class="cm">     *  Modularization</span>
<span class="cm">     */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Copyright 1999,2000 Jeff Garzik &lt;jgarzik@pobox.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Accelerated FBDev driver for Cirrus Logic chips&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cirrusfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;cirrusfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">cirrusfb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_ZORRO</span>
	<span class="n">error</span> <span class="o">|=</span> <span class="n">zorro_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cirrusfb_zorro_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">error</span> <span class="o">|=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cirrusfb_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cirrusfb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cirrusfb_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ZORRO</span>
	<span class="n">zorro_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cirrusfb_zorro_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cirrusfb_init</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="s">&quot;Initial video mode e.g. &#39;648x480-8@60&#39;&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="s">&quot;Disable acceleration&quot;</span><span class="p">);</span>

<span class="cp">#ifdef MODULE</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cirrusfb_exit</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/**********************************************************************/</span>
<span class="cm">/* about the following functions - I have used the same names for the */</span>
<span class="cm">/* functions as Markus Wild did in his Retina driver for NetBSD as    */</span>
<span class="cm">/* they just made sense for this purpose. Apart from that, I wrote    */</span>
<span class="cm">/* these functions myself.					    */</span>
<span class="cm">/**********************************************************************/</span>

<span class="cm">/*** WGen() - write into one of the external/general registers ***/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">WGen</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_PICASSO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Picasso II specific hack */</span>
<span class="cm">/*	      if (regnum == VGA_PEL_IR || regnum == VGA_PEL_D ||</span>
<span class="cm">		  regnum == CL_VSSM2) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">==</span> <span class="n">VGA_PEL_IR</span> <span class="o">||</span> <span class="n">regnum</span> <span class="o">==</span> <span class="n">VGA_PEL_D</span><span class="p">)</span>
			<span class="n">regofs</span> <span class="o">=</span> <span class="mh">0xfff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vga_w</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">regofs</span> <span class="o">+</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*** RGen() - read out one of the external/general registers ***/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">RGen</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_PICASSO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Picasso II specific hack */</span>
<span class="cm">/*	      if (regnum == VGA_PEL_IR || regnum == VGA_PEL_D ||</span>
<span class="cm">		  regnum == CL_VSSM2) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">==</span> <span class="n">VGA_PEL_IR</span> <span class="o">||</span> <span class="n">regnum</span> <span class="o">==</span> <span class="n">VGA_PEL_D</span><span class="p">)</span>
			<span class="n">regofs</span> <span class="o">=</span> <span class="mh">0xfff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">vga_r</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">regofs</span> <span class="o">+</span> <span class="n">regnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*** AttrOn() - turn on VideoEnable for Attribute controller ***/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">AttrOn</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">cinfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vga_rcrt</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_CRT24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if we&#39;re just in &quot;write value&quot; mode, write back the */</span>
		<span class="cm">/* same value as before to not modify anything */</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATT_IW</span><span class="p">,</span>
		      <span class="n">vga_r</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATT_R</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* turn on video bit */</span>
<span class="cm">/*      vga_w(cinfo-&gt;regbase, VGA_ATT_IW, 0x20); */</span>
	<span class="n">vga_w</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATT_IW</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">);</span>

	<span class="cm">/* dummy write on Reg0 to be on &quot;write index&quot; mode next time */</span>
	<span class="n">vga_w</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_ATT_IW</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*** WHDR() - write into the Hidden DAC register ***/</span>
<span class="cm">/* as the HDR is the only extension register that requires special treatment</span>
<span class="cm"> * (the other extension registers are accessible just like the &quot;ordinary&quot;</span>
<span class="cm"> * registers of their functional group) here is a specialized routine for</span>
<span class="cm"> * accessing the HDR</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">WHDR</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_PICASSO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Klaus&#39; hint for correct access to HDR on some boards */</span>
		<span class="cm">/* first write 0 to pixel mask (3c6) */</span>
		<span class="n">WGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="cm">/* next read dummy from pixel address (3c8) */</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">RGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_PEL_IW</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* now do the usual stuff to access the HDR */</span>

	<span class="n">dummy</span> <span class="o">=</span> <span class="n">RGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">RGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">RGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">RGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">WGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_PICASSO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* now first reset HDR access counter */</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">RGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_PEL_IW</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

		<span class="cm">/* and at the end, restore the mask value */</span>
		<span class="cm">/* ## is this mask always 0xff? */</span>
		<span class="n">WGen</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*** WSFR() - write to the &quot;special function register&quot; (SFR) ***/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">WSFR</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ZORRO</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">SFR</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">z_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">+</span> <span class="mh">0x8000</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* The Picasso has a second register for switching the monitor bit */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">WSFR2</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ZORRO</span>
	<span class="cm">/* writing an arbitrary value to this one causes the monitor switcher */</span>
	<span class="cm">/* to flip to Amiga display */</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">SFR</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">z_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">+</span> <span class="mh">0x9000</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*** WClut - set CLUT entry (range: 0..63) ***/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">WClut</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrusfb_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">red</span><span class="p">,</span>
	    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">blue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="n">VGA_PEL_D</span><span class="p">;</span>

	<span class="cm">/* address write mode register is not translated.. */</span>
	<span class="n">vga_w</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_PEL_IW</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_PICASSO</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_PICASSO4</span> <span class="o">||</span>
	    <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_ALPINE</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_GD5480</span> <span class="o">||</span>
	    <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_SD64</span> <span class="o">||</span> <span class="n">is_laguna</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* but DAC data register IS, at least for Picasso II */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">btype</span> <span class="o">==</span> <span class="n">BT_PICASSO</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">red</span><span class="p">);</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">green</span><span class="p">);</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">green</span><span class="p">);</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">red</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*** RClut - read CLUT entry (range 0..63) ***/</span>
<span class="c">static void RClut(struct cirrusfb_info *cinfo, unsigned char regnum, unsigned char *red,</span>
<span class="c">	    unsigned char *green, unsigned char *blue)</span>
<span class="c">{</span>
<span class="c">	unsigned int data = VGA_PEL_D;</span>

<span class="c">	vga_w(cinfo-&gt;regbase, VGA_PEL_IR, regnum);</span>

<span class="c">	if (cinfo-&gt;btype == BT_PICASSO || cinfo-&gt;btype == BT_PICASSO4 ||</span>
<span class="c">	    cinfo-&gt;btype == BT_ALPINE || cinfo-&gt;btype == BT_GD5480) {</span>
<span class="c">		if (cinfo-&gt;btype == BT_PICASSO)</span>
<span class="c">			data += 0xfff;</span>
<span class="c">		*red = vga_r(cinfo-&gt;regbase, data);</span>
<span class="c">		*green = vga_r(cinfo-&gt;regbase, data);</span>
<span class="c">		*blue = vga_r(cinfo-&gt;regbase, data);</span>
<span class="c">	} else {</span>
<span class="c">		*blue = vga_r(cinfo-&gt;regbase, data);</span>
<span class="c">		*green = vga_r(cinfo-&gt;regbase, data);</span>
<span class="c">		*red = vga_r(cinfo-&gt;regbase, data);</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/*******************************************************************</span>
<span class="cm">	cirrusfb_WaitBLT()</span>

<span class="cm">	Wait for the BitBLT engine to complete a possible earlier job</span>
<span class="cm">*********************************************************************/</span>

<span class="cm">/* FIXME: use interrupts instead */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_WaitBLT</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regbase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">vga_rgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************</span>
<span class="cm">	cirrusfb_BitBLT()</span>

<span class="cm">	perform accelerated &quot;scrolling&quot;</span>
<span class="cm">********************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_set_blitter</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regbase</span><span class="p">,</span>
			    <span class="n">u_short</span> <span class="n">nwidth</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">nheight</span><span class="p">,</span>
			    <span class="n">u_long</span> <span class="n">nsrc</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">ndest</span><span class="p">,</span>
			    <span class="n">u_short</span> <span class="n">bltmode</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">line_length</span><span class="p">)</span>

<span class="p">{</span>
	<span class="cm">/* pitch: set to line_length */</span>
	<span class="cm">/* dest pitch low */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR24</span><span class="p">,</span> <span class="n">line_length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="cm">/* dest pitch hi */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR25</span><span class="p">,</span> <span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* source pitch low */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR26</span><span class="p">,</span> <span class="n">line_length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="cm">/* source pitch hi */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR27</span><span class="p">,</span> <span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* BLT width: actual number of pixels - 1 */</span>
	<span class="cm">/* BLT width low */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR20</span><span class="p">,</span> <span class="n">nwidth</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="cm">/* BLT width hi */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR21</span><span class="p">,</span> <span class="n">nwidth</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* BLT height: actual number of lines -1 */</span>
	<span class="cm">/* BLT height low */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR22</span><span class="p">,</span> <span class="n">nheight</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="cm">/* BLT width hi */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR23</span><span class="p">,</span> <span class="n">nheight</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* BLT destination */</span>
	<span class="cm">/* BLT dest low */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR28</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">ndest</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="cm">/* BLT dest mid */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR29</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">ndest</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="cm">/* BLT dest hi */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR2A</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">ndest</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* BLT source */</span>
	<span class="cm">/* BLT src low */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR2C</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">nsrc</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="cm">/* BLT src mid */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR2D</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">nsrc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="cm">/* BLT src hi */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR2E</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">nsrc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* BLT mode */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR30</span><span class="p">,</span> <span class="n">bltmode</span><span class="p">);</span>	<span class="cm">/* BLT mode */</span>

	<span class="cm">/* BLT ROP: SrcCopy */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR32</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>	<span class="cm">/* BLT ROP */</span>

	<span class="cm">/* and finally: GO! */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR31</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>	<span class="cm">/* BLT Start/status */</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************</span>
<span class="cm">	cirrusfb_BitBLT()</span>

<span class="cm">	perform accelerated &quot;scrolling&quot;</span>
<span class="cm">********************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_BitBLT</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regbase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits_per_pixel</span><span class="p">,</span>
			    <span class="n">u_short</span> <span class="n">curx</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">cury</span><span class="p">,</span>
			    <span class="n">u_short</span> <span class="n">destx</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">desty</span><span class="p">,</span>
			    <span class="n">u_short</span> <span class="n">width</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">height</span><span class="p">,</span>
			    <span class="n">u_short</span> <span class="n">line_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span> <span class="n">nwidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">nheight</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">nsrc</span><span class="p">,</span> <span class="n">ndest</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">bltmode</span><span class="p">;</span>

	<span class="n">bltmode</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="cm">/* if source adr &lt; dest addr, do the Blt backwards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cury</span> <span class="o">&lt;=</span> <span class="n">desty</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cury</span> <span class="o">==</span> <span class="n">desty</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if src and dest are on the same line, check x */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curx</span> <span class="o">&lt;</span> <span class="n">destx</span><span class="p">)</span>
				<span class="n">bltmode</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bltmode</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* standard case: forward blitting */</span>
	<span class="n">nsrc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cury</span> <span class="o">*</span> <span class="n">line_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">curx</span><span class="p">;</span>
	<span class="n">ndest</span> <span class="o">=</span> <span class="p">(</span><span class="n">desty</span> <span class="o">*</span> <span class="n">line_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">destx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bltmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this means start addresses are at the end,</span>
<span class="cm">		 * counting backwards</span>
<span class="cm">		 */</span>
		<span class="n">nsrc</span> <span class="o">+=</span> <span class="n">nheight</span> <span class="o">*</span> <span class="n">line_length</span> <span class="o">+</span> <span class="n">nwidth</span><span class="p">;</span>
		<span class="n">ndest</span> <span class="o">+=</span> <span class="n">nheight</span> <span class="o">*</span> <span class="n">line_length</span> <span class="o">+</span> <span class="n">nwidth</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cirrusfb_WaitBLT</span><span class="p">(</span><span class="n">regbase</span><span class="p">);</span>

	<span class="n">cirrusfb_set_blitter</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">nwidth</span><span class="p">,</span> <span class="n">nheight</span><span class="p">,</span>
			    <span class="n">nsrc</span><span class="p">,</span> <span class="n">ndest</span><span class="p">,</span> <span class="n">bltmode</span><span class="p">,</span> <span class="n">line_length</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************</span>
<span class="cm">	cirrusfb_RectFill()</span>

<span class="cm">	perform accelerated rectangle fill</span>
<span class="cm">********************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_RectFill</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regbase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits_per_pixel</span><span class="p">,</span>
		     <span class="n">u_short</span> <span class="n">x</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">y</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">width</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">height</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">fg_color</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bg_color</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">line_length</span><span class="p">,</span>
		     <span class="n">u_char</span> <span class="n">blitmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">ndest</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">line_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">cirrusfb_WaitBLT</span><span class="p">(</span><span class="n">regbase</span><span class="p">);</span>

	<span class="cm">/* This is a ColorExpand Blt, using the */</span>
	<span class="cm">/* same color for foreground and background */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_SR_VALUE</span><span class="p">,</span> <span class="n">bg_color</span><span class="p">);</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">VGA_GFX_SR_ENABLE</span><span class="p">,</span> <span class="n">fg_color</span><span class="p">);</span>

	<span class="n">op</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bits_per_pixel</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR10</span><span class="p">,</span> <span class="n">bg_color</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR11</span><span class="p">,</span> <span class="n">fg_color</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">op</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bits_per_pixel</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR12</span><span class="p">,</span> <span class="n">bg_color</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR13</span><span class="p">,</span> <span class="n">fg_color</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">op</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR14</span><span class="p">,</span> <span class="n">bg_color</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">CL_GR15</span><span class="p">,</span> <span class="n">fg_color</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">op</span> <span class="o">=</span> <span class="mh">0xb0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cirrusfb_set_blitter</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="n">ndest</span><span class="p">,</span> <span class="n">op</span> <span class="o">|</span> <span class="n">blitmode</span><span class="p">,</span> <span class="n">line_length</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * bestclock() - determine closest possible clock lower(?) than the</span>
<span class="cm"> * desired pixel clock</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bestclock</span><span class="p">(</span><span class="kt">long</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nom</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">den</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">h</span><span class="p">,</span> <span class="n">diff</span><span class="p">;</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">nom</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">den</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">div</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="o">*</span><span class="n">nom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">den</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">8000</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>

	<span class="n">diff</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14318</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">freq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;=</span> <span class="mi">63</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">temp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">h</span> <span class="o">=</span> <span class="p">((</span><span class="mi">14318</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">temp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="n">freq</span> <span class="o">?</span> <span class="n">h</span> <span class="o">-</span> <span class="n">freq</span> <span class="o">:</span> <span class="n">freq</span> <span class="o">-</span> <span class="n">h</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;</span> <span class="n">diff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diff</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
				<span class="o">*</span><span class="n">nom</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
				<span class="o">*</span><span class="n">den</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="o">*</span><span class="n">div</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">d</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;=</span> <span class="mi">63</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">d</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">h</span> <span class="o">=</span> <span class="p">((</span><span class="mi">14318</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="n">freq</span> <span class="o">?</span> <span class="n">h</span> <span class="o">-</span> <span class="n">freq</span> <span class="o">:</span> <span class="n">freq</span> <span class="o">-</span> <span class="n">h</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;</span> <span class="n">diff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diff</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
				<span class="o">*</span><span class="n">nom</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
				<span class="o">*</span><span class="n">den</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
				<span class="o">*</span><span class="n">div</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * debugging functions</span>
<span class="cm"> *</span>
<span class="cm"> * -------------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CIRRUSFB_DEBUG</span>

<span class="cm">/**</span>
<span class="cm"> * cirrusfb_dbg_print_regs</span>
<span class="cm"> * @base: If using newmmio, the newmmio base address, otherwise %NULL</span>
<span class="cm"> * @reg_class: type of registers to read: %CRT, or %SEQ</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * Dumps the given list of VGA CRTC registers.  If @base is %NULL,</span>
<span class="cm"> * old-style I/O ports are queried for information, otherwise MMIO is</span>
<span class="cm"> * used at the given @base address to query the information.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_dbg_print_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="n">caddr_t</span> <span class="n">regbase</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">cirrusfb_dbg_reg_class</span> <span class="n">reg_class</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">reg_class</span><span class="p">);</span>

	<span class="n">name</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">reg_class</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CRT</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">vga_rcrt</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SEQ</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">vga_rseq</span><span class="p">(</span><span class="n">regbase</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* should never occur */</span>
			<span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;%8s = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cirrusfb_dbg_reg_dump</span>
<span class="cm"> * @base: If using newmmio, the newmmio base address, otherwise %NULL</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * Dumps a list of interesting VGA and CIRRUSFB registers.  If @base is %NULL,</span>
<span class="cm"> * old-style I/O ports are queried for information, otherwise MMIO is</span>
<span class="cm"> * used at the given @base address to query the information.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrusfb_dbg_reg_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">caddr_t</span> <span class="n">regbase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;VGA CRTC register dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cirrusfb_dbg_print_regs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">regbase</span><span class="p">,</span> <span class="n">CRT</span><span class="p">,</span>
			   <span class="s">&quot;CR00&quot;</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
			   <span class="s">&quot;CR01&quot;</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
			   <span class="s">&quot;CR02&quot;</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
			   <span class="s">&quot;CR03&quot;</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
			   <span class="s">&quot;CR04&quot;</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
			   <span class="s">&quot;CR05&quot;</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
			   <span class="s">&quot;CR06&quot;</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span>
			   <span class="s">&quot;CR07&quot;</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
			   <span class="s">&quot;CR08&quot;</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
			   <span class="s">&quot;CR09&quot;</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span>
			   <span class="s">&quot;CR0A&quot;</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span>
			   <span class="s">&quot;CR0B&quot;</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span>
			   <span class="s">&quot;CR0C&quot;</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span>
			   <span class="s">&quot;CR0D&quot;</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span>
			   <span class="s">&quot;CR0E&quot;</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span>
			   <span class="s">&quot;CR0F&quot;</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span>
			   <span class="s">&quot;CR10&quot;</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
			   <span class="s">&quot;CR11&quot;</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
			   <span class="s">&quot;CR12&quot;</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span>
			   <span class="s">&quot;CR13&quot;</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
			   <span class="s">&quot;CR14&quot;</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
			   <span class="s">&quot;CR15&quot;</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span>
			   <span class="s">&quot;CR16&quot;</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span>
			   <span class="s">&quot;CR17&quot;</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span>
			   <span class="s">&quot;CR18&quot;</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span>
			   <span class="s">&quot;CR22&quot;</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span>
			   <span class="s">&quot;CR24&quot;</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
			   <span class="s">&quot;CR26&quot;</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span>
			   <span class="s">&quot;CR2D&quot;</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span>
			   <span class="s">&quot;CR2E&quot;</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">,</span>
			   <span class="s">&quot;CR2F&quot;</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span>
			   <span class="s">&quot;CR30&quot;</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
			   <span class="s">&quot;CR31&quot;</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span>
			   <span class="s">&quot;CR32&quot;</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span>
			   <span class="s">&quot;CR33&quot;</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span>
			   <span class="s">&quot;CR34&quot;</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span>
			   <span class="s">&quot;CR35&quot;</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span>
			   <span class="s">&quot;CR36&quot;</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span>
			   <span class="s">&quot;CR37&quot;</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span>
			   <span class="s">&quot;CR38&quot;</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span>
			   <span class="s">&quot;CR39&quot;</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span>
			   <span class="s">&quot;CR3A&quot;</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span>
			   <span class="s">&quot;CR3B&quot;</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span>
			   <span class="s">&quot;CR3C&quot;</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span>
			   <span class="s">&quot;CR3D&quot;</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">,</span>
			   <span class="s">&quot;CR3E&quot;</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">,</span>
			   <span class="s">&quot;CR3F&quot;</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span>
			   <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;VGA SEQ register dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cirrusfb_dbg_print_regs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">regbase</span><span class="p">,</span> <span class="n">SEQ</span><span class="p">,</span>
			   <span class="s">&quot;SR00&quot;</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
			   <span class="s">&quot;SR01&quot;</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
			   <span class="s">&quot;SR02&quot;</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
			   <span class="s">&quot;SR03&quot;</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
			   <span class="s">&quot;SR04&quot;</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
			   <span class="s">&quot;SR08&quot;</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
			   <span class="s">&quot;SR09&quot;</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span>
			   <span class="s">&quot;SR0A&quot;</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span>
			   <span class="s">&quot;SR0B&quot;</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span>
			   <span class="s">&quot;SR0D&quot;</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span>
			   <span class="s">&quot;SR10&quot;</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
			   <span class="s">&quot;SR11&quot;</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
			   <span class="s">&quot;SR12&quot;</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span>
			   <span class="s">&quot;SR13&quot;</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
			   <span class="s">&quot;SR14&quot;</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
			   <span class="s">&quot;SR15&quot;</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span>
			   <span class="s">&quot;SR16&quot;</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span>
			   <span class="s">&quot;SR17&quot;</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span>
			   <span class="s">&quot;SR18&quot;</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span>
			   <span class="s">&quot;SR19&quot;</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span>
			   <span class="s">&quot;SR1A&quot;</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span>
			   <span class="s">&quot;SR1B&quot;</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span>
			   <span class="s">&quot;SR1C&quot;</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span>
			   <span class="s">&quot;SR1D&quot;</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span>
			   <span class="s">&quot;SR1E&quot;</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span>
			   <span class="s">&quot;SR1F&quot;</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span>
			   <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif				</span><span class="cm">/* CIRRUSFB_DEBUG */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
