<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › offb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>offb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/video/offb.c -- Open Firmware based frame buffer device</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 1997 Geert Uytterhoeven</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is partly based on the PowerMac console driver:</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 1996 Paul Mackerras</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> *  License. See the file COPYING in the main directory of this archive for</span>
<span class="cm"> *  more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_address.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PPC32</span>
<span class="cp">#include &lt;asm/bootx.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;macmodes.h&quot;</span>

<span class="cm">/* Supported palette hacks */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">cmap_unknown</span><span class="p">,</span>
	<span class="n">cmap_simple</span><span class="p">,</span>		<span class="cm">/* ATI Mach64 */</span>
	<span class="n">cmap_r128</span><span class="p">,</span>		<span class="cm">/* ATI Rage128 */</span>
	<span class="n">cmap_M3A</span><span class="p">,</span>		<span class="cm">/* ATI Rage Mobility M3 Head A */</span>
	<span class="n">cmap_M3B</span><span class="p">,</span>		<span class="cm">/* ATI Rage Mobility M3 Head B */</span>
	<span class="n">cmap_radeon</span><span class="p">,</span>		<span class="cm">/* ATI Radeon */</span>
	<span class="n">cmap_gxt2000</span><span class="p">,</span>		<span class="cm">/* IBM GXT2000 */</span>
	<span class="n">cmap_avivo</span><span class="p">,</span>		<span class="cm">/* ATI R5xx */</span>
	<span class="n">cmap_qemu</span><span class="p">,</span>		<span class="cm">/* qemu vga */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">offb_par</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cmap_adr</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cmap_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmap_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blanked</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">offb_par</span> <span class="n">default_par</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC32</span>
<span class="k">extern</span> <span class="n">boot_infos_t</span> <span class="o">*</span><span class="n">boot_infos</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* Definitions used by the Avivo palette hack */</span>
<span class="cp">#define AVIVO_DC_LUT_RW_SELECT                  0x6480</span>
<span class="cp">#define AVIVO_DC_LUT_RW_MODE                    0x6484</span>
<span class="cp">#define AVIVO_DC_LUT_RW_INDEX                   0x6488</span>
<span class="cp">#define AVIVO_DC_LUT_SEQ_COLOR                  0x648c</span>
<span class="cp">#define AVIVO_DC_LUT_PWL_DATA                   0x6490</span>
<span class="cp">#define AVIVO_DC_LUT_30_COLOR                   0x6494</span>
<span class="cp">#define AVIVO_DC_LUT_READ_PIPE_SELECT           0x6498</span>
<span class="cp">#define AVIVO_DC_LUT_WRITE_EN_MASK              0x649c</span>
<span class="cp">#define AVIVO_DC_LUT_AUTOFILL                   0x64a0</span>

<span class="cp">#define AVIVO_DC_LUTA_CONTROL                   0x64c0</span>
<span class="cp">#define AVIVO_DC_LUTA_BLACK_OFFSET_BLUE         0x64c4</span>
<span class="cp">#define AVIVO_DC_LUTA_BLACK_OFFSET_GREEN        0x64c8</span>
<span class="cp">#define AVIVO_DC_LUTA_BLACK_OFFSET_RED          0x64cc</span>
<span class="cp">#define AVIVO_DC_LUTA_WHITE_OFFSET_BLUE         0x64d0</span>
<span class="cp">#define AVIVO_DC_LUTA_WHITE_OFFSET_GREEN        0x64d4</span>
<span class="cp">#define AVIVO_DC_LUTA_WHITE_OFFSET_RED          0x64d8</span>

<span class="cp">#define AVIVO_DC_LUTB_CONTROL                   0x6cc0</span>
<span class="cp">#define AVIVO_DC_LUTB_BLACK_OFFSET_BLUE         0x6cc4</span>
<span class="cp">#define AVIVO_DC_LUTB_BLACK_OFFSET_GREEN        0x6cc8</span>
<span class="cp">#define AVIVO_DC_LUTB_BLACK_OFFSET_RED          0x6ccc</span>
<span class="cp">#define AVIVO_DC_LUTB_WHITE_OFFSET_BLUE         0x6cd0</span>
<span class="cp">#define AVIVO_DC_LUTB_WHITE_OFFSET_GREEN        0x6cd4</span>
<span class="cp">#define AVIVO_DC_LUTB_WHITE_OFFSET_RED          0x6cd8</span>

    <span class="cm">/*</span>
<span class="cm">     *  Set a single color register. The values supplied are already</span>
<span class="cm">     *  rounded down to the hardware&#39;s capabilities (according to the</span>
<span class="cm">     *  entries in the var structure). Return != 0 for invalid regno.</span>
<span class="cm">     */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">offb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			  <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">offb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">offb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">cr</span> <span class="o">=</span> <span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">cg</span> <span class="o">=</span> <span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">cg</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">cb</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">cmap_simple</span>:
		<span class="n">writeb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_data</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_data</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cmap_M3A</span>:
		<span class="cm">/* Clear PALETTE_ACCESS_CNTL in DAC_CNTL */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">,</span>
			 <span class="n">in_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">cmap_r128</span>:
		<span class="cm">/* Set palette index &amp; data */</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb4</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">blue</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cmap_M3B</span>:
		<span class="cm">/* Set PALETTE_ACCESS_CNTL in DAC_CNTL */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">,</span>
			 <span class="n">in_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="cm">/* Set palette index &amp; data */</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">blue</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cmap_radeon</span>:
		<span class="cm">/* Set palette index &amp; data (could be smarter) */</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">blue</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cmap_gxt2000</span>:
		<span class="n">out_le32</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">)</span> <span class="o">+</span> <span class="n">regno</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">blue</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cmap_avivo</span>:
		<span class="cm">/* Write to both LUTs for now */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_SELECT</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_INDEX</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(((</span><span class="n">red</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">green</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">blue</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		       <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_30_COLOR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_SELECT</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_INDEX</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(((</span><span class="n">red</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">green</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">blue</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		       <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_30_COLOR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     *  Blank the display.</span>
<span class="cm">     */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">offb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">offb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">offb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">blanked</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blank</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">blanked</span> <span class="o">=</span> <span class="n">blank</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">cmap_simple</span>:
				<span class="n">writeb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_data</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cmap_M3A</span>:
				<span class="cm">/* Clear PALETTE_ACCESS_CNTL in DAC_CNTL */</span>
				<span class="n">out_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">,</span>
					 <span class="n">in_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">);</span>
			<span class="k">case</span> <span class="n">cmap_r128</span>:
				<span class="cm">/* Set palette index &amp; data */</span>
				<span class="n">out_8</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">out_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cmap_M3B</span>:
				<span class="cm">/* Set PALETTE_ACCESS_CNTL in DAC_CNTL */</span>
				<span class="n">out_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">,</span>
					 <span class="n">in_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
				<span class="cm">/* Set palette index &amp; data */</span>
				<span class="n">out_8</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">out_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cmap_radeon</span>:
				<span class="n">out_8</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">out_le32</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cmap_gxt2000</span>:
				<span class="n">out_le32</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cmap_avivo</span>:
				<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_SELECT</span><span class="p">);</span>
				<span class="n">writeb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_INDEX</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_30_COLOR</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_SELECT</span><span class="p">);</span>
				<span class="n">writeb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_INDEX</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_30_COLOR</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fb_set_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">offb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">offb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">offb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="cm">/* On avivo, initialize palette control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span> <span class="o">==</span> <span class="n">cmap_avivo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTA_CONTROL</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTA_BLACK_OFFSET_BLUE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTA_BLACK_OFFSET_GREEN</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTA_BLACK_OFFSET_RED</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTA_WHITE_OFFSET_BLUE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTA_WHITE_OFFSET_GREEN</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTA_WHITE_OFFSET_RED</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTB_CONTROL</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTB_BLACK_OFFSET_BLUE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTB_BLACK_OFFSET_GREEN</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTB_BLACK_OFFSET_RED</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTB_WHITE_OFFSET_BLUE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTB_WHITE_OFFSET_GREEN</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUTB_WHITE_OFFSET_RED</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_SELECT</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_MODE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000003f</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_WRITE_EN_MASK</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_SELECT</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_RW_MODE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000003f</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="n">AVIVO_DC_LUT_WRITE_EN_MASK</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">offb_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">apertures</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">base</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">apertures</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">offb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_destroy</span>	<span class="o">=</span> <span class="n">offb_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">offb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">offb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">offb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">offb_map_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">addrp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">asize</span><span class="p">,</span> <span class="n">taddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">addrp</span> <span class="o">=</span> <span class="n">of_get_pci_address</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addrp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">addrp</span> <span class="o">=</span> <span class="n">of_get_address</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addrp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IORESOURCE_IO</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">asize</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">taddr</span> <span class="o">=</span> <span class="n">of_translate_address</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">addrp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">taddr</span> <span class="o">==</span> <span class="n">OF_BAD_ADDR</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">taddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">offb_init_palette_hacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">offb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">offb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ATY,Rage128&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">=</span> <span class="n">offb_map_reg</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1fff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span> <span class="o">=</span> <span class="n">cmap_r128</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ATY,RageM3pA&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
			  <span class="o">||</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ATY,RageM3p12A&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">=</span> <span class="n">offb_map_reg</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1fff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span> <span class="o">=</span> <span class="n">cmap_M3A</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ATY,RageM3pB&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">=</span> <span class="n">offb_map_reg</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1fff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span> <span class="o">=</span> <span class="n">cmap_M3B</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ATY,Rage6&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">=</span> <span class="n">offb_map_reg</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1fff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span> <span class="o">=</span> <span class="n">cmap_radeon</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ATY,&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0xff000000UL</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">=</span>
			<span class="n">ioremap</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x7ff000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xcc0</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_data</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span> <span class="o">=</span> <span class="n">cmap_simple</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;pci1014,b7&quot;</span><span class="p">)</span> <span class="o">||</span>
			  <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;pci1014,21c&quot;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">=</span> <span class="n">offb_map_reg</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span> <span class="o">=</span> <span class="n">cmap_gxt2000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;vga,Display-&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Look for AVIVO initialized by SLOF */</span>
		<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">pciparent</span> <span class="o">=</span> <span class="n">of_get_parent</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vid</span><span class="p">,</span> <span class="o">*</span><span class="n">did</span><span class="p">;</span>
		<span class="n">vid</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">pciparent</span><span class="p">,</span> <span class="s">&quot;vendor-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">did</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">pciparent</span><span class="p">,</span> <span class="s">&quot;device-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="cm">/* This will match most R5xx */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vid</span> <span class="o">&amp;&amp;</span> <span class="n">did</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">vid</span> <span class="o">==</span> <span class="mh">0x1002</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="o">*</span><span class="n">did</span> <span class="o">&gt;=</span> <span class="mh">0x7100</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">did</span> <span class="o">&lt;</span> <span class="mh">0x7800</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="o">*</span><span class="n">did</span> <span class="o">&gt;=</span> <span class="mh">0x9400</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">=</span> <span class="n">offb_map_reg</span><span class="p">(</span><span class="n">pciparent</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">)</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span> <span class="o">=</span> <span class="n">cmap_avivo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">pciparent</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">&amp;&amp;</span> <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;qemu,std-vga&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="n">io_of_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01000000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span> <span class="p">};</span>
		<span class="n">u64</span> <span class="n">io_addr</span> <span class="o">=</span> <span class="n">of_translate_address</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">io_of_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io_addr</span> <span class="o">!=</span> <span class="n">OF_BAD_ADDR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mh">0x3c8</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span> <span class="o">=</span> <span class="n">cmap_simple</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_data</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span> <span class="o">!=</span> <span class="n">cmap_unknown</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">offb_init_fb</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">full_name</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">pitch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">foreign_endian</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">res_size</span> <span class="o">=</span> <span class="n">pitch</span> <span class="o">*</span> <span class="n">height</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">offb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">default_par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">res_start</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res_start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">,</span> <span class="s">&quot;offb&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;Using unsupported %dx%d %s at %lx, depth=%d, pitch=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">pitch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">!=</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">!=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t use depth = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">full_name</span><span class="p">,</span>
		       <span class="n">depth</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res_start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res_start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;OFfb &quot;</span><span class="p">);</span>
	<span class="n">strncat</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;OFfb &quot;</span><span class="p">));</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">pitch</span><span class="p">;</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">pitch</span> <span class="o">*</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_type</span> <span class="o">=</span> <span class="n">cmap_unknown</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">offb_init_palette_hacks</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:		<span class="cm">/* RGB 555 */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:		<span class="cm">/* RGB 565 */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:		<span class="cm">/* RGB 888 */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>

	<span class="cm">/* set offb aperture size for generic probing */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">apertures</span> <span class="o">=</span> <span class="n">alloc_apertures</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">apertures</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_aper</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">apertures</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">apertures</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">offb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_MISC_FIRMWARE</span> <span class="o">|</span> <span class="n">foreign_endian</span><span class="p">;</span>

	<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: Open Firmware frame buffer device on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">full_name</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="nl">out_aper:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cmap_adr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res_start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">offb_init_nodriver</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_real_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">640</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">pitch</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="n">addr_prop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rstart</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">OF_BAD_ADDR</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pp</span><span class="p">,</span> <span class="o">*</span><span class="n">addrp</span><span class="p">,</span> <span class="o">*</span><span class="n">up</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">asize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">foreign_endian</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;little-endian&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">foreign_endian</span> <span class="o">=</span> <span class="n">FBINFO_FOREIGN_ENDIAN</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;big-endian&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">foreign_endian</span> <span class="o">=</span> <span class="n">FBINFO_FOREIGN_ENDIAN</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;linux,bootx-depth&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;depth&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;linux,bootx-width&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;width&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="n">width</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;linux,bootx-height&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;height&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="n">height</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;linux,bootx-linebytes&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;linebytes&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">pp</span> <span class="o">!=</span> <span class="mh">0xffffffffu</span><span class="p">))</span>
		<span class="n">pitch</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pitch</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="p">((</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">rsize</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pitch</span> <span class="o">*</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">height</span><span class="p">;</span>

	<span class="cm">/* Ok, now we try to figure out the address of the framebuffer.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Unfortunately, Open Firmware doesn&#39;t provide a standard way to do</span>
<span class="cm">	 * so. All we can do is a dodgy heuristic that happens to work in</span>
<span class="cm">	 * practice. On most machines, the &quot;address&quot; property contains what</span>
<span class="cm">	 * we need, though not on Matrox cards found in IBM machines. What I&#39;ve</span>
<span class="cm">	 * found that appears to give good results is to go through the PCI</span>
<span class="cm">	 * ranges and pick one that is both big enough and if possible encloses</span>
<span class="cm">	 * the &quot;address&quot; property. If none match, we pick the biggest</span>
<span class="cm">	 */</span>
	<span class="n">up</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;linux,bootx-addr&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">up</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;address&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="n">addr_prop</span> <span class="o">=</span> <span class="o">*</span><span class="n">up</span><span class="p">;</span>

	<span class="cm">/* Hack for when BootX is passing us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">no_real_node</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_addr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">addrp</span> <span class="o">=</span> <span class="n">of_get_address</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">))</span>
		     <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">match_addrp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">asize</span> <span class="o">&lt;</span> <span class="n">rsize</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">rstart</span> <span class="o">=</span> <span class="n">of_translate_address</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">addrp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rstart</span> <span class="o">==</span> <span class="n">OF_BAD_ADDR</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr_prop</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rstart</span> <span class="o">&lt;=</span> <span class="n">addr_prop</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">rstart</span> <span class="o">+</span> <span class="n">asize</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">addr_prop</span> <span class="o">+</span> <span class="n">rsize</span><span class="p">)))</span>
			<span class="n">match_addrp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">match_addrp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">addr_prop</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsize</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_size</span> <span class="o">=</span> <span class="n">rsize</span><span class="p">;</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">OF_BAD_ADDR</span><span class="p">;</span>
 		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="n">OF_BAD_ADDR</span><span class="p">)</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">rstart</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">skip_addr:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="n">OF_BAD_ADDR</span> <span class="o">&amp;&amp;</span> <span class="n">addr_prop</span><span class="p">)</span>
		<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">addr_prop</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">!=</span> <span class="n">OF_BAD_ADDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* kludge for valkyrie */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;valkyrie&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">address</span> <span class="o">+=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="n">offb_init_fb</span><span class="p">(</span><span class="n">no_real_node</span> <span class="o">?</span> <span class="s">&quot;bootx&quot;</span> <span class="o">:</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			     <span class="n">no_real_node</span> <span class="o">?</span> <span class="s">&quot;display&quot;</span> <span class="o">:</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span>
			     <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span>
			     <span class="n">foreign_endian</span><span class="p">,</span> <span class="n">no_real_node</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">dp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">offb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">boot_disp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;offb&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Check if we have a MacOS display without a node spec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">of_chosen</span><span class="p">,</span> <span class="s">&quot;linux,bootx-noscreen&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The old code tried to work out which node was the MacOS</span>
<span class="cm">		 * display based on the address. I&#39;m dropping that since the</span>
<span class="cm">		 * lack of a node spec only happens with old BootX versions</span>
<span class="cm">		 * (users can update) and with this code, they&#39;ll still get</span>
<span class="cm">		 * a display (just not the palette hacks).</span>
<span class="cm">		 */</span>
		<span class="n">offb_init_nodriver</span><span class="p">(</span><span class="n">of_chosen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="p">(</span><span class="n">dp</span> <span class="o">=</span> <span class="n">of_find_node_by_type</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;display&quot;</span><span class="p">));)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;linux,opened&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;linux,boot-display&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">boot_disp</span> <span class="o">=</span> <span class="n">dp</span><span class="p">;</span>
			<span class="n">offb_init_nodriver</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="p">(</span><span class="n">dp</span> <span class="o">=</span> <span class="n">of_find_node_by_type</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;display&quot;</span><span class="p">));)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;linux,opened&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dp</span> <span class="o">!=</span> <span class="n">boot_disp</span><span class="p">)</span>
			<span class="n">offb_init_nodriver</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">offb_init</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
