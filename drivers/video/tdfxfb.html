<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › tdfxfb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tdfxfb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * tdfxfb.c</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Hannu Mallat &lt;hmallat@cc.hut.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 1999 Hannu Mallat</span>
<span class="cm"> * All rights reserved</span>
<span class="cm"> *</span>
<span class="cm"> * Created      : Thu Sep 23 18:17:43 1999, hmallat</span>
<span class="cm"> * Last modified: Tue Nov  2 21:19:47 1999, hmallat</span>
<span class="cm"> *</span>
<span class="cm"> * I2C part copied from the i2c-voodoo3.c driver by:</span>
<span class="cm"> * Frodo Looijaard &lt;frodol@dds.nl&gt;,</span>
<span class="cm"> * Philip Edelbrock &lt;phil@netroedge.com&gt;,</span>
<span class="cm"> * Ralph Metzler &lt;rjkm@thp.uni-koeln.de&gt;, and</span>
<span class="cm"> * Mark D. Studebaker &lt;mdsxyz123@yahoo.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Lots of the information here comes from the Daryll Strauss&#39; Banshee</span>
<span class="cm"> * patches to the XF86 server, and the rest comes from the 3dfx</span>
<span class="cm"> * Banshee specification. I&#39;m very much indebted to Daryll for his</span>
<span class="cm"> * work on the X server.</span>
<span class="cm"> *</span>
<span class="cm"> * Voodoo3 support was contributed Harold Oga. Lots of additions</span>
<span class="cm"> * (proper acceleration, 24 bpp, hardware cursor) and bug fixes by Attila</span>
<span class="cm"> * Kesmarki. Thanks guys!</span>
<span class="cm"> *</span>
<span class="cm"> * Voodoo1 and Voodoo2 support aren&#39;t relevant to this driver as they</span>
<span class="cm"> * behave very differently from the Voodoo3/4/5. For anyone wanting to</span>
<span class="cm"> * use frame buffer on the Voodoo1/2, see the sstfb driver (which is</span>
<span class="cm"> * located at http://www.sourceforge.net/projects/sstfb).</span>
<span class="cm"> *</span>
<span class="cm"> * While I _am_ grateful to 3Dfx for releasing the specs for Banshee,</span>
<span class="cm"> * I do wish the next version is a bit more complete. Without the XF86</span>
<span class="cm"> * patches I couldn&#39;t have gotten even this far... for instance, the</span>
<span class="cm"> * extensions to the VGA register set go completely unmentioned in the</span>
<span class="cm"> * spec! Also, lots of references are made to the &#39;SST core&#39;, but no</span>
<span class="cm"> * spec is publicly available, AFAIK.</span>
<span class="cm"> *</span>
<span class="cm"> * The structure of this driver comes pretty much from the Permedia</span>
<span class="cm"> * driver by Ilario Nardinocchi, which in turn is based on skeletonfb.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> * - multihead support (basically need to support an array of fb_infos)</span>
<span class="cm"> * - support other architectures (PPC, Alpha); does the fact that the VGA</span>
<span class="cm"> *   core can be accessed only thru I/O (not memory mapped) complicate</span>
<span class="cm"> *   things?</span>
<span class="cm"> *</span>
<span class="cm"> * Version history:</span>
<span class="cm"> *</span>
<span class="cm"> * 0.1.4 (released 2002-05-28)	ported over to new fbdev api by James Simmons</span>
<span class="cm"> *</span>
<span class="cm"> * 0.1.3 (released 1999-11-02)	added Attila&#39;s panning support, code</span>
<span class="cm"> *				reorg, hwcursor address page size alignment</span>
<span class="cm"> *				(for mmapping both frame buffer and regs),</span>
<span class="cm"> *				and my changes to get rid of hardcoded</span>
<span class="cm"> *				VGA i/o register locations (uses PCI</span>
<span class="cm"> *				configuration info now)</span>
<span class="cm"> * 0.1.2 (released 1999-10-19)	added Attila Kesmarki&#39;s bug fixes and</span>
<span class="cm"> *				improvements</span>
<span class="cm"> * 0.1.1 (released 1999-10-07)	added Voodoo3 support by Harold Oga.</span>
<span class="cm"> * 0.1.0 (released 1999-10-06)	initial version</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;video/tdfx.h&gt;</span>

<span class="cp">#define DPRINTK(a, b...) pr_debug(&quot;fb: %s: &quot; a, __func__ , ## b)</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#else</span>
<span class="cm">/* duplicate asm/mtrr.h defines to work on archs without mtrr */</span>
<span class="cp">#define MTRR_TYPE_WRCOMB     1</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mtrr_add</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="n">increment</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mtrr_del</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define BANSHEE_MAX_PIXCLOCK 270000</span>
<span class="cp">#define VOODOO3_MAX_PIXCLOCK 300000</span>
<span class="cp">#define VOODOO5_MAX_PIXCLOCK 350000</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">tdfx_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span>		<span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span> <span class="o">=</span>	<span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span> <span class="o">=</span>	<span class="n">FB_ACCEL_3DFX_BANSHEE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">tdfx_var</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* &quot;640x480, 8 bpp @ 60 Hz */</span>
	<span class="p">.</span><span class="n">xres</span> <span class="o">=</span>		<span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span> <span class="o">=</span>		<span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span>	<span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span>	<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">red</span> <span class="o">=</span>		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">blue</span> <span class="o">=</span>		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">green</span> <span class="o">=</span>	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">activate</span> <span class="o">=</span>	<span class="n">FB_ACTIVATE_NOW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span> <span class="o">=</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span> <span class="o">=</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span>	<span class="n">FB_ACCELF_TEXT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span>	<span class="mi">39722</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span> <span class="o">=</span>	<span class="mi">40</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span> <span class="o">=</span>	<span class="mi">24</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span> <span class="o">=</span>	<span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span> <span class="o">=</span>	<span class="mi">11</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsync_len</span> <span class="o">=</span>	<span class="mi">96</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span> <span class="o">=</span>	<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vmode</span> <span class="o">=</span>	<span class="n">FB_VMODE_NONINTERLACED</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * PCI driver prototypes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">tdfxfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">tdfxfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">tdfxfb_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3DFX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3DFX_BANSHEE</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_BASE_CLASS_DISPLAY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span>
	  <span class="mh">0xff0000</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3DFX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3DFX_VOODOO3</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_BASE_CLASS_DISPLAY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span>
	  <span class="mh">0xff0000</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3DFX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3DFX_VOODOO5</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_BASE_CLASS_DISPLAY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span>
	  <span class="mh">0xff0000</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">tdfxfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;tdfxfb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">tdfxfb_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tdfxfb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tdfxfb_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">tdfxfb_id_table</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Driver data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nopan</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nowrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>      <span class="cm">/* not implemented (yet) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hwcursor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__devinitdata</span><span class="p">;</span>
<span class="cm">/* mtrr option */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nomtrr</span> <span class="n">__devinitdata</span><span class="p">;</span>

<span class="cm">/* -------------------------------------------------------------------------</span>
<span class="cm"> *			Hardware-specific funcions</span>
<span class="cm"> * ------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">vga_inb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">-</span> <span class="mh">0x300</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vga_outb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">-</span> <span class="mh">0x300</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gra_outb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">GRA_I</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">GRA_D</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">seq_outb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SEQ_I</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SEQ_D</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">seq_inb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SEQ_I</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">vga_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SEQ_D</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">crt_outb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CRT_I</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CRT_D</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">crt_inb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CRT_I</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">vga_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CRT_D</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">att_outb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">vga_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">IS1_R</span><span class="p">);</span>
	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ATT_IW</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ATT_IW</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vga_disable_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">seq_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">seq_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">seq_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">seq_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vga_enable_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">seq_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xdf</span><span class="p">;</span>
	<span class="n">seq_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">seq_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">seq_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vga_enable_palette</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vga_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">IS1_R</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ATT_IW</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">tdfx_inl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">regbase_virt</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tdfx_outl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">regbase_virt</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">banshee_make_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Note: The Voodoo3&#39;s onboard FIFO has 32 slots. This loop</span>
<span class="cm">	 * won&#39;t quit if you ask for more. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">banshee_wait_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COMMAND_3D</span><span class="p">,</span> <span class="n">COMMAND_3D_NOP</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STATUS_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the color of a palette entry in 8bpp mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">do_setpalentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DACADDR</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
	<span class="cm">/* read after write makes it working */</span>
	<span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DACADDR</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DACDATA</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">do_calc_pll</span><span class="p">(</span><span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">freq_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">best_m</span><span class="p">,</span> <span class="n">best_n</span><span class="p">,</span> <span class="n">best_k</span><span class="p">,</span> <span class="n">best_error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fref</span> <span class="o">=</span> <span class="mi">14318</span><span class="p">;</span>

	<span class="n">best_error</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">best_n</span> <span class="o">=</span> <span class="n">best_m</span> <span class="o">=</span> <span class="n">best_k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span> <span class="n">m</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Estimate value of n that produces target frequency</span>
<span class="cm">			 * with current m and k</span>
<span class="cm">			 */</span>
			<span class="kt">int</span> <span class="n">n_estimated</span> <span class="o">=</span> <span class="p">((</span><span class="n">freq</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">fref</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

			<span class="cm">/* Search neighborhood of estimated n */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_estimated</span><span class="p">);</span>
				<span class="n">n</span> <span class="o">&lt;=</span> <span class="n">min</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="n">n_estimated</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Calculate PLL freqency with current m, k and</span>
<span class="cm">				 * estimated n</span>
<span class="cm">				 */</span>
				<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">fref</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">k</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">freq</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * If this is the closest we&#39;ve come to the</span>
<span class="cm">				 * target frequency then remember n, m and k</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="n">best_error</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">best_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
					<span class="n">best_n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
					<span class="n">best_m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
					<span class="n">best_k</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">best_n</span><span class="p">;</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">best_m</span><span class="p">;</span>
	<span class="n">k</span> <span class="o">=</span> <span class="n">best_k</span><span class="p">;</span>
	<span class="o">*</span><span class="n">freq_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">fref</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">k</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_write_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">banshee_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">banshee_wait_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MISCINIT1</span><span class="p">,</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MISCINIT1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="n">crt_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">crt_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span> <span class="cm">/* CRT unprotect */</span>

	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGAINIT1</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">vgainit1</span> <span class="o">&amp;</span> <span class="mh">0x001FFFFF</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDPROCCFG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">vidcfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00000001</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	tdfx_outl(par, PLLCTRL1, reg-&gt;mempll);</span>
<span class="c">	tdfx_outl(par, PLLCTRL2, reg-&gt;gfxpll);</span>
<span class="cp">#endif</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PLLCTRL0</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">vidpll</span><span class="p">);</span>

	<span class="n">vga_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MISC_W</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">misc</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">crt_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">crt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gra_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">gra</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">att_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">att</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">crt_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">crt_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">vga_enable_palette</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">vga_enable_video</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGAINIT0</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">vgainit0</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DACMODE</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">dacmode</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDDESKSTRIDE</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">HWCURPATADDR</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">curspataddr</span><span class="p">);</span>

	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSCREENSIZE</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">screensize</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDDESKSTART</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">startaddr</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDPROCCFG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">vidcfg</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGAINIT1</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">vgainit1</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MISCINIT0</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">miscinit0</span><span class="p">);</span>

	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SRCBASE</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">startaddr</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTBASE</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">startaddr</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COMMANDEXTRA_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CLIP0MIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CLIP0MAX</span><span class="p">,</span> <span class="mh">0x0fff0fff</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CLIP1MIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CLIP1MAX</span><span class="p">,</span> <span class="mh">0x0fff0fff</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SRCXY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">banshee_wait_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">do_lfb_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">draminit0</span> <span class="o">=</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DRAMINIT0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">draminit1</span> <span class="o">=</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DRAMINIT1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">miscinit1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_chips</span> <span class="o">=</span> <span class="p">(</span><span class="n">draminit0</span> <span class="o">&amp;</span> <span class="n">DRAMINIT0_SGRAM_NUM</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip_size</span><span class="p">;</span> <span class="cm">/* in MB */</span>
	<span class="kt">int</span> <span class="n">has_sgram</span> <span class="o">=</span> <span class="n">draminit1</span> <span class="o">&amp;</span> <span class="n">DRAMINIT1_MEM_SDRAM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">&lt;</span> <span class="n">PCI_DEVICE_ID_3DFX_VOODOO5</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Banshee/Voodoo3 */</span>
		<span class="n">chip_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">has_sgram</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">draminit0</span> <span class="o">&amp;</span> <span class="n">DRAMINIT0_SGRAM_TYPE</span><span class="p">))</span>
			<span class="n">chip_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Voodoo4/5 */</span>
		<span class="n">has_sgram</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip_size</span> <span class="o">=</span> <span class="n">draminit0</span> <span class="o">&amp;</span> <span class="n">DRAMINIT0_SGRAM_TYPE_MASK</span><span class="p">;</span>
		<span class="n">chip_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">chip_size</span> <span class="o">&gt;&gt;</span> <span class="n">DRAMINIT0_SGRAM_TYPE_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable block writes for SDRAM */</span>
	<span class="n">miscinit1</span> <span class="o">=</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MISCINIT1</span><span class="p">);</span>
	<span class="n">miscinit1</span> <span class="o">|=</span> <span class="n">has_sgram</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">MISCINIT1_2DBLOCK_DIS</span><span class="p">;</span>
	<span class="n">miscinit1</span> <span class="o">|=</span> <span class="n">MISCINIT1_CLUT_INV</span><span class="p">;</span>

	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MISCINIT1</span><span class="p">,</span> <span class="n">miscinit1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">num_chips</span> <span class="o">*</span> <span class="n">chip_size</span> <span class="o">*</span> <span class="mi">1024l</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdfxfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lpitch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">8</span>  <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">24</span> <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;depth not supported: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;xoffset not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Banshee doesn&#39;t support interlace, but Voodoo4/5 and probably</span>
<span class="cm">	 * Voodoo3 do.</span>
<span class="cm">	 * no direct information about device id now?</span>
<span class="cm">	 *  use max_pixclock for this...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">max_pixclock</span> <span class="o">&lt;</span> <span class="n">VOODOO3_MAX_PIXCLOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;interlace not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">&amp;&amp;</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span> <span class="o">&amp;&amp;</span> <span class="n">fb_validate_mode</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;mode outside monitor&#39;s specs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span> <span class="cm">/* could sometimes be 8 */</span>
	<span class="n">lpitch</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="mi">320</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;width not supported: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;height not supported: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpitch</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">/</span> <span class="n">lpitch</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no memory for screen (%ux%ux%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">max_pixclock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;pixclock too high (%ldKHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>   <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>   <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Checking graphics mode at %dx%d depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdfxfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hdispend</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hsyncsta</span> <span class="o">=</span> <span class="n">hdispend</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hsyncend</span> <span class="o">=</span> <span class="n">hsyncsta</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">htotal</span>   <span class="o">=</span> <span class="n">hsyncend</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hd</span><span class="p">,</span> <span class="n">hs</span><span class="p">,</span> <span class="n">he</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">hbs</span><span class="p">,</span> <span class="n">hbe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vd</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">ve</span><span class="p">,</span> <span class="n">vt</span><span class="p">,</span> <span class="n">vbs</span><span class="p">,</span> <span class="n">vbe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">banshee_reg</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fout</span><span class="p">,</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cpp</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>

	<span class="n">reg</span><span class="p">.</span><span class="n">vidcfg</span> <span class="o">=</span> <span class="n">VIDCFG_VIDPROC_ENABLE</span> <span class="o">|</span> <span class="n">VIDCFG_DESK_ENABLE</span> <span class="o">|</span>
		     <span class="n">VIDCFG_CURS_X11</span> <span class="o">|</span>
		     <span class="p">((</span><span class="n">cpp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">VIDCFG_PIXFMT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">cpp</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">VIDCFG_CLUT_BYPASS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* PLL settings */</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">);</span>

	<span class="n">reg</span><span class="p">.</span><span class="n">vidcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIDCFG_2X</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">max_pixclock</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">max_pixclock</span> <span class="o">?</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">max_pixclock</span> <span class="o">:</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">dacmode</span> <span class="o">|=</span> <span class="n">DACMODE_2X</span><span class="p">;</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">vidcfg</span>  <span class="o">|=</span> <span class="n">VIDCFG_2X</span><span class="p">;</span>
		<span class="n">hdispend</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hsyncsta</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hsyncend</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">htotal</span>   <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wd</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdispend</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hd</span>  <span class="o">=</span> <span class="n">wd</span><span class="p">;</span>
	<span class="n">hs</span>  <span class="o">=</span> <span class="p">(</span><span class="n">hsyncsta</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">he</span>  <span class="o">=</span> <span class="p">(</span><span class="n">hsyncend</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ht</span>  <span class="o">=</span> <span class="p">(</span><span class="n">htotal</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hbs</span> <span class="o">=</span> <span class="n">hd</span><span class="p">;</span>
	<span class="n">hbe</span> <span class="o">=</span> <span class="n">ht</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vd</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vs</span>  <span class="o">=</span> <span class="n">vd</span> <span class="o">+</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ve</span>  <span class="o">=</span> <span class="n">vs</span> <span class="o">+</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">vt</span> <span class="o">=</span> <span class="n">ve</span> <span class="o">+</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">screensize</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">vidcfg</span> <span class="o">|=</span> <span class="n">VIDCFG_HALF_MODE</span><span class="p">;</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vd</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vs</span>  <span class="o">=</span> <span class="n">vd</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span><span class="p">;</span>
		<span class="n">ve</span>  <span class="o">=</span> <span class="n">vs</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">;</span>
		<span class="n">vt</span> <span class="o">=</span> <span class="n">ve</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">screensize</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">vidcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIDCFG_HALF_MODE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vbs</span> <span class="o">=</span> <span class="n">vd</span><span class="p">;</span>
	<span class="n">vbe</span> <span class="o">=</span> <span class="n">vt</span><span class="p">;</span>

	<span class="cm">/* this is all pretty standard VGA register stuffing */</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">misc</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="mi">400</span> <span class="o">?</span> <span class="mh">0xa0</span> <span class="o">:</span>
			 <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="mi">480</span> <span class="o">?</span> <span class="mh">0x60</span> <span class="o">:</span>
			 <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="mi">768</span> <span class="o">?</span> <span class="mh">0xe0</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">reg</span><span class="p">.</span><span class="n">gra</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">gra</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">gra</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">gra</span><span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0d</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">att</span><span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="n">reg</span><span class="p">.</span><span class="n">seq</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">seq</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* fixme: clkdiv2? */</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">seq</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">seq</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">seq</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">;</span>

	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">ht</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="n">hd</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="n">hbs</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">hbe</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="n">hs</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">hbe</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">he</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">vs</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">vd</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">vt</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">vbs</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">vs</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">vd</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">vt</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="p">((</span><span class="n">vbs</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="n">vs</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ve</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="n">vd</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="n">wd</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">=</span> <span class="n">vbs</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x16</span><span class="p">]</span> <span class="o">=</span> <span class="n">vbe</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xc3</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">crt</span><span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* Banshee&#39;s nonvga stuff */</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">ext</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">ht</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">hd</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">hbs</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">hbe</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">hs</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">he</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">ext</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">vt</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">vd</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">vbs</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">vbe</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">reg</span><span class="p">.</span><span class="n">vgainit0</span> <span class="o">=</span>	<span class="n">VGAINIT0_8BIT_DAC</span>     <span class="o">|</span>
			<span class="n">VGAINIT0_EXT_ENABLE</span>   <span class="o">|</span>
			<span class="n">VGAINIT0_WAKEUP_3C3</span>   <span class="o">|</span>
			<span class="n">VGAINIT0_ALT_READBACK</span> <span class="o">|</span>
			<span class="n">VGAINIT0_EXTSHIFTOUT</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">vgainit1</span> <span class="o">=</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGAINIT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwcursor</span><span class="p">)</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">curspataddr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>

	<span class="n">reg</span><span class="p">.</span><span class="n">cursloc</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span><span class="p">.</span><span class="n">cursc0</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">cursc1</span>    <span class="o">=</span> <span class="mh">0xffffff</span><span class="p">;</span>

	<span class="n">reg</span><span class="p">.</span><span class="n">stride</span>    <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="n">cpp</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">startaddr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">reg</span><span class="p">.</span><span class="n">stride</span>
			<span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">*</span> <span class="n">cpp</span><span class="p">;</span>

	<span class="n">reg</span><span class="p">.</span><span class="n">vidpll</span> <span class="o">=</span> <span class="n">do_calc_pll</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fout</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	reg.mempll = do_calc_pll(..., &amp;fout);</span>
<span class="c">	reg.gfxpll = do_calc_pll(..., &amp;fout);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">vidcfg</span> <span class="o">|=</span> <span class="n">VIDCFG_INTERLACE</span><span class="p">;</span>
	<span class="n">reg</span><span class="p">.</span><span class="n">miscinit0</span> <span class="o">=</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MISCINIT0</span><span class="p">);</span>

<span class="cp">#if defined(__BIG_ENDIAN)</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">reg</span><span class="p">.</span><span class="n">miscinit0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">miscinit0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">reg</span><span class="p">.</span><span class="n">miscinit0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">miscinit0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">reg</span><span class="p">.</span><span class="n">miscinit0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
		<span class="n">reg</span><span class="p">.</span><span class="n">miscinit0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">do_write_regs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Now change fb_fix_screeninfo according to changes in par */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="n">stride</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
				<span class="o">?</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>
				<span class="o">:</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Graphics mode is now set at %dx%d depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* A handy macro shamelessly pinched from matroxfb */</span>
<span class="cp">#define CNVT_TOHW(val, width) ((((val) &lt;&lt; (width)) + 0x7FFF - (val)) &gt;&gt; 16)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdfxfb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rgbcol</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span> <span class="o">||</span> <span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* grayscale works only partially under directcolor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* grayscale = 0.30*R + 0.59*G + 0.11*B */</span>
		<span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">*</span> <span class="mi">77</span> <span class="o">+</span> <span class="n">green</span> <span class="o">*</span> <span class="mi">151</span> <span class="o">+</span> <span class="n">blue</span> <span class="o">*</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">green</span> <span class="o">=</span> <span class="n">blue</span><span class="p">;</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">blue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="n">rgbcol</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">red</span>   <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">blue</span>  <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">do_setpalentry</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">rgbcol</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* Truecolor has no hardware color palettes. */</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rgbcol</span> <span class="o">=</span> <span class="p">(</span><span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">transp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgbcol</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;bad depth %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 0 unblank, 1 blank, 2 no vsync, 3 no hsync, 4 off */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdfxfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vgablank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dacmode</span> <span class="o">=</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DACMODE</span><span class="p">);</span>

	<span class="n">dacmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>: <span class="cm">/* Screen: On; HSync: On, VSync: On */</span>
		<span class="n">vgablank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>: <span class="cm">/* Screen: Off; HSync: On, VSync: On */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>: <span class="cm">/* Screen: Off; HSync: On, VSync: Off */</span>
		<span class="n">dacmode</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>: <span class="cm">/* Screen: Off; HSync: Off, VSync: On */</span>
		<span class="n">dacmode</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>: <span class="cm">/* Screen: Off; HSync: Off, VSync: Off */</span>
		<span class="n">dacmode</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DACMODE</span><span class="p">,</span> <span class="n">dacmode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vgablank</span><span class="p">)</span>
		<span class="n">vga_disable_video</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vga_enable_video</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the starting position of the visible screen to var-&gt;yoffset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdfxfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nopan</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDDESKSTART</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_3DFX_ACCEL</span>
<span class="cm">/*</span>
<span class="cm"> * FillRect 2D command (solidfill or invert (via ROP_XOR))</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tdfxfb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fmt</span> <span class="o">=</span> <span class="n">stride</span> <span class="o">|</span> <span class="p">((</span><span class="n">bpp</span> <span class="o">+</span> <span class="p">((</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tdfx_rop</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dstbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">==</span> <span class="n">ROP_COPY</span><span class="p">)</span>
		<span class="n">tdfx_rop</span> <span class="o">=</span> <span class="n">TDFX_ROP_COPY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tdfx_rop</span> <span class="o">=</span> <span class="n">TDFX_ROP_XOR</span><span class="p">;</span>

	<span class="cm">/* assume always rect-&gt;height &lt; 4096 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dstbase</span> <span class="o">=</span> <span class="n">stride</span> <span class="o">*</span> <span class="n">dy</span><span class="p">;</span>
		<span class="n">dy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* assume always rect-&gt;width &lt; 4096 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dstbase</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">dx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTFORMAT</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COLORFORE</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* FB_VISUAL_TRUECOLOR */</span>
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COLORFORE</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COMMAND_2D</span><span class="p">,</span> <span class="n">COMMAND_2D_FILLRECT</span> <span class="o">|</span> <span class="p">(</span><span class="n">tdfx_rop</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTBASE</span><span class="p">,</span> <span class="n">dstbase</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTSIZE</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">|</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">LAUNCH_2D</span><span class="p">,</span> <span class="n">dx</span> <span class="o">|</span> <span class="p">(</span><span class="n">dy</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Screen-to-Screen BitBlt 2D command (for the bmove fb op.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tdfxfb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">blitcmd</span> <span class="o">=</span> <span class="n">COMMAND_2D_S2S_BITBLT</span> <span class="o">|</span> <span class="p">(</span><span class="n">TDFX_ROP_COPY</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fmt</span> <span class="o">=</span> <span class="n">stride</span> <span class="o">|</span> <span class="p">((</span><span class="n">bpp</span> <span class="o">+</span> <span class="p">((</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">dstbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">srcbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* assume always area-&gt;height &lt; 4096 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sy</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srcbase</span> <span class="o">=</span> <span class="n">stride</span> <span class="o">*</span> <span class="n">sy</span><span class="p">;</span>
		<span class="n">sy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* assume always area-&gt;width &lt; 4096 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sx</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srcbase</span> <span class="o">+=</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">sx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* assume always area-&gt;height &lt; 4096 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dstbase</span> <span class="o">=</span> <span class="n">stride</span> <span class="o">*</span> <span class="n">dy</span><span class="p">;</span>
		<span class="n">dy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* assume always area-&gt;width &lt; 4096 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dstbase</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">dx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">&lt;=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* -X */</span>
		<span class="n">blitcmd</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
		<span class="n">sx</span> <span class="o">+=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dx</span> <span class="o">+=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">&lt;=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* -Y */</span>
		<span class="n">blitcmd</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
		<span class="n">sy</span> <span class="o">+=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dy</span> <span class="o">+=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SRCFORMAT</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTFORMAT</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COMMAND_2D</span><span class="p">,</span> <span class="n">blitcmd</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTSIZE</span><span class="p">,</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">|</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTXY</span><span class="p">,</span> <span class="n">dx</span> <span class="o">|</span> <span class="p">(</span><span class="n">dy</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SRCBASE</span><span class="p">,</span> <span class="n">srcbase</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTBASE</span><span class="p">,</span> <span class="n">dstbase</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">LAUNCH_2D</span><span class="p">,</span> <span class="n">sx</span> <span class="o">|</span> <span class="p">(</span><span class="n">sy</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tdfxfb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">fifo_free</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dstfmt</span> <span class="o">=</span> <span class="n">stride</span> <span class="o">|</span> <span class="p">((</span><span class="n">bpp</span> <span class="o">+</span> <span class="p">((</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">chardata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">srcfmt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dstbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef BROKEN_CODE</span>
		<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">((</span><span class="n">size</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">srcfmt</span> <span class="o">=</span> <span class="n">stride</span> <span class="o">|</span> <span class="p">((</span><span class="n">bpp</span> <span class="o">+</span> <span class="p">((</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
			<span class="mh">0x400000</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COLORFORE</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">);</span>
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COLORBACK</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
	<span class="nl">default:</span>
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COLORFORE</span><span class="p">,</span>
			  <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">]);</span>
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COLORBACK</span><span class="p">,</span>
			  <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">srcfmt</span> <span class="o">=</span> <span class="mh">0x400000</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">srcfmt</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* assume always image-&gt;height &lt; 4096 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dstbase</span> <span class="o">=</span> <span class="n">stride</span> <span class="o">*</span> <span class="n">dy</span><span class="p">;</span>
		<span class="n">dy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* assume always image-&gt;width &lt; 4096 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dstbase</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">dx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTBASE</span><span class="p">,</span> <span class="n">dstbase</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SRCXY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTXY</span><span class="p">,</span> <span class="n">dx</span> <span class="o">|</span> <span class="p">(</span><span class="n">dy</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COMMAND_2D</span><span class="p">,</span>
		  <span class="n">COMMAND_2D_H2S_BITBLT</span> <span class="o">|</span> <span class="p">(</span><span class="n">TDFX_ROP_COPY</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SRCFORMAT</span><span class="p">,</span> <span class="n">srcfmt</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTFORMAT</span><span class="p">,</span> <span class="n">dstfmt</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DSTSIZE</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">|</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* A count of how many free FIFO entries we&#39;ve requested.</span>
<span class="cm">	 * When this goes negative, we need to request more. */</span>
	<span class="n">fifo_free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Send four bytes at a time of data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">fifo_free</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fifo_free</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
			<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">fifo_free</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">LAUNCH_2D</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">chardata</span><span class="p">);</span>
		<span class="n">chardata</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send the leftovers now */</span>
	<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">LAUNCH_2D</span><span class="p">,</span> <span class="o">*</span><span class="n">chardata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">LAUNCH_2D</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">chardata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">LAUNCH_2D</span><span class="p">,</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">chardata</span> <span class="o">|</span> <span class="p">(</span><span class="n">chardata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_3DFX_ACCEL */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdfxfb_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_cursor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vidcfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwcursor</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* just to force soft_cursor() call */</span>

	<span class="cm">/* Too large of a cursor or wrong bpp :-( */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">||</span>
	    <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">||</span>
	    <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">vidcfg</span> <span class="o">=</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDPROCCFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDPROCCFG</span><span class="p">,</span> <span class="n">vidcfg</span> <span class="o">|</span> <span class="n">VIDCFG_HWCURSOR_ENABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDPROCCFG</span><span class="p">,</span> <span class="n">vidcfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VIDCFG_HWCURSOR_ENABLE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the cursor is not be changed this means either we want the</span>
<span class="cm">	 * current cursor state (if enable is set) or we want to query what</span>
<span class="cm">	 * we can do with the cursor (if enable is not set)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* fix cursor color - XFree86 forgets to restore it properly */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETCMAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_cmap</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">bg_idx</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">bg_color</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">fg_idx</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">fg_color</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bg_color</span><span class="p">,</span> <span class="n">fg_color</span><span class="p">;</span>

		<span class="n">fg_color</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span>   <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span>  <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">bg_color</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span>   <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span>  <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">HWCURC0</span><span class="p">,</span> <span class="n">bg_color</span><span class="p">);</span>
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">HWCURC1</span><span class="p">,</span> <span class="n">fg_color</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETPOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">dy</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span><span class="p">;</span>

		<span class="n">x</span> <span class="o">+=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">+=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">banshee_make_room</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">HWCURLOC</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FB_CUR_SETIMAGE</span> <span class="o">|</span> <span class="n">FB_CUR_SETSHAPE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Voodoo 3 and above cards use 2 monochrome cursor patterns.</span>
<span class="cm">		 *    The reason is so the card can fetch 8 words at a time</span>
<span class="cm">		 * and are stored on chip for use for the next 8 scanlines.</span>
<span class="cm">		 * This reduces the number of times for access to draw the</span>
<span class="cm">		 * cursor for each screen refresh.</span>
<span class="cm">		 *    Each pattern is a bitmap of 64 bit wide and 64 bit high</span>
<span class="cm">		 * (total of 8192 bits or 1024 bytes). The two patterns are</span>
<span class="cm">		 * stored in such a way that pattern 0 always resides in the</span>
<span class="cm">		 * lower half (least significant 64 bits) of a 128 bit word</span>
<span class="cm">		 * and pattern 1 the upper half. If you examine the data of</span>
<span class="cm">		 * the cursor image the graphics card uses then from the</span>
<span class="cm">		 * beginning you see line one of pattern 0, line one of</span>
<span class="cm">		 * pattern 1, line two of pattern 0, line two of pattern 1,</span>
<span class="cm">		 * etc etc. The linear stride for the cursor is always 16 bytes</span>
<span class="cm">		 * (128 bits) which is the maximum cursor width times two for</span>
<span class="cm">		 * the two monochrome patterns.</span>
<span class="cm">		 */</span>
		<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cursorbase</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">fb_memset</span><span class="p">(</span><span class="n">cursorbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">mask</span> <span class="o">^</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">==</span> <span class="n">ROP_COPY</span><span class="p">)</span>
					<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
				<span class="cm">/* Pattern 0. Copy the cursor mask to it */</span>
				<span class="n">fb_writeb</span><span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">cursorbase</span> <span class="o">+</span> <span class="n">h</span><span class="p">);</span>
				<span class="n">mask</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* Pattern 1. Copy the cursor bitmap to it */</span>
				<span class="n">fb_writeb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cursorbase</span> <span class="o">+</span> <span class="n">h</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">bitmap</span><span class="o">++</span><span class="p">;</span>
				<span class="n">h</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cursorbase</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">tdfxfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">tdfxfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">tdfxfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">tdfxfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">tdfxfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">tdfxfb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_sync</span>	<span class="o">=</span> <span class="n">banshee_wait_idle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_cursor</span>	<span class="o">=</span> <span class="n">tdfxfb_cursor</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_FB_3DFX_ACCEL</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">tdfxfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">tdfxfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">tdfxfb_imageblit</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_FB_3DFX_I2C</span>
<span class="cm">/* The voo GPIO registers don&#39;t have individual masks for each bit</span>
<span class="cm">   so we always have to read before writing. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tdfxfb_i2c_setscl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfxfb_i2c_chan</span> 	<span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> 	<span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">I2C_SCL_OUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I2C_SCL_OUT</span><span class="p">;</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tdfxfb_i2c_setsda</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfxfb_i2c_chan</span> 	<span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> 	<span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">I2C_SDA_OUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I2C_SDA_OUT</span><span class="p">;</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>
<span class="p">}</span>

<span class="cm">/* The GPIO pins are open drain, so the pins always remain outputs.</span>
<span class="cm">   We rely on the i2c-algo-bit routines to set the pins high before</span>
<span class="cm">   reading the input from other chips. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdfxfb_i2c_getscl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfxfb_i2c_chan</span> 	<span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> 	<span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I2C_SCL_IN</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdfxfb_i2c_getsda</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfxfb_i2c_chan</span> 	<span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> 	<span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I2C_SDA_IN</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tdfxfb_ddc_setscl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfxfb_i2c_chan</span> 	<span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> 	<span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">DDC_SCL_OUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DDC_SCL_OUT</span><span class="p">;</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tdfxfb_ddc_setsda</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfxfb_i2c_chan</span> 	<span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> 	<span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">DDC_SDA_OUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DDC_SDA_OUT</span><span class="p">;</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdfxfb_ddc_getscl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfxfb_i2c_chan</span> 	<span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> 	<span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DDC_SCL_IN</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdfxfb_ddc_getsda</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfxfb_i2c_chan</span> 	<span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> 	<span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tdfx_inl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DDC_SDA_IN</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tdfxfb_setup_ddc_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfxfb_i2c_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">class</span>		<span class="o">=</span> <span class="n">I2C_CLASS_DDC</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">algo_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span>	<span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">setsda</span>		<span class="o">=</span> <span class="n">tdfxfb_ddc_setsda</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">setscl</span>		<span class="o">=</span> <span class="n">tdfxfb_ddc_setscl</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">getsda</span>		<span class="o">=</span> <span class="n">tdfxfb_ddc_getsda</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">getscl</span>		<span class="o">=</span> <span class="n">tdfxfb_ddc_getscl</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">udelay</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">timeout</span>		<span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">data</span> 		<span class="o">=</span> <span class="n">chan</span><span class="p">;</span>

	<span class="n">i2c_set_adapdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_bit_add_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;I2C bus %s registered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tdfxfb_setup_i2c_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfxfb_i2c_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">algo_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span>	<span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">setsda</span>		<span class="o">=</span> <span class="n">tdfxfb_i2c_setsda</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">setscl</span>		<span class="o">=</span> <span class="n">tdfxfb_i2c_setscl</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">getsda</span>		<span class="o">=</span> <span class="n">tdfxfb_i2c_getsda</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">getscl</span>		<span class="o">=</span> <span class="n">tdfxfb_i2c_getscl</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">udelay</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">timeout</span>		<span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">data</span> 		<span class="o">=</span> <span class="n">chan</span><span class="p">;</span>

	<span class="n">i2c_set_adapdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_bit_add_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;I2C bus %s registered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tdfxfb_create_i2c_busses</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDINFORMAT</span><span class="p">,</span> <span class="mh">0x8160</span><span class="p">);</span>
	<span class="n">tdfx_outl</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VIDSERPARPORT</span><span class="p">,</span> <span class="mh">0xcffc0020</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">par</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">par</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>

	<span class="n">tdfxfb_setup_ddc_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;Voodoo3-DDC&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tdfxfb_setup_i2c_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;Voodoo3-I2C&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tdfxfb_delete_i2c_busses</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">par</span><span class="p">)</span>
		<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">par</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">par</span><span class="p">)</span>
		<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">par</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdfxfb_probe_i2c_connector</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">edid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Probe DDC Bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">par</span><span class="p">)</span>
		<span class="n">edid</span> <span class="o">=</span> <span class="n">fb_ddc_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_edid_to_monspecs</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="n">specs</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_3DFX_I2C */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> *      tdfxfb_probe - Device Initializiation</span>
<span class="cm"> *</span>
<span class="cm"> *      @pdev:  PCI Device to initialize</span>
<span class="cm"> *      @id:    PCI Device ID</span>
<span class="cm"> *</span>
<span class="cm"> *      Initializes and allocates resources for PCI device @pdev.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tdfxfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">default_par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">lpitch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tdfxfb: Can&#39;t enable pdev: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tdfx_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">default_par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">tdfx_fix</span><span class="p">;</span>

	<span class="cm">/* Configure the default fb_fix_screeninfo first */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_3DFX_BANSHEE</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;3Dfx Banshee&quot;</span><span class="p">);</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">max_pixclock</span> <span class="o">=</span> <span class="n">BANSHEE_MAX_PIXCLOCK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_3DFX_VOODOO3</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;3Dfx Voodoo3&quot;</span><span class="p">);</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">max_pixclock</span> <span class="o">=</span> <span class="n">VOODOO3_MAX_PIXCLOCK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_3DFX_VOODOO5</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;3Dfx Voodoo5&quot;</span><span class="p">);</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">max_pixclock</span> <span class="o">=</span> <span class="n">VOODOO5_MAX_PIXCLOCK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">,</span>
				<span class="s">&quot;tdfx regbase&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tdfxfb: Can&#39;t reserve regbase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">regbase_virt</span> <span class="o">=</span>
		<span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">regbase_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;fb: Can&#39;t remap %s register area.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_regbase</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">do_lfb_size</span><span class="p">(</span><span class="n">default_par</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;fb: Can&#39;t count %s memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_regbase</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
				<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;tdfx smem&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tdfxfb: Can&#39;t reserve smem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_regbase</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
					    <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;fb: Can&#39;t remap %s framebuffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_screenbase</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s">&quot;tdfx iobase&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tdfxfb: Can&#39;t reserve iobase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_screenbase</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb: %s memory = %dK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nomtrr</span><span class="p">)</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span> <span class="o">=</span>
			<span class="n">mtrr_add</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
				 <span class="n">MTRR_TYPE_WRCOMB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span>	<span class="o">=</span> <span class="n">nopan</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span>	<span class="o">=</span> <span class="n">nowrap</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tdfxfb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span>	<span class="o">=</span> <span class="n">default_par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_3DFX_ACCEL</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">|=</span> <span class="n">FBINFO_HWACCEL_FILLRECT</span> <span class="o">|</span>
				   <span class="n">FBINFO_HWACCEL_COPYAREA</span> <span class="o">|</span>
				   <span class="n">FBINFO_HWACCEL_IMAGEBLIT</span> <span class="o">|</span>
				   <span class="n">FBINFO_READS_FAST</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* reserve 8192 bits for cursor */</span>
	<span class="cm">/* the 2.4 driver says PAGE_MASK boundary is not enough for Voodoo4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwcursor</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">-</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">PAGE_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">specs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">;</span>
	<span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_3DFX_I2C</span>
	<span class="n">tdfxfb_create_i2c_busses</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tdfxfb_probe_i2c_connector</span><span class="p">(</span><span class="n">default_par</span><span class="p">,</span> <span class="n">specs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Unable to get Mode Database</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

			<span class="n">fb_videomode_to_modelist</span><span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">,</span>
						 <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">fb_find_best_display</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fb_videomode_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
				<span class="cm">/* fill all other info-&gt;var&#39;s fields */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tdfxfb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">tdfx_var</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_option</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="n">mode_option</span> <span class="o">=</span> <span class="s">&quot;640x480@60&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode_option</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span>
				   <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">tdfx_var</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_destroy_modedb</span><span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* maximize virtual vertical length */</span>
	<span class="n">lpitch</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">/</span> <span class="n">lpitch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err_iobase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tdfxfb: Can&#39;t allocate color map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_iobase</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tdfxfb: can&#39;t register framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_iobase</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Our driver data</span>
<span class="cm">	 */</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err_iobase:</span>
<span class="cp">#ifdef CONFIG_FB_3DFX_I2C</span>
	<span class="n">tdfxfb_delete_i2c_busses</span><span class="p">(</span><span class="n">default_par</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
			 <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
		       <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
<span class="nl">out_err_screenbase:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="nl">out_err_regbase:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Cleanup after anything that was remapped/allocated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">regbase_virt</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">regbase_virt</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">tdfxfb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nopan&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nopan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nowrap&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nowrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;hwcursor=&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hwcursor</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nomtrr&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nomtrr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> *      tdfxfb_remove - Device removal</span>
<span class="cm"> *</span>
<span class="cm"> *      @pdev:  PCI Device to cleanup</span>
<span class="cm"> *</span>
<span class="cm"> *      Releases all resources allocated during the course of the driver&#39;s</span>
<span class="cm"> *      lifetime for the PCI device @pdev.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">tdfxfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tdfx_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_FB_3DFX_I2C</span>
	<span class="n">tdfxfb_delete_i2c_busses</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
			 <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">regbase_virt</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>

	<span class="cm">/* Clean up after reserved regions */</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
		       <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tdfxfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;tdfxfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">tdfxfb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdfxfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tdfxfb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdfxfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Hannu Mallat &lt;hmallat@cc.hut.fi&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;3Dfx framebuffer device driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">hwcursor</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hwcursor</span><span class="p">,</span> <span class="s">&quot;Enable hardware cursor &quot;</span>
			<span class="s">&quot;(1=enable, 0=disable, default=1)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="s">&quot;Initial video mode e.g. &#39;648x480-8@60&#39;&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nomtrr</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nomtrr</span><span class="p">,</span> <span class="s">&quot;Disable MTRR support (default: enabled)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tdfxfb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tdfxfb_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
