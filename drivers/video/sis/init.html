<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › sis › init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $XFree86$ */</span>
<span class="cm">/* $XdotOrg$ */</span>
<span class="cm">/*</span>
<span class="cm"> * Mode initializing code (CRT1 section) for</span>
<span class="cm"> * for SiS 300/305/540/630/730,</span>
<span class="cm"> *     SiS 315/550/[M]650/651/[M]661[FGM]X/[M]74x[GX]/330/[M]76x[GX],</span>
<span class="cm"> *     XGI Volari V3XT/V5/V8, Z7</span>
<span class="cm"> * (Universal module for Linux kernel framebuffer and X.org/XFree86 4.x)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001-2005 by Thomas Winischhofer, Vienna, Austria</span>
<span class="cm"> *</span>
<span class="cm"> * If distributed as part of the Linux kernel, the following license terms</span>
<span class="cm"> * apply:</span>
<span class="cm"> *</span>
<span class="cm"> * * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * * the Free Software Foundation; either version 2 of the named License,</span>
<span class="cm"> * * or any later version.</span>
<span class="cm"> * *</span>
<span class="cm"> * * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> * * GNU General Public License for more details.</span>
<span class="cm"> * *</span>
<span class="cm"> * * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * * along with this program; if not, write to the Free Software</span>
<span class="cm"> * * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA</span>
<span class="cm"> *</span>
<span class="cm"> * Otherwise, the following license terms apply:</span>
<span class="cm"> *</span>
<span class="cm"> * * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * * modification, are permitted provided that the following conditions</span>
<span class="cm"> * * are met:</span>
<span class="cm"> * * 1) Redistributions of source code must retain the above copyright</span>
<span class="cm"> * *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * * 2) Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> * *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> * *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> * * 3) The name of the author may not be used to endorse or promote products</span>
<span class="cm"> * *    derived from this software without specific prior written permission.</span>
<span class="cm"> * *</span>
<span class="cm"> * * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS&#39;&#39; AND ANY EXPRESS OR</span>
<span class="cm"> * * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
<span class="cm"> * * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
<span class="cm"> * * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="cm"> * * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<span class="cm"> * * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm"> * * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="cm"> * * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="cm"> * * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: 	Thomas Winischhofer &lt;thomas@winischhofer.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Formerly based on non-functional code-fragements for 300 series by SiS, Inc.</span>
<span class="cm"> * Used by permission.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;init.h&quot;</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
<span class="cp">#include &quot;300vtbl.h&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
<span class="cp">#include &quot;310vtbl.h&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(ALLOC_PRAGMA)</span>
<span class="cp">#pragma alloc_text(PAGE,SiSSetMode)</span>
<span class="cp">#endif</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*         POINTER INITIALIZATION            */</span>
<span class="cm">/*********************************************/</span>

<span class="cp">#if defined(CONFIG_FB_SIS_300) || defined(CONFIG_FB_SIS_315)</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">InitCommonPointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SModeIDTable</span>  <span class="o">=</span> <span class="n">SiS_SModeIDTable</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StResInfo</span>     <span class="o">=</span> <span class="n">SiS_StResInfo</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeResInfo</span>   <span class="o">=</span> <span class="n">SiS_ModeResInfo</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StandTable</span>    <span class="o">=</span> <span class="n">SiS_StandTable</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_NTSCTiming</span>     <span class="o">=</span> <span class="n">SiS_NTSCTiming</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PALTiming</span>      <span class="o">=</span> <span class="n">SiS_PALTiming</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_HiTVSt1Timing</span>  <span class="o">=</span> <span class="n">SiS_HiTVSt1Timing</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_HiTVSt2Timing</span>  <span class="o">=</span> <span class="n">SiS_HiTVSt2Timing</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_HiTVExtTiming</span>  <span class="o">=</span> <span class="n">SiS_HiTVExtTiming</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_HiTVGroup3Data</span> <span class="o">=</span> <span class="n">SiS_HiTVGroup3Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_HiTVGroup3Simu</span> <span class="o">=</span> <span class="n">SiS_HiTVGroup3Simu</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">   SiS_Pr-&gt;SiS_HiTVTextTiming = SiS_HiTVTextTiming;</span>
<span class="c">   SiS_Pr-&gt;SiS_HiTVGroup3Text = SiS_HiTVGroup3Text;</span>
<span class="cp">#endif</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StPALData</span>   <span class="o">=</span> <span class="n">SiS_StPALData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ExtPALData</span>  <span class="o">=</span> <span class="n">SiS_ExtPALData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StNTSCData</span>  <span class="o">=</span> <span class="n">SiS_StNTSCData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ExtNTSCData</span> <span class="o">=</span> <span class="n">SiS_ExtNTSCData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_St1HiTVData</span> <span class="o">=</span> <span class="n">SiS_StHiTVData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_St2HiTVData</span> <span class="o">=</span> <span class="n">SiS_St2HiTVData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ExtHiTVData</span> <span class="o">=</span> <span class="n">SiS_ExtHiTVData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_St525iData</span>  <span class="o">=</span> <span class="n">SiS_StNTSCData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_St525pData</span>  <span class="o">=</span> <span class="n">SiS_St525pData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_St750pData</span>  <span class="o">=</span> <span class="n">SiS_St750pData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Ext525iData</span> <span class="o">=</span> <span class="n">SiS_ExtNTSCData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Ext525pData</span> <span class="o">=</span> <span class="n">SiS_ExtNTSCData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Ext750pData</span> <span class="o">=</span> <span class="n">SiS_Ext750pData</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">pSiS_OutputSelect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SiS_OutputSelect</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">pSiS_SoftSetting</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">SiS_SoftSetting</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCD1280x720Data</span>      <span class="o">=</span> <span class="n">SiS_LCD1280x720Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StLCD1280x768_2Data</span>  <span class="o">=</span> <span class="n">SiS_StLCD1280x768_2Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ExtLCD1280x768_2Data</span> <span class="o">=</span> <span class="n">SiS_ExtLCD1280x768_2Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCD1280x800Data</span>      <span class="o">=</span> <span class="n">SiS_LCD1280x800Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCD1280x800_2Data</span>    <span class="o">=</span> <span class="n">SiS_LCD1280x800_2Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCD1280x854Data</span>      <span class="o">=</span> <span class="n">SiS_LCD1280x854Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCD1280x960Data</span>      <span class="o">=</span> <span class="n">SiS_LCD1280x960Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StLCD1400x1050Data</span>   <span class="o">=</span> <span class="n">SiS_StLCD1400x1050Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ExtLCD1400x1050Data</span>  <span class="o">=</span> <span class="n">SiS_ExtLCD1400x1050Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCD1680x1050Data</span>     <span class="o">=</span> <span class="n">SiS_LCD1680x1050Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StLCD1600x1200Data</span>   <span class="o">=</span> <span class="n">SiS_StLCD1600x1200Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ExtLCD1600x1200Data</span>  <span class="o">=</span> <span class="n">SiS_ExtLCD1600x1200Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_NoScaleData</span>          <span class="o">=</span> <span class="n">SiS_NoScaleData</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDS320x240Data_1</span>   <span class="o">=</span> <span class="n">SiS_LVDS320x240Data_1</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDS320x240Data_2</span>   <span class="o">=</span> <span class="n">SiS_LVDS320x240Data_2</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDS640x480Data_1</span>   <span class="o">=</span> <span class="n">SiS_LVDS640x480Data_1</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDS800x600Data_1</span>   <span class="o">=</span> <span class="n">SiS_LVDS800x600Data_1</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDS1024x600Data_1</span>  <span class="o">=</span> <span class="n">SiS_LVDS1024x600Data_1</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDS1024x768Data_1</span>  <span class="o">=</span> <span class="n">SiS_LVDS1024x768Data_1</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDSCRT1320x240_1</span>     <span class="o">=</span> <span class="n">SiS_LVDSCRT1320x240_1</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDSCRT1320x240_2</span>     <span class="o">=</span> <span class="n">SiS_LVDSCRT1320x240_2</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDSCRT1320x240_2_H</span>   <span class="o">=</span> <span class="n">SiS_LVDSCRT1320x240_2_H</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDSCRT1320x240_3</span>     <span class="o">=</span> <span class="n">SiS_LVDSCRT1320x240_3</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDSCRT1320x240_3_H</span>   <span class="o">=</span> <span class="n">SiS_LVDSCRT1320x240_3_H</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDSCRT1640x480_1</span>     <span class="o">=</span> <span class="n">SiS_LVDSCRT1640x480_1</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDSCRT1640x480_1_H</span>   <span class="o">=</span> <span class="n">SiS_LVDSCRT1640x480_1_H</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">   SiS_Pr-&gt;SiS_LVDSCRT11024x600_1    = SiS_LVDSCRT11024x600_1;</span>
<span class="c">   SiS_Pr-&gt;SiS_LVDSCRT11024x600_1_H  = SiS_LVDSCRT11024x600_1_H;</span>
<span class="c">   SiS_Pr-&gt;SiS_LVDSCRT11024x600_2    = SiS_LVDSCRT11024x600_2;</span>
<span class="c">   SiS_Pr-&gt;SiS_LVDSCRT11024x600_2_H  = SiS_LVDSCRT11024x600_2_H;</span>
<span class="cp">#endif</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVUNTSCData</span> <span class="o">=</span> <span class="n">SiS_CHTVUNTSCData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVONTSCData</span> <span class="o">=</span> <span class="n">SiS_CHTVONTSCData</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PanelMinLVDS</span>   <span class="o">=</span> <span class="n">Panel_800x600</span><span class="p">;</span>    <span class="cm">/* lowest value LVDS/LCDA */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PanelMin301</span>    <span class="o">=</span> <span class="n">Panel_1024x768</span><span class="p">;</span>   <span class="cm">/* lowest value 301 */</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">InitTo300Pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">InitCommonPointer</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBModeIDTable</span> <span class="o">=</span> <span class="n">SiS300_VBModeIDTable</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_EModeIDTable</span>  <span class="o">=</span> <span class="n">SiS300_EModeIDTable</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span>      <span class="o">=</span> <span class="n">SiS300_RefIndex</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CRT1Table</span>     <span class="o">=</span> <span class="n">SiS300_CRT1Table</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_300</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span> <span class="o">=</span> <span class="n">SiS300_MCLKData_300</span><span class="p">;</span> <span class="cm">/* 300 */</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span> <span class="o">=</span> <span class="n">SiS300_MCLKData_630</span><span class="p">;</span> <span class="cm">/* 630, 730 */</span>
   <span class="p">}</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span>      <span class="o">=</span> <span class="n">SiS300_VCLKData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBVCLKData</span>    <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">SiS_VBVCLKData</span> <span class="o">*</span><span class="p">)</span><span class="n">SiS300_VCLKData</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SR15</span>  <span class="o">=</span> <span class="n">SiS300_SR15</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PanelDelayTbl</span>     <span class="o">=</span> <span class="n">SiS300_PanelDelayTbl</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PanelDelayTblLVDS</span> <span class="o">=</span> <span class="n">SiS300_PanelDelayTbl</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ExtLCD1024x768Data</span>   <span class="o">=</span> <span class="n">SiS300_ExtLCD1024x768Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_St2LCD1024x768Data</span>   <span class="o">=</span> <span class="n">SiS300_St2LCD1024x768Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ExtLCD1280x1024Data</span>  <span class="o">=</span> <span class="n">SiS300_ExtLCD1280x1024Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_St2LCD1280x1024Data</span>  <span class="o">=</span> <span class="n">SiS300_St2LCD1280x1024Data</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CRT2Part2_1024x768_1</span>  <span class="o">=</span> <span class="n">SiS300_CRT2Part2_1024x768_1</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CRT2Part2_1024x768_2</span>  <span class="o">=</span> <span class="n">SiS300_CRT2Part2_1024x768_2</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CRT2Part2_1024x768_3</span>  <span class="o">=</span> <span class="n">SiS300_CRT2Part2_1024x768_3</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVUPALData</span>  <span class="o">=</span> <span class="n">SiS300_CHTVUPALData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVOPALData</span>  <span class="o">=</span> <span class="n">SiS300_CHTVOPALData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVUPALMData</span> <span class="o">=</span> <span class="n">SiS_CHTVUNTSCData</span><span class="p">;</span>    <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVOPALMData</span> <span class="o">=</span> <span class="n">SiS_CHTVONTSCData</span><span class="p">;</span>    <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVUPALNData</span> <span class="o">=</span> <span class="n">SiS300_CHTVUPALData</span><span class="p">;</span>  <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVOPALNData</span> <span class="o">=</span> <span class="n">SiS300_CHTVOPALData</span><span class="p">;</span>  <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVSOPALData</span> <span class="o">=</span> <span class="n">SiS300_CHTVSOPALData</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDS848x480Data_1</span>   <span class="o">=</span> <span class="n">SiS300_LVDS848x480Data_1</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDS848x480Data_2</span>   <span class="o">=</span> <span class="n">SiS300_LVDS848x480Data_2</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDSBARCO1024Data_1</span> <span class="o">=</span> <span class="n">SiS300_LVDSBARCO1024Data_1</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDSBARCO1366Data_1</span> <span class="o">=</span> <span class="n">SiS300_LVDSBARCO1366Data_1</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LVDSBARCO1366Data_2</span> <span class="o">=</span> <span class="n">SiS300_LVDSBARCO1366Data_2</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PanelType04_1a</span> <span class="o">=</span> <span class="n">SiS300_PanelType04_1a</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PanelType04_2a</span> <span class="o">=</span> <span class="n">SiS300_PanelType04_2a</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PanelType04_1b</span> <span class="o">=</span> <span class="n">SiS300_PanelType04_1b</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PanelType04_2b</span> <span class="o">=</span> <span class="n">SiS300_PanelType04_2b</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVCRT1UNTSC</span> <span class="o">=</span> <span class="n">SiS300_CHTVCRT1UNTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVCRT1ONTSC</span> <span class="o">=</span> <span class="n">SiS300_CHTVCRT1ONTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVCRT1UPAL</span>  <span class="o">=</span> <span class="n">SiS300_CHTVCRT1UPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVCRT1OPAL</span>  <span class="o">=</span> <span class="n">SiS300_CHTVCRT1OPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVCRT1SOPAL</span> <span class="o">=</span> <span class="n">SiS300_CHTVCRT1SOPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_UNTSC</span> <span class="o">=</span> <span class="n">SiS300_CHTVReg_UNTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_ONTSC</span> <span class="o">=</span> <span class="n">SiS300_CHTVReg_ONTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_UPAL</span>  <span class="o">=</span> <span class="n">SiS300_CHTVReg_UPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_OPAL</span>  <span class="o">=</span> <span class="n">SiS300_CHTVReg_OPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_UPALM</span> <span class="o">=</span> <span class="n">SiS300_CHTVReg_UNTSC</span><span class="p">;</span>  <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_OPALM</span> <span class="o">=</span> <span class="n">SiS300_CHTVReg_ONTSC</span><span class="p">;</span>  <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_UPALN</span> <span class="o">=</span> <span class="n">SiS300_CHTVReg_UPAL</span><span class="p">;</span>   <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_OPALN</span> <span class="o">=</span> <span class="n">SiS300_CHTVReg_OPAL</span><span class="p">;</span>   <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_SOPAL</span> <span class="o">=</span> <span class="n">SiS300_CHTVReg_SOPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKUNTSC</span> <span class="o">=</span> <span class="n">SiS300_CHTVVCLKUNTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKONTSC</span> <span class="o">=</span> <span class="n">SiS300_CHTVVCLKONTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKUPAL</span>  <span class="o">=</span> <span class="n">SiS300_CHTVVCLKUPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKOPAL</span>  <span class="o">=</span> <span class="n">SiS300_CHTVVCLKOPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKUPALM</span> <span class="o">=</span> <span class="n">SiS300_CHTVVCLKUNTSC</span><span class="p">;</span>  <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKOPALM</span> <span class="o">=</span> <span class="n">SiS300_CHTVVCLKONTSC</span><span class="p">;</span>  <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKUPALN</span> <span class="o">=</span> <span class="n">SiS300_CHTVVCLKUPAL</span><span class="p">;</span>   <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKOPALN</span> <span class="o">=</span> <span class="n">SiS300_CHTVVCLKOPAL</span><span class="p">;</span>   <span class="cm">/* not supported on 300 series */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKSOPAL</span> <span class="o">=</span> <span class="n">SiS300_CHTVVCLKSOPAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">InitTo310Pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">InitCommonPointer</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_EModeIDTable</span>  <span class="o">=</span> <span class="n">SiS310_EModeIDTable</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span>      <span class="o">=</span> <span class="n">SiS310_RefIndex</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CRT1Table</span>     <span class="o">=</span> <span class="n">SiS310_CRT1Table</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_340</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span> <span class="o">=</span> <span class="n">SiS310_MCLKData_0_340</span><span class="p">;</span>  <span class="cm">/* 340 + XGI */</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_761</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span> <span class="o">=</span> <span class="n">SiS310_MCLKData_0_761</span><span class="p">;</span>  <span class="cm">/* 761 - preliminary */</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_760</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span> <span class="o">=</span> <span class="n">SiS310_MCLKData_0_760</span><span class="p">;</span>  <span class="cm">/* 760 */</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span> <span class="o">=</span> <span class="n">SiS310_MCLKData_0_660</span><span class="p">;</span>  <span class="cm">/* 661/741 */</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_330</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span> <span class="o">=</span> <span class="n">SiS310_MCLKData_0_330</span><span class="p">;</span>  <span class="cm">/* 330 */</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;</span> <span class="n">SIS_315PRO</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span> <span class="o">=</span> <span class="n">SiS310_MCLKData_0_650</span><span class="p">;</span>  <span class="cm">/* 550, 650, 740 */</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span> <span class="o">=</span> <span class="n">SiS310_MCLKData_0_315</span><span class="p">;</span>  <span class="cm">/* 315 */</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_340</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_1</span> <span class="o">=</span> <span class="n">SiS310_MCLKData_1_340</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_1</span> <span class="o">=</span> <span class="n">SiS310_MCLKData_1</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span>      <span class="o">=</span> <span class="n">SiS310_VCLKData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBVCLKData</span>    <span class="o">=</span> <span class="n">SiS310_VBVCLKData</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SR15</span>  <span class="o">=</span> <span class="n">SiS310_SR15</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PanelDelayTbl</span>     <span class="o">=</span> <span class="n">SiS310_PanelDelayTbl</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PanelDelayTblLVDS</span> <span class="o">=</span> <span class="n">SiS310_PanelDelayTblLVDS</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_St2LCD1024x768Data</span>   <span class="o">=</span> <span class="n">SiS310_St2LCD1024x768Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ExtLCD1024x768Data</span>   <span class="o">=</span> <span class="n">SiS310_ExtLCD1024x768Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_St2LCD1280x1024Data</span>  <span class="o">=</span> <span class="n">SiS310_St2LCD1280x1024Data</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ExtLCD1280x1024Data</span>  <span class="o">=</span> <span class="n">SiS310_ExtLCD1280x1024Data</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CRT2Part2_1024x768_1</span>  <span class="o">=</span> <span class="n">SiS310_CRT2Part2_1024x768_1</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVUPALData</span>  <span class="o">=</span> <span class="n">SiS310_CHTVUPALData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVOPALData</span>  <span class="o">=</span> <span class="n">SiS310_CHTVOPALData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVUPALMData</span> <span class="o">=</span> <span class="n">SiS310_CHTVUPALMData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVOPALMData</span> <span class="o">=</span> <span class="n">SiS310_CHTVOPALMData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVUPALNData</span> <span class="o">=</span> <span class="n">SiS310_CHTVUPALNData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVOPALNData</span> <span class="o">=</span> <span class="n">SiS310_CHTVOPALNData</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVSOPALData</span> <span class="o">=</span> <span class="n">SiS310_CHTVSOPALData</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVCRT1UNTSC</span> <span class="o">=</span> <span class="n">SiS310_CHTVCRT1UNTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVCRT1ONTSC</span> <span class="o">=</span> <span class="n">SiS310_CHTVCRT1ONTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVCRT1UPAL</span>  <span class="o">=</span> <span class="n">SiS310_CHTVCRT1UPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVCRT1OPAL</span>  <span class="o">=</span> <span class="n">SiS310_CHTVCRT1OPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVCRT1SOPAL</span> <span class="o">=</span> <span class="n">SiS310_CHTVCRT1OPAL</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_UNTSC</span> <span class="o">=</span> <span class="n">SiS310_CHTVReg_UNTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_ONTSC</span> <span class="o">=</span> <span class="n">SiS310_CHTVReg_ONTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_UPAL</span>  <span class="o">=</span> <span class="n">SiS310_CHTVReg_UPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_OPAL</span>  <span class="o">=</span> <span class="n">SiS310_CHTVReg_OPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_UPALM</span> <span class="o">=</span> <span class="n">SiS310_CHTVReg_UPALM</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_OPALM</span> <span class="o">=</span> <span class="n">SiS310_CHTVReg_OPALM</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_UPALN</span> <span class="o">=</span> <span class="n">SiS310_CHTVReg_UPALN</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_OPALN</span> <span class="o">=</span> <span class="n">SiS310_CHTVReg_OPALN</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVReg_SOPAL</span> <span class="o">=</span> <span class="n">SiS310_CHTVReg_OPAL</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKUNTSC</span> <span class="o">=</span> <span class="n">SiS310_CHTVVCLKUNTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKONTSC</span> <span class="o">=</span> <span class="n">SiS310_CHTVVCLKONTSC</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKUPAL</span>  <span class="o">=</span> <span class="n">SiS310_CHTVVCLKUPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKOPAL</span>  <span class="o">=</span> <span class="n">SiS310_CHTVVCLKOPAL</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKUPALM</span> <span class="o">=</span> <span class="n">SiS310_CHTVVCLKUPALM</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKOPALM</span> <span class="o">=</span> <span class="n">SiS310_CHTVVCLKOPALM</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKUPALN</span> <span class="o">=</span> <span class="n">SiS310_CHTVVCLKUPALN</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKOPALN</span> <span class="o">=</span> <span class="n">SiS310_CHTVVCLKOPALN</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CHTVVCLKSOPAL</span> <span class="o">=</span> <span class="n">SiS310_CHTVVCLKOPAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="n">bool</span>
<span class="nf">SiSInitPtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
      <span class="n">InitTo300Pointer</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
<span class="cp">#else</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
      <span class="n">InitTo310Pointer</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
<span class="cp">#else</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*            HELPER: Get ModeID             */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span>
<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetModeID</span><span class="p">(</span><span class="kt">int</span> <span class="n">VGAEngine</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">VBFlags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">HDisplay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">VDisplay</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">Depth</span><span class="p">,</span> <span class="n">bool</span> <span class="n">FSTN</span><span class="p">,</span> <span class="kt">int</span> <span class="n">LCDwidth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">LCDheight</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">switch</span><span class="p">(</span><span class="n">HDisplay</span><span class="p">)</span>
   <span class="p">{</span>
	<span class="k">case</span> <span class="mi">320</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_320x200</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">240</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">CRT2_LCD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">FSTN</span><span class="p">))</span>
				<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_320x240_FSTN</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_320x240</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">400</span>:
		<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">CRT1_LCDA</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">LCDwidth</span> <span class="o">&gt;=</span> <span class="mi">800</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">LCDwidth</span> <span class="o">&gt;=</span> <span class="mi">600</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">300</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_400x300</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">512</span>:
		<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">CRT1_LCDA</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">LCDwidth</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">LCDwidth</span> <span class="o">&gt;=</span> <span class="mi">768</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">384</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_512x384</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">640</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_640x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">400</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_640x400</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">720</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_720x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">576</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_720x576</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">768</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">576</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_768x576</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">800</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">600</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_800x600</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_800x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">848</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_848x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">856</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_856x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">960</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">540</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_960x540</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
			<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">600</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_960x600</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1024</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">576</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1024x576</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1024x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">600</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1024x600</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1152</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">864</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1152x864</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1152x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1280</span>:
		<span class="k">switch</span><span class="p">(</span><span class="n">VDisplay</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">720</span>:
				<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x720</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">768</span>:
				<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_300_1280x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_310_1280x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">800</span>:
				<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x800</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">854</span>:
				<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x854</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">960</span>:
				<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x960</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1024</span>:
				<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x1024</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1360</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1360x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_300_1360x1024</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1400</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1050</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1400x1050</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1600</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1200</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1600x1200</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1680</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1050</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1680x1050</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1920</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1440</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1920x1440</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1080</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1920x1080</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2048</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1536</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_300_2048x1536</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_310_2048x1536</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">ModeIndex</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetModeID_LCD</span><span class="p">(</span><span class="kt">int</span> <span class="n">VGAEngine</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">VBFlags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">HDisplay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">VDisplay</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">Depth</span><span class="p">,</span> <span class="n">bool</span> <span class="n">FSTN</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">CustomT</span><span class="p">,</span> <span class="kt">int</span> <span class="n">LCDwidth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">LCDheight</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">VBFlags2</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VB2_LVDS</span> <span class="o">|</span> <span class="n">VB2_30xBDH</span><span class="p">))</span> <span class="p">{</span>

      <span class="k">switch</span><span class="p">(</span><span class="n">HDisplay</span><span class="p">)</span>
      <span class="p">{</span>
	<span class="k">case</span> <span class="mi">320</span>:
	     <span class="k">if</span><span class="p">((</span><span class="n">CustomT</span> <span class="o">!=</span> <span class="n">CUT_PANEL848</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CustomT</span> <span class="o">!=</span> <span class="n">CUT_PANEL856</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">FSTN</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_320x200</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">240</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">FSTN</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_320x240</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_320x240_FSTN</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		   <span class="p">}</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">400</span>:
	     <span class="k">if</span><span class="p">((</span><span class="n">CustomT</span> <span class="o">!=</span> <span class="n">CUT_PANEL848</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CustomT</span> <span class="o">!=</span> <span class="n">CUT_PANEL856</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_TRUMPION</span><span class="p">)))</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">300</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_400x300</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">512</span>:
	     <span class="k">if</span><span class="p">((</span><span class="n">CustomT</span> <span class="o">!=</span> <span class="n">CUT_PANEL848</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CustomT</span> <span class="o">!=</span> <span class="n">CUT_PANEL856</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_TRUMPION</span><span class="p">)))</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span><span class="n">LCDwidth</span> <span class="o">&gt;=</span> <span class="mi">1024</span> <span class="o">&amp;&amp;</span> <span class="n">LCDwidth</span> <span class="o">!=</span> <span class="mi">1152</span> <span class="o">&amp;&amp;</span> <span class="n">LCDheight</span> <span class="o">&gt;=</span> <span class="mi">768</span><span class="p">)</span> <span class="p">{</span>
		      <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">384</span><span class="p">)</span> <span class="p">{</span>
		         <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_512x384</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		      <span class="p">}</span>
		   <span class="p">}</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">640</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_640x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">CustomT</span> <span class="o">!=</span> <span class="n">CUT_PANEL848</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CustomT</span> <span class="o">!=</span> <span class="n">CUT_PANEL856</span><span class="p">))</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_640x400</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">800</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">600</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_800x600</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">848</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">CustomT</span> <span class="o">==</span> <span class="n">CUT_PANEL848</span><span class="p">)</span> <span class="p">{</span>
	        <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_848x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">856</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">CustomT</span> <span class="o">==</span> <span class="n">CUT_PANEL856</span><span class="p">)</span> <span class="p">{</span>
	        <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_856x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1024</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1024x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">600</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">LCDheight</span> <span class="o">==</span> <span class="mi">600</span><span class="p">))</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1024x600</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1152</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">LCDheight</span> <span class="o">==</span> <span class="mi">768</span><span class="p">))</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1152x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1280</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x1024</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">LCDheight</span> <span class="o">==</span> <span class="mi">768</span><span class="p">))</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_310_1280x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1360</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">CustomT</span> <span class="o">==</span> <span class="n">CUT_BARCO1366</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_300_1360x1024</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">if</span><span class="p">(</span><span class="n">CustomT</span> <span class="o">==</span> <span class="n">CUT_PANEL848</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1360x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1400</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1050</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1400x1050</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1600</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1200</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1600x1200</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISBRIDGE</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">switch</span><span class="p">(</span><span class="n">HDisplay</span><span class="p">)</span>
      <span class="p">{</span>
	<span class="k">case</span> <span class="mi">320</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_320x200</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">240</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_320x240</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">400</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">LCDwidth</span> <span class="o">&gt;=</span> <span class="mi">800</span> <span class="o">&amp;&amp;</span> <span class="n">LCDheight</span> <span class="o">&gt;=</span> <span class="mi">600</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">300</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_400x300</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">512</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">LCDwidth</span> <span class="o">&gt;=</span> <span class="mi">1024</span> <span class="o">&amp;&amp;</span> <span class="n">LCDheight</span> <span class="o">&gt;=</span> <span class="mi">768</span> <span class="o">&amp;&amp;</span> <span class="n">LCDwidth</span> <span class="o">!=</span> <span class="mi">1152</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">384</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_512x384</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">640</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_640x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">400</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_640x400</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">720</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_720x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">576</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_720x576</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">768</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">576</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_768x576</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">800</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">600</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_800x600</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_800x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">848</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_848x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">856</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_856x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">960</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">540</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_960x540</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">600</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_960x600</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1024</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1024x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">576</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1024x576</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1152</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">864</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1152x864</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1280</span>:
	     <span class="k">switch</span><span class="p">(</span><span class="n">VDisplay</span><span class="p">)</span> <span class="p">{</span>
	     <span class="k">case</span> <span class="mi">720</span>:
		<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x720</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">case</span> <span class="mi">768</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_300_1280x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_310_1280x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	     <span class="k">case</span> <span class="mi">800</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x800</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	     <span class="k">case</span> <span class="mi">854</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x854</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	     <span class="k">case</span> <span class="mi">960</span>:
		<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x960</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	     <span class="k">case</span> <span class="mi">1024</span>:
		<span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x1024</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1360</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* OVER1280 only? */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1360x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1400</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_LCDOVER1280BRIDGE</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1050</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1400x1050</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1600</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_LCDOVER1280BRIDGE</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1200</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1600x1200</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
<span class="cp">#ifndef VB_FORBID_CRT2LCD_OVER_1600</span>
	<span class="k">case</span> <span class="mi">1680</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_LCDOVER1280BRIDGE</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1050</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1680x1050</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1920</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_LCDOVER1600BRIDGE</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1440</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1920x1440</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2048</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_LCDOVER1600BRIDGE</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1536</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_310_2048x1536</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">ModeIndex</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetModeID_TV</span><span class="p">(</span><span class="kt">int</span> <span class="n">VGAEngine</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">VBFlags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">HDisplay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">VDisplay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Depth</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">VBFlags2</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">switch</span><span class="p">(</span><span class="n">HDisplay</span><span class="p">)</span>
      <span class="p">{</span>
	<span class="k">case</span> <span class="mi">512</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">384</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_512x384</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">640</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_640x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">400</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_640x400</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">800</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">600</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_800x600</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1024</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1024x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISTVBRIDGE</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">switch</span><span class="p">(</span><span class="n">HDisplay</span><span class="p">)</span>
      <span class="p">{</span>
	<span class="k">case</span> <span class="mi">320</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_320x200</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">240</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_320x240</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">400</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">300</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_400x300</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">512</span>:
	     <span class="k">if</span><span class="p">(</span> <span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_YPBPR750P</span> <span class="o">|</span> <span class="n">TV_YPBPR1080I</span><span class="p">)))</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_HIVISION</span><span class="p">)</span> 					      <span class="o">||</span>
		 <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_YPBPR</span> <span class="o">|</span> <span class="n">TV_PALM</span><span class="p">)))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_PAL</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">384</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_512x384</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">640</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span>      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_640x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">400</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_640x400</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">720</span>:
	     <span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_HIVISION</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR1080I</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_720x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">576</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span> <span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR750P</span><span class="p">))</span> <span class="o">||</span>
		       <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_YPBPR</span> <span class="o">|</span> <span class="n">TV_PALM</span><span class="p">)))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_PAL</span><span class="p">))</span> <span class="p">)</span>
		      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_720x576</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
             <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">768</span>:
	     <span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_HIVISION</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR1080I</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR750P</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_YPBPR</span> <span class="o">|</span> <span class="n">TV_PALM</span><span class="p">)))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_PAL</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">576</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_768x576</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
             <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">800</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">600</span><span class="p">)</span> <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_800x600</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
	     <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR750P</span><span class="p">)))</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_800x480</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">960</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">600</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_HIVISION</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR1080I</span><span class="p">)))</span> <span class="p">{</span>
		      <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_960x600</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		   <span class="p">}</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1024</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xBLV</span><span class="p">)</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1024x768</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">576</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_HIVISION</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR1080I</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xBLV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_YPBPR</span> <span class="o">|</span> <span class="n">TV_PALM</span><span class="p">)))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_PAL</span><span class="p">)))</span> <span class="p">)</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1024x576</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1280</span>:
	     <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">720</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_HIVISION</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_YPBPR1080I</span> <span class="o">|</span> <span class="n">TV_YPBPR750P</span><span class="p">))))</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x720</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_HIVISION</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">VBFlags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR1080I</span><span class="p">)))</span> <span class="p">{</span>
		   <span class="n">ModeIndex</span> <span class="o">=</span> <span class="n">ModeIndex_1280x1024</span><span class="p">[</span><span class="n">Depth</span><span class="p">];</span>
		<span class="p">}</span>
	     <span class="p">}</span>
	     <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">ModeIndex</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetModeID_VGA2</span><span class="p">(</span><span class="kt">int</span> <span class="n">VGAEngine</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">VBFlags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">HDisplay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">VDisplay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Depth</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">VBFlags2</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISVGA2BRIDGE</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">HDisplay</span> <span class="o">&gt;=</span> <span class="mi">1920</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">switch</span><span class="p">(</span><span class="n">HDisplay</span><span class="p">)</span>
   <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1600</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1200</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">!=</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xB</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1680</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">VDisplay</span> <span class="o">==</span> <span class="mi">1050</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">VGAEngine</span> <span class="o">!=</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">VBFlags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xB</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">SiS_GetModeID</span><span class="p">(</span><span class="n">VGAEngine</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDisplay</span><span class="p">,</span> <span class="n">VDisplay</span><span class="p">,</span> <span class="n">Depth</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*********************************************/</span>
<span class="cm">/*          HELPER: SetReg, GetReg           */</span>
<span class="cm">/*********************************************/</span>

<span class="kt">void</span>
<span class="nf">SiS_SetReg</span><span class="p">(</span><span class="n">SISIOADDRESS</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">SiS_SetRegByte</span><span class="p">(</span><span class="n">SISIOADDRESS</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">SiS_SetRegShort</span><span class="p">(</span><span class="n">SISIOADDRESS</span> <span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">SiS_SetRegLong</span><span class="p">(</span><span class="n">SISIOADDRESS</span> <span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span>
<span class="nf">SiS_GetReg</span><span class="p">(</span><span class="n">SISIOADDRESS</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span>
<span class="nf">SiS_GetRegByte</span><span class="p">(</span><span class="n">SISIOADDRESS</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u16</span>
<span class="nf">SiS_GetRegShort</span><span class="p">(</span><span class="n">SISIOADDRESS</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inw</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span>
<span class="nf">SiS_GetRegLong</span><span class="p">(</span><span class="n">SISIOADDRESS</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inl</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISIOADDRESS</span> <span class="n">Port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">Index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">DataAND</span><span class="p">,</span> <span class="n">u8</span> <span class="n">DataOR</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">u8</span> <span class="n">temp</span><span class="p">;</span>

   <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">Port</span><span class="p">,</span> <span class="n">Index</span><span class="p">);</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DataAND</span><span class="p">))</span> <span class="o">|</span> <span class="n">DataOR</span><span class="p">;</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">Port</span><span class="p">,</span> <span class="n">Index</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISIOADDRESS</span> <span class="n">Port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">Index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">DataAND</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">u8</span> <span class="n">temp</span><span class="p">;</span>

   <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">Port</span><span class="p">,</span> <span class="n">Index</span><span class="p">);</span>
   <span class="n">temp</span> <span class="o">&amp;=</span> <span class="n">DataAND</span><span class="p">;</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">Port</span><span class="p">,</span> <span class="n">Index</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISIOADDRESS</span> <span class="n">Port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">Index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">DataOR</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">u8</span> <span class="n">temp</span><span class="p">;</span>

   <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">Port</span><span class="p">,</span> <span class="n">Index</span><span class="p">);</span>
   <span class="n">temp</span> <span class="o">|=</span> <span class="n">DataOR</span><span class="p">;</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">Port</span><span class="p">,</span> <span class="n">Index</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*      HELPER: DisplayOn, DisplayOff        */</span>
<span class="cm">/*********************************************/</span>

<span class="kt">void</span>
<span class="nf">SiS_DisplayOn</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">SiS_DisplayOff</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*********************************************/</span>
<span class="cm">/*        HELPER: Init Port Addresses        */</span>
<span class="cm">/*********************************************/</span>

<span class="kt">void</span>
<span class="nf">SiSRegInit</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">SISIOADDRESS</span> <span class="n">BaseAddr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x24</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c0</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3ce</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x1e</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c2</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3ca</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x1a</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c6</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x16</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c7</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x17</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c8</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c9</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x19</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cb</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x1b</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cc</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cd</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x1d</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3da</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x2a</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part1Port</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">SIS_CRT2_PORT_04</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part2Port</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">SIS_CRT2_PORT_10</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part3Port</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">SIS_CRT2_PORT_12</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">SIS_CRT2_PORT_14</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part5Port</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">SIS_CRT2_PORT_14</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_DDC_Port</span>  <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VidCapt</span>   <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">SIS_VIDEO_CAPTURE</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VidPlay</span>   <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">SIS_VIDEO_PLAYBACK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*             HELPER: GetSysFlags           */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_GetSysFlags</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cr5f</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">;</span>

   <span class="cm">/* 661 and newer: NEVER write non-zero to SR11[7:4] */</span>
   <span class="cm">/* (SR11 is used for DDC and in enable/disablebridge) */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SensibleSR11</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MyCR63</span> <span class="o">=</span> <span class="mh">0x63</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_330</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MyCR63</span> <span class="o">=</span> <span class="mh">0x53</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SensibleSR11</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="cm">/* You should use the macros, not these flags directly */</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_650</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cr5f</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x5f</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x5c</span><span class="p">,</span><span class="mh">0x07</span><span class="p">);</span>
      <span class="n">temp1</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x5c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">;</span>
      <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x5c</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">);</span>
      <span class="n">temp2</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x5c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">;</span>
      <span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="n">temp1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">temp2</span><span class="p">))</span> <span class="p">{</span>
	 <span class="k">switch</span><span class="p">(</span><span class="n">cr5f</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="mh">0x80</span>:
	    <span class="k">case</span> <span class="mh">0x90</span>:
	    <span class="k">case</span> <span class="mh">0xc0</span>:
	       <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">|=</span> <span class="n">SF_IsM650</span><span class="p">;</span>
	       <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mh">0xa0</span>:
	    <span class="k">case</span> <span class="mh">0xb0</span>:
	    <span class="k">case</span> <span class="mh">0xe0</span>:
	       <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">|=</span> <span class="n">SF_Is651</span><span class="p">;</span>
	       <span class="k">break</span><span class="p">;</span>
	 <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="k">switch</span><span class="p">(</span><span class="n">cr5f</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="mh">0x90</span>:
	       <span class="n">temp1</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x5c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">;</span>
	       <span class="k">switch</span><span class="p">(</span><span class="n">temp1</span><span class="p">)</span> <span class="p">{</span>
		  <span class="k">case</span> <span class="mh">0x00</span>: <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">|=</span> <span class="n">SF_IsM652</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		  <span class="k">case</span> <span class="mh">0x40</span>: <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">|=</span> <span class="n">SF_IsM653</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		  <span class="nl">default:</span>   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">|=</span> <span class="n">SF_IsM650</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	       <span class="p">}</span>
	       <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mh">0xb0</span>:
	       <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">|=</span> <span class="n">SF_Is652</span><span class="p">;</span>
	       <span class="k">break</span><span class="p">;</span>
	    <span class="nl">default:</span>
	       <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">|=</span> <span class="n">SF_IsM650</span><span class="p">;</span>
	       <span class="k">break</span><span class="p">;</span>
	 <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_760</span> <span class="o">&amp;&amp;</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;=</span> <span class="n">SIS_761</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x78</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">|=</span> <span class="n">SF_760LFB</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x79</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">|=</span> <span class="n">SF_760UMA</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*         HELPER: Init PCI &amp; Engines        */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiSInitPCIetc</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">switch</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
   <span class="k">case</span> <span class="n">SIS_300</span>:
   <span class="k">case</span> <span class="n">SIS_540</span>:
   <span class="k">case</span> <span class="n">SIS_630</span>:
   <span class="k">case</span> <span class="n">SIS_730</span>:
      <span class="cm">/* Set - PCI LINEAR ADDRESSING ENABLE (0x80)</span>
<span class="cm">       *     - RELOCATED VGA IO ENABLED (0x20)</span>
<span class="cm">       *     - MMIO ENABLED (0x01)</span>
<span class="cm">       * Leave other bits untouched.</span>
<span class="cm">       */</span>
      <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xa1</span><span class="p">);</span>
      <span class="cm">/*  - Enable 2D (0x40)</span>
<span class="cm">       *  - Enable 3D (0x02)</span>
<span class="cm">       *  - Enable 3D Vertex command fetch (0x10) ?</span>
<span class="cm">       *  - Enable 3D command parser (0x08) ?</span>
<span class="cm">       */</span>
      <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x1E</span><span class="p">,</span><span class="mh">0x5A</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
   <span class="k">case</span> <span class="n">SIS_315H</span>:
   <span class="k">case</span> <span class="n">SIS_315</span>:
   <span class="k">case</span> <span class="n">SIS_315PRO</span>:
   <span class="k">case</span> <span class="n">SIS_650</span>:
   <span class="k">case</span> <span class="n">SIS_740</span>:
   <span class="k">case</span> <span class="n">SIS_330</span>:
   <span class="k">case</span> <span class="n">SIS_661</span>:
   <span class="k">case</span> <span class="n">SIS_741</span>:
   <span class="k">case</span> <span class="n">SIS_660</span>:
   <span class="k">case</span> <span class="n">SIS_760</span>:
   <span class="k">case</span> <span class="n">SIS_761</span>:
   <span class="k">case</span> <span class="n">SIS_340</span>:
   <span class="k">case</span> <span class="n">XGI_40</span>:
      <span class="cm">/* See above */</span>
      <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xa1</span><span class="p">);</span>
      <span class="cm">/*  - Enable 3D G/L transformation engine (0x80)</span>
<span class="cm">       *  - Enable 2D (0x40)</span>
<span class="cm">       *  - Enable 3D vertex command fetch (0x10)</span>
<span class="cm">       *  - Enable 3D command parser (0x08)</span>
<span class="cm">       *  - Enable 3D (0x02)</span>
<span class="cm">       */</span>
      <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x1E</span><span class="p">,</span><span class="mh">0xDA</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
   <span class="k">case</span> <span class="n">XGI_20</span>:
   <span class="k">case</span> <span class="n">SIS_550</span>:
      <span class="cm">/* See above */</span>
      <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xa1</span><span class="p">);</span>
      <span class="cm">/* No 3D engine ! */</span>
      <span class="cm">/*  - Enable 2D (0x40)</span>
<span class="cm">       *  - disable 3D</span>
<span class="cm">       */</span>
      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x1E</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="mh">0x40</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
   <span class="nl">default:</span>
      <span class="k">break</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*             HELPER: SetLVDSetc            */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">SiSSetLVDSetc</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_LVDS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_TRUMPION</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_CH70xx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_CONEX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ChrontelInit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

   <span class="cm">/* Check for SiS30x first */</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>
   <span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

   <span class="k">switch</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
   <span class="k">case</span> <span class="n">SIS_540</span>:
   <span class="k">case</span> <span class="n">SIS_630</span>:
   <span class="k">case</span> <span class="n">SIS_730</span>:
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x37</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">))</span>	<span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_LVDS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>			<span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_TRUMPION</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Save power status (and error check) - UNUSED */</span>
		<span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Backup70xx</span> <span class="o">=</span> <span class="n">SiS_GetCH700x</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
		<span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_CH70xx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
   <span class="k">case</span> <span class="n">SIS_550</span>:
   <span class="k">case</span> <span class="n">SIS_650</span>:
   <span class="k">case</span> <span class="n">SIS_740</span>:
   <span class="k">case</span> <span class="n">SIS_330</span>:
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x37</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">))</span>	<span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_LVDS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>			<span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_CH70xx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
   <span class="k">case</span> <span class="n">SIS_661</span>:
   <span class="k">case</span> <span class="n">SIS_741</span>:
   <span class="k">case</span> <span class="n">SIS_660</span>:
   <span class="k">case</span> <span class="n">SIS_760</span>:
   <span class="k">case</span> <span class="n">SIS_761</span>:
   <span class="k">case</span> <span class="n">SIS_340</span>:
   <span class="k">case</span> <span class="n">XGI_20</span>:
   <span class="k">case</span> <span class="n">XGI_40</span>:
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x38</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">))</span> 	<span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_LVDS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>			<span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_CH70xx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>			<span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_CONEX</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* Not yet supported */</span>
	<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
   <span class="nl">default:</span>
	<span class="k">break</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*          HELPER: Enable DSTN/FSTN         */</span>
<span class="cm">/*********************************************/</span>

<span class="kt">void</span>
<span class="nf">SiS_SetEnableDstn</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_DSTN</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">SiS_SetEnableFstn</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_FSTN</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*            HELPER: Get modeflag           */</span>
<span class="cm">/*********************************************/</span>

<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetModeFlag</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CModeFlag</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&lt;=</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SModeIDTable</span><span class="p">[</span><span class="n">ModeIdIndex</span><span class="p">].</span><span class="n">St_ModeFlag</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_EModeIDTable</span><span class="p">[</span><span class="n">ModeIdIndex</span><span class="p">].</span><span class="n">Ext_ModeFlag</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*        HELPER: Determine ROM usage        */</span>
<span class="cm">/*********************************************/</span>

<span class="n">bool</span>
<span class="nf">SiSDetermineROMLayout661</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">ROMAddr</span>  <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">VirtualRomBase</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">romversoffs</span><span class="p">,</span> <span class="n">romvmaj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">romvmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* XGI ROMs don&#39;t qualify */</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_761</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* I very much assume 761, 340 and newer will use new layout */</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">((</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x1a</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;N&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	 <span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x1b</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;e&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	 <span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x1c</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;w&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	 <span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x1d</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span><span class="p">))</span> <span class="p">{</span>
	 <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">romversoffs</span> <span class="o">=</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x16</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">romversoffs</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">((</span><span class="n">ROMAddr</span><span class="p">[</span><span class="n">romversoffs</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="n">romversoffs</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">romvmaj</span> <span class="o">=</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="n">romversoffs</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	    <span class="n">romvmin</span> <span class="o">=</span> <span class="p">((</span><span class="n">ROMAddr</span><span class="p">[</span><span class="n">romversoffs</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="n">romversoffs</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
	 <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">((</span><span class="n">romvmaj</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">romvmin</span> <span class="o">&gt;=</span> <span class="mi">92</span><span class="p">))</span> <span class="p">{</span>
	 <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">IS_SIS650740</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">((</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x1a</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;N&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	 <span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x1b</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;e&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	 <span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x1c</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;w&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	 <span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x1d</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span><span class="p">))</span> <span class="p">{</span>
	 <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiSDetermineROMUsage</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">ROMAddr</span>  <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">VirtualRomBase</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">romptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_UseROM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ROMNew</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PWDOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

   <span class="k">if</span><span class="p">((</span><span class="n">ROMAddr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseROM</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_300</span><span class="p">)</span> <span class="p">{</span>
	 <span class="cm">/* 300: We check if the code starts below 0x220 by</span>
<span class="cm">	  * checking the jmp instruction at the beginning</span>
<span class="cm">	  * of the BIOS image.</span>
<span class="cm">	  */</span>
	 <span class="k">if</span><span class="p">((</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xe9</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mh">0x21a</span><span class="p">)</span>
	    <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_UseROM</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
	 <span class="cm">/* Sony&#39;s VAIO BIOS 1.09 follows the standard, so perhaps</span>
<span class="cm">	  * the others do as well</span>
<span class="cm">	  */</span>
	 <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_UseROM</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="cm">/* 315/330 series stick to the standard(s) */</span>
	 <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_UseROM</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ROMNew</span> <span class="o">=</span> <span class="n">SiSDetermineROMLayout661</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">)))</span> <span class="p">{</span>
	    <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_EMIOffset</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	    <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PWDOffset</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	    <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS661LCD2TableSize</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	    <span class="cm">/* Find out about LCD data table entry size */</span>
	    <span class="k">if</span><span class="p">((</span><span class="n">romptr</span> <span class="o">=</span> <span class="n">SISGETROMW</span><span class="p">(</span><span class="mh">0x0102</span><span class="p">)))</span> <span class="p">{</span>
	       <span class="k">if</span><span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="n">romptr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		  <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS661LCD2TableSize</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="n">romptr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">34</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		  <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS661LCD2TableSize</span> <span class="o">=</span> <span class="mi">34</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="n">romptr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>	   <span class="cm">/* 0.94, 2.05.00+ */</span>
		  <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS661LCD2TableSize</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="n">romptr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">38</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span>   <span class="cm">/* 2.00.00 - 2.02.00 */</span>
		 	<span class="p">(</span><span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x6F</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>		   <span class="cm">/* 2.03.00 - &lt;2.05.00 */</span>
		  <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS661LCD2TableSize</span> <span class="o">=</span> <span class="mi">38</span><span class="p">;</span>		   <span class="cm">/* UMC data layout abandoned at 2.05.00 */</span>
		  <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_EMIOffset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		  <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_PWDOffset</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
	       <span class="p">}</span>
	    <span class="p">}</span>
	 <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*        HELPER: SET SEGMENT REGISTERS      */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetSegRegLower</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">;</span>

   <span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0x00ff</span><span class="p">;</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
   <span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cb</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
   <span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cd</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetSegRegUpper</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">;</span>

   <span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0x00ff</span><span class="p">;</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
   <span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cb</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
   <span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cd</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetSegmentReg</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">SiS_SetSegRegLower</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
   <span class="n">SiS_SetSegRegUpper</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_ResetSegmentReg</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">SiS_SetSegmentReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetSegmentRegOver</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

   <span class="n">temp</span> <span class="o">&amp;=</span> <span class="mh">0x07</span><span class="p">;</span>
   <span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x1d</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>
   <span class="n">SiS_SetSegmentReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_ResetSegmentRegOver</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">SiS_SetSegmentRegOver</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_ResetSegmentRegisters</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">((</span><span class="n">IS_SIS65x</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">SiS_ResetSegmentReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
      <span class="n">SiS_ResetSegmentRegOver</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*             HELPER: GetVBType             */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span>
<span class="kt">void</span>
<span class="nf">SiS_GetVBType</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nolcd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">p4_0f</span><span class="p">,</span> <span class="n">p4_25</span><span class="p">,</span> <span class="n">p4_27</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_LVDS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_CONEX</span><span class="p">))</span>
      <span class="k">return</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>

   <span class="n">flag</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">flag</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>

   <span class="n">rev</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x01</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">flag</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">=</span> <span class="n">VB_SIS302B</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">=</span> <span class="n">VB_SIS301C</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mh">0xB0</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">=</span> <span class="n">VB_SIS301B</span><span class="p">;</span>
	 <span class="cm">/* Check if 30xB DH version (no LCD support, use Panel Link instead) */</span>
	 <span class="n">nolcd</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x23</span><span class="p">);</span>
	 <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nolcd</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">|=</span> <span class="n">VB_NoLCD</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">=</span> <span class="n">VB_SIS301</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VB_SIS301B</span> <span class="o">|</span> <span class="n">VB_SIS301C</span> <span class="o">|</span> <span class="n">VB_SIS302B</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">flag</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x39</span><span class="p">);</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">=</span> <span class="n">VB_SIS302LV</span><span class="p">;</span>
	 <span class="k">else</span> 	 	  <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">=</span> <span class="n">VB_SIS301C</span><span class="p">;</span>  <span class="cm">/* VB_SIS302ELV; */</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mh">0xD0</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">=</span> <span class="n">VB_SIS301LV</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VB_SIS301C</span> <span class="o">|</span> <span class="n">VB_SIS301LV</span> <span class="o">|</span> <span class="n">VB_SIS302LV</span> <span class="o">|</span> <span class="n">VB_SIS302ELV</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">p4_0f</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x0f</span><span class="p">);</span>
      <span class="n">p4_25</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x25</span><span class="p">);</span>
      <span class="n">p4_27</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x27</span><span class="p">);</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x0f</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">);</span>
      <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x08</span><span class="p">);</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x27</span><span class="p">,</span><span class="mh">0xfd</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">|=</span> <span class="n">VB_UMC</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x27</span><span class="p">,</span><span class="n">p4_27</span><span class="p">);</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="n">p4_25</span><span class="p">);</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part4Port</span><span class="p">,</span><span class="mh">0x0f</span><span class="p">,</span><span class="n">p4_0f</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*           HELPER: Check RAM size          */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">SiS_CheckMemorySize</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">AdapterMemSize</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">VideoMemorySize</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">modeflag</span> <span class="o">=</span> <span class="n">SiS_GetModeFlag</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">memorysize</span> <span class="o">=</span> <span class="p">((</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">MemoryInfoFlag</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MemorySizeShift</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">AdapterMemSize</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">AdapterMemSize</span> <span class="o">&lt;</span> <span class="n">memorysize</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*           HELPER: Get DRAM type           */</span>
<span class="cm">/*********************************************/</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">SiS_Get310DRAMType</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>

   <span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">pSiS_SoftSetting</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SoftDRAMType</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">pSiS_SoftSetting</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
         <span class="cm">/* Do I need this? SR17 seems to be zero anyway... */</span>
	 <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_340</span><span class="p">)</span> <span class="p">{</span>
	 <span class="cm">/* TODO */</span>
	 <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ROMNew</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x78</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
	 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">data</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x78</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	 <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">IS_SIS550650740</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">data</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* 315, 330 */</span>
	 <span class="n">data</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x3a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_330</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	       <span class="k">switch</span><span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x5f</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
	       <span class="k">case</span> <span class="mh">0x00</span>: <span class="n">data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	       <span class="k">case</span> <span class="mh">0x10</span>: <span class="n">data</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	       <span class="k">case</span> <span class="mh">0x20</span>: <span class="n">data</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	       <span class="k">case</span> <span class="mh">0x30</span>: <span class="n">data</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	       <span class="p">}</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	       <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
	 <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetMCLK</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">ROMAddr</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">VirtualRomBase</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">index</span><span class="p">;</span>

   <span class="n">index</span> <span class="o">=</span> <span class="n">SiS_Get310DRAMType</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ROMNew</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">return</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">SISGETROMW</span><span class="p">((</span><span class="mh">0x90</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))));</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">CLOCK</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_1</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">4</span><span class="p">].</span><span class="n">CLOCK</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">CLOCK</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*           HELPER: ClearBuffer             */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_ClearBuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">SISIOMEMTYPE</span> <span class="o">*</span><span class="n">memaddr</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">VideoMemoryAddress</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">memsize</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">VideoMemorySize</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">SISIOMEMTYPE</span> <span class="o">*</span><span class="n">pBuffer</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">memaddr</span> <span class="o">||</span> <span class="o">!</span><span class="n">memsize</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">&gt;=</span> <span class="n">ModeEGA</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&gt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">memset_io</span><span class="p">(</span><span class="n">memaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">memsize</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="n">pBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">SISIOMEMTYPE</span> <span class="o">*</span><span class="p">)</span><span class="n">memaddr</span><span class="p">;</span>
	 <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x4000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">&lt;</span> <span class="n">ModeCGA</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">SISIOMEMTYPE</span> <span class="o">*</span><span class="p">)</span><span class="n">memaddr</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x4000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">writew</span><span class="p">(</span><span class="mh">0x0720</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">memset_io</span><span class="p">(</span><span class="n">memaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*           HELPER: SearchModeID            */</span>
<span class="cm">/*********************************************/</span>

<span class="n">bool</span>
<span class="nf">SiS_SearchModeID</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">VGAINFO</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAINFO</span><span class="p">;</span>

   <span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">ModeNo</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">ModeNo</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0x05</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">ModeNo</span><span class="p">)</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>

      <span class="k">for</span><span class="p">((</span><span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;(</span><span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SModeIDTable</span><span class="p">[(</span><span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)].</span><span class="n">St_ModeID</span> <span class="o">==</span> <span class="p">(</span><span class="o">*</span><span class="n">ModeNo</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SModeIDTable</span><span class="p">[(</span><span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)].</span><span class="n">St_ModeID</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">ModeNo</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">VGAINFO</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>   <span class="cm">/* 400 lines */</span>
	  <span class="cm">/* else 350 lines */</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">ModeNo</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">VGAINFO</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">(</span><span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">VGAINFO</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>    <span class="p">(</span><span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* 400 lines  */</span>
	 <span class="cm">/* else 350 lines  */</span>
      <span class="p">}</span>
      <span class="cm">/* else 200 lines  */</span>

   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

      <span class="k">for</span><span class="p">((</span><span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;(</span><span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_EModeIDTable</span><span class="p">[(</span><span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)].</span><span class="n">Ext_ModeID</span> <span class="o">==</span> <span class="p">(</span><span class="o">*</span><span class="n">ModeNo</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_EModeIDTable</span><span class="p">[(</span><span class="o">*</span><span class="n">ModeIdIndex</span><span class="p">)].</span><span class="n">Ext_ModeID</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="p">}</span>
   <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*            HELPER: GetModePtr             */</span>
<span class="cm">/*********************************************/</span>

<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetModePtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">index</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&lt;=</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">index</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SModeIDTable</span><span class="p">[</span><span class="n">ModeIdIndex</span><span class="p">].</span><span class="n">St_StTableIndex</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">&lt;=</span> <span class="n">ModeEGA</span><span class="p">)</span> <span class="n">index</span> <span class="o">=</span> <span class="mh">0x1B</span><span class="p">;</span>
      <span class="k">else</span> <span class="n">index</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*         HELPERS: Get some indices         */</span>
<span class="cm">/*********************************************/</span>

<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetRefCRTVCLK</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">Index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">UseWide</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">Index</span><span class="p">].</span><span class="n">Ext_InfoFlag</span> <span class="o">&amp;</span> <span class="n">HaveWideTiming</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">UseWide</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">Index</span><span class="p">].</span><span class="n">Ext_CRTVCLK_WIDE</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">return</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">Index</span><span class="p">].</span><span class="n">Ext_CRTVCLK_NORM</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">Index</span><span class="p">].</span><span class="n">Ext_CRTVCLK</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetRefCRT1CRTC</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">Index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">UseWide</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">Index</span><span class="p">].</span><span class="n">Ext_InfoFlag</span> <span class="o">&amp;</span> <span class="n">HaveWideTiming</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">UseWide</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">Index</span><span class="p">].</span><span class="n">Ext_CRT1CRTC_WIDE</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">return</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">Index</span><span class="p">].</span><span class="n">Ext_CRT1CRTC_NORM</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">Index</span><span class="p">].</span><span class="n">Ext_CRT1CRTC</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*           HELPER: LowModeTests            */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">SiS_DoLowModeTest</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">;</span>

   <span class="k">if</span><span class="p">((</span><span class="n">ModeNo</span> <span class="o">!=</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ModeNo</span> <span class="o">!=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ModeNo</span> <span class="o">!=</span> <span class="mh">0x12</span><span class="p">))</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x11</span><span class="p">);</span>
   <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x80</span><span class="p">);</span>
   <span class="n">temp1</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x55</span><span class="p">);</span>
   <span class="n">temp2</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="n">temp1</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>
   <span class="k">if</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="o">||</span>
      <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_300</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">temp2</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">temp2</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
      <span class="k">else</span> <span class="p">{</span>
	 <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x35</span><span class="p">,</span><span class="mh">0x01</span><span class="p">);</span>
	 <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetLowModeTest</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_DoLowModeTest</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SetFlag</span> <span class="o">|=</span> <span class="n">LowModeTests</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*        HELPER: OPEN/CLOSE CRT1 CRTC       */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_OpenCRTC</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span><span class="n">IS_SIS650</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">IS_SIS651</span><span class="p">)</span> <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x56</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">IS_SIS661741660760</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x61</span><span class="p">,</span><span class="mh">0xf7</span><span class="p">);</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">);</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x56</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ROMNew</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x3a</span><span class="p">,</span><span class="mh">0xef</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_CloseCRTC</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"> /* This locks some CRTC registers. We don&#39;t want that. */</span>
<span class="c">   unsigned short temp1 = 0, temp2 = 0;</span>

<span class="c">   if(IS_SIS661741660760) {</span>
<span class="c">      if(SiS_Pr-&gt;SiS_VBInfo &amp; SetCRT2ToLCDA) {</span>
<span class="c">         temp1 = 0xa0; temp2 = 0x08;</span>
<span class="c">      }</span>
<span class="c">      SiS_SetRegANDOR(SiS_Pr-&gt;SiS_P3d4,0x51,0x1f,temp1);</span>
<span class="c">      SiS_SetRegANDOR(SiS_Pr-&gt;SiS_P3d4,0x56,0xe7,temp2);</span>
<span class="c">   }</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_HandleCRT1</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="cm">/* Enable CRT1 gating */</span>
   <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MyCR63</span><span class="p">,</span><span class="mh">0xbf</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">   if(!(SiS_GetReg(SiS_Pr-&gt;SiS_P3c4,0x15) &amp; 0x01)) {</span>
<span class="c">      if((SiS_GetReg(SiS_Pr-&gt;SiS_P3c4,0x15) &amp; 0x0a) ||</span>
<span class="c">         (SiS_GetReg(SiS_Pr-&gt;SiS_P3c4,0x16) &amp; 0x01)) {</span>
<span class="c">         SiS_SetRegOR(SiS_Pr-&gt;SiS_P3d4,SiS_Pr-&gt;SiS_MyCR63,0x40);</span>
<span class="c">      }</span>
<span class="c">   }</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*           HELPER: GetColorDepth           */</span>
<span class="cm">/*********************************************/</span>

<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetColorDepth</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ColorDepth</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span> <span class="p">};</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">modeflag</span><span class="p">;</span>
   <span class="kt">short</span> <span class="n">index</span><span class="p">;</span>

   <span class="cm">/* Do NOT check UseCustomMode, will skrew up FIFO */</span>
   <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">modeflag</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CModeFlag</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&lt;=</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">modeflag</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SModeIDTable</span><span class="p">[</span><span class="n">ModeIdIndex</span><span class="p">].</span><span class="n">St_ModeFlag</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">modeflag</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_EModeIDTable</span><span class="p">[</span><span class="n">ModeIdIndex</span><span class="p">].</span><span class="n">Ext_ModeFlag</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">ModeTypeMask</span><span class="p">)</span> <span class="o">-</span> <span class="n">ModeEGA</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">ColorDepth</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*             HELPER: GetOffset             */</span>
<span class="cm">/*********************************************/</span>

<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetOffset</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">RRTI</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">xres</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">colordepth</span><span class="p">,</span> <span class="n">infoflag</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">infoflag</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CInfoFlag</span><span class="p">;</span>
      <span class="n">xres</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHDisplay</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">infoflag</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">RRTI</span><span class="p">].</span><span class="n">Ext_InfoFlag</span><span class="p">;</span>
      <span class="n">xres</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">RRTI</span><span class="p">].</span><span class="n">XRes</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">colordepth</span> <span class="o">=</span> <span class="n">SiS_GetColorDepth</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>

   <span class="n">temp</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">infoflag</span> <span class="o">&amp;</span> <span class="n">InterlaceMode</span><span class="p">)</span> <span class="n">temp</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">temp</span> <span class="o">*=</span> <span class="n">colordepth</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">xres</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="n">temp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">colordepth</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

   <span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                   SEQ                     */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetSeqRegs</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">StandTableIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SRdata</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x03</span><span class="p">);</span>

   <span class="cm">/* or &quot;display off&quot;  */</span>
   <span class="n">SRdata</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StandTable</span><span class="p">[</span><span class="n">StandTableIndex</span><span class="p">].</span><span class="n">SR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>

   <span class="cm">/* determine whether to force x8 dotclock */</span>
   <span class="k">if</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="n">VB_SISVB</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_LVDS</span><span class="p">))</span> <span class="p">{</span>

      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SetCRT2ToLCD</span> <span class="o">|</span> <span class="n">SetCRT2ToTV</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetInSlaveMode</span><span class="p">)</span>    <span class="n">SRdata</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetCRT2ToLCDA</span><span class="p">)</span> <span class="n">SRdata</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>

   <span class="p">}</span>

   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="n">SRdata</span><span class="p">);</span>

   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SRdata</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StandTable</span><span class="p">[</span><span class="n">StandTableIndex</span><span class="p">].</span><span class="n">SR</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">SRdata</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                  MISC                     */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetMiscRegs</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">StandTableIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Miscdata</span><span class="p">;</span>

   <span class="n">Miscdata</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StandTable</span><span class="p">[</span><span class="n">StandTableIndex</span><span class="p">].</span><span class="n">MISC</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="n">VB_SIS30xBLV</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetCRT2ToLCDA</span><span class="p">)</span> <span class="p">{</span>
	   <span class="n">Miscdata</span> <span class="o">|=</span> <span class="mh">0x0C</span><span class="p">;</span>
	 <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c2</span><span class="p">,</span><span class="n">Miscdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                  CRTC                     */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetCRTCRegs</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">StandTableIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">CRTCdata</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

   <span class="cm">/* Unlock CRTC */</span>
   <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">);</span>

   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x18</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">CRTCdata</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StandTable</span><span class="p">[</span><span class="n">StandTableIndex</span><span class="p">].</span><span class="n">CRTC</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">CRTCdata</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_OpenCRTC</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">CRTCdata</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StandTable</span><span class="p">[</span><span class="n">StandTableIndex</span><span class="p">].</span><span class="n">CRTC</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	 <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">CRTCdata</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_630</span><span class="p">)</span> <span class="o">||</span>
	        <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_730</span><span class="p">)</span> <span class="p">)</span>  <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipRevision</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetInSlaveMode</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SetCRT2ToLCD</span> <span class="o">|</span> <span class="n">SetCRT2ToTV</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">);</span>
	 <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                   ATT                     */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetATTRegs</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">StandTableIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">ARdata</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ARdata</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StandTable</span><span class="p">[</span><span class="n">StandTableIndex</span><span class="p">].</span><span class="n">ATTR</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

      <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
	 <span class="cm">/* Pixel shift. If screen on LCD or TV is shifted left or right,</span>
<span class="cm">	  * this might be the cause.</span>
<span class="cm">	  */</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="n">VB_SIS30xBLV</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetCRT2ToLCDA</span><span class="p">)</span> <span class="n">ARdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	 <span class="p">}</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_LVDS</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_CH70xx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	       <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetCRT2ToTV</span><span class="p">)</span> <span class="p">{</span>
		  <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetInSlaveMode</span><span class="p">)</span> <span class="n">ARdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	       <span class="p">}</span>
	    <span class="p">}</span>
	 <span class="p">}</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SetCRT2ToTV</span> <span class="o">|</span> <span class="n">SetCRT2ToLCD</span><span class="p">))</span> <span class="p">{</span>
	       <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetInSlaveMode</span><span class="p">)</span> <span class="n">ARdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
	 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetCRT2ToLCD</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
	       <span class="k">if</span><span class="p">(</span><span class="n">IS_SIS550650740660</span><span class="p">)</span> <span class="p">{</span>
		  <span class="cm">/* 315, 330 don&#39;t do this */</span>
		  <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="n">VB_SIS30xB</span><span class="p">)</span> <span class="p">{</span>
		     <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetInSlaveMode</span><span class="p">)</span> <span class="n">ARdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		     <span class="n">ARdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		  <span class="p">}</span>
	       <span class="p">}</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	       <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetInSlaveMode</span><span class="p">)</span> <span class="n">ARdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
	 <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3da</span><span class="p">);</span>		<span class="cm">/* reset 3da  */</span>
      <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c0</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>	<span class="cm">/* set index  */</span>
      <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c0</span><span class="p">,</span><span class="n">ARdata</span><span class="p">);</span>	<span class="cm">/* set data   */</span>
   <span class="p">}</span>

   <span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3da</span><span class="p">);</span>		<span class="cm">/* reset 3da  */</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c0</span><span class="p">,</span><span class="mh">0x14</span><span class="p">);</span>	<span class="cm">/* set index  */</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* set data   */</span>

   <span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3da</span><span class="p">);</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c0</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>	<span class="cm">/* Enable Attribute  */</span>
   <span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3da</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                   GRC                     */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetGRCRegs</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">StandTableIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">GRdata</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">GRdata</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_StandTable</span><span class="p">[</span><span class="n">StandTableIndex</span><span class="p">].</span><span class="n">GRC</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3ce</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">GRdata</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">&gt;</span> <span class="n">ModeVGA</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* 256 color disable */</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3ce</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0xBF</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*          CLEAR EXTENDED REGISTERS         */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_ClearExt1Regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x0E</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x37</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&lt;=</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">==</span> <span class="mh">0x06</span> <span class="o">||</span> <span class="n">ModeNo</span> <span class="o">&gt;=</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0e</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
	 <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                 RESET VCLK                */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_ResetCRT1VCLK</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_LVDS</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_LVDS</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	 <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="n">VB_SIS30xBLV</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
	 <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0xcf</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2B</span><span class="p">,</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">SR2B</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2C</span><span class="p">,</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">SR2C</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2D</span><span class="p">,</span><span class="mh">0x80</span><span class="p">);</span>
   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0xcf</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2B</span><span class="p">,</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">SR2B</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2C</span><span class="p">,</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">SR2C</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2D</span><span class="p">,</span><span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                  SYNC                     */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetCRT1Sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">RRTI</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sync</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sync</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CInfoFlag</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">sync</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">RRTI</span><span class="p">].</span><span class="n">Ext_InfoFlag</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">sync</span> <span class="o">&amp;=</span> <span class="mh">0xC0</span><span class="p">;</span>
   <span class="n">sync</span> <span class="o">|=</span> <span class="mh">0x2f</span><span class="p">;</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c2</span><span class="p">,</span><span class="n">sync</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                  CRTC/2                   */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetCRT1CRTC</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">RRTI</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">modeflag</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">crt1data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="n">modeflag</span> <span class="o">=</span> <span class="n">SiS_GetModeFlag</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">crt1data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

      <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetRefCRT1CRTC</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">RRTI</span><span class="p">,</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_UseWide</span><span class="p">);</span>

      <span class="cm">/* Alternate for 1600x1200 LCDA */</span>
      <span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">Alternate1600x1200</span><span class="p">))</span> <span class="n">temp</span> <span class="o">=</span> <span class="mh">0x57</span><span class="p">;</span>

      <span class="n">crt1data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CRT1Table</span><span class="p">[</span><span class="n">temp</span><span class="p">].</span><span class="n">CR</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

   <span class="p">}</span>

   <span class="cm">/* unlock cr0-7 */</span>
   <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">);</span>

   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">crt1data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
   <span class="p">}</span>
   <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">crt1data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
   <span class="p">}</span>
   <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">crt1data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
   <span class="p">}</span>
   <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">crt1data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
   <span class="p">}</span>

   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0E</span><span class="p">,</span><span class="n">crt1data</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">);</span>

   <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">crt1data</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">DoubleScanMode</span><span class="p">)</span> <span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0x5F</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">&gt;</span> <span class="n">ModeVGA</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x14</span><span class="p">,</span><span class="mh">0x4F</span><span class="p">);</span>
   <span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="n">crt1data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="n">crt1data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0c</span><span class="p">,</span><span class="mh">0xfb</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0xe0</span><span class="p">,((</span><span class="n">temp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">));</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">crt1data</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="n">temp</span> <span class="o">-=</span> <span class="mi">7</span><span class="p">;</span>
      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0e</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">,(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
   <span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*               OFFSET &amp; PITCH              */</span>
<span class="cm">/*********************************************/</span>
<span class="cm">/*  (partly overruled by SetPitch() in XF86) */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetCRT1Offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">RRTI</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">,</span> <span class="n">DisplayUnit</span><span class="p">,</span> <span class="n">infoflag</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">infoflag</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CInfoFlag</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">infoflag</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">RRTI</span><span class="p">].</span><span class="n">Ext_InfoFlag</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">DisplayUnit</span> <span class="o">=</span> <span class="n">SiS_GetOffset</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="n">RRTI</span><span class="p">);</span>

   <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">DisplayUnit</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0E</span><span class="p">,</span><span class="mh">0xF0</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>

   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="n">DisplayUnit</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">infoflag</span> <span class="o">&amp;</span> <span class="n">InterlaceMode</span><span class="p">)</span> <span class="n">DisplayUnit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

   <span class="n">DisplayUnit</span> <span class="o">&lt;&lt;=</span> <span class="mi">5</span><span class="p">;</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">DisplayUnit</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">DisplayUnit</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="n">temp</span><span class="o">++</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">==</span> <span class="mh">0x4a</span> <span class="o">||</span> <span class="n">ModeNo</span> <span class="o">==</span> <span class="mh">0x49</span><span class="p">)</span> <span class="n">temp</span><span class="o">--</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                  VCLK                     */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetCRT1VCLK</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">RRTI</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">clka</span><span class="p">,</span> <span class="n">clkb</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">clka</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CSR2B</span><span class="p">;</span>
      <span class="n">clkb</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CSR2C</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">index</span> <span class="o">=</span> <span class="n">SiS_GetVCLK2Ptr</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="n">RRTI</span><span class="p">);</span>
      <span class="k">if</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="n">VB_SIS30xBLV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	 <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetCRT2ToLCDA</span><span class="p">))</span> <span class="p">{</span>
	 <span class="cm">/* Alternate for 1600x1200 LCDA */</span>
	 <span class="k">if</span><span class="p">((</span><span class="n">index</span> <span class="o">==</span> <span class="mh">0x21</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">Alternate1600x1200</span><span class="p">))</span> <span class="n">index</span> <span class="o">=</span> <span class="mh">0x72</span><span class="p">;</span>
	 <span class="n">clka</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBVCLKData</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">Part4_A</span><span class="p">;</span>
	 <span class="n">clkb</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBVCLKData</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">Part4_B</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="n">clka</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">SR2B</span><span class="p">;</span>
	 <span class="n">clkb</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">SR2C</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">);</span>

   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2b</span><span class="p">,</span><span class="n">clka</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2c</span><span class="p">,</span><span class="n">clkb</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2D</span><span class="p">,</span><span class="mh">0x01</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mf</span> <span class="o">=</span> <span class="n">SiS_GetModeFlag</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">mf</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2b</span><span class="p">,</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2b</span><span class="p">));</span>
	    <span class="n">clkb</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2c</span><span class="p">);</span>
	    <span class="n">clkb</span> <span class="o">=</span> <span class="p">(((</span><span class="n">clkb</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">clkb</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">);</span>
	    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2c</span><span class="p">,</span><span class="n">clkb</span><span class="p">);</span>
	 <span class="p">}</span>
      <span class="p">}</span>
<span class="cp">#endif</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2D</span><span class="p">,</span><span class="mh">0x80</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                  FIFO                     */</span>
<span class="cm">/*********************************************/</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
<span class="kt">void</span>
<span class="nf">SiS_GetFIFOThresholdIndex300</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">idx1</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">idx2</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">;</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ThTiming</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
   <span class="p">};</span>

   <span class="n">temp1</span> <span class="o">=</span> <span class="n">temp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x62</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">(</span><span class="o">*</span><span class="n">idx2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">ThTiming</span><span class="p">[((</span><span class="n">temp2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">temp1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]);</span>
   <span class="p">(</span><span class="o">*</span><span class="n">idx1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
   <span class="p">(</span><span class="o">*</span><span class="n">idx1</span><span class="p">)</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(((</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x14</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">));</span>
   <span class="p">(</span><span class="o">*</span><span class="n">idx1</span><span class="p">)</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetFIFOThresholdA300</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">idx1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">idx2</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ThLowA</span><span class="p">[</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">61</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span><span class="mi">68</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span>
		<span class="mi">43</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span>
		<span class="mi">34</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span><span class="mi">11</span>
   <span class="p">};</span>

   <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)((</span><span class="n">ThLowA</span><span class="p">[</span><span class="n">idx1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">idx2</span><span class="p">)</span> <span class="o">+</span> <span class="n">ThLowA</span><span class="p">[</span><span class="n">idx1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetFIFOThresholdB300</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">idx1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">idx2</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ThLowB</span><span class="p">[</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">81</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="mi">72</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span>
		<span class="mi">55</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span>
		<span class="mi">42</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span><span class="mi">12</span>
   <span class="p">};</span>

   <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)((</span><span class="n">ThLowB</span><span class="p">[</span><span class="n">idx1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">idx2</span><span class="p">)</span> <span class="o">+</span> <span class="n">ThLowB</span><span class="p">[</span><span class="n">idx1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_DoCalcDelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">MCLK</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">VCLK</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">colordepth</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">longtemp</span> <span class="o">=</span> <span class="n">VCLK</span> <span class="o">*</span> <span class="n">colordepth</span><span class="p">;</span>

   <span class="n">SiS_GetFIFOThresholdIndex300</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx2</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">longtemp</span> <span class="o">*=</span> <span class="n">SiS_GetFIFOThresholdA300</span><span class="p">(</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">longtemp</span> <span class="o">*=</span> <span class="n">SiS_GetFIFOThresholdB300</span><span class="p">(</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">idx1</span> <span class="o">=</span> <span class="n">longtemp</span> <span class="o">%</span> <span class="p">(</span><span class="n">MCLK</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
   <span class="n">longtemp</span> <span class="o">/=</span> <span class="p">(</span><span class="n">MCLK</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="n">idx1</span><span class="p">)</span> <span class="n">longtemp</span><span class="o">++</span><span class="p">;</span>
   <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">longtemp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_CalcDelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">VCLK</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">colordepth</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">MCLK</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">;</span>

   <span class="n">temp2</span> <span class="o">=</span> <span class="n">SiS_DoCalcDelay</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">MCLK</span><span class="p">,</span> <span class="n">VCLK</span><span class="p">,</span> <span class="n">colordepth</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
   <span class="n">temp1</span> <span class="o">=</span> <span class="n">SiS_DoCalcDelay</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">MCLK</span><span class="p">,</span> <span class="n">VCLK</span><span class="p">,</span> <span class="n">colordepth</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="n">temp1</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="n">temp1</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
   <span class="n">temp1</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">temp2</span> <span class="o">&lt;</span> <span class="n">temp1</span><span class="p">)</span> <span class="n">temp2</span> <span class="o">=</span> <span class="n">temp1</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">temp2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetCRT1FIFO_300</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">RefreshRateTableIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ThresholdLow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">VCLK</span><span class="p">,</span> <span class="n">MCLK</span><span class="p">,</span> <span class="n">colorth</span><span class="p">;</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">colortharray</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">};</span>

   <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&gt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>

      <span class="cm">/* Get VCLK  */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">VCLK</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CSRClock</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="n">index</span> <span class="o">=</span> <span class="n">SiS_GetRefCRTVCLK</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">RefreshRateTableIndex</span><span class="p">,</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_UseWide</span><span class="p">);</span>
	 <span class="n">VCLK</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">CLOCK</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="cm">/* Get half colordepth */</span>
      <span class="n">colorth</span> <span class="o">=</span> <span class="n">colortharray</span><span class="p">[(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">-</span> <span class="n">ModeEGA</span><span class="p">)];</span>

      <span class="cm">/* Get MCLK  */</span>
      <span class="n">index</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x3A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
      <span class="n">MCLK</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">CLOCK</span><span class="p">;</span>

      <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x35</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc3</span><span class="p">;</span>
      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0x3c</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>

      <span class="k">do</span> <span class="p">{</span>
	 <span class="n">ThresholdLow</span> <span class="o">=</span> <span class="n">SiS_CalcDelay</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">VCLK</span><span class="p">,</span> <span class="n">colorth</span><span class="p">,</span> <span class="n">MCLK</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">ThresholdLow</span> <span class="o">&lt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
	 <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0xfc</span><span class="p">);</span>
	 <span class="n">ThresholdLow</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>
	 <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">temp</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
	 <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0x3f</span><span class="p">,((</span><span class="n">temp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

   <span class="p">}</span> <span class="k">else</span> <span class="n">ThresholdLow</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

   <span class="cm">/* Write CRT/CPU threshold low, CRT/Engine threshold high */</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ThresholdLow</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span><span class="p">;</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>

   <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ThresholdLow</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&gt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0f</span><span class="p">,</span><span class="mh">0x9f</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>

   <span class="cm">/* What is this? */</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0x09</span><span class="p">);</span>

   <span class="cm">/* Write CRT/CPU threshold high */</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="n">ThresholdLow</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x09</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_GetLatencyFactor630</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">LatencyFactor</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">97</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>       <span class="cm">/* 64  bit    BQ=2   */</span>
		 <span class="mi">0</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span>       <span class="cm">/* 64  bit    BQ=1   */</span>
		<span class="mi">97</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>       <span class="cm">/* 128 bit    BQ=2   */</span>
		 <span class="mi">0</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>       <span class="cm">/* 128 bit    BQ=1   */</span>
		<span class="mi">80</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>       <span class="cm">/* 64  bit    BQ=2   */</span>
		 <span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span>       <span class="cm">/* 64  bit    BQ=1   */</span>
		<span class="mi">86</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>       <span class="cm">/* 128 bit    BQ=2   */</span>
		 <span class="mi">0</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">37</span>        <span class="cm">/* 128 bit    BQ=1   */</span>
   <span class="p">};</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">LatencyFactor730</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="mi">69</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span>
		 <span class="mi">86</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span>
		<span class="mi">103</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span>
		<span class="mi">120</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span>
		<span class="mi">137</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mi">128</span>
   <span class="p">};</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_730</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">LatencyFactor730</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">LatencyFactor</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">SiS_CalcDelay2</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">index</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_730</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">index</span> <span class="o">=</span> <span class="p">((</span><span class="n">key</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">key</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>    <span class="n">index</span> <span class="o">+=</span>  <span class="mi">6</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">key</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="n">index</span> <span class="o">+=</span> <span class="mi">24</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="n">index</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">SiS_GetLatencyFactor630</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetCRT1FIFO_630</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
                    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">RefreshRateTableIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">ThresholdLow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">VCLK</span><span class="p">,</span> <span class="n">MCLK16</span><span class="p">,</span> <span class="n">colorth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">templ</span><span class="p">,</span> <span class="n">datal</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">queuedata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FQBQData</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x01</span><span class="p">,</span><span class="mh">0x21</span><span class="p">,</span><span class="mh">0x41</span><span class="p">,</span><span class="mh">0x61</span><span class="p">,</span><span class="mh">0x81</span><span class="p">,</span>
		<span class="mh">0x31</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x71</span><span class="p">,</span><span class="mh">0x91</span><span class="p">,</span><span class="mh">0xb1</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span>
		<span class="mh">0x30</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span>
		<span class="mh">0xff</span>
   <span class="p">};</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FQBQData730</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x34</span><span class="p">,</span><span class="mh">0x74</span><span class="p">,</span><span class="mh">0xb4</span><span class="p">,</span>
		<span class="mh">0x23</span><span class="p">,</span><span class="mh">0x63</span><span class="p">,</span><span class="mh">0xa3</span><span class="p">,</span>
		<span class="mh">0x12</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x92</span><span class="p">,</span>
		<span class="mh">0x01</span><span class="p">,</span><span class="mh">0x41</span><span class="p">,</span><span class="mh">0x81</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span>
		<span class="mh">0xff</span>
   <span class="p">};</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">colortharray</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
   <span class="p">};</span>

   <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&gt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>

      <span class="cm">/* Get VCLK  */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">VCLK</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CSRClock</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="n">data</span> <span class="o">=</span> <span class="n">SiS_GetRefCRTVCLK</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">RefreshRateTableIndex</span><span class="p">,</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_UseWide</span><span class="p">);</span>
	 <span class="n">VCLK</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span><span class="p">[</span><span class="n">data</span><span class="p">].</span><span class="n">CLOCK</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="cm">/* Get MCLK * 16 */</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x1A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
      <span class="n">MCLK16</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_MCLKData_0</span><span class="p">[</span><span class="n">data</span><span class="p">].</span><span class="n">CLOCK</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>

      <span class="cm">/* Get half colordepth */</span>
      <span class="n">colorth</span> <span class="o">=</span> <span class="n">colortharray</span><span class="p">[(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">-</span> <span class="n">ModeEGA</span><span class="p">)];</span>

      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_730</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">queuedata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FQBQData730</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="n">queuedata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FQBQData</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>

      <span class="k">do</span> <span class="p">{</span>
	 <span class="n">templ</span> <span class="o">=</span> <span class="n">SiS_CalcDelay2</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">queuedata</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">VCLK</span> <span class="o">*</span> <span class="n">colorth</span><span class="p">;</span>

	 <span class="n">datal</span> <span class="o">=</span> <span class="n">templ</span> <span class="o">%</span> <span class="n">MCLK16</span><span class="p">;</span>
	 <span class="n">templ</span> <span class="o">=</span> <span class="p">(</span><span class="n">templ</span> <span class="o">/</span> <span class="n">MCLK16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">datal</span><span class="p">)</span> <span class="n">templ</span><span class="o">++</span><span class="p">;</span>

	 <span class="k">if</span><span class="p">(</span><span class="n">templ</span> <span class="o">&gt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">queuedata</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">ThresholdLow</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>
	       <span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
	 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">ThresholdLow</span> <span class="o">=</span> <span class="n">templ</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	 <span class="p">}</span>
      <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">queuedata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">);</span>

   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">!=</span> <span class="n">SIS_730</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
      <span class="n">ThresholdLow</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>

   <span class="p">}</span>

   <span class="cm">/* Write CRT/CPU threshold low, CRT/Engine threshold high */</span>
   <span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="n">ThresholdLow</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span><span class="p">;</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>

   <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">ThresholdLow</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0F</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>

   <span class="cm">/* What is this? */</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0x09</span><span class="p">);</span>

   <span class="cm">/* Write CRT/CPU threshold high (gap = 3) */</span>
   <span class="n">data</span> <span class="o">=</span> <span class="n">ThresholdLow</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>

  <span class="cm">/* Write foreground and background queue */</span>
   <span class="n">templ</span> <span class="o">=</span> <span class="n">sisfb_read_nbridge_pci_dword</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_730</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">templ</span> <span class="o">&amp;=</span> <span class="mh">0xfffff9ff</span><span class="p">;</span>
      <span class="n">templ</span> <span class="o">|=</span> <span class="p">((</span><span class="n">queuedata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

      <span class="n">templ</span> <span class="o">&amp;=</span> <span class="mh">0xf0ffffff</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">ModeNo</span> <span class="o">&lt;=</span> <span class="mh">0x13</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_630</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	  <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipRevision</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
	 <span class="n">templ</span> <span class="o">|=</span> <span class="mh">0x0b000000</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">templ</span> <span class="o">|=</span> <span class="p">((</span><span class="n">queuedata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
      <span class="p">}</span>

   <span class="p">}</span>

   <span class="n">sisfb_write_nbridge_pci_dword</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">templ</span><span class="p">);</span>
   <span class="n">templ</span> <span class="o">=</span> <span class="n">sisfb_read_nbridge_pci_dword</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">);</span>

   <span class="cm">/* GUI grant timer (PCI config 0xA3) */</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_730</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">templ</span> <span class="o">&amp;=</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
      <span class="n">datal</span> <span class="o">=</span> <span class="n">queuedata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
      <span class="n">templ</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">datal</span> <span class="o">&amp;</span> <span class="mh">0x0f00</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">datal</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

      <span class="n">templ</span> <span class="o">&amp;=</span> <span class="mh">0xf0ffffff</span><span class="p">;</span>
      <span class="n">templ</span> <span class="o">|=</span> <span class="p">((</span><span class="n">queuedata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

   <span class="p">}</span>

   <span class="n">sisfb_write_nbridge_pci_dword</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="n">templ</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_SIS_300 */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetCRT1FIFO_310</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">modeflag</span><span class="p">;</span>

   <span class="cm">/* disable auto-threshold */</span>
   <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x3D</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">);</span>

   <span class="n">modeflag</span> <span class="o">=</span> <span class="n">SiS_GetModeFlag</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>

   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0xAE</span><span class="p">);</span>
   <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0xF0</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&gt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x34</span><span class="p">);</span>
	 <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x3D</span><span class="p">,</span><span class="mh">0x01</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x34</span><span class="p">);</span>
	    <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x3D</span><span class="p">,</span><span class="mh">0x01</span><span class="p">);</span>
	 <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">DoubleScanMode</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">)))</span> <span class="p">{</span>
	    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x34</span><span class="p">);</span>
	    <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x3D</span><span class="p">,</span><span class="mh">0x01</span><span class="p">);</span>
	 <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*              MODE REGISTERS               */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetVCLKState</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">RefreshRateTableIndex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VCLK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&gt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">VCLK</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CSRClock</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">index</span> <span class="o">=</span> <span class="n">SiS_GetVCLK2Ptr</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="n">RefreshRateTableIndex</span><span class="p">);</span>
         <span class="n">VCLK</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">CLOCK</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
      <span class="k">if</span><span class="p">(</span><span class="n">VCLK</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">)</span> <span class="n">data</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span><span class="mh">0x7B</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>

      <span class="n">data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">VCLK</span> <span class="o">&gt;=</span> <span class="mi">150</span><span class="p">)</span> <span class="n">data</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0xF7</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
<span class="cp">#endif</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
      <span class="k">if</span><span class="p">(</span><span class="n">VCLK</span> <span class="o">&gt;=</span> <span class="mi">166</span><span class="p">)</span> <span class="n">data</span> <span class="o">|=</span> <span class="mh">0x0c</span><span class="p">;</span>
      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0xf3</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="n">VCLK</span> <span class="o">&gt;=</span> <span class="mi">166</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">);</span>
      <span class="p">}</span>
<span class="cp">#endif</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
      <span class="k">if</span><span class="p">(</span><span class="n">VCLK</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span> <span class="n">data</span> <span class="o">|=</span> <span class="mh">0x0c</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">;</span>
      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0xf3</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">!=</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">data</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xe7</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">VCLK</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">)</span> <span class="n">data</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	 <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
      <span class="p">}</span>
<span class="cp">#endif</span>
   <span class="p">}</span>

   <span class="cm">/* DAC speed */</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span><span class="mh">0xE8</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>

   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

      <span class="n">data</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">VCLK</span> <span class="o">&gt;=</span> <span class="mi">260</span><span class="p">)</span>      <span class="n">data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VCLK</span> <span class="o">&gt;=</span> <span class="mi">160</span><span class="p">)</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">VCLK</span> <span class="o">&gt;=</span> <span class="mi">135</span><span class="p">)</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_540</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span><span class="p">((</span><span class="n">VCLK</span> <span class="o">==</span> <span class="mi">203</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">VCLK</span> <span class="o">&lt;</span> <span class="mi">234</span><span class="p">))</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span><span class="mh">0xFC</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;</span> <span class="n">SIS_315PRO</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&gt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0xfc</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span><span class="mh">0xF8</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
      <span class="p">}</span>

   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetCRT1ModeRegs</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">RRTI</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">,</span> <span class="n">infoflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">modeflag</span><span class="p">,</span> <span class="n">resindex</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">ROMAddr</span>  <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">VirtualRomBase</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data2</span><span class="p">,</span> <span class="n">data3</span><span class="p">;</span>
<span class="cp">#endif</span>

   <span class="n">modeflag</span> <span class="o">=</span> <span class="n">SiS_GetModeFlag</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">infoflag</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CInfoFlag</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">resindex</span> <span class="o">=</span> <span class="n">SiS_GetResInfo</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&gt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">infoflag</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_RefIndex</span><span class="p">[</span><span class="n">RRTI</span><span class="p">].</span><span class="n">Ext_InfoFlag</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="cm">/* Disable DPMS */</span>
   <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x1F</span><span class="p">,</span><span class="mh">0x3F</span><span class="p">);</span>

   <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&gt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">&gt;</span> <span class="n">ModeEGA</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">data</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
         <span class="n">data</span> <span class="o">|=</span> <span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">-</span> <span class="n">ModeVGA</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">infoflag</span> <span class="o">&amp;</span> <span class="n">InterlaceMode</span><span class="p">)</span> <span class="n">data</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">!=</span> <span class="n">SIS_300</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">infoflag</span> <span class="o">&amp;</span> <span class="n">InterlaceMode</span><span class="p">)</span> <span class="p">{</span>
	 <span class="cm">/* data = (Hsync / 8) - ((Htotal / 8) / 2) + 3 */</span>
	 <span class="kt">int</span> <span class="n">hrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x04</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
	 <span class="kt">int</span> <span class="n">hto</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x00</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	 <span class="n">data</span> <span class="o">=</span> <span class="n">hrs</span> <span class="o">-</span> <span class="p">(</span><span class="n">hto</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x19</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x1a</span><span class="p">,</span><span class="mh">0xFC</span><span class="p">,((</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">));</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x08</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">LineCompareOff</span><span class="p">)</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_300</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0F</span><span class="p">,</span><span class="mh">0xF7</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="n">data</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">==</span> <span class="n">ModeEGA</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&gt;</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">data</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	 <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0F</span><span class="p">,</span><span class="mh">0xB7</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
   <span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0xfb</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_315PRO</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">data</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SR15</span><span class="p">[(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">SiS_Get310DRAMType</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">)];</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">==</span> <span class="n">ModeText</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0xc7</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="n">data2</span> <span class="o">=</span> <span class="n">SiS_GetOffset</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="n">RRTI</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">infoflag</span> <span class="o">&amp;</span> <span class="n">InterlaceMode</span><span class="p">)</span> <span class="n">data2</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="n">data3</span> <span class="o">=</span> <span class="n">SiS_GetColorDepth</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">data3</span><span class="p">)</span> <span class="n">data2</span> <span class="o">/=</span> <span class="n">data3</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0x50</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
	    <span class="n">data</span> <span class="o">|=</span> <span class="mh">0x50</span><span class="p">;</span>
	 <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x17</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>

   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_330</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">&amp;</span> <span class="n">SF_760LFB</span><span class="p">))</span> <span class="p">{</span>

      <span class="n">data</span> <span class="o">=</span> <span class="n">SiS_Get310DRAMType</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_330</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">data</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SR15</span><span class="p">[(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ROMNew</span><span class="p">)</span>	     <span class="n">data</span> <span class="o">=</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0xf6</span><span class="p">];</span>
	 <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_UseROM</span><span class="p">)</span> <span class="n">data</span> <span class="o">=</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x100</span> <span class="o">+</span> <span class="n">data</span><span class="p">];</span>
	 <span class="k">else</span>			     <span class="n">data</span> <span class="o">=</span> <span class="mh">0xba</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">&lt;=</span> <span class="n">ModeEGA</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0xc7</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">data2</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CSRClock</span><span class="p">;</span>
	 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">data2</span> <span class="o">=</span> <span class="n">SiS_GetVCLK2Ptr</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="n">RRTI</span><span class="p">);</span>
	    <span class="n">data2</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VCLKData</span><span class="p">[</span><span class="n">data2</span><span class="p">].</span><span class="n">CLOCK</span><span class="p">;</span>
	 <span class="p">}</span>

	 <span class="n">data3</span> <span class="o">=</span> <span class="n">SiS_GetColorDepth</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">data3</span><span class="p">)</span> <span class="n">data2</span> <span class="o">*=</span> <span class="n">data3</span><span class="p">;</span>

	 <span class="n">data2</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">SiS_GetMCLK</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="o">/</span> <span class="n">data2</span><span class="p">;</span>

	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_330</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">!=</span> <span class="n">Mode16Bpp</span><span class="p">)</span> <span class="p">{</span>
	       <span class="k">if</span>     <span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0x19c</span><span class="p">)</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0xba</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0x140</span><span class="p">)</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0x7a</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0x101</span><span class="p">)</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0x3a</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0xf5</span><span class="p">)</span>  <span class="n">data</span> <span class="o">=</span> <span class="mh">0x32</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0xe2</span><span class="p">)</span>  <span class="n">data</span> <span class="o">=</span> <span class="mh">0x2a</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0xc4</span><span class="p">)</span>  <span class="n">data</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0xac</span><span class="p">)</span>  <span class="n">data</span> <span class="o">=</span> <span class="mh">0x1a</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0x9e</span><span class="p">)</span>  <span class="n">data</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0x8e</span><span class="p">)</span>  <span class="n">data</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span>
	       <span class="k">else</span>                    <span class="n">data</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	       <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0x127</span><span class="p">)</span>      <span class="n">data</span> <span class="o">=</span> <span class="mh">0xba</span><span class="p">;</span>
	       <span class="k">else</span>                    <span class="n">data</span> <span class="o">=</span> <span class="mh">0x7a</span><span class="p">;</span>
	    <span class="p">}</span>
	 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* 76x+LFB */</span>
	    <span class="k">if</span>     <span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0x190</span><span class="p">)</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0xba</span><span class="p">;</span>
	    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0xff</span><span class="p">)</span>  <span class="n">data</span> <span class="o">=</span> <span class="mh">0x7a</span><span class="p">;</span>
	    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0xd3</span><span class="p">)</span>  <span class="n">data</span> <span class="o">=</span> <span class="mh">0x3a</span><span class="p">;</span>
	    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0xa9</span><span class="p">)</span>  <span class="n">data</span> <span class="o">=</span> <span class="mh">0x1a</span><span class="p">;</span>
	    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data2</span> <span class="o">&gt;=</span> <span class="mh">0x93</span><span class="p">)</span>  <span class="n">data</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span>
	    <span class="k">else</span>                    <span class="n">data</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	 <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x17</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>

   <span class="p">}</span>
      <span class="cm">/* XGI: Nothing. */</span>
      <span class="cm">/* TODO: Check SiS340 */</span>
<span class="cp">#endif</span>

   <span class="n">data</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">!=</span> <span class="n">ModeText</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">data</span> <span class="o">^=</span> <span class="mh">0x60</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ModeType</span> <span class="o">!=</span> <span class="n">ModeEGA</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">data</span> <span class="o">^=</span> <span class="mh">0xA0</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x21</span><span class="p">,</span><span class="mh">0x1F</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>

   <span class="n">SiS_SetVCLKState</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">RRTI</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
   <span class="k">if</span><span class="p">(((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_661</span><span class="p">))</span> <span class="o">||</span>
       <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x2c</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x6c</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x33</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x73</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x02</span><span class="p">);</span>
   <span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetupDualChip</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">   /* TODO: Find out about IOAddress2 */</span>
<span class="c">   SISIOADDRESS P2_3c2 = SiS_Pr-&gt;IOAddress2 + 0x12;</span>
<span class="c">   SISIOADDRESS P2_3c4 = SiS_Pr-&gt;IOAddress2 + 0x14;</span>
<span class="c">   SISIOADDRESS P2_3ce = SiS_Pr-&gt;IOAddress2 + 0x1e;</span>
<span class="c">   int i;</span>

<span class="c">   if((SiS_Pr-&gt;ChipRevision != 0) ||</span>
<span class="c">      (!(SiS_GetReg(SiS_Pr-&gt;SiS_P3c4,0x3a) &amp; 0x04)))</span>
<span class="c">      return;</span>

<span class="c">   for(i = 0; i &lt;= 4; i++) {					/* SR00 - SR04 */</span>
<span class="c">      SiS_SetReg(P2_3c4,i,SiS_GetReg(SiS_Pr-&gt;SiS_P3c4,i));</span>
<span class="c">   }</span>
<span class="c">   for(i = 0; i &lt;= 8; i++) {					/* GR00 - GR08 */</span>
<span class="c">      SiS_SetReg(P2_3ce,i,SiS_GetReg(SiS_Pr-&gt;SiS_P3ce,i));</span>
<span class="c">   }</span>
<span class="c">   SiS_SetReg(P2_3c4,0x05,0x86);</span>
<span class="c">   SiS_SetReg(P2_3c4,0x06,SiS_GetReg(SiS_Pr-&gt;SiS_P3c4,0x06));	/* SR06 */</span>
<span class="c">   SiS_SetReg(P2_3c4,0x21,SiS_GetReg(SiS_Pr-&gt;SiS_P3c4,0x21));	/* SR21 */</span>
<span class="c">   SiS_SetRegByte(P2_3c2,SiS_GetRegByte(SiS_Pr-&gt;SiS_P3cc));	/* MISC */</span>
<span class="c">   SiS_SetReg(P2_3c4,0x05,0x00);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                 LOAD DAC                  */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_WriteDAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">SISIOADDRESS</span> <span class="n">DACData</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">shiftflag</span><span class="p">,</span>
             <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ah</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">al</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dh</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">;</span>

   <span class="k">switch</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">case</span>  <span class="mi">0</span>: <span class="n">d1</span> <span class="o">=</span> <span class="n">dh</span><span class="p">;</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">ah</span><span class="p">;</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">al</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
   <span class="k">case</span>  <span class="mi">1</span>: <span class="n">d1</span> <span class="o">=</span> <span class="n">ah</span><span class="p">;</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">al</span><span class="p">;</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">dh</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
   <span class="nl">default:</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">al</span><span class="p">;</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">dh</span><span class="p">;</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">ah</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">DACData</span><span class="p">,</span> <span class="p">(</span><span class="n">d1</span> <span class="o">&lt;&lt;</span> <span class="n">shiftflag</span><span class="p">));</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">DACData</span><span class="p">,</span> <span class="p">(</span><span class="n">d2</span> <span class="o">&lt;&lt;</span> <span class="n">shiftflag</span><span class="p">));</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">DACData</span><span class="p">,</span> <span class="p">(</span><span class="n">d3</span> <span class="o">&lt;&lt;</span> <span class="n">shiftflag</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">SiS_LoadDAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">si</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">sf</span><span class="p">;</span>
   <span class="n">SISIOADDRESS</span> <span class="n">DACAddr</span><span class="p">,</span> <span class="n">DACData</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="n">data</span> <span class="o">=</span> <span class="n">SiS_GetModeFlag</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DACInfoFlag</span><span class="p">;</span>

   <span class="n">j</span> <span class="o">=</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>      <span class="n">table</span> <span class="o">=</span> <span class="n">SiS_MDA_DAC</span><span class="p">;</span>
   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="n">table</span> <span class="o">=</span> <span class="n">SiS_CGA_DAC</span><span class="p">;</span>
   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="n">table</span> <span class="o">=</span> <span class="n">SiS_EGA_DAC</span><span class="p">;</span>
   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0x18</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">j</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
      <span class="n">time</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
      <span class="n">table</span> <span class="o">=</span> <span class="n">SiS_VGA_DAC</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetCRT2ToLCD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>        <span class="cm">/* 301B-DH LCD */</span>
         <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="n">VB_NoLCD</span><span class="p">)</span> <span class="p">)</span>        <span class="o">||</span>
       <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetCRT2ToLCDA</span><span class="p">)</span>       <span class="o">||</span>   <span class="cm">/* LCDA */</span>
       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SetFlag</span> <span class="o">&amp;</span> <span class="n">ProgrammingCRT2</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Programming CRT1 */</span>
      <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c6</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">);</span>
      <span class="n">DACAddr</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c8</span><span class="p">;</span>
      <span class="n">DACData</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c9</span><span class="p">;</span>
      <span class="n">sf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">DACAddr</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part5Port</span><span class="p">;</span>
      <span class="n">DACData</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part5Port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">sf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">DACAddr</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>

   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="k">for</span><span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">data2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">data2</span> <span class="o">+=</span> <span class="mh">0x2A</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="n">data2</span> <span class="o">+=</span> <span class="mh">0x15</span><span class="p">;</span>
	<span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">DACData</span><span class="p">,</span> <span class="p">(</span><span class="n">data2</span> <span class="o">&lt;&lt;</span> <span class="n">sf</span><span class="p">));</span>
	<span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span><span class="n">time</span> <span class="o">==</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">data</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">sf</span><span class="p">;</span>
	 <span class="k">for</span><span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">DACData</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">si</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">di</span> <span class="o">=</span> <span class="n">si</span><span class="p">;</span>
	 <span class="n">bx</span> <span class="o">=</span> <span class="n">si</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	 <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">for</span><span class="p">(</span><span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">o</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">o</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">SiS_WriteDAC</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">DACData</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">table</span><span class="p">[</span><span class="n">di</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="n">bx</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="n">si</span><span class="p">]);</span>
	       <span class="n">si</span><span class="o">++</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">si</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	    <span class="k">for</span><span class="p">(</span><span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">o</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">o</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">SiS_WriteDAC</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">DACData</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">table</span><span class="p">[</span><span class="n">di</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="n">si</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="n">bx</span><span class="p">]);</span>
	       <span class="n">si</span><span class="o">--</span><span class="p">;</span>
	    <span class="p">}</span>
	 <span class="p">}</span>            <span class="cm">/* for n &lt; 3 */</span>
	 <span class="n">si</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
      <span class="p">}</span>               <span class="cm">/* for m &lt; 9 */</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*         SET CRT1 REGISTER GROUP           */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_SetCRT1Group</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">StandTableIndex</span><span class="p">,</span> <span class="n">RefreshRateTableIndex</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_CRT1Mode</span> <span class="o">=</span> <span class="n">ModeNo</span><span class="p">;</span>

   <span class="n">StandTableIndex</span> <span class="o">=</span> <span class="n">SiS_GetModePtr</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SetFlag</span> <span class="o">&amp;</span> <span class="n">LowModeTests</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SetSimuScanMode</span> <span class="o">|</span> <span class="n">SwitchCRT2</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">SiS_DisableBridge</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="n">SiS_ResetSegmentRegisters</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="n">SiS_SetSeqRegs</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">StandTableIndex</span><span class="p">);</span>
   <span class="n">SiS_SetMiscRegs</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">StandTableIndex</span><span class="p">);</span>
   <span class="n">SiS_SetCRTCRegs</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">StandTableIndex</span><span class="p">);</span>
   <span class="n">SiS_SetATTRegs</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">StandTableIndex</span><span class="p">);</span>
   <span class="n">SiS_SetGRCRegs</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">StandTableIndex</span><span class="p">);</span>
   <span class="n">SiS_ClearExt1Regs</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">);</span>
   <span class="n">SiS_ResetCRT1VCLK</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SelectCRT2Rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SetFlag</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">ProgrammingCRT2</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetSimuScanMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetInSlaveMode</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SetFlag</span> <span class="o">|=</span> <span class="n">ProgrammingCRT2</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetCRT2ToLCDA</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SetFlag</span> <span class="o">|=</span> <span class="n">ProgrammingCRT2</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">RefreshRateTableIndex</span> <span class="o">=</span> <span class="n">SiS_GetRatePtr</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SetCRT2ToLCDA</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SetFlag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ProgrammingCRT2</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span><span class="n">RefreshRateTableIndex</span> <span class="o">!=</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetCRT1Sync</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">RefreshRateTableIndex</span><span class="p">);</span>
      <span class="n">SiS_SetCRT1CRTC</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="n">RefreshRateTableIndex</span><span class="p">);</span>
      <span class="n">SiS_SetCRT1Offset</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="n">RefreshRateTableIndex</span><span class="p">);</span>
      <span class="n">SiS_SetCRT1VCLK</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="n">RefreshRateTableIndex</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">switch</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
   <span class="k">case</span> <span class="n">SIS_300</span>:
      <span class="n">SiS_SetCRT1FIFO_300</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">RefreshRateTableIndex</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
   <span class="k">case</span> <span class="n">SIS_540</span>:
   <span class="k">case</span> <span class="n">SIS_630</span>:
   <span class="k">case</span> <span class="n">SIS_730</span>:
      <span class="n">SiS_SetCRT1FIFO_630</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">RefreshRateTableIndex</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
   <span class="nl">default:</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sr2b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sr2c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="k">switch</span><span class="p">(</span><span class="n">ModeNo</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">case</span> <span class="mh">0x00</span>:
	 <span class="k">case</span> <span class="mh">0x01</span>: <span class="n">sr2b</span> <span class="o">=</span> <span class="mh">0x4e</span><span class="p">;</span> <span class="n">sr2c</span> <span class="o">=</span> <span class="mh">0xe9</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	 <span class="k">case</span> <span class="mh">0x04</span>:
	 <span class="k">case</span> <span class="mh">0x05</span>:
	 <span class="k">case</span> <span class="mh">0x0d</span>: <span class="n">sr2b</span> <span class="o">=</span> <span class="mh">0x1b</span><span class="p">;</span> <span class="n">sr2c</span> <span class="o">=</span> <span class="mh">0xe3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	 <span class="p">}</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">sr2b</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2b</span><span class="p">,</span><span class="n">sr2b</span><span class="p">);</span>
	    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x2c</span><span class="p">,</span><span class="n">sr2c</span><span class="p">);</span>
	    <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c2</span><span class="p">,(</span><span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3cc</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0c</span><span class="p">));</span>
	 <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">SiS_SetCRT1FIFO_310</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>
<span class="cp">#endif</span>
      <span class="k">break</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">SiS_SetCRT1ModeRegs</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="n">RefreshRateTableIndex</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetupDualChip</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
   <span class="p">}</span>
<span class="cp">#endif</span>

   <span class="n">SiS_LoadDAC</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_flag_clearbuffer</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_ClearBuffer</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SetSimuScanMode</span> <span class="o">|</span> <span class="n">SwitchCRT2</span> <span class="o">|</span> <span class="n">SetCRT2ToLCDA</span><span class="p">)))</span> <span class="p">{</span>
      <span class="n">SiS_WaitRetrace1</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
      <span class="n">SiS_DisplayOn</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*       HELPER: VIDEO BRIDGE PROG CLK       */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_InitVB</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ROMAddr</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">VirtualRomBase</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">Init_P4_0E</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ROMNew</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">Init_P4_0E</span> <span class="o">=</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x82</span><span class="p">];</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_XGIROM</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">Init_P4_0E</span> <span class="o">=</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x80</span><span class="p">];</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_ResetVB</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">ROMAddr</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">VirtualRomBase</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">;</span>

   <span class="cm">/* VB programming clock */</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_UseROM</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_330</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">temp</span> <span class="o">=</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="n">VB310Data_1_2_Offset</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ROMNew</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x80</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
	 <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part1Port</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span> <span class="o">&amp;&amp;</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">temp</span> <span class="o">=</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x7e</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ROMNew</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x80</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
	 <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part1Port</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_XGIROM</span><span class="p">)</span> <span class="n">temp</span> <span class="o">|=</span> <span class="n">ROMAddr</span><span class="p">[</span><span class="mh">0x7e</span><span class="p">];</span>
      <span class="cm">/* Can we do this on any chipset? */</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part1Port</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>
   <span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*    HELPER: SET VIDEO/CAPTURE REGISTERS    */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_StrangeStuff</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="cm">/* SiS65x and XGI set up some sort of &quot;lock mode&quot; for text</span>
<span class="cm">    * which locks CRT2 in some way to CRT1 timing. Disable</span>
<span class="cm">    * this here.</span>
<span class="cm">    */</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
   <span class="k">if</span><span class="p">((</span><span class="n">IS_SIS651</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">IS_SISM650</span><span class="p">)</span> <span class="o">||</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_340</span> <span class="o">||</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VidCapt</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>   <span class="cm">/* Fiddle with capture regs */</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VidCapt</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VidPlay</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>   <span class="cm">/* (BIOS does NOT unlock) */</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VidPlay</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span> <span class="cm">/* Fiddle with video regs */</span>
      <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VidPlay</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="cm">/* !!! This does not support modes &lt; 0x13 !!! */</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*     HELPER: SET AGP TIMING FOR SiS760     */</span>
<span class="cm">/*********************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SiS_Handle760</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">somebase</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">,</span> <span class="n">temp3</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">!=</span> <span class="n">SIS_760</span><span class="p">)</span>                         <span class="o">||</span>
       <span class="p">((</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">||</span>
       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">&amp;</span> <span class="n">SF_760LFB</span><span class="p">))</span>                 <span class="o">||</span>
       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_SysFlags</span> <span class="o">&amp;</span> <span class="n">SF_760UMA</span><span class="p">))</span> <span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>

   <span class="n">somebase</span> <span class="o">=</span> <span class="n">sisfb_read_mio_pci_word</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">);</span>
   <span class="n">somebase</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">somebase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

   <span class="n">temp3</span> <span class="o">=</span> <span class="n">SiS_GetRegByte</span><span class="p">((</span><span class="n">somebase</span> <span class="o">+</span> <span class="mh">0x85</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xb7</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">temp1</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
      <span class="n">temp2</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
      <span class="n">temp3</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">temp1</span> <span class="o">=</span> <span class="mh">0x25</span><span class="p">;</span>
      <span class="n">temp2</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">sisfb_write_nbridge_pci_byte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="n">temp1</span><span class="p">);</span>
   <span class="n">sisfb_write_nbridge_pci_byte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="n">temp2</span><span class="p">);</span>

   <span class="n">SiS_SetRegByte</span><span class="p">((</span><span class="n">somebase</span> <span class="o">+</span> <span class="mh">0x85</span><span class="p">),</span> <span class="n">temp3</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/*                 SiSSetMode()              */</span>
<span class="cm">/*********************************************/</span>

<span class="n">bool</span>
<span class="nf">SiSSetMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">SISIOADDRESS</span> <span class="n">BaseAddr</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">IOAddress</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">RealModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">backupreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">KeepLockReg</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CRT1UsesCustomMode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_flag_clearbuffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ModeNo</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_flag_clearbuffer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">ModeNo</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Don&#39;t use FSTN mode for CRT1 */</span>
   <span class="n">RealModeNo</span> <span class="o">=</span> <span class="n">ModeNo</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">ModeNo</span> <span class="o">==</span> <span class="mh">0x5b</span><span class="p">)</span> <span class="n">ModeNo</span> <span class="o">=</span> <span class="mh">0x56</span><span class="p">;</span>

   <span class="n">SiSInitPtr</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
   <span class="n">SiSRegInit</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">BaseAddr</span><span class="p">);</span>
   <span class="n">SiS_GetSysFlags</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAINFO</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>

   <span class="n">KeepLockReg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x05</span><span class="p">);</span>
   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x86</span><span class="p">);</span>

   <span class="n">SiSInitPCIetc</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
   <span class="n">SiSSetLVDSetc</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
   <span class="n">SiSDetermineROMUsage</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="n">SiS_UnLockCRT2</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SiS_SearchModeID</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ModeNo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ModeIdIndex</span><span class="p">)))</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">ModeIdIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">SiS_GetVBType</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="cm">/* Init/restore some VB registers */</span>
   <span class="n">SiS_InitVB</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="n">VB_SIS30xBLV</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SiS_ResetVB</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
	 <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
	 <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part2Port</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0c</span><span class="p">);</span>
         <span class="n">backupreg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x38</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">backupreg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x35</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="cm">/* Get VB information (connectors, connected devices) */</span>
   <span class="n">SiS_GetVBInfo</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">,</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
   <span class="n">SiS_SetYPbPr</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
   <span class="n">SiS_SetTVMode</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>
   <span class="n">SiS_GetLCDResInfo</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>
   <span class="n">SiS_SetLowModeTest</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">);</span>

   <span class="cm">/* Check memory size (kernel framebuffer driver only) */</span>
   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SiS_CheckMemorySize</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">SiS_OpenCRTC</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">UseCustomMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CRT1UsesCustomMode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CSRClock_CRT1</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CSRClock</span><span class="p">;</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CModeFlag_CRT1</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CModeFlag</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CRT1UsesCustomMode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Set mode on CRT1 */</span>
   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SetSimuScanMode</span> <span class="o">|</span> <span class="n">SetCRT2ToLCDA</span><span class="p">))</span> <span class="o">||</span>
       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="n">SwitchCRT2</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetCRT1Group</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="cm">/* Set mode on CRT2 */</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBInfo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SetSimuScanMode</span> <span class="o">|</span> <span class="n">SwitchCRT2</span> <span class="o">|</span> <span class="n">SetCRT2ToLCDA</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="n">VB_SISVB</span><span class="p">)</span>    <span class="o">||</span>
	  <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_LVDS</span>     <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	  <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_CH70xx</span>   <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	  <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_TRUMPION</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
	 <span class="n">SiS_SetCRT2Group</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">RealModeNo</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="n">SiS_HandleCRT1</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="n">SiS_StrangeStuff</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="n">SiS_DisplayOn</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>
   <span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c6</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_IF_DEF_LVDS</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SiS_IsDualEdge</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">)))</span> <span class="p">{</span>
	    <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_Part1Port</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="mh">0xfb</span><span class="p">);</span>
	 <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="cp">#endif</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VBType</span> <span class="o">&amp;</span> <span class="n">VB_SIS30xBLV</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&gt;=</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	 <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_ROMNew</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">SiS_IsVAMode</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">))</span> <span class="p">{</span>
	       <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x35</span><span class="p">,</span><span class="mh">0x01</span><span class="p">);</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	       <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x35</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">);</span>
	    <span class="p">}</span>
	 <span class="p">}</span>

	 <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="n">backupreg</span><span class="p">);</span>

	 <span class="k">if</span><span class="p">((</span><span class="n">IS_SIS650</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">((</span><span class="n">ModeNo</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ModeNo</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">))</span> <span class="p">{</span>
	       <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x80</span><span class="p">);</span>
	       <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x56</span><span class="p">,</span><span class="mh">0x08</span><span class="p">);</span>
	    <span class="p">}</span>
	 <span class="p">}</span>

	 <span class="k">if</span><span class="p">(</span><span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SetCRT2ToLCD</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="mh">0xfc</span><span class="p">);</span>
	 <span class="p">}</span>
<span class="cp">#endif</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_630</span><span class="p">)</span> <span class="o">||</span>
	        <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_730</span><span class="p">))</span> <span class="p">{</span>
	 <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x35</span><span class="p">,</span><span class="n">backupreg</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="n">SiS_CloseCRTC</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="n">SiS_Handle760</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">);</span>

   <span class="cm">/* We never lock registers in XF86 */</span>
   <span class="k">if</span><span class="p">(</span><span class="n">KeepLockReg</span> <span class="o">!=</span> <span class="mh">0xA1</span><span class="p">)</span> <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>

   <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef GETBITSTR</span>
<span class="cp">#define BITMASK(h,l)    	(((unsigned)(1U &lt;&lt; ((h)-(l)+1))-1)&lt;&lt;(l))</span>
<span class="cp">#define GENMASK(mask)   	BITMASK(1?mask,0?mask)</span>
<span class="cp">#define GETBITS(var,mask)   	(((var) &amp; GENMASK(mask)) &gt;&gt; (0?mask))</span>
<span class="cp">#define GETBITSTR(val,from,to)  ((GETBITS(val,from)) &lt;&lt; (0?to))</span>
<span class="cp">#endif</span>

<span class="kt">void</span>
<span class="nf">SiS_CalcCRRegisters</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Fix sync */</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span>  <span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHTotal</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>		<span class="cm">/* CR0 */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span>  <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHDisplay</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>			<span class="cm">/* CR1 */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span>  <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHBlankStart</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>			<span class="cm">/* CR2 */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="p">(((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHBlankEnd</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* CR3 */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span>  <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>			<span class="cm">/* CR4 */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="o">=</span>  <span class="p">((((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHBlankEnd</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* CR5 */</span>
			    <span class="p">(((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncEnd</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>  <span class="o">=</span>  <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVTotal</span>       <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>			<span class="cm">/* CR6 */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span>  <span class="p">(((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVTotal</span>     <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>		<span class="cm">/* CR7 */</span>
			  <span class="o">|</span> <span class="p">(((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVDisplay</span>   <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVSyncStart</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVBlankStart</span><span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span>
			  <span class="o">|</span> <span class="mh">0x10</span>
			  <span class="o">|</span> <span class="p">(((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVTotal</span>     <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVDisplay</span>   <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVSyncStart</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">((((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVBlankStart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span> 	<span class="cm">/* CR9 */</span>

   <span class="k">if</span><span class="p">(</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHDisplay</span> <span class="o">&gt;=</span> <span class="mi">1600</span><span class="p">)</span>      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x60</span><span class="p">;</span>		<span class="cm">/* SRE */</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHDisplay</span> <span class="o">&gt;=</span> <span class="mi">640</span><span class="p">)</span>  <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVSyncStart</span>  <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>			<span class="cm">/* CR10 */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span>  <span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVSyncEnd</span>   <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>		<span class="cm">/* CR11 */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVDisplay</span>    <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>			<span class="cm">/* CR12 */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVBlankStart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>			<span class="cm">/* CR15 */</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVBlankEnd</span>   <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>			<span class="cm">/* CR16 */</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span>							<span class="cm">/* SRA */</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVTotal</span>     <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="mi">10</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVDisplay</span>   <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVBlankStart</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="o">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVSyncStart</span> <span class="o">-</span><span class="n">x</span><span class="p">),</span> <span class="mi">10</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="o">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVBlankEnd</span>  <span class="o">-</span><span class="mi">1</span><span class="p">),</span>   <span class="mi">8</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="o">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVSyncEnd</span>     <span class="p">),</span>   <span class="mi">4</span><span class="o">:</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="o">:</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span>							<span class="cm">/* SRB */</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHTotal</span>      <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHDisplay</span>    <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="o">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHBlankStart</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="o">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span>  <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="o">:</span><span class="mi">6</span><span class="p">)</span> <span class="p">;</span>


   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span>							<span class="cm">/* SRC */</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHBlankEnd</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">GETBITSTR</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncEnd</span>  <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="o">:</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">SiS_CalcLCDACRT1Timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeNo</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ModeIdIndex</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">modeflag</span><span class="p">,</span> <span class="n">tempax</span><span class="p">,</span> <span class="n">tempbx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">VGAHDE</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAHDE</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

   <span class="cm">/* 1:1 data: use data set by setcrt1crtc() */</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCDInfo</span> <span class="o">&amp;</span> <span class="n">LCDPass11</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

   <span class="n">modeflag</span> <span class="o">=</span> <span class="n">SiS_GetModeFlag</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ModeNo</span><span class="p">,</span> <span class="n">ModeIdIndex</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">)</span> <span class="n">VGAHDE</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHDisplay</span> <span class="o">=</span> <span class="n">VGAHDE</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHBlankStart</span> <span class="o">=</span> <span class="n">VGAHDE</span><span class="p">;</span>

   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVDisplay</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAVDE</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVBlankStart</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAVDE</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
      <span class="n">tempbx</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAHT</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCDInfo</span> <span class="o">&amp;</span> <span class="n">DontExpandLCD</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">tempbx</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelHT</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">)</span> <span class="n">tempbx</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">remaining</span> <span class="o">=</span> <span class="n">tempbx</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
<span class="cp">#endif</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
      <span class="cm">/* OK for LCDA, LVDS */</span>
      <span class="n">tempbx</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelHT</span> <span class="o">-</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelXRes</span><span class="p">;</span>
      <span class="n">tempax</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAHDE</span><span class="p">;</span>  <span class="cm">/* not /2 ! */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCDInfo</span> <span class="o">&amp;</span> <span class="n">DontExpandLCD</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">tempax</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelXRes</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">tempbx</span> <span class="o">+=</span> <span class="n">tempax</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">)</span> <span class="n">tempbx</span> <span class="o">-=</span> <span class="n">VGAHDE</span><span class="p">;</span>
<span class="cp">#endif</span>
   <span class="p">}</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHTotal</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHBlankEnd</span> <span class="o">=</span> <span class="n">tempbx</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAHDE</span> <span class="o">==</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelXRes</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAHDE</span> <span class="o">+</span> <span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelHRS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
	 <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncEnd</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">+</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelHRE</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncEnd</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCDInfo</span> <span class="o">&amp;</span> <span class="n">DontExpandLCD</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">tempax</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelXRes</span> <span class="o">-</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAHDE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="n">tempbx</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelHRS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">tempax</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">tempbx</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="p">}</span>
	 <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">=</span> <span class="p">(</span><span class="n">VGAHDE</span> <span class="o">+</span> <span class="n">tempax</span> <span class="o">+</span> <span class="n">tempbx</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	 <span class="n">tempax</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelHRE</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">)</span> <span class="n">tempax</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">+</span> <span class="n">tempax</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAHDE</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">tempax</span> <span class="o">=</span> <span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHTotal</span> <span class="o">-</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncEnd</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">+</span> <span class="n">tempax</span><span class="p">;</span>
	 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">+</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHTotal</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	    <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	 <span class="p">}</span>
      <span class="p">}</span>
<span class="cp">#endif</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
      <span class="n">tempax</span> <span class="o">=</span> <span class="n">VGAHDE</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCDInfo</span> <span class="o">&amp;</span> <span class="n">DontExpandLCD</span><span class="p">)</span> <span class="p">{</span>
	 <span class="n">tempbx</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelXRes</span><span class="p">;</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">HalfDCLK</span><span class="p">)</span> <span class="n">tempbx</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="n">tempax</span> <span class="o">+=</span> <span class="p">((</span><span class="n">tempbx</span> <span class="o">-</span> <span class="n">tempax</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">tempax</span> <span class="o">+=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelHRS</span><span class="p">;</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncStart</span> <span class="o">=</span> <span class="n">tempax</span><span class="p">;</span>
      <span class="n">tempax</span> <span class="o">+=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelHRE</span><span class="p">;</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CHSyncEnd</span> <span class="o">=</span> <span class="n">tempax</span><span class="p">;</span>
<span class="cp">#endif</span>
   <span class="p">}</span>

   <span class="n">tempbx</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelVT</span> <span class="o">-</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelYRes</span><span class="p">;</span>
   <span class="n">tempax</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAVDE</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCDInfo</span> <span class="o">&amp;</span> <span class="n">DontExpandLCD</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">tempax</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelYRes</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
      <span class="cm">/* Stupid hack for 640x400/320x200 */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCDResInfo</span> <span class="o">==</span> <span class="n">Panel_1024x768</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">if</span><span class="p">((</span><span class="n">tempax</span> <span class="o">+</span> <span class="n">tempbx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">438</span><span class="p">)</span> <span class="n">tempbx</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCDResInfo</span> <span class="o">==</span> <span class="n">Panel_800x600</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCDResInfo</span> <span class="o">==</span> <span class="n">Panel_1024x600</span><span class="p">))</span> <span class="p">{</span>
	 <span class="n">tempax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	 <span class="n">tempbx</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAVT</span><span class="p">;</span>
      <span class="p">}</span>
<span class="cp">#endif</span>
   <span class="p">}</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVTotal</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVBlankEnd</span> <span class="o">=</span> <span class="n">tempbx</span> <span class="o">+</span> <span class="n">tempax</span><span class="p">;</span>

   <span class="n">tempax</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_VGAVDE</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_LCDInfo</span> <span class="o">&amp;</span> <span class="n">DontExpandLCD</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">tempax</span> <span class="o">+=</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelYRes</span> <span class="o">-</span> <span class="n">tempax</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">tempax</span> <span class="o">+=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelVRS</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVSyncStart</span> <span class="o">=</span> <span class="n">tempax</span><span class="p">;</span>
   <span class="n">tempax</span> <span class="o">+=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">PanelVRE</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVSyncEnd</span> <span class="o">=</span> <span class="n">tempax</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ChipType</span> <span class="o">&lt;</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVSyncStart</span><span class="o">--</span><span class="p">;</span>
      <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CVSyncEnd</span><span class="o">--</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">SiS_CalcCRRegisters</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xF8</span><span class="p">;</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
   <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xE0</span><span class="p">;</span>

   <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">);</span>

   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
   <span class="p">}</span>
   <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
   <span class="p">}</span>
   <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
   <span class="p">}</span>
   <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
   <span class="p">}</span>

   <span class="n">tempax</span> <span class="o">=</span> <span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">;</span>
   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3c4</span><span class="p">,</span><span class="mh">0x0E</span><span class="p">,</span><span class="mh">0x1F</span><span class="p">,</span><span class="n">tempax</span><span class="p">);</span>

   <span class="n">tempax</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">CCRT1CRTC</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="n">modeflag</span> <span class="o">&amp;</span> <span class="n">DoubleScanMode</span><span class="p">)</span> <span class="n">tempax</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">SiS_P3d4</span><span class="p">,</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0x5F</span><span class="p">,</span><span class="n">tempax</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">SiS_Generic_ConvertCRData</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">crdata</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">yres</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="n">bool</span> <span class="n">writeres</span>
<span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">HRE</span><span class="p">,</span> <span class="n">HBE</span><span class="p">,</span> <span class="n">HRS</span><span class="p">,</span> <span class="n">HBS</span><span class="p">,</span> <span class="n">HDE</span><span class="p">,</span> <span class="n">HT</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">VRE</span><span class="p">,</span> <span class="n">VBE</span><span class="p">,</span> <span class="n">VRS</span><span class="p">,</span> <span class="n">VBS</span><span class="p">,</span> <span class="n">VDE</span><span class="p">,</span> <span class="n">VT</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">sr_data</span><span class="p">,</span> <span class="n">cr_data</span><span class="p">,</span> <span class="n">cr_data2</span><span class="p">;</span>
   <span class="kt">int</span>            <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

   <span class="n">sr_data</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>

   <span class="cm">/* Horizontal total */</span>
   <span class="n">HT</span> <span class="o">=</span>  <span class="n">crdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">sr_data</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
   <span class="n">A</span> <span class="o">=</span> <span class="n">HT</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>

   <span class="cm">/* Horizontal display enable end */</span>
   <span class="n">HDE</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">sr_data</span> <span class="o">&amp;</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
   <span class="n">E</span> <span class="o">=</span> <span class="n">HDE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

   <span class="cm">/* Horizontal retrace (=sync) start */</span>
   <span class="n">HRS</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">sr_data</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
   <span class="n">F</span> <span class="o">=</span> <span class="n">HRS</span> <span class="o">-</span> <span class="n">E</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>

   <span class="cm">/* Horizontal blank start */</span>
   <span class="n">HBS</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">sr_data</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

   <span class="n">sr_data</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
   <span class="n">cr_data</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

   <span class="cm">/* Horizontal blank end */</span>
   <span class="n">HBE</span> <span class="o">=</span> <span class="p">(</span><span class="n">crdata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">|</span>
         <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">cr_data</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
         <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">sr_data</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>

   <span class="cm">/* Horizontal retrace (=sync) end */</span>
   <span class="n">HRE</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr_data</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">sr_data</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

   <span class="n">temp</span> <span class="o">=</span> <span class="n">HBE</span> <span class="o">-</span> <span class="p">((</span><span class="n">E</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
   <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">temp</span> <span class="o">:</span> <span class="p">(</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">256</span><span class="p">);</span>

   <span class="n">temp</span> <span class="o">=</span> <span class="n">HRE</span> <span class="o">-</span> <span class="p">((</span><span class="n">E</span> <span class="o">+</span> <span class="n">F</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">);</span>
   <span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">temp</span> <span class="o">:</span> <span class="p">(</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">64</span><span class="p">);</span>

   <span class="n">D</span> <span class="o">=</span> <span class="n">B</span> <span class="o">-</span> <span class="n">F</span> <span class="o">-</span> <span class="n">C</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">writeres</span><span class="p">)</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
   <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">D</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
   <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">F</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
   <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

   <span class="cm">/* Vertical */</span>
   <span class="n">sr_data</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
   <span class="n">cr_data</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

   <span class="cm">/* Vertical total */</span>
   <span class="n">VT</span>  <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">cr_data</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">cr_data</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">sr_data</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
   <span class="n">A</span> <span class="o">=</span> <span class="n">VT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

   <span class="cm">/* Vertical display enable end */</span>
   <span class="n">VDE</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">cr_data</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">cr_data</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">sr_data</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
   <span class="n">E</span> <span class="o">=</span> <span class="n">VDE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

   <span class="cm">/* Vertical retrace (=sync) start */</span>
   <span class="n">VRS</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">cr_data</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">cr_data</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">sr_data</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
   <span class="n">F</span> <span class="o">=</span> <span class="n">VRS</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">E</span><span class="p">;</span>

   <span class="n">cr_data2</span> <span class="o">=</span> <span class="p">(</span><span class="n">crdata</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>

   <span class="cm">/* Vertical blank start */</span>
   <span class="n">VBS</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">cr_data</span>  <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">cr_data2</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
	 <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">sr_data</span>  <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

   <span class="cm">/* Vertical blank end */</span>
   <span class="n">VBE</span> <span class="o">=</span> <span class="n">crdata</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">sr_data</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="n">VBE</span> <span class="o">-</span> <span class="p">((</span><span class="n">E</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">511</span><span class="p">);</span>
   <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">temp</span> <span class="o">:</span> <span class="p">(</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">512</span><span class="p">);</span>

   <span class="cm">/* Vertical retrace (=sync) end */</span>
   <span class="n">VRE</span> <span class="o">=</span> <span class="p">(</span><span class="n">crdata</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">sr_data</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
   <span class="n">temp</span> <span class="o">=</span> <span class="n">VRE</span> <span class="o">-</span> <span class="p">((</span><span class="n">E</span> <span class="o">+</span> <span class="n">F</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
   <span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">temp</span> <span class="o">:</span> <span class="p">(</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>

   <span class="n">D</span> <span class="o">=</span> <span class="n">B</span> <span class="o">-</span> <span class="n">F</span> <span class="o">-</span> <span class="n">C</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">writeres</span><span class="p">)</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">E</span><span class="p">;</span>
   <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">D</span><span class="p">;</span>
   <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">F</span><span class="p">;</span>
   <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">C</span><span class="p">;</span>

   <span class="k">if</span><span class="p">((</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">320</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">240</span><span class="p">)))</span> <span class="p">{</span>
	<span class="cm">/* Terrible hack, but correct CRTC data for</span>
<span class="cm">	 * these modes only produces a black screen...</span>
<span class="cm">	 * (HRE is 0, leading into a too large C and</span>
<span class="cm">	 * a negative D. The CRT controller does not</span>
<span class="cm">	 * seem to like correcting HRE to 50)</span>
<span class="cm">	 */</span>
      <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="p">(</span><span class="mi">400</span> <span class="o">-</span> <span class="mi">376</span><span class="p">);</span>
      <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="p">(</span><span class="mi">328</span> <span class="o">-</span> <span class="mi">320</span><span class="p">);</span>
      <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">376</span> <span class="o">-</span> <span class="mi">328</span><span class="p">);</span>

   <span class="p">}</span>

<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
