<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › sis › sis_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sis_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SiS 300/540/630[S]/730[S],</span>
<span class="cm"> * SiS 315[E|PRO]/550/[M]65x/[M]66x[F|M|G]X/[M]74x[GX]/330/[M]76x[GX],</span>
<span class="cm"> * XGI V3XT/V5/V8, Z7</span>
<span class="cm"> * frame buffer driver for Linux kernels &gt;= 2.4.14 and &gt;=2.6.3</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001-2005 Thomas Winischhofer, Vienna, Austria.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the named License,</span>
<span class="cm"> * or any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA</span>
<span class="cm"> *</span>
<span class="cm"> * Author:	Thomas Winischhofer &lt;thomas@winischhofer.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Author of (practically wiped) code base:</span>
<span class="cm"> *		SiS (www.sis.com)</span>
<span class="cm"> *		Copyright (C) 1999 Silicon Integrated Systems, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * See http://www.winischhofer.net/ for more information and updates</span>
<span class="cm"> *</span>
<span class="cm"> * Originally based on the VBE 2.0 compliant graphic boards framebuffer driver,</span>
<span class="cm"> * which is (c) 1998 Gerd Knorr &lt;kraxel@goldbach.in-berlin.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/screen_info.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/selection.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;sis.h&quot;</span>
<span class="cp">#include &quot;sis_main.h&quot;</span>

<span class="cp">#if !defined(CONFIG_FB_SIS_300) &amp;&amp; !defined(CONFIG_FB_SIS_315)</span>
<span class="cp">#warning Neither CONFIG_FB_SIS_300 nor CONFIG_FB_SIS_315 is set</span>
<span class="cp">#warning sisfb will not work!</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">sisfb_handle_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sisfb_cmd</span> <span class="o">*</span><span class="n">sisfb_command</span><span class="p">);</span>

<span class="cm">/* ------------------ Internal helper routines ----------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">sisfb_setdefaultparms</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sisfb_off</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisfb_parm_mem</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisfb_accel</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_ypan</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_max</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_userom</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_useoem</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_mode_idx</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_parm_rate</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_crt1off</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisfb_forcecrt1</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_crt2type</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_crt2flags</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisfb_pdc</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">sisfb_pdca</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">sisfb_scalelcd</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_specialtiming</span> 	<span class="o">=</span> <span class="n">CUT_NONE</span><span class="p">;</span>
	<span class="n">sisfb_lvdshl</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_dstn</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisfb_fstn</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisfb_tvplug</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_tvstd</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisfb_tvxposoffset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisfb_tvyposoffset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisfb_nocrt2rate</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__x86_64__)</span>
	<span class="n">sisfb_resetcard</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisfb_videoram</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* ------------- Parameter parsing -------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_search_vesamode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vesamode</span><span class="p">,</span> <span class="n">bool</span> <span class="n">quiet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t know the hardware specs yet and there is no ivideo */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">vesamode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">quiet</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Invalid mode. Using default.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">DEFAULT_MODE</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vesamode</span> <span class="o">&amp;=</span> <span class="mh">0x1dff</span><span class="p">;</span>  <span class="cm">/* Clean VESA mode number from other flags */</span>

	<span class="k">while</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">vesa_mode_no_1</span> <span class="o">==</span> <span class="n">vesamode</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">vesa_mode_no_2</span> <span class="o">==</span> <span class="n">vesamode</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sisfb_fstn</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">||</span>
				   <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x56</span> <span class="o">||</span>
				   <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x53</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x5a</span> <span class="o">||</span>
				   <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x5b</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="n">j</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">quiet</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Invalid VESA mode 0x%x&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vesamode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_search_mode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">bool</span> <span class="n">quiet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">yres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">strbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">strbuf1</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">nameptr</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t know the hardware specs yet and there is no ivideo */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">quiet</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Internal error, using default mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">DEFAULT_MODE</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">MODE_INDEX_NONE</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">quiet</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Mode &#39;none&#39; not supported anymore. Using default.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">DEFAULT_MODE</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">19</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">strbuf1</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">strbuf1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">strbuf1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="sc">&#39;0&#39;</span> <span class="o">||</span> <span class="n">strbuf1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="n">strbuf1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* This does some fuzzy mode naming detection */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">strbuf1</span><span class="p">,</span> <span class="s">&quot;%u %u %u %u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">yres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">depth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">j</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">depth</span><span class="p">;</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span> <span class="s">&quot;%ux%ux%u&quot;</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
			<span class="n">nameptr</span> <span class="o">=</span> <span class="n">strbuf</span><span class="p">;</span>
			<span class="n">sisfb_parm_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">strbuf1</span><span class="p">,</span> <span class="s">&quot;%u %u %u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">yres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">depth</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span> <span class="s">&quot;%ux%ux%u&quot;</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
			<span class="n">nameptr</span> <span class="o">=</span> <span class="n">strbuf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">xres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span><span class="p">((</span><span class="n">sscanf</span><span class="p">(</span><span class="n">strbuf1</span><span class="p">,</span> <span class="s">&quot;%u %u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">yres</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">xres</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span> <span class="s">&quot;%ux%ux8&quot;</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">);</span>
				<span class="n">nameptr</span> <span class="o">=</span> <span class="n">strbuf</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sisfb_search_vesamode</span><span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">quiet</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">nameptr</span><span class="p">,</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">nameptr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sisfb_fstn</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">||</span>
				   <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x56</span> <span class="o">||</span>
				   <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x53</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x5a</span> <span class="o">||</span>
				   <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x5b</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="n">j</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">quiet</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Invalid mode &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nameptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_get_vga_mode_from_kernel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86</span>
	<span class="kt">char</span> <span class="n">mymode</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span>  <span class="n">mydepth</span> <span class="o">=</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">lfb_depth</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_isVGA</span> <span class="o">!=</span> <span class="n">VIDEO_TYPE_VLFB</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">lfb_width</span> <span class="o">&gt;=</span> <span class="mi">320</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">lfb_width</span> <span class="o">&lt;=</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">lfb_height</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">lfb_height</span> <span class="o">&lt;=</span> <span class="mi">1536</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mydepth</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mydepth</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span><span class="n">mydepth</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="n">mydepth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">mymode</span><span class="p">,</span> <span class="s">&quot;%ux%ux%u&quot;</span><span class="p">,</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">lfb_width</span><span class="p">,</span>
					<span class="n">screen_info</span><span class="p">.</span><span class="n">lfb_height</span><span class="p">,</span>
					<span class="n">mydepth</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			<span class="s">&quot;sisfb: Using vga mode %s pre-set by kernel as default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mymode</span><span class="p">);</span>

		<span class="n">sisfb_search_mode</span><span class="p">(</span><span class="n">mymode</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">sisfb_search_crt2type</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t know the hardware specs yet and there is no ivideo */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">sis_crt2type</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type_no</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sis_crt2type</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sis_crt2type</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">sisfb_crt2type</span> <span class="o">=</span> <span class="n">sis_crt2type</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type_no</span><span class="p">;</span>
			<span class="n">sisfb_tvplug</span> <span class="o">=</span> <span class="n">sis_crt2type</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tvplug_no</span><span class="p">;</span>
			<span class="n">sisfb_crt2flags</span> <span class="o">=</span> <span class="n">sis_crt2type</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sisfb_dstn</span> <span class="o">=</span> <span class="p">(</span><span class="n">sisfb_crt2flags</span> <span class="o">&amp;</span> <span class="n">FL_550_DSTN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisfb_fstn</span> <span class="o">=</span> <span class="p">(</span><span class="n">sisfb_crt2flags</span> <span class="o">&amp;</span> <span class="n">FL_550_FSTN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">sisfb_crt2type</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Invalid CRT2 type: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">sisfb_search_tvstd</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t know the hardware specs yet and there is no ivideo */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">sis_tvtype</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type_no</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sis_tvtype</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sis_tvtype</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">sisfb_tvstd</span> <span class="o">=</span> <span class="n">sis_tvtype</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type_no</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">sisfb_search_specialtiming</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t know the hardware specs yet and there is no ivideo */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sisfb_specialtiming</span> <span class="o">=</span> <span class="n">CUT_FORCENONE</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: Special timing disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span><span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chipID</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optionName</span><span class="p">,</span>
			   <span class="n">strlen</span><span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optionName</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">sisfb_specialtiming</span> <span class="o">=</span> <span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SpecialID</span><span class="p">;</span>
				<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Special timing for %s %s forced (</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendorName</span><span class="p">,</span>
					<span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cardName</span><span class="p">,</span>
					<span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optionName</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;sisfb: Invalid SpecialTiming parameter, valid are:&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;</span><span class="se">\t\&quot;</span><span class="s">none</span><span class="se">\&quot;</span><span class="s"> (to disable special timings)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span><span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chipID</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;</span><span class="se">\t\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> (for %s %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optionName</span><span class="p">,</span>
					<span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendorName</span><span class="p">,</span>
					<span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cardName</span><span class="p">);</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ----------- Various detection routines ----------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_detect_custom_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">biosver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">biosdate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">footprint</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">biosver</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VirtualRomBase</span> <span class="o">+</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="n">biosdate</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VirtualRomBase</span> <span class="o">+</span> <span class="mh">0x2c</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32768</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">chksum</span> <span class="o">+=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VirtualRomBase</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chipID</span> <span class="o">==</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span>			<span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">biosversion</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">biosversion</span><span class="p">,</span> <span class="n">biosver</span><span class="p">,</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">biosversion</span><span class="p">)))))</span>	<span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">biosdate</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">biosdate</span><span class="p">,</span> <span class="n">biosdate</span><span class="p">,</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">biosdate</span><span class="p">)))))</span>		<span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="o">!</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bioschksum</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bioschksum</span> <span class="o">==</span> <span class="n">chksum</span><span class="p">)))</span>		<span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pcisubsysvendor</span> <span class="o">==</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">subsysvendor</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pcisubsyscard</span> <span class="o">==</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">subsysdevice</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">footprint</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">biosFootprintAddr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VirtualRomBase</span><span class="p">[</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">biosFootprintAddr</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">!=</span>
							<span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">biosFootprintData</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
							<span class="n">footprint</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">footprint</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">footprint</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_CustomT</span> <span class="o">=</span> <span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SpecialID</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: Identified [%s %s], special timing applies</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendorName</span><span class="p">,</span>
				<span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cardName</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: [specialtiming parameter name: %s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optionName</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">mycustomttable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chipID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__devinit</span>
<span class="nf">sisfb_interpret_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisfb_monitor</span> <span class="o">*</span><span class="n">monitor</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">refresh</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">emodes</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">||</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span>
	   <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span>
	   <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span>
	   <span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: Bad EDID header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: EDID version %d not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mh">0x12</span><span class="p">]);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">monitor</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mh">0x18</span><span class="p">];</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;sisfb: WARNING: Monitor does not support separate syncs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/* EDID V1 rev 1 and 2: Search for monitor descriptor</span>
<span class="cm">	    * to extract ranges</span>
<span class="cm">	    */</span>
	    <span class="n">j</span> <span class="o">=</span> <span class="mh">0x36</span><span class="p">;</span>
	    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	       <span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>     <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
		  <span class="n">buffer</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfd</span> <span class="o">&amp;&amp;</span>
		  <span class="n">buffer</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		  <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmin</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">7</span><span class="p">];</span>
		  <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmax</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span>
		  <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmin</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">5</span><span class="p">];</span>
		  <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">6</span><span class="p">];</span>
		  <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">dclockmax</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		  <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">datavalid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		  <span class="k">break</span><span class="p">;</span>
	       <span class="p">}</span>
	       <span class="n">j</span> <span class="o">+=</span> <span class="mi">18</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">datavalid</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/* Otherwise: Get a range from the list of supported</span>
<span class="cm">	    * Estabished Timings. This is not entirely accurate,</span>
<span class="cm">	    * because fixed frequency monitors are not supported</span>
<span class="cm">	    * that way.</span>
<span class="cm">	    */</span>
	   <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmin</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	   <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmin</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	   <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">dclockmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	   <span class="n">emodes</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mh">0x23</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x24</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x25</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">if</span><span class="p">(</span><span class="n">emodes</span> <span class="o">&amp;</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmin</span> <span class="o">&gt;</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">h</span><span class="p">)</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmin</span> <span class="o">=</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">h</span><span class="p">;</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmax</span> <span class="o">&lt;</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">h</span><span class="p">)</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmax</span> <span class="o">=</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmin</span> <span class="o">&gt;</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v</span><span class="p">)</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmin</span> <span class="o">=</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v</span><span class="p">;</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmax</span> <span class="o">&lt;</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v</span><span class="p">)</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v</span><span class="p">;</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">dclockmax</span> <span class="o">&lt;</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">)</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">dclockmax</span> <span class="o">=</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
	      <span class="p">}</span>
	   <span class="p">}</span>
	   <span class="n">index</span> <span class="o">=</span> <span class="mh">0x26</span><span class="p">;</span>
	   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	      <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	      <span class="k">switch</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="p">{</span>
		 <span class="k">case</span> <span class="mh">0xc0</span>: <span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		 <span class="k">case</span> <span class="mh">0x80</span>: <span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span>  <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		 <span class="k">case</span> <span class="mh">0x40</span>: <span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span>  <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		 <span class="nl">default:</span>   <span class="n">yres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>	    <span class="k">break</span><span class="p">;</span>
	      <span class="p">}</span>
	      <span class="n">refresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">60</span><span class="p">;</span>
	      <span class="k">if</span><span class="p">((</span><span class="n">xres</span> <span class="o">&gt;=</span> <span class="mi">640</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&gt;=</span> <span class="mi">480</span><span class="p">))</span> <span class="p">{</span>
		 <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">if</span><span class="p">((</span><span class="n">xres</span> <span class="o">==</span> <span class="n">sisfb_ddcfmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">yres</span> <span class="o">==</span> <span class="n">sisfb_ddcfmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">y</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">refresh</span> <span class="o">==</span> <span class="n">sisfb_ddcfmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">v</span><span class="p">))</span> <span class="p">{</span>
		      <span class="k">if</span><span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmin</span> <span class="o">&gt;</span> <span class="n">sisfb_ddcfmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">h</span><span class="p">)</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmin</span> <span class="o">=</span> <span class="n">sisfb_ddcfmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">h</span><span class="p">;</span>
		      <span class="k">if</span><span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmax</span> <span class="o">&lt;</span> <span class="n">sisfb_ddcfmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">h</span><span class="p">)</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmax</span> <span class="o">=</span> <span class="n">sisfb_ddcfmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		      <span class="k">if</span><span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmin</span> <span class="o">&gt;</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">v</span><span class="p">)</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmin</span> <span class="o">=</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">v</span><span class="p">;</span>
		      <span class="k">if</span><span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmax</span> <span class="o">&lt;</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">v</span><span class="p">)</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">v</span><span class="p">;</span>
		      <span class="k">if</span><span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">dclockmax</span> <span class="o">&lt;</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">d</span><span class="p">)</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">dclockmax</span> <span class="o">=</span> <span class="n">sisfb_ddcsmodes</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
		    <span class="p">}</span>
		 <span class="p">}</span>
	      <span class="p">}</span>
	      <span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	   <span class="p">}</span>
	   <span class="k">if</span><span class="p">((</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmin</span> <span class="o">&lt;=</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmax</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmin</span> <span class="o">&lt;=</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmax</span><span class="p">))</span> <span class="p">{</span>
	      <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">datavalid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	   <span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">datavalid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_handle_ddc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sisfb_monitor</span> <span class="o">*</span><span class="n">monitor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">realcrtno</span> <span class="o">=</span> <span class="n">crtno</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="n">monitor</span><span class="o">-&gt;</span><span class="n">datavalid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">crtno</span><span class="p">)</span> <span class="p">{</span>
	   <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_LCD</span><span class="p">)</span>      <span class="n">realcrtno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_VGA</span><span class="p">)</span> <span class="n">realcrtno</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	   <span class="k">else</span> <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">crtno</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_HandleDDC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span><span class="p">,</span>
				<span class="n">realcrtno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="n">temp</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
	   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: CRT%d DDC probing failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	   <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: CRT%d DDC supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: CRT%d DDC level: %s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">crtno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;[none of the supported]&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;2 &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;D&amp;P&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;FPDI-2&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	   <span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
	      <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* Number of retrys */</span>
	      <span class="k">do</span> <span class="p">{</span>
		 <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_HandleDDC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span><span class="p">,</span>
				     <span class="n">realcrtno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span><span class="p">);</span>
	      <span class="p">}</span> <span class="k">while</span><span class="p">((</span><span class="n">temp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">--</span><span class="p">);</span>
	      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">sisfb_interpret_edid</span><span class="p">(</span><span class="n">monitor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Monitor range H %d-%dKHz, V %d-%dHz, Max. dotclock %dMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmin</span><span class="p">,</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmax</span><span class="p">,</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmin</span><span class="p">,</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmax</span><span class="p">,</span>
			<span class="n">monitor</span><span class="o">-&gt;</span><span class="n">dclockmax</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: CRT%d DDC EDID corrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		 <span class="p">}</span>
	      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: CRT%d DDC reading failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	      <span class="p">}</span>
	   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: VESA D&amp;P and FPDI-2 not supported yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	   <span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* -------------- Mode validation --------------- */</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">sisfb_verify_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sisfb_monitor</span> <span class="o">*</span><span class="n">monitor</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">mode_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dclock</span><span class="p">,</span> <span class="n">hsync</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">datavalid</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">mode_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Skip for 320x200, 320x240, 640x400 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">mode_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x59</span>:
	<span class="k">case</span> <span class="mh">0x41</span>:
	<span class="k">case</span> <span class="mh">0x4f</span>:
	<span class="k">case</span> <span class="mh">0x50</span>:
	<span class="k">case</span> <span class="mh">0x56</span>:
	<span class="k">case</span> <span class="mh">0x53</span>:
	<span class="k">case</span> <span class="mh">0x2f</span>:
	<span class="k">case</span> <span class="mh">0x5d</span>:
	<span class="k">case</span> <span class="mh">0x5e</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">case</span> <span class="mh">0x5a</span>:
	<span class="k">case</span> <span class="mh">0x5b</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">vmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">sisfb_gettotalfrommode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span>
				  <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">mode_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">],</span>
				  <span class="o">&amp;</span><span class="n">htotal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vtotal</span><span class="p">,</span> <span class="n">rate_idx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dclock</span> <span class="o">=</span> <span class="p">(</span><span class="n">htotal</span> <span class="o">*</span> <span class="n">vtotal</span> <span class="o">*</span> <span class="n">rate</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">dclock</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">dclockmax</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">hsync</span> <span class="o">=</span> <span class="n">dclock</span> <span class="o">/</span> <span class="n">htotal</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">hsync</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">hsync</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">hmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_validate_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">myindex</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vbflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">xres</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">myres</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="n">MD_SIS300</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="n">MD_SIS315</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">myres</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_DISP2</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">CRT2_LCD</span>:
		<span class="n">xres</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdxres</span><span class="p">;</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdyres</span><span class="p">;</span>

		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_CustomT</span> <span class="o">!=</span> <span class="n">CUT_PANEL848</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_CustomT</span> <span class="o">!=</span> <span class="n">CUT_PANEL856</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">xres</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">myres</span> <span class="o">&gt;</span> <span class="n">yres</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_fstn</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">320</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">myres</span> <span class="o">==</span> <span class="mi">240</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">switch</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
						<span class="k">case</span> <span class="mh">0x50</span>: <span class="n">myindex</span> <span class="o">=</span> <span class="n">MODE_FSTN_8</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
						<span class="k">case</span> <span class="mh">0x56</span>: <span class="n">myindex</span> <span class="o">=</span> <span class="n">MODE_FSTN_16</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
						<span class="k">case</span> <span class="mh">0x53</span>: <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">SiS_GetModeID_LCD</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span><span class="p">,</span> <span class="n">vbflags</span><span class="p">,</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">xres</span><span class="p">,</span>
			 	<span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">yres</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_fstn</span><span class="p">,</span>
			 	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_CustomT</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x14</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CRT2_TV</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">SiS_GetModeID_TV</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span><span class="p">,</span> <span class="n">vbflags</span><span class="p">,</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">xres</span><span class="p">,</span>
				<span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">yres</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x14</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CRT2_VGA</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">SiS_GetModeID_VGA2</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span><span class="p">,</span> <span class="n">vbflags</span><span class="p">,</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">xres</span><span class="p">,</span>
				<span class="n">sisbios_mode</span><span class="p">[</span><span class="n">myindex</span><span class="p">].</span><span class="n">yres</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x14</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">myindex</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">sisfb_search_refresh_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">xres</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">mode_idx</span><span class="p">].</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">mode_idx</span><span class="p">].</span><span class="n">yres</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span><span class="p">((</span><span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xres</span> <span class="o">&lt;=</span> <span class="n">xres</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xres</span> <span class="o">==</span> <span class="n">xres</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">yres</span> <span class="o">==</span> <span class="n">yres</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span> <span class="o">==</span> <span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span> <span class="o">&gt;</span> <span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">((</span><span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span> <span class="o">-</span> <span class="n">rate</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;sisfb: Adjusting rate from %d up to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">rate</span><span class="p">,</span> <span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span><span class="p">);</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span> <span class="o">=</span> <span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">((</span><span class="n">rate</span> <span class="o">-</span> <span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">refresh</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;sisfb: Adjusting rate from %d down to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">rate</span><span class="p">,</span> <span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">refresh</span><span class="p">);</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span> <span class="o">=</span> <span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">refresh</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">rate</span> <span class="o">-</span> <span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;sisfb: Adjusting rate from %d down to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">rate</span><span class="p">,</span> <span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">sisfb_vrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Unsupported rate %d for %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rate</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">sisfb_bridgeisslave</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">P1_00</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_VIDEOBRIDGE</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">P1_00</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">P1_00</span> <span class="o">&amp;</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">P1_00</span> <span class="o">&amp;</span> <span class="mh">0x50</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">sisfballowretracecrt1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">sisfbcheckvretracecrt1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">sisfballowretracecrt1</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SISINPSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfbwaitretracecrt1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">watchdog</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">sisfballowretracecrt1</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">watchdog</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SISINPSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">watchdog</span><span class="p">);</span>
	<span class="n">watchdog</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SISINPSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">watchdog</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">sisfbcheckvretracecrt2</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIS_300_VGA</span>: <span class="n">reg</span> <span class="o">=</span> <span class="mh">0x25</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIS_315_VGA</span>: <span class="n">reg</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">sisfb_CheckVBRetrace</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_DISP2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">sisfb_bridgeisslave</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">sisfbcheckvretracecrt2</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sisfbcheckvretracecrt1</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">sisfb_setupvbblankflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vcount</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">hcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">,</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">reg2</span><span class="p">,</span> <span class="n">reg3</span><span class="p">,</span> <span class="n">reg4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">vcount</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">hcount</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_DISP2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisfb_bridgeisslave</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))))</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FB_VBLANK_HAVE_VSYNC</span>  <span class="o">|</span>
			<span class="n">FB_VBLANK_HAVE_HBLANK</span> <span class="o">|</span>
			<span class="n">FB_VBLANK_HAVE_VBLANK</span> <span class="o">|</span>
			<span class="n">FB_VBLANK_HAVE_VCOUNT</span> <span class="o">|</span>
			<span class="n">FB_VBLANK_HAVE_HCOUNT</span><span class="p">);</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SIS_300_VGA</span>: <span class="n">idx</span> <span class="o">=</span> <span class="mh">0x25</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
			<span class="k">case</span> <span class="n">SIS_315_VGA</span>: <span class="n">idx</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg1</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">0</span><span class="p">));</span> <span class="cm">/* 30 */</span>
		<span class="n">reg2</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span> <span class="cm">/* 31 */</span>
		<span class="n">reg3</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">));</span> <span class="cm">/* 32 */</span>
		<span class="n">reg4</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">));</span> <span class="cm">/* 33 */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg1</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">ret</span> <span class="o">|=</span> <span class="n">FB_VBLANK_VBLANKING</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg1</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="n">ret</span> <span class="o">|=</span> <span class="n">FB_VBLANK_VSYNCING</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg4</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="n">ret</span> <span class="o">|=</span> <span class="n">FB_VBLANK_HBLANKING</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">vcount</span><span class="p">)</span> <span class="o">=</span> <span class="n">reg3</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg4</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">hcount</span><span class="p">)</span> <span class="o">=</span> <span class="n">reg2</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg4</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sisfballowretracecrt1</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FB_VBLANK_HAVE_VSYNC</span>  <span class="o">|</span>
			<span class="n">FB_VBLANK_HAVE_VBLANK</span> <span class="o">|</span>
			<span class="n">FB_VBLANK_HAVE_VCOUNT</span> <span class="o">|</span>
			<span class="n">FB_VBLANK_HAVE_HCOUNT</span><span class="p">);</span>
		<span class="n">reg1</span> <span class="o">=</span> <span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SISINPSTAT</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg1</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="n">ret</span> <span class="o">|=</span> <span class="n">FB_VBLANK_VSYNCING</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg1</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">ret</span> <span class="o">|=</span> <span class="n">FB_VBLANK_VBLANKING</span><span class="p">;</span>
		<span class="n">reg1</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">reg1</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">);</span>
		<span class="n">reg2</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">);</span>
		<span class="n">reg3</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">vcount</span><span class="p">)</span> <span class="o">=</span> <span class="n">reg2</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg3</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">hcount</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg1</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg3</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_myblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">sr01</span><span class="p">,</span> <span class="n">sr11</span><span class="p">,</span> <span class="n">sr1f</span><span class="p">,</span> <span class="n">cr63</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">p2_0</span><span class="p">,</span> <span class="n">p1_13</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">backlight</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:	<span class="cm">/* on */</span>
			<span class="n">sr01</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">sr11</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">sr1f</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">cr63</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">p2_0</span>  <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">p1_13</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">backlight</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:	<span class="cm">/* blank */</span>
			<span class="n">sr01</span>  <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">sr11</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">sr1f</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">cr63</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">p2_0</span>  <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">p1_13</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">backlight</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:	<span class="cm">/* no vsync */</span>
			<span class="n">sr01</span>  <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">sr11</span>  <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">sr1f</span>  <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">cr63</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">p2_0</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">p1_13</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">backlight</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:	<span class="cm">/* no hsync */</span>
			<span class="n">sr01</span>  <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">sr11</span>  <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">sr1f</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">cr63</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">p2_0</span>  <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">p1_13</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">backlight</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:	<span class="cm">/* off */</span>
			<span class="n">sr01</span>  <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">sr11</span>  <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">sr1f</span>  <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
			<span class="n">cr63</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">p2_0</span>  <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
			<span class="n">p1_13</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
			<span class="n">backlight</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_CRT1</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_thismonitor</span><span class="p">.</span><span class="n">datavalid</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_thismonitor</span><span class="p">.</span><span class="n">datavalid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_thismonitor</span><span class="p">.</span><span class="n">feature</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)))</span> <span class="p">{</span>

			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_MyCR63</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="n">cr63</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisfb_bridgeisslave</span><span class="p">(</span><span class="n">ivideo</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">sr01</span><span class="p">);</span>
				<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">sr1f</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_LCD</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISLVDSBRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">backlight</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SiS_SiS30xBLOn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">SiS_SiS30xBLOff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">backlight</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SiS_Chrontel701xBLOn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">SiS_Chrontel701xBLOff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VB2_301</span><span class="o">|</span><span class="n">VB2_30xBDH</span><span class="o">|</span><span class="n">VB2_LVDS</span><span class="p">)))</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VB2_LVDS</span> <span class="o">|</span> <span class="n">VB2_CHRONTEL</span><span class="p">))</span> <span class="o">==</span> <span class="n">VB2_LVDS</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x0c</span><span class="p">,</span> <span class="n">sr11</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xBDH</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">p1_13</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xBDH</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">p2_0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_VGA</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">p2_0</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------- Callbacks from init.c/init301.c  -------------- */</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">sisfb_read_nbridge_pci_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ivideo</span><span class="p">;</span>
   <span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
   <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">sisfb_write_nbridge_pci_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ivideo</span><span class="p">;</span>

   <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">sisfb_read_lpc_pci_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ivideo</span><span class="p">;</span>
   <span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lpcdev</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

   <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lpcdev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
   <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
<span class="kt">void</span>
<span class="nf">sisfb_write_nbridge_pci_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ivideo</span><span class="p">;</span>

   <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">sisfb_read_mio_pci_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span> <span class="o">*</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">ivideo</span><span class="p">;</span>
   <span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lpcdev</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

   <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lpcdev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
   <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* ----------- FBDev related routines for all series ----------- */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_get_cmap_len</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_set_vparms</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">DstColor</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS310_AccelDepth</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_cmap_len</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">DstColor</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS310_AccelDepth</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_cmap_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">DstColor</span> <span class="o">=</span> <span class="mh">0xC000</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS310_AccelDepth</span> <span class="o">=</span> <span class="mh">0x00020000</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_cmap_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_cmap_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Unsupported depth %d&quot;</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_bpp</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_calc_maxyres</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">maxyres</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mem</span> <span class="o">/</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>

	<span class="k">if</span><span class="p">(</span><span class="n">maxyres</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span> <span class="n">maxyres</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">maxyres</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_calc_pitch</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_linelength</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">scrnpitchCRT1</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_linelength</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">CRT1_LCDA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">scrnpitchCRT1</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_set_pitch</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">isslavemode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">HDisplay1</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">scrnpitchCRT1</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">HDisplay2</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_linelength</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">sisfb_bridgeisslave</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span> <span class="n">isslavemode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* We need to set pitch for CRT1 if bridge is in slave mode, too */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_DISP1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">isslavemode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="p">(</span><span class="n">HDisplay1</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="p">(</span><span class="n">HDisplay1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* We must not set the pitch for CRT2 if bridge is in slave mode */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_DISP2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">isslavemode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2_write_enable</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="p">(</span><span class="n">HDisplay2</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="p">(</span><span class="n">HDisplay2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_bpp_to_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_cmap_len</span> <span class="o">=</span> <span class="n">sisfb_get_cmap_len</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clrscrn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">modeno</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mode_no</span><span class="p">;</span>

	<span class="cm">/* &gt;=2.6.12&#39;s fbcon clears the screen anyway */</span>
	<span class="n">modeno</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_PASSWORD</span><span class="p">,</span> <span class="n">SIS_PASSWORD</span><span class="p">);</span>

	<span class="n">sisfb_pre_setmode</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SiSSetMode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">modeno</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Setting mode[0x%x] failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mode_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_PASSWORD</span><span class="p">,</span> <span class="n">SIS_PASSWORD</span><span class="p">);</span>

	<span class="n">sisfb_post_setmode</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_do_set_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isactive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">htotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vtotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">drate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hrate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pixclock</span><span class="p">;</span>

	<span class="n">htotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>

	<span class="n">vtotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>

	<span class="n">pixclock</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vtotal</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">vtotal</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vtotal</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">vtotal</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vtotal</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">vtotal</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> 	<span class="n">vtotal</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">htotal</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">vtotal</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;sisfb: Invalid &#39;var&#39; information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pixclock</span> <span class="o">&amp;&amp;</span> <span class="n">htotal</span> <span class="o">&amp;&amp;</span> <span class="n">vtotal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drate</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">pixclock</span><span class="p">;</span>
		<span class="n">hrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">drate</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">htotal</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">hrate</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">vtotal</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_mode</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">xres</span> <span class="o">&lt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">xres</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">yres</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">bpp</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mode_no</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">];</span>
			<span class="n">found_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">found_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">sisfb_validate_mode</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

       	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Mode %dx%dx%d not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span>
		       <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">old_mode</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mode_no</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">];</span>

	<span class="k">if</span><span class="p">(</span><span class="n">sisfb_search_refresh_rate</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">rate_idx</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">isactive</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If acceleration to be used? Need to know</span>
<span class="cm">		 * before pre/post_set_mode()</span>
<span class="cm">		 */</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if defined(FBINFO_HWACCEL_DISABLED) &amp;&amp; defined(FBINFO_HWACCEL_XPAN)</span>
<span class="cp">#ifdef STUPID_ACCELF_TEXT_SHIT</span>
		<span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">&amp;</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">))</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">&amp;</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">)</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">if</span><span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sisfb_set_mode</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_bpp</span>    <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">bpp</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_width</span>  <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">xres</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_height</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">yres</span><span class="p">;</span>

		<span class="n">sisfb_calc_pitch</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="n">sisfb_set_pitch</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

		<span class="n">sisfb_set_vparms</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_width</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_width</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_height</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_height</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_bpp</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_bpp</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_htotal</span> <span class="o">=</span> <span class="n">htotal</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_vtotal</span> <span class="o">=</span> <span class="n">vtotal</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_linelength</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_linelength</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_pixclock</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_refresh_rate</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_lastrates</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mode_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_set_base_CRT1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_PASSWORD</span><span class="p">,</span> <span class="n">SIS_PASSWORD</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_set_base_CRT2</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_DISP2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2_write_enable</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="p">((</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="p">((</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="p">((</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_pan_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_base</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span>
			     <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>

	<span class="cm">/* calculate base bpp dep. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_base</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="nl">default:</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_base</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_base</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">sisfb_set_base_CRT1</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_base</span><span class="p">);</span>
	<span class="n">sisfb_set_base_CRT2</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_base</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">sisfb_get_cmap_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SISDACA</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
		<span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SISDACD</span><span class="p">,</span> <span class="p">(</span><span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>
		<span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SISDACD</span><span class="p">,</span> <span class="p">(</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>
		<span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SISDACD</span><span class="p">,</span> <span class="p">(</span><span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_DISP2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SISDAC2A</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
			<span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SISDAC2D</span><span class="p">,</span> <span class="p">(</span><span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SISDAC2D</span><span class="p">,</span> <span class="p">(</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SISDAC2D</span><span class="p">,</span> <span class="p">(</span><span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span>          <span class="o">|</span>
				<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">blue</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">sisfb_do_set_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sisfb_get_fix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">htotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vtotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">myrateindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">drate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hrate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxyres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">refresh_rate</span><span class="p">,</span> <span class="n">search_idx</span><span class="p">,</span> <span class="n">tidx</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">recalc_clock</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pixclock</span><span class="p">;</span>

	<span class="n">htotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>

	<span class="n">vtotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>

	<span class="n">pixclock</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vtotal</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">vtotal</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vtotal</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">vtotal</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vtotal</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">vtotal</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vtotal</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">htotal</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">vtotal</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SISFAIL</span><span class="p">(</span><span class="s">&quot;sisfb: no valid timing data&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">search_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">xres</span> <span class="o">&lt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">xres</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">yres</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">bpp</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">tidx</span> <span class="o">=</span> <span class="n">sisfb_validate_mode</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">search_idx</span><span class="p">,</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">search_idx</span> <span class="o">=</span> <span class="n">tidx</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">search_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">found_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">search_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">xres</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">yres</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">bpp</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">tidx</span> <span class="o">=</span> <span class="n">sisfb_validate_mode</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span><span class="n">search_idx</span><span class="p">,</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">search_idx</span> <span class="o">=</span> <span class="n">tidx</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		   <span class="p">}</span>
		   <span class="n">search_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">found_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				<span class="s">&quot;sisfb: Adapted from %dx%dx%d to %dx%dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span>
				<span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">xres</span><span class="p">,</span>
				<span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">yres</span><span class="p">,</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">xres</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">yres</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;sisfb: Failed to find supported mode near %dx%dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_LVDS</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xBDH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_LCD</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Slave modes on LVDS and 301B-DH */</span>
		<span class="n">refresh_rate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">recalc_clock</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_htotal</span> <span class="o">==</span> <span class="n">htotal</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_vtotal</span> <span class="o">==</span> <span class="n">vtotal</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_pixclock</span> <span class="o">==</span> <span class="n">pixclock</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* x=x &amp; y=y &amp; c=c -&gt; assume depth change */</span>
		<span class="n">drate</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">pixclock</span><span class="p">;</span>
		<span class="n">hrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">drate</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">htotal</span><span class="p">;</span>
		<span class="n">refresh_rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">hrate</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">vtotal</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_htotal</span> <span class="o">!=</span> <span class="n">htotal</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_vtotal</span> <span class="o">!=</span> <span class="n">vtotal</span><span class="p">)</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_pixclock</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* x!=x | y!=y &amp; c=c -&gt; invalid pixclock */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_lastrates</span><span class="p">[</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">]])</span> <span class="p">{</span>
			<span class="n">refresh_rate</span> <span class="o">=</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_lastrates</span><span class="p">[</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">]];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_rate</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sic, sisfb_parm_rate - want to know originally desired rate here */</span>
			<span class="n">refresh_rate</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_rate</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">refresh_rate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">recalc_clock</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">htotal</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vtotal</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drate</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">pixclock</span><span class="p">;</span>
		<span class="n">hrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">drate</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">htotal</span><span class="p">;</span>
		<span class="n">refresh_rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">hrate</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">vtotal</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_refresh_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">refresh_rate</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_refresh_rate</span><span class="p">;</span>
		<span class="n">recalc_clock</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">refresh_rate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">recalc_clock</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">myrateindex</span> <span class="o">=</span> <span class="n">sisfb_search_refresh_rate</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">refresh_rate</span><span class="p">,</span> <span class="n">search_idx</span><span class="p">);</span>

	<span class="cm">/* Eventually recalculate timing and clock */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">recalc_clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">myrateindex</span><span class="p">)</span> <span class="n">myrateindex</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">rate_idx</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="mi">1000000000</span> <span class="o">/</span> <span class="n">sisfb_mode_rate_to_dclock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span>
						<span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">],</span>
						<span class="n">myrateindex</span><span class="p">));</span>
		<span class="n">sisfb_mode_rate_to_ddata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span>
					<span class="n">sisbios_mode</span><span class="p">[</span><span class="n">search_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">],</span>
					<span class="n">myrateindex</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_thismonitor</span><span class="p">.</span><span class="n">datavalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">sisfb_verify_rate</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_thismonitor</span><span class="p">,</span> <span class="n">search_idx</span><span class="p">,</span>
				<span class="n">myrateindex</span><span class="p">,</span> <span class="n">refresh_rate</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;sisfb: WARNING: Refresh rate exceeds monitor specs!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Adapt RGB settings */</span>
	<span class="n">sisfb_bpp_to_var</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>

	<span class="cm">/* Sanity check for offsets */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_ypan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maxyres</span> <span class="o">=</span> <span class="n">sisfb_calc_maxyres</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">maxyres</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">maxyres</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">maxyres</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Truncate offsets to maximum if too high */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set everything else to 0 */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span><span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sisfb_pan_var</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sisfb_myblank</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">blank</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----------- FBDev related routines for all series ---------- */</span>

<span class="k">static</span> <span class="kt">int</span>	<span class="nf">sisfb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span>	<span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sis_memreq</span>	<span class="n">sismemreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_vblank</span>	<span class="n">sisvbblank</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">gpu32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifndef __user</span>
<span class="cp">#define __user</span>
<span class="cp">#endif</span>
	<span class="n">u32</span> <span class="n">__user</span> 		<span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	   <span class="k">case</span> <span class="n">FBIO_ALLOC</span>:
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sismemreq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sismemreq</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">sis_malloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sismemreq</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sismemreq</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sismemreq</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">sis_free</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">sismemreq</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	   <span class="k">case</span> <span class="n">FBIO_FREE</span>:
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">gpu32</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">sis_free</span><span class="p">(</span><span class="n">gpu32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	   <span class="k">case</span> <span class="n">FBIOGET_VBLANK</span>:

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisvbblank</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_vblank</span><span class="p">));</span>

		<span class="n">sisvbblank</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sisvbblank</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">sisfb_setupvbblankflags</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sisvbblank</span><span class="p">.</span><span class="n">vcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sisvbblank</span><span class="p">.</span><span class="n">hcount</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sisvbblank</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sisvbblank</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	   <span class="k">case</span> <span class="n">SISFB_GET_INFO_SIZE</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisfb_info</span><span class="p">),</span> <span class="n">argp</span><span class="p">);</span>

	   <span class="k">case</span> <span class="n">SISFB_GET_INFO_OLD</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">warncount</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;sisfb: Deprecated ioctl call received - update your application!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	   <span class="k">case</span> <span class="n">SISFB_GET_INFO</span>:  <span class="cm">/* For communication with X driver */</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_id</span>         <span class="o">=</span> <span class="n">SISFB_ID</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_version</span>    <span class="o">=</span> <span class="n">VER_MAJOR</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_revision</span>   <span class="o">=</span> <span class="n">VER_MINOR</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_patchlevel</span> <span class="o">=</span> <span class="n">VER_LEVEL</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_pci_vendor</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip_vendor</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">heapstart</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">heapstart</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modechanged</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">fbvidmode</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mode_no</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">fbvidmode</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modeprechange</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_caps</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_tqlen</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_pcibus</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">pcibus</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_pcislot</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">pcislot</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_pcifunc</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">pcifunc</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_lcdpdc</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_lcdpdca</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdca</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_lcda</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedlcda</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_vbflags</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_currentvbflags</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_scalelcd</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UsePanelScaler</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_specialtiming</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_CustomT</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_haveemi</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">HaveEMI</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_haveemilcd</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">HaveEMILCD</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_emi30</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">EMI_30</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_emi31</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">EMI_31</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_emi32</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">EMI_32</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_emi33</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">EMI_33</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_tvxpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvxpos</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_tvypos</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvypos</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_heapsize</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_videooffset</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_offset</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_curfstn</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curFSTN</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_curdstn</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curDSTN</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_vbflags2</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_can_post</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_can_post</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_card_posted</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_card_posted</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">.</span><span class="n">sisfb_was_boot_device</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_was_boot_device</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_infoblock</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	        <span class="k">break</span><span class="p">;</span>

	   <span class="k">case</span> <span class="n">SISFB_GET_VBRSTATUS_OLD</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">warncount</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;sisfb: Deprecated ioctl call received - update your application!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	   <span class="k">case</span> <span class="n">SISFB_GET_VBRSTATUS</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">sisfb_CheckVBRetrace</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	   <span class="k">case</span> <span class="n">SISFB_GET_AUTOMAXIMIZE_OLD</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">warncount</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;sisfb: Deprecated ioctl call received - update your application!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	   <span class="k">case</span> <span class="n">SISFB_GET_AUTOMAXIMIZE</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_max</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	   <span class="k">case</span> <span class="n">SISFB_SET_AUTOMAXIMIZE_OLD</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">warncount</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;sisfb: Deprecated ioctl call received - update your application!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	   <span class="k">case</span> <span class="n">SISFB_SET_AUTOMAXIMIZE</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">gpu32</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">gpu32</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	   <span class="k">case</span> <span class="n">SISFB_SET_TVPOSOFFSET</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">gpu32</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">sisfb_set_TVxposoffset</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">gpu32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">-</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">sisfb_set_TVyposoffset</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">gpu32</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="o">-</span> <span class="mi">32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	   <span class="k">case</span> <span class="n">SISFB_GET_TVPOSOFFSET</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">((</span><span class="n">u32</span><span class="p">)(((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvxpos</span><span class="o">+</span><span class="mi">32</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvypos</span><span class="o">+</span><span class="mi">32</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">)),</span>
							<span class="n">argp</span><span class="p">);</span>

	   <span class="k">case</span> <span class="n">SISFB_COMMAND</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_command</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisfb_cmd</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">sisfb_handle_command</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_command</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_command</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisfb_cmd</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	   <span class="k">case</span> <span class="n">SISFB_SET_LOCK</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">gpu32</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfblocked</span> <span class="o">=</span> <span class="p">(</span><span class="n">gpu32</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	   <span class="nl">default:</span>
<span class="cp">#ifdef SIS_NEW_CONFIG_COMPAT</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_get_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">con</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span><span class="p">));</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span>  <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_base</span> <span class="o">+</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_offset</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span>    <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mem</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span>        <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span>      <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> 	 <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_ypan</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ywrapstep</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_linelength</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span>  <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span>    <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_size</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_SIS_GLAMOUR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">SIS_330</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">SIS_760</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">SIS_761</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_SIS_XABRE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_XGI_VOLARI_Z</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_XGI_VOLARI_V</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_SIS_GLAMOUR_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------  fb_ops structures ----------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">sisfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>	<span class="o">=</span> <span class="n">sisfb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>	<span class="o">=</span> <span class="n">sisfb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">sisfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">sisfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">sisfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">sisfb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">sisfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">fbcon_sis_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">fbcon_sis_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_sync</span>	<span class="o">=</span> <span class="n">fbcon_sis_sync</span><span class="p">,</span>
<span class="cp">#ifdef SIS_NEW_CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">fb_compat_ioctl</span><span class="o">=</span> <span class="n">sisfb_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">fb_ioctl</span>	<span class="o">=</span> <span class="n">sisfb_ioctl</span>
<span class="p">};</span>

<span class="cm">/* ---------------- Chip generation dependent routines ---------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span> <span class="n">__devinit</span>
<span class="nf">sisfb_get_northbridge</span><span class="p">(</span><span class="kt">int</span> <span class="n">basechipid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbridgenum</span><span class="p">,</span> <span class="n">nbridgeidx</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">nbridgeids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">PCI_DEVICE_ID_SI_540</span><span class="p">,</span>	<span class="cm">/* for SiS 540 VGA */</span>
		<span class="n">PCI_DEVICE_ID_SI_630</span><span class="p">,</span>	<span class="cm">/* for SiS 630/730 VGA */</span>
		<span class="n">PCI_DEVICE_ID_SI_730</span><span class="p">,</span>
		<span class="n">PCI_DEVICE_ID_SI_550</span><span class="p">,</span>   <span class="cm">/* for SiS 550 VGA */</span>
		<span class="n">PCI_DEVICE_ID_SI_650</span><span class="p">,</span>   <span class="cm">/* for SiS 650/651/740 VGA */</span>
		<span class="n">PCI_DEVICE_ID_SI_651</span><span class="p">,</span>
		<span class="n">PCI_DEVICE_ID_SI_740</span><span class="p">,</span>
		<span class="n">PCI_DEVICE_ID_SI_661</span><span class="p">,</span>	<span class="cm">/* for SiS 661/741/660/760/761 VGA */</span>
		<span class="n">PCI_DEVICE_ID_SI_741</span><span class="p">,</span>
		<span class="n">PCI_DEVICE_ID_SI_660</span><span class="p">,</span>
		<span class="n">PCI_DEVICE_ID_SI_760</span><span class="p">,</span>
		<span class="n">PCI_DEVICE_ID_SI_761</span>
	<span class="p">};</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">basechipid</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
	<span class="k">case</span> <span class="n">SIS_540</span>:	<span class="n">nbridgeidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nbridgenum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIS_630</span>:	<span class="n">nbridgeidx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">nbridgenum</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">case</span> <span class="n">SIS_550</span>:   <span class="n">nbridgeidx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">nbridgenum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIS_650</span>:	<span class="n">nbridgeidx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">nbridgenum</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIS_660</span>:	<span class="n">nbridgeidx</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">nbridgenum</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbridgenum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SI</span><span class="p">,</span>
				<span class="n">nbridgeids</span><span class="p">[</span><span class="n">nbridgeidx</span><span class="o">+</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">sisfb_get_dram_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_FB_SIS_300) || defined(CONFIG_FB_SIS_315)</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">UMAsize</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">LFBsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
	<span class="k">case</span> <span class="n">SIS_300</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIS_540</span>:
	<span class="k">case</span> <span class="n">SIS_630</span>:
	<span class="k">case</span> <span class="n">SIS_730</span>:
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">21</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">case</span> <span class="n">SIS_315H</span>:
	<span class="k">case</span> <span class="n">SIS_315PRO</span>:
	<span class="k">case</span> <span class="n">SIS_315</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">switch</span><span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIS_330</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIS_550</span>:
	<span class="k">case</span> <span class="n">SIS_650</span>:
	<span class="k">case</span> <span class="n">SIS_740</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIS_661</span>:
	<span class="k">case</span> <span class="n">SIS_741</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIS_660</span>:
	<span class="k">case</span> <span class="n">SIS_760</span>:
	<span class="k">case</span> <span class="n">SIS_761</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>	<span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">UMAsize</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">LFBsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">LFBsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">+=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">LFBsize</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIS_340</span>:
	<span class="k">case</span> <span class="n">XGI_20</span>:
	<span class="k">case</span> <span class="n">XGI_40</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">reg</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
				<span class="k">else</span>	       <span class="n">reg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span>		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span>	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------- video bridge device detection --------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_detect_VB_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cr32</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* No CRT2 on XGI Z7 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="n">SIS_300</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* PAL/NTSC is stored on SR16 on such machines */</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_PAL</span> <span class="o">|</span> <span class="n">TV_NTSC</span> <span class="o">|</span> <span class="n">TV_PALM</span> <span class="o">|</span> <span class="n">TV_PALN</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_PAL</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_NTSC</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">cr32</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">cr32</span> <span class="o">&amp;</span> <span class="n">SIS_CRT1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr32</span> <span class="o">&amp;</span> <span class="mh">0xDF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CRT2_TV</span> <span class="o">|</span> <span class="n">CRT2_LCD</span> <span class="o">|</span> <span class="n">CRT2_VGA</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">cr32</span> <span class="o">&amp;</span> <span class="n">SIS_VB_TV</span><span class="p">)</span>   <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">CRT2_TV</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">cr32</span> <span class="o">&amp;</span> <span class="n">SIS_VB_LCD</span><span class="p">)</span>  <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">CRT2_LCD</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">cr32</span> <span class="o">&amp;</span> <span class="n">SIS_VB_CRT2</span><span class="p">)</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">CRT2_VGA</span><span class="p">;</span>

	<span class="cm">/* Check given parms for hardware compatibility.</span>
<span class="cm">	 * (Cannot do this in the search_xx routines since we don&#39;t</span>
<span class="cm">	 * know what hardware we are running on then)</span>
<span class="cm">	 */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="n">SIS_550</span><span class="p">)</span> <span class="p">{</span>
	   <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_dstn</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_fstn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvplug</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">!=</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISYPBPRBRIDGE</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
	      <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvplug</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="p">{</span>
		 <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvplug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: YPbPr not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	      <span class="p">}</span>
	   <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvplug</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">!=</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISHIVISIONBRIDGE</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
	      <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvplug</span> <span class="o">&amp;</span> <span class="n">TV_HIVISION</span><span class="p">)</span> <span class="p">{</span>
		 <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvplug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: HiVision not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	      <span class="p">}</span>
	   <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvstd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISBRIDGE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">)))</span> <span class="p">)</span> <span class="p">{</span>
	      <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvstd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_PALM</span> <span class="o">|</span> <span class="n">TV_PALN</span> <span class="o">|</span> <span class="n">TV_NTSCJ</span><span class="p">))</span> <span class="p">{</span>
		 <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvstd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: PALM/PALN/NTSCJ not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	      <span class="p">}</span>
	   <span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Detect/set TV plug &amp; type */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvplug</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvplug</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">cr32</span> <span class="o">&amp;</span> <span class="n">SIS_VB_YPBPR</span><span class="p">)</span>     	 <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TV_YPBPR</span><span class="o">|</span><span class="n">TV_YPBPR525I</span><span class="p">);</span> <span class="cm">/* default: 480i */</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">cr32</span> <span class="o">&amp;</span> <span class="n">SIS_VB_HIVISION</span><span class="p">)</span>  <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_HIVISION</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">cr32</span> <span class="o">&amp;</span> <span class="n">SIS_VB_SCART</span><span class="p">)</span>     <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_SCART</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">cr32</span> <span class="o">&amp;</span> <span class="n">SIS_VB_SVIDEO</span><span class="p">)</span>    <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_SVIDEO</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">cr32</span> <span class="o">&amp;</span> <span class="n">SIS_VB_COMPOSITE</span><span class="p">)</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_AVIDEO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_YPBPR</span> <span class="o">|</span> <span class="n">TV_HIVISION</span><span class="p">)))</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvstd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TV_NTSC</span> <span class="o">|</span> <span class="n">TV_PAL</span> <span class="o">|</span> <span class="n">TV_PALM</span> <span class="o">|</span> <span class="n">TV_PALN</span> <span class="o">|</span> <span class="n">TV_NTSCJ</span><span class="p">);</span>
	       <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvstd</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_SCART</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TV_NTSC</span> <span class="o">|</span> <span class="n">TV_PALM</span> <span class="o">|</span> <span class="n">TV_PALN</span> <span class="o">|</span> <span class="n">TV_NTSCJ</span><span class="p">);</span>
	       <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_PAL</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_PAL</span> <span class="o">|</span> <span class="n">TV_NTSC</span> <span class="o">|</span> <span class="n">TV_PALM</span> <span class="o">|</span> <span class="n">TV_PALN</span> <span class="o">|</span> <span class="n">TV_NTSCJ</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_PAL</span><span class="p">;</span>
			<span class="k">else</span>		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_NTSC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&lt;=</span> <span class="n">SIS_315PRO</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_330</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_PAL</span><span class="p">;</span>
			<span class="k">else</span>		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_NTSC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_PAL</span><span class="p">;</span>
			<span class="k">else</span>		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_NTSC</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Copy forceCRT1 option to CRT1off if option is given */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_forcecrt1</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	   <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_forcecrt1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ------------------ Sensing routines ------------------ */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__devinit</span>
<span class="nf">sisfb_test_DDC1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">old</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>

    <span class="n">old</span> <span class="o">=</span> <span class="n">SiS_ReadDDC1Bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">);</span>
    <span class="k">do</span> <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">SiS_ReadDDC1Bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_sense_crt1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">bool</span> <span class="n">mustwait</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">u8</span>  <span class="n">sr1F</span><span class="p">,</span> <span class="n">cr17</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
    <span class="n">u8</span>  <span class="n">cr63</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="n">u16</span> <span class="n">temp</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">sr1F</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
    <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
    <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">sr1F</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="n">mustwait</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">cr63</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_MyCR63</span><span class="p">);</span>
       <span class="n">cr63</span> <span class="o">&amp;=</span> <span class="mh">0x40</span><span class="p">;</span>
       <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_MyCR63</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="n">cr17</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
    <span class="n">cr17</span> <span class="o">&amp;=</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">cr17</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
       <span class="n">mustwait</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
       <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
       <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">mustwait</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">sisfbwaitretracecrt1</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_330</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">);</span>
       <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_340</span><span class="p">)</span> <span class="p">{</span>
	   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">);</span>
       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">);</span>
       <span class="p">}</span>
	<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SISINPSTAT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>    <span class="k">break</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SISINPSTAT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SISMISCW</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">);</span>
	<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
       <span class="k">do</span> <span class="p">{</span>
	  <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_HandleDDC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span><span class="p">,</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span><span class="p">);</span>
       <span class="p">}</span> <span class="k">while</span><span class="p">(((</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">--</span><span class="p">);</span>

       <span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="n">sisfb_test_DDC1</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
       <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">((</span><span class="n">temp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_MyCR63</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="n">cr63</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="n">cr17</span><span class="p">);</span>

    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="n">sr1F</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Determine and detect attached devices on SiS30x */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">SiS_SenseLCD</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">,</span> <span class="n">realcrtno</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">cr37</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">paneltype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PanelSelfDetected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* LCD detection only for TMDS bridges */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISTMDSBRIDGE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xBDH</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* If LCD already set up by BIOS, skip it */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">realcrtno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">DDCPortMixup</span><span class="p">)</span>
		<span class="n">realcrtno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check DDC capabilities */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_HandleDDC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span><span class="p">,</span>
				<span class="n">realcrtno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span><span class="p">);</span>

	<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="n">temp</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Read DDC data */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* Number of retrys */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_HandleDDC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span><span class="p">,</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span><span class="p">,</span> <span class="n">realcrtno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">((</span><span class="n">temp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">--</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* No digital device */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* First detailed timing preferred timing? */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">xres</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mh">0x38</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x3a</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">yres</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mh">0x3b</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x3d</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">xres</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1024</span>:
			<span class="k">if</span><span class="p">(</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span>
				<span class="n">paneltype</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1280</span>:
			<span class="k">if</span><span class="p">(</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">)</span>
				<span class="n">paneltype</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1600</span>:
			<span class="k">if</span><span class="p">((</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">1200</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xC</span><span class="p">))</span>
				<span class="n">paneltype</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">paneltype</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x23</span><span class="p">])</span>
		<span class="n">cr37</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x47</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x18</span><span class="p">)</span>
		<span class="n">cr37</span> <span class="o">|=</span> <span class="p">((((</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x47</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cr37</span> <span class="o">|=</span> <span class="mh">0xc0</span><span class="p">;</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">paneltype</span><span class="p">);</span>
	<span class="n">cr37</span> <span class="o">&amp;=</span> <span class="mh">0xf1</span><span class="p">;</span>
	<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="n">cr37</span><span class="p">);</span>
	<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PanelSelfDetected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">SISDoSense</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">mytest</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">mytest</span> <span class="o">=</span> <span class="n">test</span><span class="p">;</span>
	   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">));</span>
          <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mytest</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
	  <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
          <span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x1500</span><span class="p">);</span>
          <span class="n">mytest</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
          <span class="n">mytest</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
	   <span class="n">temp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
          <span class="n">temp</span> <span class="o">^=</span> <span class="mh">0x0e</span><span class="p">;</span>
          <span class="n">temp</span> <span class="o">&amp;=</span> <span class="n">mytest</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="n">mytest</span><span class="p">)</span> <span class="n">result</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if 1</span>
	  <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	  <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>
	  <span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
<span class="cp">#endif</span>
       <span class="p">}</span>
       <span class="k">if</span><span class="p">((</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">SiS_Sense30x</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span>  <span class="n">backupP4_0d</span><span class="p">,</span><span class="n">backupP2_00</span><span class="p">,</span><span class="n">backupP2_4d</span><span class="p">,</span><span class="n">backupSR_1e</span><span class="p">,</span><span class="n">biosflag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">svhs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">svhs_c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">cvbs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cvbs_c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">vga2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vga2_c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">myflag</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">stdstr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;sisfb: Detected&quot;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">tvstr</span><span class="p">[]</span>  <span class="o">=</span> <span class="s">&quot;TV connected to&quot;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_301</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">svhs</span> <span class="o">=</span> <span class="mh">0x00b9</span><span class="p">;</span> <span class="n">cvbs</span> <span class="o">=</span> <span class="mh">0x00b3</span><span class="p">;</span> <span class="n">vga2</span> <span class="o">=</span> <span class="mh">0x00d1</span><span class="p">;</span>
       <span class="n">myflag</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
       <span class="k">if</span><span class="p">(</span><span class="n">myflag</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">svhs</span> <span class="o">=</span> <span class="mh">0x00dd</span><span class="p">;</span> <span class="n">cvbs</span> <span class="o">=</span> <span class="mh">0x00ee</span><span class="p">;</span> <span class="n">vga2</span> <span class="o">=</span> <span class="mh">0x00fd</span><span class="p">;</span>
       <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VB2_301B</span> <span class="o">|</span> <span class="n">VB2_302B</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">svhs</span> <span class="o">=</span> <span class="mh">0x016b</span><span class="p">;</span> <span class="n">cvbs</span> <span class="o">=</span> <span class="mh">0x0174</span><span class="p">;</span> <span class="n">vga2</span> <span class="o">=</span> <span class="mh">0x0190</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VB2_301LV</span> <span class="o">|</span> <span class="n">VB2_302LV</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">svhs</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">;</span> <span class="n">cvbs</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VB2_301C</span> <span class="o">|</span> <span class="n">VB2_302ELV</span> <span class="o">|</span> <span class="n">VB2_307T</span> <span class="o">|</span> <span class="n">VB2_307LV</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">svhs</span> <span class="o">=</span> <span class="mh">0x016b</span><span class="p">;</span> <span class="n">cvbs</span> <span class="o">=</span> <span class="mh">0x0110</span><span class="p">;</span> <span class="n">vga2</span> <span class="o">=</span> <span class="mh">0x0190</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span>
       <span class="k">return</span><span class="p">;</span>

    <span class="n">vga2_c</span> <span class="o">=</span> <span class="mh">0x0e08</span><span class="p">;</span> <span class="n">svhs_c</span> <span class="o">=</span> <span class="mh">0x0404</span><span class="p">;</span> <span class="n">cvbs_c</span> <span class="o">=</span> <span class="mh">0x0804</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VB2_301LV</span><span class="o">|</span><span class="n">VB2_302LV</span><span class="o">|</span><span class="n">VB2_302ELV</span><span class="o">|</span><span class="n">VB2_307LV</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">svhs_c</span> <span class="o">=</span> <span class="mh">0x0408</span><span class="p">;</span> <span class="n">cvbs_c</span> <span class="o">=</span> <span class="mh">0x0808</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">biosflag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">biosflag</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">[</span><span class="mh">0x58</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">newrom</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">[</span><span class="mh">0x5d</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="n">biosflag</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">biosflag</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">[</span><span class="mh">0xfe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
       <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">SIS_300</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">myflag</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">);</span>
       <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">myflag</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="n">vga2</span> <span class="o">=</span> <span class="n">vga2_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISVGA2BRIDGE</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">vga2</span> <span class="o">=</span> <span class="n">vga2_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">backupSR_1e</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">);</span>
    <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

    <span class="n">backupP4_0d</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xC</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>

    <span class="n">backupP2_00</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="p">((</span><span class="n">backupP2_00</span> <span class="o">|</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">));</span>

    <span class="n">backupP2_4d</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISYPBPRBRIDGE</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="p">(</span><span class="n">backupP2_4d</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xCLV</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">SISDoSense</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x14</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">vga2_c</span> <span class="o">||</span> <span class="n">vga2</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span><span class="p">(</span><span class="n">SISDoSense</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">vga2</span><span class="p">,</span> <span class="n">vga2_c</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="n">biosflag</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
	     <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s %s SCART output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">tvstr</span><span class="p">);</span>
	     <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	     <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s secondary VGA connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">);</span>
	     <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	  <span class="p">}</span>
       <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xCLV</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISYPBPRBRIDGE</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="p">(</span><span class="n">backupP2_4d</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">));</span>
       <span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
       <span class="k">if</span><span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">SISDoSense</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">svhs</span><span class="p">,</span> <span class="mh">0x0604</span><span class="p">)))</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">SISDoSense</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">cvbs</span><span class="p">,</span> <span class="mh">0x0804</span><span class="p">)))</span> <span class="p">{</span>
	     <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s %s YPbPr component output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">tvstr</span><span class="p">);</span>
	     <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	  <span class="p">}</span>
       <span class="p">}</span>
       <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="n">backupP2_4d</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">))</span> <span class="p">{</span>
       <span class="k">if</span><span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">SISDoSense</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">svhs</span><span class="p">,</span> <span class="n">svhs_c</span><span class="p">)))</span> <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s %s SVIDEO output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">tvstr</span><span class="p">);</span>
	   <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
       <span class="p">}</span>
       <span class="k">if</span><span class="p">((</span><span class="n">biosflag</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="n">SISDoSense</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">cvbs</span><span class="p">,</span> <span class="n">cvbs_c</span><span class="p">))</span> <span class="p">{</span>
	     <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s %s COMPOSITE output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">tvstr</span><span class="p">);</span>
	     <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
          <span class="p">}</span>
       <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">SISDoSense</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">backupP2_00</span><span class="p">);</span>
    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">backupP4_0d</span><span class="p">);</span>
    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="n">backupSR_1e</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xCLV</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">biosflag</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
       <span class="k">if</span><span class="p">(</span><span class="n">biosflag</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span><span class="p">(</span><span class="n">myflag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">myflag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">myflag</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
	     <span class="n">biosflag</span> <span class="o">^=</span> <span class="mh">0x20</span><span class="p">;</span>
	     <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">biosflag</span><span class="p">);</span>
	  <span class="p">}</span>
       <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">backupP2_00</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Determine and detect attached TV&#39;s on Chrontel */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">SiS_SenseCh</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_FB_SIS_300) || defined(CONFIG_FB_SIS_315)</span>
    <span class="n">u8</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">stdstr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;sisfb: Chrontel: Detected TV connected to&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">test</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&lt;</span> <span class="n">SIS_315H</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
       <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_IF_DEF_CH70xx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Chrontel 700x */</span>
       <span class="n">SiS_SetChrontelGPIO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">);</span>	<span class="cm">/* Set general purpose IO for Chrontel communication */</span>
       <span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
       <span class="n">temp1</span> <span class="o">=</span> <span class="n">SiS_GetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>
       <span class="cm">/* See Chrontel TB31 for explanation */</span>
       <span class="n">temp2</span> <span class="o">=</span> <span class="n">SiS_GetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
       <span class="k">if</span><span class="p">(((</span><span class="n">temp2</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">temp2</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">SiS_SetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">);</span>
	  <span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
       <span class="p">}</span>
       <span class="n">temp2</span> <span class="o">=</span> <span class="n">SiS_GetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>
       <span class="k">if</span><span class="p">(</span><span class="n">temp2</span> <span class="o">!=</span> <span class="n">temp1</span><span class="p">)</span> <span class="n">temp1</span> <span class="o">=</span> <span class="n">temp2</span><span class="p">;</span>

       <span class="k">if</span><span class="p">((</span><span class="n">temp1</span> <span class="o">&gt;=</span> <span class="mh">0x22</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp1</span> <span class="o">&lt;=</span> <span class="mh">0x50</span><span class="p">))</span> <span class="p">{</span>
	   <span class="cm">/* Read power status */</span>
	   <span class="n">temp1</span> <span class="o">=</span> <span class="n">SiS_GetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
	   <span class="k">if</span><span class="p">((</span><span class="n">temp1</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Power all outputs */</span>
		<span class="n">SiS_SetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span><span class="mh">0x0b</span><span class="p">);</span>
		<span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
	   <span class="p">}</span>
	   <span class="cm">/* Sense connected TV devices */</span>
	   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">SiS_SetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	       <span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">);</span>
	       <span class="n">SiS_SetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	       <span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">);</span>
	       <span class="n">temp1</span> <span class="o">=</span> <span class="n">SiS_GetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	       <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp1</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span>       <span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	       <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp1</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span>  <span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	       <span class="k">else</span>                      <span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	       <span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">);</span>
	   <span class="p">}</span>

	   <span class="k">if</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>      <span class="n">temp1</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">test</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="n">temp1</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">test</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="n">temp1</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	   <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;sisfb: TV detection unreliable - test results varied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">temp1</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	   <span class="p">}</span>
	   <span class="k">if</span><span class="p">(</span><span class="n">temp1</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s SVIDEO output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_SVIDEO</span><span class="p">;</span>
		<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x05</span><span class="p">);</span>
	   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp1</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s CVBS output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_AVIDEO</span><span class="p">;</span>
		<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x06</span><span class="p">);</span>
	   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SiS_SetCH70xxANDOR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">);</span>
		<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">);</span>
	   <span class="p">}</span>
       <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">temp1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">SiS_SetCH70xxANDOR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">);</span>
	  <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">);</span>
       <span class="p">}</span>
       <span class="cm">/* Set general purpose IO for Chrontel communication */</span>
       <span class="n">SiS_SetChrontelGPIO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_IF_DEF_CH70xx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* Chrontel 7019 */</span>
	<span class="n">temp1</span> <span class="o">=</span> <span class="n">SiS_GetCH701x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">);</span>
	<span class="n">SiS_SetCH701x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">);</span>
	<span class="n">temp2</span> <span class="o">=</span> <span class="n">SiS_GetCH701x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">temp2</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">SiS_SetCH701x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">temp2</span><span class="p">);</span>
	<span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">);</span>
	<span class="n">temp2</span> <span class="o">^=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">SiS_SetCH701x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">temp2</span><span class="p">);</span>
	<span class="n">SiS_DDC2Delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">);</span>
	<span class="n">temp2</span> <span class="o">=</span> <span class="n">SiS_GetCH701x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">SiS_SetCH701x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="n">temp1</span><span class="p">);</span>
	<span class="n">temp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">temp2</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="n">temp1</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">temp2</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="n">temp1</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">temp2</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="n">temp1</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">temp1</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp1</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">)</span> <span class="n">temp1</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">temp1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x01</span>:
	     <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s CVBS output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">);</span>
	     <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_AVIDEO</span><span class="p">;</span>
	     <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	     <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x06</span><span class="p">);</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
	     <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s SVIDEO output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">);</span>
	     <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">TV_SVIDEO</span><span class="p">;</span>
	     <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	     <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x05</span><span class="p">);</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>:
	     <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s SCART output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">);</span>
	     <span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	     <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">);</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	     <span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_get_VB_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">stdstr</span><span class="p">[]</span>    <span class="o">=</span> <span class="s">&quot;sisfb: Detected&quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">bridgestr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;video bridge&quot;</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vb_chipid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* No CRT2 on XGI Z7 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vb_chipid</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">vb_chipid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xb0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_301</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_301</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s SiS301 %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">bridgestr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_301B</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_301B</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
			   <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_30xBDH</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
			   <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_30xBDH</span><span class="p">;</span>
			   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s SiS301B-DH %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">bridgestr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s SiS301B %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">bridgestr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xd0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_301C</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_301C</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s SiS301C %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">bridgestr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_301LV</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_301LV</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s SiS301LV %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">bridgestr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0xe1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			   <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_302LV</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
			   <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_302LV</span><span class="p">;</span>
			   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s SiS302LV %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">bridgestr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			   <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_301C</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
			   <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_301C</span><span class="p">;</span>
			   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s SiS301C(P4) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">bridgestr</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			   ivideo-&gt;vbflags |= VB_302ELV;	/* Deprecated */</span>
<span class="c">			   ivideo-&gt;vbflags2 |= VB2_302ELV;</span>
<span class="c">			   printk(KERN_INFO &quot;%s SiS302ELV %s\n&quot;, stdstr, bridgestr);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_302B</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_302B</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s SiS302B %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">,</span> <span class="n">bridgestr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_VIDEOBRIDGE</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="n">SIS_300</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="n">SIS_EXTERNAL_CHIP_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
			   <span class="k">case</span> <span class="n">SIS_EXTERNAL_CHIP_LVDS</span>:
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_LVDS</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_LVDS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			   <span class="k">case</span> <span class="n">SIS_EXTERNAL_CHIP_TRUMPION</span>:
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VB_LVDS</span> <span class="o">|</span> <span class="n">VB_TRUMPION</span><span class="p">);</span>	<span class="cm">/* Deprecated */</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VB2_LVDS</span> <span class="o">|</span> <span class="n">VB2_TRUMPION</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			   <span class="k">case</span> <span class="n">SIS_EXTERNAL_CHIP_CHRONTEL</span>:
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_CHRONTEL</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_CHRONTEL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			   <span class="k">case</span> <span class="n">SIS_EXTERNAL_CHIP_LVDS_CHRONTEL</span>:
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VB_LVDS</span> <span class="o">|</span> <span class="n">VB_CHRONTEL</span><span class="p">);</span>	<span class="cm">/* Deprecated */</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VB2_LVDS</span> <span class="o">|</span> <span class="n">VB2_CHRONTEL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">)</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chronteltype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&lt;</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
			   <span class="k">case</span> <span class="n">SIS310_EXTERNAL_CHIP_LVDS</span>:
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_LVDS</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_LVDS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			   <span class="k">case</span> <span class="n">SIS310_EXTERNAL_CHIP_LVDS_CHRONTEL</span>:
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VB_LVDS</span> <span class="o">|</span> <span class="n">VB_CHRONTEL</span><span class="p">);</span>	<span class="cm">/* Deprecated */</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VB2_LVDS</span> <span class="o">|</span> <span class="n">VB2_CHRONTEL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">)</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chronteltype</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
			   <span class="k">case</span> <span class="mh">0x02</span>:
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="n">VB_LVDS</span><span class="p">;</span>	<span class="cm">/* Deprecated */</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="n">VB2_LVDS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			   <span class="k">case</span> <span class="mh">0x03</span>:
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VB_LVDS</span> <span class="o">|</span> <span class="n">VB_CHRONTEL</span><span class="p">);</span>	<span class="cm">/* Deprecated */</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VB2_LVDS</span> <span class="o">|</span> <span class="n">VB2_CHRONTEL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			   <span class="k">case</span> <span class="mh">0x04</span>:
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VB_LVDS</span> <span class="o">|</span> <span class="n">VB_CONEXANT</span><span class="p">);</span>	<span class="cm">/* Deprecated */</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VB2_LVDS</span> <span class="o">|</span> <span class="n">VB2_CONEXANT</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">)</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chronteltype</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_LVDS</span><span class="p">)</span> <span class="p">{</span>
		   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s LVDS transmitter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_TRUMPION</span><span class="p">))</span> <span class="p">{</span>
		   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s Trumpion Zurac LCD scaler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">)</span> <span class="p">{</span>
		   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s Chrontel TV encoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CONEXANT</span><span class="p">))</span> <span class="p">{</span>
		   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s Conexant external device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdstr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISBRIDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SenseLCD</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
		<span class="n">SiS_Sense30x</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SenseCh</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ---------- Engine initialization routines ------------ */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_engine_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Initialize command queue (we use MMIO only) */</span>

	<span class="cm">/* BEFORE THIS IS CALLED, THE ENGINES *MUST* BE SYNC&#39;ED */</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TURBO_QUEUE_CAP</span>    <span class="o">|</span>
			  <span class="n">MMIO_CMD_QUEUE_CAP</span> <span class="o">|</span>
			  <span class="n">VM_CMD_QUEUE_CAP</span>   <span class="o">|</span>
			  <span class="n">AGP_CMD_QUEUE_CAP</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tqueue_pos</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">tq_state</span><span class="p">;</span>

		<span class="n">tqueue_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">-</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>

		<span class="n">tq_state</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_TURBOQUEUE_SET</span><span class="p">);</span>
		<span class="n">tq_state</span> <span class="o">|=</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="n">tq_state</span> <span class="o">&amp;=</span> <span class="mh">0xfc</span><span class="p">;</span>
		<span class="n">tq_state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">tqueue_pos</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_TURBOQUEUE_SET</span><span class="p">,</span> <span class="n">tq_state</span><span class="p">);</span>

		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_TURBOQUEUE_ADR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">tqueue_pos</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">TURBO_QUEUE_CAP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tempq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">templ</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">temp</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>:
				<span class="n">temp</span> <span class="o">=</span> <span class="n">SIS_CMD_QUEUE_SIZE_Z7_64k</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>:
			<span class="nl">default:</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">SIS_CMD_QUEUE_SIZE_Z7_128k</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>:
				<span class="n">temp</span> <span class="o">=</span> <span class="n">SIS_CMD_QUEUE_SIZE_4M</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>:
				<span class="n">temp</span> <span class="o">=</span> <span class="n">SIS_CMD_QUEUE_SIZE_2M</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>:
				<span class="n">temp</span> <span class="o">=</span> <span class="n">SIS_CMD_QUEUE_SIZE_1M</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>:
				<span class="n">temp</span> <span class="o">=</span> <span class="n">SIS_CMD_QUEUE_SIZE_512k</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_CMDQUEUE_THRESHOLD</span><span class="p">,</span> <span class="n">COMMAND_QUEUE_THRESHOLD</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_CMDQUEUE_SET</span><span class="p">,</span> <span class="n">SIS_CMD_QUEUE_RESET</span><span class="p">);</span>

		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modechanged</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Must disable dual pipe on XGI_40. Can&#39;t do</span>
<span class="cm">			 * this in MMIO mode, because it requires</span>
<span class="cm">			 * setting/clearing a bit in the MMIO fire trigger</span>
<span class="cm">			 * register.</span>
<span class="cm">			 */</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">templ</span> <span class="o">=</span> <span class="n">MMIO_IN32</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">,</span> <span class="mh">0x8240</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)))</span> <span class="p">{</span>

				<span class="n">MMIO_OUT32</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">,</span> <span class="n">Q_WRITE_PTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_CMDQUEUE_SET</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">SIS_VRAM_CMDQUEUE_ENABLE</span><span class="p">));</span>

				<span class="n">tempq</span> <span class="o">=</span> <span class="n">MMIO_IN32</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">,</span> <span class="n">Q_READ_PTR</span><span class="p">);</span>
				<span class="n">MMIO_OUT32</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">,</span> <span class="n">Q_WRITE_PTR</span><span class="p">,</span> <span class="n">tempq</span><span class="p">);</span>

				<span class="n">tempq</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">-</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span><span class="p">);</span>
				<span class="n">MMIO_OUT32</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">,</span> <span class="n">Q_BASE_ADDR</span><span class="p">,</span> <span class="n">tempq</span><span class="p">);</span>

				<span class="n">writel</span><span class="p">(</span><span class="mh">0x16800000</span> <span class="o">+</span> <span class="mh">0x8240</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">+</span> <span class="n">tempq</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">templ</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">+</span> <span class="n">tempq</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="mh">0x168F0000</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">+</span> <span class="n">tempq</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="mh">0x168F0000</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">+</span> <span class="n">tempq</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

				<span class="n">MMIO_OUT32</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">,</span> <span class="n">Q_WRITE_PTR</span><span class="p">,</span> <span class="p">(</span><span class="n">tempq</span> <span class="o">+</span> <span class="mi">16</span><span class="p">));</span>

				<span class="n">sisfb_syncaccel</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_CMDQUEUE_SET</span><span class="p">,</span> <span class="n">SIS_CMD_QUEUE_RESET</span><span class="p">);</span>

			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">tempq</span> <span class="o">=</span> <span class="n">MMIO_IN32</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">,</span> <span class="n">MMIO_QUEUE_READPORT</span><span class="p">);</span>
		<span class="n">MMIO_OUT32</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">,</span> <span class="n">MMIO_QUEUE_WRITEPORT</span><span class="p">,</span> <span class="n">tempq</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SIS_MMIO_CMD_ENABLE</span> <span class="o">|</span> <span class="n">SIS_CMD_AUTO_CORR</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_CMDQUEUE_SET</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="n">tempq</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">-</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span><span class="p">);</span>
		<span class="n">MMIO_OUT32</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">,</span> <span class="n">MMIO_QUEUE_PHYBASE</span><span class="p">,</span> <span class="n">tempq</span><span class="p">);</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMIO_CMD_QUEUE_CAP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">engineok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_detect_lcd_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2LCDType</span> <span class="o">=</span> <span class="n">sis300paneltype</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2LCDType</span> <span class="o">=</span> <span class="n">sis661paneltype</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2LCDType</span> <span class="o">=</span> <span class="n">sis310paneltype</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">SIS_550</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sisfb_fstn</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2LCDType</span> <span class="o">!=</span> <span class="n">LCD_320x240_2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2LCDType</span> <span class="o">!=</span> <span class="n">LCD_320x240_3</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2LCDType</span> <span class="o">=</span> <span class="n">LCD_320x240</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2LCDType</span> <span class="o">==</span> <span class="n">LCD_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For broken BIOSes: Assume 1024x768, RGB18 */</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2LCDType</span> <span class="o">=</span> <span class="n">LCD_1024x768</span><span class="p">;</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: Invalid panel ID (%02x), assuming 1024x768, RGB18</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIS_LCD_NUMBER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2LCDType</span> <span class="o">==</span> <span class="n">sis_lcd_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lcdtype</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdxres</span> <span class="o">=</span> <span class="n">sis_lcd_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xres</span><span class="p">;</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdyres</span> <span class="o">=</span> <span class="n">sis_lcd_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">yres</span><span class="p">;</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcddefmodeidx</span> <span class="o">=</span> <span class="n">sis_lcd_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_mode_idx</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_CustomT</span> <span class="o">==</span> <span class="n">CUT_BARCO1366</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdxres</span> <span class="o">=</span> <span class="mi">1360</span><span class="p">;</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdyres</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcddefmodeidx</span> <span class="o">=</span> <span class="n">DEFAULT_MODE_1360</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_CustomT</span> <span class="o">==</span> <span class="n">CUT_PANEL848</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdxres</span> <span class="o">=</span>  <span class="mi">848</span><span class="p">;</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdyres</span> <span class="o">=</span>  <span class="mi">480</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcddefmodeidx</span> <span class="o">=</span> <span class="n">DEFAULT_MODE_848</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_CustomT</span> <span class="o">==</span> <span class="n">CUT_PANEL856</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdxres</span> <span class="o">=</span>  <span class="mi">856</span><span class="p">;</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdyres</span> <span class="o">=</span>  <span class="mi">480</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcddefmodeidx</span> <span class="o">=</span> <span class="n">DEFAULT_MODE_856</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: Detected %dx%d flat panel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdxres</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcdyres</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_save_pdc_emi</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
	<span class="cm">/* Save the current PanelDelayCompensation if the LCD is currently used */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VB2_LVDS</span> <span class="o">|</span> <span class="n">VB2_30xBDH</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Currently on LCD? If yes, read current pdc */</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span> <span class="o">&amp;=</span> <span class="mh">0x3c</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Let option override detection */</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Detected LCD PDC 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span> <span class="o">!=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Using LCD PDC 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Try to find about LCDA */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISLCDABRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_UseLCDA</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedlcda</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Save PDC */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISLVDSBRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedlcda</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Currently on LCD? If yes, read current pdc */</span>
				<span class="n">u8</span> <span class="n">pdc</span><span class="p">;</span>
				<span class="n">pdc</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span>  <span class="o">=</span> <span class="p">(</span><span class="n">pdc</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdca</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdc</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">pdc</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span> <span class="o">|=</span> <span class="p">((</span><span class="n">pdc</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
				<span class="n">pdc</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdca</span> <span class="o">|=</span> <span class="p">((</span><span class="n">pdc</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">newrom</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* New ROM invalidates other PDC resp. */</span>
					<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedlcda</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdca</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDCA</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdca</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDCA</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdca</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
						<span class="s">&quot;sisfb: Detected LCD PDC 0x%02x (for LCD=CRT2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdca</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
						<span class="s">&quot;sisfb: Detected LCD PDC1 0x%02x (for LCD=CRT1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdca</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Save EMI */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISEMIBRIDGE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">EMI_30</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">EMI_31</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">EMI_32</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">EMI_33</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">HaveEMI</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">if</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedlcda</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">HaveEMILCD</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Let user override detected PDCs (all bridges) */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_30xBLV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span> <span class="o">!=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Using LCD PDC 0x%02x (for LCD=CRT2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDCA</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDCA</span> <span class="o">!=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdca</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Using LCD PDC1 0x%02x (for LCD=CRT1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDCA</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* -------------------- Memory manager routines ---------------------- */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">__devinit</span>
<span class="nf">sisfb_getheapstart</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_mem</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">maxoffs</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">-</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">hwcursor_size</span> <span class="o">-</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">def</span><span class="p">;</span>

	<span class="cm">/* Calculate heap start = end of memory for console</span>
<span class="cm">	 *</span>
<span class="cm">	 * CCCCCCCCDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHHHQQQQQQQQQQ</span>
<span class="cm">	 * C = console, D = heap, H = HWCursor, Q = cmd-queue</span>
<span class="cm">	 *</span>
<span class="cm">	 * On 76x in UMA+LFB mode, the layout is as follows:</span>
<span class="cm">	 * DDDDDDDDDDDCCCCCCCCCCCCCCCCCCCCCCCCHHHHQQQQQQQQQQQ</span>
<span class="cm">	 * where the heap is the entire UMA area, eventually</span>
<span class="cm">	 * into the LFB area if the given mem parameter is</span>
<span class="cm">	 * higher than the size of the UMA memory.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Basically given by &quot;mem&quot; parameter</span>
<span class="cm">	 *</span>
<span class="cm">	 * maximum = videosize - cmd_queue - hwcursor</span>
<span class="cm">	 *           (results in a heap of size 0)</span>
<span class="cm">	 * default = SiS 300: depends on videosize</span>
<span class="cm">	 *           SiS 315/330/340/XGI: 32k below max</span>
<span class="cm">	 */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">&gt;</span> <span class="mh">0x1000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">def</span> <span class="o">=</span> <span class="mh">0xc00000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">&gt;</span> <span class="mh">0x800000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">def</span> <span class="o">=</span> <span class="mh">0x800000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">def</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">UMAsize</span> <span class="o">&amp;&amp;</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">LFBsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">def</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">def</span> <span class="o">=</span> <span class="n">maxoffs</span> <span class="o">-</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use default for secondary card for now (FIXME) */</span>
	<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">maxoffs</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cardnumber</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">def</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">__devinit</span>
<span class="nf">sisfb_getheapsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">max</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">-</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">hwcursor_size</span> <span class="o">-</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">UMAsize</span> <span class="o">&amp;&amp;</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">LFBsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_mem</span><span class="p">)</span>			<span class="o">||</span>
		    <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_mem</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>	<span class="o">||</span>
		    <span class="p">((</span><span class="n">max</span> <span class="o">-</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_mem</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">UMAsize</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">UMAsize</span><span class="p">;</span>
			<span class="n">max</span> <span class="o">-=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">UMAsize</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">max</span> <span class="o">-</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_mem</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_mem</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_offset</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mem</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">max</span> <span class="o">-</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">heapstart</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mem</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">heapstart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">sisfb_heap_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">poh</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_mem</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_mem</span> <span class="o">&gt;</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_mem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">heapstart</span> <span class="o">=</span> <span class="n">sisfb_getheapstart</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap_size</span> <span class="o">=</span> <span class="n">sisfb_getheapsize</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap_start</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">+</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">heapstart</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap_end</span>   <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap_start</span> <span class="o">+</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap_size</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Memory heap starting at %dK, size %dK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">heapstart</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">));</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">vinfo</span> <span class="o">=</span> <span class="n">ivideo</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">poha_chain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">poh_freelist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">poh</span> <span class="o">=</span> <span class="n">sisfb_poh_new_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">poh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">oh_free</span><span class="p">;</span>
	<span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">oh_free</span><span class="p">;</span>
	<span class="n">poh</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap_size</span><span class="p">;</span>
	<span class="n">poh</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">heapstart</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">oh_free</span><span class="p">.</span><span class="n">poh_next</span> <span class="o">=</span> <span class="n">poh</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">oh_free</span><span class="p">.</span><span class="n">poh_prev</span> <span class="o">=</span> <span class="n">poh</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">oh_free</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">max_freesize</span> <span class="o">=</span> <span class="n">poh</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">oh_used</span><span class="p">.</span><span class="n">poh_next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">oh_used</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">oh_used</span><span class="p">.</span><span class="n">poh_prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">oh_used</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">.</span><span class="n">oh_used</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">SENTINEL</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cardnumber</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For the first card, make this heap the &quot;global&quot; one</span>
<span class="cm">		 * for old DRM (which could handle only one card)</span>
<span class="cm">		 */</span>
		<span class="n">sisfb_heap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span>
<span class="nf">sisfb_poh_new_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">SIS_HEAP</span> <span class="o">*</span><span class="n">memheap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">SIS_OHALLOC</span>	<span class="o">*</span><span class="n">poha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SIS_OH</span>		<span class="o">*</span><span class="n">poh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">cOhs</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">memheap</span><span class="o">-&gt;</span><span class="n">poh_freelist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">poha</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SIS_OH_ALLOC_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">poha</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">poha</span><span class="o">-&gt;</span><span class="n">poha_next</span> <span class="o">=</span> <span class="n">memheap</span><span class="o">-&gt;</span><span class="n">poha_chain</span><span class="p">;</span>
		<span class="n">memheap</span><span class="o">-&gt;</span><span class="n">poha_chain</span> <span class="o">=</span> <span class="n">poha</span><span class="p">;</span>

		<span class="n">cOhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">SIS_OH_ALLOC_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">SIS_OHALLOC</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">SIS_OH</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">poh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">poha</span><span class="o">-&gt;</span><span class="n">aoh</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">cOhs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_next</span> <span class="o">=</span> <span class="n">poh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">poh</span> <span class="o">=</span> <span class="n">poh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">memheap</span><span class="o">-&gt;</span><span class="n">poh_freelist</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">poha</span><span class="o">-&gt;</span><span class="n">aoh</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">poh</span> <span class="o">=</span> <span class="n">memheap</span><span class="o">-&gt;</span><span class="n">poh_freelist</span><span class="p">;</span>
	<span class="n">memheap</span><span class="o">-&gt;</span><span class="n">poh_freelist</span> <span class="o">=</span> <span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_next</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">poh</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span>
<span class="nf">sisfb_poh_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">SIS_HEAP</span> <span class="o">*</span><span class="n">memheap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">SIS_OH</span>	<span class="o">*</span><span class="n">pohThis</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SIS_OH</span>	<span class="o">*</span><span class="n">pohRoot</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">bAllocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">memheap</span><span class="o">-&gt;</span><span class="n">max_freesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;sisfb: Can&#39;t allocate %dk video memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pohThis</span> <span class="o">=</span> <span class="n">memheap</span><span class="o">-&gt;</span><span class="n">oh_free</span><span class="p">.</span><span class="n">poh_next</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">pohThis</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">memheap</span><span class="o">-&gt;</span><span class="n">oh_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">pohThis</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bAllocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pohThis</span> <span class="o">=</span> <span class="n">pohThis</span><span class="o">-&gt;</span><span class="n">poh_next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bAllocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;sisfb: Can&#39;t allocate %dk video memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">pohThis</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pohRoot</span> <span class="o">=</span> <span class="n">pohThis</span><span class="p">;</span>
		<span class="n">sisfb_delete_node</span><span class="p">(</span><span class="n">pohThis</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pohRoot</span> <span class="o">=</span> <span class="n">sisfb_poh_new_node</span><span class="p">(</span><span class="n">memheap</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pohRoot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">pohRoot</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">pohThis</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">pohRoot</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">pohThis</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">pohThis</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memheap</span><span class="o">-&gt;</span><span class="n">max_freesize</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">pohThis</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">memheap</span><span class="o">-&gt;</span><span class="n">oh_used</span><span class="p">;</span>
	<span class="n">sisfb_insert_node</span><span class="p">(</span><span class="n">pohThis</span><span class="p">,</span> <span class="n">pohRoot</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pohRoot</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_delete_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">poh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_prev</span><span class="o">-&gt;</span><span class="n">poh_next</span> <span class="o">=</span> <span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_next</span><span class="p">;</span>
	<span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_next</span><span class="o">-&gt;</span><span class="n">poh_prev</span> <span class="o">=</span> <span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_prev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_insert_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">pohList</span><span class="p">,</span> <span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">poh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">pohTemp</span> <span class="o">=</span> <span class="n">pohList</span><span class="o">-&gt;</span><span class="n">poh_next</span><span class="p">;</span>

	<span class="n">pohList</span><span class="o">-&gt;</span><span class="n">poh_next</span> <span class="o">=</span> <span class="n">poh</span><span class="p">;</span>
	<span class="n">pohTemp</span><span class="o">-&gt;</span><span class="n">poh_prev</span> <span class="o">=</span> <span class="n">poh</span><span class="p">;</span>

	<span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_prev</span> <span class="o">=</span> <span class="n">pohList</span><span class="p">;</span>
	<span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_next</span> <span class="o">=</span> <span class="n">pohTemp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span>
<span class="nf">sisfb_poh_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">SIS_HEAP</span> <span class="o">*</span><span class="n">memheap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">pohThis</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">poh_freed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">poh_prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">poh_next</span><span class="p">;</span>
	<span class="n">u32</span>    <span class="n">ulUpper</span><span class="p">;</span>
	<span class="n">u32</span>    <span class="n">ulLower</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">foundNode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">poh_freed</span> <span class="o">=</span> <span class="n">memheap</span><span class="o">-&gt;</span><span class="n">oh_used</span><span class="p">.</span><span class="n">poh_next</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">poh_freed</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">memheap</span><span class="o">-&gt;</span><span class="n">oh_used</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">poh_freed</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="n">base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">foundNode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">poh_freed</span> <span class="o">=</span> <span class="n">poh_freed</span><span class="o">-&gt;</span><span class="n">poh_next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">foundNode</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memheap</span><span class="o">-&gt;</span><span class="n">max_freesize</span> <span class="o">+=</span> <span class="n">poh_freed</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="n">poh_prev</span> <span class="o">=</span> <span class="n">poh_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ulUpper</span> <span class="o">=</span> <span class="n">poh_freed</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">poh_freed</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">ulLower</span> <span class="o">=</span> <span class="n">poh_freed</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">pohThis</span> <span class="o">=</span> <span class="n">memheap</span><span class="o">-&gt;</span><span class="n">oh_free</span><span class="p">.</span><span class="n">poh_next</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">pohThis</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">memheap</span><span class="o">-&gt;</span><span class="n">oh_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pohThis</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="n">ulUpper</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">poh_next</span> <span class="o">=</span> <span class="n">pohThis</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">pohThis</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">pohThis</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="n">ulLower</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">poh_prev</span> <span class="o">=</span> <span class="n">pohThis</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pohThis</span> <span class="o">=</span> <span class="n">pohThis</span><span class="o">-&gt;</span><span class="n">poh_next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sisfb_delete_node</span><span class="p">(</span><span class="n">poh_freed</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">poh_prev</span> <span class="o">&amp;&amp;</span> <span class="n">poh_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">poh_prev</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+=</span> <span class="p">(</span><span class="n">poh_freed</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">poh_next</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">sisfb_delete_node</span><span class="p">(</span><span class="n">poh_next</span><span class="p">);</span>
		<span class="n">sisfb_free_node</span><span class="p">(</span><span class="n">memheap</span><span class="p">,</span> <span class="n">poh_freed</span><span class="p">);</span>
		<span class="n">sisfb_free_node</span><span class="p">(</span><span class="n">memheap</span><span class="p">,</span> <span class="n">poh_next</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">poh_prev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">poh_prev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">poh_prev</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+=</span> <span class="n">poh_freed</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">sisfb_free_node</span><span class="p">(</span><span class="n">memheap</span><span class="p">,</span> <span class="n">poh_freed</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">poh_prev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">poh_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">poh_next</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+=</span> <span class="n">poh_freed</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">poh_next</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">poh_freed</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">sisfb_free_node</span><span class="p">(</span><span class="n">memheap</span><span class="p">,</span> <span class="n">poh_freed</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">poh_next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sisfb_insert_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memheap</span><span class="o">-&gt;</span><span class="n">oh_free</span><span class="p">,</span> <span class="n">poh_freed</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">poh_freed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_free_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">SIS_HEAP</span> <span class="o">*</span><span class="n">memheap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">poh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">poh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">poh</span><span class="o">-&gt;</span><span class="n">poh_next</span> <span class="o">=</span> <span class="n">memheap</span><span class="o">-&gt;</span><span class="n">poh_freelist</span><span class="p">;</span>
	<span class="n">memheap</span><span class="o">-&gt;</span><span class="n">poh_freelist</span> <span class="o">=</span> <span class="n">poh</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sis_int_malloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sis_memreq</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">poh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_id</span> <span class="o">==</span> <span class="n">SISFB_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">havenoheap</span><span class="p">))</span>
		<span class="n">poh</span> <span class="o">=</span> <span class="n">sisfb_poh_allocate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">poh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;sisfb: Video RAM allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">poh</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">poh</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;sisfb: Video RAM allocation succeeded: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">poh</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">sis_malloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_memreq</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="n">sisfb_heap</span><span class="o">-&gt;</span><span class="n">vinfo</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span> <span class="o">==</span> <span class="n">sisfb_heap</span><span class="p">)</span>
		<span class="n">sis_int_malloc</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">sis_malloc_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sis_memreq</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">sis_int_malloc</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sis_free: u32 because &quot;base&quot; is offset inside video ram, can never be &gt;4GB */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sis_int_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">SIS_OH</span> <span class="o">*</span><span class="n">poh</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="n">ivideo</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_id</span> <span class="o">!=</span> <span class="n">SISFB_ID</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">havenoheap</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">poh</span> <span class="o">=</span> <span class="n">sisfb_poh_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_heap</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">poh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;sisfb: sisfb_poh_free() failed at base 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">sis_free</span><span class="p">(</span><span class="n">u32</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="n">sisfb_heap</span><span class="o">-&gt;</span><span class="n">vinfo</span><span class="p">;</span>

	<span class="n">sis_int_free</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">sis_free_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">sis_int_free</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------- SetMode routines ------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_check_engine_and_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cr30</span><span class="p">,</span> <span class="n">cr31</span><span class="p">;</span>

	<span class="cm">/* Check if MMIO and engines are enabled,</span>
<span class="cm">	 * and sync in case they are. Can&#39;t use</span>
<span class="cm">	 * ivideo-&gt;accel here, as this might have</span>
<span class="cm">	 * been changed before this is called.</span>
<span class="cm">	 */</span>
	<span class="n">cr30</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_PCI_ADDRESS_SET</span><span class="p">);</span>
	<span class="n">cr31</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_MODULE_ENABLE</span><span class="p">);</span>
	<span class="cm">/* MMIO and 2D/3D engine enabled? */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">cr30</span> <span class="o">&amp;</span> <span class="n">SIS_MEM_MAP_IO_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cr31</span> <span class="o">&amp;</span> <span class="mh">0x42</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Don&#39;t care about TurboQueue. It&#39;s</span>
<span class="cm">			 * enough to know that the engines</span>
<span class="cm">			 * are enabled</span>
<span class="cm">			 */</span>
			<span class="n">sisfb_syncaccel</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check that any queue mode is</span>
<span class="cm">			 * enabled, and that the queue</span>
<span class="cm">			 * is not in the state of &quot;reset&quot;</span>
<span class="cm">			 */</span>
			<span class="n">cr30</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">cr30</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cr30</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">sisfb_syncaccel</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_pre_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cr30</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cr31</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cr33</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cr35</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cr38</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tvregnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">VB_VIDEOBRIDGE</span> <span class="o">|</span> <span class="n">VB_DISPTYPE_DISP2</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>

	<span class="n">cr31</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
	<span class="n">cr31</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x60</span><span class="p">;</span>
	<span class="n">cr31</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>

	<span class="n">cr33</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
	   <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
	      <span class="n">cr38</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
	      <span class="n">cr38</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">;</span>  <span class="cm">/* Clear LCDA/DualEdge and YPbPr bits */</span>
	   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="n">tvregnum</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
	      <span class="n">cr38</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">tvregnum</span><span class="p">);</span>
	      <span class="n">cr38</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3b</span><span class="p">;</span>  <span class="cm">/* Clear LCDA/DualEdge and YPbPr bits */</span>
	   <span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
	   <span class="n">tvregnum</span> <span class="o">=</span> <span class="mh">0x35</span><span class="p">;</span>
	   <span class="n">cr38</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">tvregnum</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">SiS_SetEnableDstn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">SiS_SetEnableFstn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curFSTN</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curDSTN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_DISP2</span><span class="p">)</span> <span class="p">{</span>

	   <span class="k">case</span> <span class="n">CRT2_TV</span>:
	      <span class="n">cr38</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xc0</span><span class="p">;</span>   <span class="cm">/* Clear PAL-M / PAL-N bits */</span>
	      <span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISYPBPRBRIDGE</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">cr38</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR525P</span><span class="p">)</span>       <span class="n">cr35</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
		    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR750P</span><span class="p">)</span>  <span class="n">cr35</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR1080I</span><span class="p">)</span> <span class="n">cr35</span> <span class="o">|=</span> <span class="mh">0x60</span><span class="p">;</span>
		    <span class="n">cr30</span> <span class="o">|=</span> <span class="n">SIS_SIMULTANEOUS_VIEW_ENABLE</span><span class="p">;</span>
		    <span class="n">cr35</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
		    <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TV_YPBPR</span> <span class="o">|</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPRALL</span><span class="p">));</span>
		 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">cr30</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">SIS_SIMULTANEOUS_VIEW_ENABLE</span><span class="p">);</span>
		    <span class="n">cr38</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR525P</span><span class="p">)</span>       <span class="n">cr38</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR750P</span><span class="p">)</span>  <span class="n">cr38</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
		    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPR1080I</span><span class="p">)</span> <span class="n">cr38</span> <span class="o">|=</span> <span class="mh">0x30</span><span class="p">;</span>
		    <span class="n">cr31</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
		    <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TV_YPBPR</span> <span class="o">|</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_YPBPRALL</span><span class="p">));</span>
		 <span class="p">}</span>
<span class="cp">#endif</span>
	      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_HIVISION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISHIVISIONBRIDGE</span><span class="p">))</span> <span class="p">{</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">cr38</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		    <span class="n">cr35</span> <span class="o">|=</span> <span class="mh">0x60</span><span class="p">;</span>
		 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">cr30</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		 <span class="p">}</span>
		 <span class="n">cr30</span> <span class="o">|=</span> <span class="n">SIS_SIMULTANEOUS_VIEW_ENABLE</span><span class="p">;</span>
		 <span class="n">cr31</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		 <span class="n">cr35</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		 <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">TV_HIVISION</span><span class="p">;</span>
	      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_SCART</span><span class="p">)</span> <span class="p">{</span>
		 <span class="n">cr30</span> <span class="o">=</span> <span class="p">(</span><span class="n">SIS_VB_OUTPUT_SCART</span> <span class="o">|</span> <span class="n">SIS_SIMULTANEOUS_VIEW_ENABLE</span><span class="p">);</span>
		 <span class="n">cr31</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		 <span class="n">cr35</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		 <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">TV_SCART</span><span class="p">;</span>
	      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_SVIDEO</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">cr30</span> <span class="o">=</span> <span class="p">(</span><span class="n">SIS_VB_OUTPUT_SVIDEO</span> <span class="o">|</span> <span class="n">SIS_SIMULTANEOUS_VIEW_ENABLE</span><span class="p">);</span>
		    <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">TV_SVIDEO</span><span class="p">;</span>
		 <span class="p">}</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_AVIDEO</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">cr30</span> <span class="o">=</span> <span class="p">(</span><span class="n">SIS_VB_OUTPUT_COMPOSITE</span> <span class="o">|</span> <span class="n">SIS_SIMULTANEOUS_VIEW_ENABLE</span><span class="p">);</span>
		    <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">TV_AVIDEO</span><span class="p">;</span>
		 <span class="p">}</span>
	      <span class="p">}</span>
	      <span class="n">cr31</span> <span class="o">|=</span> <span class="n">SIS_DRIVER_MODE</span><span class="p">;</span>

	      <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_AVIDEO</span> <span class="o">|</span> <span class="n">TV_SVIDEO</span><span class="p">))</span> <span class="p">{</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_PAL</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">cr31</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="n">cr35</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		    <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">TV_PAL</span><span class="p">;</span>
		    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_PALM</span><span class="p">)</span> <span class="p">{</span>
		       <span class="n">cr38</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">cr35</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		       <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">TV_PALM</span><span class="p">;</span>
		    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_PALN</span><span class="p">)</span> <span class="p">{</span>
		       <span class="n">cr38</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">cr35</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		       <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">TV_PALN</span><span class="p">;</span>
		    <span class="p">}</span>
		 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">cr31</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span> <span class="n">cr35</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
		    <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">TV_NTSC</span><span class="p">;</span>
		    <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">TV_NTSCJ</span><span class="p">)</span> <span class="p">{</span>
		       <span class="n">cr38</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">cr35</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		       <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">TV_NTSCJ</span><span class="p">;</span>
		    <span class="p">}</span>
		 <span class="p">}</span>
	      <span class="p">}</span>
	      <span class="k">break</span><span class="p">;</span>

	   <span class="k">case</span> <span class="n">CRT2_LCD</span>:
	      <span class="n">cr30</span>  <span class="o">=</span> <span class="p">(</span><span class="n">SIS_VB_OUTPUT_LCD</span> <span class="o">|</span> <span class="n">SIS_SIMULTANEOUS_VIEW_ENABLE</span><span class="p">);</span>
	      <span class="n">cr31</span> <span class="o">|=</span> <span class="n">SIS_DRIVER_MODE</span><span class="p">;</span>
	      <span class="n">SiS_SetEnableDstn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_dstn</span><span class="p">);</span>
	      <span class="n">SiS_SetEnableFstn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_fstn</span><span class="p">);</span>
	      <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curFSTN</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_fstn</span><span class="p">;</span>
	      <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curDSTN</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_dstn</span><span class="p">;</span>
	      <span class="k">break</span><span class="p">;</span>

	   <span class="k">case</span> <span class="n">CRT2_VGA</span>:
	      <span class="n">cr30</span> <span class="o">=</span> <span class="p">(</span><span class="n">SIS_VB_OUTPUT_CRT2</span> <span class="o">|</span> <span class="n">SIS_SIMULTANEOUS_VIEW_ENABLE</span><span class="p">);</span>
	      <span class="n">cr31</span> <span class="o">|=</span> <span class="n">SIS_DRIVER_MODE</span><span class="p">;</span>
	      <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_nocrt2rate</span><span class="p">)</span> <span class="p">{</span>
		 <span class="n">cr33</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">rate_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="n">cr33</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	      <span class="p">}</span>
	      <span class="k">break</span><span class="p">;</span>

	   <span class="nl">default:</span>	<span class="cm">/* disable CRT2 */</span>
	      <span class="n">cr30</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	      <span class="n">cr31</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SIS_DRIVER_MODE</span> <span class="o">|</span> <span class="n">SIS_VB_OUTPUT_DISABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">cr30</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="n">cr33</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	   <span class="n">cr31</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>                          <span class="cm">/* Clear PAL flag (now in CR35) */</span>
	   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">cr35</span><span class="p">);</span> <span class="cm">/* Leave overscan bit alone */</span>
	   <span class="n">cr38</span> <span class="o">&amp;=</span> <span class="mh">0x07</span><span class="p">;</span>                           <span class="cm">/* Use only LCDA and HiVision/YPbPr bits */</span>
	   <span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="n">cr38</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="n">SIS_300</span><span class="p">)</span> <span class="p">{</span>
	   <span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">tvregnum</span><span class="p">,</span> <span class="n">cr38</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="n">cr31</span><span class="p">);</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_UseOEM</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_useoem</span><span class="p">;</span>

	<span class="n">sisfb_check_engine_and_sync</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Fix SR11 for 661 and later */</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_fixup_SR11</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>  <span class="n">tmpreg</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmpreg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">tmpreg</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmpreg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">);</span>
			<span class="n">tmpreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmpreg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="n">tmpreg</span><span class="p">);</span>
			<span class="n">tmpreg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">tmpreg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_set_TVxposoffset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">32</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvxpos</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfblocked</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modechanged</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_TV</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">)</span> <span class="p">{</span>

			<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvx</span><span class="p">;</span>

			<span class="k">switch</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chronteltype</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">x</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
				<span class="n">SiS_SetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
				<span class="n">SiS_SetCH70xxANDOR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">),</span> <span class="mh">0xFD</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="cm">/* Not supported by hardware */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISBRIDGE</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">u8</span> <span class="n">p2_1f</span><span class="p">,</span><span class="n">p2_20</span><span class="p">,</span><span class="n">p2_2b</span><span class="p">,</span><span class="n">p2_42</span><span class="p">,</span><span class="n">p2_43</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">;</span>

			<span class="n">p2_1f</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_1f</span><span class="p">;</span>
			<span class="n">p2_20</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_20</span><span class="p">;</span>
			<span class="n">p2_2b</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_2b</span><span class="p">;</span>
			<span class="n">p2_42</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_42</span><span class="p">;</span>
			<span class="n">p2_43</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_43</span><span class="p">;</span>

			<span class="n">temp</span> <span class="o">=</span> <span class="n">p2_1f</span> <span class="o">|</span> <span class="p">((</span><span class="n">p2_20</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">p2_1f</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">p2_20</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">p2_2b</span> <span class="o">=</span> <span class="p">((</span><span class="n">p2_2b</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">p2_43</span> <span class="o">|</span> <span class="p">((</span><span class="n">p2_42</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">p2_43</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">p2_42</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">p2_1f</span><span class="p">);</span>
			<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="n">p2_20</span><span class="p">);</span>
			<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="n">p2_2b</span><span class="p">);</span>
			<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="n">p2_42</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">p2_43</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_set_TVyposoffset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">32</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvypos</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfblocked</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modechanged</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_TV</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">)</span> <span class="p">{</span>

			<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvy</span><span class="p">;</span>

			<span class="k">switch</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chronteltype</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">y</span> <span class="o">-=</span> <span class="n">val</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
				<span class="n">SiS_SetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
				<span class="n">SiS_SetCH70xxANDOR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="p">((</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="mh">0xFE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="cm">/* Not supported by hardware */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISBRIDGE</span><span class="p">)</span> <span class="p">{</span>

			<span class="kt">char</span> <span class="n">p2_01</span><span class="p">,</span> <span class="n">p2_02</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">p2_01</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_01</span><span class="p">;</span>
			<span class="n">p2_02</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_02</span><span class="p">;</span>

			<span class="n">p2_01</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">p2_02</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TV_HIVISION</span> <span class="o">|</span> <span class="n">TV_YPBPR</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">while</span><span class="p">((</span><span class="n">p2_01</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">p2_02</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">p2_01</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">p2_02</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">p2_01</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">p2_02</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_post_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">crt1isoff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">doit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_FB_SIS_300) || defined(CONFIG_FB_SIS_315)</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="n">u8</span> <span class="n">reg1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="n">sisfb_fixup_SR11</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Now we actually HAVE changed the display mode */</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modechanged</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* We can&#39;t switch off CRT1 if bridge is in slave mode */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_VIDEOBRIDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">sisfb_bridgeisslave</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span> <span class="n">doit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">doit</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">crt1isoff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">crt1isoff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">doit</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">crt1isoff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">reg</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">reg1</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">crt1isoff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">reg</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">reg1</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_MyCR63</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">reg1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span><span class="p">(</span><span class="n">crt1isoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VB_DISPTYPE_CRT1</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">VB_SINGLE_MODE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">VB_DISPTYPE_CRT1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_CRT2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">VB_MIRROR_MODE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">VB_SINGLE_MODE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_RAMDAC_CONTROL</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_TV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISBRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_1f</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_20</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_2b</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">);</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_42</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_43</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_01</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">p2_02</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chronteltype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvx</span> <span class="o">=</span> <span class="n">SiS_GetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvx</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">SiS_GetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvy</span> <span class="o">=</span> <span class="n">SiS_GetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvy</span> <span class="o">|=</span> <span class="p">((</span><span class="n">SiS_GetCH700x</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvxpos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sisfb_set_TVxposoffset</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvxpos</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvypos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sisfb_set_TVyposoffset</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvypos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Eventually sync engines */</span>
	<span class="n">sisfb_check_engine_and_sync</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

	<span class="cm">/* (Re-)Initialize chip engines */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">accel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sisfb_engine_init</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">engineok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisfb_reset_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">sisfb_set_mode</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sisfb_set_pitch</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
	<span class="n">sisfb_set_base_CRT1</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_base</span><span class="p">);</span>
	<span class="n">sisfb_set_base_CRT2</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_base</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisfb_handle_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sisfb_cmd</span> <span class="o">*</span><span class="n">sisfb_command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mycrt1off</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SISFB_CMD_GETVBFLAGS</span>:
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modechanged</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SISFB_CMD_ERR_EARLY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SISFB_CMD_ERR_OK</span><span class="p">;</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span><span class="p">;</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SISFB_CMD_SWITCHCRT1</span>:
		<span class="cm">/* arg[0]: 0 = off, 1 = on, 99 = query */</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modechanged</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SISFB_CMD_ERR_EARLY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">99</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Query */</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SISFB_CMD_ERR_OK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfblocked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SISFB_CMD_ERR_LOCKED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_ENABLE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SISFB_CMD_ERR_NOCRT2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SISFB_CMD_ERR_OK</span><span class="p">;</span>
			<span class="n">mycrt1off</span> <span class="o">=</span> <span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span> <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_CRT1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mycrt1off</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_CRT1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mycrt1off</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span> <span class="o">=</span> <span class="n">mycrt1off</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisfb_reset_mode</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SISFB_CMD_ERR_OTHER</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* more to come */</span>
	<span class="nl">default:</span>
		<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SISFB_CMD_ERR_UNKNOWN</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Unknown command 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sisfb_command</span><span class="o">-&gt;</span><span class="n">sisfb_cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sisfb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="n">sisfb_setdefaultparms</span><span class="p">();</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span><span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">this_opt</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;forcecrt2type:&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Need to check crt2 type first for fstn/dstn */</span>
			<span class="n">sisfb_search_crt2type</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;tvmode:&quot;</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_search_tvstd</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;tvstandard:&quot;</span><span class="p">,</span><span class="mi">11</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_search_tvstd</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">11</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mode:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_search_mode</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vesa:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_search_vesamode</span><span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;rate:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_parm_rate</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;forcecrt1:&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_forcecrt1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mem:&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_parm_mem</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;pdc:&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_pdc</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;pdc1:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_pdca</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;noaccel&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_accel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;accel&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_accel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;noypan&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_ypan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;ypan&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_ypan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nomax&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;max&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;userom:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_userom</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;useoem:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_useoem</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nocrt2rate&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_nocrt2rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;scalelcd:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			   <span class="n">sisfb_scalelcd</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;tvxposoffset:&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtol</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">13</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">32</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
			   <span class="n">sisfb_tvxposoffset</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;tvyposoffset:&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtol</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">13</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">32</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
			   <span class="n">sisfb_tvyposoffset</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;specialtiming:&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_search_specialtiming</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;lvdshl:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			   <span class="n">sisfb_lvdshl</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">this_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">this_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sisfb_search_mode</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__x86_64__)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;resetcard&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_resetcard</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;videoram:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_videoram</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Invalid option %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">this_opt</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">sisfb_check_rom</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rom_base</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">romptr</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="n">rom_base</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">rom_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xaa</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">romptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">rom_base</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">rom_base</span> <span class="o">+</span> <span class="mh">0x19</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="n">romptr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mh">0x10000</span> <span class="o">-</span> <span class="mi">8</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rom</span> <span class="o">=</span> <span class="n">rom_base</span> <span class="o">+</span> <span class="n">romptr</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="n">rom</span><span class="p">)</span>     <span class="o">!=</span> <span class="sc">&#39;P&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">rom</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">rom</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">rom</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;R&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="n">rom</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">rom</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">!=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip_vendor</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="n">rom</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">rom</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">!=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">__devinit</span>
<span class="nf">sisfb_find_rom</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rom_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">myrombase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">romsize</span><span class="p">;</span>

	<span class="cm">/* First, try the official pci ROM functions (except</span>
<span class="cm">	 * on integrated chipsets which have no ROM).</span>
<span class="cm">	 */</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">((</span><span class="n">rom_base</span> <span class="o">=</span> <span class="n">pci_map_rom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">romsize</span><span class="p">)))</span> <span class="p">{</span>

			<span class="k">if</span><span class="p">(</span><span class="n">sisfb_check_rom</span><span class="p">(</span><span class="n">rom_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="p">))</span> <span class="p">{</span>

				<span class="k">if</span><span class="p">((</span><span class="n">myrombase</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="mi">65536</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">myrombase</span><span class="p">,</span> <span class="n">rom_base</span><span class="p">,</span>
							<span class="p">(</span><span class="n">romsize</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">?</span> <span class="mi">65536</span> <span class="o">:</span> <span class="n">romsize</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rom_base</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">myrombase</span><span class="p">)</span> <span class="k">return</span> <span class="n">myrombase</span><span class="p">;</span>

	<span class="cm">/* Otherwise do it the conventional way. */</span>

<span class="cp">#if defined(__i386__) || defined(__x86_64__)</span>
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="mh">0x000c0000</span><span class="p">;</span> <span class="n">temp</span> <span class="o">&lt;</span> <span class="mh">0x000f0000</span><span class="p">;</span> <span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x00001000</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">rom_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rom_base</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisfb_check_rom</span><span class="p">(</span><span class="n">rom_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">rom_base</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">myrombase</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="mi">65536</span><span class="p">)))</span>
				<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">myrombase</span><span class="p">,</span> <span class="n">rom_base</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>

			<span class="n">iounmap</span><span class="p">(</span><span class="n">rom_base</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">myrombase</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_map_vram</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mapsize</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mapsize</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">min</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_base</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">mapsize</span><span class="p">));</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;sisfb: Unable to map maximum video RAM for size detection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">mapsize</span><span class="p">)</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_base</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">mapsize</span><span class="p">)))))</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="n">mapsize</span><span class="p">)</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">mapsize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">min</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;sisfb: Video RAM size detection limited to %dMB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="o">*</span><span class="n">mapsize</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_300_buswidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">FBAddress</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">);</span>
	<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="mh">0x1234</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">FBAddress</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">FBAddress</span><span class="p">)</span> <span class="o">==</span> <span class="n">temp</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
			<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
			<span class="n">temp</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x01234567L</span><span class="p">,</span> <span class="n">FBAddress</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x456789ABL</span><span class="p">,</span> <span class="p">(</span><span class="n">FBAddress</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x89ABCDEFL</span><span class="p">,</span> <span class="p">(</span><span class="n">FBAddress</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xCDEF0123L</span><span class="p">,</span> <span class="p">(</span><span class="n">FBAddress</span> <span class="o">+</span> <span class="mi">12</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">readl</span><span class="p">((</span><span class="n">FBAddress</span> <span class="o">+</span> <span class="mi">12</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0xCDEF0123L</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* Channel A 128bit */</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">readl</span><span class="p">((</span><span class="n">FBAddress</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0x456789ABL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* Channel B 64bit */</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>			<span class="cm">/* 32bit */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__devinitconst</span> <span class="n">SiS_DRAMType</span><span class="p">[</span><span class="mi">17</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x0A</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x39</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0D</span><span class="p">,</span><span class="mh">0x0A</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x48</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x35</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0D</span><span class="p">,</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x44</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x31</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0D</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x0A</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x34</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x32</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x21</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x30</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0A</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x11</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span><span class="mh">0x0A</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x28</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x24</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0A</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x10</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_300_rwtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iteration</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buswidth</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">PseudoRankCapacity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">PseudoAdrPinCount</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mapsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">FBAddr</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sr14</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">RankCapacity</span><span class="p">,</span> <span class="n">PageCapacity</span><span class="p">,</span> <span class="n">BankNumHigh</span><span class="p">,</span> <span class="n">BankNumMid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">PhysicalAdrOtherPage</span><span class="p">,</span> <span class="n">PhysicalAdrHigh</span><span class="p">,</span> <span class="n">PhysicalAdrHalfPage</span><span class="p">;</span>

	 <span class="k">for</span><span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">SiS_DRAMType</span><span class="p">);</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">RankCapacity</span> <span class="o">=</span> <span class="n">buswidth</span> <span class="o">*</span> <span class="n">SiS_DRAMType</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>

		<span class="k">if</span><span class="p">(</span><span class="n">RankCapacity</span> <span class="o">!=</span> <span class="n">PseudoRankCapacity</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span><span class="p">((</span><span class="n">SiS_DRAMType</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">SiS_DRAMType</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">PseudoAdrPinCount</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">BankNumHigh</span> <span class="o">=</span> <span class="n">RankCapacity</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">iteration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">iteration</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>             <span class="cm">/* Rank No */</span>
			<span class="n">BankNumMid</span>  <span class="o">=</span> <span class="n">RankCapacity</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BankNumMid</span>  <span class="o">=</span> <span class="n">RankCapacity</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">iteration</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">PageCapacity</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SiS_DRAMType</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">buswidth</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">PhysicalAdrHigh</span> <span class="o">=</span> <span class="n">BankNumHigh</span><span class="p">;</span>
		<span class="n">PhysicalAdrHalfPage</span> <span class="o">=</span> <span class="p">(</span><span class="n">PageCapacity</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">PhysicalAdrHigh</span><span class="p">)</span> <span class="o">%</span> <span class="n">PageCapacity</span><span class="p">;</span>
		<span class="n">PhysicalAdrOtherPage</span> <span class="o">=</span> <span class="n">PageCapacity</span> <span class="o">*</span> <span class="n">SiS_DRAMType</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">PhysicalAdrHigh</span><span class="p">;</span>

		<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">);</span> <span class="cm">/* Test */</span>
		<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>  <span class="cm">/* Test */</span>
		<span class="n">sr14</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiS_DRAMType</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">buswidth</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">buswidth</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>      <span class="n">sr14</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">buswidth</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">sr14</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">SiS_DRAMType</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">sr14</span><span class="p">);</span>

		<span class="n">BankNumHigh</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">BankNumMid</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span><span class="p">((</span><span class="n">BankNumHigh</span> <span class="o">+</span> <span class="n">PhysicalAdrHigh</span>      <span class="o">&gt;=</span> <span class="n">mapsize</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">BankNumMid</span>  <span class="o">+</span> <span class="n">PhysicalAdrHigh</span>      <span class="o">&gt;=</span> <span class="n">mapsize</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">BankNumHigh</span> <span class="o">+</span> <span class="n">PhysicalAdrHalfPage</span>  <span class="o">&gt;=</span> <span class="n">mapsize</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">BankNumHigh</span> <span class="o">+</span> <span class="n">PhysicalAdrOtherPage</span> <span class="o">&gt;=</span> <span class="n">mapsize</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Write data */</span>
		<span class="n">writew</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">PhysicalAdrHigh</span><span class="p">),</span>
				<span class="p">(</span><span class="n">FBAddr</span> <span class="o">+</span> <span class="n">BankNumHigh</span> <span class="o">+</span> <span class="n">PhysicalAdrHigh</span><span class="p">));</span>
		<span class="n">writew</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">BankNumMid</span><span class="p">),</span>
				<span class="p">(</span><span class="n">FBAddr</span> <span class="o">+</span> <span class="n">BankNumMid</span>  <span class="o">+</span> <span class="n">PhysicalAdrHigh</span><span class="p">));</span>
		<span class="n">writew</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">PhysicalAdrHalfPage</span><span class="p">),</span>
				<span class="p">(</span><span class="n">FBAddr</span> <span class="o">+</span> <span class="n">BankNumHigh</span> <span class="o">+</span> <span class="n">PhysicalAdrHalfPage</span><span class="p">));</span>
		<span class="n">writew</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">PhysicalAdrOtherPage</span><span class="p">),</span>
				<span class="p">(</span><span class="n">FBAddr</span> <span class="o">+</span> <span class="n">BankNumHigh</span> <span class="o">+</span> <span class="n">PhysicalAdrOtherPage</span><span class="p">));</span>

		<span class="cm">/* Read data */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">FBAddr</span> <span class="o">+</span> <span class="n">BankNumHigh</span> <span class="o">+</span> <span class="n">PhysicalAdrHigh</span><span class="p">)</span> <span class="o">==</span> <span class="n">PhysicalAdrHigh</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_300_ramsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mapsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">buswidth</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">PseudoRankCapacity</span><span class="p">,</span> <span class="n">PseudoAdrPinCount</span><span class="p">;</span>

	<span class="n">buswidth</span> <span class="o">=</span> <span class="n">sisfb_post_300_buswidth</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PseudoRankCapacity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PseudoAdrPinCount</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">-</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">if</span><span class="p">((</span><span class="n">PseudoRankCapacity</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_300_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span>
						<span class="n">j</span><span class="p">,</span>
						<span class="n">buswidth</span><span class="p">,</span>
						<span class="n">PseudoRankCapacity</span><span class="p">,</span>
						<span class="n">PseudoAdrPinCount</span><span class="p">,</span>
						<span class="n">mapsize</span><span class="p">))</span>
					<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_sis300</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bios</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VirtualRomBase</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">reg</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">v4</span><span class="p">,</span> <span class="n">v5</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="n">v8</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">rindex</span><span class="p">,</span> <span class="n">memtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mapsize</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span><span class="p">)</span>
		<span class="n">bios</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">bios</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x52</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memtype</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x52</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memtype</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memtype</span> <span class="o">&amp;=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v3</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">v6</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">&lt;=</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span> <span class="n">v2</span> <span class="o">=</span> <span class="mh">0x42</span><span class="p">;</span>
		<span class="n">v4</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span> <span class="n">v5</span> <span class="o">=</span> <span class="mh">0x42</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">;</span> <span class="n">v2</span> <span class="o">=</span> <span class="mh">0x43</span><span class="p">;</span> <span class="cm">/* Assume 125Mhz MCLK */</span>
		<span class="n">v4</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">;</span> <span class="n">v5</span> <span class="o">=</span> <span class="mh">0x43</span><span class="p">;</span> <span class="cm">/* Assume 125Mhz ECLK */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">bios</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">memtype</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">rindex</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mh">0x54</span><span class="p">;</span>
			<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">rindex</span><span class="o">++</span><span class="p">];</span>
			<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">rindex</span><span class="o">++</span><span class="p">];</span>
			<span class="n">v3</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">rindex</span><span class="o">++</span><span class="p">];</span>
			<span class="n">rindex</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mh">0x7c</span><span class="p">;</span>
			<span class="n">v4</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">rindex</span><span class="o">++</span><span class="p">];</span>
			<span class="n">v5</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">rindex</span><span class="o">++</span><span class="p">];</span>
			<span class="n">v6</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">rindex</span><span class="o">++</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">v5</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">v6</span><span class="p">);</span>

	<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bios</span><span class="p">)</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xa4</span><span class="p">];</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>       <span class="cm">/* DAC speed */</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>     <span class="cm">/* DDC, power save */</span>

	<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="n">v2</span> <span class="o">=</span> <span class="mh">0x43</span><span class="p">;</span> <span class="n">v3</span> <span class="o">=</span> <span class="mh">0x1e</span><span class="p">;</span> <span class="n">v4</span> <span class="o">=</span> <span class="mh">0x2a</span><span class="p">;</span>
	<span class="n">v5</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span> <span class="n">v6</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">v7</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">v8</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bios</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memtype</span> <span class="o">+=</span> <span class="mh">0xa5</span><span class="p">;</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">memtype</span><span class="p">];</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">memtype</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span>
		<span class="n">v3</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">memtype</span> <span class="o">+</span> <span class="mi">16</span><span class="p">];</span>
		<span class="n">v4</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">memtype</span> <span class="o">+</span> <span class="mi">24</span><span class="p">];</span>
		<span class="n">v5</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">memtype</span> <span class="o">+</span> <span class="mi">32</span><span class="p">];</span>
		<span class="n">v6</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">memtype</span> <span class="o">+</span> <span class="mi">40</span><span class="p">];</span>
		<span class="n">v7</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">memtype</span> <span class="o">+</span> <span class="mi">48</span><span class="p">];</span>
		<span class="n">v8</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">memtype</span> <span class="o">+</span> <span class="mi">56</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">&gt;=</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">v3</span> <span class="o">&amp;=</span> <span class="mh">0xfd</span><span class="p">;</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>       <span class="cm">/* Ram type (assuming 0, BIOS 0xa5 step 8) */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">v5</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="n">v6</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">v7</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="n">v8</span><span class="p">);</span>	   <span class="cm">/* ---- */</span>
	<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">);</span>
	<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bios</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x53</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>			   <span class="cm">/* DAC pedestal (BIOS 0xe5) */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">&gt;=</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">v1</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">);</span>     <span class="cm">/* linear &amp; relocated io &amp; disable a0000 */</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="mh">0xf6</span><span class="p">;</span> <span class="n">v2</span> <span class="o">=</span> <span class="mh">0x0d</span><span class="p">;</span> <span class="n">v3</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bios</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xe8</span><span class="p">];</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xe9</span><span class="p">];</span>
		<span class="n">v3</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xea</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>   <span class="cm">/* unlock crt2 */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">v2</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bios</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xec</span><span class="p">];</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xeb</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">&gt;=</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">v2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">);</span>
		<span class="n">v4</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">v5</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">v6</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xf5</span><span class="p">];</span>
			<span class="n">v5</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xf6</span><span class="p">];</span>
			<span class="n">v6</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xf7</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">v5</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">v6</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0xb0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

	<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span>  <span class="cm">/* Lock CRT2 */</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xc3</span><span class="p">;</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__x86_64__)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">sisfb_videoram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>  <span class="cm">/* ? */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="p">((</span><span class="n">sisfb_videoram</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="cm">/* Need to map max FB size for finding out about RAM size */</span>
		<span class="n">mapsize</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">;</span>
		<span class="n">sisfb_post_map_vram</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapsize</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sisfb_post_300_ramsize</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				<span class="s">&quot;sisfb: Failed to map memory for size detection, assuming 8MB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>  <span class="cm">/* ? */</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">);</span>  <span class="cm">/* 8MB, 64bit default */</span>
		<span class="p">}</span>
<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__x86_64__)</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bios</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xe6</span><span class="p">];</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xe7</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* PCI */</span>
			<span class="n">v2</span> <span class="o">=</span> <span class="mh">0x92</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span> <span class="cm">/* AGP */</span>
			<span class="n">v2</span> <span class="o">=</span> <span class="mh">0xb2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

	<span class="cm">/* Sense CRT1 */</span>
	<span class="n">sisfb_sense_crt1</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

	<span class="cm">/* Set default mode, don&#39;t clear screen */</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_UseOEM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">SiS_SetEnableDstn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">SiS_SetEnableFstn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curFSTN</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curDSTN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VideoMemorySize</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">SiSSetMode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x2e</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>

	<span class="cm">/* Display off */</span>
	<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="cm">/* Save mode number in CR34 */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>

	<span class="cm">/* Let everyone know what the current mode is */</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modeprechange</span> <span class="o">=</span> <span class="mh">0x2e</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void __devinit</span>
<span class="c">sisfb_post_sis315330(struct pci_dev *pdev)</span>
<span class="c">{</span>
<span class="c">	/* TODO */</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sisfb_xgi_is21</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip_real_id</span> <span class="o">==</span> <span class="n">XGI_21</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_xgi_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">delay</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">36</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
		<span class="n">reg</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">sisfb_find_host_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">mypdev</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pcivendor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span><span class="p">((</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_class</span><span class="p">(</span><span class="n">PCI_CLASS_BRIDGE_HOST</span><span class="p">,</span> <span class="n">pdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="n">pcivendor</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">starta</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enda</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mapsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">starta</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enda</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">mapsize</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">150</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">starta</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enda</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">mapsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">+</span> <span class="n">pos</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_xgi_ramsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buswidth</span><span class="p">,</span> <span class="n">ranksize</span><span class="p">,</span> <span class="n">channelab</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">sr14</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">dramsr13</span><span class="p">[</span><span class="mi">12</span> <span class="o">*</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x31</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">dramsr13_4</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x21</span>
	<span class="p">};</span>

	<span class="cm">/* Enable linear mode, disable 0xa0000 address decoding */</span>
	<span class="cm">/* We disable a0000 address decoding, because</span>
<span class="cm">	 * - if running on x86, if the card is disabled, it means</span>
<span class="cm">	 *   that another card is in the system. We don&#39;t want</span>
<span class="cm">	 *   to interphere with that primary card&#39;s textmode.</span>
<span class="cm">	 * - if running on non-x86, there usually is no VGA window</span>
<span class="cm">	 *   at a0000.</span>
<span class="cm">	 */</span>
	<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">));</span>

	<span class="cm">/* Need to map max FB size for finding out about RAM size */</span>
	<span class="n">mapsize</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">;</span>
	<span class="n">sisfb_post_map_vram</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapsize</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Unable to detect RAM size. Setting default.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
		<span class="cm">/* TODO */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Non-interleaving */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* No tiling */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">channelab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* Single 32/16 */</span>
			<span class="n">buswidth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">);</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>

			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>

			<span class="n">buswidth</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Dual 16/8 */</span>
			<span class="n">buswidth</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>

			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>

			<span class="n">buswidth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* XGI_40 */</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* DDRII */</span>
			<span class="n">buswidth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">channelab</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">);</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
				<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
				<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>

				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>

				<span class="n">channelab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">);</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
				<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>

				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">channelab</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">);</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">);</span>
				<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">;</span>
				<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>

				<span class="n">channelab</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
				<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>

				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">);</span>
				<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">;</span>

				<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">channelab</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">channelab</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
					<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* DDR */</span>

			<span class="n">buswidth</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">channelab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">);</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">);</span>
				<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>

				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">channelab</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">);</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">);</span>
				<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">sr14</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">bail_out</span><span class="p">;</span>

				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">bail_out:</span>
	<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="n">sr14</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">?</span> <span class="mi">12</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">dramsr13</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="n">dramsr13_4</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">];</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>

		<span class="n">ranksize</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">dramsr13</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">:</span> <span class="n">dramsr13_4</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="n">ranksize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">buswidth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>      <span class="n">ranksize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">buswidth</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="n">ranksize</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">buswidth</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span>      <span class="n">ranksize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">channelab</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">l</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ranksize</span> <span class="o">*</span> <span class="n">l</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span><span class="p">((</span><span class="n">ranksize</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">))</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">reg</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">));</span>
		<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sisfb_post_xgi_rwtest</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">channelab</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span><span class="p">),</span> <span class="n">mapsize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_xgi_setclocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">regb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs90</span><span class="p">[</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
		<span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x01</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">csb8</span><span class="p">[</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
		<span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x01</span>
	<span class="p">};</span>

	<span class="n">regb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* ! */</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">regb</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="n">cs90</span><span class="p">[</span><span class="n">index</span><span class="p">];</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">cs90</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">cs90</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">[</span><span class="mh">0x90</span> <span class="o">+</span> <span class="n">index</span><span class="p">];</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">[</span><span class="mh">0x90</span> <span class="o">+</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">v3</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">[</span><span class="mh">0x90</span> <span class="o">+</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">regb</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="n">csb8</span><span class="p">[</span><span class="n">index</span><span class="p">];</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">csb8</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">csb8</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">[</span><span class="mh">0xb8</span> <span class="o">+</span> <span class="n">index</span><span class="p">];</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">[</span><span class="mh">0xb8</span> <span class="o">+</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">v3</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">[</span><span class="mh">0xb8</span> <span class="o">+</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_xgi_ddr2_mrs_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">regb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bios</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v1</span><span class="p">;</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_setclocks</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">regb</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xf0</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_xgi_ddr2_mrs_xg21</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sisfb_post_xgi_setclocks</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* EMRS2 */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* EMRS3 */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* EMRS1 */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>	<span class="cm">/* MRS1 */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>	<span class="cm">/* MRS1 */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
	<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_xgi_ddr2</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">regb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bios</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs158</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x88</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs160</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs168</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v3</span><span class="p">;</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span> <span class="cm">/* DDR2 dual frequency mode */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="n">cs168</span><span class="p">[</span><span class="n">regb</span><span class="p">];</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">cs160</span><span class="p">[</span><span class="n">regb</span><span class="p">];</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">cs158</span><span class="p">[</span><span class="n">regb</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x168</span><span class="p">];</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x160</span><span class="p">];</span>
		<span class="n">v3</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x158</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sisfb_xgi_is21</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span>
		<span class="n">sisfb_post_xgi_ddr2_mrs_xg21</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sisfb_post_xgi_ddr2_mrs_default</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">regb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_xgi_ramtype</span><span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bios</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ramtype</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v1</span><span class="p">;</span>

	<span class="n">ramtype</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">v1</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ramtype</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x62</span><span class="p">];</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x1d2</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ramtype</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sisfb_xgi_is21</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">);</span> <span class="cm">/* GPIO control */</span>
			<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>  <span class="cm">/* GPIOH EN */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
			<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
			<span class="n">ramtype</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>		  <span class="cm">/* GPIOH */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ramtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
			<span class="n">ramtype</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ramtype</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">);</span>
				<span class="n">ramtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ramtype</span> <span class="o">&amp;=</span> <span class="mh">0x07</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ramtype</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">sisfb_post_xgi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bios</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">mypdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">v4</span><span class="p">,</span> <span class="n">v5</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ramtype</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rega</span><span class="p">,</span> <span class="n">regb</span><span class="p">,</span> <span class="n">regd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs78</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs76</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xfb</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs7b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs158</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x88</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs160</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs168</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs128</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs148</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs31a</span><span class="p">[</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span>
		<span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs33a</span><span class="p">[</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs45a</span><span class="p">[</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs170</span><span class="p">[</span><span class="mi">7</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs1a8</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cs100</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>

	<span class="cm">/* VGA enable */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SISVGAENABLE</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SISVGAENABLE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Misc */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetRegByte</span><span class="p">(</span><span class="n">SISMISCR</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">SiS_SetRegByte</span><span class="p">(</span><span class="n">SISMISCW</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Unlock SR */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="mh">0xa1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Clear some regs */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x22</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="mh">0x06</span> <span class="o">+</span> <span class="n">i</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x06</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x0b</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x31</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x30</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cs78</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x78</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x23</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cs76</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x76</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span> <span class="n">v2</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x74</span><span class="p">];</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x75</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="cm">/* PCI linear mode, RelIO enabled, A0000 decoding disabled */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cs7b</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x7b</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x31</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 40 *and* 20? */</span>
		<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x08</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">);</span> <span class="cm">/* =0x28 Z7 ? */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISVID</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISVID</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISVID</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISVID</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISVID</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISVID</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">);</span>
		<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCAP</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>

		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x7e</span><span class="p">]);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x7f</span><span class="p">]);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x80</span><span class="p">]);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x81</span><span class="p">]);</span>
			<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>

			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0xb0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x77</span><span class="p">];</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">);</span>
			<span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span> <span class="n">v2</span> <span class="o">^=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="n">v2</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">v2</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>

			<span class="k">if</span><span class="p">((</span><span class="n">mypdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SI</span><span class="p">,</span> <span class="mh">0x0730</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">mypdev</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(((</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
					<span class="n">v2</span> <span class="o">&amp;=</span> <span class="mh">0xf9</span><span class="p">;</span>
				<span class="n">v2</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
				<span class="n">v1</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mypdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SI</span><span class="p">,</span> <span class="mh">0x0735</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mypdev</span><span class="p">)</span>
					<span class="n">mypdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SI</span><span class="p">,</span> <span class="mh">0x0645</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mypdev</span><span class="p">)</span>
					<span class="n">mypdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SI</span><span class="p">,</span> <span class="mh">0x0650</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">mypdev</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">mypdev</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regd</span><span class="p">);</span>
					<span class="n">regd</span> <span class="o">&amp;=</span> <span class="mh">0xfffffeff</span><span class="p">;</span>
					<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">mypdev</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="n">regd</span><span class="p">);</span>
					<span class="n">v1</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
					<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">mypdev</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sisfb_find_host_bridge</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_SI</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">v1</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sisfb_find_host_bridge</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x1106</span><span class="p">)</span> <span class="o">||</span>
					  <span class="n">sisfb_find_host_bridge</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x1022</span><span class="p">)</span> <span class="o">||</span>
					  <span class="n">sisfb_find_host_bridge</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x700e</span><span class="p">)</span> <span class="o">||</span>
					  <span class="n">sisfb_find_host_bridge</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x10de</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">((</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
						<span class="n">v2</span> <span class="o">^=</span> <span class="mh">0x06</span><span class="p">;</span>
					<span class="n">v2</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v1</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">);</span>
			<span class="n">v2</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">);</span>
			<span class="n">regd</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x90</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x90</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">regd</span> <span class="o">&lt;</span> <span class="mh">0xcf</span><span class="p">)</span> <span class="p">)</span>
				<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

			<span class="k">if</span><span class="p">((</span><span class="n">mypdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="mh">0x10de</span><span class="p">,</span> <span class="mh">0x01e0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* TODO: set CR5f &amp;0xf1 | 0x01 for version 6570</span>
<span class="cm">				 * of nforce 2 ROM</span>
<span class="cm">				 */</span>
				<span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
					<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
				<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">mypdev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">);</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x0e</span><span class="p">))</span>
			<span class="n">v1</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x64</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x64</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x4f7</span><span class="p">];</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regd</span><span class="p">);</span>
		<span class="n">regd</span> <span class="o">=</span> <span class="p">(</span><span class="n">regd</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">regd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v1</span> <span class="o">&amp;=</span> <span class="mh">0xfc</span><span class="p">;</span>
			<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>

		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x4f6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfb</span><span class="p">);</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x4f8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x4f9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x9f</span><span class="p">);</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x4fa</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf7</span><span class="p">);</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x4fb</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x4fc</span><span class="p">]);</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x4fd</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x4fe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">);</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x4ff</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x500</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x501</span><span class="p">];</span>
		<span class="k">if</span><span class="p">((</span><span class="n">mypdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2530</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">v1</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">mypdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* RAM type:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0 == DDR1, 1 == DDR2, 2..7 == reserved?</span>
<span class="cm">	 *</span>
<span class="cm">	 * The code seems to written so that regb should equal ramtype,</span>
<span class="cm">	 * however, so far it has been hardcoded to 0. Enable other values only</span>
<span class="cm">	 * on XGI Z9, as it passes the POST, and add a warning for others.</span>
<span class="cm">	 */</span>
	<span class="n">ramtype</span> <span class="o">=</span> <span class="n">sisfb_post_xgi_ramtype</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisfb_xgi_is21</span><span class="p">(</span><span class="n">ivideo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ramtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;RAM type something else than expected: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ramtype</span><span class="p">);</span>
		<span class="n">regb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">regb</span> <span class="o">=</span> <span class="n">ramtype</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v1</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x140</span> <span class="o">+</span> <span class="n">regb</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cs128</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x128</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x68</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">regb</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">ptr</span>  <span class="o">=</span> <span class="n">cs31a</span><span class="p">;</span>
	<span class="n">ptr2</span> <span class="o">=</span> <span class="n">cs33a</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x31a</span> <span class="o">:</span> <span class="mh">0x3a6</span><span class="p">;</span>
		<span class="n">ptr</span>  <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="n">ptr2</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regd</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">regb</span><span class="p">]);</span>
			<span class="n">rega</span> <span class="o">=</span> <span class="mh">0x6b</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">regd</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr2</span><span class="p">)[</span><span class="n">regb</span><span class="p">]);</span>
			<span class="n">rega</span> <span class="o">=</span> <span class="mh">0x6e</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xf3</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">regd</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">regd</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">regd</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">rega</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">rega</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">rega</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">+=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">);</span>

	<span class="n">ptr</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x35a</span> <span class="o">:</span> <span class="mh">0x3e6</span><span class="p">;</span>
		<span class="n">ptr</span>  <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetRegANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">regd</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">regb</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]);</span>
				<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* reg = 0x00; */</span>
			<span class="k">for</span><span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xfc</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">regd</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">regd</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
				<span class="n">regd</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">);</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">);</span>
				<span class="n">reg</span> <span class="o">+=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ptr</span>  <span class="o">=</span> <span class="n">cs148</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span>  <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x148</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">regb</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">);</span>

	<span class="n">ptr</span>  <span class="o">=</span> <span class="n">cs45a</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x45a</span> <span class="o">:</span> <span class="mh">0x4e6</span><span class="p">;</span>
		<span class="n">ptr</span>  <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">regd</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(((</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">regb</span><span class="p">]);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xfc</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">regd</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">regd</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">regd</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">+=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v1</span> <span class="o">=</span> <span class="mh">0xb5</span><span class="p">;</span> <span class="n">v2</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">v3</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span> <span class="n">v4</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x118</span> <span class="o">+</span> <span class="n">regb</span><span class="p">];</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xf8</span> <span class="o">+</span> <span class="n">regb</span><span class="p">];</span>
		<span class="n">v3</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x120</span> <span class="o">+</span> <span class="n">regb</span><span class="p">];</span>
		<span class="n">v4</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x1ca</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="p">(</span><span class="n">v1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

	<span class="n">ptr</span>  <span class="o">=</span> <span class="n">cs170</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span>  <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x170</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x90</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">regb</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>

	<span class="n">ptr</span>  <span class="o">=</span> <span class="n">cs1a8</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span>  <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x1a8</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">regb</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">ptr</span>  <span class="o">=</span> <span class="n">cs100</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span>  <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x8a</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">regb</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>		<span class="cm">/* DDR2 */</span>
	<span class="k">else</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>		<span class="cm">/* DDR1 */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">ramtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">sisfb_post_xgi_setclocks</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">regb</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>   <span class="o">||</span>
		   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">v1</span> <span class="o">=</span> <span class="n">cs158</span><span class="p">[</span><span class="n">regb</span><span class="p">];</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">cs160</span><span class="p">[</span><span class="n">regb</span><span class="p">];</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">cs168</span><span class="p">[</span><span class="n">regb</span><span class="p">];</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x158</span><span class="p">];</span>
				<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x160</span><span class="p">];</span>
				<span class="n">v3</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x168</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x168</span><span class="p">]);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x160</span><span class="p">]);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x158</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>

		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x1cb</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x0c</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">||</span>
			   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x1cb</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0c</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* SiS_SetReg(SISSR, 0x16, 0x0c); */</span> <span class="cm">/* ? */</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">;</span> <span class="n">v2</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="n">v3</span> <span class="o">=</span> <span class="mh">0x83</span><span class="p">;</span> <span class="n">v4</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="n">v5</span> <span class="o">=</span> <span class="mh">0x83</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xf0</span><span class="p">];</span>
			<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x4b2</span> <span class="o">:</span> <span class="mh">0x53e</span><span class="p">;</span>
			<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="n">v3</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">v4</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
			<span class="n">v5</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">));</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
		<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">v5</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">sisfb_post_xgi_ddr2</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">regb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">sisfb_post_xgi_setclocks</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">regb</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x158</span><span class="p">]);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x160</span><span class="p">]);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x168</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
			<span class="n">v1</span> <span class="o">=</span> <span class="n">cs160</span><span class="p">[</span><span class="n">regb</span><span class="p">];</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">cs158</span><span class="p">[</span><span class="n">regb</span><span class="p">];</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x160</span><span class="p">];</span>
				<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0x158</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bios</span><span class="p">[</span><span class="mh">0x1cb</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x0c</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
			<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0xf0</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x53e</span><span class="p">]);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x53f</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sisfb_post_xgi_delay</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x540</span><span class="p">]);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x541</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">regb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* ! */</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x110</span> <span class="o">+</span> <span class="n">regb</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>

	<span class="cm">/* RAM size */</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">v2</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x62</span><span class="p">];</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="mh">0x63</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">regb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* ! */</span>
	<span class="n">regd</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">regb</span><span class="p">;</span>
	<span class="k">if</span><span class="p">((</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="n">regd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0xe0</span><span class="p">]);</span>
		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="n">regb</span> <span class="o">+</span> <span class="mh">0xe0</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* Set default mode, don&#39;t clear screen */</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_UseOEM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">SiS_SetEnableDstn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">SiS_SetEnableFstn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curFSTN</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curDSTN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VideoMemorySize</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">SiSSetMode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x2e</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>

		<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>

		<span class="cm">/* Disable read-cache */</span>
		<span class="n">SiS_SetRegAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sisfb_post_xgi_ramsize</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
		<span class="cm">/* Enable read-cache */</span>
		<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: RAM size detection failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(KERN_DEBUG &quot;-----------------\n&quot;);</span>
<span class="c">	for(i = 0; i &lt; 0xff; i++) {</span>
<span class="c">		reg = SiS_GetReg(SISCR, i);</span>
<span class="c">		printk(KERN_DEBUG &quot;CR%02x(%x) = 0x%02x\n&quot;, i, SISCR, reg);</span>
<span class="c">	}</span>
<span class="c">	for(i = 0; i &lt; 0x40; i++) {</span>
<span class="c">		reg = SiS_GetReg(SISSR, i);</span>
<span class="c">		printk(KERN_DEBUG &quot;SR%02x(%x) = 0x%02x\n&quot;, i, SISSR, reg);</span>
<span class="c">	}</span>
<span class="c">	printk(KERN_DEBUG &quot;-----------------\n&quot;);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Sense CRT1 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISPART4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sisfb_sense_crt1</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set default mode, don&#39;t clear screen */</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_UseOEM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">SiS_SetEnableDstn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">SiS_SetEnableFstn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curFSTN</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">curDSTN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SiSSetMode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x2e</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>

	<span class="cm">/* Display off */</span>
	<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="cm">/* Save mode number in CR34 */</span>
	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>

	<span class="cm">/* Let everyone know what the current mode is */</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modeprechange</span> <span class="o">=</span> <span class="mh">0x2e</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">);</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;sisfb: Please connect power to the card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">sisfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisfb_chip_info</span>	<span class="o">*</span><span class="n">chipinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sisfb_chip_info</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span>	<span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span>		<span class="o">*</span><span class="n">sis_fb_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg16</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">sisfb_off</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">sis_fb_info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ivideo</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">sis_fb_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="p">)</span><span class="n">sis_fb_info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">memyselfandi</span> <span class="o">=</span> <span class="n">sis_fb_info</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_id</span> <span class="o">=</span> <span class="n">SISFB_ID</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">card_list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cardnumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sis_video_info</span> <span class="o">*</span><span class="n">countvideo</span> <span class="o">=</span> <span class="n">card_list</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cardnumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span><span class="p">((</span><span class="n">countvideo</span> <span class="o">=</span> <span class="n">countvideo</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cardnumber</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="n">chipinfo</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">warncount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip_vendor</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">ChipRevision</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg16</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_enabled</span> <span class="o">=</span> <span class="n">reg16</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">pcibus</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">pcislot</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">pcifunc</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">subsysvendor</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">subsysdevice</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>

<span class="cp">#ifndef MODULE</span>
	<span class="k">if</span><span class="p">(</span><span class="n">sisfb_mode_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sisfb_get_vga_mode_from_kernel</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">chipinfo</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip_real_id</span> <span class="o">=</span> <span class="n">chipinfo</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">=</span> <span class="n">chipinfo</span><span class="o">-&gt;</span><span class="n">vgaengine</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">hwcursor_size</span> <span class="o">=</span> <span class="n">chipinfo</span><span class="o">-&gt;</span><span class="n">hwcursor_size</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">CRT2_write_enable</span> <span class="o">=</span> <span class="n">chipinfo</span><span class="o">-&gt;</span><span class="n">CRT2_write_enable</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span> <span class="o">=</span> <span class="n">chipinfo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdc</span>  <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedpdca</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">detectedlcda</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_thismonitor</span><span class="p">.</span><span class="n">datavalid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">current_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">engineok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_was_boot_device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_ROM_RESOURCE</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_ROM_SHADOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_enabled</span><span class="p">)</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_was_boot_device</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: PCI device is disabled, &quot;</span>
				<span class="s">&quot;but marked as boot video device ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: I will not accept this &quot;</span>
				<span class="s">&quot;as the primary VGA device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_mem</span> <span class="o">=</span> <span class="n">sisfb_parm_mem</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_accel</span> <span class="o">=</span> <span class="n">sisfb_accel</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_ypan</span> <span class="o">=</span> <span class="n">sisfb_ypan</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_max</span> <span class="o">=</span> <span class="n">sisfb_max</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_userom</span> <span class="o">=</span> <span class="n">sisfb_userom</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_useoem</span> <span class="o">=</span> <span class="n">sisfb_useoem</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">sisfb_mode_idx</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_rate</span> <span class="o">=</span> <span class="n">sisfb_parm_rate</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span> <span class="o">=</span> <span class="n">sisfb_crt1off</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_forcecrt1</span> <span class="o">=</span> <span class="n">sisfb_forcecrt1</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt2type</span> <span class="o">=</span> <span class="n">sisfb_crt2type</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt2flags</span> <span class="o">=</span> <span class="n">sisfb_crt2flags</span><span class="p">;</span>
	<span class="cm">/* pdc(a), scalelcd, special timing, lvdshl handled below */</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_dstn</span> <span class="o">=</span> <span class="n">sisfb_dstn</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_fstn</span> <span class="o">=</span> <span class="n">sisfb_fstn</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvplug</span> <span class="o">=</span> <span class="n">sisfb_tvplug</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_tvstd</span> <span class="o">=</span> <span class="n">sisfb_tvstd</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvxpos</span> <span class="o">=</span> <span class="n">sisfb_tvxposoffset</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvypos</span> <span class="o">=</span> <span class="n">sisfb_tvyposoffset</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_nocrt2rate</span> <span class="o">=</span> <span class="n">sisfb_nocrt2rate</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_rate</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_parm_rate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UsePanelScaler</span> <span class="o">=</span> <span class="n">sisfb_scalelcd</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">CenterScreen</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_CustomT</span> <span class="o">=</span> <span class="n">sisfb_specialtiming</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">LVDSHL</span> <span class="o">=</span> <span class="n">sisfb_lvdshl</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_Backup70xx</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_CHOverScan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_ChSW</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_UseLCDA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">HaveEMI</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">HaveEMILCD</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">OverruleEMI</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_SensibleSR11</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_MyCR63</span> <span class="o">=</span> <span class="mh">0x63</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDCA</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">DDCPortMixup</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_330</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_MyCR63</span> <span class="o">=</span> <span class="mh">0x53</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">SIS_661</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_SensibleSR11</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">my_default_var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">my_default_var</span><span class="p">));</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ivideo</span><span class="p">);</span>

	<span class="cm">/* Patch special cases */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span> <span class="o">=</span> <span class="n">sisfb_get_northbridge</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_SI_730</span>:
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">SIS_730</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="s">&quot;SiS 730&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_SI_651</span>:
			<span class="cm">/* ivideo-&gt;chip is ok */</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="s">&quot;SiS 651&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_SI_740</span>:
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">SIS_740</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="s">&quot;SiS 740&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_SI_661</span>:
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">SIS_661</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="s">&quot;SiS 661&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_SI_741</span>:
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">SIS_741</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="s">&quot;SiS 741&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_SI_760</span>:
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">SIS_760</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="s">&quot;SiS 760&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_SI_761</span>:
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">SIS_761</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="s">&quot;SiS 761&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">ChipType</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">ivideo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ivideo</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_315PRO</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">ChipType</span> <span class="o">==</span> <span class="n">SIS_315</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">ChipType</span> <span class="o">=</span> <span class="n">SIS_315H</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">)</span> <span class="n">pci_dev_put</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">);</span>
			<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">sis_fb_info</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_base</span>  <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_size</span>  <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">RelIO</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">IOAddress</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vga_base</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">RelIO</span><span class="p">;</span>

	<span class="n">SiSRegInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">IOAddress</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
	<span class="cm">/* Find PCI systems for Chrontel/GPIO communication setup */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">SIS_630</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        	<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">mychswtable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subsysVendor</span> <span class="o">==</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">subsysvendor</span> <span class="o">&amp;&amp;</span>
			   <span class="n">mychswtable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subsysCard</span>   <span class="o">==</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">subsysdevice</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_ChSW</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: Identified [%s %s] &quot;</span>
					<span class="s">&quot;requiring Chrontel/GPIO setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mychswtable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendorName</span><span class="p">,</span>
					<span class="n">mychswtable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cardName</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lpcdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SI</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">mychswtable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subsysVendor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">SIS_760</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lpcdev</span> <span class="o">=</span> <span class="n">pci_get_slot</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_enabled</span><span class="p">)</span>
<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__x86_64__)</span>
			      <span class="o">||</span> <span class="p">(</span><span class="n">sisfb_resetcard</span><span class="p">)</span>
<span class="cp">#endif</span>
						   <span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x3f</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SiS_SetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Find out about current video mode */</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modeprechange</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modeprechange</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_enabled</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(__i386__) || defined(__x86_64__)</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tt</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="mh">0x400</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modeprechange</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">tt</span> <span class="o">+</span> <span class="mh">0x49</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">tt</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Search and copy ROM image */</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VirtualRomBase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_XGIROM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_userom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VirtualRomBase</span> <span class="o">=</span> <span class="n">sisfb_find_rom</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VirtualRomBase</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VirtualRomBase</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Video ROM %sfound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">XGI_20</span><span class="p">))</span> <span class="p">{</span>
		   <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">UseROM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		   <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_XGIROM</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">[</span><span class="mh">0x1d1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">DDCPortMixup</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		   <span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Video ROM usage disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Find systems for special custom timing */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">SiS_CustomT</span> <span class="o">==</span> <span class="n">CUT_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sisfb_detect_custom_timing</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if our Z7 chip is actually Z9 */</span>
		<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* GPIOG EN */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SiS_GetReg</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* GPIOG */</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip_real_id</span> <span class="o">=</span> <span class="n">XGI_21</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Z9 detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* POST card in case this has not been done by the BIOS */</span>
	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_enabled</span><span class="p">)</span>
<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__x86_64__)</span>
			     <span class="o">||</span> <span class="p">(</span><span class="n">sisfb_resetcard</span><span class="p">)</span>
<span class="cp">#endif</span>
						 <span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">SIS_300</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sisfb_post_sis300</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_can_post</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/*	if((ivideo-&gt;chip == SIS_315H)   ||</span>
<span class="cm">			   (ivideo-&gt;chip == SIS_315)    ||</span>
<span class="cm">			   (ivideo-&gt;chip == SIS_315PRO) ||</span>
<span class="cm">			   (ivideo-&gt;chip == SIS_330)) {</span>
<span class="cm">				sisfb_post_sis315330(pdev);</span>
<span class="cm">			} else */</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">sisfb_post_xgi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_can_post</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">haveXGIROM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">sisfb_post_xgi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_can_post</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Card is not &quot;</span>
					<span class="s">&quot;POSTed and sisfb can&#39;t do this either.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Failed to POST card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_card_posted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Find out about RAM size */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">sisfb_get_dram_size</span><span class="p">(</span><span class="n">ivideo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Fatal error: Unable to determine VRAM size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_3</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* Enable PCI addressing and MMIO */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">((</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Enable PCI_LINEAR_ADDRESSING and MMIO_ENABLE  */</span>
		<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_PCI_ADDRESS_SET</span><span class="p">,</span> <span class="p">(</span><span class="n">SIS_PCI_ADDR_ENABLE</span> <span class="o">|</span> <span class="n">SIS_MEM_MAP_IO_ENABLE</span><span class="p">));</span>
		<span class="cm">/* Enable 2D accelerator engine */</span>
		<span class="n">SiS_SetRegOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">IND_SIS_MODULE_ENABLE</span><span class="p">,</span> <span class="n">SIS_ENABLE_2D</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">sisfb_pdc</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span>
			<span class="n">sisfb_pdc</span> <span class="o">&amp;=</span> <span class="mh">0x3c</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sisfb_pdc</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDC</span> <span class="o">=</span> <span class="n">sisfb_pdc</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_315_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">sisfb_pdca</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">PDCA</span> <span class="o">=</span> <span class="n">sisfb_pdca</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">,</span> <span class="s">&quot;sisfb FB&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Fatal error: Unable to reserve %dMB framebuffer memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Is there another framebuffer driver active?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_size</span><span class="p">,</span> <span class="s">&quot;sisfb MMIO&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Fatal error: Unable to reserve MMIO region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">);</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VideoMemoryAddress</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Fatal error: Unable to map framebuffer memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_size</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Fatal error: Unable to map MMIO region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="nl">error_0:</span>	<span class="n">iounmap</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">);</span>
<span class="nl">error_1:</span>	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">);</span>
<span class="nl">error_2:</span>	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_size</span><span class="p">);</span>
<span class="nl">error_3:</span>	<span class="n">vfree</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lpcdev</span><span class="p">)</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lpcdev</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">)</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_enabled</span><span class="p">)</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">sis_fb_info</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Video RAM at 0x%lx, mapped to 0x%lx, size %ldk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_base</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Viewport offset %ldk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_offset</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: MMIO at 0x%lx, mapped to 0x%lx, size %ldk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>


	<span class="cm">/* Determine the size of the command queue */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span> <span class="o">=</span> <span class="n">TURBO_QUEUE_AREA_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span> <span class="o">=</span> <span class="n">COMMAND_QUEUE_AREA_SIZE_Z7</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span> <span class="o">=</span> <span class="n">COMMAND_QUEUE_AREA_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Engines are no longer initialized here; this is</span>
<span class="cm">	 * now done after the first mode-switch (if the</span>
<span class="cm">	 * submitted var has its acceleration flags set).</span>
<span class="cm">	 */</span>

	<span class="cm">/* Calculate the base of the (unused) hw cursor */</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">hwcursor_vbase</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span>
				 <span class="o">+</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span>
				 <span class="o">-</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">cmdQueueSize</span>
				 <span class="o">-</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">hwcursor_size</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">HW_CURSOR_CAP</span><span class="p">;</span>

	<span class="cm">/* Initialize offscreen memory manager */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">havenoheap</span> <span class="o">=</span> <span class="n">sisfb_heap_init</span><span class="p">(</span><span class="n">ivideo</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;sisfb: Failed to initialize offscreen memory heap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Used for clearing the screen only, therefore respect our mem limit */</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VideoMemoryAddress</span> <span class="o">+=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_offset</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">.</span><span class="n">VideoMemorySize</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mem</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mtrr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcddefmodeidx</span> <span class="o">=</span> <span class="n">DEFAULT_LCDMODE</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvdefmodeidx</span>  <span class="o">=</span> <span class="n">DEFAULT_TVMODE</span><span class="p">;</span>
	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">defmodeidx</span>    <span class="o">=</span> <span class="n">DEFAULT_MODE</span><span class="p">;</span>

	<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">newrom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&lt;</span> <span class="n">XGI_20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">newrom</span> <span class="o">=</span> <span class="n">SiSDetermineROMLayout661</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">((</span><span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">sisfb_sense_crt1</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

		<span class="n">sisfb_get_VB_type</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_VIDEOBRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sisfb_detect_VB_connect</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VB_VIDEOBRIDGE</span> <span class="o">|</span> <span class="n">TV_STANDARD</span><span class="p">);</span>

		<span class="cm">/* Decide on which CRT2 device to use */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_VIDEOBRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt2type</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt2type</span> <span class="o">==</span> <span class="n">CRT2_LCD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_LCD</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">CRT2_LCD</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt2type</span> <span class="o">!=</span> <span class="n">CRT2_LCD</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt2type</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Chrontel 700x TV detection often unreliable, therefore</span>
<span class="cm">				 * use a different default order on such machines</span>
<span class="cm">				 */</span>
				<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_engine</span> <span class="o">==</span> <span class="n">SIS_300_VGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_CHRONTEL</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_LCD</span><span class="p">)</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">CRT2_LCD</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_TV</span><span class="p">)</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">CRT2_TV</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_VGA</span><span class="p">)</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">CRT2_VGA</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_TV</span><span class="p">)</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">CRT2_TV</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_LCD</span><span class="p">)</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">CRT2_LCD</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_VGA</span><span class="p">)</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">|=</span> <span class="n">CRT2_VGA</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="n">CRT2_LCD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sisfb_detect_lcd_type</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sisfb_save_pdc_emi</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_crt1off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sisfb_handle_ddc</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_thismonitor</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags2</span> <span class="o">&amp;</span> <span class="n">VB2_SISTMDSBRIDGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CRT2_VGA</span> <span class="o">|</span> <span class="n">CRT2_LCD</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">sisfb_handle_ddc</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_thismonitor</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bu</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">;</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">sisfb_validate_mode</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span>
					<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">bu</span> <span class="o">!=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Mode %dx%dx%d failed validation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">sisbios_mode</span><span class="p">[</span><span class="n">bu</span><span class="p">].</span><span class="n">xres</span><span class="p">,</span>
					<span class="n">sisbios_mode</span><span class="p">[</span><span class="n">bu</span><span class="p">].</span><span class="n">yres</span><span class="p">,</span>
					<span class="n">sisbios_mode</span><span class="p">[</span><span class="n">bu</span><span class="p">].</span><span class="n">bpp</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">currentvbflags</span> <span class="o">&amp;</span> <span class="n">VB_DISPTYPE_DISP2</span><span class="p">)</span> <span class="p">{</span>
			   <span class="k">case</span> <span class="n">CRT2_LCD</span>:
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lcddefmodeidx</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			   <span class="k">case</span> <span class="n">CRT2_TV</span>:
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">tvdefmodeidx</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			   <span class="nl">default:</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">defmodeidx</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mode_no</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">mode_no</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mni</span><span class="p">];</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sisfb_search_refresh_rate</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span><span class="p">,</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">rate_idx</span><span class="p">;</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_thismonitor</span><span class="p">.</span><span class="n">datavalid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">sisfb_verify_rate</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_thismonitor</span><span class="p">,</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">,</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">,</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: WARNING: Refresh rate &quot;</span>
							<span class="s">&quot;exceeds monitor specs!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_bpp</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">bpp</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_width</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">xres</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_height</span> <span class="o">=</span> <span class="n">sisbios_mode</span><span class="p">[</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_mode_idx</span><span class="p">].</span><span class="n">yres</span><span class="p">;</span>

		<span class="n">sisfb_set_vparms</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Default mode is %dx%dx%d (%dHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_width</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_height</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_bpp</span><span class="p">,</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">refresh_rate</span><span class="p">);</span>

		<span class="cm">/* Set up the default var according to chosen default display mode */</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_width</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_height</span><span class="p">;</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_bpp</span><span class="p">;</span>

		<span class="n">sisfb_bpp_to_var</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">);</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="mi">1000000000</span> <span class="o">/</span>
			<span class="n">sisfb_mode_rate_to_dclock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mode_no</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">));</span>

		<span class="k">if</span><span class="p">(</span><span class="n">sisfb_mode_rate_to_ddata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mode_no</span><span class="p">,</span>
						<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_ypan</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Maximize regardless of sisfb_max at startup */</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span>
				<span class="n">sisfb_calc_maxyres</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">sisfb_calc_pitch</span><span class="p">(</span><span class="n">ivideo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">);</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_accel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef STUPID_ACCELF_TEXT_SHIT</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">|=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="n">sisfb_initaccel</span><span class="p">(</span><span class="n">ivideo</span><span class="p">);</span>

<span class="cp">#if defined(FBINFO_HWACCEL_DISABLED) &amp;&amp; defined(FBINFO_HWACCEL_XPAN)</span>
		<span class="n">sis_fb_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> 		<span class="o">|</span>
				     <span class="n">FBINFO_HWACCEL_YPAN</span> 	<span class="o">|</span>
				     <span class="n">FBINFO_HWACCEL_XPAN</span> 	<span class="o">|</span>
				     <span class="n">FBINFO_HWACCEL_COPYAREA</span> 	<span class="o">|</span>
				     <span class="n">FBINFO_HWACCEL_FILLRECT</span> 	<span class="o">|</span>
				     <span class="p">((</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">accel</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">sis_fb_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">sis_fb_info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">default_var</span><span class="p">;</span>
		<span class="n">sis_fb_info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_fix</span><span class="p">;</span>
		<span class="n">sis_fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">+</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_offset</span><span class="p">;</span>
		<span class="n">sis_fb_info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sisfb_ops</span><span class="p">;</span>
		<span class="n">sis_fb_info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

		<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sis_fb_info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span> <span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: Initial vbflags 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">vbflags</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mtrr</span> <span class="o">=</span> <span class="n">mtrr_add</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">,</span>
					<span class="n">MTRR_TYPE_WRCOMB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mtrr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: Failed to add MTRRs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="k">if</span><span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">sis_fb_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sisfb: Fatal error: Failed to register framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Enlist us */</span>
		<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">card_list</span><span class="p">;</span>
		<span class="n">card_list</span> <span class="o">=</span> <span class="n">ivideo</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: 2D acceleration is %s, y-panning %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_accel</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
			<span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_ypan</span>  <span class="o">?</span>
				<span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisfb_max</span> <span class="o">?</span> <span class="s">&quot;enabled (auto-max)&quot;</span> <span class="o">:</span>
						<span class="s">&quot;enabled (no auto-max)&quot;</span><span class="p">)</span> <span class="o">:</span>
									<span class="s">&quot;disabled&quot;</span><span class="p">);</span>


		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device version %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sis_fb_info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="n">VER_MAJOR</span><span class="p">,</span> <span class="n">VER_MINOR</span><span class="p">,</span> <span class="n">VER_LEVEL</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sisfb: Copyright (C) 2001-2005 Thomas Winischhofer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="p">}</span>	<span class="cm">/* if mode = &quot;none&quot; */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************/</span>
<span class="cm">/*                PCI DEVICE HANDLING                */</span>
<span class="cm">/*****************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">sisfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sis_video_info</span>	<span class="o">*</span><span class="n">ivideo</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_info</span>		<span class="o">*</span><span class="n">sis_fb_info</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">memyselfandi</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">registered</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">registered</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">modechanged</span> <span class="o">=</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">modechanged</span><span class="p">;</span>

	<span class="cm">/* Unmap */</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">);</span>

	<span class="cm">/* Release mem regions */</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mmio_size</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">bios_abase</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lpcdev</span><span class="p">)</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">lpcdev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">)</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">nbridge</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="cm">/* Release MTRR region */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mtrr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">mtrr</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_base</span><span class="p">,</span> <span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* If device was disabled when starting, disable</span>
<span class="cm">	 * it when quitting.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">sisvga_enabled</span><span class="p">)</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Unregister the framebuffer */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ivideo</span><span class="o">-&gt;</span><span class="n">registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">sis_fb_info</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">sis_fb_info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* OK, our ivideo is gone for good from here. */</span>

	<span class="cm">/* TODO: Restore the initial mode</span>
<span class="cm">	 * This sounds easy but is as good as impossible</span>
<span class="cm">	 * on many machines with SiS chip and video bridge</span>
<span class="cm">	 * since text modes are always set up differently</span>
<span class="cm">	 * from machine to machine. Depends on the type</span>
<span class="cm">	 * of integration between chipset and bridge.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">registered</span> <span class="o">&amp;&amp;</span> <span class="n">modechanged</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;sisfb: Restoring of text mode not supported yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">sisfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sisfb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> 	<span class="o">=</span> <span class="n">sisfb_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sisfb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> 	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sisfb_remove</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sisfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;sisfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">sisfb_setup</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">sisfb_init</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************/</span>
<span class="cm">/*                      MODULE                       */</span>
<span class="cm">/*****************************************************/</span>

<span class="cp">#ifdef MODULE</span>

<span class="k">static</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">vesa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">crt1off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">mem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">forcecrt2type</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">forcecrt1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">pdc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">pdc1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">noaccel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">noypan</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">nomax</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">userom</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">useoem</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">tvstandard</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">nocrt2rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">scalelcd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">specialtiming</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">lvdshl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">tvxposoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tvyposoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__x86_64__)</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">resetcard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">videoram</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sisfb_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sisfb_setdefaultparms</span><span class="p">();</span>

	<span class="k">if</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
		<span class="n">sisfb_parm_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">scalelcd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">scalelcd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">sisfb_scalelcd</span> <span class="o">=</span> <span class="n">scalelcd</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Need to check crt2 type first for fstn/dstn */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">forcecrt2type</span><span class="p">)</span>
		<span class="n">sisfb_search_crt2type</span><span class="p">(</span><span class="n">forcecrt2type</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">tvstandard</span><span class="p">)</span>
		<span class="n">sisfb_search_tvstd</span><span class="p">(</span><span class="n">tvstandard</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">sisfb_search_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">vesa</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sisfb_search_vesamode</span><span class="p">(</span><span class="n">vesa</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">sisfb_crt1off</span> <span class="o">=</span> <span class="p">(</span><span class="n">crt1off</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sisfb_forcecrt1</span> <span class="o">=</span> <span class="n">forcecrt1</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">forcecrt1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sisfb_crt1off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">forcecrt1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sisfb_crt1off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">noaccel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sisfb_accel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">noaccel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sisfb_accel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">noypan</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sisfb_ypan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">noypan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sisfb_ypan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">nomax</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sisfb_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">nomax</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sisfb_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>
		<span class="n">sisfb_parm_mem</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">userom</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sisfb_userom</span> <span class="o">=</span> <span class="n">userom</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">useoem</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sisfb_useoem</span> <span class="o">=</span> <span class="n">useoem</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">pdc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sisfb_pdc</span>  <span class="o">=</span> <span class="p">(</span><span class="n">pdc</span>  <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pdc1</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sisfb_pdca</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdc1</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="n">sisfb_nocrt2rate</span> <span class="o">=</span> <span class="n">nocrt2rate</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">specialtiming</span><span class="p">)</span>
		<span class="n">sisfb_search_specialtiming</span><span class="p">(</span><span class="n">specialtiming</span><span class="p">);</span>

	<span class="k">if</span><span class="p">((</span><span class="n">lvdshl</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lvdshl</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">sisfb_lvdshl</span> <span class="o">=</span> <span class="n">lvdshl</span><span class="p">;</span>

	<span class="n">sisfb_tvxposoffset</span> <span class="o">=</span> <span class="n">tvxposoffset</span><span class="p">;</span>
	<span class="n">sisfb_tvyposoffset</span> <span class="o">=</span> <span class="n">tvyposoffset</span><span class="p">;</span>

<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__x86_64__)</span>
	<span class="n">sisfb_resetcard</span> <span class="o">=</span> <span class="p">(</span><span class="n">resetcard</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">videoram</span><span class="p">)</span>
		<span class="n">sisfb_videoram</span> <span class="o">=</span> <span class="n">videoram</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">sisfb_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sisfb_remove_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisfb_driver</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sisfb: Module unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sisfb_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sisfb_remove_module</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SiS 300/540/630/730/315/55x/65x/661/74x/330/76x/34x, XGI V3XT/V5/V8/Z7 framebuffer device driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Thomas Winischhofer &lt;thomas@winischhofer.net&gt;, Others&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">noypan</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nomax</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">userom</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">useoem</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vesa</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">forcecrt1</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">forcecrt2type</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">scalelcd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pdc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pdc1</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">specialtiming</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lvdshl</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tvstandard</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tvxposoffset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tvyposoffset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nocrt2rate</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__x86_64__)</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">resetcard</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">videoram</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Determines the beginning of the video memory heap in KB. This heap is used</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;for video RAM management for eg. DRM/DRI. On 300 series, the default depends</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;on the amount of video RAM available. If 8MB of video RAM or less is available,</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;the heap starts at 4096KB, if between 8 and 16MB are available at 8192KB,</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;otherwise at 12288KB. On 315/330/340 series, the heap size is 32KB by default.</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;The value is to be specified without &#39;KB&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">If set to anything other than 0, 2D acceleration will be disabled.</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;(default: 0)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noypan</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">If set to anything other than 0, y-panning will be disabled and scrolling</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;will be performed by redrawing the screen. (default: 0)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nomax</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">If y-panning is enabled, sisfb will by default use the entire available video</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;memory for the virtual screen in order to optimize scrolling performance. If</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;this is set to anything other than 0, sisfb will not do this and thereby </span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;enable the user to positively specify a virtual Y size of the screen using</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;fbset. (default: 0)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Selects the desired default display mode in the format XxYxDepth,</span><span class="se">\n</span><span class="s">&quot;</span>
	 <span class="s">&quot;eg. 1024x768x16. Other formats supported include XxY-Depth and</span><span class="se">\n</span><span class="s">&quot;</span>
	 <span class="s">&quot;XxY-Depth@Rate. If the parameter is only one (decimal or hexadecimal)</span><span class="se">\n</span><span class="s">&quot;</span>
	 <span class="s">&quot;number, it will be interpreted as a VESA mode number. (default: 800x600x8)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vesa</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Selects the desired default display mode by VESA defined mode number, eg.</span><span class="se">\n</span><span class="s">&quot;</span>
	 <span class="s">&quot;0x117 (default: 0x0103)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Selects the desired vertical refresh rate for CRT1 (external VGA) in Hz.</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;If the mode is specified in the format XxY-Depth@Rate, this parameter</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;will be ignored (default: 60)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">forcecrt1</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Normally, the driver autodetects whether or not CRT1 (external VGA) is </span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;connected. With this option, the detection can be overridden (1=CRT1 ON,</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;0=CRT1 OFF) (default: [autodetected])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">forcecrt2type</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">If this option is omitted, the driver autodetects CRT2 output devices, such as</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;LCD, TV or secondary VGA. With this option, this autodetection can be</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;overridden. Possible parameters are LCD, TV, VGA or NONE. NONE disables CRT2.</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;On systems with a SiS video bridge, parameters SVIDEO, COMPOSITE or SCART can</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;be used instead of TV to override the TV detection. Furthermore, on systems</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;with a SiS video bridge, SVIDEO+COMPOSITE, HIVISION, YPBPR480I, YPBPR480P,</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;YPBPR720P and YPBPR1080I are understood. However, whether or not these work</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;depends on the very hardware in use. (default: [autodetected])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">scalelcd</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Setting this to 1 will force the driver to scale the LCD image to the panel&#39;s</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;native resolution. Setting it to 0 will disable scaling; LVDS panels will</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;show black bars around the image, TMDS panels will probably do the scaling</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;themselves. Default: 1 on LVDS panels, 0 on TMDS panels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pdc</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">This is for manually selecting the LCD panel delay compensation. The driver</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;should detect this correctly in most cases; however, sometimes this is not</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;possible. If you see &#39;small waves&#39; on the LCD, try setting this to 4, 32 or 24</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;on a 300 series chipset; 6 on other chipsets. If the problem persists, try</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;other values (on 300 series: between 4 and 60 in steps of 4; otherwise: any</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;value from 0 to 31). (default: autodetected, if LCD is active during start)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_SIS_315</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pdc1</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">This is same as pdc, but for LCD-via CRT1. Hence, this is for the 315/330/340</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;series only. (default: autodetected if LCD is in LCD-via-CRT1 mode during</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;startup) - Note: currently, this has no effect because LCD-via-CRT1 is not</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;implemented yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">specialtiming</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Please refer to documentation for more information on this option.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lvdshl</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Please refer to documentation for more information on this option.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tvstandard</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">This allows overriding the BIOS default for the TV standard. Valid choices are</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;pal, ntsc, palm and paln. (default: [auto; pal or ntsc only])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tvxposoffset</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Relocate TV output horizontally. Possible parameters: -32 through 32.</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;Default: 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tvyposoffset</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Relocate TV output vertically. Possible parameters: -32 through 32.</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;Default: 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nocrt2rate</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Setting this to 1 will force the driver to use the default refresh rate for</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;CRT2 if CRT2 type is VGA. (default: 0, use same rate as CRT1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__x86_64__)</span>
<span class="cp">#ifdef CONFIG_FB_SIS_300</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">resetcard</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Set this to 1 in order to reset (POST) the card on non-x86 machines where</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;the BIOS did not POST the card (only supported for SiS 300/305 and XGI cards</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;currently). Default: 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">videoram</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">Set this to the amount of video RAM (in kilobyte) the card has. Required on</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;some non-x86 architectures where the memory auto detection fails. Only</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="s">&quot;relevant if resetcard is set, too. SiS300/305 only. Default: [auto-detect]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#endif 	   </span><span class="cm">/*  /MODULE  */</span><span class="cp"></span>

<span class="cm">/* _GPL only for new symbols. */</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sis_malloc</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sis_free</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sis_malloc_new</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sis_free_new</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
