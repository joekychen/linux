<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › omap2 › omapfb › omapfb-main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>omapfb-main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/omap2/omapfb-main.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Nokia Corporation</span>
<span class="cm"> * Author: Tomi Valkeinen &lt;tomi.valkeinen@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Some code and ideas taken from drivers/video/omap/ driver</span>
<span class="cm"> * by Imre Deak.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/omapfb.h&gt;</span>

<span class="cp">#include &lt;video/omapdss.h&gt;</span>
<span class="cp">#include &lt;plat/vram.h&gt;</span>
<span class="cp">#include &lt;plat/vrfb.h&gt;</span>

<span class="cp">#include &quot;omapfb.h&quot;</span>

<span class="cp">#define MODULE_NAME     &quot;omapfb&quot;</span>

<span class="cp">#define OMAPFB_PLANE_XRES_MIN		8</span>
<span class="cp">#define OMAPFB_PLANE_YRES_MIN		8</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">def_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">def_vram</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">def_vrfb</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">def_rotate</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">def_mirror</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">auto_update</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">auto_update_freq</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">auto_update</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">auto_update_freq</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
<span class="n">bool</span> <span class="n">omapfb_debug</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">omapfb_debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">omapfb_test_pattern</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">omapfb_test_pattern</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">omapfb_fb_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">omapfb_get_recommended_bpp</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">draw_pixel</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">bytespp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">line_len</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">/</span> <span class="n">bytespp</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">line_len</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>

		<span class="n">__raw_writew</span><span class="p">((</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">line_len</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

		<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">line_len</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_fb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">short</span> <span class="n">w</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">short</span> <span class="n">h</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;fill_fb %dx%d, line_len %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
				<span class="n">draw_pixel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">20</span><span class="p">))</span>
				<span class="n">draw_pixel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">20</span><span class="p">))</span>
				<span class="n">draw_pixel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mh">0xff00</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">20</span><span class="p">))</span>
				<span class="n">draw_pixel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mh">0xff0000</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">20</span><span class="p">))</span>
				<span class="n">draw_pixel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">20</span> <span class="o">||</span> <span class="n">x</span> <span class="o">==</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">||</span>
					<span class="n">y</span> <span class="o">==</span> <span class="mi">20</span> <span class="o">||</span> <span class="n">y</span> <span class="o">==</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span>
				<span class="n">draw_pixel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span> <span class="o">||</span> <span class="n">w</span> <span class="o">-</span> <span class="n">x</span> <span class="o">==</span> <span class="n">h</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
				<span class="n">draw_pixel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mh">0xff00ff</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span> <span class="o">||</span> <span class="n">x</span> <span class="o">==</span> <span class="n">h</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
				<span class="n">draw_pixel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mh">0x00ffff</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">w</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="n">c</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">%</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">%</span> <span class="mi">64</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
						<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">%</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
						<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">draw_pixel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">draw_pixel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">omapfb_get_vrfb_offset</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">vrfb</span> <span class="o">*</span><span class="n">vrfb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rot</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_ROTATE_UR</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ROTATE_CW</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ROTATE_UD</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">OMAP_VRFB_LINE_LEN</span> <span class="o">+</span> <span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ROTATE_CCW</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="n">OMAP_VRFB_LINE_LEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">*=</span> <span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">bytespp</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">omapfb_get_region_rot_paddr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">.</span><span class="n">paddr</span><span class="p">[</span><span class="n">rot</span><span class="p">]</span>
			<span class="o">+</span> <span class="n">omapfb_get_vrfb_offset</span><span class="p">(</span><span class="n">ofbi</span><span class="p">,</span> <span class="n">rot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">omapfb_get_region_paddr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">.</span><span class="n">paddr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">omapfb_get_region_vaddr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">.</span><span class="n">vaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">omapfb_colormode</span> <span class="n">omapfb_colormodes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_UYVY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nonstd</span> <span class="o">=</span> <span class="n">OMAPFB_COLOR_YUV422</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_YUV2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nonstd</span> <span class="o">=</span> <span class="n">OMAPFB_COLOR_YUY422</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_ARGB16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">red</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">green</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">blue</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">transp</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGB16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">red</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">green</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">blue</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">transp</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGB24P</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">red</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">green</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">blue</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">transp</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGB24U</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">red</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">green</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">blue</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">transp</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_ARGB32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">red</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">green</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">blue</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">transp</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGBA32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">red</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">green</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">blue</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">transp</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGBX32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">red</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">green</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">blue</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">transp</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">cmp_var_to_colormode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omapfb_colormode</span> <span class="o">*</span><span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">cmp_component</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_bitfield</span> <span class="o">*</span><span class="n">f1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_bitfield</span> <span class="o">*</span><span class="n">f2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">f1</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="n">f2</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span>
			<span class="n">f1</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="n">f2</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;&amp;</span>
			<span class="n">f1</span><span class="o">-&gt;</span><span class="n">msb_right</span> <span class="o">==</span> <span class="n">f2</span><span class="o">-&gt;</span><span class="n">msb_right</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="n">color</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&amp;&amp;</span>
		<span class="n">cmp_component</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">color</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">cmp_component</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">color</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">cmp_component</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">color</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">cmp_component</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">color</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assign_colormode_to_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omapfb_colormode</span> <span class="o">*</span><span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">color</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="n">color</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span> <span class="o">=</span> <span class="n">color</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span> <span class="o">=</span> <span class="n">color</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span> <span class="o">=</span> <span class="n">color</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span> <span class="o">=</span> <span class="n">color</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_mode_to_dss_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">dssmode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* first match with nonstd field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">omapfb_colormodes</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">omapfb_colormode</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omapfb_colormodes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">==</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">assign_colormode_to_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
				<span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">dssmode</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* then try exact match of bpp and colors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">omapfb_colormodes</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omapfb_colormode</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omapfb_colormodes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmp_var_to_colormode</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">assign_colormode_to_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
			<span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">dssmode</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* match with bpp if user has not filled color fields</span>
<span class="cm">	 * properly */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_CLUT1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_CLUT2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_CLUT4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_CLUT8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGB12U</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGB16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGB24P</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">dssmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_COLOR_RGB24U</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">omapfb_colormodes</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omapfb_colormode</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omapfb_colormodes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dssmode</span> <span class="o">==</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">dssmode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">assign_colormode_to_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
			<span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">dssmode</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_fb_res_bounds</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xres_min</span> <span class="o">=</span> <span class="n">OMAPFB_PLANE_XRES_MIN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xres_max</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yres_min</span> <span class="o">=</span> <span class="n">OMAPFB_PLANE_YRES_MIN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yres_max</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>

	<span class="cm">/* XXX: some applications seem to set virtual res to 0. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">xres_min</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">yres_min</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="n">xres_min</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres_min</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="n">yres_min</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres_min</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">xres_max</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres_max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">yres_max</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres_max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shrink_height</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_frame_size</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;can&#39;t fit FB into memory, reducing y</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">max_frame_size</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">OMAPFB_PLANE_YRES_MIN</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">OMAPFB_PLANE_YRES_MIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shrink_width</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_frame_size</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;can&#39;t fit FB into memory, reducing x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">max_frame_size</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">OMAPFB_PLANE_XRES_MIN</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">OMAPFB_PLANE_XRES_MIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_vrfb_fb_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">region_size</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_phys_size</span> <span class="o">=</span> <span class="n">omap_vrfb_min_phys_size</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">min_phys_size</span> <span class="o">&gt;</span> <span class="n">region_size</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_fb_size</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytespp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">line_size</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bytespp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* One needs to check for both VRFB and OMAPFB limitations. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_vrfb_fb_size</span><span class="p">(</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
			<span class="n">shrink_height</span><span class="p">(</span><span class="n">omap_vrfb_max_height</span><span class="p">(</span>
				<span class="n">max_frame_size</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">bytespp</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">line_size</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">check_vrfb_fb_size</span><span class="p">(</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;cannot fit FB to memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;max frame size %lu, line size %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_frame_size</span><span class="p">,</span> <span class="n">line_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line_size</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">max_frame_size</span><span class="p">)</span>
		<span class="n">shrink_height</span><span class="p">(</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line_size</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">max_frame_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shrink_width</span><span class="p">(</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="n">line_size</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bytespp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line_size</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">max_frame_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;cannot fit FB to memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Consider if VRFB assisted rotation is in use and if the virtual space for</span>
<span class="cm"> * the zero degree view needs to be mapped. The need for mapping also acts as</span>
<span class="cm"> * the trigger for setting up the hardware on the context in question. This</span>
<span class="cm"> * ensures that one does not attempt to access the virtual view before the</span>
<span class="cm"> * hardware is serving the address translations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_vrfb_rotation</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omapfb2_mem_region</span> <span class="o">*</span><span class="n">rg</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vrfb</span> <span class="o">*</span><span class="n">vrfb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">bytespp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">yuv_mode</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">reconf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">!=</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;setup_vrfb_rotation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">fb_mode_to_dss_mode</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">bytespp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">yuv_mode</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_YUV2</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_UYVY</span><span class="p">;</span>

	<span class="cm">/* We need to reconfigure VRFB if the resolution changes, if yuv mode</span>
<span class="cm">	 * is enabled/disabled, or if bytes per pixel changes */</span>

	<span class="cm">/* XXX we shouldn&#39;t allow this when framebuffer is mmapped */</span>

	<span class="n">reconf</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">yuv_mode</span> <span class="o">!=</span> <span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">yuv_mode</span><span class="p">)</span>
		<span class="n">reconf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bytespp</span> <span class="o">!=</span> <span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">bytespp</span><span class="p">)</span>
		<span class="n">reconf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">||</span>
			<span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="n">reconf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">reconf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;setup_vrfb_rotation: reset fb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vrfb</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">omap_vrfb_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">,</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span>
			<span class="n">bytespp</span><span class="p">,</span> <span class="n">yuv_mode</span><span class="p">);</span>

	<span class="cm">/* Now one can ioremap the 0 angle view */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_vrfb_map_angle</span><span class="p">(</span><span class="n">vrfb</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* used by open/write in fbmem.c */</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">.</span><span class="n">vaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">.</span><span class="n">paddr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUV422</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUY422</span>:
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">OMAP_VRFB_LINE_LEN</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">OMAP_VRFB_LINE_LEN</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">*</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dss_mode_to_fb_mode</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">dssmode</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">omapfb_colormodes</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omapfb_colormode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omapfb_colormodes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dssmode</span> <span class="o">==</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">dssmode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">assign_colormode_to_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_fb_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omapfb2_mem_region</span> <span class="o">*</span><span class="n">rg</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;set_fb_fix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* used by open/write in fbmem.c */</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">omapfb_get_region_vaddr</span><span class="p">(</span><span class="n">ofbi</span><span class="p">);</span>

	<span class="cm">/* used by mmap in fbmem.c */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUV422</span>:
		<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUY422</span>:
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">OMAP_VRFB_LINE_LEN</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">OMAP_VRFB_LINE_LEN</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">*</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">omapfb_get_region_paddr</span><span class="p">(</span><span class="n">ofbi</span><span class="p">);</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">case</span> <span class="mi">24</span>:
		<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">case</span> <span class="mi">12</span>:
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
			<span class="cm">/* 12bpp is stored in 16 bits */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check new var and possibly modify it to be ok */</span>
<span class="kt">int</span> <span class="nf">check_fb_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span> <span class="o">=</span> <span class="n">fb2display</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;check_fb_var %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">lock_count</span><span class="p">));</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">fb_mode_to_dss_mode</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;cannot convert var to omap dss mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">supported_modes</span> <span class="o">&amp;</span> <span class="n">mode</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;invalid mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">rotate</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_fb_res_bounds</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* When no memory is allocated ignore the size check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">check_fb_size</span><span class="p">(</span><span class="n">ofbi</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;xres = %d, yres = %d, vxres = %d, vyres = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">display</span> <span class="o">&amp;&amp;</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_dimensions</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
		<span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_dimensions</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">display</span> <span class="o">&amp;&amp;</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_timings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="n">timings</span><span class="p">;</span>
		<span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_timings</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timings</span><span class="p">);</span>

		<span class="cm">/* pixclock in ps, the rest in pixclock */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">pixel_clock</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span>
			<span class="n">KHZ2PICOS</span><span class="p">(</span><span class="n">timings</span><span class="p">.</span><span class="n">pixel_clock</span><span class="p">)</span> <span class="o">:</span>
			<span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">hbp</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">hfp</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">vbp</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">vfp</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">hsw</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">vsw</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: get these from panel-&gt;config */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span>              <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span>               <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * fbdev framework callbacks</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">calc_rotation_offset_dma</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">+</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">calc_rotation_offset_vrfb</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_UD</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_CW</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_UR</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">+</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_UD</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">+</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_CW</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">+</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_CCW</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">+</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_calc_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">paddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data_start_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span>
		<span class="n">data_start_p</span> <span class="o">=</span> <span class="n">omapfb_get_region_rot_paddr</span><span class="p">(</span><span class="n">ofbi</span><span class="p">,</span> <span class="n">rotation</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">data_start_p</span> <span class="o">=</span> <span class="n">omapfb_get_region_paddr</span><span class="p">(</span><span class="n">ofbi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">calc_rotation_offset_vrfb</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fix</span><span class="p">,</span> <span class="n">rotation</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">calc_rotation_offset_dma</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fix</span><span class="p">,</span> <span class="n">rotation</span><span class="p">);</span>

	<span class="n">data_start_p</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;offset %d, %d = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;paddr %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_start_p</span><span class="p">);</span>

	<span class="o">*</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">data_start_p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setup overlay according to the fb */</span>
<span class="kt">int</span> <span class="nf">omapfb_setup_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">posx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">posy</span><span class="p">,</span> <span class="n">u16</span> <span class="n">outw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">outh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_start_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">screen_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mirror</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rotation</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">rotate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">lock_count</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span> <span class="o">!=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">rotation</span> <span class="o">=</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">+</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;setup_overlay %d, posx %d, posy %d, outw %d, outh %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">posx</span><span class="p">,</span> <span class="n">posy</span><span class="p">,</span> <span class="n">outw</span><span class="p">,</span> <span class="n">outh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_CW</span> <span class="o">||</span> <span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_CCW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">omapfb_calc_addr</span><span class="p">(</span><span class="n">ofbi</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">fix</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_start_p</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">fb_mode_to_dss_mode</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;fb_mode_to_dss_mode failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUV422</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUY422</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">screen_width</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span>
				<span class="o">/</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">screen_width</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">/</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">get_overlay_info</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span>
		<span class="n">mirror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mirror</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">mirror</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">data_start_p</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">screen_width</span> <span class="o">=</span> <span class="n">screen_width</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">rotation_type</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">mirror</span> <span class="o">=</span> <span class="n">mirror</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">pos_x</span> <span class="o">=</span> <span class="n">posx</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">pos_y</span> <span class="o">=</span> <span class="n">posy</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">out_width</span> <span class="o">=</span> <span class="n">outw</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">out_height</span> <span class="o">=</span> <span class="n">outh</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">set_overlay_info</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;ovl-&gt;setup_overlay_info failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;setup_overlay failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* apply var to the overlay */</span>
<span class="kt">int</span> <span class="nf">omapfb_apply_changes</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">posx</span><span class="p">,</span> <span class="n">posy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">outw</span><span class="p">,</span> <span class="n">outh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omapfb_test_pattern</span><span class="p">)</span>
		<span class="n">fill_fb</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">lock_count</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ovl</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;apply_changes, fb %d, ovl %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the fb is not available. disable the overlay */</span>
			<span class="n">omapfb_overlay_enable</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">)</span>
				<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">apply</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">init</span> <span class="o">||</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_OVL_CAP_SCALE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">rotation</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">rotate</span> <span class="o">+</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_CW</span> <span class="o">||</span>
					<span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_CCW</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outw</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
				<span class="n">outh</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">outw</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
				<span class="n">outh</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">omap_overlay_info</span> <span class="n">info</span><span class="p">;</span>
			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">get_overlay_info</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
			<span class="n">outw</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">out_width</span><span class="p">;</span>
			<span class="n">outh</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">out_height</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">posx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">posy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">omap_overlay_info</span> <span class="n">info</span><span class="p">;</span>
			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">get_overlay_info</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
			<span class="n">posx</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">pos_x</span><span class="p">;</span>
			<span class="n">posy</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">pos_y</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_setup_overlay</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">ovl</span><span class="p">,</span> <span class="n">posx</span><span class="p">,</span> <span class="n">posy</span><span class="p">,</span> <span class="n">outw</span><span class="p">,</span> <span class="n">outh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">)</span>
			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">apply</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;apply_changes failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* checks var and eventually tweaks it to something supported,</span>
<span class="cm"> * DO NOT MODIFY PAR */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;check_var(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">omapfb_get_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">check_fb_var</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>

	<span class="n">omapfb_put_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set the video mode according to info-&gt;var */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;set_par(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">omapfb_get_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>

	<span class="n">set_fb_fix</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">setup_vrfb_rotation</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_apply_changes</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">omapfb_put_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">new_var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;pan_display(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">==</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">&amp;&amp;</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">==</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">new_var</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="n">new_var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">new_var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">new_var</span><span class="p">;</span>

	<span class="n">omapfb_get_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_apply_changes</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">omapfb_put_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmap_user_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb2_mem_region</span> <span class="o">*</span><span class="n">rg</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>

	<span class="n">omapfb_get_mem_region</span><span class="p">(</span><span class="n">rg</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="p">);</span>
	<span class="n">omapfb_put_mem_region</span><span class="p">(</span><span class="n">rg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmap_user_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb2_mem_region</span> <span class="o">*</span><span class="n">rg</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>

	<span class="n">omapfb_get_mem_region</span><span class="p">(</span><span class="n">rg</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="p">);</span>
	<span class="n">omapfb_put_mem_region</span><span class="p">(</span><span class="n">rg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">mmap_user_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">mmap_user_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">mmap_user_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb2_mem_region</span> <span class="o">*</span><span class="n">rg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">off</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">rg</span> <span class="o">=</span> <span class="n">omapfb_get_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">omapfb_get_region_paddr</span><span class="p">(</span><span class="n">ofbi</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">+</span> <span class="n">off</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">+=</span> <span class="n">start</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;user mmap region start %lx, len %d, off %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>

	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_IO</span> <span class="o">|</span> <span class="n">VM_RESERVED</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span> <span class="o">=</span> <span class="n">pgprot_writecombine</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">);</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mmap_user_ops</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span> <span class="o">=</span> <span class="n">rg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io_remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
			       <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span>
			       <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* vm_ops.open won&#39;t be called for mmap itself. */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="p">);</span>

	<span class="n">omapfb_put_mem_region</span><span class="p">(</span><span class="n">rg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">error:</span>
	<span class="n">omapfb_put_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Store a single color palette entry into a pseudo palette or the hardware</span>
<span class="cm"> * palette if one is available. For now we support only 16bpp and thus store</span>
<span class="cm"> * the entry only to the pseudo palette.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_setcolreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span>
		<span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">update_hw_pal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*struct omapfb_info *ofbi = FB2OFB(fbi);*/</span>
	<span class="cm">/*struct omapfb2_device *fbdev = ofbi-&gt;fbdev;*/</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">omapfb_color_format</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">OMAPFB_COLOR_RGB24U</span><span class="p">;</span> <span class="cm">/* XXX */</span>

	<span class="cm">/*switch (plane-&gt;color_mode) {*/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUV422</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUV420</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUY422</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_CLUT_8BPP</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_CLUT_4BPP</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_CLUT_2BPP</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_CLUT_1BPP</span>:
		<span class="cm">/*</span>
<span class="cm">		   if (fbdev-&gt;ctrl-&gt;setcolreg)</span>
<span class="cm">		   r = fbdev-&gt;ctrl-&gt;setcolreg(regno, red, green, blue,</span>
<span class="cm">		   transp, update_hw_pal);</span>
<span class="cm">		   */</span>
		<span class="cm">/* Fallthrough */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_RGB565</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_RGB444</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_RGB24P</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_RGB24U</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">pal</span><span class="p">;</span>
			<span class="n">pal</span> <span class="o">=</span> <span class="p">((</span><span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
					<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
				 <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">));</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
		<span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;setcolreg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">_setcolreg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">transp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_setcmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_cmap</span> <span class="o">*</span><span class="n">cmap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">red</span><span class="p">,</span> <span class="o">*</span><span class="n">green</span><span class="p">,</span> <span class="o">*</span><span class="n">blue</span><span class="p">,</span> <span class="o">*</span><span class="n">transp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">trans</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;setcmap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">red</span>     <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
	<span class="n">green</span>   <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">;</span>
	<span class="n">blue</span>    <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">;</span>
	<span class="n">transp</span>  <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">;</span>
	<span class="n">index</span>   <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">transp</span><span class="p">)</span>
			<span class="n">trans</span> <span class="o">=</span> <span class="o">*</span><span class="n">transp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">_setcolreg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">,</span> <span class="o">*</span><span class="n">red</span><span class="o">++</span><span class="p">,</span> <span class="o">*</span><span class="n">green</span><span class="o">++</span><span class="p">,</span> <span class="o">*</span><span class="n">blue</span><span class="o">++</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span>
				<span class="n">count</span> <span class="o">==</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span> <span class="o">=</span> <span class="n">fb2display</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omapfb_display_data</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">display</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">omapfb_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">get_display_data</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">display</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">OMAP_DSS_DISPLAY_SUSPENDED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">display</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_DISPLAY_CAP_MANUAL_UPDATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">update_mode</span> <span class="o">==</span> <span class="n">OMAPFB_AUTO_UPDATE</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">auto_update_work_enabled</span><span class="p">)</span>
			<span class="n">omapfb_start_auto_update</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">display</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="cm">/* FB_BLANK_NORMAL could be implemented.</span>
<span class="cm">		 * Needs DSS additions. */</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">OMAP_DSS_DISPLAY_ACTIVE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">auto_update_work_enabled</span><span class="p">)</span>
			<span class="n">omapfb_stop_auto_update</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">display</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">display</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">omapfb_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* XXX fb_read and fb_write are needed for VRFB */</span>
<span class="c">ssize_t omapfb_write(struct fb_info *info, const char __user *buf,</span>
<span class="c">		size_t count, loff_t *ppos)</span>
<span class="c">{</span>
<span class="c">	DBG(&quot;omapfb_write %d, %lu\n&quot;, count, (unsigned long)*ppos);</span>
<span class="c">	/* XXX needed for VRFB */</span>
<span class="c">	return count;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">omapfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>          <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>        <span class="o">=</span> <span class="n">omapfb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>     <span class="o">=</span> <span class="n">omapfb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>    <span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>    <span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>   <span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>       <span class="o">=</span> <span class="n">omapfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span>       <span class="o">=</span> <span class="n">omapfb_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>   <span class="o">=</span> <span class="n">omapfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>     <span class="o">=</span> <span class="n">omapfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">omapfb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_mmap</span>	<span class="o">=</span> <span class="n">omapfb_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">omapfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcmap</span>	<span class="o">=</span> <span class="n">omapfb_setcmap</span><span class="p">,</span>
	<span class="cm">/*.fb_write	= omapfb_write,*/</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_free_fbmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb2_mem_region</span> <span class="o">*</span><span class="n">rg</span><span class="p">;</span>

	<span class="n">rg</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_vram_free</span><span class="p">(</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VRAM FREE failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unmap the 0 angle rotation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">.</span><span class="n">vaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">.</span><span class="n">vaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">omap_vrfb_release_ctx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">);</span>
			<span class="n">rg</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">.</span><span class="n">vaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_fb_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">MODULE_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_free_all_fbmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;free all fbmem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">omapfb_free_fbmem</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="n">clear_fb_info</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_alloc_fbmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb2_mem_region</span> <span class="o">*</span><span class="n">rg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">rg</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">;</span>

	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">);</span>
	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">paddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;allocating %lu bytes for fb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">omap_vram_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">paddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;reserving %lu bytes at %lx for fb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span>
				<span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">omap_vram_reserve</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">!=</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vaddr</span> <span class="o">=</span> <span class="n">ioremap_wc</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vaddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to ioremap framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">omap_vram_free</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;allocated VRAM paddr %lx, vaddr %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">omap_vrfb_request_ctx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">vrfb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vrfb create ctx failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">vaddr</span><span class="p">;</span>
	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">rg</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* allocate fbmem using display resolution as reference */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_alloc_fbmem_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytespp</span><span class="p">;</span>

	<span class="n">display</span> <span class="o">=</span>  <span class="n">fb2display</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">display</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">omapfb_get_recommended_bpp</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">display</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">bytespp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">bytespp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bytespp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>

		<span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_resolution</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_VRFB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">omap_vrfb_min_phys_size</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">bytespp</span><span class="p">),</span>
					<span class="n">omap_vrfb_min_phys_size</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">bytespp</span><span class="p">));</span>

			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;adjusting fb mem size for VRFB, %u -&gt; %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">w</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="n">bytespp</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="n">bytespp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">omapfb_alloc_fbmem</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_parse_vram_param</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_entries</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sizes</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">paddrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fbnum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>

		<span class="n">fbnum</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fbnum</span> <span class="o">&gt;=</span> <span class="n">max_entries</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">memparse</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">paddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">paddr</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">paddr</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="n">paddrs</span><span class="p">[</span><span class="n">fbnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="n">sizes</span><span class="p">[</span><span class="n">fbnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="o">++</span><span class="n">p</span><span class="p">;</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_allocate_all_fbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vram_sizes</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vram_paddrs</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vram_sizes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vram_sizes</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vram_paddrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vram_paddrs</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">def_vram</span> <span class="o">&amp;&amp;</span>	<span class="n">omapfb_parse_vram_param</span><span class="p">(</span><span class="n">def_vram</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
				<span class="n">vram_sizes</span><span class="p">,</span> <span class="n">vram_paddrs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to parse vram parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vram_sizes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vram_sizes</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vram_paddrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vram_paddrs</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* allocate memory automatically only for fb0, or if</span>
<span class="cm">		 * excplicitly defined with vram or plat data option */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vram_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_alloc_fbmem_display</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">vram_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vram_paddrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">struct</span> <span class="n">omapfb2_mem_region</span> <span class="o">*</span><span class="n">rg</span><span class="p">;</span>
		<span class="n">rg</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">;</span>

		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;region%d phys %08x virt %p size=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span>
				<span class="n">rg</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span>
				<span class="n">rg</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">,</span>
				<span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omapfb_realloc_fbmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span> <span class="o">=</span> <span class="n">fb2display</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omapfb2_mem_region</span> <span class="o">*</span><span class="n">rg</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_size</span> <span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_paddr</span> <span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_type</span> <span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OMAPFB_MEMTYPE_SDRAM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">==</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">old_type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">display</span> <span class="o">&amp;&amp;</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">)</span>
			<span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">(</span><span class="n">display</span><span class="p">);</span>

	<span class="n">omapfb_free_fbmem</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_fb_info</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_alloc_fbmem</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_size</span><span class="p">)</span>
			<span class="n">omapfb_alloc_fbmem</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">old_size</span><span class="p">,</span> <span class="n">old_paddr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">clear_fb_info</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;initializing fb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_fb_init</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;omapfb_fb_init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_apply_changes</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;omapfb_apply_changes failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">new_var</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_var</span><span class="p">));</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">check_fb_var</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_var</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">));</span>
		<span class="n">set_fb_fix</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">setup_vrfb_rotation</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">omapfb_free_fbmem</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">clear_fb_info</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_auto_update_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dss_driver</span> <span class="o">*</span><span class="n">dssdrv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_display_data</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omapfb_display_data</span><span class="p">,</span>
			<span class="n">auto_update_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">dssdev</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">dssdev</span><span class="p">;</span>
	<span class="n">dssdrv</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">fbdev</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dssdrv</span> <span class="o">||</span> <span class="o">!</span><span class="n">dssdrv</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdrv</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">)</span>
		<span class="n">dssdrv</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="n">dssdrv</span><span class="o">-&gt;</span><span class="n">get_resolution</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>
	<span class="n">dssdrv</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">auto_update_freq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">auto_update_wq</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">auto_update_work</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="n">freq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omapfb_start_auto_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_display_data</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">auto_update_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>

		<span class="n">wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;omapfb_auto_update&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create workqueue for &quot;</span>
					<span class="s">&quot;auto-update</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">auto_update_wq</span> <span class="o">=</span> <span class="n">wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">get_display_data</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">display</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">auto_update_work</span><span class="p">,</span> <span class="n">omapfb_auto_update_work</span><span class="p">);</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">auto_update_work_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">omapfb_auto_update_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">auto_update_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omapfb_stop_auto_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_display_data</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">get_display_data</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">display</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">auto_update_work</span><span class="p">);</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">auto_update_work_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* initialize fb_info, var, fix to something sane based on the display */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_fb_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span> <span class="o">=</span> <span class="n">fb2display</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omapfb_ops</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_fb_info</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">rotate</span> <span class="o">=</span> <span class="n">def_rotate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rotation</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">rotate</span> <span class="o">+</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_resolution</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_CW</span> <span class="o">||</span>
				<span class="n">rotation</span> <span class="o">==</span> <span class="n">FB_ROTATE_CCW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">omapfb_get_recommended_bpp</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">display</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">16</span>:
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">24</span>:
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;illegal display &quot;</span>
						<span class="s">&quot;bpp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* if there&#39;s no display, let&#39;s just guess some basic values */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">check_fb_var</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">set_fb_fix</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">setup_vrfb_rotation</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to allocate color map memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fbinfo_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_free_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;free_resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* free the reserved fbmem */</span>
	<span class="n">omapfb_free_all_fbmem</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbinfo_cleanup</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_displays</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">displays</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dssdev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">displays</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">auto_update_work_enabled</span><span class="p">)</span>
			<span class="n">omapfb_stop_auto_update</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">dssdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">OMAP_DSS_DISPLAY_DISABLED</span><span class="p">)</span>
			<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

		<span class="n">omap_dss_put_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">auto_update_wq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">auto_update_wq</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">auto_update_wq</span><span class="p">);</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">auto_update_wq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_create_framebuffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;create %d framebuffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	<span class="n">CONFIG_FB_OMAP2_NUM_FBS</span><span class="p">);</span>

	<span class="cm">/* allocate fb_infos */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONFIG_FB_OMAP2_NUM_FBS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span><span class="p">;</span>

		<span class="n">fbi</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_info</span><span class="p">),</span>
				<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;unable to allocate memory for plane info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">clear_fb_info</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fbi</span><span class="p">;</span>

		<span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">fbdev</span><span class="p">;</span>
		<span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="cm">/* assign these early, so that fb alloc can use them */</span>
		<span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">=</span> <span class="n">def_vrfb</span> <span class="o">?</span> <span class="n">OMAP_DSS_ROT_VRFB</span> <span class="o">:</span>
			<span class="n">OMAP_DSS_ROT_DMA</span><span class="p">;</span>
		<span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">mirror</span> <span class="o">=</span> <span class="n">def_mirror</span><span class="p">;</span>

		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;fb_infos allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* assign overlays for the fbs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span><span class="p">,</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">num_overlays</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate fb memories */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_allocate_all_fbs</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate fbmem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;fbmems allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* setup fb_infos */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

		<span class="n">omapfb_get_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_fb_init</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>
		<span class="n">omapfb_put_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to setup fb_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;fb_infos initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;registering framebuffer %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;framebuffers registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

		<span class="n">omapfb_get_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_apply_changes</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">omapfb_put_mem_region</span><span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to change mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Enable fb0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_fbs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omapfb_info</span> <span class="o">*</span><span class="n">ofbi</span> <span class="o">=</span> <span class="n">FB2OFB</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">num_overlays</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">ofbi</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">apply</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>

			<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_overlay_enable</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;failed to enable overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;create_framebuffers done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_mode_to_timings</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_str</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_ops</span> <span class="o">*</span><span class="n">fbops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_VENC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">mode_str</span><span class="p">,</span> <span class="s">&quot;pal&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="n">omap_dss_pal_timings</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">mode_str</span><span class="p">,</span> <span class="s">&quot;ntsc&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="n">omap_dss_ntsc_timings</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* this is quite a hack, but I wanted to use the modedb and for</span>
<span class="cm">	 * that we need fb_info and var, so we create dummy ones */</span>

	<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">var</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fbops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">fbi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fbi</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">var</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbops</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fbops</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="n">fbops</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fbi</span><span class="p">,</span> <span class="n">mode_str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hbp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vbp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hsw</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vsw</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">y_res</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fbops</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_set_def_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="n">timings</span><span class="p">,</span> <span class="n">temp_timings</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_display_data</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_mode_to_timings</span><span class="p">(</span><span class="n">mode_str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timings</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bpp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">get_display_data</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">display</span><span class="p">);</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">bpp_override</span> <span class="o">=</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">check_timings</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">check_timings</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timings</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If check_timings is not present compare xres and yres */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_timings</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_timings</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_timings</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp_timings</span><span class="p">.</span><span class="n">x_res</span> <span class="o">!=</span> <span class="n">timings</span><span class="p">.</span><span class="n">x_res</span> <span class="o">||</span>
				<span class="n">temp_timings</span><span class="p">.</span><span class="n">y_res</span> <span class="o">!=</span> <span class="n">timings</span><span class="p">.</span><span class="n">y_res</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_timings</span><span class="p">)</span>
			<span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_timings</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timings</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_get_recommended_bpp</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_display_data</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_recommended_bpp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">get_display_data</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">dssdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bpp_override</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">bpp_override</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_recommended_bpp</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_parse_def_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">def_mode</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">str</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">display_str</span><span class="p">,</span> <span class="o">*</span><span class="n">mode_str</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">display_str</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
		<span class="n">mode_str</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">display</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_displays</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">displays</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="n">display_str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">display</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">displays</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dssdev</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">display</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_set_def_mode</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">mode_str</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_videomode_to_omap_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">y_res</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">hsw</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">hfp</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">hbp</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">vsw</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">vfp</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">vbp</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_find_best_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">display</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">best_xres</span><span class="p">,</span> <span class="n">best_idx</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">read_edid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">edid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">read_edid</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">edid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">specs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">specs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">fb_edid_to_monspecs</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="n">specs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">[</span><span class="mi">126</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fb_edid_add_monspecs</span><span class="p">(</span><span class="n">edid</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">specs</span><span class="p">);</span>

	<span class="n">best_xres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">best_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="n">t</span><span class="p">;</span>

		<span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* skip repeated pixel modes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">2880</span> <span class="o">||</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">1440</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">fb_videomode_to_omap_timings</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">check_timings</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">best_xres</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_xres</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
			<span class="n">best_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">best_xres</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_videomode_to_omap_timings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">[</span><span class="n">best_idx</span><span class="p">],</span> <span class="n">timings</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err2:</span>
	<span class="n">fb_destroy_modedb</span><span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">specs</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_init_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_dss_driver</span> <span class="o">*</span><span class="n">dssdrv</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_display_data</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dssdrv</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to enable display &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">get_display_data</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">dssdev</span><span class="p">);</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">fbdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_DISPLAY_CAP_MANUAL_UPDATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">auto_update</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">omapfb_start_auto_update</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">dssdev</span><span class="p">);</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">update_mode</span> <span class="o">=</span> <span class="n">OMAPFB_AUTO_UPDATE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">update_mode</span> <span class="o">=</span> <span class="n">OMAPFB_MANUAL_UPDATE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dssdrv</span><span class="o">-&gt;</span><span class="n">enable_te</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">dssdrv</span><span class="o">-&gt;</span><span class="n">enable_te</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to set TE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">dssdrv</span><span class="o">-&gt;</span><span class="n">get_resolution</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dssdrv</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Failed to update display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">update_mode</span> <span class="o">=</span> <span class="n">OMAPFB_AUTO_UPDATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omapfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">def_display</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;omapfb_probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probed for an unknown device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb2_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO : Replace cpu check with omap_has_vrfb once HAS_FEATURE</span>
<span class="cm">	*	 available for OMAP2 and OMAP3</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_vrfb</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_is_omap24xx</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_is_omap34xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">def_vrfb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VRFB is not supported on this hardware, &quot;</span>
				<span class="s">&quot;ignoring the module parameter vrfb=y</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">fbdev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_displays</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dssdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">for_each_dss_dev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omapfb_display_data</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

		<span class="n">omap_dss_get_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no driver for display: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">omap_dss_put_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">displays</span><span class="p">[</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_displays</span><span class="o">++</span><span class="p">];</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">dssdev</span> <span class="o">=</span> <span class="n">dssdev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_DISPLAY_CAP_MANUAL_UPDATE</span><span class="p">)</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">update_mode</span> <span class="o">=</span> <span class="n">OMAPFB_MANUAL_UPDATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">update_mode</span> <span class="o">=</span> <span class="n">OMAPFB_AUTO_UPDATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_displays</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no displays</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_overlays</span> <span class="o">=</span> <span class="n">omap_dss_get_num_overlays</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_overlays</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">overlays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_managers</span> <span class="o">=</span> <span class="n">omap_dss_get_num_overlay_managers</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_managers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">managers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay_manager</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="cm">/* gfx overlay should be the default one. find a display</span>
<span class="cm">	 * connected to that, and use it as default display */</span>
	<span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">&amp;&amp;</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">def_display</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot find default display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">def_display</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">def_mode</span> <span class="o">&amp;&amp;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">def_mode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omapfb_parse_def_modes</span><span class="p">(</span><span class="n">fbdev</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot parse default modes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">def_display</span> <span class="o">&amp;&amp;</span> <span class="n">def_display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_timings</span> <span class="o">&amp;&amp;</span>
			<span class="n">def_display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">check_timings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="n">t</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_find_best_mode</span><span class="p">(</span><span class="n">def_display</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">def_display</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_timings</span><span class="p">(</span><span class="n">def_display</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_create_framebuffers</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">num_managers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_overlay_manager</span> <span class="o">*</span><span class="n">mgr</span><span class="p">;</span>
		<span class="n">mgr</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">managers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">apply</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to apply dispc config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;mgr-&gt;apply&#39;ed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">def_display</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_init_display</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">def_display</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;failed to initialize default &quot;</span>
					<span class="s">&quot;display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;create sysfs for fbs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_create_sysfs</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create sysfs entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="n">omapfb_free_resources</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to setup omapfb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">omapfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb2_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* FIXME: wait till completion of pending events */</span>

	<span class="n">omapfb_remove_sysfs</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="n">omapfb_free_resources</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omapfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">omapfb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>         <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;omapfb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omapfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;omapfb_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omapfb_driver</span><span class="p">,</span> <span class="n">omapfb_probe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failed to register omapfb driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">omapfb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;omapfb_exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omapfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">def_mode</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">vram</span><span class="p">,</span> <span class="n">def_vram</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">rotate</span><span class="p">,</span> <span class="n">def_rotate</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">vrfb</span><span class="p">,</span> <span class="n">def_vrfb</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">mirror</span><span class="p">,</span> <span class="n">def_mirror</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* late_initcall to let panel/ctrl drivers loaded first.</span>
<span class="cm"> * I guess better option would be a more dynamic approach,</span>
<span class="cm"> * so that omapfb reacts to new panels when they are loaded */</span>
<span class="n">late_initcall</span><span class="p">(</span><span class="n">omapfb_init</span><span class="p">);</span>
<span class="cm">/*module_init(omapfb_init);*/</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">omapfb_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Tomi Valkeinen &lt;tomi.valkeinen@nokia.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;OMAP2/3 Framebuffer&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
