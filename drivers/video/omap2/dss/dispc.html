<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › omap2 › dss › dispc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dispc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/omap2/dss/dispc.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Nokia Corporation</span>
<span class="cm"> * Author: Tomi Valkeinen &lt;tomi.valkeinen@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Some code and ideas taken from drivers/video/omap/ driver</span>
<span class="cm"> * by Imre Deak.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>

<span class="cp">#define DSS_SUBSYS_NAME &quot;DISPC&quot;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;plat/clock.h&gt;</span>

<span class="cp">#include &lt;video/omapdss.h&gt;</span>

<span class="cp">#include &quot;dss.h&quot;</span>
<span class="cp">#include &quot;dss_features.h&quot;</span>
<span class="cp">#include &quot;dispc.h&quot;</span>

<span class="cm">/* DISPC */</span>
<span class="cp">#define DISPC_SZ_REGS			SZ_4K</span>

<span class="cp">#define DISPC_IRQ_MASK_ERROR            (DISPC_IRQ_GFX_FIFO_UNDERFLOW | \</span>
<span class="cp">					 DISPC_IRQ_OCP_ERR | \</span>
<span class="cp">					 DISPC_IRQ_VID1_FIFO_UNDERFLOW | \</span>
<span class="cp">					 DISPC_IRQ_VID2_FIFO_UNDERFLOW | \</span>
<span class="cp">					 DISPC_IRQ_SYNC_LOST | \</span>
<span class="cp">					 DISPC_IRQ_SYNC_LOST_DIGIT)</span>

<span class="cp">#define DISPC_MAX_NR_ISRS		8</span>

<span class="k">struct</span> <span class="n">omap_dispc_isr_data</span> <span class="p">{</span>
	<span class="n">omap_dispc_isr_t</span>	<span class="n">isr</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">omap_burst_size</span> <span class="p">{</span>
	<span class="n">BURST_SIZE_X2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">BURST_SIZE_X4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">BURST_SIZE_X8</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define REG_GET(idx, start, end) \</span>
<span class="cp">	FLD_GET(dispc_read_reg(idx), start, end)</span>

<span class="cp">#define REG_FLD_MOD(idx, val, start, end)				\</span>
<span class="cp">	dispc_write_reg(idx, FLD_MOD(dispc_read_reg(idx), val, start, end))</span>

<span class="k">struct</span> <span class="n">dispc_irq_stats</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_reset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">irq_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">irqs</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>    <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="kt">int</span>		<span class="n">ctx_loss_cnt</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">dss_clk</span><span class="p">;</span>

	<span class="n">u32</span>	<span class="n">fifo_size</span><span class="p">[</span><span class="n">MAX_DSS_OVERLAYS</span><span class="p">];</span>

	<span class="n">spinlock_t</span> <span class="n">irq_lock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_error_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dispc_isr_data</span> <span class="n">registered_isr</span><span class="p">[</span><span class="n">DISPC_MAX_NR_ISRS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">error_irqs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">error_work</span><span class="p">;</span>

	<span class="n">bool</span>		<span class="n">ctx_valid</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">ctx</span><span class="p">[</span><span class="n">DISPC_SZ_REGS</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)];</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_COLLECT_IRQ_STATS</span>
	<span class="n">spinlock_t</span> <span class="n">irq_stats_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dispc_irq_stats</span> <span class="n">irq_stats</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span> <span class="n">dispc</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">omap_color_component</span> <span class="p">{</span>
	<span class="cm">/* used for all color formats for OMAP3 and earlier</span>
<span class="cm">	 * and for RGB and Y color component on OMAP4</span>
<span class="cm">	 */</span>
	<span class="n">DISPC_COLOR_COMPONENT_RGB_Y</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* used for UV component for</span>
<span class="cm">	 * OMAP_DSS_COLOR_YUV2, OMAP_DSS_COLOR_UYVY, OMAP_DSS_COLOR_NV12</span>
<span class="cm">	 * color formats on OMAP4</span>
<span class="cm">	 */</span>
	<span class="n">DISPC_COLOR_COMPONENT_UV</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">_omap_dispc_set_irqs</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dispc_write_reg</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dispc</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">dispc_read_reg</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">dispc</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SR(reg) \</span>
<span class="cp">	dispc.ctx[DISPC_##reg / sizeof(u32)] = dispc_read_reg(DISPC_##reg)</span>
<span class="cp">#define RR(reg) \</span>
<span class="cp">	dispc_write_reg(DISPC_##reg, dispc.ctx[DISPC_##reg / sizeof(u32)])</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_save_context</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dispc_save_context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">SR</span><span class="p">(</span><span class="n">IRQENABLE</span><span class="p">);</span>
	<span class="n">SR</span><span class="p">(</span><span class="n">CONTROL</span><span class="p">);</span>
	<span class="n">SR</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">);</span>
	<span class="n">SR</span><span class="p">(</span><span class="n">LINE_NUMBER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ALPHA_FIXED_ZORDER</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ALPHA_FREE_ZORDER</span><span class="p">))</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">GLOBAL_ALPHA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_MGR_LCD2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">CONTROL2</span><span class="p">);</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">CONFIG2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dss_feat_get_num_mgrs</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">DEFAULT_COLOR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">TRANS_COLOR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">SIZE_MGR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_DIGIT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">TIMING_H</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">TIMING_V</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">POL_FREQ</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">DIVISORo</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="n">SR</span><span class="p">(</span><span class="n">DATA_CYCLE1</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">DATA_CYCLE2</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">DATA_CYCLE3</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_CPR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">CPR_COEF_R</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">CPR_COEF_G</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">CPR_COEF_B</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dss_feat_get_num_ovls</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_BA0</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_BA1</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_POSITION</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_SIZE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_FIFO_THRESHOLD</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_ROW_INC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_PIXEL_INC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_PRELOAD</span><span class="p">))</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_PRELOAD</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">OMAP_DSS_GFX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_WINDOW_SKIP</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_TABLE_BA</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_FIR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_PICTURE_SIZE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_ACCU0</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">OVL_ACCU1</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_H</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_HV</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_CONV_COEF</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_FIR_COEF_V</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">SR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_V</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_HANDLE_UV_SEPARATE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_BA0_UV</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_BA1_UV</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_FIR2</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_ACCU2_0</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_ACCU2_1</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">SR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_H2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">SR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_HV2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">SR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_V2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ATTR2</span><span class="p">))</span>
			<span class="n">SR</span><span class="p">(</span><span class="n">OVL_ATTRIBUTES2</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_CORE_CLK_DIV</span><span class="p">))</span>
		<span class="n">SR</span><span class="p">(</span><span class="n">DIVISOR</span><span class="p">);</span>

	<span class="n">dispc</span><span class="p">.</span><span class="n">ctx_loss_cnt</span> <span class="o">=</span> <span class="n">dss_get_ctx_loss_count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dispc</span><span class="p">.</span><span class="n">ctx_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;context saved, ctx_loss_count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dispc</span><span class="p">.</span><span class="n">ctx_loss_cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_restore_context</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ctx</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dispc_restore_context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dispc</span><span class="p">.</span><span class="n">ctx_valid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="n">dss_get_ctx_loss_count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span> <span class="o">==</span> <span class="n">dispc</span><span class="p">.</span><span class="n">ctx_loss_cnt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;ctx_loss_count: saved %d, current %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dispc</span><span class="p">.</span><span class="n">ctx_loss_cnt</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>

	<span class="cm">/*RR(IRQENABLE);*/</span>
	<span class="cm">/*RR(CONTROL);*/</span>
	<span class="n">RR</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">);</span>
	<span class="n">RR</span><span class="p">(</span><span class="n">LINE_NUMBER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ALPHA_FIXED_ZORDER</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ALPHA_FREE_ZORDER</span><span class="p">))</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">GLOBAL_ALPHA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_MGR_LCD2</span><span class="p">))</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">CONFIG2</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dss_feat_get_num_mgrs</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">DEFAULT_COLOR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">TRANS_COLOR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">SIZE_MGR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_DIGIT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">TIMING_H</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">TIMING_V</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">POL_FREQ</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">DIVISORo</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="n">RR</span><span class="p">(</span><span class="n">DATA_CYCLE1</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">DATA_CYCLE2</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">DATA_CYCLE3</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_CPR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">CPR_COEF_R</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">CPR_COEF_G</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">CPR_COEF_B</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dss_feat_get_num_ovls</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_BA0</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_BA1</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_POSITION</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_SIZE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_FIFO_THRESHOLD</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_ROW_INC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_PIXEL_INC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_PRELOAD</span><span class="p">))</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_PRELOAD</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">OMAP_DSS_GFX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_WINDOW_SKIP</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_TABLE_BA</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_FIR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_PICTURE_SIZE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_ACCU0</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">OVL_ACCU1</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_H</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_HV</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_CONV_COEF</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_FIR_COEF_V</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">RR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_V</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_HANDLE_UV_SEPARATE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_BA0_UV</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_BA1_UV</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_FIR2</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_ACCU2_0</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_ACCU2_1</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">RR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_H2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">RR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_HV2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">RR</span><span class="p">(</span><span class="n">OVL_FIR_COEF_V2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ATTR2</span><span class="p">))</span>
			<span class="n">RR</span><span class="p">(</span><span class="n">OVL_ATTRIBUTES2</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_CORE_CLK_DIV</span><span class="p">))</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">DIVISOR</span><span class="p">);</span>

	<span class="cm">/* enable last, because LCD &amp; DIGIT enable are here */</span>
	<span class="n">RR</span><span class="p">(</span><span class="n">CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_MGR_LCD2</span><span class="p">))</span>
		<span class="n">RR</span><span class="p">(</span><span class="n">CONTROL2</span><span class="p">);</span>
	<span class="cm">/* clear spurious SYNC_LOST_DIGIT interrupts */</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_IRQSTATUS</span><span class="p">,</span> <span class="n">DISPC_IRQ_SYNC_LOST_DIGIT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * enable last so IRQs won&#39;t trigger before</span>
<span class="cm">	 * the context is fully restored</span>
<span class="cm">	 */</span>
	<span class="n">RR</span><span class="p">(</span><span class="n">IRQENABLE</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;context restored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#undef SR</span>
<span class="cp">#undef RR</span>

<span class="kt">int</span> <span class="nf">dispc_runtime_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dispc_runtime_get</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_runtime_put</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dispc_runtime_put</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">dispc_mgr_is_lcd</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span> <span class="o">||</span>
			<span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">dispc_mgr_get_vsync_irq</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span>:
		<span class="k">return</span> <span class="n">DISPC_IRQ_VSYNC</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span>:
		<span class="k">return</span> <span class="n">DISPC_IRQ_VSYNC2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CHANNEL_DIGIT</span>:
		<span class="k">return</span> <span class="n">DISPC_IRQ_EVSYNC_ODD</span> <span class="o">|</span> <span class="n">DISPC_IRQ_EVSYNC_EVEN</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">dispc_mgr_get_framedone_irq</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span>:
		<span class="k">return</span> <span class="n">DISPC_IRQ_FRAMEDONE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span>:
		<span class="k">return</span> <span class="n">DISPC_IRQ_FRAMEDONE2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CHANNEL_DIGIT</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">dispc_mgr_go_busy</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dispc_mgr_is_lcd</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* GOLCD */</span>
	<span class="k">else</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="cm">/* GODIGIT */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_mgr_go</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">enable_bit</span><span class="p">,</span> <span class="n">go_bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dispc_mgr_is_lcd</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* LCDENABLE */</span>
	<span class="k">else</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* DIGITALENABLE */</span>

	<span class="cm">/* if the channel is not enabled, we don&#39;t need GO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
		<span class="n">enable_bit</span> <span class="o">=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">enable_bit</span> <span class="o">=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_bit</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dispc_mgr_is_lcd</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* GOLCD */</span>
	<span class="k">else</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="cm">/* GODIGIT */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
		<span class="n">go_bit</span> <span class="o">=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">go_bit</span> <span class="o">=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">go_bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;GO bit not down for channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;GO %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span> <span class="o">?</span> <span class="s">&quot;LCD&quot;</span> <span class="o">:</span>
		<span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span> <span class="o">?</span> <span class="s">&quot;LCD2&quot;</span> <span class="o">:</span> <span class="s">&quot;DIGIT&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_write_firh_reg</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_FIR_COEF_H</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_write_firhv_reg</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_FIR_COEF_HV</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_write_firv_reg</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_FIR_COEF_V</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_write_firh2_reg</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">plane</span> <span class="o">==</span> <span class="n">OMAP_DSS_GFX</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_FIR_COEF_H2</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_write_firhv2_reg</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">plane</span> <span class="o">==</span> <span class="n">OMAP_DSS_GFX</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_FIR_COEF_HV2</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_write_firv2_reg</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">plane</span> <span class="o">==</span> <span class="n">OMAP_DSS_GFX</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_FIR_COEF_V2</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_scale_coef</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fir_hinc</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">fir_vinc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">five_taps</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">omap_color_component</span> <span class="n">color_comp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dispc_coef</span> <span class="o">*</span><span class="n">h_coef</span><span class="p">,</span> <span class="o">*</span><span class="n">v_coef</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">h_coef</span> <span class="o">=</span> <span class="n">dispc_ovl_get_scale_coef</span><span class="p">(</span><span class="n">fir_hinc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">v_coef</span> <span class="o">=</span> <span class="n">dispc_ovl_get_scale_coef</span><span class="p">(</span><span class="n">fir_vinc</span><span class="p">,</span> <span class="n">five_taps</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">h</span><span class="p">,</span> <span class="n">hv</span><span class="p">;</span>

		<span class="n">h</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">h_coef</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hc0_vc00</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">h_coef</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hc1_vc0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">h_coef</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hc2_vc1</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">h_coef</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hc3_vc2</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">hv</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">h_coef</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hc4_vc22</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">v_coef</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hc1_vc0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">v_coef</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hc2_vc1</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">v_coef</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hc3_vc2</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">color_comp</span> <span class="o">==</span> <span class="n">DISPC_COLOR_COMPONENT_RGB_Y</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dispc_ovl_write_firh_reg</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
			<span class="n">dispc_ovl_write_firhv_reg</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hv</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dispc_ovl_write_firh2_reg</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
			<span class="n">dispc_ovl_write_firhv2_reg</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hv</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">five_taps</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">v_coef</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hc0_vc00</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">v_coef</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hc4_vc22</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">color_comp</span> <span class="o">==</span> <span class="n">DISPC_COLOR_COMPONENT_RGB_Y</span><span class="p">)</span>
				<span class="n">dispc_ovl_write_firv_reg</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dispc_ovl_write_firv2_reg</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dispc_setup_color_conv_coef</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">color_conv_coef</span> <span class="p">{</span>
		<span class="kt">int</span>  <span class="n">ry</span><span class="p">,</span>  <span class="n">rcr</span><span class="p">,</span>  <span class="n">rcb</span><span class="p">,</span>   <span class="n">gy</span><span class="p">,</span>  <span class="n">gcr</span><span class="p">,</span>  <span class="n">gcb</span><span class="p">,</span>   <span class="n">by</span><span class="p">,</span>  <span class="n">bcr</span><span class="p">,</span>  <span class="n">bcb</span><span class="p">;</span>
		<span class="kt">int</span>  <span class="n">full_range</span><span class="p">;</span>
	<span class="p">}</span>  <span class="n">ctbl_bt601_5</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">298</span><span class="p">,</span>  <span class="mi">409</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="mi">298</span><span class="p">,</span> <span class="o">-</span><span class="mi">208</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span>  <span class="mi">298</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>  <span class="mi">517</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">color_conv_coef</span> <span class="o">*</span><span class="n">ct</span><span class="p">;</span>

<span class="cp">#define CVAL(x, y) (FLD_VAL(x, 26, 16) | FLD_VAL(y, 10, 0))</span>

	<span class="n">ct</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctbl_bt601_5</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dss_feat_get_num_ovls</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_CONV_COEF</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">CVAL</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">rcr</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">ry</span><span class="p">));</span>
		<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_CONV_COEF</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			<span class="n">CVAL</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">gy</span><span class="p">,</span>  <span class="n">ct</span><span class="o">-&gt;</span><span class="n">rcb</span><span class="p">));</span>
		<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_CONV_COEF</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">CVAL</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">gcb</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">gcr</span><span class="p">));</span>
		<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_CONV_COEF</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
			<span class="n">CVAL</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">bcr</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">by</span><span class="p">));</span>
		<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_CONV_COEF</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
			<span class="n">CVAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">bcb</span><span class="p">));</span>

		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">full_range</span><span class="p">,</span>
			<span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#undef CVAL</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_ba0</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">u32</span> <span class="n">paddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_BA0</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">paddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_ba1</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">u32</span> <span class="n">paddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_BA1</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">paddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_ba0_uv</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">u32</span> <span class="n">paddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_BA0_UV</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">paddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_ba1_uv</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">u32</span> <span class="n">paddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_BA1_UV</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">paddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_pos</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_POSITION</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_pic_size</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span> <span class="o">==</span> <span class="n">OMAP_DSS_GFX</span><span class="p">)</span>
		<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_SIZE</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_PICTURE_SIZE</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_vid_size</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">plane</span> <span class="o">==</span> <span class="n">OMAP_DSS_GFX</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_SIZE</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_zorder</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">u8</span> <span class="n">zorder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_OVL_CAP_ZORDER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">zorder</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">26</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_enable_zorder_planes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ALPHA_FREE_ZORDER</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dss_feat_get_num_ovls</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_pre_mult_alpha</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_OVL_CAP_PRE_MULT_ALPHA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_setup_global_alpha</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">u8</span> <span class="n">global_alpha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">shifts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_OVL_CAP_GLOBAL_ALPHA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">plane</span><span class="p">];</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_GLOBAL_ALPHA</span><span class="p">,</span> <span class="n">global_alpha</span><span class="p">,</span> <span class="n">shift</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_pix_inc</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">s32</span> <span class="n">inc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_PIXEL_INC</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">inc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_row_inc</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">s32</span> <span class="n">inc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ROW_INC</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">inc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_color_mode</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span> <span class="o">!=</span> <span class="n">OMAP_DSS_GFX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">color_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_NV12</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBX16</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBA16</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB12U</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_ARGB16</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB16</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_ARGB16_1555</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB24U</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB24P</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_YUV2</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_UYVY</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_ARGB32</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBA32</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBX32</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xe</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_XRGB16_1555</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span> <span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">color_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT1</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT2</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT4</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT8</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB12U</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_ARGB16</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB16</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_ARGB16_1555</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB24U</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB24P</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBX16</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBA16</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_ARGB32</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBA32</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBX32</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xe</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_XRGB16_1555</span>:
			<span class="n">m</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span> <span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">m</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_configure_burst_type</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_dss_rotation_type</span> <span class="n">rotation_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_BURST_2D</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_TILER</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_ovl_set_channel_out</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chan2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">plane</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_GFX</span>:
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_VIDEO1</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_VIDEO2</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_VIDEO3</span>:
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_MGR_LCD2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span>:
			<span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">chan2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_CHANNEL_DIGIT</span>:
			<span class="n">chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">chan2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span>:
			<span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">chan2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chan2</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">omap_channel</span> <span class="nf">dispc_ovl_get_channel_out</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">plane</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_GFX</span>:
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_VIDEO1</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_VIDEO2</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_VIDEO3</span>:
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_MGR_LCD2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">channel</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_burst_size</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_burst_size</span> <span class="n">burst_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">shifts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">plane</span><span class="p">];</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">burst_size</span><span class="p">,</span> <span class="n">shift</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_configure_burst_sizes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">burst_size</span> <span class="o">=</span> <span class="n">BURST_SIZE_X8</span><span class="p">;</span>

	<span class="cm">/* Configure burst size always to maximum size */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">omap_dss_get_num_overlays</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dispc_ovl_set_burst_size</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">burst_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dispc_ovl_get_burst_size</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">dss_feat_get_burst_size_unit</span><span class="p">();</span>
	<span class="cm">/* burst multiplier is always x8 (see dispc_configure_burst_sizes()) */</span>
	<span class="k">return</span> <span class="n">unit</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_enable_gamma_table</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is partially implemented to support only disabling of</span>
<span class="cm">	 * the gamma table.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSWARN</span><span class="p">(</span><span class="s">&quot;Gamma table enabling for TV not yet supported&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_mgr_enable_cpr</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">DISPC_CONFIG</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">DISPC_CONFIG2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_mgr_set_cpr_coef</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_dss_cpr_coefs</span> <span class="o">*</span><span class="n">coefs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">coef_r</span><span class="p">,</span> <span class="n">coef_g</span><span class="p">,</span> <span class="n">coef_b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dispc_mgr_is_lcd</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">coef_r</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">coefs</span><span class="o">-&gt;</span><span class="n">rr</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">coefs</span><span class="o">-&gt;</span><span class="n">rg</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">coefs</span><span class="o">-&gt;</span><span class="n">rb</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">coef_g</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">coefs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">coefs</span><span class="o">-&gt;</span><span class="n">gg</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">coefs</span><span class="o">-&gt;</span><span class="n">gb</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">coef_b</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">coefs</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">coefs</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">coefs</span><span class="o">-&gt;</span><span class="n">bb</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_CPR_COEF_R</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">coef_r</span><span class="p">);</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_CPR_COEF_G</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">coef_g</span><span class="p">);</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_CPR_COEF_B</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">coef_b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_vid_color_conv</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">plane</span> <span class="o">==</span> <span class="n">OMAP_DSS_GFX</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_enable_replication</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">shifts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">plane</span><span class="p">];</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">enable</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_mgr_set_size</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u16</span> <span class="n">width</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_SIZE_MGR</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_read_plane_fifo_sizes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">unit</span><span class="p">;</span>

	<span class="n">unit</span> <span class="o">=</span> <span class="n">dss_feat_get_buffer_size_unit</span><span class="p">();</span>

	<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_FIFOSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">plane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">plane</span> <span class="o">&lt;</span> <span class="n">dss_feat_get_num_ovls</span><span class="p">();</span> <span class="o">++</span><span class="n">plane</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_OVL_FIFO_SIZE_STATUS</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">*=</span> <span class="n">unit</span><span class="p">;</span>
		<span class="n">dispc</span><span class="p">.</span><span class="n">fifo_size</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dispc_ovl_get_fifo_size</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dispc</span><span class="p">.</span><span class="n">fifo_size</span><span class="p">[</span><span class="n">plane</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_ovl_set_fifo_threshold</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">u32</span> <span class="n">high</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">hi_start</span><span class="p">,</span> <span class="n">hi_end</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">,</span> <span class="n">lo_end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">unit</span><span class="p">;</span>

	<span class="n">unit</span> <span class="o">=</span> <span class="n">dss_feat_get_buffer_size_unit</span><span class="p">();</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">low</span> <span class="o">%</span> <span class="n">unit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">high</span> <span class="o">%</span> <span class="n">unit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">low</span> <span class="o">/=</span> <span class="n">unit</span><span class="p">;</span>
	<span class="n">high</span> <span class="o">/=</span> <span class="n">unit</span><span class="p">;</span>

	<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_FIFOHIGHTHRESHOLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi_end</span><span class="p">);</span>
	<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_FIFOLOWTHRESHOLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo_end</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;fifo(%d) threshold (bytes), old %u/%u, new %u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">plane</span><span class="p">,</span>
			<span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_OVL_FIFO_THRESHOLD</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span>
				<span class="n">lo_start</span><span class="p">,</span> <span class="n">lo_end</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit</span><span class="p">,</span>
			<span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_OVL_FIFO_THRESHOLD</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span>
				<span class="n">hi_start</span><span class="p">,</span> <span class="n">hi_end</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit</span><span class="p">,</span>
			<span class="n">low</span> <span class="o">*</span> <span class="n">unit</span><span class="p">,</span> <span class="n">high</span> <span class="o">*</span> <span class="n">unit</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_FIFO_THRESHOLD</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span>
			<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">hi_start</span><span class="p">,</span> <span class="n">hi_end</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">,</span> <span class="n">lo_end</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_enable_fifomerge</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_FIFO_MERGE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;FIFO merge %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_ovl_compute_fifo_thresholds</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">fifo_low</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">fifo_high</span><span class="p">,</span> <span class="n">bool</span> <span class="n">use_fifomerge</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">manual_update</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * All sizes are in bytes. Both the buffer and burst are made of</span>
<span class="cm">	 * buffer_units, and the fifo thresholds must be buffer_unit aligned.</span>
<span class="cm">	 */</span>

	<span class="kt">unsigned</span> <span class="n">buf_unit</span> <span class="o">=</span> <span class="n">dss_feat_get_buffer_size_unit</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="n">ovl_fifo_size</span><span class="p">,</span> <span class="n">total_fifo_size</span><span class="p">,</span> <span class="n">burst_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">burst_size</span> <span class="o">=</span> <span class="n">dispc_ovl_get_burst_size</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">ovl_fifo_size</span> <span class="o">=</span> <span class="n">dispc_ovl_get_fifo_size</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_fifomerge</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">total_fifo_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">omap_dss_get_num_overlays</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">total_fifo_size</span> <span class="o">+=</span> <span class="n">dispc_ovl_get_fifo_size</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">total_fifo_size</span> <span class="o">=</span> <span class="n">ovl_fifo_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We use the same low threshold for both fifomerge and non-fifomerge</span>
<span class="cm">	 * cases, but for fifomerge we calculate the high threshold using the</span>
<span class="cm">	 * combined fifo size</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">manual_update</span> <span class="o">&amp;&amp;</span> <span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_OMAP3_DSI_FIFO_BUG</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">fifo_low</span> <span class="o">=</span> <span class="n">ovl_fifo_size</span> <span class="o">-</span> <span class="n">burst_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">fifo_high</span> <span class="o">=</span> <span class="n">total_fifo_size</span> <span class="o">-</span> <span class="n">burst_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">fifo_low</span> <span class="o">=</span> <span class="n">ovl_fifo_size</span> <span class="o">-</span> <span class="n">burst_size</span><span class="p">;</span>
		<span class="o">*</span><span class="n">fifo_high</span> <span class="o">=</span> <span class="n">total_fifo_size</span> <span class="o">-</span> <span class="n">buf_unit</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_fir</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">hinc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vinc</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">omap_color_component</span> <span class="n">color_comp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">color_comp</span> <span class="o">==</span> <span class="n">DISPC_COLOR_COMPONENT_RGB_Y</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">hinc_start</span><span class="p">,</span> <span class="n">hinc_end</span><span class="p">,</span> <span class="n">vinc_start</span><span class="p">,</span> <span class="n">vinc_end</span><span class="p">;</span>

		<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_FIRHINC</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hinc_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hinc_end</span><span class="p">);</span>
		<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_FIRVINC</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">vinc_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vinc_end</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vinc</span><span class="p">,</span> <span class="n">vinc_start</span><span class="p">,</span> <span class="n">vinc_end</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">hinc</span><span class="p">,</span> <span class="n">hinc_start</span><span class="p">,</span> <span class="n">hinc_end</span><span class="p">);</span>

		<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_FIR</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vinc</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">hinc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_FIR2</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_vid_accu0</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">haccu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vaccu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hor_start</span><span class="p">,</span> <span class="n">hor_end</span><span class="p">,</span> <span class="n">vert_start</span><span class="p">,</span> <span class="n">vert_end</span><span class="p">;</span>

	<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_HORIZONTALACCU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hor_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hor_end</span><span class="p">);</span>
	<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_VERTICALACCU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vert_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vert_end</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vaccu</span><span class="p">,</span> <span class="n">vert_start</span><span class="p">,</span> <span class="n">vert_end</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">haccu</span><span class="p">,</span> <span class="n">hor_start</span><span class="p">,</span> <span class="n">hor_end</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ACCU0</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_vid_accu1</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">haccu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vaccu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hor_start</span><span class="p">,</span> <span class="n">hor_end</span><span class="p">,</span> <span class="n">vert_start</span><span class="p">,</span> <span class="n">vert_end</span><span class="p">;</span>

	<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_HORIZONTALACCU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hor_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hor_end</span><span class="p">);</span>
	<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_VERTICALACCU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vert_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vert_end</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vaccu</span><span class="p">,</span> <span class="n">vert_start</span><span class="p">,</span> <span class="n">vert_end</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">haccu</span><span class="p">,</span> <span class="n">hor_start</span><span class="p">,</span> <span class="n">hor_end</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ACCU1</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_vid_accu2_0</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">haccu</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">vaccu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vaccu</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">haccu</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ACCU2_0</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_vid_accu2_1</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">haccu</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">vaccu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vaccu</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">haccu</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ACCU2_1</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_scale_param</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">orig_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">orig_height</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_height</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">five_taps</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rotation</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_color_component</span> <span class="n">color_comp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fir_hinc</span><span class="p">,</span> <span class="n">fir_vinc</span><span class="p">;</span>

	<span class="n">fir_hinc</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">orig_width</span> <span class="o">/</span> <span class="n">out_width</span><span class="p">;</span>
	<span class="n">fir_vinc</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">orig_height</span> <span class="o">/</span> <span class="n">out_height</span><span class="p">;</span>

	<span class="n">dispc_ovl_set_scale_coef</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">fir_hinc</span><span class="p">,</span> <span class="n">fir_vinc</span><span class="p">,</span> <span class="n">five_taps</span><span class="p">,</span>
				<span class="n">color_comp</span><span class="p">);</span>
	<span class="n">dispc_ovl_set_fir</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">fir_hinc</span><span class="p">,</span> <span class="n">fir_vinc</span><span class="p">,</span> <span class="n">color_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_accu_uv</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">orig_width</span><span class="p">,</span>	<span class="n">u16</span> <span class="n">orig_height</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_height</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">ilace</span><span class="p">,</span> <span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rotation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">h_accu2_0</span><span class="p">,</span> <span class="n">h_accu2_1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v_accu2_0</span><span class="p">,</span> <span class="n">v_accu2_1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chroma_hinc</span><span class="p">,</span> <span class="n">chroma_vinc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">accu</span> <span class="p">{</span>
		<span class="n">s8</span> <span class="n">h0_m</span><span class="p">,</span> <span class="n">h0_n</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">h1_m</span><span class="p">,</span> <span class="n">h1_n</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">v0_m</span><span class="p">,</span> <span class="n">v0_n</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">v1_m</span><span class="p">,</span> <span class="n">v1_n</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">accu</span> <span class="o">*</span><span class="n">accu_table</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">accu</span> <span class="o">*</span><span class="n">accu_val</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">accu</span> <span class="n">accu_nv12</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">accu</span> <span class="n">accu_nv12_ilace</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
		<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
		<span class="p">{</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">accu</span> <span class="n">accu_yuv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rotation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_0</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_90</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_180</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_270</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">color_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_NV12</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ilace</span><span class="p">)</span>
			<span class="n">accu_table</span> <span class="o">=</span> <span class="n">accu_nv12_ilace</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">accu_table</span> <span class="o">=</span> <span class="n">accu_nv12</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_YUV2</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_UYVY</span>:
		<span class="n">accu_table</span> <span class="o">=</span> <span class="n">accu_yuv</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">accu_val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">accu_table</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">chroma_hinc</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">orig_width</span> <span class="o">/</span> <span class="n">out_width</span><span class="p">;</span>
	<span class="n">chroma_vinc</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">orig_height</span> <span class="o">/</span> <span class="n">out_height</span><span class="p">;</span>

	<span class="n">h_accu2_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">accu_val</span><span class="o">-&gt;</span><span class="n">h0_m</span> <span class="o">*</span> <span class="n">chroma_hinc</span> <span class="o">/</span> <span class="n">accu_val</span><span class="o">-&gt;</span><span class="n">h0_n</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">h_accu2_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">accu_val</span><span class="o">-&gt;</span><span class="n">h1_m</span> <span class="o">*</span> <span class="n">chroma_hinc</span> <span class="o">/</span> <span class="n">accu_val</span><span class="o">-&gt;</span><span class="n">h1_n</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">v_accu2_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">accu_val</span><span class="o">-&gt;</span><span class="n">v0_m</span> <span class="o">*</span> <span class="n">chroma_vinc</span> <span class="o">/</span> <span class="n">accu_val</span><span class="o">-&gt;</span><span class="n">v0_n</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">v_accu2_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">accu_val</span><span class="o">-&gt;</span><span class="n">v1_m</span> <span class="o">*</span> <span class="n">chroma_vinc</span> <span class="o">/</span> <span class="n">accu_val</span><span class="o">-&gt;</span><span class="n">v1_n</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="n">dispc_ovl_set_vid_accu2_0</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">h_accu2_0</span><span class="p">,</span> <span class="n">v_accu2_0</span><span class="p">);</span>
	<span class="n">dispc_ovl_set_vid_accu2_1</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">h_accu2_1</span><span class="p">,</span> <span class="n">v_accu2_1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_scaling_common</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">orig_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">orig_height</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_height</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">ilace</span><span class="p">,</span> <span class="n">bool</span> <span class="n">five_taps</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">fieldmode</span><span class="p">,</span> <span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">rotation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">accu0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">accu1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">dispc_ovl_set_scale_param</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">orig_width</span><span class="p">,</span> <span class="n">orig_height</span><span class="p">,</span>
				<span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">,</span> <span class="n">five_taps</span><span class="p">,</span>
				<span class="n">rotation</span><span class="p">,</span> <span class="n">DISPC_COLOR_COMPONENT_RGB_Y</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">));</span>

	<span class="cm">/* RESIZEENABLE and VERTICALTAPS */</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">));</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">orig_width</span> <span class="o">!=</span> <span class="n">out_width</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">orig_height</span> <span class="o">!=</span> <span class="n">out_height</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">five_taps</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* VRESIZECONF and HRESIZECONF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_RESIZECONF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">orig_width</span> <span class="o">&lt;=</span> <span class="n">out_width</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">orig_height</span> <span class="o">&lt;=</span> <span class="n">out_height</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* LINEBUFFERSPLIT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_LINEBUFFERSPLIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">five_taps</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">l</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * field 0 = even field = bottom field</span>
<span class="cm">	 * field 1 = odd field = top field</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ilace</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fieldmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">accu1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">accu0</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1024</span> <span class="o">*</span> <span class="n">orig_height</span> <span class="o">/</span> <span class="n">out_height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">accu0</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">accu1</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
			<span class="n">accu0</span> <span class="o">-=</span> <span class="n">accu1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dispc_ovl_set_vid_accu0</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">accu0</span><span class="p">);</span>
	<span class="n">dispc_ovl_set_vid_accu1</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">accu1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_scaling_uv</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">orig_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">orig_height</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_height</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">ilace</span><span class="p">,</span> <span class="n">bool</span> <span class="n">five_taps</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">fieldmode</span><span class="p">,</span> <span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">rotation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">scale_x</span> <span class="o">=</span> <span class="n">out_width</span> <span class="o">!=</span> <span class="n">orig_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scale_y</span> <span class="o">=</span> <span class="n">out_height</span> <span class="o">!=</span> <span class="n">orig_height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_HANDLE_UV_SEPARATE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">color_mode</span> <span class="o">!=</span> <span class="n">OMAP_DSS_COLOR_YUV2</span> <span class="o">&amp;&amp;</span>
			<span class="n">color_mode</span> <span class="o">!=</span> <span class="n">OMAP_DSS_COLOR_UYVY</span> <span class="o">&amp;&amp;</span>
			<span class="n">color_mode</span> <span class="o">!=</span> <span class="n">OMAP_DSS_COLOR_NV12</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* reset chroma resampling for RGB formats  */</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES2</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dispc_ovl_set_accu_uv</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">orig_width</span><span class="p">,</span> <span class="n">orig_height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">,</span>
			<span class="n">out_height</span><span class="p">,</span> <span class="n">ilace</span><span class="p">,</span> <span class="n">color_mode</span><span class="p">,</span> <span class="n">rotation</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">color_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_NV12</span>:
		<span class="cm">/* UV is subsampled by 2 vertically*/</span>
		<span class="n">orig_height</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* UV is subsampled by 2 horz.*/</span>
		<span class="n">orig_width</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_YUV2</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_UYVY</span>:
		<span class="cm">/*For YUV422 with 90/270 rotation,</span>
<span class="cm">		 *we don&#39;t upsample chroma</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_0</span> <span class="o">||</span>
			<span class="n">rotation</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_180</span><span class="p">)</span>
			<span class="cm">/* UV is subsampled by 2 hrz*/</span>
			<span class="n">orig_width</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* must use FIR for YUV422 if rotated */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">!=</span> <span class="n">OMAP_DSS_ROT_0</span><span class="p">)</span>
			<span class="n">scale_x</span> <span class="o">=</span> <span class="n">scale_y</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out_width</span> <span class="o">!=</span> <span class="n">orig_width</span><span class="p">)</span>
		<span class="n">scale_x</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out_height</span> <span class="o">!=</span> <span class="n">orig_height</span><span class="p">)</span>
		<span class="n">scale_y</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">dispc_ovl_set_scale_param</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">orig_width</span><span class="p">,</span> <span class="n">orig_height</span><span class="p">,</span>
			<span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">,</span> <span class="n">five_taps</span><span class="p">,</span>
				<span class="n">rotation</span><span class="p">,</span> <span class="n">DISPC_COLOR_COMPONENT_UV</span><span class="p">);</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES2</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span>
		<span class="p">(</span><span class="n">scale_x</span> <span class="o">||</span> <span class="n">scale_y</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* set H scaling */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">scale_x</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="cm">/* set V scaling */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">scale_y</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_scaling</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">orig_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">orig_height</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_height</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">ilace</span><span class="p">,</span> <span class="n">bool</span> <span class="n">five_taps</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">fieldmode</span><span class="p">,</span> <span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">rotation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">plane</span> <span class="o">==</span> <span class="n">OMAP_DSS_GFX</span><span class="p">);</span>

	<span class="n">dispc_ovl_set_scaling_common</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span>
			<span class="n">orig_width</span><span class="p">,</span> <span class="n">orig_height</span><span class="p">,</span>
			<span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">,</span>
			<span class="n">ilace</span><span class="p">,</span> <span class="n">five_taps</span><span class="p">,</span>
			<span class="n">fieldmode</span><span class="p">,</span> <span class="n">color_mode</span><span class="p">,</span>
			<span class="n">rotation</span><span class="p">);</span>

	<span class="n">dispc_ovl_set_scaling_uv</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span>
		<span class="n">orig_width</span><span class="p">,</span> <span class="n">orig_height</span><span class="p">,</span>
		<span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">,</span>
		<span class="n">ilace</span><span class="p">,</span> <span class="n">five_taps</span><span class="p">,</span>
		<span class="n">fieldmode</span><span class="p">,</span> <span class="n">color_mode</span><span class="p">,</span>
		<span class="n">rotation</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_ovl_set_rotation_attrs</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rotation</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">mirroring</span><span class="p">,</span> <span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">row_repeat</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vidrot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_YUV2</span> <span class="o">||</span>
			<span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_UYVY</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mirroring</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">rotation</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OMAP_DSS_ROT_0</span>:
				<span class="n">vidrot</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OMAP_DSS_ROT_90</span>:
				<span class="n">vidrot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OMAP_DSS_ROT_180</span>:
				<span class="n">vidrot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OMAP_DSS_ROT_270</span>:
				<span class="n">vidrot</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">rotation</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OMAP_DSS_ROT_0</span>:
				<span class="n">vidrot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OMAP_DSS_ROT_90</span>:
				<span class="n">vidrot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OMAP_DSS_ROT_180</span>:
				<span class="n">vidrot</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OMAP_DSS_ROT_270</span>:
				<span class="n">vidrot</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_90</span> <span class="o">||</span> <span class="n">rotation</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_270</span><span class="p">)</span>
			<span class="n">row_repeat</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">row_repeat</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">vidrot</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ROWREPEATENABLE</span><span class="p">))</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span>
			<span class="n">row_repeat</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">color_mode_to_bpp</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">color_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT1</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT2</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT4</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT8</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_NV12</span>:
		<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB12U</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB16</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_ARGB16</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_YUV2</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_UYVY</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBA16</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBX16</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_ARGB16_1555</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_XRGB16_1555</span>:
		<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB24P</span>:
		<span class="k">return</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGB24U</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_ARGB32</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBA32</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_RGBX32</span>:
		<span class="k">return</span> <span class="mi">32</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">pixinc</span><span class="p">(</span><span class="kt">int</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pixels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pixels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">pixels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pixels</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calc_vrfb_rotation_offset</span><span class="p">(</span><span class="n">u8</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mirror</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">screen_width</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">height</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">,</span> <span class="n">bool</span> <span class="n">fieldmode</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field_offset</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="o">*</span><span class="n">offset0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">offset1</span><span class="p">,</span>
		<span class="n">s32</span> <span class="o">*</span><span class="n">row_inc</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">pix_inc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x_predecim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y_predecim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ps</span><span class="p">;</span>

	<span class="cm">/* FIXME CLUT formats */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">color_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT1</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT2</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT4</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT8</span>:
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_YUV2</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_UYVY</span>:
		<span class="n">ps</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ps</span> <span class="o">=</span> <span class="n">color_mode_to_bpp</span><span class="p">(</span><span class="n">color_mode</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;calc_rot(%d): scrw %d, %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">screen_width</span><span class="p">,</span>
			<span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * field 0 = even field = bottom field</span>
<span class="cm">	 * field 1 = odd field = top field</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">+</span> <span class="n">mirror</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_0</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_180</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If the pixel format is YUV or UYVY divide the width</span>
<span class="cm">		 * of the image by 2 for 0 and 180 degree rotation.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_YUV2</span> <span class="o">||</span>
			<span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_UYVY</span><span class="p">)</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_90</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_270</span>:
		<span class="o">*</span><span class="n">offset1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_offset</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="n">field_offset</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="o">*</span><span class="n">row_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">y_predecim</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">-</span> <span class="n">x_predecim</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">fieldmode</span> <span class="o">?</span> <span class="n">screen_width</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ps</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">x_predecim</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_0</span> <span class="o">+</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_180</span> <span class="o">+</span> <span class="mi">4</span>:
		<span class="cm">/* If the pixel format is YUV or UYVY divide the width</span>
<span class="cm">		 * of the image by 2  for 0 degree and 180 degree</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_YUV2</span> <span class="o">||</span>
			<span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_UYVY</span><span class="p">)</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_90</span> <span class="o">+</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_270</span> <span class="o">+</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="n">offset1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_offset</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="n">field_offset</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">row_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">y_predecim</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">+</span> <span class="n">x_predecim</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">fieldmode</span> <span class="o">?</span> <span class="n">screen_width</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ps</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">x_predecim</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calc_dma_rotation_offset</span><span class="p">(</span><span class="n">u8</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mirror</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">screen_width</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">height</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">,</span> <span class="n">bool</span> <span class="n">fieldmode</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field_offset</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="o">*</span><span class="n">offset0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">offset1</span><span class="p">,</span>
		<span class="n">s32</span> <span class="o">*</span><span class="n">row_inc</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">pix_inc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x_predecim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y_predecim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ps</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fbw</span><span class="p">,</span> <span class="n">fbh</span><span class="p">;</span>

	<span class="cm">/* FIXME CLUT formats */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">color_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT1</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT2</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT4</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT8</span>:
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ps</span> <span class="o">=</span> <span class="n">color_mode_to_bpp</span><span class="p">(</span><span class="n">color_mode</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;calc_rot(%d): scrw %d, %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">screen_width</span><span class="p">,</span>
			<span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="cm">/* width &amp; height are overlay sizes, convert to fb sizes */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_0</span> <span class="o">||</span> <span class="n">rotation</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_180</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbw</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">fbh</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fbw</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">fbh</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * field 0 = even field = bottom field</span>
<span class="cm">	 * field 1 = odd field = top field</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">+</span> <span class="n">mirror</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_0</span>:
		<span class="o">*</span><span class="n">offset1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_offset</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span> <span class="o">+</span> <span class="n">field_offset</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">row_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">y_predecim</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">-</span> <span class="n">fbw</span> <span class="o">*</span> <span class="n">x_predecim</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">fieldmode</span> <span class="o">?</span> <span class="n">screen_width</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>	<span class="n">ps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_YUV2</span> <span class="o">||</span>
			<span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_UYVY</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">x_predecim</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">x_predecim</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_90</span>:
		<span class="o">*</span><span class="n">offset1</span> <span class="o">=</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">fbh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_offset</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span> <span class="o">+</span> <span class="n">field_offset</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">row_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">screen_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">fbh</span> <span class="o">*</span> <span class="n">x_predecim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">y_predecim</span> <span class="o">+</span> <span class="p">(</span><span class="n">fieldmode</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ps</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="o">-</span><span class="n">x_predecim</span> <span class="o">*</span> <span class="n">screen_width</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_180</span>:
		<span class="o">*</span><span class="n">offset1</span> <span class="o">=</span> <span class="p">(</span><span class="n">screen_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">fbh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fbw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_offset</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span> <span class="o">-</span> <span class="n">field_offset</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">row_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">y_predecim</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">-</span> <span class="n">fbw</span> <span class="o">*</span> <span class="n">x_predecim</span><span class="p">)</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">fieldmode</span> <span class="o">?</span> <span class="n">screen_width</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>	<span class="n">ps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_YUV2</span> <span class="o">||</span>
			<span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_UYVY</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="o">-</span><span class="n">x_predecim</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="o">-</span><span class="n">x_predecim</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_270</span>:
		<span class="o">*</span><span class="n">offset1</span> <span class="o">=</span> <span class="p">(</span><span class="n">fbw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_offset</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span> <span class="o">-</span> <span class="n">field_offset</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">row_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="o">-</span><span class="n">screen_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">fbh</span> <span class="o">*</span> <span class="n">x_predecim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">y_predecim</span> <span class="o">-</span> <span class="p">(</span><span class="n">fieldmode</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ps</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">x_predecim</span> <span class="o">*</span> <span class="n">screen_width</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* mirroring */</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_0</span> <span class="o">+</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="n">offset1</span> <span class="o">=</span> <span class="p">(</span><span class="n">fbw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_offset</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span> <span class="o">+</span> <span class="n">field_offset</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">row_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">y_predecim</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">fieldmode</span> <span class="o">?</span> <span class="n">screen_width</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">ps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_YUV2</span> <span class="o">||</span>
			<span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_UYVY</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="o">-</span><span class="n">x_predecim</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="o">-</span><span class="n">x_predecim</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_90</span> <span class="o">+</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="n">offset1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_offset</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span> <span class="o">+</span> <span class="n">field_offset</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">row_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="o">-</span><span class="n">screen_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">fbh</span> <span class="o">*</span> <span class="n">x_predecim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">y_predecim</span> <span class="o">+</span> <span class="p">(</span><span class="n">fieldmode</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">ps</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">x_predecim</span> <span class="o">*</span> <span class="n">screen_width</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_180</span> <span class="o">+</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="n">offset1</span> <span class="o">=</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">fbh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_offset</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span> <span class="o">-</span> <span class="n">field_offset</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">row_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_predecim</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">fieldmode</span> <span class="o">?</span> <span class="n">screen_width</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">ps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_YUV2</span> <span class="o">||</span>
			<span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_UYVY</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">x_predecim</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">x_predecim</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_ROT_270</span> <span class="o">+</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="n">offset1</span> <span class="o">=</span> <span class="p">(</span><span class="n">screen_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">fbh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fbw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_offset</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span> <span class="o">-</span> <span class="n">field_offset</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">row_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">screen_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">fbh</span> <span class="o">*</span> <span class="n">x_predecim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">y_predecim</span> <span class="o">-</span> <span class="p">(</span><span class="n">fieldmode</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">ps</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="o">-</span><span class="n">x_predecim</span> <span class="o">*</span> <span class="n">screen_width</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calc_tiler_rotation_offset</span><span class="p">(</span><span class="n">u16</span> <span class="n">screen_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">width</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">,</span> <span class="n">bool</span> <span class="n">fieldmode</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field_offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">offset0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">offset1</span><span class="p">,</span>
		<span class="n">s32</span> <span class="o">*</span><span class="n">row_inc</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">pix_inc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x_predecim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y_predecim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ps</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">color_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT1</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT2</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT4</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_COLOR_CLUT8</span>:
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ps</span> <span class="o">=</span> <span class="n">color_mode_to_bpp</span><span class="p">(</span><span class="n">color_mode</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;scrw %d, width %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">screen_width</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * field 0 = even field = bottom field</span>
<span class="cm">	 * field 1 = odd field = top field</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">offset1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">field_offset</span><span class="p">)</span>
		<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span> <span class="o">+</span> <span class="n">field_offset</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="n">ps</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">offset0</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">row_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_predecim</span> <span class="o">*</span> <span class="n">screen_width</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">x_predecim</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">fieldmode</span> <span class="o">?</span> <span class="n">screen_width</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_YUV2</span> <span class="o">||</span>
		<span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_UYVY</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">x_predecim</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ps</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">pix_inc</span> <span class="o">=</span> <span class="n">pixinc</span><span class="p">(</span><span class="n">x_predecim</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is used to avoid synclosts in OMAP3, because of some</span>
<span class="cm"> * undocumented horizontal position and timing related limitations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_horiz_timing_omap3</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pos_x</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">height</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">DS</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">out_height</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nonactive</span><span class="p">,</span> <span class="n">lclk</span><span class="p">,</span> <span class="n">pclk</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span> <span class="p">};</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="n">blank</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nonactive</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">+</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">hfp</span> <span class="o">+</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">hsw</span> <span class="o">+</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">hbp</span> <span class="o">-</span> <span class="n">out_width</span><span class="p">;</span>
	<span class="n">pclk</span> <span class="o">=</span> <span class="n">dispc_mgr_pclk_rate</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dispc_mgr_is_lcd</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span>
		<span class="n">lclk</span> <span class="o">=</span> <span class="n">dispc_mgr_lclk_rate</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lclk</span> <span class="o">=</span> <span class="n">dispc_fclk_rate</span><span class="p">();</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out_height</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">)</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out_width</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">)</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="n">blank</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">hbp</span> <span class="o">+</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">hsw</span> <span class="o">+</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">hfp</span><span class="p">)</span> <span class="o">*</span> <span class="n">lclk</span><span class="p">,</span> <span class="n">pclk</span><span class="p">);</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;blanking period + ppl = %llu (limit = %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="p">,</span> <span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blank</span> <span class="o">&lt;=</span> <span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Pixel data should be prepared before visible display point starts.</span>
<span class="cm">	 * So, atleast DS-2 lines must have already been fetched by DISPC</span>
<span class="cm">	 * during nonactive - pos_x period.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">nonactive</span> <span class="o">-</span> <span class="n">pos_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">lclk</span><span class="p">,</span> <span class="n">pclk</span><span class="p">);</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;(nonactive - pos_x) * pcd = %llu max(0, DS - 2) * width = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">val</span><span class="p">,</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DS</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DS</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * All lines need to be refilled during the nonactive period of which</span>
<span class="cm">	 * only one line can be loaded during the active period. So, atleast</span>
<span class="cm">	 * DS - 1 lines should be loaded during nonactive period.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span>  <span class="n">div_u64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">nonactive</span> <span class="o">*</span> <span class="n">lclk</span><span class="p">,</span> <span class="n">pclk</span><span class="p">);</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;nonactive * pcd  = %llu, max(0, DS - 1) * width = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">val</span><span class="p">,</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">calc_core_clk_five_taps</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">mgr_timings</span><span class="p">,</span> <span class="n">u16</span> <span class="n">width</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">height</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_height</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">core_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">pclk</span> <span class="o">=</span> <span class="n">dispc_mgr_pclk_rate</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="n">out_height</span> <span class="o">&amp;&amp;</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="n">out_width</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pclk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">out_height</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ppl</span> <span class="o">=</span> <span class="n">mgr_timings</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">pclk</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="n">out_width</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">out_height</span> <span class="o">*</span> <span class="n">ppl</span><span class="p">);</span>
		<span class="n">core_clk</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">out_height</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppl</span> <span class="o">==</span> <span class="n">out_width</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">pclk</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">out_height</span><span class="p">)</span> <span class="o">*</span> <span class="n">out_width</span><span class="p">;</span>
			<span class="n">do_div</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">out_height</span> <span class="o">*</span> <span class="p">(</span><span class="n">ppl</span> <span class="o">-</span> <span class="n">out_width</span><span class="p">));</span>
			<span class="n">core_clk</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">core_clk</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">out_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">pclk</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">out_width</span><span class="p">);</span>
		<span class="n">core_clk</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">core_clk</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_RGB24U</span><span class="p">)</span>
			<span class="n">core_clk</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">core_clk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">calc_core_clk</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u16</span> <span class="n">width</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">height</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hf</span><span class="p">,</span> <span class="n">vf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pclk</span> <span class="o">=</span> <span class="n">dispc_mgr_pclk_rate</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME how to determine the &#39;A&#39; factor</span>
<span class="cm">	 * for the no downscaling case ?</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">out_width</span><span class="p">)</span>
		<span class="n">hf</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">out_width</span><span class="p">)</span>
		<span class="n">hf</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">out_width</span><span class="p">)</span>
		<span class="n">hf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">out_height</span><span class="p">)</span>
		<span class="n">vf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vf</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">hf</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pclk</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">pclk</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap34xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">pclk</span> <span class="o">*</span> <span class="n">vf</span> <span class="o">*</span> <span class="n">hf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hf</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">pclk</span><span class="p">,</span> <span class="n">out_width</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">pclk</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dispc_ovl_calc_scaling</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">mgr_timings</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">height</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">out_height</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_color_mode</span> <span class="n">color_mode</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">five_taps</span><span class="p">,</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">x_predecim</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y_predecim</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pos_x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">maxdownscale</span> <span class="o">=</span> <span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_DOWNSCALE</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">maxsinglelinewidth</span> <span class="o">=</span>
				<span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_LINEWIDTH</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max_decim_limit</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">core_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">decim_x</span><span class="p">,</span> <span class="n">decim_y</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">min_factor</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">in_width</span><span class="p">,</span> <span class="n">in_height</span><span class="p">,</span> <span class="n">in_width_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="n">out_width</span> <span class="o">&amp;&amp;</span> <span class="n">height</span> <span class="o">==</span> <span class="n">out_height</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_OVL_CAP_SCALE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">x_predecim</span> <span class="o">=</span> <span class="n">max_decim_limit</span><span class="p">;</span>
	<span class="o">*</span><span class="n">y_predecim</span> <span class="o">=</span> <span class="n">max_decim_limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_CLUT1</span> <span class="o">||</span>
	    <span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_CLUT2</span> <span class="o">||</span>
	    <span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_CLUT4</span> <span class="o">||</span>
	    <span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_CLUT8</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">x_predecim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">y_predecim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">five_taps</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">decim_x</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">out_width</span><span class="p">),</span> <span class="n">maxdownscale</span><span class="p">);</span>
	<span class="n">decim_y</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">out_height</span><span class="p">),</span> <span class="n">maxdownscale</span><span class="p">);</span>

	<span class="n">min_factor</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">decim_x</span><span class="p">,</span> <span class="n">decim_y</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">decim_x</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">x_predecim</span> <span class="o">||</span> <span class="n">out_width</span> <span class="o">&gt;</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">decim_y</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">y_predecim</span> <span class="o">||</span> <span class="n">out_height</span> <span class="o">&gt;</span> <span class="n">height</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">five_taps</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">in_height</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">decim_y</span><span class="p">);</span>
			<span class="n">in_width</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">decim_x</span><span class="p">);</span>
			<span class="n">core_clk</span> <span class="o">=</span> <span class="n">calc_core_clk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span> <span class="n">in_height</span><span class="p">,</span>
					<span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_width</span> <span class="o">&gt;</span> <span class="n">maxsinglelinewidth</span> <span class="o">||</span> <span class="o">!</span><span class="n">core_clk</span> <span class="o">||</span>
				<span class="n">core_clk</span> <span class="o">&gt;</span> <span class="n">dispc_core_clk_rate</span><span class="p">());</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">decim_x</span> <span class="o">==</span> <span class="n">decim_y</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">decim_x</span> <span class="o">=</span> <span class="n">min_factor</span><span class="p">;</span>
					<span class="n">decim_y</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">swap</span><span class="p">(</span><span class="n">decim_x</span><span class="p">,</span> <span class="n">decim_y</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">decim_x</span> <span class="o">&lt;</span> <span class="n">decim_y</span><span class="p">)</span>
						<span class="n">decim_x</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">decim_x</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">x_predecim</span> <span class="o">&amp;&amp;</span> <span class="n">decim_y</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">y_predecim</span> <span class="o">&amp;&amp;</span>
				<span class="n">error</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in_width</span> <span class="o">&gt;</span> <span class="n">maxsinglelinewidth</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Cannot scale max input width exceeded&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap34xx</span><span class="p">())</span> <span class="p">{</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">in_height</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">decim_y</span><span class="p">);</span>
			<span class="n">in_width</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">decim_x</span><span class="p">);</span>
			<span class="n">core_clk</span> <span class="o">=</span> <span class="n">calc_core_clk_five_taps</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">mgr_timings</span><span class="p">,</span>
				<span class="n">in_width</span><span class="p">,</span> <span class="n">in_height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">,</span>
				<span class="n">color_mode</span><span class="p">);</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">check_horiz_timing_omap3</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">mgr_timings</span><span class="p">,</span>
				<span class="n">pos_x</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span> <span class="n">in_height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">,</span>
				<span class="n">out_height</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">in_width</span> <span class="o">&gt;</span> <span class="n">maxsinglelinewidth</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">in_height</span> <span class="o">&gt;</span> <span class="n">out_height</span> <span class="o">&amp;&amp;</span>
					<span class="n">in_height</span> <span class="o">&lt;</span> <span class="n">out_height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
					<span class="o">*</span><span class="n">five_taps</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">five_taps</span><span class="p">)</span>
				<span class="n">core_clk</span> <span class="o">=</span> <span class="n">calc_core_clk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span>
					<span class="n">in_height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="n">in_width</span> <span class="o">&gt;</span> <span class="n">maxsinglelinewidth</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">in_width</span> <span class="o">&gt;</span> <span class="n">maxsinglelinewidth</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">five_taps</span><span class="p">)</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">core_clk</span> <span class="o">||</span> <span class="n">core_clk</span> <span class="o">&gt;</span> <span class="n">dispc_core_clk_rate</span><span class="p">());</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">decim_x</span> <span class="o">==</span> <span class="n">decim_y</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">decim_x</span> <span class="o">=</span> <span class="n">min_factor</span><span class="p">;</span>
					<span class="n">decim_y</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">swap</span><span class="p">(</span><span class="n">decim_x</span><span class="p">,</span> <span class="n">decim_y</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">decim_x</span> <span class="o">&lt;</span> <span class="n">decim_y</span><span class="p">)</span>
						<span class="n">decim_x</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">decim_x</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">x_predecim</span> <span class="o">&amp;&amp;</span> <span class="n">decim_y</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">y_predecim</span>
			<span class="o">&amp;&amp;</span> <span class="n">error</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">check_horiz_timing_omap3</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">mgr_timings</span><span class="p">,</span> <span class="n">pos_x</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
			<span class="n">height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">)){</span>
				<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;horizontal timing too tight</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in_width</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">maxsinglelinewidth</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Cannot setup scaling&quot;</span><span class="p">);</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;width exceeds maximum width possible&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in_width</span> <span class="o">&gt;</span> <span class="n">maxsinglelinewidth</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">five_taps</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;cannot setup scaling with five taps&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">decim_x_min</span> <span class="o">=</span> <span class="n">decim_x</span><span class="p">;</span>
		<span class="n">in_height</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">decim_y</span><span class="p">);</span>
		<span class="n">in_width_max</span> <span class="o">=</span> <span class="n">dispc_core_clk_rate</span><span class="p">()</span> <span class="o">/</span>
				<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">dispc_mgr_pclk_rate</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
						<span class="n">out_width</span><span class="p">);</span>
		<span class="n">decim_x</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">in_width_max</span><span class="p">);</span>

		<span class="n">decim_x</span> <span class="o">=</span> <span class="n">decim_x</span> <span class="o">&gt;</span> <span class="n">decim_x_min</span> <span class="o">?</span> <span class="n">decim_x</span> <span class="o">:</span> <span class="n">decim_x_min</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">decim_x</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">x_predecim</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">in_width</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">decim_x</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">decim_x</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">x_predecim</span> <span class="o">&amp;&amp;</span>
				<span class="n">in_width</span> <span class="o">&gt;</span> <span class="n">maxsinglelinewidth</span> <span class="o">&amp;&amp;</span> <span class="n">decim_x</span><span class="o">++</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in_width</span> <span class="o">&gt;</span> <span class="n">maxsinglelinewidth</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Cannot scale width exceeds max line width&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">core_clk</span> <span class="o">=</span> <span class="n">calc_core_clk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span> <span class="n">in_height</span><span class="p">,</span>
				<span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;required core clk rate = %lu Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">core_clk</span><span class="p">);</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;current core clk rate = %lu Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dispc_core_clk_rate</span><span class="p">());</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">core_clk</span> <span class="o">||</span> <span class="n">core_clk</span> <span class="o">&gt;</span> <span class="n">dispc_core_clk_rate</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to set up scaling, &quot;</span>
			<span class="s">&quot;required core clk rate = %lu Hz, &quot;</span>
			<span class="s">&quot;current core clk rate = %lu Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">core_clk</span><span class="p">,</span> <span class="n">dispc_core_clk_rate</span><span class="p">());</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">x_predecim</span> <span class="o">=</span> <span class="n">decim_x</span><span class="p">;</span>
	<span class="o">*</span><span class="n">y_predecim</span> <span class="o">=</span> <span class="n">decim_y</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dispc_ovl_setup</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_overlay_info</span> <span class="o">*</span><span class="n">oi</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">ilace</span><span class="p">,</span> <span class="n">bool</span> <span class="n">replication</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">mgr_timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">five_taps</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fieldmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">cconv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset0</span><span class="p">,</span> <span class="n">offset1</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">row_inc</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">pix_inc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">frame_height</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">in_height</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">in_width</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x_predecim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_predecim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">dispc_ovl_get_channel_out</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dispc_ovl_setup %d, pa %x, pa_uv %x, sw %d, %d,%d, %dx%d -&gt; &quot;</span>
		<span class="s">&quot;%dx%d, cmode %x, rot %d, mir %d, ilace %d chan %d repl %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">p_uv_addr</span><span class="p">,</span>
		<span class="n">oi</span><span class="o">-&gt;</span><span class="n">screen_width</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">pos_x</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">pos_y</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
		<span class="n">oi</span><span class="o">-&gt;</span><span class="n">out_width</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">out_height</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">,</span>
		<span class="n">oi</span><span class="o">-&gt;</span><span class="n">mirror</span><span class="p">,</span> <span class="n">ilace</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">replication</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">out_width</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">out_width</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">:</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">out_width</span><span class="p">;</span>
	<span class="n">out_height</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">out_height</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">:</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">out_height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ilace</span> <span class="o">&amp;&amp;</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">==</span> <span class="n">out_height</span><span class="p">)</span>
		<span class="n">fieldmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ilace</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fieldmode</span><span class="p">)</span>
			<span class="n">in_height</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">oi</span><span class="o">-&gt;</span><span class="n">pos_y</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">out_height</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;adjusting for ilace: height %d, pos_y %d, &quot;</span>
				<span class="s">&quot;out_height %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">in_height</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">pos_y</span><span class="p">,</span> <span class="n">out_height</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dss_feat_color_mode_supported</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dispc_ovl_calc_scaling</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">mgr_timings</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span>
			<span class="n">in_height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">five_taps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x_predecim</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y_predecim</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">pos_x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">in_width</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">in_width</span><span class="p">,</span> <span class="n">x_predecim</span><span class="p">);</span>
	<span class="n">in_height</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">in_height</span><span class="p">,</span> <span class="n">y_predecim</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_YUV2</span> <span class="o">||</span>
			<span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_UYVY</span> <span class="o">||</span>
			<span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_COLOR_NV12</span><span class="p">)</span>
		<span class="n">cconv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ilace</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fieldmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * when downscaling the bottom field may have to start several</span>
<span class="cm">		 * source lines below the top field. Unfortunately ACCUI</span>
<span class="cm">		 * registers will only hold the fractional part of the offset</span>
<span class="cm">		 * so the integer part must be added to the base address of the</span>
<span class="cm">		 * bottom field.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_height</span> <span class="o">||</span> <span class="n">in_height</span> <span class="o">==</span> <span class="n">out_height</span><span class="p">)</span>
			<span class="n">field_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">field_offset</span> <span class="o">=</span> <span class="n">in_height</span> <span class="o">/</span> <span class="n">out_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fields are independent but interleaved in memory. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fieldmode</span><span class="p">)</span>
		<span class="n">field_offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">offset0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">offset1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">row_inc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pix_inc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_TILER</span><span class="p">)</span>
		<span class="n">calc_tiler_rotation_offset</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">screen_width</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span>
				<span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">,</span> <span class="n">fieldmode</span><span class="p">,</span> <span class="n">field_offset</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">offset0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">row_inc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pix_inc</span><span class="p">,</span>
				<span class="n">x_predecim</span><span class="p">,</span> <span class="n">y_predecim</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">rotation_type</span> <span class="o">==</span> <span class="n">OMAP_DSS_ROT_DMA</span><span class="p">)</span>
		<span class="n">calc_dma_rotation_offset</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">mirror</span><span class="p">,</span>
				<span class="n">oi</span><span class="o">-&gt;</span><span class="n">screen_width</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span> <span class="n">frame_height</span><span class="p">,</span>
				<span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">,</span> <span class="n">fieldmode</span><span class="p">,</span> <span class="n">field_offset</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">offset0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">row_inc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pix_inc</span><span class="p">,</span>
				<span class="n">x_predecim</span><span class="p">,</span> <span class="n">y_predecim</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">calc_vrfb_rotation_offset</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">mirror</span><span class="p">,</span>
				<span class="n">oi</span><span class="o">-&gt;</span><span class="n">screen_width</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span> <span class="n">frame_height</span><span class="p">,</span>
				<span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">,</span> <span class="n">fieldmode</span><span class="p">,</span> <span class="n">field_offset</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">offset0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">row_inc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pix_inc</span><span class="p">,</span>
				<span class="n">x_predecim</span><span class="p">,</span> <span class="n">y_predecim</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;offset0 %u, offset1 %u, row_inc %d, pix_inc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">offset0</span><span class="p">,</span> <span class="n">offset1</span><span class="p">,</span> <span class="n">row_inc</span><span class="p">,</span> <span class="n">pix_inc</span><span class="p">);</span>

	<span class="n">dispc_ovl_set_color_mode</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">);</span>

	<span class="n">dispc_ovl_configure_burst_type</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">rotation_type</span><span class="p">);</span>

	<span class="n">dispc_ovl_set_ba0</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">+</span> <span class="n">offset0</span><span class="p">);</span>
	<span class="n">dispc_ovl_set_ba1</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">+</span> <span class="n">offset1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OMAP_DSS_COLOR_NV12</span> <span class="o">==</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dispc_ovl_set_ba0_uv</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">p_uv_addr</span> <span class="o">+</span> <span class="n">offset0</span><span class="p">);</span>
		<span class="n">dispc_ovl_set_ba1_uv</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">p_uv_addr</span> <span class="o">+</span> <span class="n">offset1</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">dispc_ovl_set_row_inc</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">row_inc</span><span class="p">);</span>
	<span class="n">dispc_ovl_set_pix_inc</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">pix_inc</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;%d,%d %dx%d -&gt; %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">pos_x</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">pos_y</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span>
			<span class="n">in_height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">);</span>

	<span class="n">dispc_ovl_set_pos</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">pos_x</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">pos_y</span><span class="p">);</span>

	<span class="n">dispc_ovl_set_pic_size</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span> <span class="n">in_height</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_OVL_CAP_SCALE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dispc_ovl_set_scaling</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">in_width</span><span class="p">,</span> <span class="n">in_height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">,</span>
				   <span class="n">out_height</span><span class="p">,</span> <span class="n">ilace</span><span class="p">,</span> <span class="n">five_taps</span><span class="p">,</span> <span class="n">fieldmode</span><span class="p">,</span>
				   <span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">);</span>
		<span class="n">dispc_ovl_set_vid_size</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">out_width</span><span class="p">,</span> <span class="n">out_height</span><span class="p">);</span>
		<span class="n">dispc_ovl_set_vid_color_conv</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">cconv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dispc_ovl_set_rotation_attrs</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">mirror</span><span class="p">,</span>
			<span class="n">oi</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">);</span>

	<span class="n">dispc_ovl_set_zorder</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">zorder</span><span class="p">);</span>
	<span class="n">dispc_ovl_set_pre_mult_alpha</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">pre_mult_alpha</span><span class="p">);</span>
	<span class="n">dispc_ovl_setup_global_alpha</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">global_alpha</span><span class="p">);</span>

	<span class="n">dispc_ovl_enable_replication</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">replication</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dispc_ovl_enable</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dispc_enable_plane %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_disable_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">compl</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="n">compl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_enable_lcd_out</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* flush posted write */</span>
		<span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_mgr_enable_lcd_out</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">frame_done_completion</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_on</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* When we disable LCD output, we need to wait until frame is done.</span>
<span class="cm">	 * Otherwise the DSS is still working, and turning off the clocks</span>
<span class="cm">	 * prevents DSS from going to OFF mode */</span>
	<span class="n">is_on</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span> <span class="o">?</span>
			<span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span> <span class="o">?</span> <span class="n">DISPC_IRQ_FRAMEDONE2</span> <span class="o">:</span>
			<span class="n">DISPC_IRQ_FRAMEDONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">is_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_done_completion</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dispc_register_isr</span><span class="p">(</span><span class="n">dispc_disable_isr</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">frame_done_completion</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to register FRAMEDONE isr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_enable_lcd_out</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">is_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_done_completion</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;timeout waiting for FRAME DONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dispc_unregister_isr</span><span class="p">(</span><span class="n">dispc_disable_isr</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">frame_done_completion</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to unregister FRAMEDONE isr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_enable_digit_out</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* flush posted write */</span>
	<span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_mgr_enable_digit_out</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">frame_done_completion</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dss_hdmi_venc_clk_source_select</span> <span class="n">src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_irqs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">src</span> <span class="o">=</span> <span class="n">dss_get_hdmi_venc_clk_source</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="cm">/* When we enable digit output, we&#39;ll get an extra digit</span>
<span class="cm">		 * sync lost interrupt, that we need to ignore */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dispc</span><span class="p">.</span><span class="n">irq_error_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPC_IRQ_SYNC_LOST_DIGIT</span><span class="p">;</span>
		<span class="n">_omap_dispc_set_irqs</span><span class="p">();</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* When we disable digit output, we need to wait until fields are done.</span>
<span class="cm">	 * Otherwise the DSS is still working, and turning off the clocks</span>
<span class="cm">	 * prevents DSS from going to OFF mode. And when enabling, we need to</span>
<span class="cm">	 * wait for the extra sync losts */</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_done_completion</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="n">DSS_HDMI_M_PCLK</span> <span class="o">&amp;&amp;</span> <span class="n">enable</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_mask</span> <span class="o">=</span> <span class="n">DISPC_IRQ_FRAMEDONETV</span><span class="p">;</span>
		<span class="n">num_irqs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">irq_mask</span> <span class="o">=</span> <span class="n">DISPC_IRQ_EVSYNC_EVEN</span> <span class="o">|</span> <span class="n">DISPC_IRQ_EVSYNC_ODD</span><span class="p">;</span>
		<span class="cm">/* XXX I understand from TRM that we should only wait for the</span>
<span class="cm">		 * current field to complete. But it seems we have to wait for</span>
<span class="cm">		 * both fields */</span>
		<span class="n">num_irqs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dispc_register_isr</span><span class="p">(</span><span class="n">dispc_disable_isr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame_done_completion</span><span class="p">,</span>
			<span class="n">irq_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to register %x isr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">);</span>

	<span class="n">_enable_digit_out</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_irqs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_done_completion</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;timeout waiting for digit out to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;start&quot;</span> <span class="o">:</span> <span class="s">&quot;stop&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dispc_unregister_isr</span><span class="p">(</span><span class="n">dispc_disable_isr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame_done_completion</span><span class="p">,</span>
			<span class="n">irq_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to unregister %x isr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dispc</span><span class="p">.</span><span class="n">irq_error_mask</span> <span class="o">|=</span> <span class="n">DISPC_IRQ_SYNC_LOST_DIGIT</span><span class="p">;</span>
		<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_IRQSTATUS</span><span class="p">,</span> <span class="n">DISPC_IRQ_SYNC_LOST_DIGIT</span><span class="p">);</span>
		<span class="n">_omap_dispc_set_irqs</span><span class="p">();</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">dispc_mgr_is_enabled</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">!!</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_DIGIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">!!</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">!!</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_mgr_enable</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dispc_mgr_is_lcd</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span>
		<span class="n">dispc_mgr_enable_lcd_out</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_DIGIT</span><span class="p">)</span>
		<span class="n">dispc_mgr_enable_digit_out</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_lcd_enable_signal_polarity</span><span class="p">(</span><span class="n">bool</span> <span class="n">act_high</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_LCDENABLEPOL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">act_high</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_lcd_enable_signal</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_LCDENABLESIGNAL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_pck_free_enable</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_PCKFREEENABLE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">27</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_mgr_enable_fifohandcheck</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG2</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">dispc_mgr_set_lcd_display_type</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_lcd_display_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_LCD_DISPLAY_STN</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_LCD_DISPLAY_TFT</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_set_loadmode</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_dss_load_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_mgr_set_default_color</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u32</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_DEFAULT_COLOR</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">color</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_mgr_set_trans_key</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">ch</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_dss_trans_key_type</span> <span class="n">type</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">trans_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_DIGIT</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* OMAP_DSS_CHANNEL_LCD2 */</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG2</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_TRANS_COLOR</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">trans_key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_mgr_enable_trans_key</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">ch</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_DIGIT</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* OMAP_DSS_CHANNEL_LCD2 */</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG2</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_mgr_enable_alpha_fixed_zorder</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">ch</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ALPHA_FIXED_ZORDER</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_DIGIT</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_mgr_setup</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_overlay_manager_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_mgr_set_default_color</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_color</span><span class="p">);</span>
	<span class="n">dispc_mgr_set_trans_key</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">trans_key_type</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">trans_key</span><span class="p">);</span>
	<span class="n">dispc_mgr_enable_trans_key</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">trans_enabled</span><span class="p">);</span>
	<span class="n">dispc_mgr_enable_alpha_fixed_zorder</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">partial_alpha_enabled</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_CPR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dispc_mgr_enable_cpr</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cpr_enable</span><span class="p">);</span>
		<span class="n">dispc_mgr_set_cpr_coef</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cpr_coefs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_mgr_set_tft_data_lines</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data_lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">code</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data_lines</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">code</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">18</span>:
		<span class="n">code</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">code</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_mgr_set_io_pad_mode</span><span class="p">(</span><span class="k">enum</span> <span class="n">dss_io_pad_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpout0</span><span class="p">,</span> <span class="n">gpout1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DSS_IO_PAD_MODE_RESET</span>:
		<span class="n">gpout0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gpout1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSS_IO_PAD_MODE_RFBI</span>:
		<span class="n">gpout0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gpout1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSS_IO_PAD_MODE_BYPASS</span>:
		<span class="n">gpout0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gpout1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">gpout0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">gpout1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_mgr_enable_stallmode</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_dispc_mgr_size_ok</span><span class="p">(</span><span class="n">u16</span> <span class="n">width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_MGR_WIDTH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">height</span> <span class="o">&lt;=</span> <span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_MGR_HEIGHT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_dispc_lcd_timings_ok</span><span class="p">(</span><span class="kt">int</span> <span class="n">hsw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hfp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hbp</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">vsw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vfp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vbp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">()</span> <span class="o">||</span> <span class="n">omap_rev</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">OMAP3430_REV_ES3_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hsw</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">hsw</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">||</span>
				<span class="n">hfp</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">hfp</span> <span class="o">&gt;</span> <span class="mi">256</span> <span class="o">||</span>
				<span class="n">hbp</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">hbp</span> <span class="o">&gt;</span> <span class="mi">256</span> <span class="o">||</span>
				<span class="n">vsw</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">vsw</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">||</span>
				<span class="n">vfp</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vfp</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">||</span>
				<span class="n">vbp</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vbp</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hsw</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">hsw</span> <span class="o">&gt;</span> <span class="mi">256</span> <span class="o">||</span>
				<span class="n">hfp</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">hfp</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="o">||</span>
				<span class="n">hbp</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">hbp</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="o">||</span>
				<span class="n">vsw</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">vsw</span> <span class="o">&gt;</span> <span class="mi">256</span> <span class="o">||</span>
				<span class="n">vfp</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vfp</span> <span class="o">&gt;</span> <span class="mi">4095</span> <span class="o">||</span>
				<span class="n">vbp</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vbp</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">dispc_mgr_timings_ok</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">timings_ok</span><span class="p">;</span>

	<span class="n">timings_ok</span> <span class="o">=</span> <span class="n">_dispc_mgr_size_ok</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">,</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dispc_mgr_is_lcd</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span>
		<span class="n">timings_ok</span> <span class="o">=</span>  <span class="n">timings_ok</span> <span class="o">&amp;&amp;</span> <span class="n">_dispc_lcd_timings_ok</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">hsw</span><span class="p">,</span>
						<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfp</span><span class="p">,</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hbp</span><span class="p">,</span>
						<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vsw</span><span class="p">,</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfp</span><span class="p">,</span>
						<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vbp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">timings_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dispc_mgr_set_lcd_timings</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hsw</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">hfp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hbp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vsw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vfp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vbp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timing_h</span><span class="p">,</span> <span class="n">timing_v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">()</span> <span class="o">||</span> <span class="n">omap_rev</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">OMAP3430_REV_ES3_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timing_h</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">hsw</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">hfp</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">hbp</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

		<span class="n">timing_v</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vsw</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vfp</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vbp</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">timing_h</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">hsw</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">hfp</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">hbp</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

		<span class="n">timing_v</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vsw</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vfp</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">vbp</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_TIMING_H</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">timing_h</span><span class="p">);</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_TIMING_V</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">timing_v</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* change name to mode? */</span>
<span class="kt">void</span> <span class="nf">dispc_mgr_set_timings</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">xtot</span><span class="p">,</span> <span class="n">ytot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ht</span><span class="p">,</span> <span class="n">vt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="n">t</span> <span class="o">=</span> <span class="o">*</span><span class="n">timings</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;channel %d xres %u yres %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">x_res</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">y_res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dispc_mgr_timings_ok</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dispc_mgr_is_lcd</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_dispc_mgr_set_lcd_timings</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">hsw</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">hfp</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">hbp</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">vsw</span><span class="p">,</span>
				<span class="n">t</span><span class="p">.</span><span class="n">vfp</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">vbp</span><span class="p">);</span>

		<span class="n">xtot</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">x_res</span> <span class="o">+</span> <span class="n">t</span><span class="p">.</span><span class="n">hfp</span> <span class="o">+</span> <span class="n">t</span><span class="p">.</span><span class="n">hsw</span> <span class="o">+</span> <span class="n">t</span><span class="p">.</span><span class="n">hbp</span><span class="p">;</span>
		<span class="n">ytot</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">y_res</span> <span class="o">+</span> <span class="n">t</span><span class="p">.</span><span class="n">vfp</span> <span class="o">+</span> <span class="n">t</span><span class="p">.</span><span class="n">vsw</span> <span class="o">+</span> <span class="n">t</span><span class="p">.</span><span class="n">vbp</span><span class="p">;</span>

		<span class="n">ht</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">xtot</span><span class="p">;</span>
		<span class="n">vt</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">xtot</span> <span class="o">/</span> <span class="n">ytot</span><span class="p">;</span>

		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;pck %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">);</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;hsw %d hfp %d hbp %d vsw %d vfp %d vbp %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">t</span><span class="p">.</span><span class="n">hsw</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">hfp</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">hbp</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">vsw</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">vfp</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">vbp</span><span class="p">);</span>

		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;hsync %luHz, vsync %luHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">vt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">dss_hdmi_venc_clk_source_select</span> <span class="n">source</span><span class="p">;</span>

		<span class="n">source</span> <span class="o">=</span> <span class="n">dss_get_hdmi_venc_clk_source</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="n">DSS_VENC_TV_CLK</span><span class="p">)</span>
			<span class="n">t</span><span class="p">.</span><span class="n">y_res</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dispc_mgr_set_size</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">x_res</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">y_res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_mgr_set_lcd_divisor</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u16</span> <span class="n">lck_div</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">pck_div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lck_div</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pck_div</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_DIVISORo</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
			<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">lck_div</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">pck_div</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_mgr_get_lcd_divisor</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lck_div</span><span class="p">,</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">pck_div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_DIVISORo</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
	<span class="o">*</span><span class="n">lck_div</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pck_div</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dispc_fclk_rate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dss_get_dispc_clk_source</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CLK_SRC_FCK</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">dispc</span><span class="p">.</span><span class="n">dss_clk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DISPC</span>:
		<span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_get_pll_hsdiv_dispc_rate</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CLK_SRC_DSI2_PLL_HSDIV_DISPC</span>:
		<span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_id</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_get_pll_hsdiv_dispc_rate</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dispc_mgr_lclk_rate</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lcd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_DIVISORo</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>

	<span class="n">lcd</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dss_get_lcd_clk_source</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CLK_SRC_FCK</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">dispc</span><span class="p">.</span><span class="n">dss_clk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DISPC</span>:
		<span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_get_pll_hsdiv_dispc_rate</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_CLK_SRC_DSI2_PLL_HSDIV_DISPC</span>:
		<span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_id</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_get_pll_hsdiv_dispc_rate</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span> <span class="o">/</span> <span class="n">lcd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dispc_mgr_pclk_rate</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dispc_mgr_is_lcd</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pcd</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

		<span class="n">l</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_DIVISORo</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>

		<span class="n">pcd</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">dispc_mgr_lclk_rate</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">r</span> <span class="o">/</span> <span class="n">pcd</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">dss_hdmi_venc_clk_source_select</span> <span class="n">source</span><span class="p">;</span>

		<span class="n">source</span> <span class="o">=</span> <span class="n">dss_get_hdmi_venc_clk_source</span><span class="p">();</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DSS_VENC_TV_CLK</span>:
			<span class="k">return</span> <span class="n">venc_get_pixel_clock</span><span class="p">();</span>
		<span class="k">case</span> <span class="n">DSS_HDMI_M_PCLK</span>:
			<span class="k">return</span> <span class="n">hdmi_get_pixel_clock</span><span class="p">();</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dispc_core_clk_rate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lcd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fclk</span> <span class="o">=</span> <span class="n">dispc_fclk_rate</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_CORE_CLK_DIV</span><span class="p">))</span>
		<span class="n">lcd</span> <span class="o">=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_DIVISOR</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lcd</span> <span class="o">=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_DIVISORo</span><span class="p">(</span><span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">),</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fclk</span> <span class="o">/</span> <span class="n">lcd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_dump_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lcd</span><span class="p">,</span> <span class="n">pcd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_dss_clk_source</span> <span class="n">dispc_clk_src</span> <span class="o">=</span> <span class="n">dss_get_dispc_clk_source</span><span class="p">();</span>
	<span class="k">enum</span> <span class="n">omap_dss_clk_source</span> <span class="n">lcd_clk_src</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dispc_runtime_get</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;- DISPC -</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;dispc fclk source = %s (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dss_get_generic_clk_source_name</span><span class="p">(</span><span class="n">dispc_clk_src</span><span class="p">),</span>
			<span class="n">dss_feat_get_clk_source_name</span><span class="p">(</span><span class="n">dispc_clk_src</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;fck</span><span class="se">\t\t</span><span class="s">%-16lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dispc_fclk_rate</span><span class="p">());</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_CORE_CLK_DIV</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;- DISPC-CORE-CLK -</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_DIVISOR</span><span class="p">);</span>
		<span class="n">lcd</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;lck</span><span class="se">\t\t</span><span class="s">%-16lulck div</span><span class="se">\t</span><span class="s">%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dispc_fclk_rate</span><span class="p">()</span><span class="o">/</span><span class="n">lcd</span><span class="p">),</span> <span class="n">lcd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;- LCD1 -</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">lcd_clk_src</span> <span class="o">=</span> <span class="n">dss_get_lcd_clk_source</span><span class="p">(</span><span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;lcd1_clk source = %s (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dss_get_generic_clk_source_name</span><span class="p">(</span><span class="n">lcd_clk_src</span><span class="p">),</span>
		<span class="n">dss_feat_get_clk_source_name</span><span class="p">(</span><span class="n">lcd_clk_src</span><span class="p">));</span>

	<span class="n">dispc_mgr_get_lcd_divisor</span><span class="p">(</span><span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcd</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;lck</span><span class="se">\t\t</span><span class="s">%-16lulck div</span><span class="se">\t</span><span class="s">%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dispc_mgr_lclk_rate</span><span class="p">(</span><span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">),</span> <span class="n">lcd</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;pck</span><span class="se">\t\t</span><span class="s">%-16lupck div</span><span class="se">\t</span><span class="s">%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dispc_mgr_pclk_rate</span><span class="p">(</span><span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">),</span> <span class="n">pcd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_MGR_LCD2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;- LCD2 -</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">lcd_clk_src</span> <span class="o">=</span> <span class="n">dss_get_lcd_clk_source</span><span class="p">(</span><span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;lcd2_clk source = %s (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dss_get_generic_clk_source_name</span><span class="p">(</span><span class="n">lcd_clk_src</span><span class="p">),</span>
			<span class="n">dss_feat_get_clk_source_name</span><span class="p">(</span><span class="n">lcd_clk_src</span><span class="p">));</span>

		<span class="n">dispc_mgr_get_lcd_divisor</span><span class="p">(</span><span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcd</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;lck</span><span class="se">\t\t</span><span class="s">%-16lulck div</span><span class="se">\t</span><span class="s">%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dispc_mgr_lclk_rate</span><span class="p">(</span><span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">),</span> <span class="n">lcd</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;pck</span><span class="se">\t\t</span><span class="s">%-16lupck div</span><span class="se">\t</span><span class="s">%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dispc_mgr_pclk_rate</span><span class="p">(</span><span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">),</span> <span class="n">pcd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dispc_runtime_put</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_COLLECT_IRQ_STATS</span>
<span class="kt">void</span> <span class="nf">dispc_dump_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dispc_irq_stats</span> <span class="n">stats</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats</span><span class="p">));</span>
	<span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats</span><span class="p">.</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;period %u ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">last_reset</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;irqs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">irq_count</span><span class="p">);</span>
<span class="cp">#define PIS(x) \</span>
<span class="cp">	seq_printf(s, &quot;%-20s %10d\n&quot;, #x, stats.irqs[ffs(DISPC_IRQ_##x)-1]);</span>

	<span class="n">PIS</span><span class="p">(</span><span class="n">FRAMEDONE</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VSYNC</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">EVSYNC_EVEN</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">EVSYNC_ODD</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ACBIAS_COUNT_STAT</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PROG_LINE_NUM</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">GFX_FIFO_UNDERFLOW</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">GFX_END_WIN</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PAL_GAMMA_MASK</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">OCP_ERR</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VID1_FIFO_UNDERFLOW</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VID1_END_WIN</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VID2_FIFO_UNDERFLOW</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VID2_END_WIN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_feat_get_num_ovls</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PIS</span><span class="p">(</span><span class="n">VID3_FIFO_UNDERFLOW</span><span class="p">);</span>
		<span class="n">PIS</span><span class="p">(</span><span class="n">VID3_END_WIN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">SYNC_LOST</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">SYNC_LOST_DIGIT</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">WAKEUP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_MGR_LCD2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PIS</span><span class="p">(</span><span class="n">FRAMEDONE2</span><span class="p">);</span>
		<span class="n">PIS</span><span class="p">(</span><span class="n">VSYNC2</span><span class="p">);</span>
		<span class="n">PIS</span><span class="p">(</span><span class="n">ACBIAS_COUNT_STAT2</span><span class="p">);</span>
		<span class="n">PIS</span><span class="p">(</span><span class="n">SYNC_LOST2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#undef PIS</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mgr_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">OMAP_DSS_CHANNEL_LCD</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;LCD&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">OMAP_DSS_CHANNEL_DIGIT</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TV&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">OMAP_DSS_CHANNEL_LCD2</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;LCD2&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ovl_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">OMAP_DSS_GFX</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;GFX&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">OMAP_DSS_VIDEO1</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;VID1&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">OMAP_DSS_VIDEO2</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;VID2&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">OMAP_DSS_VIDEO3</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;VID3&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">p_names</span><span class="p">;</span>

<span class="cp">#define DUMPREG(r) seq_printf(s, &quot;%-50s %08x\n&quot;, #r, dispc_read_reg(r))</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dispc_runtime_get</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* DISPC common registers */</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_REVISION</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_SYSCONFIG</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_SYSSTATUS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_IRQSTATUS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_IRQENABLE</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_CONTROL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_CAPABLE</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_LINE_STATUS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_LINE_NUMBER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ALPHA_FIXED_ZORDER</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ALPHA_FREE_ZORDER</span><span class="p">))</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_GLOBAL_ALPHA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_MGR_LCD2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_CONTROL2</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DISPC_CONFIG2</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#undef DUMPREG</span>

<span class="cp">#define DISPC_REG(i, name) name(i)</span>
<span class="cp">#define DUMPREG(i, r) seq_printf(s, &quot;%s(%s)%*s %08x\n&quot;, #r, p_names[i], \</span>
<span class="cp">	48 - strlen(#r) - strlen(p_names[i]), &quot; &quot;, \</span>
<span class="cp">	dispc_read_reg(DISPC_REG(i, r)))</span>

	<span class="n">p_names</span> <span class="o">=</span> <span class="n">mgr_names</span><span class="p">;</span>

	<span class="cm">/* DISPC channel specific registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dss_feat_get_num_mgrs</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_DEFAULT_COLOR</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_TRANS_COLOR</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_SIZE_MGR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_DIGIT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_DEFAULT_COLOR</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_TRANS_COLOR</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_TIMING_H</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_TIMING_V</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_POL_FREQ</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_DIVISORo</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_SIZE_MGR</span><span class="p">);</span>

		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_DATA_CYCLE1</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_DATA_CYCLE2</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_DATA_CYCLE3</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_CPR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_CPR_COEF_R</span><span class="p">);</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_CPR_COEF_G</span><span class="p">);</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_CPR_COEF_B</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">p_names</span> <span class="o">=</span> <span class="n">ovl_names</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dss_feat_get_num_ovls</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_BA0</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_BA1</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_POSITION</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_SIZE</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_ATTRIBUTES</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_FIFO_THRESHOLD</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_FIFO_SIZE_STATUS</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_ROW_INC</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_PIXEL_INC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_PRELOAD</span><span class="p">))</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_PRELOAD</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">OMAP_DSS_GFX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_WINDOW_SKIP</span><span class="p">);</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_TABLE_BA</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_FIR</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_PICTURE_SIZE</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_ACCU0</span><span class="p">);</span>
		<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_ACCU1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_HANDLE_UV_SEPARATE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_BA0_UV</span><span class="p">);</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_BA1_UV</span><span class="p">);</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_FIR2</span><span class="p">);</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_ACCU2_0</span><span class="p">);</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_ACCU2_1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_ATTR2</span><span class="p">))</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_ATTRIBUTES2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_PRELOAD</span><span class="p">))</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_PRELOAD</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#undef DISPC_REG</span>
<span class="cp">#undef DUMPREG</span>

<span class="cp">#define DISPC_REG(plane, name, i) name(plane, i)</span>
<span class="cp">#define DUMPREG(plane, name, i) \</span>
<span class="cp">	seq_printf(s, &quot;%s_%d(%s)%*s %08x\n&quot;, #name, i, p_names[plane], \</span>
<span class="cp">	46 - strlen(#name) - strlen(p_names[plane]), &quot; &quot;, \</span>
<span class="cp">	dispc_read_reg(DISPC_REG(plane, name, i)))</span>

	<span class="cm">/* Video pipeline coefficient registers */</span>

	<span class="cm">/* start from OMAP_DSS_VIDEO1 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dss_feat_get_num_ovls</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_FIR_COEF_H</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_FIR_COEF_HV</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_CONV_COEF</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_FIR_COEF_V</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_FIR_COEF_V</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_HANDLE_UV_SEPARATE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_FIR_COEF_H2</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_FIR_COEF_HV2</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">DUMPREG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DISPC_OVL_FIR_COEF_V2</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dispc_runtime_put</span><span class="p">();</span>

<span class="cp">#undef DISPC_REG</span>
<span class="cp">#undef DUMPREG</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dispc_mgr_set_pol_freq</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bool</span> <span class="n">onoff</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">rf</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ieo</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ipc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ihs</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ivs</span><span class="p">,</span> <span class="n">u8</span> <span class="n">acbi</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;onoff %d rf %d ieo %d ipc %d ihs %d ivs %d acbi %d acb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">onoff</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">ieo</span><span class="p">,</span> <span class="n">ipc</span><span class="p">,</span> <span class="n">ihs</span><span class="p">,</span> <span class="n">ivs</span><span class="p">,</span> <span class="n">acbi</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">onoff</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">ieo</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">ipc</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">ihs</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">ivs</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">acbi</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_POL_FREQ</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_mgr_set_pol_freq</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">omap_panel_config</span> <span class="n">config</span><span class="p">,</span> <span class="n">u8</span> <span class="n">acbi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_dispc_mgr_set_pol_freq</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_LCD_ONOFF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_LCD_RF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_LCD_IEO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_LCD_IPC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_LCD_IHS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">OMAP_DSS_LCD_IVS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">acbi</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* with fck as input clock rate, find dispc dividers that produce req_pck */</span>
<span class="kt">void</span> <span class="nf">dispc_find_clk_divs</span><span class="p">(</span><span class="n">bool</span> <span class="n">is_tft</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">req_pck</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fck</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dispc_clock_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pcd_min</span><span class="p">,</span> <span class="n">pcd_max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">best_pck</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">best_ld</span><span class="p">,</span> <span class="n">cur_ld</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">best_pd</span><span class="p">,</span> <span class="n">cur_pd</span><span class="p">;</span>

	<span class="n">pcd_min</span> <span class="o">=</span> <span class="n">dss_feat_get_param_min</span><span class="p">(</span><span class="n">FEAT_PARAM_DSS_PCD</span><span class="p">);</span>
	<span class="n">pcd_max</span> <span class="o">=</span> <span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_DSS_PCD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_tft</span><span class="p">)</span>
		<span class="n">pcd_min</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">best_pck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">best_ld</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">best_pd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cur_ld</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cur_ld</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">;</span> <span class="o">++</span><span class="n">cur_ld</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lck</span> <span class="o">=</span> <span class="n">fck</span> <span class="o">/</span> <span class="n">cur_ld</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">cur_pd</span> <span class="o">=</span> <span class="n">pcd_min</span><span class="p">;</span> <span class="n">cur_pd</span> <span class="o">&lt;=</span> <span class="n">pcd_max</span><span class="p">;</span> <span class="o">++</span><span class="n">cur_pd</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pck</span> <span class="o">=</span> <span class="n">lck</span> <span class="o">/</span> <span class="n">cur_pd</span><span class="p">;</span>
			<span class="kt">long</span> <span class="n">old_delta</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">best_pck</span> <span class="o">-</span> <span class="n">req_pck</span><span class="p">);</span>
			<span class="kt">long</span> <span class="n">new_delta</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">pck</span> <span class="o">-</span> <span class="n">req_pck</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">best_pck</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">new_delta</span> <span class="o">&lt;</span> <span class="n">old_delta</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">best_pck</span> <span class="o">=</span> <span class="n">pck</span><span class="p">;</span>
				<span class="n">best_ld</span> <span class="o">=</span> <span class="n">cur_ld</span><span class="p">;</span>
				<span class="n">best_pd</span> <span class="o">=</span> <span class="n">cur_pd</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">pck</span> <span class="o">==</span> <span class="n">req_pck</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pck</span> <span class="o">&lt;</span> <span class="n">req_pck</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lck</span> <span class="o">/</span> <span class="n">pcd_min</span> <span class="o">&lt;</span> <span class="n">req_pck</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">found:</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck_div</span> <span class="o">=</span> <span class="n">best_ld</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck_div</span> <span class="o">=</span> <span class="n">best_pd</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck</span> <span class="o">=</span> <span class="n">fck</span> <span class="o">/</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck_div</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck</span> <span class="o">/</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck_div</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* calculate clock rates using dividers in cinfo */</span>
<span class="kt">int</span> <span class="nf">dispc_calc_clock_rates</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dispc_fclk_rate</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dispc_clock_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck_div</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck_div</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck_div</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck_div</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck</span> <span class="o">=</span> <span class="n">dispc_fclk_rate</span> <span class="o">/</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck_div</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck</span> <span class="o">/</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck_div</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dispc_mgr_set_clock_div</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dispc_clock_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;lck = %lu (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck_div</span><span class="p">);</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;pck = %lu (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck_div</span><span class="p">);</span>

	<span class="n">dispc_mgr_set_lcd_divisor</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck_div</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck_div</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dispc_mgr_get_clock_div</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_channel</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dispc_clock_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fck</span><span class="p">;</span>

	<span class="n">fck</span> <span class="o">=</span> <span class="n">dispc_fclk_rate</span><span class="p">();</span>

	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck_div</span> <span class="o">=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_DIVISORo</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck_div</span> <span class="o">=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">DISPC_DIVISORo</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck</span> <span class="o">=</span> <span class="n">fck</span> <span class="o">/</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck_div</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lck</span> <span class="o">/</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">pck_div</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dispc.irq_lock has to be locked by the caller */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_omap_dispc_set_irqs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">old_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dispc_isr_data</span> <span class="o">*</span><span class="n">isr_data</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">dispc</span><span class="p">.</span><span class="n">irq_error_mask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DISPC_MAX_NR_ISRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">registered_isr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mask</span> <span class="o">|=</span> <span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_mask</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_IRQENABLE</span><span class="p">);</span>
	<span class="cm">/* clear the irqstatus for newly enabled irqs */</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_IRQSTATUS</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">^</span> <span class="n">old_mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_IRQENABLE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap_dispc_register_isr</span><span class="p">(</span><span class="n">omap_dispc_isr_t</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dispc_isr_data</span> <span class="o">*</span><span class="n">isr_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* check for duplicate entry */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DISPC_MAX_NR_ISRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">registered_isr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">==</span> <span class="n">isr</span> <span class="o">&amp;&amp;</span> <span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">==</span> <span class="n">arg</span> <span class="o">&amp;&amp;</span>
				<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">isr_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DISPC_MAX_NR_ISRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">registered_isr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="n">isr</span><span class="p">;</span>
		<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">_omap_dispc_set_irqs</span><span class="p">();</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dispc_register_isr</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">omap_dispc_unregister_isr</span><span class="p">(</span><span class="n">omap_dispc_isr_t</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dispc_isr_data</span> <span class="o">*</span><span class="n">isr_data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DISPC_MAX_NR_ISRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">registered_isr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">!=</span> <span class="n">isr</span> <span class="o">||</span> <span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">!=</span> <span class="n">arg</span> <span class="o">||</span>
				<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">!=</span> <span class="n">mask</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* found the correct isr */</span>

		<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">_omap_dispc_set_irqs</span><span class="p">();</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dispc_unregister_isr</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_irq_status</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">dispc</span><span class="p">.</span><span class="n">irq_error_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DISPC IRQ: 0x%x: &quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

<span class="cp">#define PIS(x) \</span>
<span class="cp">	if (status &amp; DISPC_IRQ_##x) \</span>
<span class="cp">		printk(#x &quot; &quot;);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">GFX_FIFO_UNDERFLOW</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">OCP_ERR</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VID1_FIFO_UNDERFLOW</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VID2_FIFO_UNDERFLOW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_feat_get_num_ovls</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">PIS</span><span class="p">(</span><span class="n">VID3_FIFO_UNDERFLOW</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">SYNC_LOST</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">SYNC_LOST_DIGIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_MGR_LCD2</span><span class="p">))</span>
		<span class="n">PIS</span><span class="p">(</span><span class="n">SYNC_LOST2</span><span class="p">);</span>
<span class="cp">#undef PIS</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Called from dss.c. Note that we don&#39;t touch clocks here,</span>
<span class="cm"> * but we presume they are on because we got an IRQ. However,</span>
<span class="cm"> * an irq handler may turn the clocks off, so we may not have</span>
<span class="cm"> * clock later in the function. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap_dispc_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irqstatus</span><span class="p">,</span> <span class="n">irqenable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">handledirqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">unhandled_errors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dispc_isr_data</span> <span class="o">*</span><span class="n">isr_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dispc_isr_data</span> <span class="n">registered_isr</span><span class="p">[</span><span class="n">DISPC_MAX_NR_ISRS</span><span class="p">];</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="n">irqstatus</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_IRQSTATUS</span><span class="p">);</span>
	<span class="n">irqenable</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_IRQENABLE</span><span class="p">);</span>

	<span class="cm">/* IRQ is not for us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">irqenable</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_COLLECT_IRQ_STATS</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats_lock</span><span class="p">);</span>
	<span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats</span><span class="p">.</span><span class="n">irq_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dss_collect_irq_stats</span><span class="p">(</span><span class="n">irqstatus</span><span class="p">,</span> <span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats</span><span class="p">.</span><span class="n">irqs</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats_lock</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_debug</span><span class="p">)</span>
		<span class="n">print_irq_status</span><span class="p">(</span><span class="n">irqstatus</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Ack the interrupt. Do it here before clocks are possibly turned</span>
<span class="cm">	 * off */</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_IRQSTATUS</span><span class="p">,</span> <span class="n">irqstatus</span><span class="p">);</span>
	<span class="cm">/* flush posted write */</span>
	<span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_IRQSTATUS</span><span class="p">);</span>

	<span class="cm">/* make a copy and unlock, so that isrs can unregister</span>
<span class="cm">	 * themselves */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">registered_isr</span><span class="p">,</span> <span class="n">dispc</span><span class="p">.</span><span class="n">registered_isr</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">registered_isr</span><span class="p">));</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DISPC_MAX_NR_ISRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">registered_isr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">irqstatus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="n">irqstatus</span><span class="p">);</span>
			<span class="n">handledirqs</span> <span class="o">|=</span> <span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="n">unhandled_errors</span> <span class="o">=</span> <span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">handledirqs</span> <span class="o">&amp;</span> <span class="n">dispc</span><span class="p">.</span><span class="n">irq_error_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unhandled_errors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dispc</span><span class="p">.</span><span class="n">error_irqs</span> <span class="o">|=</span> <span class="n">unhandled_errors</span><span class="p">;</span>

		<span class="n">dispc</span><span class="p">.</span><span class="n">irq_error_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">unhandled_errors</span><span class="p">;</span>
		<span class="n">_omap_dispc_set_irqs</span><span class="p">();</span>

		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">error_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_error_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">errors</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">fifo_underflow_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">DISPC_IRQ_GFX_FIFO_UNDERFLOW</span><span class="p">,</span>
		<span class="n">DISPC_IRQ_VID1_FIFO_UNDERFLOW</span><span class="p">,</span>
		<span class="n">DISPC_IRQ_VID2_FIFO_UNDERFLOW</span><span class="p">,</span>
		<span class="n">DISPC_IRQ_VID3_FIFO_UNDERFLOW</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">sync_lost_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">DISPC_IRQ_SYNC_LOST</span><span class="p">,</span>
		<span class="n">DISPC_IRQ_SYNC_LOST_DIGIT</span><span class="p">,</span>
		<span class="n">DISPC_IRQ_SYNC_LOST2</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">errors</span> <span class="o">=</span> <span class="n">dispc</span><span class="p">.</span><span class="n">error_irqs</span><span class="p">;</span>
	<span class="n">dispc</span><span class="p">.</span><span class="n">error_irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dispc_runtime_get</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">omap_dss_get_num_overlays</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">bit</span><span class="p">;</span>

		<span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">fifo_underflow_bits</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">errors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;FIFO UNDERFLOW on %s, disabling the overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dispc_ovl_enable</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">dispc_mgr_go</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">omap_dss_get_num_overlay_managers</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_overlay_manager</span> <span class="o">*</span><span class="n">mgr</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">bit</span><span class="p">;</span>

		<span class="n">mgr</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay_manager</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">sync_lost_bits</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">errors</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
			<span class="n">bool</span> <span class="n">enable</span><span class="p">;</span>

			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;SYNC_LOST on channel %s, restarting the output &quot;</span>
					<span class="s">&quot;with video overlays disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="n">enable</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">OMAP_DSS_DISPLAY_ACTIVE</span><span class="p">;</span>
			<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">omap_dss_get_num_overlays</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
				<span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">OMAP_DSS_GFX</span> <span class="o">&amp;&amp;</span>
						<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">==</span> <span class="n">mgr</span><span class="p">)</span>
					<span class="n">dispc_ovl_enable</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">dispc_mgr_go</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
				<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&amp;</span> <span class="n">DISPC_IRQ_OCP_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;OCP_ERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">omap_dss_get_num_overlay_managers</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">omap_overlay_manager</span> <span class="o">*</span><span class="n">mgr</span><span class="p">;</span>
			<span class="n">mgr</span> <span class="o">=</span> <span class="n">omap_dss_get_overlay_manager</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&amp;&amp;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
				<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dispc</span><span class="p">.</span><span class="n">irq_error_mask</span> <span class="o">|=</span> <span class="n">errors</span><span class="p">;</span>
	<span class="n">_omap_dispc_set_irqs</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dispc_runtime_put</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap_dispc_wait_for_irq_timeout</span><span class="p">(</span><span class="n">u32</span> <span class="n">irqmask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">dispc_irq_wait_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">complete</span><span class="p">((</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">completion</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dispc_register_isr</span><span class="p">(</span><span class="n">dispc_irq_wait_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
			<span class="n">irqmask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="n">omap_dispc_unregister_isr</span><span class="p">(</span><span class="n">dispc_irq_wait_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span> <span class="n">irqmask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap_dispc_wait_for_irq_interruptible_timeout</span><span class="p">(</span><span class="n">u32</span> <span class="n">irqmask</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">dispc_irq_wait_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">complete</span><span class="p">((</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">completion</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dispc_register_isr</span><span class="p">(</span><span class="n">dispc_irq_wait_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
			<span class="n">irqmask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
			<span class="n">timeout</span><span class="p">);</span>

	<span class="n">omap_dispc_unregister_isr</span><span class="p">(</span><span class="n">dispc_irq_wait_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span> <span class="n">irqmask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_omap_dispc_initialize_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dispc</span><span class="p">.</span><span class="n">registered_isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dispc</span><span class="p">.</span><span class="n">registered_isr</span><span class="p">));</span>

	<span class="n">dispc</span><span class="p">.</span><span class="n">irq_error_mask</span> <span class="o">=</span> <span class="n">DISPC_IRQ_MASK_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_MGR_LCD2</span><span class="p">))</span>
		<span class="n">dispc</span><span class="p">.</span><span class="n">irq_error_mask</span> <span class="o">|=</span> <span class="n">DISPC_IRQ_SYNC_LOST2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_feat_get_num_ovls</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">dispc</span><span class="p">.</span><span class="n">irq_error_mask</span> <span class="o">|=</span> <span class="n">DISPC_IRQ_VID3_FIFO_UNDERFLOW</span><span class="p">;</span>

	<span class="cm">/* there&#39;s SYNC_LOST_DIGIT waiting after enabling the DSS,</span>
<span class="cm">	 * so clear it */</span>
	<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_IRQSTATUS</span><span class="p">,</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_IRQSTATUS</span><span class="p">));</span>

	<span class="n">_omap_dispc_set_irqs</span><span class="p">();</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_enable_sidle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_SYSCONFIG</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* SIDLEMODE: smart idle */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dispc_disable_sidle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_SYSCONFIG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* SIDLEMODE: no idle */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_omap_dispc_initial_config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="cm">/* Exclusively enable DISPC_CORE_CLK and set divider to 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_CORE_CLK_DIV</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_DIVISOR</span><span class="p">);</span>
		<span class="cm">/* Use DISPC_DIVISOR.LCD, instead of DISPC_DIVISOR1.LCD */</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">dispc_write_reg</span><span class="p">(</span><span class="n">DISPC_DIVISOR</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FUNCGATED */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_FUNCGATED</span><span class="p">))</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">DISPC_CONFIG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>

	<span class="n">_dispc_setup_color_conv_coef</span><span class="p">();</span>

	<span class="n">dispc_set_loadmode</span><span class="p">(</span><span class="n">OMAP_DSS_LOAD_FRAME_ONLY</span><span class="p">);</span>

	<span class="n">dispc_read_plane_fifo_sizes</span><span class="p">();</span>

	<span class="n">dispc_configure_burst_sizes</span><span class="p">();</span>

	<span class="n">dispc_ovl_enable_zorder_planes</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* DISPC HW IP initialisation */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_dispchw_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">dispc_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="n">dispc</span><span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_COLLECT_IRQ_STATS</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats_lock</span><span class="p">);</span>
	<span class="n">dispc</span><span class="p">.</span><span class="n">irq_stats</span><span class="p">.</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispc</span><span class="p">.</span><span class="n">error_work</span><span class="p">,</span> <span class="n">dispc_error_worker</span><span class="p">);</span>

	<span class="n">dispc_mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dispc</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dispc_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get IORESOURCE_MEM DISPC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dispc</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dispc_mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				  <span class="n">resource_size</span><span class="p">(</span><span class="n">dispc_mem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dispc</span><span class="p">.</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t ioremap DISPC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dispc</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">dispc</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dispc</span><span class="p">.</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;platform_get_irq failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dispc</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">omap_dispc_irq_handler</span><span class="p">,</span>
			     <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;OMAP DISPC&quot;</span><span class="p">,</span> <span class="n">dispc</span><span class="p">.</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;request_irq failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fck&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get fck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dispc</span><span class="p">.</span><span class="n">dss_clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dispc_runtime_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_runtime_get</span><span class="p">;</span>

	<span class="n">_omap_dispc_initial_config</span><span class="p">();</span>

	<span class="n">_omap_dispc_initialize_irq</span><span class="p">();</span>

	<span class="n">rev</span> <span class="o">=</span> <span class="n">dispc_read_reg</span><span class="p">(</span><span class="n">DISPC_REVISION</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OMAP DISPC rev %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">FLD_GET</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">dispc_runtime_put</span><span class="p">();</span>

	<span class="n">dss_debugfs_create_file</span><span class="p">(</span><span class="s">&quot;dispc&quot;</span><span class="p">,</span> <span class="n">dispc_dump_regs</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_COLLECT_IRQ_STATS</span>
	<span class="n">dss_debugfs_create_file</span><span class="p">(</span><span class="s">&quot;dispc_irq&quot;</span><span class="p">,</span> <span class="n">dispc_dump_irqs</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_runtime_get:</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">dispc</span><span class="p">.</span><span class="n">dss_clk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">omap_dispchw_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">dispc</span><span class="p">.</span><span class="n">dss_clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dispc_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_save_context</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dispc_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_restore_context</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">dispc_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">runtime_suspend</span> <span class="o">=</span> <span class="n">dispc_runtime_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span> <span class="o">=</span> <span class="n">dispc_runtime_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omap_dispchw_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">omap_dispchw_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>         <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;omapdss_dispc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dispc_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">dispc_init_platform_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dispchw_driver</span><span class="p">,</span> <span class="n">omap_dispchw_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dispc_uninit_platform_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dispchw_driver</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
