<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › omap2 › dss › rfbi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>rfbi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/omap2/dss/rfbi.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Nokia Corporation</span>
<span class="cm"> * Author: Tomi Valkeinen &lt;tomi.valkeinen@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Some code and ideas taken from drivers/video/omap/ driver</span>
<span class="cm"> * by Imre Deak.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>

<span class="cp">#define DSS_SUBSYS_NAME &quot;RFBI&quot;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kfifo.h&gt;</span>
<span class="cp">#include &lt;linux/ktime.h&gt;</span>
<span class="cp">#include &lt;linux/hrtimer.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;video/omapdss.h&gt;</span>
<span class="cp">#include &quot;dss.h&quot;</span>

<span class="k">struct</span> <span class="n">rfbi_reg</span> <span class="p">{</span> <span class="n">u16</span> <span class="n">idx</span><span class="p">;</span> <span class="p">};</span>

<span class="cp">#define RFBI_REG(idx)		((const struct rfbi_reg) { idx })</span>

<span class="cp">#define RFBI_REVISION		RFBI_REG(0x0000)</span>
<span class="cp">#define RFBI_SYSCONFIG		RFBI_REG(0x0010)</span>
<span class="cp">#define RFBI_SYSSTATUS		RFBI_REG(0x0014)</span>
<span class="cp">#define RFBI_CONTROL		RFBI_REG(0x0040)</span>
<span class="cp">#define RFBI_PIXEL_CNT		RFBI_REG(0x0044)</span>
<span class="cp">#define RFBI_LINE_NUMBER	RFBI_REG(0x0048)</span>
<span class="cp">#define RFBI_CMD		RFBI_REG(0x004c)</span>
<span class="cp">#define RFBI_PARAM		RFBI_REG(0x0050)</span>
<span class="cp">#define RFBI_DATA		RFBI_REG(0x0054)</span>
<span class="cp">#define RFBI_READ		RFBI_REG(0x0058)</span>
<span class="cp">#define RFBI_STATUS		RFBI_REG(0x005c)</span>

<span class="cp">#define RFBI_CONFIG(n)		RFBI_REG(0x0060 + (n)*0x18)</span>
<span class="cp">#define RFBI_ONOFF_TIME(n)	RFBI_REG(0x0064 + (n)*0x18)</span>
<span class="cp">#define RFBI_CYCLE_TIME(n)	RFBI_REG(0x0068 + (n)*0x18)</span>
<span class="cp">#define RFBI_DATA_CYCLE1(n)	RFBI_REG(0x006c + (n)*0x18)</span>
<span class="cp">#define RFBI_DATA_CYCLE2(n)	RFBI_REG(0x0070 + (n)*0x18)</span>
<span class="cp">#define RFBI_DATA_CYCLE3(n)	RFBI_REG(0x0074 + (n)*0x18)</span>

<span class="cp">#define RFBI_VSYNC_WIDTH	RFBI_REG(0x0090)</span>
<span class="cp">#define RFBI_HSYNC_WIDTH	RFBI_REG(0x0094)</span>

<span class="cp">#define REG_FLD_MOD(idx, val, start, end) \</span>
<span class="cp">	rfbi_write_reg(idx, FLD_MOD(rfbi_read_reg(idx), val, start, end))</span>

<span class="k">enum</span> <span class="n">omap_rfbi_cycleformat</span> <span class="p">{</span>
	<span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_1_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_2_1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_3_1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_3_2</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">omap_rfbi_datatype</span> <span class="p">{</span>
	<span class="n">OMAP_DSS_RFBI_DATATYPE_12</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">OMAP_DSS_RFBI_DATATYPE_16</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">OMAP_DSS_RFBI_DATATYPE_18</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">OMAP_DSS_RFBI_DATATYPE_24</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">omap_rfbi_parallelmode</span> <span class="p">{</span>
	<span class="n">OMAP_DSS_RFBI_PARALLELMODE_8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">OMAP_DSS_RFBI_PARALLELMODE_9</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">OMAP_DSS_RFBI_PARALLELMODE_12</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">OMAP_DSS_RFBI_PARALLELMODE_16</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rfbi_convert_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfbi_timings</span> <span class="o">*</span><span class="n">t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rfbi_get_clk_info</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">clk_period</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">max_clk_div</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">l4_khz</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">omap_rfbi_datatype</span> <span class="n">datatype</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_rfbi_parallelmode</span> <span class="n">parallelmode</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">omap_rfbi_te_mode</span> <span class="n">te_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">te_enabled</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">framedone_callback</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">framedone_callback_data</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">bus_lock</span><span class="p">;</span>
<span class="p">}</span> <span class="n">rfbi</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rfbi_write_reg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rfbi_reg</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rfbi</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">rfbi_read_reg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rfbi_reg</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">rfbi</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rfbi_runtime_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;rfbi_runtime_get</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfbi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rfbi_runtime_put</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;rfbi_runtime_put</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfbi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rfbi_bus_lock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfbi</span><span class="p">.</span><span class="n">bus_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rfbi_bus_lock</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rfbi_bus_unlock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfbi</span><span class="p">.</span><span class="n">bus_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rfbi_bus_unlock</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_rfbi_write_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rfbi</span><span class="p">.</span><span class="n">parallelmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_8</span>:
	<span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span><span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">)</span>
			<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_CMD</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="o">++</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_16</span>:
	<span class="p">{</span>
		<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span><span class="p">;</span> <span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_CMD</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="o">++</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_9</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_12</span>:
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_rfbi_write_command</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_rfbi_read_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rfbi</span><span class="p">.</span><span class="n">parallelmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_8</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span><span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="o">*</span><span class="n">b</span><span class="o">++</span> <span class="o">=</span> <span class="n">rfbi_read_reg</span><span class="p">(</span><span class="n">RFBI_READ</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_16</span>:
	<span class="p">{</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span><span class="p">;</span> <span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="o">*</span><span class="n">w</span><span class="o">++</span> <span class="o">=</span> <span class="n">rfbi_read_reg</span><span class="p">(</span><span class="n">RFBI_READ</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_9</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_12</span>:
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_rfbi_read_data</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_rfbi_write_data</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rfbi</span><span class="p">.</span><span class="n">parallelmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_8</span>:
	<span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span><span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">)</span>
			<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_PARAM</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="o">++</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_16</span>:
	<span class="p">{</span>
		<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span><span class="p">;</span> <span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_PARAM</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="o">++</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_9</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_12</span>:
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_rfbi_write_data</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_rfbi_write_pixels</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scr_width</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">y</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">w</span><span class="p">,</span> <span class="n">u16</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">start_offset</span> <span class="o">=</span> <span class="n">scr_width</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">horiz_offset</span> <span class="o">=</span> <span class="n">scr_width</span> <span class="o">-</span> <span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfbi</span><span class="p">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">OMAP_DSS_RFBI_DATATYPE_16</span> <span class="o">&amp;&amp;</span>
	   <span class="n">rfbi</span><span class="p">.</span><span class="n">parallelmode</span> <span class="o">==</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">pd</span> <span class="o">+=</span> <span class="n">start_offset</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">h</span><span class="p">;</span> <span class="o">--</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">pd</span><span class="p">;</span>
				<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_PARAM</span><span class="p">,</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
				<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_PARAM</span><span class="p">,</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">0</span><span class="p">));</span>
				<span class="o">++</span><span class="n">pd</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pd</span> <span class="o">+=</span> <span class="n">horiz_offset</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rfbi</span><span class="p">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">OMAP_DSS_RFBI_DATATYPE_24</span> <span class="o">&amp;&amp;</span>
	   <span class="n">rfbi</span><span class="p">.</span><span class="n">parallelmode</span> <span class="o">==</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">pd</span> <span class="o">+=</span> <span class="n">start_offset</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">h</span><span class="p">;</span> <span class="o">--</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">pd</span><span class="p">;</span>
				<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_PARAM</span><span class="p">,</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">2</span><span class="p">));</span>
				<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_PARAM</span><span class="p">,</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
				<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_PARAM</span><span class="p">,</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">0</span><span class="p">));</span>
				<span class="o">++</span><span class="n">pd</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pd</span> <span class="o">+=</span> <span class="n">horiz_offset</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rfbi</span><span class="p">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">OMAP_DSS_RFBI_DATATYPE_16</span> <span class="o">&amp;&amp;</span>
	   <span class="n">rfbi</span><span class="p">.</span><span class="n">parallelmode</span> <span class="o">==</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">pd</span> <span class="o">+=</span> <span class="n">start_offset</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">h</span><span class="p">;</span> <span class="o">--</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_PARAM</span><span class="p">,</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">pd</span><span class="p">));</span>
				<span class="o">++</span><span class="n">pd</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pd</span> <span class="o">+=</span> <span class="n">horiz_offset</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_rfbi_write_pixels</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rfbi_transfer_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">width</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">height</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="n">timings</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hsw</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hfp</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hbp</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsw</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfp</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbp</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">x_res</span>		<span class="o">=</span> <span class="n">width</span><span class="p">,</span>
		<span class="p">.</span><span class="n">y_res</span>		<span class="o">=</span> <span class="n">height</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="cm">/*BUG_ON(callback == 0);*/</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rfbi</span><span class="p">.</span><span class="n">framedone_callback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;rfbi_transfer_area %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="n">dss_mgr_set_timings</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timings</span><span class="p">);</span>

	<span class="n">dispc_mgr_enable</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">rfbi</span><span class="p">.</span><span class="n">framedone_callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">rfbi</span><span class="p">.</span><span class="n">framedone_callback_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_PIXEL_CNT</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">rfbi_read_reg</span><span class="p">(</span><span class="n">RFBI_CONTROL</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* enable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rfbi</span><span class="p">.</span><span class="n">te_enabled</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* ITE */</span>

	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_CONTROL</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">framedone_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;FRAMEDONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">RFBI_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">callback</span> <span class="o">=</span> <span class="n">rfbi</span><span class="p">.</span><span class="n">framedone_callback</span><span class="p">;</span>
	<span class="n">rfbi</span><span class="p">.</span><span class="n">framedone_callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">callback</span><span class="p">(</span><span class="n">rfbi</span><span class="p">.</span><span class="n">framedone_callback_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 1 </span><span class="cm">/* VERBOSE */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rfbi_print_timings</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">time</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">rfbi_read_reg</span><span class="p">(</span><span class="n">RFBI_CONFIG</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">time</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">rfbi</span><span class="p">.</span><span class="n">l4_khz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">time</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;Tick time %u ps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">rfbi_read_reg</span><span class="p">(</span><span class="n">RFBI_ONOFF_TIME</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;CSONTIME %d, CSOFFTIME %d, WEONTIME %d, WEOFFTIME %d, &quot;</span>
		<span class="s">&quot;REONTIME %d, REOFFTIME %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">l</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span>
		<span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">rfbi_read_reg</span><span class="p">(</span><span class="n">RFBI_CYCLE_TIME</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;WECYCLETIME %d, RECYCLETIME %d, CSPULSEWIDTH %d, &quot;</span>
		<span class="s">&quot;ACCESSTIME %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">),</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span>
		<span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rfbi_print_timings</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>




<span class="k">static</span> <span class="n">u32</span> <span class="n">extif_clk_period</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">round_to_extif_ticks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ps</span><span class="p">,</span> <span class="kt">int</span> <span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bus_tick</span> <span class="o">=</span> <span class="n">extif_clk_period</span> <span class="o">*</span> <span class="n">div</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ps</span> <span class="o">+</span> <span class="n">bus_tick</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">bus_tick</span> <span class="o">*</span> <span class="n">bus_tick</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calc_reg_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfbi_timings</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">clk_div</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_on_time</span> <span class="o">=</span> <span class="n">round_to_extif_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_on_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">we_on_time</span> <span class="o">=</span> <span class="n">round_to_extif_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">we_on_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">we_off_time</span> <span class="o">=</span> <span class="n">round_to_extif_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">we_off_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">we_cycle_time</span> <span class="o">=</span> <span class="n">round_to_extif_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">we_cycle_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">re_on_time</span> <span class="o">=</span> <span class="n">round_to_extif_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">re_on_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">re_off_time</span> <span class="o">=</span> <span class="n">round_to_extif_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">re_off_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">re_cycle_time</span> <span class="o">=</span> <span class="n">round_to_extif_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">re_cycle_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">access_time</span> <span class="o">=</span> <span class="n">round_to_extif_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">access_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_off_time</span> <span class="o">=</span> <span class="n">round_to_extif_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_off_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_pulse_width</span> <span class="o">=</span> <span class="n">round_to_extif_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_pulse_width</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;[reg]cson %d csoff %d reon %d reoff %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_on_time</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_off_time</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">re_on_time</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">re_off_time</span><span class="p">);</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;[reg]weon %d weoff %d recyc %d wecyc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">t</span><span class="o">-&gt;</span><span class="n">we_on_time</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">we_off_time</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">re_cycle_time</span><span class="p">,</span>
	       <span class="n">t</span><span class="o">-&gt;</span><span class="n">we_cycle_time</span><span class="p">);</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;[reg]rdaccess %d cspulse %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">t</span><span class="o">-&gt;</span><span class="n">access_time</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_pulse_width</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rfbi_convert_timings</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calc_extif_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfbi_timings</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">max_clk_div</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">rfbi_get_clk_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">extif_clk_period</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_clk_div</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">div</span> <span class="o">&lt;=</span> <span class="n">max_clk_div</span><span class="p">;</span> <span class="n">div</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">calc_reg_timing</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">div</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&lt;=</span> <span class="n">max_clk_div</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t setup timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rfbi_set_timings</span><span class="p">(</span><span class="kt">int</span> <span class="n">rfbi_module</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rfbi_timings</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">converted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">calc_extif_timings</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to calc timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">converted</span><span class="p">);</span>

	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_ONOFF_TIME</span><span class="p">(</span><span class="n">rfbi_module</span><span class="p">),</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_CYCLE_TIME</span><span class="p">(</span><span class="n">rfbi_module</span><span class="p">),</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* TIMEGRANULARITY */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">RFBI_CONFIG</span><span class="p">(</span><span class="n">rfbi_module</span><span class="p">),</span>
		    <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">rfbi_print_timings</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps_to_rfbi_ticks</span><span class="p">(</span><span class="kt">int</span> <span class="n">time</span><span class="p">,</span> <span class="kt">int</span> <span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tick_ps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Calculate in picosecs to yield more exact results */</span>
	<span class="n">tick_ps</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="p">(</span><span class="n">rfbi</span><span class="p">.</span><span class="n">l4_khz</span><span class="p">)</span> <span class="o">*</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">+</span> <span class="n">tick_ps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">tick_ps</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rfbi_get_clk_info</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">clk_period</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">max_clk_div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">clk_period</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">rfbi</span><span class="p">.</span><span class="n">l4_khz</span><span class="p">;</span>
	<span class="o">*</span><span class="n">max_clk_div</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rfbi_convert_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfbi_timings</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reon</span><span class="p">,</span> <span class="n">reoff</span><span class="p">,</span> <span class="n">weon</span><span class="p">,</span> <span class="n">weoff</span><span class="p">,</span> <span class="n">cson</span><span class="p">,</span> <span class="n">csoff</span><span class="p">,</span> <span class="n">cs_pulse</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">actim</span><span class="p">,</span> <span class="n">recyc</span><span class="p">,</span> <span class="n">wecyc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">div</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">clk_div</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">div</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Make sure that after conversion it still holds that:</span>
<span class="cm">	 * weoff &gt; weon, reoff &gt; reon, recyc &gt;= reoff, wecyc &gt;= weoff,</span>
<span class="cm">	 * csoff &gt; cson, csoff &gt;= max(weoff, reoff), actim &gt; reon</span>
<span class="cm">	 */</span>
	<span class="n">weon</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">we_on_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="n">weoff</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">we_off_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">weoff</span> <span class="o">&lt;=</span> <span class="n">weon</span><span class="p">)</span>
		<span class="n">weoff</span> <span class="o">=</span> <span class="n">weon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">weon</span> <span class="o">&gt;</span> <span class="mh">0x0f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">weoff</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">reon</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">re_on_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="n">reoff</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">re_off_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reoff</span> <span class="o">&lt;=</span> <span class="n">reon</span><span class="p">)</span>
		<span class="n">reoff</span> <span class="o">=</span> <span class="n">reon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reon</span> <span class="o">&gt;</span> <span class="mh">0x0f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reoff</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">cson</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_on_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="n">csoff</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_off_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csoff</span> <span class="o">&lt;=</span> <span class="n">cson</span><span class="p">)</span>
		<span class="n">csoff</span> <span class="o">=</span> <span class="n">cson</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csoff</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">(</span><span class="n">weoff</span><span class="p">,</span> <span class="n">reoff</span><span class="p">))</span>
		<span class="n">csoff</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">weoff</span><span class="p">,</span> <span class="n">reoff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cson</span> <span class="o">&gt;</span> <span class="mh">0x0f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csoff</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span>  <span class="n">cson</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">csoff</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">weon</span>  <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">weoff</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">reon</span>  <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">reoff</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">actim</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">access_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actim</span> <span class="o">&lt;=</span> <span class="n">reon</span><span class="p">)</span>
		<span class="n">actim</span> <span class="o">=</span> <span class="n">reon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actim</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wecyc</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">we_cycle_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wecyc</span> <span class="o">&lt;</span> <span class="n">weoff</span><span class="p">)</span>
		<span class="n">wecyc</span> <span class="o">=</span> <span class="n">weoff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wecyc</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">recyc</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">re_cycle_time</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recyc</span> <span class="o">&lt;</span> <span class="n">reoff</span><span class="p">)</span>
		<span class="n">recyc</span> <span class="o">=</span> <span class="n">reoff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recyc</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">cs_pulse</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_pulse_width</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs_pulse</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span>  <span class="n">wecyc</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">recyc</span>    <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">cs_pulse</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">actim</span>    <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">converted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xxx FIX module selection missing */</span>
<span class="kt">int</span> <span class="nf">omap_rfbi_setup_te</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_rfbi_te_mode</span> <span class="n">mode</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="n">hs_pulse_time</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">vs_pulse_time</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">hs_pol_inv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vs_pol_inv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">extif_div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hs</span><span class="p">,</span> <span class="n">vs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">hs</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">hs_pulse_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">vs</span> <span class="o">=</span> <span class="n">ps_to_rfbi_ticks</span><span class="p">(</span><span class="n">vs_pulse_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_RFBI_TE_MODE_2</span><span class="p">)</span>
		<span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* OMAP_DSS_RFBI_TE_MODE_1 */</span>
		<span class="n">min</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vs</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vs</span> <span class="o">==</span> <span class="n">hs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">rfbi</span><span class="p">.</span><span class="n">te_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;setup_te: mode %d hs %d vs %d hs_inv %d vs_inv %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mode</span><span class="p">,</span> <span class="n">hs</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">hs_pol_inv</span><span class="p">,</span> <span class="n">vs_pol_inv</span><span class="p">);</span>

	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_HSYNC_WIDTH</span><span class="p">,</span> <span class="n">hs</span><span class="p">);</span>
	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_VSYNC_WIDTH</span><span class="p">,</span> <span class="n">vs</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">rfbi_read_reg</span><span class="p">(</span><span class="n">RFBI_CONFIG</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hs_pol_inv</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vs_pol_inv</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_rfbi_setup_te</span><span class="p">);</span>

<span class="cm">/* xxx FIX module selection missing */</span>
<span class="kt">int</span> <span class="nf">omap_rfbi_enable_te</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;te %d line %d mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">rfbi</span><span class="p">.</span><span class="n">te_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">rfbi_read_reg</span><span class="p">(</span><span class="n">RFBI_CONFIG</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfbi</span><span class="p">.</span><span class="n">te_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">rfbi</span><span class="p">.</span><span class="n">te_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rfbi</span><span class="p">.</span><span class="n">te_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_CONFIG</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_LINE_NUMBER</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_rfbi_enable_te</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rfbi_configure</span><span class="p">(</span><span class="kt">int</span> <span class="n">rfbi_module</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cycle1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cycle2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cycle3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_rfbi_cycleformat</span> <span class="n">cycleformat</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_rfbi_datatype</span> <span class="n">datatype</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_rfbi_parallelmode</span> <span class="n">parallelmode</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_DATATYPE_12</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_DATATYPE_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">18</span>:
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_DATATYPE_18</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_DATATYPE_24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rfbi</span><span class="p">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="n">datatype</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">parallelmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">parallelmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_9</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">parallelmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_12</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">parallelmode</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_PARALLELMODE_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rfbi</span><span class="p">.</span><span class="n">parallelmode</span> <span class="o">=</span> <span class="n">parallelmode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bpp</span> <span class="o">%</span> <span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">/</span> <span class="n">lines</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">cycleformat</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_1_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">cycleformat</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_2_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">cycleformat</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_3_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">%</span> <span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">cycleformat</span> <span class="o">=</span> <span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_3_2</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">BUG</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cycleformat</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_1_1</span>:
		<span class="n">cycle1</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_2_1</span>:
		<span class="n">cycle1</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="n">cycle2</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_3_1</span>:
		<span class="n">cycle1</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="n">cycle2</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="n">cycle3</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OMAP_DSS_RFBI_CYCLEFORMAT_3_2</span>:
		<span class="n">cycle1</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="n">cycle2</span> <span class="o">=</span> <span class="p">(</span><span class="n">lines</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">lines</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cycle3</span> <span class="o">=</span> <span class="p">(</span><span class="n">lines</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">RFBI_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* clear CS */</span>

	<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">parallelmode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>		<span class="cm">/* TRIGGERMODE: ITE */</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>		<span class="cm">/* TIMEGRANULARITY */</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="cm">/* l |= FLD_VAL(2, 8, 7); */</span>	<span class="cm">/* L4FORMAT, 2pix/L4 */</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* L4FORMAT, 1pix/L4 */</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">cycleformat</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>	<span class="cm">/* UNUSEDBITS */</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* A0POLARITY */</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>	<span class="cm">/* REPOLARITY */</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>	<span class="cm">/* WEPOLARITY */</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>	<span class="cm">/* CSPOLARITY */</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>	<span class="cm">/* TE_VSYNC_POLARITY */</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>	<span class="cm">/* HSYNCPOLARITY */</span>
	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_CONFIG</span><span class="p">(</span><span class="n">rfbi_module</span><span class="p">),</span> <span class="n">l</span><span class="p">);</span>

	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_DATA_CYCLE1</span><span class="p">(</span><span class="n">rfbi_module</span><span class="p">),</span> <span class="n">cycle1</span><span class="p">);</span>
	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_DATA_CYCLE2</span><span class="p">(</span><span class="n">rfbi_module</span><span class="p">),</span> <span class="n">cycle2</span><span class="p">);</span>
	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_DATA_CYCLE3</span><span class="p">(</span><span class="n">rfbi_module</span><span class="p">),</span> <span class="n">cycle3</span><span class="p">);</span>


	<span class="n">l</span> <span class="o">=</span> <span class="n">rfbi_read_reg</span><span class="p">(</span><span class="n">RFBI_CONTROL</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">rfbi_module</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* Select CSx */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* clear bypass */</span>
	<span class="n">rfbi_write_reg</span><span class="p">(</span><span class="n">RFBI_CONTROL</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>


	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;RFBI config: bpp %d, lines %d, cycles: 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bpp</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">cycle1</span><span class="p">,</span> <span class="n">cycle2</span><span class="p">,</span> <span class="n">cycle3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap_rfbi_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixel_size</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">data_lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rfbi_configure</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rfbi</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">data_lines</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_rfbi_configure</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">omap_rfbi_prepare_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="n">timings</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hsw</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hfp</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hbp</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsw</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfp</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbp</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">x_res</span>		<span class="o">=</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		<span class="p">.</span><span class="n">y_res</span>		<span class="o">=</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_resolution</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dh</span><span class="p">);</span>

	<span class="k">if</span>  <span class="p">(</span><span class="o">*</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">dw</span> <span class="o">||</span> <span class="o">*</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">dh</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="o">*</span><span class="n">w</span> <span class="o">&gt;</span> <span class="n">dw</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="o">*</span><span class="n">h</span> <span class="o">&gt;</span> <span class="n">dh</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dss_mgr_set_timings</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timings</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_rfbi_prepare_update</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">omap_rfbi_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">y</span><span class="p">,</span> <span class="n">u16</span> <span class="n">w</span><span class="p">,</span> <span class="n">u16</span> <span class="n">h</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rfbi_transfer_area</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_rfbi_update</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rfbi_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define DUMPREG(r) seq_printf(s, &quot;%-35s %08x\n&quot;, #r, rfbi_read_reg(r))</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfbi_runtime_get</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_REVISION</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_SYSCONFIG</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_SYSSTATUS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_CONTROL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_PIXEL_CNT</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_LINE_NUMBER</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_CMD</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_PARAM</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_DATA</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_READ</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_STATUS</span><span class="p">);</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_CONFIG</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_ONOFF_TIME</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_CYCLE_TIME</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_DATA_CYCLE1</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_DATA_CYCLE2</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_DATA_CYCLE3</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_CONFIG</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_ONOFF_TIME</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_CYCLE_TIME</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_DATA_CYCLE1</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_DATA_CYCLE2</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_DATA_CYCLE3</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_VSYNC_WIDTH</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">RFBI_HSYNC_WIDTH</span><span class="p">);</span>

	<span class="n">rfbi_runtime_put</span><span class="p">();</span>
<span class="cp">#undef DUMPREG</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omapdss_rfbi_display_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to enable display: no manager</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">rfbi_runtime_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dss_start_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to start device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dispc_register_isr</span><span class="p">(</span><span class="n">framedone_callback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">DISPC_IRQ_FRAMEDONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get FRAMEDONE irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dispc_mgr_set_lcd_display_type</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">OMAP_DSS_LCD_DISPLAY_TFT</span><span class="p">);</span>

	<span class="n">dispc_mgr_set_io_pad_mode</span><span class="p">(</span><span class="n">DSS_IO_PAD_MODE_RFBI</span><span class="p">);</span>
	<span class="n">dispc_mgr_enable_stallmode</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">dispc_mgr_set_tft_data_lines</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pixel_size</span><span class="p">);</span>

	<span class="n">rfbi_configure</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rfbi</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
			       <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pixel_size</span><span class="p">,</span>
			       <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rfbi</span><span class="p">.</span><span class="n">data_lines</span><span class="p">);</span>

	<span class="n">rfbi_set_timings</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rfbi</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">rfbi_timings</span><span class="p">);</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err1:</span>
	<span class="n">omap_dss_stop_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="n">rfbi_runtime_put</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapdss_rfbi_display_enable</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omapdss_rfbi_display_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omap_dispc_unregister_isr</span><span class="p">(</span><span class="n">framedone_callback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">DISPC_IRQ_FRAMEDONE</span><span class="p">);</span>
	<span class="n">omap_dss_stop_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="n">rfbi_runtime_put</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapdss_rfbi_display_disable</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rfbi_init_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rfbi</span><span class="p">.</span><span class="n">dssdev</span><span class="p">[</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rfbi</span><span class="p">.</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">dssdev</span><span class="p">;</span>
	<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="n">OMAP_DSS_DISPLAY_CAP_MANUAL_UPDATE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">rfbi_probe_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_dss_board_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OMAP_DISPLAY_TYPE_DBI</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">rfbi_init_display</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;device %s init failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dss_register_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;device %s register failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* RFBI HW IP initialisation */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_rfbihw_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">rfbi_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">rfbi</span><span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfbi</span><span class="p">.</span><span class="n">bus_lock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">rfbi_mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">rfbi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rfbi_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get IORESOURCE_MEM RFBI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rfbi</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfbi_mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				 <span class="n">resource_size</span><span class="p">(</span><span class="n">rfbi_mem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rfbi</span><span class="p">.</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t ioremap RFBI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ick&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get ick</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rfbi</span><span class="p">.</span><span class="n">l4_khz</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">rfbi_runtime_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_runtime_get</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">rev</span> <span class="o">=</span> <span class="n">rfbi_read_reg</span><span class="p">(</span><span class="n">RFBI_REVISION</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OMAP RFBI rev %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">FLD_GET</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">rfbi_runtime_put</span><span class="p">();</span>

	<span class="n">dss_debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rfbi&quot;</span><span class="p">,</span> <span class="n">rfbi_dump_regs</span><span class="p">);</span>

	<span class="n">rfbi_probe_pdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_runtime_get:</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">omap_rfbihw_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omap_dss_unregister_child_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rfbi_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_runtime_put</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rfbi_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dispc_runtime_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">rfbi_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">runtime_suspend</span> <span class="o">=</span> <span class="n">rfbi_runtime_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span> <span class="o">=</span> <span class="n">rfbi_runtime_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omap_rfbihw_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">omap_rfbihw_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>         <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;omapdss_rfbi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rfbi_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">rfbi_init_platform_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_rfbihw_driver</span><span class="p">,</span> <span class="n">omap_rfbihw_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">rfbi_uninit_platform_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_rfbihw_driver</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
