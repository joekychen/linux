<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › omap2 › dss › venc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>venc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/omap2/dss/venc.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Nokia Corporation</span>
<span class="cm"> * Author: Tomi Valkeinen &lt;tomi.valkeinen@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * VENC settings from TI&#39;s DSS driver</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>

<span class="cp">#define DSS_SUBSYS_NAME &quot;VENC&quot;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;video/omapdss.h&gt;</span>
<span class="cp">#include &lt;plat/cpu.h&gt;</span>

<span class="cp">#include &quot;dss.h&quot;</span>
<span class="cp">#include &quot;dss_features.h&quot;</span>

<span class="cm">/* Venc registers */</span>
<span class="cp">#define VENC_REV_ID				0x00</span>
<span class="cp">#define VENC_STATUS				0x04</span>
<span class="cp">#define VENC_F_CONTROL				0x08</span>
<span class="cp">#define VENC_VIDOUT_CTRL			0x10</span>
<span class="cp">#define VENC_SYNC_CTRL				0x14</span>
<span class="cp">#define VENC_LLEN				0x1C</span>
<span class="cp">#define VENC_FLENS				0x20</span>
<span class="cp">#define VENC_HFLTR_CTRL				0x24</span>
<span class="cp">#define VENC_CC_CARR_WSS_CARR			0x28</span>
<span class="cp">#define VENC_C_PHASE				0x2C</span>
<span class="cp">#define VENC_GAIN_U				0x30</span>
<span class="cp">#define VENC_GAIN_V				0x34</span>
<span class="cp">#define VENC_GAIN_Y				0x38</span>
<span class="cp">#define VENC_BLACK_LEVEL			0x3C</span>
<span class="cp">#define VENC_BLANK_LEVEL			0x40</span>
<span class="cp">#define VENC_X_COLOR				0x44</span>
<span class="cp">#define VENC_M_CONTROL				0x48</span>
<span class="cp">#define VENC_BSTAMP_WSS_DATA			0x4C</span>
<span class="cp">#define VENC_S_CARR				0x50</span>
<span class="cp">#define VENC_LINE21				0x54</span>
<span class="cp">#define VENC_LN_SEL				0x58</span>
<span class="cp">#define VENC_L21__WC_CTL			0x5C</span>
<span class="cp">#define VENC_HTRIGGER_VTRIGGER			0x60</span>
<span class="cp">#define VENC_SAVID__EAVID			0x64</span>
<span class="cp">#define VENC_FLEN__FAL				0x68</span>
<span class="cp">#define VENC_LAL__PHASE_RESET			0x6C</span>
<span class="cp">#define VENC_HS_INT_START_STOP_X		0x70</span>
<span class="cp">#define VENC_HS_EXT_START_STOP_X		0x74</span>
<span class="cp">#define VENC_VS_INT_START_X			0x78</span>
<span class="cp">#define VENC_VS_INT_STOP_X__VS_INT_START_Y	0x7C</span>
<span class="cp">#define VENC_VS_INT_STOP_Y__VS_EXT_START_X	0x80</span>
<span class="cp">#define VENC_VS_EXT_STOP_X__VS_EXT_START_Y	0x84</span>
<span class="cp">#define VENC_VS_EXT_STOP_Y			0x88</span>
<span class="cp">#define VENC_AVID_START_STOP_X			0x90</span>
<span class="cp">#define VENC_AVID_START_STOP_Y			0x94</span>
<span class="cp">#define VENC_FID_INT_START_X__FID_INT_START_Y	0xA0</span>
<span class="cp">#define VENC_FID_INT_OFFSET_Y__FID_EXT_START_X	0xA4</span>
<span class="cp">#define VENC_FID_EXT_START_Y__FID_EXT_OFFSET_Y	0xA8</span>
<span class="cp">#define VENC_TVDETGP_INT_START_STOP_X		0xB0</span>
<span class="cp">#define VENC_TVDETGP_INT_START_STOP_Y		0xB4</span>
<span class="cp">#define VENC_GEN_CTRL				0xB8</span>
<span class="cp">#define VENC_OUTPUT_CONTROL			0xC4</span>
<span class="cp">#define VENC_OUTPUT_TEST			0xC8</span>
<span class="cp">#define VENC_DAC_B__DAC_C			0xC8</span>

<span class="k">struct</span> <span class="n">venc_config</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">f_control</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vidout_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sync_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">llen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flens</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hfltr_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cc_carr_wss_carr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">c_phase</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gain_u</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gain_v</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gain_y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">black_level</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">blank_level</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">x_color</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m_control</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bstamp_wss_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">s_carr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">line21</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ln_sel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l21__wc_ctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">htrigger_vtrigger</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">savid__eavid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flen__fal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lal__phase_reset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hs_int_start_stop_x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hs_ext_start_stop_x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vs_int_start_x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vs_int_stop_x__vs_int_start_y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vs_int_stop_y__vs_ext_start_x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vs_ext_stop_x__vs_ext_start_y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vs_ext_stop_y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">avid_start_stop_x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">avid_start_stop_y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fid_int_start_x__fid_int_start_y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fid_int_offset_y__fid_ext_start_x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fid_ext_start_y__fid_ext_offset_y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tvdetgp_int_start_stop_x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tvdetgp_int_start_stop_y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gen_ctrl</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* from TRM */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">venc_config</span> <span class="n">venc_config_pal_trm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">f_control</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidout_ctrl</span>				<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_ctrl</span>				<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llen</span>					<span class="o">=</span> <span class="mh">0x35F</span><span class="p">,</span> <span class="cm">/* 863 */</span>
	<span class="p">.</span><span class="n">flens</span>					<span class="o">=</span> <span class="mh">0x270</span><span class="p">,</span> <span class="cm">/* 624 */</span>
	<span class="p">.</span><span class="n">hfltr_ctrl</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cc_carr_wss_carr</span>			<span class="o">=</span> <span class="mh">0x2F7225ED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_phase</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gain_u</span>					<span class="o">=</span> <span class="mh">0x111</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gain_v</span>					<span class="o">=</span> <span class="mh">0x181</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gain_y</span>					<span class="o">=</span> <span class="mh">0x140</span><span class="p">,</span>
	<span class="p">.</span><span class="n">black_level</span>				<span class="o">=</span> <span class="mh">0x3B</span><span class="p">,</span>
	<span class="p">.</span><span class="n">blank_level</span>				<span class="o">=</span> <span class="mh">0x3B</span><span class="p">,</span>
	<span class="p">.</span><span class="n">x_color</span>				<span class="o">=</span> <span class="mh">0x7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">m_control</span>				<span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bstamp_wss_data</span>			<span class="o">=</span> <span class="mh">0x3F</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_carr</span>					<span class="o">=</span> <span class="mh">0x2A098ACB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line21</span>					<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ln_sel</span>					<span class="o">=</span> <span class="mh">0x01290015</span><span class="p">,</span>
	<span class="p">.</span><span class="n">l21__wc_ctl</span>				<span class="o">=</span> <span class="mh">0x0000F603</span><span class="p">,</span>
	<span class="p">.</span><span class="n">htrigger_vtrigger</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

	<span class="p">.</span><span class="n">savid__eavid</span>				<span class="o">=</span> <span class="mh">0x06A70108</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flen__fal</span>				<span class="o">=</span> <span class="mh">0x00180270</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lal__phase_reset</span>			<span class="o">=</span> <span class="mh">0x00040135</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hs_int_start_stop_x</span>			<span class="o">=</span> <span class="mh">0x00880358</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hs_ext_start_stop_x</span>			<span class="o">=</span> <span class="mh">0x000F035F</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_int_start_x</span>				<span class="o">=</span> <span class="mh">0x01A70000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_int_stop_x__vs_int_start_y</span>		<span class="o">=</span> <span class="mh">0x000001A7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_int_stop_y__vs_ext_start_x</span>		<span class="o">=</span> <span class="mh">0x01AF0000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_ext_stop_x__vs_ext_start_y</span>		<span class="o">=</span> <span class="mh">0x000101AF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_ext_stop_y</span>				<span class="o">=</span> <span class="mh">0x00000025</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avid_start_stop_x</span>			<span class="o">=</span> <span class="mh">0x03530083</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avid_start_stop_y</span>			<span class="o">=</span> <span class="mh">0x026C002E</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fid_int_start_x__fid_int_start_y</span>	<span class="o">=</span> <span class="mh">0x0001008A</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fid_int_offset_y__fid_ext_start_x</span>	<span class="o">=</span> <span class="mh">0x002E0138</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fid_ext_start_y__fid_ext_offset_y</span>	<span class="o">=</span> <span class="mh">0x01380001</span><span class="p">,</span>

	<span class="p">.</span><span class="n">tvdetgp_int_start_stop_x</span>		<span class="o">=</span> <span class="mh">0x00140001</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvdetgp_int_start_stop_y</span>		<span class="o">=</span> <span class="mh">0x00010001</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gen_ctrl</span>				<span class="o">=</span> <span class="mh">0x00FF0000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* from TRM */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">venc_config</span> <span class="n">venc_config_ntsc_trm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">f_control</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidout_ctrl</span>				<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_ctrl</span>				<span class="o">=</span> <span class="mh">0x8040</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llen</span>					<span class="o">=</span> <span class="mh">0x359</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flens</span>					<span class="o">=</span> <span class="mh">0x20C</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hfltr_ctrl</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cc_carr_wss_carr</span>			<span class="o">=</span> <span class="mh">0x043F2631</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_phase</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gain_u</span>					<span class="o">=</span> <span class="mh">0x102</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gain_v</span>					<span class="o">=</span> <span class="mh">0x16C</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gain_y</span>					<span class="o">=</span> <span class="mh">0x12F</span><span class="p">,</span>
	<span class="p">.</span><span class="n">black_level</span>				<span class="o">=</span> <span class="mh">0x43</span><span class="p">,</span>
	<span class="p">.</span><span class="n">blank_level</span>				<span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>
	<span class="p">.</span><span class="n">x_color</span>				<span class="o">=</span> <span class="mh">0x7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">m_control</span>				<span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bstamp_wss_data</span>			<span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_carr</span>					<span class="o">=</span> <span class="mh">0x21F07C1F</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line21</span>					<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ln_sel</span>					<span class="o">=</span> <span class="mh">0x01310011</span><span class="p">,</span>
	<span class="p">.</span><span class="n">l21__wc_ctl</span>				<span class="o">=</span> <span class="mh">0x0000F003</span><span class="p">,</span>
	<span class="p">.</span><span class="n">htrigger_vtrigger</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

	<span class="p">.</span><span class="n">savid__eavid</span>				<span class="o">=</span> <span class="mh">0x069300F4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flen__fal</span>				<span class="o">=</span> <span class="mh">0x0016020C</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lal__phase_reset</span>			<span class="o">=</span> <span class="mh">0x00060107</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hs_int_start_stop_x</span>			<span class="o">=</span> <span class="mh">0x008E0350</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hs_ext_start_stop_x</span>			<span class="o">=</span> <span class="mh">0x000F0359</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_int_start_x</span>				<span class="o">=</span> <span class="mh">0x01A00000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_int_stop_x__vs_int_start_y</span>		<span class="o">=</span> <span class="mh">0x020701A0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_int_stop_y__vs_ext_start_x</span>		<span class="o">=</span> <span class="mh">0x01AC0024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_ext_stop_x__vs_ext_start_y</span>		<span class="o">=</span> <span class="mh">0x020D01AC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_ext_stop_y</span>				<span class="o">=</span> <span class="mh">0x00000006</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avid_start_stop_x</span>			<span class="o">=</span> <span class="mh">0x03480078</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avid_start_stop_y</span>			<span class="o">=</span> <span class="mh">0x02060024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fid_int_start_x__fid_int_start_y</span>	<span class="o">=</span> <span class="mh">0x0001008A</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fid_int_offset_y__fid_ext_start_x</span>	<span class="o">=</span> <span class="mh">0x01AC0106</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fid_ext_start_y__fid_ext_offset_y</span>	<span class="o">=</span> <span class="mh">0x01060006</span><span class="p">,</span>

	<span class="p">.</span><span class="n">tvdetgp_int_start_stop_x</span>		<span class="o">=</span> <span class="mh">0x00140001</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvdetgp_int_start_stop_y</span>		<span class="o">=</span> <span class="mh">0x00010001</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gen_ctrl</span>				<span class="o">=</span> <span class="mh">0x00F90000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">venc_config</span> <span class="n">venc_config_pal_bdghi</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">f_control</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidout_ctrl</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_ctrl</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hfltr_ctrl</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">x_color</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line21</span>					<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ln_sel</span>					<span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
	<span class="p">.</span><span class="n">htrigger_vtrigger</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvdetgp_int_start_stop_x</span>		<span class="o">=</span> <span class="mh">0x00140001</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvdetgp_int_start_stop_y</span>		<span class="o">=</span> <span class="mh">0x00010001</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gen_ctrl</span>				<span class="o">=</span> <span class="mh">0x00FB0000</span><span class="p">,</span>

	<span class="p">.</span><span class="n">llen</span>					<span class="o">=</span> <span class="mi">864</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flens</span>					<span class="o">=</span> <span class="mi">625</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cc_carr_wss_carr</span>			<span class="o">=</span> <span class="mh">0x2F7625ED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_phase</span>				<span class="o">=</span> <span class="mh">0xDF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gain_u</span>					<span class="o">=</span> <span class="mh">0x111</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gain_v</span>					<span class="o">=</span> <span class="mh">0x181</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gain_y</span>					<span class="o">=</span> <span class="mh">0x140</span><span class="p">,</span>
	<span class="p">.</span><span class="n">black_level</span>				<span class="o">=</span> <span class="mh">0x3e</span><span class="p">,</span>
	<span class="p">.</span><span class="n">blank_level</span>				<span class="o">=</span> <span class="mh">0x3e</span><span class="p">,</span>
	<span class="p">.</span><span class="n">m_control</span>				<span class="o">=</span> <span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">2</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bstamp_wss_data</span>			<span class="o">=</span> <span class="mh">0x42</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_carr</span>					<span class="o">=</span> <span class="mh">0x2a098acb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">l21__wc_ctl</span>				<span class="o">=</span> <span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">13</span> <span class="o">|</span> <span class="mh">0x16</span><span class="o">&lt;&lt;</span><span class="mi">8</span> <span class="o">|</span> <span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">savid__eavid</span>				<span class="o">=</span> <span class="mh">0x06A70108</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flen__fal</span>				<span class="o">=</span> <span class="mi">23</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="mi">624</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lal__phase_reset</span>			<span class="o">=</span> <span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">17</span> <span class="o">|</span> <span class="mi">310</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hs_int_start_stop_x</span>			<span class="o">=</span> <span class="mh">0x00920358</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hs_ext_start_stop_x</span>			<span class="o">=</span> <span class="mh">0x000F035F</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_int_start_x</span>				<span class="o">=</span> <span class="mh">0x1a7</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_int_stop_x__vs_int_start_y</span>		<span class="o">=</span> <span class="mh">0x000601A7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_int_stop_y__vs_ext_start_x</span>		<span class="o">=</span> <span class="mh">0x01AF0036</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_ext_stop_x__vs_ext_start_y</span>		<span class="o">=</span> <span class="mh">0x27101af</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_ext_stop_y</span>				<span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avid_start_stop_x</span>			<span class="o">=</span> <span class="mh">0x03530082</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avid_start_stop_y</span>			<span class="o">=</span> <span class="mh">0x0270002E</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fid_int_start_x__fid_int_start_y</span>	<span class="o">=</span> <span class="mh">0x0005008A</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fid_int_offset_y__fid_ext_start_x</span>	<span class="o">=</span> <span class="mh">0x002E0138</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fid_ext_start_y__fid_ext_offset_y</span>	<span class="o">=</span> <span class="mh">0x01380005</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="n">omap_dss_pal_timings</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">x_res</span>		<span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
	<span class="p">.</span><span class="n">y_res</span>		<span class="o">=</span> <span class="mi">574</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pixel_clock</span>	<span class="o">=</span> <span class="mi">13500</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsw</span>		<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hfp</span>		<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hbp</span>		<span class="o">=</span> <span class="mi">68</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsw</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vfp</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbp</span>		<span class="o">=</span> <span class="mi">41</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dss_pal_timings</span><span class="p">);</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="n">omap_dss_ntsc_timings</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">x_res</span>		<span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
	<span class="p">.</span><span class="n">y_res</span>		<span class="o">=</span> <span class="mi">482</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pixel_clock</span>	<span class="o">=</span> <span class="mi">13500</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsw</span>		<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hfp</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hbp</span>		<span class="o">=</span> <span class="mi">58</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsw</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vfp</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbp</span>		<span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dss_ntsc_timings</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">venc_lock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wss_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">vdda_dac_reg</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">clk</span>	<span class="o">*</span><span class="n">tv_dac_clk</span><span class="p">;</span>
<span class="p">}</span> <span class="n">venc</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">venc_write_reg</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">venc</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">venc_read_reg</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">venc_write_config</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">venc_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;write venc conf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_LLEN</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">llen</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_FLENS</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">flens</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_CC_CARR_WSS_CARR</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">cc_carr_wss_carr</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_C_PHASE</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">c_phase</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_GAIN_U</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">gain_u</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_GAIN_V</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">gain_v</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_GAIN_Y</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">gain_y</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_BLACK_LEVEL</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">black_level</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_BLANK_LEVEL</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">blank_level</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_M_CONTROL</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">m_control</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_BSTAMP_WSS_DATA</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bstamp_wss_data</span> <span class="o">|</span>
			<span class="n">venc</span><span class="p">.</span><span class="n">wss_data</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_S_CARR</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">s_carr</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_L21__WC_CTL</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">l21__wc_ctl</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_SAVID__EAVID</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">savid__eavid</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_FLEN__FAL</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">flen__fal</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_LAL__PHASE_RESET</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">lal__phase_reset</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_HS_INT_START_STOP_X</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">hs_int_start_stop_x</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_HS_EXT_START_STOP_X</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">hs_ext_start_stop_x</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_VS_INT_START_X</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">vs_int_start_x</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_VS_INT_STOP_X__VS_INT_START_Y</span><span class="p">,</span>
		       <span class="n">config</span><span class="o">-&gt;</span><span class="n">vs_int_stop_x__vs_int_start_y</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_VS_INT_STOP_Y__VS_EXT_START_X</span><span class="p">,</span>
		       <span class="n">config</span><span class="o">-&gt;</span><span class="n">vs_int_stop_y__vs_ext_start_x</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_VS_EXT_STOP_X__VS_EXT_START_Y</span><span class="p">,</span>
		       <span class="n">config</span><span class="o">-&gt;</span><span class="n">vs_ext_stop_x__vs_ext_start_y</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_VS_EXT_STOP_Y</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">vs_ext_stop_y</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_AVID_START_STOP_X</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">avid_start_stop_x</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_AVID_START_STOP_Y</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">avid_start_stop_y</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_FID_INT_START_X__FID_INT_START_Y</span><span class="p">,</span>
		       <span class="n">config</span><span class="o">-&gt;</span><span class="n">fid_int_start_x__fid_int_start_y</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_FID_INT_OFFSET_Y__FID_EXT_START_X</span><span class="p">,</span>
		       <span class="n">config</span><span class="o">-&gt;</span><span class="n">fid_int_offset_y__fid_ext_start_x</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_FID_EXT_START_Y__FID_EXT_OFFSET_Y</span><span class="p">,</span>
		       <span class="n">config</span><span class="o">-&gt;</span><span class="n">fid_ext_start_y__fid_ext_offset_y</span><span class="p">);</span>

	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_DAC_B__DAC_C</span><span class="p">,</span>  <span class="n">venc_read_reg</span><span class="p">(</span><span class="n">VENC_DAC_B__DAC_C</span><span class="p">));</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_VIDOUT_CTRL</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">vidout_ctrl</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_HFLTR_CTRL</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">hfltr_ctrl</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_X_COLOR</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">x_color</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_LINE21</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">line21</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_LN_SEL</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">ln_sel</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_HTRIGGER_VTRIGGER</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">htrigger_vtrigger</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_TVDETGP_INT_START_STOP_X</span><span class="p">,</span>
		       <span class="n">config</span><span class="o">-&gt;</span><span class="n">tvdetgp_int_start_stop_x</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_TVDETGP_INT_START_STOP_Y</span><span class="p">,</span>
		       <span class="n">config</span><span class="o">-&gt;</span><span class="n">tvdetgp_int_start_stop_y</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_GEN_CTRL</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">gen_ctrl</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_F_CONTROL</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">f_control</span><span class="p">);</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_SYNC_CTRL</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">sync_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">venc_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_F_CONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">venc_read_reg</span><span class="p">(</span><span class="n">VENC_F_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to reset venc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_SLEEP_AFTER_VENC_RESET</span>
	<span class="cm">/* the magical sleep that makes things work */</span>
	<span class="cm">/* XXX more info? What bug this circumvents? */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_runtime_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;venc_runtime_get</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">venc_runtime_put</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;venc_runtime_put</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">venc_config</span> <span class="o">*</span><span class="nf">venc_timings_to_config</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dss_pal_timings</span><span class="p">,</span> <span class="n">timings</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">timings</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">venc_config_pal_trm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dss_ntsc_timings</span><span class="p">,</span> <span class="n">timings</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">timings</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">venc_config_ntsc_trm</span><span class="p">;</span>

	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">venc_reset</span><span class="p">();</span>
	<span class="n">venc_write_config</span><span class="p">(</span><span class="n">venc_timings_to_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">));</span>

	<span class="n">dss_set_venc_output</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">venc</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
	<span class="n">dss_set_dac_pwrdn_bgz</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">venc</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OMAP_DSS_VENC_TYPE_COMPOSITE</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* S-Video */</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">venc</span><span class="p">.</span><span class="n">invert_polarity</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_OUTPUT_CONTROL</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

	<span class="n">dss_mgr_set_timings</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">vdda_dac_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_enable</span><span class="p">)</span>
		<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_enable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dss_mgr_enable</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_OUTPUT_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dss_set_dac_pwrdn_bgz</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_disable</span><span class="p">)</span>
		<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_disable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="n">regulator_disable</span><span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">vdda_dac_reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">venc_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_OUTPUT_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dss_set_dac_pwrdn_bgz</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">dss_mgr_disable</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_disable</span><span class="p">)</span>
		<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_disable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="n">regulator_disable</span><span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">vdda_dac_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">venc_get_pixel_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* VENC Pixel Clock in Mhz */</span>
	<span class="k">return</span> <span class="mi">13500000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">display_output_type_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span> <span class="o">=</span> <span class="n">to_dss_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">venc</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_VENC_TYPE_COMPOSITE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;composite&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_VENC_TYPE_SVIDEO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;svideo&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">display_output_type_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span> <span class="o">=</span> <span class="n">to_dss_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">omap_dss_venc_type</span> <span class="n">new_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_streq</span><span class="p">(</span><span class="s">&quot;composite&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">new_type</span> <span class="o">=</span> <span class="n">OMAP_DSS_VENC_TYPE_COMPOSITE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sysfs_streq</span><span class="p">(</span><span class="s">&quot;svideo&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">new_type</span> <span class="o">=</span> <span class="n">OMAP_DSS_VENC_TYPE_SVIDEO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">venc_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">venc</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">new_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">venc</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">new_type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">OMAP_DSS_DISPLAY_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">venc_power_off</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
			<span class="n">venc_power_on</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">venc_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">output_type</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		<span class="n">display_output_type_show</span><span class="p">,</span> <span class="n">display_output_type_store</span><span class="p">);</span>

<span class="cm">/* driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_panel_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span> <span class="o">=</span> <span class="n">omap_dss_pal_timings</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_output_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">venc_panel_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_output_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_panel_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;venc_enable_display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">venc_lock</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dss_start_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to start device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">OMAP_DSS_DISPLAY_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">venc_runtime_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">venc_power_on</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="n">venc</span><span class="p">.</span><span class="n">wss_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OMAP_DSS_DISPLAY_ACTIVE</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">venc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err2:</span>
	<span class="n">venc_runtime_put</span><span class="p">();</span>
<span class="nl">err1:</span>
	<span class="n">omap_dss_stop_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">venc_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">venc_panel_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;venc_disable_display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">venc_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">OMAP_DSS_DISPLAY_DISABLED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">OMAP_DSS_DISPLAY_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* suspended is the same as disabled with venc */</span>
		<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OMAP_DSS_DISPLAY_DISABLED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">venc_power_off</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="n">venc_runtime_put</span><span class="p">();</span>

	<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OMAP_DSS_DISPLAY_DISABLED</span><span class="p">;</span>

	<span class="n">omap_dss_stop_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">venc_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_panel_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">venc_panel_disable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_panel_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">venc_panel_enable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">venc_set_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;venc_set_timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Reset WSS data when the TV standard changes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">,</span> <span class="n">timings</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">timings</span><span class="p">)))</span>
		<span class="n">venc</span><span class="p">.</span><span class="n">wss_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span> <span class="o">=</span> <span class="o">*</span><span class="n">timings</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">OMAP_DSS_DISPLAY_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* turn the venc off and on to get new timings to use */</span>
		<span class="n">venc_panel_disable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
		<span class="n">venc_panel_enable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dss_mgr_set_timings</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="n">timings</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_check_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;venc_check_timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dss_pal_timings</span><span class="p">,</span> <span class="n">timings</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">timings</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dss_ntsc_timings</span><span class="p">,</span> <span class="n">timings</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">timings</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">venc_get_wss</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Invert due to VENC_L21_WC_CTL:INV=1 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">wss_data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xfffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_set_wss</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>	<span class="n">u32</span> <span class="n">wss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">venc_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;venc_set_wss</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">venc_lock</span><span class="p">);</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">venc_timings_to_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">);</span>

	<span class="cm">/* Invert due to VENC_L21_WC_CTL:INV=1 */</span>
	<span class="n">venc</span><span class="p">.</span><span class="n">wss_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">wss</span> <span class="o">^</span> <span class="mh">0xfffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">venc_runtime_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">venc_write_reg</span><span class="p">(</span><span class="n">VENC_BSTAMP_WSS_DATA</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bstamp_wss_data</span> <span class="o">|</span>
			<span class="n">venc</span><span class="p">.</span><span class="n">wss_data</span><span class="p">);</span>

	<span class="n">venc_runtime_put</span><span class="p">();</span>

<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">venc_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_dss_driver</span> <span class="n">venc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">venc_panel_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">venc_panel_remove</span><span class="p">,</span>

	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">venc_panel_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">venc_panel_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">venc_panel_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">venc_panel_resume</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_resolution</span>	<span class="o">=</span> <span class="n">omapdss_default_get_resolution</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_recommended_bpp</span> <span class="o">=</span> <span class="n">omapdss_default_get_recommended_bpp</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_timings</span>	<span class="o">=</span> <span class="n">venc_set_timings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_timings</span>	<span class="o">=</span> <span class="n">venc_check_timings</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_wss</span>	<span class="o">=</span> <span class="n">venc_get_wss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wss</span>	<span class="o">=</span> <span class="n">venc_set_wss</span><span class="p">,</span>

	<span class="p">.</span><span class="n">driver</span>         <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;venc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="cm">/* driver end */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">venc_init_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;init_display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">vdda_dac_reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">vdda_dac</span><span class="p">;</span>

		<span class="n">vdda_dac</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vdda_dac&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vdda_dac</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get VDDA_DAC regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">vdda_dac</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">venc</span><span class="p">.</span><span class="n">vdda_dac_reg</span> <span class="o">=</span> <span class="n">vdda_dac</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">venc_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define DUMPREG(r) seq_printf(s, &quot;%-35s %08x\n&quot;, #r, venc_read_reg(r))</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap44xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;VENC currently disabled on OMAP44xx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">venc_runtime_get</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_F_CONTROL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_VIDOUT_CTRL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_SYNC_CTRL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_LLEN</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_FLENS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_HFLTR_CTRL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_CC_CARR_WSS_CARR</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_C_PHASE</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_GAIN_U</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_GAIN_V</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_GAIN_Y</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_BLACK_LEVEL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_BLANK_LEVEL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_X_COLOR</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_M_CONTROL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_BSTAMP_WSS_DATA</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_S_CARR</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_LINE21</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_LN_SEL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_L21__WC_CTL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_HTRIGGER_VTRIGGER</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_SAVID__EAVID</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_FLEN__FAL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_LAL__PHASE_RESET</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_HS_INT_START_STOP_X</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_HS_EXT_START_STOP_X</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_VS_INT_START_X</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_VS_INT_STOP_X__VS_INT_START_Y</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_VS_INT_STOP_Y__VS_EXT_START_X</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_VS_EXT_STOP_X__VS_EXT_START_Y</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_VS_EXT_STOP_Y</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_AVID_START_STOP_X</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_AVID_START_STOP_Y</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_FID_INT_START_X__FID_INT_START_Y</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_FID_INT_OFFSET_Y__FID_EXT_START_X</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_FID_EXT_START_Y__FID_EXT_OFFSET_Y</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_TVDETGP_INT_START_STOP_X</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_TVDETGP_INT_START_STOP_Y</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_GEN_CTRL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_OUTPUT_CONTROL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">VENC_OUTPUT_TEST</span><span class="p">);</span>

	<span class="n">venc_runtime_put</span><span class="p">();</span>

<span class="cp">#undef DUMPREG</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_get_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_VENC_REQUIRES_TV_DAC_CLK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tv_dac_clk&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get tv_dac_clk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">venc</span><span class="p">.</span><span class="n">tv_dac_clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">venc_put_clocks</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">tv_dac_clk</span><span class="p">)</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">tv_dac_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">venc_probe_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_dss_board_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OMAP_DISPLAY_TYPE_VENC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">venc_init_display</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;device %s init failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dss_register_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;device %s register failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* VENC HW IP initialisation */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_venchw_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">venc_mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">venc</span><span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc</span><span class="p">.</span><span class="n">venc_lock</span><span class="p">);</span>

	<span class="n">venc</span><span class="p">.</span><span class="n">wss_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">venc_mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">venc_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get IORESOURCE_MEM VENC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">venc</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">venc_mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				 <span class="n">resource_size</span><span class="p">(</span><span class="n">venc_mem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">venc</span><span class="p">.</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t ioremap VENC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">venc_get_clocks</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">venc_runtime_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_runtime_get</span><span class="p">;</span>

	<span class="n">rev_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">venc_read_reg</span><span class="p">(</span><span class="n">VENC_REV_ID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OMAP VENC rev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rev_id</span><span class="p">);</span>

	<span class="n">venc_runtime_put</span><span class="p">();</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dss_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_reg_panel_driver</span><span class="p">;</span>

	<span class="n">dss_debugfs_create_file</span><span class="p">(</span><span class="s">&quot;venc&quot;</span><span class="p">,</span> <span class="n">venc_dump_regs</span><span class="p">);</span>

	<span class="n">venc_probe_pdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_reg_panel_driver:</span>
<span class="nl">err_runtime_get:</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">venc_put_clocks</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">omap_venchw_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omap_dss_unregister_child_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">vdda_dac_reg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">vdda_dac_reg</span><span class="p">);</span>
		<span class="n">venc</span><span class="p">.</span><span class="n">vdda_dac_reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">omap_dss_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">venc_driver</span><span class="p">);</span>

	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">venc_put_clocks</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">tv_dac_clk</span><span class="p">)</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">tv_dac_clk</span><span class="p">);</span>

	<span class="n">dispc_runtime_put</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">venc_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dispc_runtime_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">tv_dac_clk</span><span class="p">)</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">venc</span><span class="p">.</span><span class="n">tv_dac_clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">venc_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">runtime_suspend</span> <span class="o">=</span> <span class="n">venc_runtime_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span> <span class="o">=</span> <span class="n">venc_runtime_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omap_venchw_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">omap_venchw_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>         <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;omapdss_venc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">venc_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">venc_init_platform_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap44xx</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_venchw_driver</span><span class="p">,</span> <span class="n">omap_venchw_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">venc_uninit_platform_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap44xx</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_venchw_driver</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
