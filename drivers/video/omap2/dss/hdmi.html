<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › omap2 › dss › hdmi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hdmi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * hdmi.c</span>
<span class="cm"> *</span>
<span class="cm"> * HDMI interface DSS driver setting for TI&#39;s OMAP4 family of processor.</span>
<span class="cm"> * Copyright (C) 2010-2011 Texas Instruments Incorporated - http://www.ti.com/</span>
<span class="cm"> * Authors: Yong Zhi</span>
<span class="cm"> *	Mythri pk &lt;mythripk@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>

<span class="cp">#define DSS_SUBSYS_NAME &quot;HDMI&quot;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;video/omapdss.h&gt;</span>

<span class="cp">#include &quot;ti_hdmi.h&quot;</span>
<span class="cp">#include &quot;dss.h&quot;</span>
<span class="cp">#include &quot;dss_features.h&quot;</span>

<span class="cp">#define HDMI_WP			0x0</span>
<span class="cp">#define HDMI_CORE_SYS		0x400</span>
<span class="cp">#define HDMI_CORE_AV		0x900</span>
<span class="cp">#define HDMI_PLLCTRL		0x200</span>
<span class="cp">#define HDMI_PHY		0x300</span>

<span class="cm">/* HDMI EDID Length move this */</span>
<span class="cp">#define HDMI_EDID_MAX_LENGTH			256</span>
<span class="cp">#define EDID_TIMING_DESCRIPTOR_SIZE		0x12</span>
<span class="cp">#define EDID_DESCRIPTOR_BLOCK0_ADDRESS		0x36</span>
<span class="cp">#define EDID_DESCRIPTOR_BLOCK1_ADDRESS		0x80</span>
<span class="cp">#define EDID_SIZE_BLOCK0_TIMING_DESCRIPTOR	4</span>
<span class="cp">#define EDID_SIZE_BLOCK1_TIMING_DESCRIPTOR	4</span>

<span class="cp">#define HDMI_DEFAULT_REGN 16</span>
<span class="cp">#define HDMI_DEFAULT_REGM2 1</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="n">ip_data</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">sys_clk</span><span class="p">;</span>
<span class="p">}</span> <span class="n">hdmi</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Logic for the below structure :</span>
<span class="cm"> * user enters the CEA or VESA timings by specifying the HDMI/DVI code.</span>
<span class="cm"> * There is a correspondence between CEA/VESA timing and code, please</span>
<span class="cm"> * refer to section 6.3 in HDMI 1.3 specification for timing code.</span>
<span class="cm"> *</span>
<span class="cm"> * In the below structure, cea_vesa_timings corresponds to all OMAP4</span>
<span class="cm"> * supported CEA and VESA timing values.code_cea corresponds to the CEA</span>
<span class="cm"> * code, It is used to get the timing from cea_vesa_timing array.Similarly</span>
<span class="cm"> * with code_vesa. Code_index is used for back mapping, that is once EDID</span>
<span class="cm"> * is read from the TV, EDID is parsed to find the timing values and then</span>
<span class="cm"> * map it to corresponding CEA or VESA index.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hdmi_config</span> <span class="n">cea_timings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">25200</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">720</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">27027</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">74250</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">540</span><span class="p">,</span> <span class="mi">74250</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1440</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">27027</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="mi">148500</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">16</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">720</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">27000</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">17</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">74250</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">440</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">19</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">540</span><span class="p">,</span> <span class="mi">74250</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">528</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">20</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1440</span><span class="p">,</span> <span class="mi">288</span><span class="p">,</span> <span class="mi">27000</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">21</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1440</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">54000</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">29</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="mi">148500</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">528</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">31</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="mi">74250</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">638</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">32</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">2880</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">108108</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">35</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">2880</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">108000</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">272</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">37</span><span class="p">,</span> <span class="n">HDMI_HDMI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hdmi_config</span> <span class="n">vesa_timings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* VESA From Here */</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">25175</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">2</span> <span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">40000</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">4</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">848</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">33750</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">8</span> <span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xE</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">79500</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">7</span> <span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x17</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">83500</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">6</span> <span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x1C</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1360</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">85500</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">6</span> <span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x27</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">960</span><span class="p">,</span> <span class="mi">108000</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">312</span><span class="p">,</span> <span class="mi">3</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">108000</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">3</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x23</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">65000</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1050</span><span class="p">,</span> <span class="mi">121750</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x2A</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1440</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">106500</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x2F</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1680</span><span class="p">,</span> <span class="mi">1050</span><span class="p">,</span> <span class="mi">146250</span><span class="p">,</span> <span class="mi">176</span> <span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x3A</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1366</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">85500</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x51</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="mi">148500</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x52</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">68250</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x16</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1050</span><span class="p">,</span> <span class="mi">101000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x29</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1680</span><span class="p">,</span> <span class="mi">1050</span><span class="p">,</span> <span class="mi">119000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x39</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">79500</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x1B</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">74250</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x55</span><span class="p">,</span> <span class="n">HDMI_DVI</span><span class="p">}</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_runtime_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;hdmi_runtime_get</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_runtime_put</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;hdmi_runtime_put</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hdmi_init_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;init_display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dss_init_hdmi_ip_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hdmi_config</span> <span class="o">*</span><span class="nf">hdmi_find_timing</span><span class="p">(</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">hdmi_config</span> <span class="o">*</span><span class="n">timings_arr</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timings_arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cm</span><span class="p">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">code</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">timings_arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hdmi_config</span> <span class="o">*</span><span class="nf">hdmi_get_timings</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
       <span class="k">const</span> <span class="k">struct</span> <span class="n">hdmi_config</span> <span class="o">*</span><span class="n">arr</span><span class="p">;</span>
       <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

       <span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">HDMI_DVI</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">arr</span> <span class="o">=</span> <span class="n">vesa_timings</span><span class="p">;</span>
               <span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vesa_timings</span><span class="p">);</span>
       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="n">arr</span> <span class="o">=</span> <span class="n">cea_timings</span><span class="p">;</span>
               <span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cea_timings</span><span class="p">);</span>
       <span class="p">}</span>

       <span class="k">return</span> <span class="n">hdmi_find_timing</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hdmi_timings_compare</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timing1</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">hdmi_video_timings</span> <span class="o">*</span><span class="n">timing2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timing1_vsync</span><span class="p">,</span> <span class="n">timing1_hsync</span><span class="p">,</span> <span class="n">timing2_vsync</span><span class="p">,</span> <span class="n">timing2_hsync</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">timing2</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">==</span> <span class="n">timing1</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">timing2</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">==</span> <span class="n">timing1</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">timing2</span><span class="o">-&gt;</span><span class="n">y_res</span> <span class="o">==</span> <span class="n">timing1</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">timing2_hsync</span> <span class="o">=</span> <span class="n">timing2</span><span class="o">-&gt;</span><span class="n">hfp</span> <span class="o">+</span> <span class="n">timing2</span><span class="o">-&gt;</span><span class="n">hsw</span> <span class="o">+</span> <span class="n">timing2</span><span class="o">-&gt;</span><span class="n">hbp</span><span class="p">;</span>
		<span class="n">timing1_hsync</span> <span class="o">=</span> <span class="n">timing1</span><span class="o">-&gt;</span><span class="n">hfp</span> <span class="o">+</span> <span class="n">timing1</span><span class="o">-&gt;</span><span class="n">hsw</span> <span class="o">+</span> <span class="n">timing1</span><span class="o">-&gt;</span><span class="n">hbp</span><span class="p">;</span>
		<span class="n">timing2_vsync</span> <span class="o">=</span> <span class="n">timing2</span><span class="o">-&gt;</span><span class="n">vfp</span> <span class="o">+</span> <span class="n">timing2</span><span class="o">-&gt;</span><span class="n">vsw</span> <span class="o">+</span> <span class="n">timing2</span><span class="o">-&gt;</span><span class="n">vbp</span><span class="p">;</span>
		<span class="n">timing1_vsync</span> <span class="o">=</span> <span class="n">timing2</span><span class="o">-&gt;</span><span class="n">vfp</span> <span class="o">+</span> <span class="n">timing2</span><span class="o">-&gt;</span><span class="n">vsw</span> <span class="o">+</span> <span class="n">timing2</span><span class="o">-&gt;</span><span class="n">vbp</span><span class="p">;</span>

		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;timing1_hsync = %d timing1_vsync = %d&quot;</span>\
			<span class="s">&quot;timing2_hsync = %d timing2_vsync = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">timing1_hsync</span><span class="p">,</span> <span class="n">timing1_vsync</span><span class="p">,</span>
			<span class="n">timing2_hsync</span><span class="p">,</span> <span class="n">timing2_vsync</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">timing1_hsync</span> <span class="o">==</span> <span class="n">timing2_hsync</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">timing1_vsync</span> <span class="o">==</span> <span class="n">timing2_vsync</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hdmi_cm</span> <span class="nf">hdmi_get_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_cm</span> <span class="n">cm</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">};</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;hdmi_get_code</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cea_timings</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_timings_compare</span><span class="p">(</span><span class="n">timing</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cea_timings</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timings</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cm</span> <span class="o">=</span> <span class="n">cea_timings</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cm</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vesa_timings</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_timings_compare</span><span class="p">(</span><span class="n">timing</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vesa_timings</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timings</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cm</span> <span class="o">=</span> <span class="n">vesa_timings</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cm</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">end:</span>	<span class="k">return</span> <span class="n">cm</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">hdmi_get_pixel_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* HDMI Pixel Clock in Mhz */</span>
	<span class="k">return</span> <span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">pixel_clock</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_compute_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hdmi_pll_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clkin</span><span class="p">,</span> <span class="n">refclk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mf</span><span class="p">;</span>

	<span class="n">clkin</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">hdmi</span><span class="p">.</span><span class="n">sys_clk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Input clock is predivided by N + 1</span>
<span class="cm">	 * out put of which is reference clk</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">hdmi</span><span class="p">.</span><span class="n">regn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">regn</span> <span class="o">=</span> <span class="n">HDMI_DEFAULT_REGN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">regn</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">hdmi</span><span class="p">.</span><span class="n">regn</span><span class="p">;</span>

	<span class="n">refclk</span> <span class="o">=</span> <span class="n">clkin</span> <span class="o">/</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">hdmi</span><span class="p">.</span><span class="n">regm2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">regm2</span> <span class="o">=</span> <span class="n">HDMI_DEFAULT_REGM2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">regm2</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">hdmi</span><span class="p">.</span><span class="n">regm2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * multiplier is pixel_clk/ref_clk</span>
<span class="cm">	 * Multiplying by 100 to avoid fractional part removal</span>
<span class="cm">	 */</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">regm</span> <span class="o">=</span> <span class="n">phy</span> <span class="o">*</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regm2</span> <span class="o">/</span> <span class="n">refclk</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * fractional multiplier is remainder of the difference between</span>
<span class="cm">	 * multiplier and actual phy(required pixel clock thus should be</span>
<span class="cm">	 * multiplied by 2^18(262144) divided by the reference clock</span>
<span class="cm">	 */</span>
	<span class="n">mf</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy</span> <span class="o">-</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regm</span> <span class="o">/</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regm2</span> <span class="o">*</span> <span class="n">refclk</span><span class="p">)</span> <span class="o">*</span> <span class="mi">262144</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">regmf</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regm2</span> <span class="o">*</span> <span class="n">mf</span> <span class="o">/</span> <span class="n">refclk</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Dcofreq should be set to 1 if required pixel clock</span>
<span class="cm">	 * is greater than 1000MHz</span>
<span class="cm">	 */</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dcofreq</span> <span class="o">=</span> <span class="n">phy</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">regsd</span> <span class="o">=</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">regm</span> <span class="o">*</span> <span class="n">clkin</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">regn</span> <span class="o">*</span> <span class="mi">250</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="cm">/* Set the reference clock to sysclk reference */</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">refsel</span> <span class="o">=</span> <span class="n">HDMI_REFSEL_SYSCLK</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;M = %d Mf = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regm</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regmf</span><span class="p">);</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;range = %d sd = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">dcofreq</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">regsd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hdmi_config</span> <span class="o">*</span><span class="n">timing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phy</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_runtime_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dss_mgr_disable</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;hdmi_power_on x_res= %d y_res = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">x_res</span><span class="p">,</span>
		<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">y_res</span><span class="p">);</span>

	<span class="n">timing</span> <span class="o">=</span> <span class="n">hdmi_get_timings</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timing</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* HDMI code 4 corresponds to 640 * 480 VGA */</span>
		<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="cm">/* DVI mode 1 corresponds to HDMI 0 to DVI */</span>
		<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">HDMI_DVI</span><span class="p">;</span>
		<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">vesa_timings</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">*</span><span class="n">timing</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phy</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">;</span>

	<span class="n">hdmi_compute_pll</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">pll_data</span><span class="p">);</span>

	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">video_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="cm">/* config the PLL and PHY hdmi_set_pll_pwrfirst */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pll_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;Failed to lock PLL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">phy_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;Failed to start PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">video_configure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="cm">/* Make selection of HDMI in DSS */</span>
	<span class="n">dss_select_hdmi_venc_clk_source</span><span class="p">(</span><span class="n">DSS_HDMI_M_PCLK</span><span class="p">);</span>

	<span class="cm">/* Select the dispc clock source as PRCM clock, to ensure that it is not</span>
<span class="cm">	 * DSI PLL source as the clock selected by DSI PLL might not be</span>
<span class="cm">	 * sufficient for the resolution selected / that can be changed</span>
<span class="cm">	 * dynamically by user. This can be moved to single location , say</span>
<span class="cm">	 * Boardfile.</span>
<span class="cm">	 */</span>
	<span class="n">dss_select_dispc_clk_source</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dispc</span><span class="p">.</span><span class="n">dispc_fclk_src</span><span class="p">);</span>

	<span class="cm">/* bypass TV gamma table */</span>
	<span class="n">dispc_enable_gamma_table</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* tv size */</span>
	<span class="n">dss_mgr_set_timings</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">video_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_vid_enable</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dss_mgr_enable</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_mgr_enable</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_mgr_enable:</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">video_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
<span class="nl">err_vid_enable:</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">phy_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pll_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">hdmi_runtime_put</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dss_mgr_disable</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>

	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">video_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">phy_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pll_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="n">hdmi_runtime_put</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omapdss_hdmi_display_check_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_cm</span> <span class="n">cm</span><span class="p">;</span>

	<span class="n">cm</span> <span class="o">=</span> <span class="n">hdmi_get_code</span><span class="p">(</span><span class="n">timings</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="p">.</span><span class="n">code</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omapdss_hdmi_display_set_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_cm</span> <span class="n">cm</span><span class="p">;</span>

	<span class="n">cm</span> <span class="o">=</span> <span class="n">hdmi_get_code</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">);</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cm</span><span class="p">.</span><span class="n">code</span><span class="p">;</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">cm</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">OMAP_DSS_DISPLAY_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

		<span class="n">hdmi_power_off</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_power_on</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to power on device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dss_mgr_set_timings</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_runtime_get</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_wrapper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_pll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_phy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_core</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="n">hdmi_runtime_put</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omapdss_hdmi_read_edid</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_runtime_get</span><span class="p">();</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_edid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">hdmi_runtime_put</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">omapdss_hdmi_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_runtime_get</span><span class="p">();</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">detect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="n">hdmi_runtime_put</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omapdss_hdmi_display_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_dss_hdmi_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;ENTER hdmi_display_enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to enable display: no manager</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">hpd_gpio</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hpd_gpio</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dss_start_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to start device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_enable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to enable GPIO&#39;s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_power_on</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to power on device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err2:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_disable</span><span class="p">)</span>
		<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_disable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">omap_dss_stop_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omapdss_hdmi_display_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;Enter hdmi_display_disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">hdmi_power_off</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_disable</span><span class="p">)</span>
		<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">platform_disable</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="n">omap_dss_stop_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_get_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sys_clk&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get sys_clk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hdmi</span><span class="p">.</span><span class="n">sys_clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_put_clocks</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="p">.</span><span class="n">sys_clk</span><span class="p">)</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">hdmi</span><span class="p">.</span><span class="n">sys_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_OMAP4_DSS_HDMI_AUDIO)</span>
<span class="kt">int</span> <span class="nf">hdmi_compute_acr</span><span class="p">(</span><span class="n">u32</span> <span class="n">sample_freq</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">cts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">deep_color</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">deep_color_correct</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pclk</span> <span class="o">=</span> <span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">pixel_clock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">cts</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* TODO: When implemented, query deep color mode here. */</span>
	<span class="n">deep_color</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * When using deep color, the default N value (as in the HDMI</span>
<span class="cm">	 * specification) yields to an non-integer CTS. Hence, we</span>
<span class="cm">	 * modify it while keeping the restrictions described in</span>
<span class="cm">	 * section 7.2.1 of the HDMI 1.4a specification.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sample_freq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32000</span>:
	<span class="k">case</span> <span class="mi">48000</span>:
	<span class="k">case</span> <span class="mi">96000</span>:
	<span class="k">case</span> <span class="mi">192000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">deep_color</span> <span class="o">==</span> <span class="mi">125</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pclk</span> <span class="o">==</span> <span class="mi">27027</span> <span class="o">||</span> <span class="n">pclk</span> <span class="o">==</span> <span class="mi">74250</span><span class="p">)</span>
				<span class="n">deep_color_correct</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deep_color</span> <span class="o">==</span> <span class="mi">150</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pclk</span> <span class="o">==</span> <span class="mi">27027</span><span class="p">)</span>
				<span class="n">deep_color_correct</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:
	<span class="k">case</span> <span class="mi">88200</span>:
	<span class="k">case</span> <span class="mi">176400</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">deep_color</span> <span class="o">==</span> <span class="mi">125</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pclk</span> <span class="o">==</span> <span class="mi">27027</span><span class="p">)</span>
				<span class="n">deep_color_correct</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">deep_color_correct</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sample_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">32000</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">44100</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">12544</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">48000</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">88200</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">25088</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">96000</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">16384</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">176400</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">50176</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">192000</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sample_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">32000</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">44100</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">6272</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">48000</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">6144</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">88200</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">12544</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">96000</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">12288</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">176400</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">25088</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">192000</span>:
			<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="mi">24576</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Calculate CTS. See HDMI 1.3a or 1.4a specifications */</span>
	<span class="o">*</span><span class="n">cts</span> <span class="o">=</span> <span class="n">pclk</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">n</span> <span class="o">/</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="n">deep_color</span> <span class="o">/</span> <span class="p">(</span><span class="n">sample_freq</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hdmi_audio_enable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;audio_enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hdmi_audio_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;audio_disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hdmi_audio_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;audio_start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hdmi_audio_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;audio_stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">hdmi_mode_has_audio</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">HDMI_HDMI</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hdmi_audio_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_audio</span> <span class="o">*</span><span class="n">audio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">audio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">hdmi_probe_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_dss_board_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OMAP_DISPLAY_TYPE_HDMI</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_init_display</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;device %s init failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dss_register_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;device %s register failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* HDMI HW IP initialisation */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omapdss_hdmihw_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">hdmi_mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">hdmi</span><span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">hdmi_mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">hdmi</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdmi_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get IORESOURCE_MEM HDMI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Base address taken from platform */</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">base_wp</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">hdmi_mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
						<span class="n">resource_size</span><span class="p">(</span><span class="n">hdmi_mem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">base_wp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t ioremap WP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_get_clocks</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">base_wp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">core_sys_offset</span> <span class="o">=</span> <span class="n">HDMI_CORE_SYS</span><span class="p">;</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">core_av_offset</span> <span class="o">=</span> <span class="n">HDMI_CORE_AV</span><span class="p">;</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">pll_offset</span> <span class="o">=</span> <span class="n">HDMI_PLLCTRL</span><span class="p">;</span>
	<span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">phy_offset</span> <span class="o">=</span> <span class="n">HDMI_PHY</span><span class="p">;</span>

	<span class="n">hdmi_panel_init</span><span class="p">();</span>

	<span class="n">dss_debugfs_create_file</span><span class="p">(</span><span class="s">&quot;hdmi&quot;</span><span class="p">,</span> <span class="n">hdmi_dump_regs</span><span class="p">);</span>

	<span class="n">hdmi_probe_pdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">omapdss_hdmihw_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omap_dss_unregister_child_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hdmi_panel_exit</span><span class="p">();</span>

	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hdmi_put_clocks</span><span class="p">();</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">hdmi</span><span class="p">.</span><span class="n">ip_data</span><span class="p">.</span><span class="n">base_wp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">hdmi</span><span class="p">.</span><span class="n">sys_clk</span><span class="p">);</span>

	<span class="n">dispc_runtime_put</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dispc_runtime_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">hdmi</span><span class="p">.</span><span class="n">sys_clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">hdmi_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">runtime_suspend</span> <span class="o">=</span> <span class="n">hdmi_runtime_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span> <span class="o">=</span> <span class="n">hdmi_runtime_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omapdss_hdmihw_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">omapdss_hdmihw_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>         <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;omapdss_hdmi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hdmi_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">hdmi_init_platform_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omapdss_hdmihw_driver</span><span class="p">,</span> <span class="n">omapdss_hdmihw_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">hdmi_uninit_platform_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omapdss_hdmihw_driver</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
