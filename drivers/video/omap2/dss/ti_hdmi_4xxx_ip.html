<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › omap2 › dss › ti_hdmi_4xxx_ip.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ti_hdmi_4xxx_ip.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ti_hdmi_4xxx_ip.c</span>
<span class="cm"> *</span>
<span class="cm"> * HDMI TI81xx, TI38xx, TI OMAP4 etc IP driver Library</span>
<span class="cm"> * Copyright (C) 2010-2011 Texas Instruments Incorporated - http://www.ti.com/</span>
<span class="cm"> * Authors: Yong Zhi</span>
<span class="cm"> *	Mythri pk &lt;mythripk@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#if defined(CONFIG_OMAP4_DSS_HDMI_AUDIO)</span>
<span class="cp">#include &lt;sound/asound.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;ti_hdmi_4xxx_ip.h&quot;</span>
<span class="cp">#include &quot;dss.h&quot;</span>
<span class="cp">#include &quot;dss_features.h&quot;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdmi_write_reg</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u16</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">hdmi_read_reg</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u16</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">hdmi_wp_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">base_wp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">hdmi_phy_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">base_wp</span> <span class="o">+</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">phy_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">hdmi_pll_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">base_wp</span> <span class="o">+</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">pll_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">hdmi_av_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">base_wp</span> <span class="o">+</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">core_av_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">hdmi_core_sys_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">base_wp</span> <span class="o">+</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">core_sys_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hdmi_wait_for_bit_change</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u16</span> <span class="n">idx</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">b2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">!</span><span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_pll_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pll_base</span> <span class="o">=</span> <span class="n">hdmi_pll_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hdmi_pll_info</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">pll_data</span><span class="p">;</span>

	<span class="cm">/* PLL start always use manual mode */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_PLL_CONTROL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_CFG1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">regm</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span> <span class="cm">/* CFG1_PLL_REGM */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">regn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>  <span class="cm">/* CFG1_PLL_REGN */</span>

	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_CFG1</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_CFG2</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span> <span class="cm">/* PLL_HIGHFREQ divide by 2 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span> <span class="cm">/* PLL_REFEN */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span> <span class="cm">/* PHY_CLKINEN de-assert during locking */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">refsel</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span> <span class="cm">/* REFSEL */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">dcofreq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* divider programming for frequency beyond 1000Mhz */</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_CFG3</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">regsd</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* 1000MHz and 2000MHz */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* 500MHz and 1000MHz */</span>
	<span class="p">}</span>

	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_CFG2</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_CFG4</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">regm2</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">regmf</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_CFG4</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* go now */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_PLL_GO</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* wait for bit change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_wait_for_bit_change</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_PLL_GO</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PLL GO bit not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait till the lock bit is set in PLL status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_wait_for_bit_change</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span>
				<span class="n">PLLCTRL_PLL_STATUS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot lock PLL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;CFG1 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_CFG1</span><span class="p">));</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;CFG2 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_CFG2</span><span class="p">));</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;CFG4 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">pll_base</span><span class="p">,</span> <span class="n">PLLCTRL_CFG4</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PLL locked!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PHY_PWR_CMD */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_set_phy_pwr</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span> <span class="k">enum</span> <span class="n">hdmi_phy_pwr</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Command for power control of HDMI PHY */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_PWR_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* Status of the power control of HDMI PHY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_wait_for_bit_change</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span>
				<span class="n">HDMI_WP_PWR_CTRL</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to set PHY power mode to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PLL_PWR_CMD */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_set_pll_pwr</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span> <span class="k">enum</span> <span class="n">hdmi_pll_pwr</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Command for power control of HDMI PLL */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_PWR_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* wait till PHY_PWR_STATUS is set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_wait_for_bit_change</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_PWR_CTRL</span><span class="p">,</span>
						<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to set PLL_PWR_STATUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_pll_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* SYSRESET  controlled by power FSM */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_pll_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">PLLCTRL_PLL_CONTROL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* READ 0x0 reset is in progress */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_wait_for_bit_change</span><span class="p">(</span><span class="n">hdmi_pll_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span>
				<span class="n">PLLCTRL_PLL_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to sysreset PLL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ti_hdmi_4xxx_pll_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_set_pll_pwr</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">HDMI_PLLPWRCMD_ALLOFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_set_pll_pwr</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">HDMI_PLLPWRCMD_BOTHON_ALLCLKS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_pll_reset</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_pll_init</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_pll_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdmi_set_pll_pwr</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">HDMI_PLLPWRCMD_ALLOFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_check_hpd_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hpd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="cm">/* this should be in ti_hdmi_4xxx_ip private data */</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">phy_tx_lock</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">hpd</span> <span class="o">=</span> <span class="n">gpio_get_value</span><span class="p">(</span><span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">hpd_gpio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpd</span> <span class="o">==</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">phy_tx_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpd</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_set_phy_pwr</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">HDMI_PHYPWRCMD_TXON</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_set_phy_pwr</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">HDMI_PHYPWRCMD_LDOON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to %s PHY TX power</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hpd</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">phy_tx_enabled</span> <span class="o">=</span> <span class="n">hpd</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">hpd_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">hdmi_check_hpd_state</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ti_hdmi_4xxx_phy_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">phy_base</span> <span class="o">=</span> <span class="n">hdmi_phy_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_set_phy_pwr</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">HDMI_PHYPWRCMD_LDOON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read address 0 in order to get the SCP reset done completed</span>
<span class="cm">	 * Dummy access performed to make sure reset is done</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">phy_base</span><span class="p">,</span> <span class="n">HDMI_TXPHY_TX_CTRL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write to phy address 0 to configure the clock</span>
<span class="cm">	 * use HFBITCLK write HDMI_TXPHY_TX_CONTROL_FREQOUT field</span>
<span class="cm">	 */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">phy_base</span><span class="p">,</span> <span class="n">HDMI_TXPHY_TX_CTRL</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

	<span class="cm">/* Write to phy address 1 to start HDMI line (TXVALID and TMDSCLKEN) */</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">phy_base</span><span class="p">,</span> <span class="n">HDMI_TXPHY_DIGITAL_CTRL</span><span class="p">,</span> <span class="mh">0xF0000000</span><span class="p">);</span>

	<span class="cm">/* Setup max LDO voltage */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">phy_base</span><span class="p">,</span> <span class="n">HDMI_TXPHY_POWER_CTRL</span><span class="p">,</span> <span class="mh">0xB</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Write to phy address 3 to change the polarity control */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">phy_base</span><span class="p">,</span> <span class="n">HDMI_TXPHY_PAD_CFG_CTRL</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">27</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">hpd_gpio</span><span class="p">),</span>
				 <span class="nb">NULL</span><span class="p">,</span> <span class="n">hpd_irq_handler</span><span class="p">,</span>
				 <span class="n">IRQF_TRIGGER_RISING</span> <span class="o">|</span> <span class="n">IRQF_TRIGGER_FALLING</span> <span class="o">|</span>
				 <span class="n">IRQF_ONESHOT</span><span class="p">,</span> <span class="s">&quot;hpd&quot;</span><span class="p">,</span> <span class="n">ip_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;HPD IRQ request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hdmi_set_phy_pwr</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">HDMI_PHYPWRCMD_OFF</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_check_hpd_state</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">hpd_gpio</span><span class="p">),</span> <span class="n">ip_data</span><span class="p">);</span>
		<span class="n">hdmi_set_phy_pwr</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">HDMI_PHYPWRCMD_OFF</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_phy_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">hpd_gpio</span><span class="p">),</span> <span class="n">ip_data</span><span class="p">);</span>

	<span class="n">hdmi_set_phy_pwr</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">HDMI_PHYPWRCMD_OFF</span><span class="p">);</span>
	<span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">phy_tx_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_core_ddc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">hdmi_core_sys_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="cm">/* Turn on CLK for DDC */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_DPD</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* IN_PROG */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_STATUS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Abort transaction */</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_CMD</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* IN_PROG */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_wait_for_bit_change</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_STATUS</span><span class="p">,</span>
					<span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Timeout aborting DDC transaction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Clk SCL Devices */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_CMD</span><span class="p">,</span> <span class="mh">0xA</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* HDMI_CORE_DDC_STATUS_IN_PROG */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_wait_for_bit_change</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_STATUS</span><span class="p">,</span>
				<span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Timeout starting SCL clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear FIFO */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_CMD</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* HDMI_CORE_DDC_STATUS_IN_PROG */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_wait_for_bit_change</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_STATUS</span><span class="p">,</span>
				<span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Timeout clearing DDC fifo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdmi_core_ddc_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">pedid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">hdmi_core_sys_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* HDMI_CORE_DDC_STATUS_IN_PROG */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_wait_for_bit_change</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_STATUS</span><span class="p">,</span>
				<span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Timeout waiting DDC to be ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="cm">/* Load Segment Address Register */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_SEGM</span><span class="p">,</span> <span class="n">ext</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Load Slave Address Register */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_ADDR</span><span class="p">,</span> <span class="mh">0xA0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Load Offset Address Register */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_OFFSET</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Load Byte Count */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_COUNT1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_COUNT2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set DDC_CMD */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_CMD</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_CMD</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* HDMI_CORE_DDC_STATUS_BUS_LOW */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_STATUS</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;I2C Bus Low?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* HDMI_CORE_DDC_STATUS_NO_ACK */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_STATUS</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;I2C No Ack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>

		<span class="cm">/* IN_PROG */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_STATUS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;operation stopped when reading edid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* FIFO_EMPTY */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_STATUS</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;timeout reading edid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pedid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">HDMI_CORE_DDC_DATA</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="n">pedid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;E-EDID checksum failed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ti_hdmi_4xxx_read_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">edid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_core_ddc_init</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_core_ddc_edid</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">edid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">edid</span><span class="p">[</span><span class="mh">0x7e</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_core_ddc_edid</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">edid</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ti_hdmi_4xxx_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gpio_get_value</span><span class="p">(</span><span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">hpd_gpio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_core_video_config</span> <span class="o">*</span><span class="n">video_cfg</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hdmi_core_infoframe_avi</span> <span class="o">*</span><span class="n">avi_cfg</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hdmi_core_packet_enable_repeat</span> <span class="o">*</span><span class="n">repeat_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Enter hdmi_core_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* video core */</span>
	<span class="n">video_cfg</span><span class="o">-&gt;</span><span class="n">ip_bus_width</span> <span class="o">=</span> <span class="n">HDMI_INPUT_8BIT</span><span class="p">;</span>
	<span class="n">video_cfg</span><span class="o">-&gt;</span><span class="n">op_dither_truc</span> <span class="o">=</span> <span class="n">HDMI_OUTPUTTRUNCATION_8BIT</span><span class="p">;</span>
	<span class="n">video_cfg</span><span class="o">-&gt;</span><span class="n">deep_color_pkt</span> <span class="o">=</span> <span class="n">HDMI_DEEPCOLORPACKECTDISABLE</span><span class="p">;</span>
	<span class="n">video_cfg</span><span class="o">-&gt;</span><span class="n">pkt_mode</span> <span class="o">=</span> <span class="n">HDMI_PACKETMODERESERVEDVALUE</span><span class="p">;</span>
	<span class="n">video_cfg</span><span class="o">-&gt;</span><span class="n">hdmi_dvi</span> <span class="o">=</span> <span class="n">HDMI_DVI</span><span class="p">;</span>
	<span class="n">video_cfg</span><span class="o">-&gt;</span><span class="n">tclk_sel_clkmult</span> <span class="o">=</span> <span class="n">HDMI_FPLL10IDCK</span><span class="p">;</span>

	<span class="cm">/* info frame */</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db1_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db1_active_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db1_bar_info_dv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db1_scan_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db2_colorimetry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db2_aspect_ratio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db2_active_fmt_ar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db3_itc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db3_ec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db3_q_range</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db3_nup_scaling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db4_videocode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db5_pixel_repeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db6_7_line_eoftop</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db8_9_line_sofbottom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db10_11_pixel_eofleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="o">-&gt;</span><span class="n">db12_13_pixel_sofright</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* packet enable and repeat */</span>
	<span class="n">repeat_cfg</span><span class="o">-&gt;</span><span class="n">audio_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">repeat_cfg</span><span class="o">-&gt;</span><span class="n">audio_pkt_repeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">repeat_cfg</span><span class="o">-&gt;</span><span class="n">avi_infoframe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">repeat_cfg</span><span class="o">-&gt;</span><span class="n">avi_infoframe_repeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">repeat_cfg</span><span class="o">-&gt;</span><span class="n">gen_cntrl_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">repeat_cfg</span><span class="o">-&gt;</span><span class="n">gen_cntrl_pkt_repeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">repeat_cfg</span><span class="o">-&gt;</span><span class="n">generic_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">repeat_cfg</span><span class="o">-&gt;</span><span class="n">generic_pkt_repeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_core_powerdown_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Enter hdmi_core_powerdown_disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_core_sys_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_CORE_CTRL1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_core_swreset_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Enter hdmi_core_swreset_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_core_sys_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_CORE_SYS_SRST</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_core_swreset_assert</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Enter hdmi_core_swreset_assert</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_core_sys_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_CORE_SYS_SRST</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* HDMI_CORE_VIDEO_CONFIG */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_core_video_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">hdmi_core_video_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">core_sys_base</span> <span class="o">=</span> <span class="n">hdmi_core_sys_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="cm">/* sys_ctrl1 default configuration not tunable */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">core_sys_base</span><span class="p">,</span> <span class="n">HDMI_CORE_CTRL1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">HDMI_CORE_CTRL1_VEN_FOLLOWVSYNC</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">HDMI_CORE_CTRL1_HEN_FOLLOWHSYNC</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">HDMI_CORE_CTRL1_BSEL_24BITBUS</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">HDMI_CORE_CTRL1_EDGE_RISINGEDGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">core_sys_base</span><span class="p">,</span> <span class="n">HDMI_CORE_CTRL1</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">core_sys_base</span><span class="p">,</span>
			<span class="n">HDMI_CORE_SYS_VID_ACEN</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ip_bus_width</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* Vid_Mode */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">core_sys_base</span><span class="p">,</span> <span class="n">HDMI_CORE_SYS_VID_MODE</span><span class="p">);</span>

	<span class="cm">/* dither truncation configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">op_dither_truc</span> <span class="o">&gt;</span> <span class="n">HDMI_OUTPUTTRUNCATION_12BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">op_dither_truc</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">op_dither_truc</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">core_sys_base</span><span class="p">,</span> <span class="n">HDMI_CORE_SYS_VID_MODE</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* HDMI_Ctrl */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">hdmi_av_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_CORE_AV_HDMI_CTRL</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">deep_color_pkt</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pkt_mode</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hdmi_dvi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">hdmi_av_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_CORE_AV_HDMI_CTRL</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* TMDS_CTRL */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">core_sys_base</span><span class="p">,</span>
			<span class="n">HDMI_CORE_SYS_TMDS_CTRL</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">tclk_sel_clkmult</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_core_aux_infoframe_avi_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">av_base</span> <span class="o">=</span> <span class="n">hdmi_av_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hdmi_core_infoframe_avi</span> <span class="n">info_avi</span> <span class="o">=</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">avi_cfg</span><span class="p">;</span>

	<span class="n">sum</span> <span class="o">+=</span> <span class="mh">0x82</span> <span class="o">+</span> <span class="mh">0x002</span> <span class="o">+</span> <span class="mh">0x00D</span><span class="p">;</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_TYPE</span><span class="p">,</span> <span class="mh">0x082</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_VERS</span><span class="p">,</span> <span class="mh">0x002</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_LEN</span><span class="p">,</span> <span class="mh">0x00D</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db1_format</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db1_active_info</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db1_bar_info_dv</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db1_scan_info</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db2_colorimetry</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db2_aspect_ratio</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db2_active_fmt_ar</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db3_itc</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db3_ec</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db3_q_range</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db3_nup_scaling</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
					<span class="n">info_avi</span><span class="p">.</span><span class="n">db4_videocode</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">info_avi</span><span class="p">.</span><span class="n">db4_videocode</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">info_avi</span><span class="p">.</span><span class="n">db5_pixel_repeat</span><span class="p">;</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">info_avi</span><span class="p">.</span><span class="n">db6_7_line_eoftop</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">;</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db6_7_line_eoftop</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">info_avi</span><span class="p">.</span><span class="n">db8_9_line_sofbottom</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">;</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db8_9_line_sofbottom</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">info_avi</span><span class="p">.</span><span class="n">db10_11_pixel_eofleft</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">;</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db10_11_pixel_eofleft</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">info_avi</span><span class="p">.</span><span class="n">db12_13_pixel_sofright</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">;</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">info_avi</span><span class="p">.</span><span class="n">db12_13_pixel_sofright</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">checksum</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="n">sum</span><span class="p">;</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_CHSUM</span><span class="p">,</span> <span class="n">checksum</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_core_av_packet_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hdmi_core_packet_enable_repeat</span> <span class="n">repeat_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enable/repeat the infoframe */</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">hdmi_av_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_CORE_AV_PB_CTRL1</span><span class="p">,</span>
		<span class="p">(</span><span class="n">repeat_cfg</span><span class="p">.</span><span class="n">audio_pkt</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">repeat_cfg</span><span class="p">.</span><span class="n">audio_pkt_repeat</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">repeat_cfg</span><span class="p">.</span><span class="n">avi_infoframe</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">repeat_cfg</span><span class="p">.</span><span class="n">avi_infoframe_repeat</span><span class="p">));</span>

	<span class="cm">/* enable/repeat the packet */</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">hdmi_av_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_CORE_AV_PB_CTRL2</span><span class="p">,</span>
		<span class="p">(</span><span class="n">repeat_cfg</span><span class="p">.</span><span class="n">gen_cntrl_pkt</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">repeat_cfg</span><span class="p">.</span><span class="n">gen_cntrl_pkt_repeat</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">repeat_cfg</span><span class="p">.</span><span class="n">generic_pkt</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">repeat_cfg</span><span class="p">.</span><span class="n">generic_pkt_repeat</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_wp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hdmi_video_format</span> <span class="o">*</span><span class="n">video_fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Enter hdmi_wp_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hbp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hsw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vbp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vsw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">video_fmt</span><span class="o">-&gt;</span><span class="n">packing_mode</span> <span class="o">=</span> <span class="n">HDMI_PACK_10b_RGB_YUV444</span><span class="p">;</span>
	<span class="n">video_fmt</span><span class="o">-&gt;</span><span class="n">y_res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">video_fmt</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ti_hdmi_4xxx_wp_video_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_VIDEO_CFG</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_wp_video_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_VIDEO_CFG</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_wp_video_init_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_video_format</span> <span class="o">*</span><span class="n">video_fmt</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdmi_config</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Enter hdmi_wp_video_init_format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">video_fmt</span><span class="o">-&gt;</span><span class="n">y_res</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">.</span><span class="n">y_res</span><span class="p">;</span>
	<span class="n">video_fmt</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">.</span><span class="n">x_res</span><span class="p">;</span>

	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hbp</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">.</span><span class="n">hbp</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfp</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">.</span><span class="n">hfp</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hsw</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">.</span><span class="n">hsw</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vbp</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">.</span><span class="n">vbp</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfp</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">.</span><span class="n">vfp</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vsw</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">.</span><span class="n">vsw</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_wp_video_config_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hdmi_video_format</span> <span class="o">*</span><span class="n">video_fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_VIDEO_CFG</span><span class="p">,</span>
			<span class="n">video_fmt</span><span class="o">-&gt;</span><span class="n">packing_mode</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">video_fmt</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">video_fmt</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_VIDEO_SIZE</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_wp_video_config_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Enter hdmi_wp_video_config_interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_VIDEO_CFG</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">vsync_pol</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">hsync_pol</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">interlace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* HDMI_TIMING_MASTER_24BIT */</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_VIDEO_CFG</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_wp_video_config_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timing_h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timing_v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Enter hdmi_wp_video_config_timing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">timing_h</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">hbp</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">timing_h</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfp</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">timing_h</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">hsw</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_VIDEO_TIMING_H</span><span class="p">,</span> <span class="n">timing_h</span><span class="p">);</span>

	<span class="n">timing_v</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">vbp</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">timing_v</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfp</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">timing_v</span> <span class="o">|=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">vsw</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_VIDEO_TIMING_V</span><span class="p">,</span> <span class="n">timing_v</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_basic_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* HDMI */</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="n">video_timing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_video_format</span> <span class="n">video_format</span><span class="p">;</span>
	<span class="cm">/* HDMI core */</span>
	<span class="k">struct</span> <span class="n">hdmi_core_infoframe_avi</span> <span class="n">avi_cfg</span> <span class="o">=</span> <span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">avi_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_core_video_config</span> <span class="n">v_core_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_core_packet_enable_repeat</span> <span class="n">repeat_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_config</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_data</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">;</span>

	<span class="n">hdmi_wp_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video_timing</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">video_format</span><span class="p">);</span>

	<span class="n">hdmi_core_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v_core_cfg</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">avi_cfg</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">repeat_cfg</span><span class="p">);</span>

	<span class="n">hdmi_wp_video_init_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video_format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">video_timing</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="n">hdmi_wp_video_config_timing</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">video_timing</span><span class="p">);</span>

	<span class="cm">/* video config */</span>
	<span class="n">video_format</span><span class="p">.</span><span class="n">packing_mode</span> <span class="o">=</span> <span class="n">HDMI_PACK_24b_RGB_YUV444_YUV422</span><span class="p">;</span>

	<span class="n">hdmi_wp_video_config_format</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">video_format</span><span class="p">);</span>

	<span class="n">hdmi_wp_video_config_interface</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * configure core video part</span>
<span class="cm">	 * set software reset in the core</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_core_swreset_assert</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="cm">/* power down off */</span>
	<span class="n">hdmi_core_powerdown_disable</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="n">v_core_cfg</span><span class="p">.</span><span class="n">pkt_mode</span> <span class="o">=</span> <span class="n">HDMI_PACKETMODE24BITPERPIXEL</span><span class="p">;</span>
	<span class="n">v_core_cfg</span><span class="p">.</span><span class="n">hdmi_dvi</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cm</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">hdmi_core_video_config</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v_core_cfg</span><span class="p">);</span>

	<span class="cm">/* release software reset in the core */</span>
	<span class="n">hdmi_core_swreset_release</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * configure packet</span>
<span class="cm">	 * info frame video see doc CEA861-D page 65</span>
<span class="cm">	 */</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db1_format</span> <span class="o">=</span> <span class="n">HDMI_INFOFRAME_AVI_DB1Y_RGB</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db1_active_info</span> <span class="o">=</span>
		<span class="n">HDMI_INFOFRAME_AVI_DB1A_ACTIVE_FORMAT_OFF</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db1_bar_info_dv</span> <span class="o">=</span> <span class="n">HDMI_INFOFRAME_AVI_DB1B_NO</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db1_scan_info</span> <span class="o">=</span> <span class="n">HDMI_INFOFRAME_AVI_DB1S_0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db2_colorimetry</span> <span class="o">=</span> <span class="n">HDMI_INFOFRAME_AVI_DB2C_NO</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db2_aspect_ratio</span> <span class="o">=</span> <span class="n">HDMI_INFOFRAME_AVI_DB2M_NO</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db2_active_fmt_ar</span> <span class="o">=</span> <span class="n">HDMI_INFOFRAME_AVI_DB2R_SAME</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db3_itc</span> <span class="o">=</span> <span class="n">HDMI_INFOFRAME_AVI_DB3ITC_NO</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db3_ec</span> <span class="o">=</span> <span class="n">HDMI_INFOFRAME_AVI_DB3EC_XVYUV601</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db3_q_range</span> <span class="o">=</span> <span class="n">HDMI_INFOFRAME_AVI_DB3Q_DEFAULT</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db3_nup_scaling</span> <span class="o">=</span> <span class="n">HDMI_INFOFRAME_AVI_DB3SC_NO</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db4_videocode</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cm</span><span class="p">.</span><span class="n">code</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db5_pixel_repeat</span> <span class="o">=</span> <span class="n">HDMI_INFOFRAME_AVI_DB5PR_NO</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db6_7_line_eoftop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db8_9_line_sofbottom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db10_11_pixel_eofleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avi_cfg</span><span class="p">.</span><span class="n">db12_13_pixel_sofright</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdmi_core_aux_infoframe_avi_config</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="cm">/* enable/repeat the infoframe */</span>
	<span class="n">repeat_cfg</span><span class="p">.</span><span class="n">avi_infoframe</span> <span class="o">=</span> <span class="n">HDMI_PACKETENABLE</span><span class="p">;</span>
	<span class="n">repeat_cfg</span><span class="p">.</span><span class="n">avi_infoframe_repeat</span> <span class="o">=</span> <span class="n">HDMI_PACKETREPEATON</span><span class="p">;</span>
	<span class="cm">/* wakeup */</span>
	<span class="n">repeat_cfg</span><span class="p">.</span><span class="n">audio_pkt</span> <span class="o">=</span> <span class="n">HDMI_PACKETENABLE</span><span class="p">;</span>
	<span class="n">repeat_cfg</span><span class="p">.</span><span class="n">audio_pkt_repeat</span> <span class="o">=</span> <span class="n">HDMI_PACKETREPEATON</span><span class="p">;</span>
	<span class="n">hdmi_core_av_packet_config</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">repeat_cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_wp_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define DUMPREG(r) seq_printf(s, &quot;%-35s %08x\n&quot;, #r,\</span>
<span class="cp">		hdmi_read_reg(hdmi_wp_base(ip_data), r))</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_REVISION</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_SYSCONFIG</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_IRQSTATUS_RAW</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_IRQSTATUS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_PWR_CTRL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_IRQENABLE_SET</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_VIDEO_CFG</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_VIDEO_SIZE</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_VIDEO_TIMING_H</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_VIDEO_TIMING_V</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_WP_CLK</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_AUDIO_CFG</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_AUDIO_CFG2</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_AUDIO_CTRL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">HDMI_WP_AUDIO_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_pll_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define DUMPPLL(r) seq_printf(s, &quot;%-35s %08x\n&quot;, #r,\</span>
<span class="cp">		hdmi_read_reg(hdmi_pll_base(ip_data), r))</span>

	<span class="n">DUMPPLL</span><span class="p">(</span><span class="n">PLLCTRL_PLL_CONTROL</span><span class="p">);</span>
	<span class="n">DUMPPLL</span><span class="p">(</span><span class="n">PLLCTRL_PLL_STATUS</span><span class="p">);</span>
	<span class="n">DUMPPLL</span><span class="p">(</span><span class="n">PLLCTRL_PLL_GO</span><span class="p">);</span>
	<span class="n">DUMPPLL</span><span class="p">(</span><span class="n">PLLCTRL_CFG1</span><span class="p">);</span>
	<span class="n">DUMPPLL</span><span class="p">(</span><span class="n">PLLCTRL_CFG2</span><span class="p">);</span>
	<span class="n">DUMPPLL</span><span class="p">(</span><span class="n">PLLCTRL_CFG3</span><span class="p">);</span>
	<span class="n">DUMPPLL</span><span class="p">(</span><span class="n">PLLCTRL_CFG4</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_core_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#define CORE_REG(i, name) name(i)</span>
<span class="cp">#define DUMPCORE(r) seq_printf(s, &quot;%-35s %08x\n&quot;, #r,\</span>
<span class="cp">		hdmi_read_reg(hdmi_core_sys_base(ip_data), r))</span>
<span class="cp">#define DUMPCOREAV(r) seq_printf(s, &quot;%-35s %08x\n&quot;, #r,\</span>
<span class="cp">		hdmi_read_reg(hdmi_av_base(ip_data), r))</span>
<span class="cp">#define DUMPCOREAV2(i, r) seq_printf(s, &quot;%s[%d]%*s %08x\n&quot;, #r, i, \</span>
<span class="cp">		(i &lt; 10) ? 32 - strlen(#r) : 31 - strlen(#r), &quot; &quot;, \</span>
<span class="cp">		hdmi_read_reg(hdmi_av_base(ip_data), CORE_REG(i, r)))</span>

	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_VND_IDL</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_DEV_IDL</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_DEV_IDH</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_DEV_REV</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_SRST</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_CTRL1</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_SYS_STAT</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_DE_DLY</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_DE_CTRL</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_DE_TOP</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_DE_CNTL</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_DE_CNTH</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_DE_LINL</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_DE_LINH_1</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_VID_ACEN</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_VID_MODE</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_INTR_STATE</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_INTR1</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_INTR2</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_INTR3</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_INTR4</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_UMASK1</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_SYS_TMDS_CTRL</span><span class="p">);</span>

	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_DDC_ADDR</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_DDC_SEGM</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_DDC_OFFSET</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_DDC_COUNT1</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_DDC_COUNT2</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_DDC_STATUS</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_DDC_CMD</span><span class="p">);</span>
	<span class="n">DUMPCORE</span><span class="p">(</span><span class="n">HDMI_CORE_DDC_DATA</span><span class="p">);</span>

	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_ACR_CTRL</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_FREQ_SVAL</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_N_SVAL1</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_N_SVAL2</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_N_SVAL3</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_CTS_SVAL1</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_CTS_SVAL2</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_CTS_SVAL3</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_CTS_HVAL1</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_CTS_HVAL2</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_CTS_HVAL3</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AUD_MODE</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_SPDIF_CTRL</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_HW_SPDIF_FS</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_SWAP_I2S</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_SPDIF_ERTH</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_I2S_IN_MAP</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_I2S_IN_CTRL</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_I2S_CHST0</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_I2S_CHST1</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_I2S_CHST2</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_I2S_CHST4</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_I2S_CHST5</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_ASRC</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_I2S_IN_LEN</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_HDMI_CTRL</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AUDO_TXSTAT</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AUD_PAR_BUSCLK_1</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AUD_PAR_BUSCLK_2</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AUD_PAR_BUSCLK_3</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_TEST_TXCTRL</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_DPD</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_PB_CTRL1</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_PB_CTRL2</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AVI_TYPE</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AVI_VERS</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AVI_LEN</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AVI_CHSUM</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE_NELEMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DUMPCOREAV2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AVI_DBYTE</span><span class="p">);</span>

	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_SPD_TYPE</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_SPD_VERS</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_SPD_LEN</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_SPD_CHSUM</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HDMI_CORE_AV_SPD_DBYTE_NELEMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DUMPCOREAV2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_SPD_DBYTE</span><span class="p">);</span>

	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AUDIO_TYPE</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AUDIO_VERS</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AUDIO_LEN</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_AUDIO_CHSUM</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE_NELEMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DUMPCOREAV2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE</span><span class="p">);</span>

	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_MPEG_TYPE</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_MPEG_VERS</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_MPEG_LEN</span><span class="p">);</span>
	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_MPEG_CHSUM</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HDMI_CORE_AV_MPEG_DBYTE_NELEMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DUMPCOREAV2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_MPEG_DBYTE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HDMI_CORE_AV_GEN_DBYTE_NELEMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DUMPCOREAV2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_GEN_DBYTE</span><span class="p">);</span>

	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_CP_BYTE1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HDMI_CORE_AV_GEN2_DBYTE_NELEMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DUMPCOREAV2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_GEN2_DBYTE</span><span class="p">);</span>

	<span class="n">DUMPCOREAV</span><span class="p">(</span><span class="n">HDMI_CORE_AV_CEC_ADDR_ID</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_phy_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define DUMPPHY(r) seq_printf(s, &quot;%-35s %08x\n&quot;, #r,\</span>
<span class="cp">		hdmi_read_reg(hdmi_phy_base(ip_data), r))</span>

	<span class="n">DUMPPHY</span><span class="p">(</span><span class="n">HDMI_TXPHY_TX_CTRL</span><span class="p">);</span>
	<span class="n">DUMPPHY</span><span class="p">(</span><span class="n">HDMI_TXPHY_DIGITAL_CTRL</span><span class="p">);</span>
	<span class="n">DUMPPHY</span><span class="p">(</span><span class="n">HDMI_TXPHY_POWER_CTRL</span><span class="p">);</span>
	<span class="n">DUMPPHY</span><span class="p">(</span><span class="n">HDMI_TXPHY_PAD_CFG_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_OMAP4_DSS_HDMI_AUDIO)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_wp_audio_config_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">hdmi_audio_format</span> <span class="o">*</span><span class="n">aud_fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;Enter hdmi_wp_audio_config_format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_AUDIO_CFG</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_fmt</span><span class="o">-&gt;</span><span class="n">stereo_channels</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_fmt</span><span class="o">-&gt;</span><span class="n">active_chnnls_msk</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_fmt</span><span class="o">-&gt;</span><span class="n">en_sig_blk_strt_end</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_fmt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_fmt</span><span class="o">-&gt;</span><span class="n">justification</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_fmt</span><span class="o">-&gt;</span><span class="n">sample_order</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_fmt</span><span class="o">-&gt;</span><span class="n">samples_per_word</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_fmt</span><span class="o">-&gt;</span><span class="n">sample_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_AUDIO_CFG</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_wp_audio_config_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">hdmi_audio_dma</span> <span class="o">*</span><span class="n">aud_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;Enter hdmi_wp_audio_config_dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_AUDIO_CFG2</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_dma</span><span class="o">-&gt;</span><span class="n">transfer_size</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_dma</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_AUDIO_CFG2</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_AUDIO_CTRL</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_dma</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aud_dma</span><span class="o">-&gt;</span><span class="n">fifo_threshold</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span> <span class="n">HDMI_WP_AUDIO_CTRL</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_core_audio_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">hdmi_core_audio_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">av_base</span> <span class="o">=</span> <span class="n">hdmi_av_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Parameters for generation of Audio Clock Recovery packets</span>
<span class="cm">	 */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_N_SVAL1</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_N_SVAL2</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_N_SVAL3</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cts_mode</span> <span class="o">==</span> <span class="n">HDMI_AUDIO_CTS_MODE_SW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_CTS_SVAL1</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cts</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span>
				<span class="n">HDMI_CORE_AV_CTS_SVAL2</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span>
				<span class="n">HDMI_CORE_AV_CTS_SVAL3</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_PAR_BUSCLK_1</span><span class="p">,</span>
				<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">aud_par_busclk</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_PAR_BUSCLK_2</span><span class="p">,</span>
				<span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">aud_par_busclk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_PAR_BUSCLK_3</span><span class="p">,</span>
				<span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">aud_par_busclk</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set ACR clock divisor */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span>
			<span class="n">HDMI_CORE_AV_FREQ_SVAL</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mclk_mode</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_ACR_CTRL</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Use TMDS clock for ACR packets. For devices that use</span>
<span class="cm">	 * the MCLK, this is the first part of the MCLK initialization.</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">en_acr_pkt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cts_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_ACR_CTRL</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* For devices using MCLK, this completes its initialization. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">use_mclk</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_ACR_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Override of SPDIF sample frequency with value in I2S_CHST4 */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_SPDIF_CTRL</span><span class="p">,</span>
						<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fs_override</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set IEC-60958-3 channel status word. It is passed to the IP</span>
<span class="cm">	 * just as it is received. The user of the driver is responsible</span>
<span class="cm">	 * for its contents.</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_I2S_CHST0</span><span class="p">,</span>
		       <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">iec60958_cfg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_I2S_CHST1</span><span class="p">,</span>
		       <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">iec60958_cfg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_I2S_CHST2</span><span class="p">,</span>
		       <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">iec60958_cfg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="cm">/* yes, this is correct: status[3] goes to CHST4 register */</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_I2S_CHST4</span><span class="p">,</span>
		       <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">iec60958_cfg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="cm">/* yes, this is correct: status[4] goes to CHST5 register */</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_I2S_CHST5</span><span class="p">,</span>
		       <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">iec60958_cfg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="cm">/* set I2S parameters */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_I2S_IN_CTRL</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">sck_edge_mode</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">vbit</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">justification</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">direction</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_I2S_IN_CTRL</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_I2S_IN_LEN</span><span class="p">,</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">in_length_bits</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Audio channels and mode parameters */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_HDMI_CTRL</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">hdmi_read_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_MODE</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">active_sds</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">en_dsd_audio</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">en_parallel_aud_input</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">en_spdif</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_MODE</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* Audio channel mappings */</span>
	<span class="cm">/* TODO: Make channel mapping dynamic. For now, map channels</span>
<span class="cm">	 * in the ALSA order: FL/FR/RL/RR/C/LFE/SL/SR. Remapping is needed as</span>
<span class="cm">	 * HDMI speaker order is different. See CEA-861 Section 6.6.2.</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_I2S_IN_MAP</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">);</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_SWAP_I2S</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_core_audio_infoframe_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_cea_861_aud_if</span> <span class="o">*</span><span class="n">info_aud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">av_base</span> <span class="o">=</span> <span class="n">hdmi_av_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set audio info frame type, version and length as</span>
<span class="cm">	 * described in HDMI 1.4a Section 8.2.2 specification.</span>
<span class="cm">	 * Checksum calculation is defined in Section 5.3.5.</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUDIO_TYPE</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUDIO_VERS</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUDIO_LEN</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="mh">0x84</span> <span class="o">+</span> <span class="mh">0x001</span> <span class="o">+</span> <span class="mh">0x00a</span><span class="p">;</span>

	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		       <span class="n">info_aud</span><span class="o">-&gt;</span><span class="n">db1_ct_cc</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">info_aud</span><span class="o">-&gt;</span><span class="n">db1_ct_cc</span><span class="p">;</span>

	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
		       <span class="n">info_aud</span><span class="o">-&gt;</span><span class="n">db2_sf_ss</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">info_aud</span><span class="o">-&gt;</span><span class="n">db2_sf_ss</span><span class="p">;</span>

	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">info_aud</span><span class="o">-&gt;</span><span class="n">db3</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">info_aud</span><span class="o">-&gt;</span><span class="n">db3</span><span class="p">;</span>

	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">info_aud</span><span class="o">-&gt;</span><span class="n">db4_ca</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">info_aud</span><span class="o">-&gt;</span><span class="n">db4_ca</span><span class="p">;</span>

	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
		       <span class="n">info_aud</span><span class="o">-&gt;</span><span class="n">db5_dminh_lsv</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">+=</span> <span class="n">info_aud</span><span class="o">-&gt;</span><span class="n">db5_dminh_lsv</span><span class="p">;</span>

	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span> <span class="n">HDMI_CORE_AV_AUD_DBYTE</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">checksum</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="n">sum</span><span class="p">;</span>
	<span class="n">hdmi_write_reg</span><span class="p">(</span><span class="n">av_base</span><span class="p">,</span>
					<span class="n">HDMI_CORE_AV_AUDIO_CHSUM</span><span class="p">,</span> <span class="n">checksum</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: Add MPEG and SPD enable and repeat cfg when EDID parsing</span>
<span class="cm">	 * is available.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ti_hdmi_4xxx_audio_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_dss_audio</span> <span class="o">*</span><span class="n">audio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdmi_audio_format</span> <span class="n">audio_format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_audio_dma</span> <span class="n">audio_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdmi_core_audio_config</span> <span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">cts</span><span class="p">,</span> <span class="n">channel_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fs_nr</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">word_length_16b</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">audio</span> <span class="o">||</span> <span class="o">!</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">iec</span> <span class="o">||</span> <span class="o">!</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">cea</span> <span class="o">||</span> <span class="o">!</span><span class="n">ip_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">core</span><span class="p">.</span><span class="n">iec60958_cfg</span> <span class="o">=</span> <span class="n">audio</span><span class="o">-&gt;</span><span class="n">iec</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * In the IEC-60958 status word, check if the audio sample word length</span>
<span class="cm">	 * is 16-bit as several optimizations can be performed in such case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">iec</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES4_CON_MAX_WORDLEN_24</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">iec</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES4_CON_WORDLEN_20_16</span><span class="p">)</span>
			<span class="n">word_length_16b</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* I2S configuration. See Phillips&#39; specification */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">word_length_16b</span><span class="p">)</span>
		<span class="n">core</span><span class="p">.</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">justification</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_JUSTIFY_LEFT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">core</span><span class="p">.</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">justification</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_JUSTIFY_RIGHT</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The I2S input word length is twice the lenght given in the IEC-60958</span>
<span class="cm">	 * status word. If the word size is greater than</span>
<span class="cm">	 * 20 bits, increment by one.</span>
<span class="cm">	 */</span>
	<span class="n">core</span><span class="p">.</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">in_length_bits</span> <span class="o">=</span> <span class="n">audio</span><span class="o">-&gt;</span><span class="n">iec</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
		<span class="o">&amp;</span> <span class="n">IEC958_AES4_CON_WORDLEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">iec</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES4_CON_MAX_WORDLEN_24</span><span class="p">)</span>
		<span class="n">core</span><span class="p">.</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">in_length_bits</span><span class="o">++</span><span class="p">;</span>
	<span class="n">core</span><span class="p">.</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">sck_edge_mode</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_I2S_SCK_EDGE_RISING</span><span class="p">;</span>
	<span class="n">core</span><span class="p">.</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">vbit</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_I2S_VBIT_FOR_PCM</span><span class="p">;</span>
	<span class="n">core</span><span class="p">.</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_I2S_MSB_SHIFTED_FIRST</span><span class="p">;</span>
	<span class="n">core</span><span class="p">.</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_I2S_FIRST_BIT_SHIFT</span><span class="p">;</span>

	<span class="cm">/* convert sample frequency to a number */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">iec</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES3_CON_FS</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_32000</span>:
		<span class="n">fs_nr</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_44100</span>:
		<span class="n">fs_nr</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_48000</span>:
		<span class="n">fs_nr</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_88200</span>:
		<span class="n">fs_nr</span> <span class="o">=</span> <span class="mi">88200</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_96000</span>:
		<span class="n">fs_nr</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_176400</span>:
		<span class="n">fs_nr</span> <span class="o">=</span> <span class="mi">176400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_192000</span>:
		<span class="n">fs_nr</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hdmi_compute_acr</span><span class="p">(</span><span class="n">fs_nr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cts</span><span class="p">);</span>

	<span class="cm">/* Audio clock regeneration settings */</span>
	<span class="n">core</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">core</span><span class="p">.</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cts</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_HDMI_CTS_SWMODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">core</span><span class="p">.</span><span class="n">aud_par_busclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">core</span><span class="p">.</span><span class="n">cts_mode</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_CTS_MODE_SW</span><span class="p">;</span>
		<span class="n">core</span><span class="p">.</span><span class="n">use_mclk</span> <span class="o">=</span> <span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_HDMI_AUDIO_USE_MCLK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">core</span><span class="p">.</span><span class="n">aud_par_busclk</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">31</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">core</span><span class="p">.</span><span class="n">cts_mode</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_CTS_MODE_HW</span><span class="p">;</span>
		<span class="n">core</span><span class="p">.</span><span class="n">use_mclk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="p">.</span><span class="n">use_mclk</span><span class="p">)</span>
		<span class="n">core</span><span class="p">.</span><span class="n">mclk_mode</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_MCLK_128FS</span><span class="p">;</span>

	<span class="cm">/* Audio channels settings */</span>
	<span class="n">channel_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">cea</span><span class="o">-&gt;</span><span class="n">db1_ct_cc</span> <span class="o">&amp;</span>
			 <span class="n">CEA861_AUDIO_INFOFRAME_DB1CC</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">channel_count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">audio_format</span><span class="p">.</span><span class="n">active_chnnls_msk</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">audio_format</span><span class="p">.</span><span class="n">active_chnnls_msk</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">audio_format</span><span class="p">.</span><span class="n">active_chnnls_msk</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">audio_format</span><span class="p">.</span><span class="n">active_chnnls_msk</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">audio_format</span><span class="p">.</span><span class="n">active_chnnls_msk</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">audio_format</span><span class="p">.</span><span class="n">active_chnnls_msk</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">audio_format</span><span class="p">.</span><span class="n">active_chnnls_msk</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * the HDMI IP needs to enable four stereo channels when transmitting</span>
<span class="cm">	 * more than 2 audio channels</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel_count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audio_format</span><span class="p">.</span><span class="n">stereo_channels</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_STEREO_ONECHANNEL</span><span class="p">;</span>
		<span class="n">core</span><span class="p">.</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">active_sds</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_I2S_SD0_EN</span><span class="p">;</span>
		<span class="n">core</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_LAYOUT_2CH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">audio_format</span><span class="p">.</span><span class="n">stereo_channels</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_STEREO_FOURCHANNELS</span><span class="p">;</span>
		<span class="n">core</span><span class="p">.</span><span class="n">i2s_cfg</span><span class="p">.</span><span class="n">active_sds</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_I2S_SD0_EN</span> <span class="o">|</span>
				<span class="n">HDMI_AUDIO_I2S_SD1_EN</span> <span class="o">|</span> <span class="n">HDMI_AUDIO_I2S_SD2_EN</span> <span class="o">|</span>
				<span class="n">HDMI_AUDIO_I2S_SD3_EN</span><span class="p">;</span>
		<span class="n">core</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_LAYOUT_8CH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">core</span><span class="p">.</span><span class="n">en_spdif</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/* use sample frequency from channel status word */</span>
	<span class="n">core</span><span class="p">.</span><span class="n">fs_override</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/* enable ACR packets */</span>
	<span class="n">core</span><span class="p">.</span><span class="n">en_acr_pkt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/* disable direct streaming digital audio */</span>
	<span class="n">core</span><span class="p">.</span><span class="n">en_dsd_audio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/* use parallel audio interface */</span>
	<span class="n">core</span><span class="p">.</span><span class="n">en_parallel_aud_input</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* DMA settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">word_length_16b</span><span class="p">)</span>
		<span class="n">audio_dma</span><span class="p">.</span><span class="n">transfer_size</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">audio_dma</span><span class="p">.</span><span class="n">transfer_size</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">audio_dma</span><span class="p">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
	<span class="n">audio_dma</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_TRANSF_DMA</span><span class="p">;</span>
	<span class="n">audio_dma</span><span class="p">.</span><span class="n">fifo_threshold</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* in number of samples */</span>

	<span class="cm">/* audio FIFO format settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">word_length_16b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audio_format</span><span class="p">.</span><span class="n">samples_per_word</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_ONEWORD_TWOSAMPLES</span><span class="p">;</span>
		<span class="n">audio_format</span><span class="p">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_SAMPLE_16BITS</span><span class="p">;</span>
		<span class="n">audio_format</span><span class="p">.</span><span class="n">justification</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_JUSTIFY_LEFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">audio_format</span><span class="p">.</span><span class="n">samples_per_word</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_ONEWORD_ONESAMPLE</span><span class="p">;</span>
		<span class="n">audio_format</span><span class="p">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_SAMPLE_24BITS</span><span class="p">;</span>
		<span class="n">audio_format</span><span class="p">.</span><span class="n">justification</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_JUSTIFY_RIGHT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">audio_format</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_TYPE_LPCM</span><span class="p">;</span>
	<span class="n">audio_format</span><span class="p">.</span><span class="n">sample_order</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_SAMPLE_LEFT_FIRST</span><span class="p">;</span>
	<span class="cm">/* disable start/stop signals of IEC 60958 blocks */</span>
	<span class="n">audio_format</span><span class="p">.</span><span class="n">en_sig_blk_strt_end</span> <span class="o">=</span> <span class="n">HDMI_AUDIO_BLOCK_SIG_STARTEND_ON</span><span class="p">;</span>

	<span class="cm">/* configure DMA and audio FIFO format*/</span>
	<span class="n">ti_hdmi_4xxx_wp_audio_config_dma</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audio_dma</span><span class="p">);</span>
	<span class="n">ti_hdmi_4xxx_wp_audio_config_format</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audio_format</span><span class="p">);</span>

	<span class="cm">/* configure the core*/</span>
	<span class="n">ti_hdmi_4xxx_core_audio_config</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">core</span><span class="p">);</span>

	<span class="cm">/* configure CEA 861 audio infoframe*/</span>
	<span class="n">ti_hdmi_4xxx_core_audio_infoframe_cfg</span><span class="p">(</span><span class="n">ip_data</span><span class="p">,</span> <span class="n">audio</span><span class="o">-&gt;</span><span class="n">cea</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ti_hdmi_4xxx_wp_audio_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span>
		    <span class="n">HDMI_WP_AUDIO_CTRL</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_wp_audio_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span>
		    <span class="n">HDMI_WP_AUDIO_CTRL</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ti_hdmi_4xxx_audio_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_av_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span>
		    <span class="n">HDMI_CORE_AV_AUD_MODE</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span>
		    <span class="n">HDMI_WP_AUDIO_CTRL</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ti_hdmi_4xxx_audio_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdmi_ip_data</span> <span class="o">*</span><span class="n">ip_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_av_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span>
		    <span class="n">HDMI_CORE_AV_AUD_MODE</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">hdmi_wp_base</span><span class="p">(</span><span class="n">ip_data</span><span class="p">),</span>
		    <span class="n">HDMI_WP_AUDIO_CTRL</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
