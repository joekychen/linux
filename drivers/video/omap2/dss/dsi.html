<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › omap2 › dss › dsi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dsi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/omap2/dss/dsi.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Nokia Corporation</span>
<span class="cm"> * Author: Tomi Valkeinen &lt;tomi.valkeinen@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>

<span class="cp">#define DSS_SUBSYS_NAME &quot;DSI&quot;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;video/omapdss.h&gt;</span>
<span class="cp">#include &lt;video/mipi_display.h&gt;</span>
<span class="cp">#include &lt;plat/clock.h&gt;</span>

<span class="cp">#include &quot;dss.h&quot;</span>
<span class="cp">#include &quot;dss_features.h&quot;</span>

<span class="cm">/*#define VERBOSE_IRQ*/</span>
<span class="cp">#define DSI_CATCH_MISSING_TE</span>

<span class="k">struct</span> <span class="n">dsi_reg</span> <span class="p">{</span> <span class="n">u16</span> <span class="n">idx</span><span class="p">;</span> <span class="p">};</span>

<span class="cp">#define DSI_REG(idx)		((const struct dsi_reg) { idx })</span>

<span class="cp">#define DSI_SZ_REGS		SZ_1K</span>
<span class="cm">/* DSI Protocol Engine */</span>

<span class="cp">#define DSI_REVISION			DSI_REG(0x0000)</span>
<span class="cp">#define DSI_SYSCONFIG			DSI_REG(0x0010)</span>
<span class="cp">#define DSI_SYSSTATUS			DSI_REG(0x0014)</span>
<span class="cp">#define DSI_IRQSTATUS			DSI_REG(0x0018)</span>
<span class="cp">#define DSI_IRQENABLE			DSI_REG(0x001C)</span>
<span class="cp">#define DSI_CTRL			DSI_REG(0x0040)</span>
<span class="cp">#define DSI_GNQ				DSI_REG(0x0044)</span>
<span class="cp">#define DSI_COMPLEXIO_CFG1		DSI_REG(0x0048)</span>
<span class="cp">#define DSI_COMPLEXIO_IRQ_STATUS	DSI_REG(0x004C)</span>
<span class="cp">#define DSI_COMPLEXIO_IRQ_ENABLE	DSI_REG(0x0050)</span>
<span class="cp">#define DSI_CLK_CTRL			DSI_REG(0x0054)</span>
<span class="cp">#define DSI_TIMING1			DSI_REG(0x0058)</span>
<span class="cp">#define DSI_TIMING2			DSI_REG(0x005C)</span>
<span class="cp">#define DSI_VM_TIMING1			DSI_REG(0x0060)</span>
<span class="cp">#define DSI_VM_TIMING2			DSI_REG(0x0064)</span>
<span class="cp">#define DSI_VM_TIMING3			DSI_REG(0x0068)</span>
<span class="cp">#define DSI_CLK_TIMING			DSI_REG(0x006C)</span>
<span class="cp">#define DSI_TX_FIFO_VC_SIZE		DSI_REG(0x0070)</span>
<span class="cp">#define DSI_RX_FIFO_VC_SIZE		DSI_REG(0x0074)</span>
<span class="cp">#define DSI_COMPLEXIO_CFG2		DSI_REG(0x0078)</span>
<span class="cp">#define DSI_RX_FIFO_VC_FULLNESS		DSI_REG(0x007C)</span>
<span class="cp">#define DSI_VM_TIMING4			DSI_REG(0x0080)</span>
<span class="cp">#define DSI_TX_FIFO_VC_EMPTINESS	DSI_REG(0x0084)</span>
<span class="cp">#define DSI_VM_TIMING5			DSI_REG(0x0088)</span>
<span class="cp">#define DSI_VM_TIMING6			DSI_REG(0x008C)</span>
<span class="cp">#define DSI_VM_TIMING7			DSI_REG(0x0090)</span>
<span class="cp">#define DSI_STOPCLK_TIMING		DSI_REG(0x0094)</span>
<span class="cp">#define DSI_VC_CTRL(n)			DSI_REG(0x0100 + (n * 0x20))</span>
<span class="cp">#define DSI_VC_TE(n)			DSI_REG(0x0104 + (n * 0x20))</span>
<span class="cp">#define DSI_VC_LONG_PACKET_HEADER(n)	DSI_REG(0x0108 + (n * 0x20))</span>
<span class="cp">#define DSI_VC_LONG_PACKET_PAYLOAD(n)	DSI_REG(0x010C + (n * 0x20))</span>
<span class="cp">#define DSI_VC_SHORT_PACKET_HEADER(n)	DSI_REG(0x0110 + (n * 0x20))</span>
<span class="cp">#define DSI_VC_IRQSTATUS(n)		DSI_REG(0x0118 + (n * 0x20))</span>
<span class="cp">#define DSI_VC_IRQENABLE(n)		DSI_REG(0x011C + (n * 0x20))</span>

<span class="cm">/* DSIPHY_SCP */</span>

<span class="cp">#define DSI_DSIPHY_CFG0			DSI_REG(0x200 + 0x0000)</span>
<span class="cp">#define DSI_DSIPHY_CFG1			DSI_REG(0x200 + 0x0004)</span>
<span class="cp">#define DSI_DSIPHY_CFG2			DSI_REG(0x200 + 0x0008)</span>
<span class="cp">#define DSI_DSIPHY_CFG5			DSI_REG(0x200 + 0x0014)</span>
<span class="cp">#define DSI_DSIPHY_CFG10		DSI_REG(0x200 + 0x0028)</span>

<span class="cm">/* DSI_PLL_CTRL_SCP */</span>

<span class="cp">#define DSI_PLL_CONTROL			DSI_REG(0x300 + 0x0000)</span>
<span class="cp">#define DSI_PLL_STATUS			DSI_REG(0x300 + 0x0004)</span>
<span class="cp">#define DSI_PLL_GO			DSI_REG(0x300 + 0x0008)</span>
<span class="cp">#define DSI_PLL_CONFIGURATION1		DSI_REG(0x300 + 0x000C)</span>
<span class="cp">#define DSI_PLL_CONFIGURATION2		DSI_REG(0x300 + 0x0010)</span>

<span class="cp">#define REG_GET(dsidev, idx, start, end) \</span>
<span class="cp">	FLD_GET(dsi_read_reg(dsidev, idx), start, end)</span>

<span class="cp">#define REG_FLD_MOD(dsidev, idx, val, start, end) \</span>
<span class="cp">	dsi_write_reg(dsidev, idx, FLD_MOD(dsi_read_reg(dsidev, idx), val, start, end))</span>

<span class="cm">/* Global interrupts */</span>
<span class="cp">#define DSI_IRQ_VC0		(1 &lt;&lt; 0)</span>
<span class="cp">#define DSI_IRQ_VC1		(1 &lt;&lt; 1)</span>
<span class="cp">#define DSI_IRQ_VC2		(1 &lt;&lt; 2)</span>
<span class="cp">#define DSI_IRQ_VC3		(1 &lt;&lt; 3)</span>
<span class="cp">#define DSI_IRQ_WAKEUP		(1 &lt;&lt; 4)</span>
<span class="cp">#define DSI_IRQ_RESYNC		(1 &lt;&lt; 5)</span>
<span class="cp">#define DSI_IRQ_PLL_LOCK	(1 &lt;&lt; 7)</span>
<span class="cp">#define DSI_IRQ_PLL_UNLOCK	(1 &lt;&lt; 8)</span>
<span class="cp">#define DSI_IRQ_PLL_RECALL	(1 &lt;&lt; 9)</span>
<span class="cp">#define DSI_IRQ_COMPLEXIO_ERR	(1 &lt;&lt; 10)</span>
<span class="cp">#define DSI_IRQ_HS_TX_TIMEOUT	(1 &lt;&lt; 14)</span>
<span class="cp">#define DSI_IRQ_LP_RX_TIMEOUT	(1 &lt;&lt; 15)</span>
<span class="cp">#define DSI_IRQ_TE_TRIGGER	(1 &lt;&lt; 16)</span>
<span class="cp">#define DSI_IRQ_ACK_TRIGGER	(1 &lt;&lt; 17)</span>
<span class="cp">#define DSI_IRQ_SYNC_LOST	(1 &lt;&lt; 18)</span>
<span class="cp">#define DSI_IRQ_LDO_POWER_GOOD	(1 &lt;&lt; 19)</span>
<span class="cp">#define DSI_IRQ_TA_TIMEOUT	(1 &lt;&lt; 20)</span>
<span class="cp">#define DSI_IRQ_ERROR_MASK \</span>
<span class="cp">	(DSI_IRQ_HS_TX_TIMEOUT | DSI_IRQ_LP_RX_TIMEOUT | DSI_IRQ_SYNC_LOST | \</span>
<span class="cp">	DSI_IRQ_TA_TIMEOUT | DSI_IRQ_SYNC_LOST)</span>
<span class="cp">#define DSI_IRQ_CHANNEL_MASK	0xf</span>

<span class="cm">/* Virtual channel interrupts */</span>
<span class="cp">#define DSI_VC_IRQ_CS		(1 &lt;&lt; 0)</span>
<span class="cp">#define DSI_VC_IRQ_ECC_CORR	(1 &lt;&lt; 1)</span>
<span class="cp">#define DSI_VC_IRQ_PACKET_SENT	(1 &lt;&lt; 2)</span>
<span class="cp">#define DSI_VC_IRQ_FIFO_TX_OVF	(1 &lt;&lt; 3)</span>
<span class="cp">#define DSI_VC_IRQ_FIFO_RX_OVF	(1 &lt;&lt; 4)</span>
<span class="cp">#define DSI_VC_IRQ_BTA		(1 &lt;&lt; 5)</span>
<span class="cp">#define DSI_VC_IRQ_ECC_NO_CORR	(1 &lt;&lt; 6)</span>
<span class="cp">#define DSI_VC_IRQ_FIFO_TX_UDF	(1 &lt;&lt; 7)</span>
<span class="cp">#define DSI_VC_IRQ_PP_BUSY_CHANGE (1 &lt;&lt; 8)</span>
<span class="cp">#define DSI_VC_IRQ_ERROR_MASK \</span>
<span class="cp">	(DSI_VC_IRQ_CS | DSI_VC_IRQ_ECC_CORR | DSI_VC_IRQ_FIFO_TX_OVF | \</span>
<span class="cp">	DSI_VC_IRQ_FIFO_RX_OVF | DSI_VC_IRQ_ECC_NO_CORR | \</span>
<span class="cp">	DSI_VC_IRQ_FIFO_TX_UDF)</span>

<span class="cm">/* ComplexIO interrupts */</span>
<span class="cp">#define DSI_CIO_IRQ_ERRSYNCESC1		(1 &lt;&lt; 0)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRSYNCESC2		(1 &lt;&lt; 1)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRSYNCESC3		(1 &lt;&lt; 2)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRSYNCESC4		(1 &lt;&lt; 3)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRSYNCESC5		(1 &lt;&lt; 4)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRESC1		(1 &lt;&lt; 5)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRESC2		(1 &lt;&lt; 6)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRESC3		(1 &lt;&lt; 7)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRESC4		(1 &lt;&lt; 8)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRESC5		(1 &lt;&lt; 9)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTROL1		(1 &lt;&lt; 10)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTROL2		(1 &lt;&lt; 11)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTROL3		(1 &lt;&lt; 12)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTROL4		(1 &lt;&lt; 13)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTROL5		(1 &lt;&lt; 14)</span>
<span class="cp">#define DSI_CIO_IRQ_STATEULPS1		(1 &lt;&lt; 15)</span>
<span class="cp">#define DSI_CIO_IRQ_STATEULPS2		(1 &lt;&lt; 16)</span>
<span class="cp">#define DSI_CIO_IRQ_STATEULPS3		(1 &lt;&lt; 17)</span>
<span class="cp">#define DSI_CIO_IRQ_STATEULPS4		(1 &lt;&lt; 18)</span>
<span class="cp">#define DSI_CIO_IRQ_STATEULPS5		(1 &lt;&lt; 19)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTENTIONLP0_1	(1 &lt;&lt; 20)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTENTIONLP1_1	(1 &lt;&lt; 21)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTENTIONLP0_2	(1 &lt;&lt; 22)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTENTIONLP1_2	(1 &lt;&lt; 23)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTENTIONLP0_3	(1 &lt;&lt; 24)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTENTIONLP1_3	(1 &lt;&lt; 25)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTENTIONLP0_4	(1 &lt;&lt; 26)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTENTIONLP1_4	(1 &lt;&lt; 27)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTENTIONLP0_5	(1 &lt;&lt; 28)</span>
<span class="cp">#define DSI_CIO_IRQ_ERRCONTENTIONLP1_5	(1 &lt;&lt; 29)</span>
<span class="cp">#define DSI_CIO_IRQ_ULPSACTIVENOT_ALL0	(1 &lt;&lt; 30)</span>
<span class="cp">#define DSI_CIO_IRQ_ULPSACTIVENOT_ALL1	(1 &lt;&lt; 31)</span>
<span class="cp">#define DSI_CIO_IRQ_ERROR_MASK \</span>
<span class="cp">	(DSI_CIO_IRQ_ERRSYNCESC1 | DSI_CIO_IRQ_ERRSYNCESC2 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRSYNCESC3 | DSI_CIO_IRQ_ERRSYNCESC4 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRSYNCESC5 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRESC1 | DSI_CIO_IRQ_ERRESC2 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRESC3 | DSI_CIO_IRQ_ERRESC4 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRESC5 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRCONTROL1 | DSI_CIO_IRQ_ERRCONTROL2 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRCONTROL3 | DSI_CIO_IRQ_ERRCONTROL4 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRCONTROL5 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRCONTENTIONLP0_1 | DSI_CIO_IRQ_ERRCONTENTIONLP1_1 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRCONTENTIONLP0_2 | DSI_CIO_IRQ_ERRCONTENTIONLP1_2 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRCONTENTIONLP0_3 | DSI_CIO_IRQ_ERRCONTENTIONLP1_3 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRCONTENTIONLP0_4 | DSI_CIO_IRQ_ERRCONTENTIONLP1_4 | \</span>
<span class="cp">	 DSI_CIO_IRQ_ERRCONTENTIONLP0_5 | DSI_CIO_IRQ_ERRCONTENTIONLP1_5)</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">omap_dsi_isr_t</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">);</span>

<span class="cp">#define DSI_MAX_NR_ISRS                2</span>
<span class="cp">#define DSI_MAX_NR_LANES	5</span>

<span class="k">enum</span> <span class="n">dsi_lane_function</span> <span class="p">{</span>
	<span class="n">DSI_LANE_UNUSED</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DSI_LANE_CLK</span><span class="p">,</span>
	<span class="n">DSI_LANE_DATA1</span><span class="p">,</span>
	<span class="n">DSI_LANE_DATA2</span><span class="p">,</span>
	<span class="n">DSI_LANE_DATA3</span><span class="p">,</span>
	<span class="n">DSI_LANE_DATA4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dsi_lane_config</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">dsi_lane_function</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">polarity</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="p">{</span>
	<span class="n">omap_dsi_isr_t</span>	<span class="n">isr</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">fifo_size</span> <span class="p">{</span>
	<span class="n">DSI_FIFO_SIZE_0</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DSI_FIFO_SIZE_32</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">DSI_FIFO_SIZE_64</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">DSI_FIFO_SIZE_96</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">DSI_FIFO_SIZE_128</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dsi_vc_source</span> <span class="p">{</span>
	<span class="n">DSI_VC_SOURCE_L4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DSI_VC_SOURCE_VP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dsi_irq_stats</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_reset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">irq_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">dsi_irqs</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">vc_irqs</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">cio_irqs</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dsi_isr_tables</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="n">isr_table</span><span class="p">[</span><span class="n">DSI_MAX_NR_ISRS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="n">isr_table_vc</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">DSI_MAX_NR_ISRS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="n">isr_table_cio</span><span class="p">[</span><span class="n">DSI_MAX_NR_ISRS</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dsi_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">module_id</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">dss_clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">sys_clk</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dsi_clock_info</span> <span class="n">current_cinfo</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">vdds_dsi_enabled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">vdds_dsi_reg</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">dsi_vc_source</span> <span class="n">source</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">;</span>
		<span class="k">enum</span> <span class="n">fifo_size</span> <span class="n">fifo_size</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">vc_id</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">vc</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">bus_lock</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">pll_locked</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">irq_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsi_isr_tables</span> <span class="n">isr_tables</span><span class="p">;</span>
	<span class="cm">/* space for a copy used by the interrupt handler */</span>
	<span class="k">struct</span> <span class="n">dsi_isr_tables</span> <span class="n">isr_tables_copy</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">update_channel</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">unsigned</span> <span class="n">update_bytes</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">bool</span> <span class="n">te_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ulps_enabled</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">framedone_callback</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">framedone_data</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">framedone_timeout_work</span><span class="p">;</span>

<span class="cp">#ifdef DSI_CATCH_MISSING_TE</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">te_timer</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cache_req_pck</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cache_clk_freq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsi_clock_info</span> <span class="n">cache_cinfo</span><span class="p">;</span>

	<span class="n">u32</span>		<span class="n">errors</span><span class="p">;</span>
	<span class="n">spinlock_t</span>	<span class="n">errors_lock</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">ktime_t</span> <span class="n">perf_setup_time</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">perf_start_time</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">debug_read</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">debug_write</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_COLLECT_IRQ_STATS</span>
	<span class="n">spinlock_t</span> <span class="n">irq_stats_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsi_irq_stats</span> <span class="n">irq_stats</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* DSI PLL Parameter Ranges */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regm_max</span><span class="p">,</span> <span class="n">regn_max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">regm_dispc_max</span><span class="p">,</span> <span class="n">regm_dsi_max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">fint_min</span><span class="p">,</span> <span class="n">fint_max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lpdiv_max</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">num_lanes_supported</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dsi_lane_config</span> <span class="n">lanes</span><span class="p">[</span><span class="n">DSI_MAX_NR_LANES</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">num_lanes_used</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">scp_clk_refcount</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dsi_packet_sent_handler_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">completion</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsi_pdev_map</span><span class="p">[</span><span class="n">MAX_NUM_DSI</span><span class="p">];</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">dsi_perf</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dsi_perf</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="nf">dsi_get_dsidrv_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="nf">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dsi_pdev_map</span><span class="p">[</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dsi</span><span class="p">.</span><span class="n">module</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="nf">dsi_get_dsidev_from_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dsi_pdev_map</span><span class="p">[</span><span class="n">module</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dsi_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dsi_reg</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">dsi_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dsi_reg</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dsi_bus_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">bus_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_bus_lock</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">dsi_bus_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">bus_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_bus_unlock</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">dsi_bus_is_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">bus_lock</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_completion_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">complete</span><span class="p">((</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wait_for_bit_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dsi_reg</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bitnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>

	<span class="cm">/* first busyloop to see if the bit changes right away */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">bitnum</span><span class="p">,</span> <span class="n">bitnum</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* then loop for 500ms, sleeping for 1ms in between */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">bitnum</span><span class="p">,</span> <span class="n">bitnum</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">value</span><span class="p">;</span>

		<span class="n">wait</span> <span class="o">=</span> <span class="n">ns_to_ktime</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">schedule_hrtimeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">dsi_get_pixel_size</span><span class="p">(</span><span class="k">enum</span> <span class="n">omap_dss_dsi_pixel_format</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_DSI_FMT_RGB888</span>:
	<span class="k">case</span> <span class="n">OMAP_DSS_DSI_FMT_RGB666</span>:
		<span class="k">return</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_DSI_FMT_RGB666_PACKED</span>:
		<span class="k">return</span> <span class="mi">18</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DSS_DSI_FMT_RGB565</span>:
		<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_perf_mark_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">perf_setup_time</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_perf_mark_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">perf_start_time</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_perf_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">ktime_t</span> <span class="n">t</span><span class="p">,</span> <span class="n">setup_time</span><span class="p">,</span> <span class="n">trans_time</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">total_bytes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">setup_us</span><span class="p">,</span> <span class="n">trans_us</span><span class="p">,</span> <span class="n">total_us</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsi_perf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>

	<span class="n">setup_time</span> <span class="o">=</span> <span class="n">ktime_sub</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">perf_start_time</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">perf_setup_time</span><span class="p">);</span>
	<span class="n">setup_us</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ktime_to_us</span><span class="p">(</span><span class="n">setup_time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup_us</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">setup_us</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">trans_time</span> <span class="o">=</span> <span class="n">ktime_sub</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">perf_start_time</span><span class="p">);</span>
	<span class="n">trans_us</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ktime_to_us</span><span class="p">(</span><span class="n">trans_time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trans_us</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">trans_us</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">total_us</span> <span class="o">=</span> <span class="n">setup_us</span> <span class="o">+</span> <span class="n">trans_us</span><span class="p">;</span>

	<span class="n">total_bytes</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">update_bytes</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DSI(%s): %u us + %u us = %u us (%uHz), &quot;</span>
			<span class="s">&quot;%u bytes, %u kbytes/sec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span>
			<span class="n">setup_us</span><span class="p">,</span>
			<span class="n">trans_us</span><span class="p">,</span>
			<span class="n">total_us</span><span class="p">,</span>
			<span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">total_us</span><span class="p">,</span>
			<span class="n">total_bytes</span><span class="p">,</span>
			<span class="n">total_bytes</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">total_us</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dsi_perf_mark_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dsi_perf_mark_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dsi_perf_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_irq_status</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifndef VERBOSE_IRQ</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DSI_IRQ_CHANNEL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DSI IRQ: 0x%x: &quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

<span class="cp">#define PIS(x) \</span>
<span class="cp">	if (status &amp; DSI_IRQ_##x) \</span>
<span class="cp">		printk(#x &quot; &quot;);</span>
<span class="cp">#ifdef VERBOSE_IRQ</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VC0</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VC1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VC2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VC3</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">WAKEUP</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">RESYNC</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PLL_LOCK</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PLL_UNLOCK</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PLL_RECALL</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">COMPLEXIO_ERR</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">HS_TX_TIMEOUT</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">LP_RX_TIMEOUT</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">TE_TRIGGER</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ACK_TRIGGER</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">SYNC_LOST</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">LDO_POWER_GOOD</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">TA_TIMEOUT</span><span class="p">);</span>
<span class="cp">#undef PIS</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_irq_status_vc</span><span class="p">(</span><span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifndef VERBOSE_IRQ</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DSI_VC_IRQ_PACKET_SENT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DSI VC(%d) IRQ 0x%x: &quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

<span class="cp">#define PIS(x) \</span>
<span class="cp">	if (status &amp; DSI_VC_IRQ_##x) \</span>
<span class="cp">		printk(#x &quot; &quot;);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">CS</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ECC_CORR</span><span class="p">);</span>
<span class="cp">#ifdef VERBOSE_IRQ</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PACKET_SENT</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">FIFO_TX_OVF</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">FIFO_RX_OVF</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">BTA</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ECC_NO_CORR</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">FIFO_TX_UDF</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PP_BUSY_CHANGE</span><span class="p">);</span>
<span class="cp">#undef PIS</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_irq_status_cio</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DSI CIO IRQ 0x%x: &quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

<span class="cp">#define PIS(x) \</span>
<span class="cp">	if (status &amp; DSI_CIO_IRQ_##x) \</span>
<span class="cp">		printk(#x &quot; &quot;);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRSYNCESC1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRSYNCESC2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRSYNCESC3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRESC1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRESC2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRESC3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTROL1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTROL2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTROL3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">STATEULPS1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">STATEULPS2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">STATEULPS3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP0_1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP1_1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP0_2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP1_2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP0_3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP1_3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ULPSACTIVENOT_ALL0</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ULPSACTIVENOT_ALL1</span><span class="p">);</span>
<span class="cp">#undef PIS</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_COLLECT_IRQ_STATS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_collect_irq_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">irqstatus</span><span class="p">,</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">vcstatus</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ciostatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats_lock</span><span class="p">);</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">.</span><span class="n">irq_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dss_collect_irq_stats</span><span class="p">(</span><span class="n">irqstatus</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">.</span><span class="n">dsi_irqs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dss_collect_irq_stats</span><span class="p">(</span><span class="n">vcstatus</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">.</span><span class="n">vc_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">dss_collect_irq_stats</span><span class="p">(</span><span class="n">ciostatus</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">.</span><span class="n">cio_irqs</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define dsi_collect_irq_stats(dsidev, irqstatus, vcstatus, ciostatus)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_irq</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_handle_irq_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">irqstatus</span><span class="p">,</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">vcstatus</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ciostatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">DSI_IRQ_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;DSI error, irqstatus %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irqstatus</span><span class="p">);</span>
		<span class="n">print_irq_status</span><span class="p">(</span><span class="n">irqstatus</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">errors_lock</span><span class="p">);</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">|=</span> <span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">DSI_IRQ_ERROR_MASK</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">errors_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">debug_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_irq_status</span><span class="p">(</span><span class="n">irqstatus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DSI_VC_IRQ_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;DSI VC(%d) error, vc irqstatus %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">i</span><span class="p">,</span> <span class="n">vcstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">print_irq_status_vc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">vcstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">debug_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_irq_status_vc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">vcstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ciostatus</span> <span class="o">&amp;</span> <span class="n">DSI_CIO_IRQ_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;DSI CIO error, cio irqstatus %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ciostatus</span><span class="p">);</span>
		<span class="n">print_irq_status_cio</span><span class="p">(</span><span class="n">ciostatus</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">debug_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_irq_status_cio</span><span class="p">(</span><span class="n">ciostatus</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_call_isrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="o">*</span><span class="n">isr_array</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">isr_array_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">irqstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="o">*</span><span class="n">isr_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">isr_array_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isr_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">&amp;&amp;</span> <span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">irqstatus</span><span class="p">)</span>
			<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="n">irqstatus</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_handle_isrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsi_isr_tables</span> <span class="o">*</span><span class="n">isr_tables</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">irqstatus</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vcstatus</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ciostatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dsi_call_isrs</span><span class="p">(</span><span class="n">isr_tables</span><span class="o">-&gt;</span><span class="n">isr_table</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">isr_tables</span><span class="o">-&gt;</span><span class="n">isr_table</span><span class="p">),</span>
			<span class="n">irqstatus</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dsi_call_isrs</span><span class="p">(</span><span class="n">isr_tables</span><span class="o">-&gt;</span><span class="n">isr_table_vc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">isr_tables</span><span class="o">-&gt;</span><span class="n">isr_table_vc</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				<span class="n">vcstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ciostatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dsi_call_isrs</span><span class="p">(</span><span class="n">isr_tables</span><span class="o">-&gt;</span><span class="n">isr_table_cio</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">isr_tables</span><span class="o">-&gt;</span><span class="n">isr_table_cio</span><span class="p">),</span>
				<span class="n">ciostatus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap_dsi_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irqstatus</span><span class="p">,</span> <span class="n">vcstatus</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ciostatus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dsidev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="n">irqstatus</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_IRQSTATUS</span><span class="p">);</span>

	<span class="cm">/* IRQ is not for us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqstatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_IRQSTATUS</span><span class="p">,</span> <span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DSI_IRQ_CHANNEL_MASK</span><span class="p">);</span>
	<span class="cm">/* flush posted write */</span>
	<span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_IRQSTATUS</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vcstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_IRQSTATUS</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_IRQSTATUS</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">vcstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="cm">/* flush posted write */</span>
		<span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_IRQSTATUS</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">DSI_IRQ_COMPLEXIO_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ciostatus</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_IRQ_STATUS</span><span class="p">);</span>

		<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_IRQ_STATUS</span><span class="p">,</span> <span class="n">ciostatus</span><span class="p">);</span>
		<span class="cm">/* flush posted write */</span>
		<span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_IRQ_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ciostatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DSI_CATCH_MISSING_TE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">DSI_IRQ_TE_TRIGGER</span><span class="p">)</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">te_timer</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* make a copy and unlock, so that isrs can unregister</span>
<span class="cm">	 * themselves */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables_copy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">));</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="n">dsi_handle_isrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables_copy</span><span class="p">,</span> <span class="n">irqstatus</span><span class="p">,</span> <span class="n">vcstatus</span><span class="p">,</span> <span class="n">ciostatus</span><span class="p">);</span>

	<span class="n">dsi_handle_irq_errors</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">irqstatus</span><span class="p">,</span> <span class="n">vcstatus</span><span class="p">,</span> <span class="n">ciostatus</span><span class="p">);</span>

	<span class="n">dsi_collect_irq_stats</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">irqstatus</span><span class="p">,</span> <span class="n">vcstatus</span><span class="p">,</span> <span class="n">ciostatus</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dsi-&gt;irq_lock has to be locked by the caller */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_omap_dsi_configure_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="o">*</span><span class="n">isr_array</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">isr_array_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">default_mask</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dsi_reg</span> <span class="n">enable_reg</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dsi_reg</span> <span class="n">status_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="o">*</span><span class="n">isr_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">old_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">default_mask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">isr_array_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isr_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mask</span> <span class="o">|=</span> <span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_mask</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">enable_reg</span><span class="p">);</span>
	<span class="cm">/* clear the irqstatus for newly enabled irqs */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">^</span> <span class="n">old_mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">enable_reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="cm">/* flush posted writes */</span>
	<span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">enable_reg</span><span class="p">);</span>
	<span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* dsi-&gt;irq_lock has to be locked by the caller */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_omap_dsi_set_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">DSI_IRQ_ERROR_MASK</span><span class="p">;</span>
<span class="cp">#ifdef DSI_CATCH_MISSING_TE</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="n">DSI_IRQ_TE_TRIGGER</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">_omap_dsi_configure_irqs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table</span><span class="p">),</span> <span class="n">mask</span><span class="p">,</span>
			<span class="n">DSI_IRQENABLE</span><span class="p">,</span> <span class="n">DSI_IRQSTATUS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* dsi-&gt;irq_lock has to be locked by the caller */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_omap_dsi_set_irqs_vc</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">_omap_dsi_configure_irqs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_vc</span><span class="p">[</span><span class="n">vc</span><span class="p">],</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_vc</span><span class="p">[</span><span class="n">vc</span><span class="p">]),</span>
			<span class="n">DSI_VC_IRQ_ERROR_MASK</span><span class="p">,</span>
			<span class="n">DSI_VC_IRQENABLE</span><span class="p">(</span><span class="n">vc</span><span class="p">),</span> <span class="n">DSI_VC_IRQSTATUS</span><span class="p">(</span><span class="n">vc</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* dsi-&gt;irq_lock has to be locked by the caller */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_omap_dsi_set_irqs_cio</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">_omap_dsi_configure_irqs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_cio</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_cio</span><span class="p">),</span>
			<span class="n">DSI_CIO_IRQ_ERROR_MASK</span><span class="p">,</span>
			<span class="n">DSI_COMPLEXIO_IRQ_ENABLE</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_IRQ_STATUS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dsi_initialize_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">));</span>

	<span class="n">_omap_dsi_set_irqs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vc</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">vc</span><span class="p">)</span>
		<span class="n">_omap_dsi_set_irqs_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
	<span class="n">_omap_dsi_set_irqs_cio</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_dsi_register_isr</span><span class="p">(</span><span class="n">omap_dsi_isr_t</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="o">*</span><span class="n">isr_array</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">isr_array_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="o">*</span><span class="n">isr_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">isr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* check for duplicate entry and find a free slot */</span>
	<span class="n">free_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">isr_array_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isr_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">==</span> <span class="n">isr</span> <span class="o">&amp;&amp;</span> <span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">==</span> <span class="n">arg</span> <span class="o">&amp;&amp;</span>
				<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">free_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">free_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">isr_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isr_array</span><span class="p">[</span><span class="n">free_idx</span><span class="p">];</span>
	<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="n">isr</span><span class="p">;</span>
	<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_dsi_unregister_isr</span><span class="p">(</span><span class="n">omap_dsi_isr_t</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="o">*</span><span class="n">isr_array</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">isr_array_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_isr_data</span> <span class="o">*</span><span class="n">isr_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">isr_array_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isr_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">!=</span> <span class="n">isr</span> <span class="o">||</span> <span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">!=</span> <span class="n">arg</span> <span class="o">||</span>
				<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">!=</span> <span class="n">mask</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">isr_data</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_register_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">omap_dsi_isr_t</span> <span class="n">isr</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_dsi_register_isr</span><span class="p">(</span><span class="n">isr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">_omap_dsi_set_irqs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_unregister_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="n">omap_dsi_isr_t</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_dsi_unregister_isr</span><span class="p">(</span><span class="n">isr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">_omap_dsi_set_irqs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_register_isr_vc</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">omap_dsi_isr_t</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_dsi_register_isr</span><span class="p">(</span><span class="n">isr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
			<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_vc</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_vc</span><span class="p">[</span><span class="n">channel</span><span class="p">]));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">_omap_dsi_set_irqs_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_unregister_isr_vc</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">omap_dsi_isr_t</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_dsi_unregister_isr</span><span class="p">(</span><span class="n">isr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
			<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_vc</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_vc</span><span class="p">[</span><span class="n">channel</span><span class="p">]));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">_omap_dsi_set_irqs_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_register_isr_cio</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="n">omap_dsi_isr_t</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_dsi_register_isr</span><span class="p">(</span><span class="n">isr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_cio</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_cio</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">_omap_dsi_set_irqs_cio</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_unregister_isr_cio</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="n">omap_dsi_isr_t</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_dsi_unregister_isr</span><span class="p">(</span><span class="n">isr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_cio</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">isr_tables</span><span class="p">.</span><span class="n">isr_table_cio</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">_omap_dsi_set_irqs_cio</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dsi_get_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">e</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">errors_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">errors_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dsi_runtime_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_runtime_get</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dsi_runtime_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_runtime_put</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* source clock for DSI PLL. this could also be PCLKFREE */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dsi_enable_pll_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">sys_clk</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">sys_clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pll_locked</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_STATUS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;cannot lock PLL when enabling clocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dsi_print_reset_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dss_debug</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* A dummy read using the SCP interface to any DSIPHY register is</span>
<span class="cm">	 * required after DSIPHY reset to complete the reset of the DSI complex</span>
<span class="cm">	 * I/O. */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG5</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DSI resets: &quot;</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_STATUS</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PLL (%d) &quot;</span><span class="p">,</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG1</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CIO (%d) &quot;</span><span class="p">,</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_DSI_REVERSE_TXCLKESC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b0</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>
		<span class="n">b1</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span>
		<span class="n">b2</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b0</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">b1</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="n">b2</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG5</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PHY (%x%x%x, %d, %d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">b0</span><span class="p">),</span>
			<span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b1</span><span class="p">),</span>
			<span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b2</span><span class="p">),</span>
			<span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span>
			<span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
			<span class="n">FLD_GET</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define _dsi_print_reset_status(x)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dsi_if_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_if_enable(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CTRL</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* IF_EN */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">enable</span><span class="p">)</span> <span class="o">!=</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to set dsi_if_enable to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dsi_get_pll_hsdiv_dispc_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">dsi_pll_hsdiv_dispc_clk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dsi_get_pll_hsdiv_dsi_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">dsi_pll_hsdiv_dsi_clk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dsi_get_txbyteclkhs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">clkin4ddr</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dsi_fclk_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dss_get_dsi_clk_source</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">OMAP_DSS_CLK_SRC_FCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DSI FCLK source is DSS_CLK_FCK */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">dss_clk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* DSI FCLK source is dsi_pll_hsdiv_dsi_clk */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_get_pll_hsdiv_dsi_rate</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_set_lp_clk_divisor</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dsi_fclk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lp_clk_div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lp_clk</span><span class="p">;</span>

	<span class="n">lp_clk_div</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dsi</span><span class="p">.</span><span class="n">lp_clk_div</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp_clk_div</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lp_clk_div</span> <span class="o">&gt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lpdiv_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dsi_fclk</span> <span class="o">=</span> <span class="n">dsi_fclk_rate</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">lp_clk</span> <span class="o">=</span> <span class="n">dsi_fclk</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">lp_clk_div</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;LP_CLK_DIV %u, LP_CLK %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp_clk_div</span><span class="p">,</span> <span class="n">lp_clk</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">lp_clk</span> <span class="o">=</span> <span class="n">lp_clk</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">lp_clk_div</span> <span class="o">=</span> <span class="n">lp_clk_div</span><span class="p">;</span>

	<span class="cm">/* LP_CLK_DIVISOR */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">,</span> <span class="n">lp_clk_div</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* LP_RX_SYNCHRO_ENABLE */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">,</span> <span class="n">dsi_fclk</span> <span class="o">&gt;</span> <span class="mi">30000000</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_enable_scp_clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">scp_clk_refcount</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span> <span class="cm">/* CIO_CLK_ICG */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_disable_scp_clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">scp_clk_refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">scp_clk_refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span> <span class="cm">/* CIO_CLK_ICG */</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">dsi_pll_power_state</span> <span class="p">{</span>
	<span class="n">DSI_PLL_POWER_OFF</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="n">DSI_PLL_POWER_ON_HSCLK</span>	<span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">DSI_PLL_POWER_ON_ALL</span>	<span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">DSI_PLL_POWER_ON_DIV</span>	<span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_pll_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">dsi_pll_power_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* DSI-PLL power command 0x3 is not working */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_DSI_PLL_PWR_BUG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">state</span> <span class="o">==</span> <span class="n">DSI_PLL_POWER_ON_DIV</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">DSI_PLL_POWER_ON_ALL</span><span class="p">;</span>

	<span class="cm">/* PLL_PWR_CMD */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

	<span class="cm">/* PLL_PWR_STATUS */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">FLD_GET</span><span class="p">(</span><span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">),</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to set DSI PLL power mode to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">state</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* calculate clock rates using dividers in cinfo */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_calc_clock_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dsi_clock_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regn</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regn</span> <span class="o">&gt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">regn_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm</span> <span class="o">&gt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">regm_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dispc</span> <span class="o">&gt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">regm_dispc_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dsi</span> <span class="o">&gt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">regm_dsi_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">sys_clk</span><span class="p">);</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin</span> <span class="o">/</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span> <span class="o">&gt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">fint_max</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">fint_min</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin4ddr</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm</span> <span class="o">*</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin4ddr</span> <span class="o">&gt;</span> <span class="mi">1800</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dispc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">dsi_pll_hsdiv_dispc_clk</span> <span class="o">=</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin4ddr</span> <span class="o">/</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dispc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">dsi_pll_hsdiv_dispc_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">dsi_pll_hsdiv_dsi_clk</span> <span class="o">=</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin4ddr</span> <span class="o">/</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dsi</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">dsi_pll_hsdiv_dsi_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dsi_pll_calc_clock_div_pck</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_tft</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">req_pck</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsi_clock_info</span> <span class="o">*</span><span class="n">dsi_cinfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dispc_clock_info</span> <span class="o">*</span><span class="n">dispc_cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_clock_info</span> <span class="n">cur</span><span class="p">,</span> <span class="n">best</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dispc_clock_info</span> <span class="n">best_dispc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_fck_per_pck</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dss_sys_clk</span><span class="p">,</span> <span class="n">max_dss_fck</span><span class="p">;</span>

	<span class="n">dss_sys_clk</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">sys_clk</span><span class="p">);</span>

	<span class="n">max_dss_fck</span> <span class="o">=</span> <span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_DSS_FCK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req_pck</span> <span class="o">==</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">cache_req_pck</span> <span class="o">&amp;&amp;</span>
			<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">cache_cinfo</span><span class="p">.</span><span class="n">clkin</span> <span class="o">==</span> <span class="n">dss_sys_clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;DSI clock info found from cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dsi_cinfo</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">cache_cinfo</span><span class="p">;</span>
		<span class="n">dispc_find_clk_divs</span><span class="p">(</span><span class="n">is_tft</span><span class="p">,</span> <span class="n">req_pck</span><span class="p">,</span>
			<span class="n">dsi_cinfo</span><span class="o">-&gt;</span><span class="n">dsi_pll_hsdiv_dispc_clk</span><span class="p">,</span> <span class="n">dispc_cinfo</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">min_fck_per_pck</span> <span class="o">=</span> <span class="n">CONFIG_OMAP2_DSS_MIN_FCK_PER_PCK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">min_fck_per_pck</span> <span class="o">&amp;&amp;</span>
		<span class="n">req_pck</span> <span class="o">*</span> <span class="n">min_fck_per_pck</span> <span class="o">&gt;</span> <span class="n">max_dss_fck</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Requested pixel clock not possible with the current &quot;</span>
				<span class="s">&quot;OMAP2_DSS_MIN_FCK_PER_PCK setting. Turning &quot;</span>
				<span class="s">&quot;the constraint off.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">min_fck_per_pck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_pll_calc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">retry:</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">best</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">best</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">best_dispc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">best_dispc</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cur</span><span class="p">));</span>
	<span class="n">cur</span><span class="p">.</span><span class="n">clkin</span> <span class="o">=</span> <span class="n">dss_sys_clk</span><span class="p">;</span>

	<span class="cm">/* 0.75MHz &lt; Fint = clkin / regn &lt; 2.1MHz */</span>
	<span class="cm">/* To reduce PLL lock time, keep Fint high (around 2 MHz) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">regn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cur</span><span class="p">.</span><span class="n">regn</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">regn_max</span><span class="p">;</span> <span class="o">++</span><span class="n">cur</span><span class="p">.</span><span class="n">regn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span><span class="p">.</span><span class="n">fint</span> <span class="o">=</span> <span class="n">cur</span><span class="p">.</span><span class="n">clkin</span> <span class="o">/</span> <span class="n">cur</span><span class="p">.</span><span class="n">regn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">fint</span> <span class="o">&gt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">fint_max</span> <span class="o">||</span> <span class="n">cur</span><span class="p">.</span><span class="n">fint</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">fint_min</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* DSIPHY(MHz) = (2 * regm / regn) * clkin */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">regm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cur</span><span class="p">.</span><span class="n">regm</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">regm_max</span><span class="p">;</span> <span class="o">++</span><span class="n">cur</span><span class="p">.</span><span class="n">regm</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>

			<span class="n">a</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cur</span><span class="p">.</span><span class="n">regm</span> <span class="o">*</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">clkin</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">cur</span><span class="p">.</span><span class="n">regn</span><span class="p">;</span>
			<span class="n">cur</span><span class="p">.</span><span class="n">clkin4ddr</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">clkin4ddr</span> <span class="o">&gt;</span> <span class="mi">1800</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* dsi_pll_hsdiv_dispc_clk(MHz) =</span>
<span class="cm">			 * DSIPHY(MHz) / regm_dispc  &lt; 173MHz/186Mhz */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">regm_dispc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cur</span><span class="p">.</span><span class="n">regm_dispc</span> <span class="o">&lt;</span>
					<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">regm_dispc_max</span><span class="p">;</span> <span class="o">++</span><span class="n">cur</span><span class="p">.</span><span class="n">regm_dispc</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">dispc_clock_info</span> <span class="n">cur_dispc</span><span class="p">;</span>
				<span class="n">cur</span><span class="p">.</span><span class="n">dsi_pll_hsdiv_dispc_clk</span> <span class="o">=</span>
					<span class="n">cur</span><span class="p">.</span><span class="n">clkin4ddr</span> <span class="o">/</span> <span class="n">cur</span><span class="p">.</span><span class="n">regm_dispc</span><span class="p">;</span>

				<span class="cm">/* this will narrow down the search a bit,</span>
<span class="cm">				 * but still give pixclocks below what was</span>
<span class="cm">				 * requested */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">dsi_pll_hsdiv_dispc_clk</span>  <span class="o">&lt;</span> <span class="n">req_pck</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">dsi_pll_hsdiv_dispc_clk</span> <span class="o">&gt;</span> <span class="n">max_dss_fck</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">min_fck_per_pck</span> <span class="o">&amp;&amp;</span>
					<span class="n">cur</span><span class="p">.</span><span class="n">dsi_pll_hsdiv_dispc_clk</span> <span class="o">&lt;</span>
						<span class="n">req_pck</span> <span class="o">*</span> <span class="n">min_fck_per_pck</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">dispc_find_clk_divs</span><span class="p">(</span><span class="n">is_tft</span><span class="p">,</span> <span class="n">req_pck</span><span class="p">,</span>
						<span class="n">cur</span><span class="p">.</span><span class="n">dsi_pll_hsdiv_dispc_clk</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">cur_dispc</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">cur_dispc</span><span class="p">.</span><span class="n">pck</span> <span class="o">-</span> <span class="n">req_pck</span><span class="p">)</span> <span class="o">&lt;</span>
						<span class="n">abs</span><span class="p">(</span><span class="n">best_dispc</span><span class="p">.</span><span class="n">pck</span> <span class="o">-</span> <span class="n">req_pck</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">best</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
					<span class="n">best_dispc</span> <span class="o">=</span> <span class="n">cur_dispc</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">cur_dispc</span><span class="p">.</span><span class="n">pck</span> <span class="o">==</span> <span class="n">req_pck</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">found:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">min_fck_per_pck</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Could not find suitable clock settings.</span><span class="se">\n</span><span class="s">&quot;</span>
					<span class="s">&quot;Turning FCK/PCK constraint off and&quot;</span>
					<span class="s">&quot;trying again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">min_fck_per_pck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Could not find suitable clock settings.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* dsi_pll_hsdiv_dsi_clk (regm_dsi) is not used */</span>
	<span class="n">best</span><span class="p">.</span><span class="n">regm_dsi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">best</span><span class="p">.</span><span class="n">dsi_pll_hsdiv_dsi_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi_cinfo</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dsi_cinfo</span> <span class="o">=</span> <span class="n">best</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dispc_cinfo</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dispc_cinfo</span> <span class="o">=</span> <span class="n">best_dispc</span><span class="p">;</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">cache_req_pck</span> <span class="o">=</span> <span class="n">req_pck</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">cache_clk_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">cache_cinfo</span> <span class="o">=</span> <span class="n">best</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dsi_pll_set_clock_div</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dsi_clock_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">regn_start</span><span class="p">,</span> <span class="n">regn_end</span><span class="p">,</span> <span class="n">regm_start</span><span class="p">,</span> <span class="n">regm_end</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">regm_dispc_start</span><span class="p">,</span> <span class="n">regm_dispc_end</span><span class="p">,</span> <span class="n">regm_dsi_start</span><span class="p">,</span> <span class="n">regm_dsi_end</span><span class="p">;</span>

	<span class="n">DSSDBGF</span><span class="p">();</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">clkin</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">fint</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">clkin4ddr</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin4ddr</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">dsi_pll_hsdiv_dispc_clk</span> <span class="o">=</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">dsi_pll_hsdiv_dispc_clk</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">dsi_pll_hsdiv_dsi_clk</span> <span class="o">=</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">dsi_pll_hsdiv_dsi_clk</span><span class="p">;</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">regn</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regn</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">regm</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">regm_dispc</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dispc</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">regm_dsi</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dsi</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;DSI Fint %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;clkin rate %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin</span><span class="p">);</span>

	<span class="cm">/* DSIPHY == CLKIN4DDR */</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;CLKIN4DDR = 2 * %d / %d * %lu = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm</span><span class="p">,</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regn</span><span class="p">,</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin</span><span class="p">,</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin4ddr</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;Data rate on 1 DSI lane %ld Mbps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin4ddr</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;Clock lane freq %ld Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin4ddr</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;regm_dispc = %d, %s (%s) = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dispc</span><span class="p">,</span>
		<span class="n">dss_get_generic_clk_source_name</span><span class="p">(</span><span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DISPC</span><span class="p">),</span>
		<span class="n">dss_feat_get_clk_source_name</span><span class="p">(</span><span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DISPC</span><span class="p">),</span>
		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">dsi_pll_hsdiv_dispc_clk</span><span class="p">);</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;regm_dsi = %d, %s (%s) = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dsi</span><span class="p">,</span>
		<span class="n">dss_get_generic_clk_source_name</span><span class="p">(</span><span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DSI</span><span class="p">),</span>
		<span class="n">dss_feat_get_clk_source_name</span><span class="p">(</span><span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DSI</span><span class="p">),</span>
		<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">dsi_pll_hsdiv_dsi_clk</span><span class="p">);</span>

	<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_DSIPLL_REGN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regn_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regn_end</span><span class="p">);</span>
	<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_DSIPLL_REGM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regm_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regm_end</span><span class="p">);</span>
	<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_DSIPLL_REGM_DISPC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regm_dispc_start</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">regm_dispc_end</span><span class="p">);</span>
	<span class="n">dss_feat_get_reg_field</span><span class="p">(</span><span class="n">FEAT_REG_DSIPLL_REGM_DSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regm_dsi_start</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">regm_dsi_end</span><span class="p">);</span>

	<span class="cm">/* DSI_PLL_AUTOMODE = manual */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_CONFIGURATION1</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* DSI_PLL_STOPMODE */</span>
	<span class="cm">/* DSI_PLL_REGN */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regn_start</span><span class="p">,</span> <span class="n">regn_end</span><span class="p">);</span>
	<span class="cm">/* DSI_PLL_REGM */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm</span><span class="p">,</span> <span class="n">regm_start</span><span class="p">,</span> <span class="n">regm_end</span><span class="p">);</span>
	<span class="cm">/* DSI_CLOCK_DIV */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dispc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dispc</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">regm_dispc_start</span><span class="p">,</span> <span class="n">regm_dispc_end</span><span class="p">);</span>
	<span class="cm">/* DSIPROTO_CLOCK_DIV */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dsi</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dsi</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">regm_dsi_start</span><span class="p">,</span> <span class="n">regm_dsi_end</span><span class="p">);</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_CONFIGURATION1</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">fint_min</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span> <span class="o">&gt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">fint_max</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_DSI_PLL_FREQSEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span> <span class="o">&lt;</span> <span class="mi">1000000</span> <span class="o">?</span> <span class="mh">0x3</span> <span class="o">:</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span> <span class="o">&lt;</span> <span class="mi">1250000</span> <span class="o">?</span> <span class="mh">0x4</span> <span class="o">:</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span> <span class="o">&lt;</span> <span class="mi">1500000</span> <span class="o">?</span> <span class="mh">0x5</span> <span class="o">:</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span> <span class="o">&lt;</span> <span class="mi">1750000</span> <span class="o">?</span> <span class="mh">0x6</span> <span class="o">:</span>
			<span class="mh">0x7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_CONFIGURATION2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_DSI_PLL_FREQSEL</span><span class="p">))</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* DSI_PLL_FREQSEL */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>		<span class="cm">/* DSI_PLL_REFEN */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>		<span class="cm">/* DSIPHY_CLKINEN */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>		<span class="cm">/* DSI_HSDIVBYPASS */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_CONFIGURATION2</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_GO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* DSI_PLL_GO */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_GO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;dsi pll go bit not going down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_STATUS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;cannot lock PLL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pll_locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_CONFIGURATION2</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* DSI_PLL_IDLE */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* DSI_PLL_PLLLPMODE */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* DSI_PLL_LOWCURRSTBY */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* DSI_PLL_TIGHTPHASELOCK */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* DSI_PLL_DRIFTGUARDEN */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>	<span class="cm">/* DSI_PLL_LOCKSEL */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>	<span class="cm">/* DSI_PLL_REFEN */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>	<span class="cm">/* DSIPHY_CLKINEN */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>	<span class="cm">/* DSI_BYPASSEN */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* DSS_CLOCK_EN */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>	<span class="cm">/* DSS_CLOCK_PWDN */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>	<span class="cm">/* DSI_PROTO_CLOCK_EN */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>	<span class="cm">/* DSI_PROTO_CLOCK_PWDN */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>	<span class="cm">/* DSI_HSDIVBYPASS */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_CONFIGURATION2</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;PLL config done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dsi_pll_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable_hsclk</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">enable_hsdiv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dsi_pll_power_state</span> <span class="n">pwstate</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;PLL init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">vdds_dsi</span><span class="p">;</span>

		<span class="n">vdds_dsi</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vdds_dsi&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vdds_dsi</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get VDDS_DSI regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">vdds_dsi</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_reg</span> <span class="o">=</span> <span class="n">vdds_dsi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi_enable_pll_clock</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note: SCP CLK is not required on OMAP3, but it is required on OMAP4.</span>
<span class="cm">	 */</span>
	<span class="n">dsi_enable_scp_clk</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* XXX PLL does not come out of reset without this... */</span>
	<span class="n">dispc_pck_free_enable</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;PLL not coming out of reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">dispc_pck_free_enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* XXX ... but if left on, we get problems when planes do not</span>
<span class="cm">	 * fill the whole display. No idea about this */</span>
	<span class="n">dispc_pck_free_enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_hsclk</span> <span class="o">&amp;&amp;</span> <span class="n">enable_hsdiv</span><span class="p">)</span>
		<span class="n">pwstate</span> <span class="o">=</span> <span class="n">DSI_PLL_POWER_ON_ALL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">enable_hsclk</span><span class="p">)</span>
		<span class="n">pwstate</span> <span class="o">=</span> <span class="n">DSI_PLL_POWER_ON_HSCLK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">enable_hsdiv</span><span class="p">)</span>
		<span class="n">pwstate</span> <span class="o">=</span> <span class="n">DSI_PLL_POWER_ON_DIV</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pwstate</span> <span class="o">=</span> <span class="n">DSI_PLL_POWER_OFF</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_pll_power</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">pwstate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;PLL init done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regulator_disable</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_reg</span><span class="p">);</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">err0:</span>
	<span class="n">dsi_disable_scp_clk</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">dsi_enable_pll_clock</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dsi_pll_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">disconnect_lanes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pll_locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dsi_pll_power</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_POWER_OFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disconnect_lanes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_enabled</span><span class="p">);</span>
		<span class="n">regulator_disable</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_reg</span><span class="p">);</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi_disable_scp_clk</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">dsi_enable_pll_clock</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;PLL uninit done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_dump_dsidev_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_clock_info</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">omap_dss_clk_source</span> <span class="n">dispc_clk_src</span><span class="p">,</span> <span class="n">dsi_clk_src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dsi_module</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span><span class="p">;</span>

	<span class="n">dispc_clk_src</span> <span class="o">=</span> <span class="n">dss_get_dispc_clk_source</span><span class="p">();</span>
	<span class="n">dsi_clk_src</span> <span class="o">=</span> <span class="n">dss_get_dsi_clk_source</span><span class="p">(</span><span class="n">dsi_module</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi_runtime_get</span><span class="p">(</span><span class="n">dsidev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;- DSI%d PLL -</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsi_module</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;dsi pll clkin</span><span class="se">\t</span><span class="s">%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;Fint</span><span class="se">\t\t</span><span class="s">%-16luregn %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">fint</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regn</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;CLKIN4DDR</span><span class="se">\t</span><span class="s">%-16luregm %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin4ddr</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;DSI_PLL_HSDIV_DISPC (%s)</span><span class="se">\t</span><span class="s">%-16luregm_dispc %u</span><span class="se">\t</span><span class="s">(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dss_feat_get_clk_source_name</span><span class="p">(</span><span class="n">dsi_module</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span>
				<span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DISPC</span> <span class="o">:</span>
				<span class="n">OMAP_DSS_CLK_SRC_DSI2_PLL_HSDIV_DISPC</span><span class="p">),</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">dsi_pll_hsdiv_dispc_clk</span><span class="p">,</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dispc</span><span class="p">,</span>
			<span class="n">dispc_clk_src</span> <span class="o">==</span> <span class="n">OMAP_DSS_CLK_SRC_FCK</span> <span class="o">?</span>
			<span class="s">&quot;off&quot;</span> <span class="o">:</span> <span class="s">&quot;on&quot;</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;DSI_PLL_HSDIV_DSI (%s)</span><span class="se">\t</span><span class="s">%-16luregm_dsi %u</span><span class="se">\t</span><span class="s">(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dss_feat_get_clk_source_name</span><span class="p">(</span><span class="n">dsi_module</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span>
				<span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DSI</span> <span class="o">:</span>
				<span class="n">OMAP_DSS_CLK_SRC_DSI2_PLL_HSDIV_DSI</span><span class="p">),</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">dsi_pll_hsdiv_dsi_clk</span><span class="p">,</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">regm_dsi</span><span class="p">,</span>
			<span class="n">dsi_clk_src</span> <span class="o">==</span> <span class="n">OMAP_DSS_CLK_SRC_FCK</span> <span class="o">?</span>
			<span class="s">&quot;off&quot;</span> <span class="o">:</span> <span class="s">&quot;on&quot;</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;- DSI%d -</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsi_module</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;dsi fclk source = %s (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dss_get_generic_clk_source_name</span><span class="p">(</span><span class="n">dsi_clk_src</span><span class="p">),</span>
			<span class="n">dss_feat_get_clk_source_name</span><span class="p">(</span><span class="n">dsi_clk_src</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;DSI_FCLK</span><span class="se">\t</span><span class="s">%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsi_fclk_rate</span><span class="p">(</span><span class="n">dsidev</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;DDR_CLK</span><span class="se">\t\t</span><span class="s">%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">clkin4ddr</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;TxByteClkHS</span><span class="se">\t</span><span class="s">%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsi_get_txbyteclkhs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>	<span class="s">&quot;LP_CLK</span><span class="se">\t\t</span><span class="s">%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">lp_clk</span><span class="p">);</span>

	<span class="n">dsi_runtime_put</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dsi_dump_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span>  <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_DSI</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_id</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsidev</span><span class="p">)</span>
			<span class="n">dsi_dump_dsidev_clocks</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_COLLECT_IRQ_STATS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_dump_dsidev_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsi_irq_stats</span> <span class="n">stats</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">));</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">.</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;period %u ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">last_reset</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;irqs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">irq_count</span><span class="p">);</span>
<span class="cp">#define PIS(x) \</span>
<span class="cp">	seq_printf(s, &quot;%-20s %10d\n&quot;, #x, stats.dsi_irqs[ffs(DSI_IRQ_##x)-1]);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;-- DSI%d interrupts --</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VC0</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VC1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VC2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">VC3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">WAKEUP</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">RESYNC</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PLL_LOCK</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PLL_UNLOCK</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PLL_RECALL</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">COMPLEXIO_ERR</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">HS_TX_TIMEOUT</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">LP_RX_TIMEOUT</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">TE_TRIGGER</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ACK_TRIGGER</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">SYNC_LOST</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">LDO_POWER_GOOD</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">TA_TIMEOUT</span><span class="p">);</span>
<span class="cp">#undef PIS</span>

<span class="cp">#define PIS(x) \</span>
<span class="cp">	seq_printf(s, &quot;%-20s %10d %10d %10d %10d\n&quot;, #x, \</span>
<span class="cp">			stats.vc_irqs[0][ffs(DSI_VC_IRQ_##x)-1], \</span>
<span class="cp">			stats.vc_irqs[1][ffs(DSI_VC_IRQ_##x)-1], \</span>
<span class="cp">			stats.vc_irqs[2][ffs(DSI_VC_IRQ_##x)-1], \</span>
<span class="cp">			stats.vc_irqs[3][ffs(DSI_VC_IRQ_##x)-1]);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;-- VC interrupts --</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">CS</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ECC_CORR</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PACKET_SENT</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">FIFO_TX_OVF</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">FIFO_RX_OVF</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">BTA</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ECC_NO_CORR</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">FIFO_TX_UDF</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">PP_BUSY_CHANGE</span><span class="p">);</span>
<span class="cp">#undef PIS</span>

<span class="cp">#define PIS(x) \</span>
<span class="cp">	seq_printf(s, &quot;%-20s %10d\n&quot;, #x, \</span>
<span class="cp">			stats.cio_irqs[ffs(DSI_CIO_IRQ_##x)-1]);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;-- CIO interrupts --</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRSYNCESC1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRSYNCESC2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRSYNCESC3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRESC1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRESC2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRESC3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTROL1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTROL2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTROL3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">STATEULPS1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">STATEULPS2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">STATEULPS3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP0_1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP1_1</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP0_2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP1_2</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP0_3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ERRCONTENTIONLP1_3</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ULPSACTIVENOT_ALL0</span><span class="p">);</span>
	<span class="n">PIS</span><span class="p">(</span><span class="n">ULPSACTIVENOT_ALL1</span><span class="p">);</span>
<span class="cp">#undef PIS</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi1_dump_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">dsi_dump_dsidev_irqs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi2_dump_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_id</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dsi_dump_dsidev_irqs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_dump_dsidev_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define DUMPREG(r) seq_printf(s, &quot;%-35s %08x\n&quot;, #r, dsi_read_reg(dsidev, r))</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi_runtime_get</span><span class="p">(</span><span class="n">dsidev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dsi_enable_scp_clk</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_REVISION</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_SYSCONFIG</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_SYSSTATUS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_IRQSTATUS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_IRQENABLE</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_CTRL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_COMPLEXIO_CFG1</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_COMPLEXIO_IRQ_STATUS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_COMPLEXIO_IRQ_ENABLE</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_CLK_CTRL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_TIMING1</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_TIMING2</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VM_TIMING1</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VM_TIMING2</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VM_TIMING3</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_CLK_TIMING</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_TX_FIFO_VC_SIZE</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_RX_FIFO_VC_SIZE</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_COMPLEXIO_CFG2</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_RX_FIFO_VC_FULLNESS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VM_TIMING4</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_TX_FIFO_VC_EMPTINESS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VM_TIMING5</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VM_TIMING6</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VM_TIMING7</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_STOPCLK_TIMING</span><span class="p">);</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_TE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_LONG_PACKET_HEADER</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_LONG_PACKET_PAYLOAD</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_SHORT_PACKET_HEADER</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_IRQSTATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_IRQENABLE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_TE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_LONG_PACKET_HEADER</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_LONG_PACKET_PAYLOAD</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_SHORT_PACKET_HEADER</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_IRQSTATUS</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_IRQENABLE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_TE</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_LONG_PACKET_HEADER</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_LONG_PACKET_PAYLOAD</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_SHORT_PACKET_HEADER</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_IRQSTATUS</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_IRQENABLE</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_TE</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_LONG_PACKET_HEADER</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_LONG_PACKET_PAYLOAD</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_SHORT_PACKET_HEADER</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_IRQSTATUS</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_VC_IRQENABLE</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_DSIPHY_CFG0</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_DSIPHY_CFG1</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_DSIPHY_CFG2</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_DSIPHY_CFG5</span><span class="p">);</span>

	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_PLL_CONTROL</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_PLL_STATUS</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_PLL_GO</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_PLL_CONFIGURATION1</span><span class="p">);</span>
	<span class="n">DUMPREG</span><span class="p">(</span><span class="n">DSI_PLL_CONFIGURATION2</span><span class="p">);</span>

	<span class="n">dsi_disable_scp_clk</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">dsi_runtime_put</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
<span class="cp">#undef DUMPREG</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi1_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">dsi_dump_dsidev_regs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi2_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_id</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dsi_dump_dsidev_regs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">dsi_cio_power_state</span> <span class="p">{</span>
	<span class="n">DSI_COMPLEXIO_POWER_OFF</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="n">DSI_COMPLEXIO_POWER_ON</span>		<span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">DSI_COMPLEXIO_POWER_ULPS</span>	<span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_cio_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">dsi_cio_power_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* PWR_CMD */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG1</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">27</span><span class="p">);</span>

	<span class="cm">/* PWR_STATUS */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">FLD_GET</span><span class="p">(</span><span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG1</span><span class="p">),</span>
			<span class="mi">26</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to set complexio power state to &quot;</span>
					<span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">dsi_get_line_buf_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* line buffer on OMAP3 is 1024 x 24bits */</span>
	<span class="cm">/* XXX: for some reason using full buffer size causes</span>
<span class="cm">	 * considerable TX slowdown with update sizes that fill the</span>
<span class="cm">	 * whole buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_DSI_GNQ</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1023</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_GNQ</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span> <span class="cm">/* VP1_LINE_BUFFER_SIZE */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* 512x24 bits */</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="mi">682</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* 682x24 bits */</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="mi">853</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* 853x24 bits */</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* 1024x24 bits */</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">return</span> <span class="mi">1194</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* 1194x24 bits */</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">return</span> <span class="mi">1365</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* 1365x24 bits */</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_set_lane_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">offsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">enum</span> <span class="n">dsi_lane_function</span> <span class="n">functions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">DSI_LANE_CLK</span><span class="p">,</span>
		<span class="n">DSI_LANE_DATA1</span><span class="p">,</span>
		<span class="n">DSI_LANE_DATA2</span><span class="p">,</span>
		<span class="n">DSI_LANE_DATA3</span><span class="p">,</span>
		<span class="n">DSI_LANE_DATA4</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_used</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="n">polarity</span><span class="p">,</span> <span class="n">lane_number</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">t</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span><span class="p">;</span> <span class="o">++</span><span class="n">t</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">function</span> <span class="o">==</span> <span class="n">functions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">lane_number</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">polarity</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">polarity</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lane_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">polarity</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* clear the unused lanes */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG1</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">ns2ddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="cm">/* convert time in ns to ddr ticks, rounding up */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ddr_clk</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">clkin4ddr</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ns</span> <span class="o">*</span> <span class="p">(</span><span class="n">ddr_clk</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">999</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">ddr2ns</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ddr_clk</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">current_cinfo</span><span class="p">.</span><span class="n">clkin4ddr</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ddr</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="n">ddr_clk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_cio_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ths_prepare</span><span class="p">,</span> <span class="n">ths_prepare_ths_zero</span><span class="p">,</span> <span class="n">ths_trail</span><span class="p">,</span> <span class="n">ths_exit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tlpx_half</span><span class="p">,</span> <span class="n">tclk_trail</span><span class="p">,</span> <span class="n">tclk_zero</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tclk_prepare</span><span class="p">;</span>

	<span class="cm">/* calculate timings */</span>

	<span class="cm">/* 1 * DDR_CLK = 2 * UI */</span>

	<span class="cm">/* min 40ns + 4*UI	max 85ns + 6*UI */</span>
	<span class="n">ths_prepare</span> <span class="o">=</span> <span class="n">ns2ddr</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* min 145ns + 10*UI */</span>
	<span class="n">ths_prepare_ths_zero</span> <span class="o">=</span> <span class="n">ns2ddr</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">175</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* min max(8*UI, 60ns+4*UI) */</span>
	<span class="n">ths_trail</span> <span class="o">=</span> <span class="n">ns2ddr</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>

	<span class="cm">/* min 100ns */</span>
	<span class="n">ths_exit</span> <span class="o">=</span> <span class="n">ns2ddr</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">145</span><span class="p">);</span>

	<span class="cm">/* tlpx min 50n */</span>
	<span class="n">tlpx_half</span> <span class="o">=</span> <span class="n">ns2ddr</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>

	<span class="cm">/* min 60ns */</span>
	<span class="n">tclk_trail</span> <span class="o">=</span> <span class="n">ns2ddr</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* min 38ns, max 95ns */</span>
	<span class="n">tclk_prepare</span> <span class="o">=</span> <span class="n">ns2ddr</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">65</span><span class="p">);</span>

	<span class="cm">/* min tclk-prepare + tclk-zero = 300ns */</span>
	<span class="n">tclk_zero</span> <span class="o">=</span> <span class="n">ns2ddr</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">260</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;ths_prepare %u (%uns), ths_prepare_ths_zero %u (%uns)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ths_prepare</span><span class="p">,</span> <span class="n">ddr2ns</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">ths_prepare</span><span class="p">),</span>
		<span class="n">ths_prepare_ths_zero</span><span class="p">,</span> <span class="n">ddr2ns</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">ths_prepare_ths_zero</span><span class="p">));</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;ths_trail %u (%uns), ths_exit %u (%uns)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ths_trail</span><span class="p">,</span> <span class="n">ddr2ns</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">ths_trail</span><span class="p">),</span>
			<span class="n">ths_exit</span><span class="p">,</span> <span class="n">ddr2ns</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">ths_exit</span><span class="p">));</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;tlpx_half %u (%uns), tclk_trail %u (%uns), &quot;</span>
			<span class="s">&quot;tclk_zero %u (%uns)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tlpx_half</span><span class="p">,</span> <span class="n">ddr2ns</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">tlpx_half</span><span class="p">),</span>
			<span class="n">tclk_trail</span><span class="p">,</span> <span class="n">ddr2ns</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">tclk_trail</span><span class="p">),</span>
			<span class="n">tclk_zero</span><span class="p">,</span> <span class="n">ddr2ns</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">tclk_zero</span><span class="p">));</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;tclk_prepare %u (%uns)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tclk_prepare</span><span class="p">,</span> <span class="n">ddr2ns</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">tclk_prepare</span><span class="p">));</span>

	<span class="cm">/* program timings */</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG0</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ths_prepare</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ths_prepare_ths_zero</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ths_trail</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ths_exit</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG0</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tlpx_half</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tclk_trail</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tclk_zero</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG1</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG2</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tclk_prepare</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG2</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* lane masks have lane 0 at lsb. mask_p for positive lines, n for negative */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_cio_enable_lane_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">mask_p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mask_n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lptxscp_start</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="mi">22</span> <span class="o">:</span> <span class="mi">26</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">p</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">polarity</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mask_p</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">l</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mask_n</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">l</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bits in REGLPTXSCPDAT4TO0DXDY:</span>
<span class="cm">	 * 17: DY0 18: DX0</span>
<span class="cm">	 * 19: DY1 20: DX1</span>
<span class="cm">	 * 21: DY2 22: DX2</span>
<span class="cm">	 * 23: DY3 24: DX3</span>
<span class="cm">	 * 25: DY4 26: DX4</span>
<span class="cm">	 */</span>

	<span class="cm">/* Set the lane override configuration */</span>

	<span class="cm">/* REGLPTXSCPDAT4TO0DXDY */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG10</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">lptxscp_start</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>

	<span class="cm">/* Enable lane override */</span>

	<span class="cm">/* ENLPTXSCPDAT */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">27</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_cio_disable_lane_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable lane override */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">27</span><span class="p">);</span> <span class="cm">/* ENLPTXSCPDAT */</span>
	<span class="cm">/* Reset the lane override configuration */</span>
	<span class="cm">/* REGLPTXSCPDAT4TO0DXDY */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_cio_wait_tx_clk_esc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">in_use</span><span class="p">[</span><span class="n">DSI_MAX_NR_LANES</span><span class="p">];</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">offsets_old</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">26</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">offsets_new</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span> <span class="p">};</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">offsets</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_DSI_REVERSE_TXCLKESC</span><span class="p">))</span>
		<span class="n">offsets</span> <span class="o">=</span> <span class="n">offsets_old</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">offsets</span> <span class="o">=</span> <span class="n">offsets_new</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">in_use</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span> <span class="o">!=</span> <span class="n">DSI_LANE_UNUSED</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

		<span class="n">l</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG5</span><span class="p">);</span>

		<span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_use</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
				<span class="n">ok</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">==</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_use</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;CIO TXCLKESC%d domain not coming &quot;</span> \
						<span class="s">&quot;out of reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return bitmask of enabled lanes, lane0 being the lsb */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">dsi_get_lane_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span> <span class="o">!=</span> <span class="n">DSI_LANE_UNUSED</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_cio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">DSSDBGF</span><span class="p">();</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dss_dsi_enable_pads</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span><span class="p">,</span> <span class="n">dsi_get_lane_mask</span><span class="p">(</span><span class="n">dssdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dsi_enable_scp_clk</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="cm">/* A dummy read using the SCP interface to any DSIPHY register is</span>
<span class="cm">	 * required after DSIPHY reset to complete the reset of the DSI complex</span>
<span class="cm">	 * I/O. */</span>
	<span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG5</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;CIO SCP Clock domain not coming out of reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_scp_clk_dom</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_set_lane_config</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_scp_clk_dom</span><span class="p">;</span>

	<span class="cm">/* set TX STOP MODE timer to maximum for this operation */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING1</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>	<span class="cm">/* FORCE_TX_STOP_MODE_IO */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>	<span class="cm">/* STOP_STATE_X16_IO */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>	<span class="cm">/* STOP_STATE_X4_IO */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mh">0x1fff</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* STOP_STATE_COUNTER_IO */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING1</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">ulps_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">mask_p</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;manual ulps exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* ULPS is exited by Mark-1 state for 1ms, followed by</span>
<span class="cm">		 * stop state. DSS HW cannot do this via the normal</span>
<span class="cm">		 * ULPS exit sequence, as after reset the DSS HW thinks</span>
<span class="cm">		 * that we are not in ULPS mode, and refuses to send the</span>
<span class="cm">		 * sequence. So we need to send the ULPS exit sequence</span>
<span class="cm">		 * manually by setting positive lines high and negative lines</span>
<span class="cm">		 * low for 1ms.</span>
<span class="cm">		 */</span>

		<span class="n">mask_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span> <span class="o">==</span> <span class="n">DSI_LANE_UNUSED</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">mask_p</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dsi_cio_enable_lane_override</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">mask_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_cio_power</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_POWER_ON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_cio_pwr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG1</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;CIO PWR clock domain not coming out of reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_cio_pwr_dom</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span> <span class="cm">/* LP_CLK_ENABLE */</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_cio_wait_tx_clk_esc_reset</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_tx_clk_esc_rst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">ulps_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Keep Mark-1 state for 1ms (as per DSI spec) */</span>
		<span class="n">ktime_t</span> <span class="n">wait</span> <span class="o">=</span> <span class="n">ns_to_ktime</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">schedule_hrtimeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>

		<span class="cm">/* Disable the override. The lanes should be set to Mark-11</span>
<span class="cm">		 * state by the HW */</span>
		<span class="n">dsi_cio_disable_lane_override</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FORCE_TX_STOP_MODE_IO */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>

	<span class="n">dsi_cio_timings</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_DSI_VIDEO_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DDR_CLK_ALWAYS_ON */</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">,</span>
			<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">ddr_clk_always_on</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">ulps_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;CIO init done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_tx_clk_esc_rst:</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span> <span class="cm">/* LP_CLK_ENABLE */</span>
<span class="nl">err_cio_pwr_dom:</span>
	<span class="n">dsi_cio_power</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_POWER_OFF</span><span class="p">);</span>
<span class="nl">err_cio_pwr:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">ulps_enabled</span><span class="p">)</span>
		<span class="n">dsi_cio_disable_lane_override</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
<span class="nl">err_scp_clk_dom:</span>
	<span class="n">dsi_disable_scp_clk</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">dss_dsi_disable_pads</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span><span class="p">,</span> <span class="n">dsi_get_lane_mask</span><span class="p">(</span><span class="n">dssdev</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_cio_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="cm">/* DDR_CLK_ALWAYS_ON */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>

	<span class="n">dsi_cio_power</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_POWER_OFF</span><span class="p">);</span>
	<span class="n">dsi_disable_scp_clk</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">dss_dsi_disable_pads</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span><span class="p">,</span> <span class="n">dsi_get_lane_mask</span><span class="p">(</span><span class="n">dssdev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_config_tx_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">fifo_size</span> <span class="n">size1</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fifo_size</span> <span class="n">size2</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">fifo_size</span> <span class="n">size3</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fifo_size</span> <span class="n">size4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">add</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">size1</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">size2</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">size3</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">size4</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">add</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Illegal FIFO configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">v</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="cm">/*DSSDBG(&quot;TX FIFO vc %d: size %d, add %d\n&quot;, i, size, add); */</span>
		<span class="n">add</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TX_FIFO_VC_SIZE</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_config_rx_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">fifo_size</span> <span class="n">size1</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fifo_size</span> <span class="n">size2</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">fifo_size</span> <span class="n">size3</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fifo_size</span> <span class="n">size4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">add</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">size1</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">size2</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">size3</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">size4</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">add</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Illegal FIFO configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">v</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="cm">/*DSSDBG(&quot;RX FIFO vc %d: size %d, add %d\n&quot;, i, size, add); */</span>
		<span class="n">add</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_RX_FIFO_VC_SIZE</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_force_tx_stop_mode_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>	<span class="cm">/* FORCE_TX_STOP_MODE_IO */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING1</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;TX_STOP bit not going down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">dsi_vc_is_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_packet_sent_handler_vp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_packet_sent_handler_data</span> <span class="o">*</span><span class="n">vp_data</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">dsi_packet_sent_handler_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">vp_data</span><span class="o">-&gt;</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">update_channel</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">te_enabled</span> <span class="o">?</span> <span class="mi">30</span> <span class="o">:</span> <span class="mi">31</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">vp_data</span><span class="o">-&gt;</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_TE</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">vp_data</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_sync_vc_vp</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">completion</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_packet_sent_handler_data</span> <span class="n">vp_data</span> <span class="o">=</span> <span class="p">{</span> <span class="n">dsidev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completion</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bit</span><span class="p">;</span>

	<span class="n">bit</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">te_enabled</span> <span class="o">?</span> <span class="mi">30</span> <span class="o">:</span> <span class="mi">31</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_register_isr_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dsi_packet_sent_handler_vp</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vp_data</span><span class="p">,</span> <span class="n">DSI_VC_IRQ_PACKET_SENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>

	<span class="cm">/* Wait for completion only if TE_EN/TE_START is still set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_TE</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bit</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to complete previous frame transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dsi_unregister_isr_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dsi_packet_sent_handler_vp</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vp_data</span><span class="p">,</span> <span class="n">DSI_VC_IRQ_PACKET_SENT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err1:</span>
	<span class="n">dsi_unregister_isr_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dsi_packet_sent_handler_vp</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">vp_data</span><span class="p">,</span> <span class="n">DSI_VC_IRQ_PACKET_SENT</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_packet_sent_handler_l4</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_packet_sent_handler_data</span> <span class="o">*</span><span class="n">l4_data</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">dsi_packet_sent_handler_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">l4_data</span><span class="o">-&gt;</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">update_channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">l4_data</span><span class="o">-&gt;</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">l4_data</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_sync_vc_l4</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">completion</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_packet_sent_handler_data</span> <span class="n">l4_data</span> <span class="o">=</span> <span class="p">{</span> <span class="n">dsidev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completion</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_register_isr_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dsi_packet_sent_handler_l4</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">l4_data</span><span class="p">,</span> <span class="n">DSI_VC_IRQ_PACKET_SENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>

	<span class="cm">/* Wait for completion only if TX_FIFO_NOT_EMPTY is still set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to complete previous l4 transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dsi_unregister_isr_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dsi_packet_sent_handler_l4</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">l4_data</span><span class="p">,</span> <span class="n">DSI_VC_IRQ_PACKET_SENT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err1:</span>
	<span class="n">dsi_unregister_isr_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dsi_packet_sent_handler_l4</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">l4_data</span><span class="p">,</span> <span class="n">DSI_VC_IRQ_PACKET_SENT</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_sync_vc</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dsi_bus_is_locked</span><span class="p">(</span><span class="n">dsidev</span><span class="p">));</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">());</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsi_vc_is_enabled</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DSI_VC_SOURCE_VP</span>:
		<span class="k">return</span> <span class="n">dsi_sync_vc_vp</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DSI_VC_SOURCE_L4</span>:
		<span class="k">return</span> <span class="n">dsi_sync_vc_l4</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_vc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_vc_enable channel %d, enable %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">channel</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">enable</span><span class="p">)</span> <span class="o">!=</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to set dsi_vc_enable to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_vc_initial_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DSSDBGF</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span> <span class="cm">/* VC_BUSY */</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;VC(%d) busy when trying to configure it!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">channel</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* SOURCE, 0 = L4 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* BTA_SHORT_EN  */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="cm">/* BTA_LONG_EN */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* MODE, 0 = command */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span> <span class="cm">/* CS_TX_EN */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* ECC_TX_EN */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span> <span class="cm">/* MODE_SPEED, high speed on/off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_DSI_VC_OCP_WIDTH</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>	<span class="cm">/* OCP_WIDTH = 32 bit */</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">27</span><span class="p">);</span> <span class="cm">/* DMA_RX_REQ_NB = no dma */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span> <span class="cm">/* DMA_TX_REQ_NB = no dma */</span>

	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_vc_config_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">dsi_vc_source</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">source</span> <span class="o">==</span> <span class="n">source</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DSSDBGF</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">dsi_sync_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* VC_BUSY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;vc(%d) busy when trying to config for VP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SOURCE, 0 = L4, 1 = video port */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">source</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* DCS_CMD_ENABLE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_DSI_DCS_CMD_CONFIG_VC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">enable</span> <span class="o">=</span> <span class="n">source</span> <span class="o">==</span> <span class="n">DSI_VC_SOURCE_VP</span><span class="p">;</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omapdss_dsi_vc_enable_hs</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_vc_enable_hs(%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dsi_bus_is_locked</span><span class="p">(</span><span class="n">dsidev</span><span class="p">));</span>

	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>

	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dsi_force_tx_stop_mode_io</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="cm">/* start the DDR clock by sending a NULL packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">ddr_clk_always_on</span> <span class="o">&amp;&amp;</span> <span class="n">enable</span><span class="p">)</span>
		<span class="n">dsi_vc_send_null</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapdss_dsi_vc_enable_hs</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_vc_flush_long_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_SHORT_PACKET_HEADER</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">b1 %#02x b2 %#02x b3 %#02x b4 %#02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
				<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
				<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
				<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_show_rx_ack_with_err</span><span class="p">(</span><span class="n">u16</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">ACK with ERROR (%#x):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">SoT Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">SoT Sync Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">EoT Sync Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Escape Mode Entry Command Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">LP Transmit Sync Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">HS Receive Timeout Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">False Control Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">(reserved7)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">ECC Error, single-bit (corrected)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">ECC Error, multi-bit (not corrected)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Checksum Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Data type not recognized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Invalid VC ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Invalid Transmission Length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">(reserved14)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">DSI Protocol Violation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dsi_vc_flush_receive_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* RX_FIFO_NOT_EMPTY */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">dt</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_SHORT_PACKET_HEADER</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">rawval %#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">dt</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="n">MIPI_DSI_RX_ACKNOWLEDGE_AND_ERROR_REPORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">err</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">dsi_show_rx_ack_with_err</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="n">MIPI_DSI_RX_DCS_SHORT_READ_RESPONSE_1BYTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">DCS short response, 1 byte: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="n">MIPI_DSI_RX_DCS_SHORT_READ_RESPONSE_2BYTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">DCS short response, 2 byte: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="n">MIPI_DSI_RX_DCS_LONG_READ_RESPONSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">DCS long response, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">dsi_vc_flush_long_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">unknown datatype 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_vc_send_bta</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_write</span> <span class="o">||</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_read</span><span class="p">)</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_vc_send_bta %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dsi_bus_is_locked</span><span class="p">(</span><span class="n">dsidev</span><span class="p">));</span>

	<span class="cm">/* RX_FIFO_NOT_EMPTY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;rx fifo not empty when sending BTA, dumping data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dsi_vc_flush_receive_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="cm">/* BTA_EN */</span>

	<span class="cm">/* flush posted write */</span>
	<span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dsi_vc_send_bta_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">completion</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_register_isr_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dsi_completion_handler</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span> <span class="n">DSI_VC_IRQ_BTA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_register_isr</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">dsi_completion_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
			<span class="n">DSI_IRQ_ERROR_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_send_bta</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to receive BTA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dsi_get_errors</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Error while sending BTA: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">err2:</span>
	<span class="n">dsi_unregister_isr</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">dsi_completion_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
			<span class="n">DSI_IRQ_ERROR_MASK</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">dsi_unregister_isr_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dsi_completion_handler</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span> <span class="n">DSI_VC_IRQ_BTA</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_send_bta_sync</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dsi_vc_write_long_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data_id</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dsi_bus_is_locked</span><span class="p">(</span><span class="n">dsidev</span><span class="p">));</span>

	<span class="n">data_id</span> <span class="o">=</span> <span class="n">data_type</span> <span class="o">|</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">vc_id</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">data_id</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">ecc</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_LONG_PACKET_HEADER</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dsi_vc_write_long_payload</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">b1</span><span class="p">,</span> <span class="n">u8</span> <span class="n">b2</span><span class="p">,</span> <span class="n">u8</span> <span class="n">b3</span><span class="p">,</span> <span class="n">u8</span> <span class="n">b4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">b4</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="n">b3</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">b2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>  <span class="o">|</span> <span class="n">b1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*	DSSDBG(&quot;\twriting %02x, %02x, %02x, %02x (%#010x)\n&quot;,</span>
<span class="cm">			b1, b2, b3, b4, val); */</span>

	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_LONG_PACKET_PAYLOAD</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_vc_send_long</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*u32 val; */</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_write</span><span class="p">)</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_vc_send_long, %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* len + header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;unable to send long packet: packet too long.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi_vc_config_source</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">DSI_VC_SOURCE_L4</span><span class="p">);</span>

	<span class="n">dsi_vc_write_long_header</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ecc</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_write</span><span class="p">)</span>
			<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">sending full packet %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">b1</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">b2</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">b3</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">b4</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dsi_vc_write_long_payload</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_write</span><span class="p">)</span>
			<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">sending remainder bytes %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">b1</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">b2</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">b3</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">b1</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">b2</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">b1</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dsi_vc_write_long_payload</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_vc_send_short</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data_id</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dsi_bus_is_locked</span><span class="p">(</span><span class="n">dsidev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_write</span><span class="p">)</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_vc_send_short(ch%d, dt %#x, b1 %#x, b2 %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">channel</span><span class="p">,</span>
				<span class="n">data_type</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">dsi_vc_config_source</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">DSI_VC_SOURCE_L4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FLD_GET</span><span class="p">(</span><span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">)),</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;ERROR FIFO FULL, aborting transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data_id</span> <span class="o">=</span> <span class="n">data_type</span> <span class="o">|</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">vc_id</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_id</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ecc</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_SHORT_PACKET_HEADER</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">r</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dsi_vc_send_null</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dsi_vc_send_long</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">MIPI_DSI_NULL_PACKET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_send_null</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_vc_write_nosync_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dss_dsi_content_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">DSS_DSI_CONTENT_DCS</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_send_short</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
				<span class="n">MIPI_DSI_GENERIC_SHORT_WRITE_0_PARAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_send_short</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
				<span class="n">type</span> <span class="o">==</span> <span class="n">DSS_DSI_CONTENT_GENERIC</span> <span class="o">?</span>
				<span class="n">MIPI_DSI_GENERIC_SHORT_WRITE_1_PARAM</span> <span class="o">:</span>
				<span class="n">MIPI_DSI_DCS_SHORT_WRITE</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_send_short</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
				<span class="n">type</span> <span class="o">==</span> <span class="n">DSS_DSI_CONTENT_GENERIC</span> <span class="o">?</span>
				<span class="n">MIPI_DSI_GENERIC_SHORT_WRITE_2_PARAM</span> <span class="o">:</span>
				<span class="n">MIPI_DSI_DCS_SHORT_WRITE_PARAM</span><span class="p">,</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_send_long</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
				<span class="n">type</span> <span class="o">==</span> <span class="n">DSS_DSI_CONTENT_GENERIC</span> <span class="o">?</span>
				<span class="n">MIPI_DSI_GENERIC_LONG_WRITE</span> <span class="o">:</span>
				<span class="n">MIPI_DSI_DCS_LONG_WRITE</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dsi_vc_dcs_write_nosync</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dsi_vc_write_nosync_common</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">DSS_DSI_CONTENT_DCS</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_dcs_write_nosync</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dsi_vc_generic_write_nosync</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dsi_vc_write_nosync_common</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">DSS_DSI_CONTENT_GENERIC</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_generic_write_nosync</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_vc_write_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dss_dsi_content_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_write_nosync_common</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_send_bta_sync</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* RX_FIFO_NOT_EMPTY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;rx fifo not empty after write, dumping data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dsi_vc_flush_receive_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;dsi_vc_write_common(ch %d, cmd 0x%02x, len %d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dsi_vc_dcs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dsi_vc_write_common</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">DSS_DSI_CONTENT_DCS</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_dcs_write</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dsi_vc_generic_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dsi_vc_write_common</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">DSS_DSI_CONTENT_GENERIC</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_generic_write</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dsi_vc_dcs_write_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dcs_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dsi_vc_dcs_write</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcs_cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_dcs_write_0</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dsi_vc_generic_write_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dsi_vc_generic_write</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_generic_write_0</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dsi_vc_dcs_write_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dcs_cmd</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcs_cmd</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dsi_vc_dcs_write</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_dcs_write_1</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dsi_vc_generic_write_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dsi_vc_generic_write</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_generic_write_1</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dsi_vc_generic_write_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">param1</span><span class="p">,</span> <span class="n">u8</span> <span class="n">param2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param1</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">param2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dsi_vc_generic_write</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_generic_write_2</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_vc_dcs_send_read_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dcs_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_read</span><span class="p">)</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_vc_dcs_send_read_request(ch%d, dcs_cmd %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">channel</span><span class="p">,</span> <span class="n">dcs_cmd</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_send_short</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">MIPI_DSI_DCS_READ</span><span class="p">,</span> <span class="n">dcs_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;dsi_vc_dcs_send_read_request(ch %d, cmd 0x%02x)&quot;</span>
			<span class="s">&quot; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dcs_cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_vc_generic_send_read_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">reqdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reqlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_read</span><span class="p">)</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_vc_generic_send_read_request(ch %d, reqlen %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">channel</span><span class="p">,</span> <span class="n">reqlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reqlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_type</span> <span class="o">=</span> <span class="n">MIPI_DSI_GENERIC_READ_REQUEST_0_PARAM</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reqlen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_type</span> <span class="o">=</span> <span class="n">MIPI_DSI_GENERIC_READ_REQUEST_1_PARAM</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">reqdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reqlen</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_type</span> <span class="o">=</span> <span class="n">MIPI_DSI_GENERIC_READ_REQUEST_2_PARAM</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">reqdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">reqdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_send_short</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;dsi_vc_generic_send_read_request(ch %d, reqlen %d)&quot;</span>
			<span class="s">&quot; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">reqlen</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_vc_read_rx_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dss_dsi_content_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* RX_FIFO_NOT_EMPTY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;RX fifo empty when trying to read.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_SHORT_PACKET_HEADER</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_read</span><span class="p">)</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">header: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">dt</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="n">MIPI_DSI_RX_ACKNOWLEDGE_AND_ERROR_REPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">err</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">dsi_show_rx_ack_with_err</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">DSS_DSI_CONTENT_GENERIC</span> <span class="o">?</span>
			<span class="n">MIPI_DSI_RX_GENERIC_SHORT_READ_RESPONSE_1BYTE</span> <span class="o">:</span>
			<span class="n">MIPI_DSI_RX_DCS_SHORT_READ_RESPONSE_1BYTE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">data</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_read</span><span class="p">)</span>
			<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">%s short response, 1 byte: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">type</span> <span class="o">==</span> <span class="n">DSS_DSI_CONTENT_GENERIC</span> <span class="o">?</span> <span class="s">&quot;GENERIC&quot;</span> <span class="o">:</span>
				<span class="s">&quot;DCS&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">DSS_DSI_CONTENT_GENERIC</span> <span class="o">?</span>
			<span class="n">MIPI_DSI_RX_GENERIC_SHORT_READ_RESPONSE_2BYTE</span> <span class="o">:</span>
			<span class="n">MIPI_DSI_RX_DCS_SHORT_READ_RESPONSE_2BYTE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_read</span><span class="p">)</span>
			<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">%s short response, 2 byte: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">type</span> <span class="o">==</span> <span class="n">DSS_DSI_CONTENT_GENERIC</span> <span class="o">?</span> <span class="s">&quot;GENERIC&quot;</span> <span class="o">:</span>
				<span class="s">&quot;DCS&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">DSS_DSI_CONTENT_GENERIC</span> <span class="o">?</span>
			<span class="n">MIPI_DSI_RX_GENERIC_LONG_READ_RESPONSE</span> <span class="o">:</span>
			<span class="n">MIPI_DSI_RX_DCS_LONG_READ_RESPONSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">w</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_read</span><span class="p">)</span>
			<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">%s long response, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">type</span> <span class="o">==</span> <span class="n">DSS_DSI_CONTENT_GENERIC</span> <span class="o">?</span> <span class="s">&quot;GENERIC&quot;</span> <span class="o">:</span>
				<span class="s">&quot;DCS&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* two byte checksum ends the packet, not included in len */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span>
				<span class="n">DSI_VC_SHORT_PACKET_HEADER</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">debug_read</span><span class="p">)</span>
				<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">%02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
						<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
						<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
						<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="cm">/* we discard the 2 byte checksum */</span>
				<span class="o">++</span><span class="n">w</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">unknown datatype 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dt</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;dsi_vc_read_rx_fifo(ch %d type %s) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">type</span> <span class="o">==</span> <span class="n">DSS_DSI_CONTENT_GENERIC</span> <span class="o">?</span> <span class="s">&quot;GENERIC&quot;</span> <span class="o">:</span> <span class="s">&quot;DCS&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dsi_vc_dcs_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dcs_cmd</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_dcs_send_read_request</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dcs_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_send_bta_sync</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_read_rx_fifo</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span>
		<span class="n">DSS_DSI_CONTENT_DCS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;dsi_vc_dcs_read(ch %d, cmd 0x%02x) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dcs_cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_dcs_read</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_vc_generic_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">reqdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reqlen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_generic_send_read_request</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">reqdata</span><span class="p">,</span> <span class="n">reqlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_send_bta_sync</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_read_rx_fifo</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span>
		<span class="n">DSS_DSI_CONTENT_GENERIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dsi_vc_generic_read_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_generic_read</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;dsi_vc_generic_read_0(ch %d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_generic_read_0</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dsi_vc_generic_read_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">param</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_generic_read</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;dsi_vc_generic_read_1(ch %d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_generic_read_1</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dsi_vc_generic_read_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">param1</span><span class="p">,</span> <span class="n">u8</span> <span class="n">param2</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reqdata</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">reqdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param1</span><span class="p">;</span>
	<span class="n">reqdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">param2</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_vc_generic_read</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">reqdata</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;dsi_vc_generic_read_2(ch %d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_generic_read_2</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dsi_vc_set_max_rx_packet_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dsi_vc_send_short</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
			<span class="n">MIPI_DSI_SET_MAXIMUM_RETURN_PACKET_SIZE</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_vc_set_max_rx_packet_size</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_enter_ulps</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">completion</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">DSSDBGF</span><span class="p">();</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dsi_bus_is_locked</span><span class="p">(</span><span class="n">dsidev</span><span class="p">));</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">ulps_enabled</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">ulps_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* DDR_CLK_ALWAYS_ON */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dsi_sync_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_sync_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dsi_sync_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dsi_sync_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">dsi_force_tx_stop_mode_io</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* HS_BUSY */</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;HS busy when enabling ULPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG2</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* LP_BUSY */</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;LP busy when enabling ULPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_register_isr_cio</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">dsi_completion_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
			<span class="n">DSI_CIO_IRQ_ULPSACTIVENOT_ALL0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span> <span class="o">==</span> <span class="n">DSI_LANE_UNUSED</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Assert TxRequestEsc for data lanes and TxUlpsClk for clk lane */</span>
	<span class="cm">/* LANEx_ULPS_SIG2 */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG2</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* flush posted write and wait for SCP interface to finish the write */</span>
	<span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;ULPS enable timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi_unregister_isr_cio</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">dsi_completion_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
			<span class="n">DSI_CIO_IRQ_ULPSACTIVENOT_ALL0</span><span class="p">);</span>

	<span class="cm">/* Reset LANEx_ULPS_SIG2 */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* flush posted write and wait for SCP interface to finish the write */</span>
	<span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_CFG2</span><span class="p">);</span>

	<span class="n">dsi_cio_power</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_COMPLEXIO_POWER_ULPS</span><span class="p">);</span>

	<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">ulps_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">dsi_unregister_isr_cio</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">dsi_completion_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completion</span><span class="p">,</span>
			<span class="n">DSI_CIO_IRQ_ULPSACTIVENOT_ALL0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_set_lp_rx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">bool</span> <span class="n">x4</span><span class="p">,</span> <span class="n">bool</span> <span class="n">x16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fck</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_ticks</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ticks</span> <span class="o">&gt;</span> <span class="mh">0x1fff</span><span class="p">);</span>

	<span class="cm">/* ticks in DSI_FCK */</span>
	<span class="n">fck</span> <span class="o">=</span> <span class="n">dsi_fclk_rate</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING2</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>	<span class="cm">/* LP_RX_TO */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x16</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>	<span class="cm">/* LP_RX_TO_X16 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x4</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>	<span class="cm">/* LP_RX_TO_X4 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LP_RX_COUNTER */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING2</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">total_ticks</span> <span class="o">=</span> <span class="n">ticks</span> <span class="o">*</span> <span class="p">(</span><span class="n">x16</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x4</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;LP_RX_TO %lu ticks (%#x%s%s) = %lu ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">total_ticks</span><span class="p">,</span>
			<span class="n">ticks</span><span class="p">,</span> <span class="n">x4</span> <span class="o">?</span> <span class="s">&quot; x4&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">x16</span> <span class="o">?</span> <span class="s">&quot; x16&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">total_ticks</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fck</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_set_ta_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ticks</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">x8</span><span class="p">,</span> <span class="n">bool</span> <span class="n">x16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fck</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_ticks</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ticks</span> <span class="o">&gt;</span> <span class="mh">0x1fff</span><span class="p">);</span>

	<span class="cm">/* ticks in DSI_FCK */</span>
	<span class="n">fck</span> <span class="o">=</span> <span class="n">dsi_fclk_rate</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>	<span class="cm">/* TA_TO */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x16</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>	<span class="cm">/* TA_TO_X16 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x8</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>	<span class="cm">/* TA_TO_X8 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* TA_TO_COUNTER */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING1</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">total_ticks</span> <span class="o">=</span> <span class="n">ticks</span> <span class="o">*</span> <span class="p">(</span><span class="n">x16</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x8</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;TA_TO %lu ticks (%#x%s%s) = %lu ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">total_ticks</span><span class="p">,</span>
			<span class="n">ticks</span><span class="p">,</span> <span class="n">x8</span> <span class="o">?</span> <span class="s">&quot; x8&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">x16</span> <span class="o">?</span> <span class="s">&quot; x16&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">total_ticks</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fck</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_set_stop_state_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">bool</span> <span class="n">x4</span><span class="p">,</span> <span class="n">bool</span> <span class="n">x16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fck</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_ticks</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ticks</span> <span class="o">&gt;</span> <span class="mh">0x1fff</span><span class="p">);</span>

	<span class="cm">/* ticks in DSI_FCK */</span>
	<span class="n">fck</span> <span class="o">=</span> <span class="n">dsi_fclk_rate</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING1</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>	<span class="cm">/* FORCE_TX_STOP_MODE_IO */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x16</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>	<span class="cm">/* STOP_STATE_X16_IO */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x4</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>	<span class="cm">/* STOP_STATE_X4_IO */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* STOP_STATE_COUNTER_IO */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING1</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">total_ticks</span> <span class="o">=</span> <span class="n">ticks</span> <span class="o">*</span> <span class="p">(</span><span class="n">x16</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x4</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;STOP_STATE_COUNTER %lu ticks (%#x%s%s) = %lu ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">total_ticks</span><span class="p">,</span>
			<span class="n">ticks</span><span class="p">,</span> <span class="n">x4</span> <span class="o">?</span> <span class="s">&quot; x4&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">x16</span> <span class="o">?</span> <span class="s">&quot; x16&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">total_ticks</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fck</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_set_hs_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">bool</span> <span class="n">x4</span><span class="p">,</span> <span class="n">bool</span> <span class="n">x16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fck</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_ticks</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ticks</span> <span class="o">&gt;</span> <span class="mh">0x1fff</span><span class="p">);</span>

	<span class="cm">/* ticks in TxByteClkHS */</span>
	<span class="n">fck</span> <span class="o">=</span> <span class="n">dsi_get_txbyteclkhs</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING2</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>	<span class="cm">/* HS_TX_TO */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x16</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>	<span class="cm">/* HS_TX_TO_X16 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x4</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>	<span class="cm">/* HS_TX_TO_X8 (4 really) */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* HS_TX_TO_COUNTER */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING2</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">total_ticks</span> <span class="o">=</span> <span class="n">ticks</span> <span class="o">*</span> <span class="p">(</span><span class="n">x16</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x4</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;HS_TX_TO %lu ticks (%#x%s%s) = %lu ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">total_ticks</span><span class="p">,</span>
			<span class="n">ticks</span><span class="p">,</span> <span class="n">x4</span> <span class="o">?</span> <span class="s">&quot; x4&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">x16</span> <span class="o">?</span> <span class="s">&quot; x16&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">total_ticks</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fck</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_config_vp_num_line_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">num_line_buffers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_DSI_VIDEO_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">dsi_get_pixel_size</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_pix_fmt</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="n">line_buf_size</span> <span class="o">=</span> <span class="n">dsi_get_line_buf_size</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t use line buffers if width is greater than the video</span>
<span class="cm">		 * port&#39;s line buffer size</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line_buf_size</span> <span class="o">&lt;=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">num_line_buffers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">num_line_buffers</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Use maximum number of line buffers in command mode */</span>
		<span class="n">num_line_buffers</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* LINE_BUFFER */</span>
	<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CTRL</span><span class="p">,</span> <span class="n">num_line_buffers</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_config_vp_sync_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">de_pol</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">vp_de_pol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hsync_pol</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">vp_hsync_pol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vsync_pol</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">vp_vsync_pol</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vsync_end</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">vp_vsync_end</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hsync_end</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">vp_hsync_end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CTRL</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">de_pol</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>		<span class="cm">/* VP_DE_POL */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hsync_pol</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>	<span class="cm">/* VP_HSYNC_POL */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">vsync_pol</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>	<span class="cm">/* VP_VSYNC_POL */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>		<span class="cm">/* VP_VSYNC_START */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">vsync_end</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* VP_VSYNC_END */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>		<span class="cm">/* VP_HSYNC_START */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hsync_end</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>	<span class="cm">/* VP_HSYNC_END */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CTRL</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_config_blanking_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">blanking_mode</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">blanking_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hfp_blanking_mode</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">hfp_blanking_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hbp_blanking_mode</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">hbp_blanking_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hsa_blanking_mode</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">hsa_blanking_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 0 = TX FIFO packets sent or LPS in corresponding blanking periods</span>
<span class="cm">	 * 1 = Long blanking packets are sent in corresponding blanking periods</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CTRL</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">blanking_mode</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>		<span class="cm">/* BLANKING_MODE */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hfp_blanking_mode</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>	<span class="cm">/* HFP_BLANKING */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hbp_blanking_mode</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">);</span>	<span class="cm">/* HBP_BLANKING */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hsa_blanking_mode</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">);</span>	<span class="cm">/* HSA_BLANKING */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CTRL</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * According to section &#39;HS Command Mode Interleaving&#39; in OMAP TRM, Scenario 3</span>
<span class="cm"> * results in maximum transition time for data and clock lanes to enter and</span>
<span class="cm"> * exit HS mode. Hence, this is the scenario where the least amount of command</span>
<span class="cm"> * mode data can be interleaved. We program the minimum amount of TXBYTECLKHS</span>
<span class="cm"> * clock cycles that can be used to interleave command mode data in HS so that</span>
<span class="cm"> * all scenarios are satisfied.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_compute_interleave_hs</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ddr_alwon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enter_hs</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">exit_hs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exiths_clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ddr_pre</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ddr_post</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">transition</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If DDR_CLK_ALWAYS_ON is set, we need to consider HS mode transition</span>
<span class="cm">	 * time of data lanes only, if it isn&#39;t set, we need to consider HS</span>
<span class="cm">	 * transition time of both data and clock lanes. HS transition time</span>
<span class="cm">	 * of Scenario 3 is considered.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ddr_alwon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">transition</span> <span class="o">=</span> <span class="n">enter_hs</span> <span class="o">+</span> <span class="n">exit_hs</span> <span class="o">+</span> <span class="n">max</span><span class="p">(</span><span class="n">enter_hs</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">trans1</span><span class="p">,</span> <span class="n">trans2</span><span class="p">;</span>
		<span class="n">trans1</span> <span class="o">=</span> <span class="n">ddr_pre</span> <span class="o">+</span> <span class="n">enter_hs</span> <span class="o">+</span> <span class="n">exit_hs</span> <span class="o">+</span> <span class="n">max</span><span class="p">(</span><span class="n">enter_hs</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">trans2</span> <span class="o">=</span> <span class="n">ddr_pre</span> <span class="o">+</span> <span class="n">enter_hs</span> <span class="o">+</span> <span class="n">exiths_clk</span> <span class="o">+</span> <span class="n">ddr_post</span> <span class="o">+</span> <span class="n">ddr_pre</span> <span class="o">+</span>
				<span class="n">enter_hs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">transition</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">trans1</span><span class="p">,</span> <span class="n">trans2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">blank</span> <span class="o">&gt;</span> <span class="n">transition</span> <span class="o">?</span> <span class="n">blank</span> <span class="o">-</span> <span class="n">transition</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * According to section &#39;LP Command Mode Interleaving&#39; in OMAP TRM, Scenario 1</span>
<span class="cm"> * results in maximum transition time for data lanes to enter and exit LP mode.</span>
<span class="cm"> * Hence, this is the scenario where the least amount of command mode data can</span>
<span class="cm"> * be interleaved. We program the minimum amount of bytes that can be</span>
<span class="cm"> * interleaved in LP so that all scenarios are satisfied.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_compute_interleave_lp</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enter_hs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exit_hs</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">lp_clk_div</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tdsi_fclk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">trans_lp</span><span class="p">;</span>	<span class="cm">/* time required for a LP transition, in TXBYTECLKHS */</span>
	<span class="kt">int</span> <span class="n">tlp_avail</span><span class="p">;</span>	<span class="cm">/* time left for interleaving commands, in CLKIN4DDR */</span>
	<span class="kt">int</span> <span class="n">ttxclkesc</span><span class="p">;</span>	<span class="cm">/* period of LP transmit escape clock, in CLKIN4DDR */</span>
	<span class="kt">int</span> <span class="n">thsbyte_clk</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* Period of TXBYTECLKHS clock, in CLKIN4DDR */</span>
	<span class="kt">int</span> <span class="n">lp_inter</span><span class="p">;</span>	<span class="cm">/* cmd mode data that can be interleaved, in bytes */</span>

	<span class="cm">/* maximum LP transition time according to Scenario 1 */</span>
	<span class="n">trans_lp</span> <span class="o">=</span> <span class="n">exit_hs</span> <span class="o">+</span> <span class="n">max</span><span class="p">(</span><span class="n">enter_hs</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* CLKIN4DDR = 16 * TXBYTECLKHS */</span>
	<span class="n">tlp_avail</span> <span class="o">=</span> <span class="n">thsbyte_clk</span> <span class="o">*</span> <span class="p">(</span><span class="n">blank</span> <span class="o">-</span> <span class="n">trans_lp</span><span class="p">);</span>

	<span class="n">ttxclkesc</span> <span class="o">=</span> <span class="n">tdsi_fclk</span> <span class="o">*</span> <span class="n">lp_clk_div</span><span class="p">;</span>

	<span class="n">lp_inter</span> <span class="o">=</span> <span class="p">((</span><span class="n">tlp_avail</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">thsbyte_clk</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">tdsi_fclk</span><span class="p">)</span> <span class="o">/</span> <span class="n">ttxclkesc</span> <span class="o">-</span>
			<span class="mi">26</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">max</span><span class="p">(</span><span class="n">lp_inter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_config_cmd_mode_interleaving</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">blanking_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hfp_blanking_mode</span><span class="p">,</span> <span class="n">hbp_blanking_mode</span><span class="p">,</span> <span class="n">hsa_blanking_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hsa</span><span class="p">,</span> <span class="n">hfp</span><span class="p">,</span> <span class="n">hbp</span><span class="p">,</span> <span class="n">width_bytes</span><span class="p">,</span> <span class="n">bllp</span><span class="p">,</span> <span class="n">lp_clk_div</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ddr_clk_pre</span><span class="p">,</span> <span class="n">ddr_clk_post</span><span class="p">,</span> <span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="n">exit_hs_mode_lat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tclk_trail</span><span class="p">,</span> <span class="n">ths_exit</span><span class="p">,</span> <span class="n">exiths_clk</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ddr_alwon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">dsi_get_pixel_size</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_pix_fmt</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ndl</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_used</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dsi_fclk_hsdiv</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dsi</span><span class="p">.</span><span class="n">regm_dsi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hsa_interleave_hs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hsa_interleave_lp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hfp_interleave_hs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hfp_interleave_lp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hbp_interleave_hs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hbp_interleave_lp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bl_interleave_hs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bl_interleave_lp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CTRL</span><span class="p">);</span>
	<span class="n">blanking_mode</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">hfp_blanking_mode</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>
	<span class="n">hbp_blanking_mode</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">);</span>
	<span class="n">hsa_blanking_mode</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING1</span><span class="p">);</span>
	<span class="n">hbp</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hfp</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">hsa</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_TIMING</span><span class="p">);</span>
	<span class="n">ddr_clk_post</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ddr_clk_pre</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING7</span><span class="p">);</span>
	<span class="n">exit_hs_mode_lat</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">enter_hs_mode_lat</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_CTRL</span><span class="p">);</span>
	<span class="n">lp_clk_div</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ddr_alwon</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG0</span><span class="p">);</span>
	<span class="n">ths_exit</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG1</span><span class="p">);</span>
	<span class="n">tclk_trail</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">exiths_clk</span> <span class="o">=</span> <span class="n">ths_exit</span> <span class="o">+</span> <span class="n">tclk_trail</span><span class="p">;</span>

	<span class="n">width_bytes</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">bllp</span> <span class="o">=</span> <span class="n">hbp</span> <span class="o">+</span> <span class="n">hfp</span> <span class="o">+</span> <span class="n">hsa</span> <span class="o">+</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">width_bytes</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ndl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsa_blanking_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hsa_interleave_hs</span> <span class="o">=</span> <span class="n">dsi_compute_interleave_hs</span><span class="p">(</span><span class="n">hsa</span><span class="p">,</span> <span class="n">ddr_alwon</span><span class="p">,</span>
					<span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="n">exit_hs_mode_lat</span><span class="p">,</span>
					<span class="n">exiths_clk</span><span class="p">,</span> <span class="n">ddr_clk_pre</span><span class="p">,</span> <span class="n">ddr_clk_post</span><span class="p">);</span>
		<span class="n">hsa_interleave_lp</span> <span class="o">=</span> <span class="n">dsi_compute_interleave_lp</span><span class="p">(</span><span class="n">hsa</span><span class="p">,</span>
					<span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="n">exit_hs_mode_lat</span><span class="p">,</span>
					<span class="n">lp_clk_div</span><span class="p">,</span> <span class="n">dsi_fclk_hsdiv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hfp_blanking_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hfp_interleave_hs</span> <span class="o">=</span> <span class="n">dsi_compute_interleave_hs</span><span class="p">(</span><span class="n">hfp</span><span class="p">,</span> <span class="n">ddr_alwon</span><span class="p">,</span>
					<span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="n">exit_hs_mode_lat</span><span class="p">,</span>
					<span class="n">exiths_clk</span><span class="p">,</span> <span class="n">ddr_clk_pre</span><span class="p">,</span> <span class="n">ddr_clk_post</span><span class="p">);</span>
		<span class="n">hfp_interleave_lp</span> <span class="o">=</span> <span class="n">dsi_compute_interleave_lp</span><span class="p">(</span><span class="n">hfp</span><span class="p">,</span>
					<span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="n">exit_hs_mode_lat</span><span class="p">,</span>
					<span class="n">lp_clk_div</span><span class="p">,</span> <span class="n">dsi_fclk_hsdiv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hbp_blanking_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hbp_interleave_hs</span> <span class="o">=</span> <span class="n">dsi_compute_interleave_hs</span><span class="p">(</span><span class="n">hbp</span><span class="p">,</span> <span class="n">ddr_alwon</span><span class="p">,</span>
					<span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="n">exit_hs_mode_lat</span><span class="p">,</span>
					<span class="n">exiths_clk</span><span class="p">,</span> <span class="n">ddr_clk_pre</span><span class="p">,</span> <span class="n">ddr_clk_post</span><span class="p">);</span>

		<span class="n">hbp_interleave_lp</span> <span class="o">=</span> <span class="n">dsi_compute_interleave_lp</span><span class="p">(</span><span class="n">hbp</span><span class="p">,</span>
					<span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="n">exit_hs_mode_lat</span><span class="p">,</span>
					<span class="n">lp_clk_div</span><span class="p">,</span> <span class="n">dsi_fclk_hsdiv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blanking_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bl_interleave_hs</span> <span class="o">=</span> <span class="n">dsi_compute_interleave_hs</span><span class="p">(</span><span class="n">bllp</span><span class="p">,</span> <span class="n">ddr_alwon</span><span class="p">,</span>
					<span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="n">exit_hs_mode_lat</span><span class="p">,</span>
					<span class="n">exiths_clk</span><span class="p">,</span> <span class="n">ddr_clk_pre</span><span class="p">,</span> <span class="n">ddr_clk_post</span><span class="p">);</span>

		<span class="n">bl_interleave_lp</span> <span class="o">=</span> <span class="n">dsi_compute_interleave_lp</span><span class="p">(</span><span class="n">bllp</span><span class="p">,</span>
					<span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="n">exit_hs_mode_lat</span><span class="p">,</span>
					<span class="n">lp_clk_div</span><span class="p">,</span> <span class="n">dsi_fclk_hsdiv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;DSI HS interleaving(TXBYTECLKHS) HSA %d, HFP %d, HBP %d, BLLP %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hsa_interleave_hs</span><span class="p">,</span> <span class="n">hfp_interleave_hs</span><span class="p">,</span> <span class="n">hbp_interleave_hs</span><span class="p">,</span>
		<span class="n">bl_interleave_hs</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;DSI LP interleaving(bytes) HSA %d, HFP %d, HBP %d, BLLP %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hsa_interleave_lp</span><span class="p">,</span> <span class="n">hfp_interleave_lp</span><span class="p">,</span> <span class="n">hbp_interleave_lp</span><span class="p">,</span>
		<span class="n">bl_interleave_lp</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING4</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hsa_interleave_hs</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hfp_interleave_hs</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hbp_interleave_hs</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING4</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING5</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hsa_interleave_lp</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hfp_interleave_lp</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hbp_interleave_lp</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING5</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING6</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bl_interleave_hs</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bl_interleave_lp</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING6</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_proto_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buswidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dsi_config_tx_fifo</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_FIFO_SIZE_32</span><span class="p">,</span>
			<span class="n">DSI_FIFO_SIZE_32</span><span class="p">,</span>
			<span class="n">DSI_FIFO_SIZE_32</span><span class="p">,</span>
			<span class="n">DSI_FIFO_SIZE_32</span><span class="p">);</span>

	<span class="n">dsi_config_rx_fifo</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_FIFO_SIZE_32</span><span class="p">,</span>
			<span class="n">DSI_FIFO_SIZE_32</span><span class="p">,</span>
			<span class="n">DSI_FIFO_SIZE_32</span><span class="p">,</span>
			<span class="n">DSI_FIFO_SIZE_32</span><span class="p">);</span>

	<span class="cm">/* XXX what values for the timeouts? */</span>
	<span class="n">dsi_set_stop_state_counter</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">dsi_set_ta_timeout</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mh">0x1fff</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">dsi_set_lp_rx_timeout</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mh">0x1fff</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">dsi_set_hs_tx_timeout</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mh">0x1fff</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dsi_get_pixel_size</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_pix_fmt</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">buswidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">18</span>:
		<span class="n">buswidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">buswidth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CTRL</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* CS_RX_EN */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* ECC_RX_EN */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* TX_FIFO_ARBITRATION */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* VP_CLK_RATIO, always 1, see errata*/</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">buswidth</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="cm">/* VP_DATA_BUS_WIDTH */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* VP_CLK_POL */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>	<span class="cm">/* TRIGGER_RESET_MODE */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>	<span class="cm">/* EOT_ENABLE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_DSI_DCS_CMD_CONFIG_VC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>	<span class="cm">/* DCS_CMD_ENABLE */</span>
		<span class="cm">/* DCS_CMD_CODE, 1=start, 0=continue */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CTRL</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">dsi_config_vp_num_line_buffers</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_DSI_VIDEO_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsi_config_vp_sync_events</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
		<span class="n">dsi_config_blanking_modes</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
		<span class="n">dsi_config_cmd_mode_interleaving</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dsi_vc_initial_config</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_vc_initial_config</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dsi_vc_initial_config</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dsi_vc_initial_config</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_proto_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">tlpx</span><span class="p">,</span> <span class="n">tclk_zero</span><span class="p">,</span> <span class="n">tclk_prepare</span><span class="p">,</span> <span class="n">tclk_trail</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">tclk_pre</span><span class="p">,</span> <span class="n">tclk_post</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ths_prepare</span><span class="p">,</span> <span class="n">ths_prepare_ths_zero</span><span class="p">,</span> <span class="n">ths_zero</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ths_trail</span><span class="p">,</span> <span class="n">ths_exit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ddr_clk_pre</span><span class="p">,</span> <span class="n">ddr_clk_post</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="n">exit_hs_mode_lat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ths_eot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ndl</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_used</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG0</span><span class="p">);</span>
	<span class="n">ths_prepare</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">ths_prepare_ths_zero</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ths_zero</span> <span class="o">=</span> <span class="n">ths_prepare_ths_zero</span> <span class="o">-</span> <span class="n">ths_prepare</span><span class="p">;</span>
	<span class="n">ths_trail</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ths_exit</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG1</span><span class="p">);</span>
	<span class="n">tlpx</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">tclk_trail</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">tclk_zero</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_DSIPHY_CFG2</span><span class="p">);</span>
	<span class="n">tclk_prepare</span> <span class="o">=</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* min 8*UI */</span>
	<span class="n">tclk_pre</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="cm">/* min 60ns + 52*UI */</span>
	<span class="n">tclk_post</span> <span class="o">=</span> <span class="n">ns2ddr</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="mi">26</span><span class="p">;</span>

	<span class="n">ths_eot</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">ndl</span><span class="p">);</span>

	<span class="n">ddr_clk_pre</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">tclk_pre</span> <span class="o">+</span> <span class="n">tlpx</span> <span class="o">+</span> <span class="n">tclk_zero</span> <span class="o">+</span> <span class="n">tclk_prepare</span><span class="p">,</span>
			<span class="mi">4</span><span class="p">);</span>
	<span class="n">ddr_clk_post</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">tclk_post</span> <span class="o">+</span> <span class="n">ths_trail</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">ths_eot</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ddr_clk_pre</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ddr_clk_pre</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ddr_clk_post</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ddr_clk_post</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_TIMING</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ddr_clk_pre</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ddr_clk_post</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_CLK_TIMING</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;ddr_clk_pre %u, ddr_clk_post %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ddr_clk_pre</span><span class="p">,</span>
			<span class="n">ddr_clk_post</span><span class="p">);</span>

	<span class="n">enter_hs_mode_lat</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">tlpx</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">ths_prepare</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">ths_zero</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">exit_hs_mode_lat</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">ths_trail</span> <span class="o">+</span> <span class="n">ths_exit</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ths_eot</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">exit_hs_mode_lat</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING7</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;enter_hs_mode_lat %u, exit_hs_mode_lat %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">enter_hs_mode_lat</span><span class="p">,</span> <span class="n">exit_hs_mode_lat</span><span class="p">);</span>

	 <span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_DSI_VIDEO_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: Implement a video mode check_timings function */</span>
		<span class="kt">int</span> <span class="n">hsa</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">hsa</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">hfp</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">hfp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">hbp</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">hbp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">vsa</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">vsa</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">vfp</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">vfp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">vbp</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">vbp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">window_sync</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">window_sync</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">hsync_end</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_vm_data</span><span class="p">.</span><span class="n">vp_hsync_end</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">dsi_get_pixel_size</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_pix_fmt</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">tl</span><span class="p">,</span> <span class="n">t_he</span><span class="p">,</span> <span class="n">width_bytes</span><span class="p">;</span>

		<span class="n">t_he</span> <span class="o">=</span> <span class="n">hsync_end</span> <span class="o">?</span>
			<span class="p">((</span><span class="n">hsa</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ndl</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">ndl</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">width_bytes</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

		<span class="cm">/* TL = t_HS + HSA + t_HE + HFP + ceil((WC + 6) / NDL) + HBP */</span>
		<span class="n">tl</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">ndl</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">hsync_end</span> <span class="o">?</span> <span class="n">hsa</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">t_he</span> <span class="o">+</span> <span class="n">hfp</span> <span class="o">+</span>
			<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">width_bytes</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ndl</span><span class="p">)</span> <span class="o">+</span> <span class="n">hbp</span><span class="p">;</span>

		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;HBP: %d, HFP: %d, HSA: %d, TL: %d TXBYTECLKHS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hbp</span><span class="p">,</span>
			<span class="n">hfp</span><span class="p">,</span> <span class="n">hsync_end</span> <span class="o">?</span> <span class="n">hsa</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tl</span><span class="p">);</span>
		<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;VBP: %d, VFP: %d, VSA: %d, VACT: %d lines</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vbp</span><span class="p">,</span> <span class="n">vfp</span><span class="p">,</span>
			<span class="n">vsa</span><span class="p">,</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING1</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hbp</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* HBP */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hfp</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>	<span class="cm">/* HFP */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">hsync_end</span> <span class="o">?</span> <span class="n">hsa</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>	<span class="cm">/* HSA */</span>
		<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING1</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING2</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">vbp</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* VBP */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">vfp</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* VFP */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">vsa</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* VSA */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">window_sync</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>	<span class="cm">/* WINDOW_SYNC */</span>
		<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING2</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING3</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* VACT */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tl</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>		<span class="cm">/* TL */</span>
		<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VM_TIMING3</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omapdss_dsi_configure_pins</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">omap_dsi_pin_config</span> <span class="o">*</span><span class="n">pin_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">num_pins</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pins</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsi_lane_config</span> <span class="n">lanes</span><span class="p">[</span><span class="n">DSI_MAX_NR_LANES</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">num_lanes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">enum</span> <span class="n">dsi_lane_function</span> <span class="n">functions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">DSI_LANE_CLK</span><span class="p">,</span>
		<span class="n">DSI_LANE_DATA1</span><span class="p">,</span>
		<span class="n">DSI_LANE_DATA2</span><span class="p">,</span>
		<span class="n">DSI_LANE_DATA3</span><span class="p">,</span>
		<span class="n">DSI_LANE_DATA4</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">num_pins</span> <span class="o">=</span> <span class="n">pin_cfg</span><span class="o">-&gt;</span><span class="n">num_pins</span><span class="p">;</span>
	<span class="n">pins</span> <span class="o">=</span> <span class="n">pin_cfg</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_pins</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">num_pins</span> <span class="o">&gt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span> <span class="o">*</span> <span class="mi">2</span>
			<span class="o">||</span> <span class="n">num_pins</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DSI_MAX_NR_LANES</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">lanes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="n">DSI_LANE_UNUSED</span><span class="p">;</span>

	<span class="n">num_lanes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_pins</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">lane</span><span class="p">,</span> <span class="n">pol</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">;</span>

		<span class="n">dx</span> <span class="o">=</span> <span class="n">pins</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dy</span> <span class="o">=</span> <span class="n">pins</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dx</span> <span class="o">&gt;=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dy</span> <span class="o">&gt;=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">!=</span> <span class="n">dx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">pol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">!=</span> <span class="n">dx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">pol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lane</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">lanes</span><span class="p">[</span><span class="n">lane</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="n">functions</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
		<span class="n">lanes</span><span class="p">[</span><span class="n">lane</span><span class="p">].</span><span class="n">polarity</span> <span class="o">=</span> <span class="n">pol</span><span class="p">;</span>
		<span class="n">num_lanes</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">));</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_used</span> <span class="o">=</span> <span class="n">num_lanes</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapdss_dsi_configure_pins</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dsi_enable_video_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">dsi_get_pixel_size</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_pix_fmt</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">data_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">word_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_DSI_VIDEO_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_pix_fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_DSI_FMT_RGB888</span>:
			<span class="n">data_type</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_24</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_DSI_FMT_RGB666</span>:
			<span class="n">data_type</span> <span class="o">=</span> <span class="n">MIPI_DSI_PIXEL_STREAM_3BYTE_18</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_DSI_FMT_RGB666_PACKED</span>:
			<span class="n">data_type</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_18</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DSS_DSI_FMT_RGB565</span>:
			<span class="n">data_type</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">};</span>

		<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* MODE, 1 = video mode */</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">word_count</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">.</span><span class="n">x_res</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">dsi_vc_write_long_header</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span>
				<span class="n">word_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dss_mgr_enable</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_DSI_VIDEO_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_enable_video_output</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">dsi_disable_video_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_DSI_VIDEO_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* MODE, 0 = command mode */</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_CTRL</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dss_mgr_disable</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dsi_disable_video_output</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_update_screen_dispc</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">w</span><span class="p">,</span> <span class="n">u16</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">bytespp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">bytespl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">bytespf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">total_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">packet_payload</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">packet_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">update_channel</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">line_buf_size</span> <span class="o">=</span> <span class="n">dsi_get_line_buf_size</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_update_screen_dispc(%dx%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

	<span class="n">dsi_vc_config_source</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">DSI_VC_SOURCE_VP</span><span class="p">);</span>

	<span class="n">bytespp</span>	<span class="o">=</span> <span class="n">dsi_get_pixel_size</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_pix_fmt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">bytespl</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">bytespp</span><span class="p">;</span>
	<span class="n">bytespf</span> <span class="o">=</span> <span class="n">bytespl</span> <span class="o">*</span> <span class="n">h</span><span class="p">;</span>

	<span class="cm">/* NOTE: packet_payload has to be equal to N * bytespl, where N is</span>
<span class="cm">	 * number of lines in a packet.  See errata about VP_CLK_RATIO */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bytespf</span> <span class="o">&lt;</span> <span class="n">line_buf_size</span><span class="p">)</span>
		<span class="n">packet_payload</span> <span class="o">=</span> <span class="n">bytespf</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">packet_payload</span> <span class="o">=</span> <span class="p">(</span><span class="n">line_buf_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">bytespl</span> <span class="o">*</span> <span class="n">bytespl</span><span class="p">;</span>

	<span class="n">packet_len</span> <span class="o">=</span> <span class="n">packet_payload</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 1 byte for DCS cmd */</span>
	<span class="n">total_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytespf</span> <span class="o">/</span> <span class="n">packet_payload</span><span class="p">)</span> <span class="o">*</span> <span class="n">packet_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bytespf</span> <span class="o">%</span> <span class="n">packet_payload</span><span class="p">)</span>
		<span class="n">total_len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bytespf</span> <span class="o">%</span> <span class="n">packet_payload</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">total_len</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* TE_SIZE */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_TE</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">l</span><span class="p">);</span>

	<span class="n">dsi_vc_write_long_header</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">MIPI_DSI_DCS_LONG_WRITE</span><span class="p">,</span>
		<span class="n">packet_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">te_enabled</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span> <span class="cm">/* TE_EN */</span>
	<span class="k">else</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">FLD_MOD</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span> <span class="cm">/* TE_START */</span>
	<span class="n">dsi_write_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_VC_TE</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">l</span><span class="p">);</span>

	<span class="cm">/* We put SIDLEMODE to no-idle for the duration of the transfer,</span>
<span class="cm">	 * because DSS interrupts are not capable of waking up the CPU and the</span>
<span class="cm">	 * framedone interrupt could be delayed for quite a long time. I think</span>
<span class="cm">	 * the same goes for any DSS interrupts, but for some reason I have not</span>
<span class="cm">	 * seen the problem anywhere else than here.</span>
<span class="cm">	 */</span>
	<span class="n">dispc_disable_sidle</span><span class="p">();</span>

	<span class="n">dsi_perf_mark_start</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">framedone_timeout_work</span><span class="p">,</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dss_mgr_start_update</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">te_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable LP_RX_TO, so that we can receive TE.  Time to wait</span>
<span class="cm">		 * for TE is longer than the timer allows */</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span> <span class="cm">/* LP_RX_TO */</span>

		<span class="n">dsi_vc_send_bta</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

<span class="cp">#ifdef DSI_CATCH_MISSING_TE</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">te_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef DSI_CATCH_MISSING_TE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_te_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;TE not received for 250ms!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_handle_framedone</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="cm">/* SIDLEMODE back to smart-idle */</span>
	<span class="n">dispc_enable_sidle</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">te_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable LP_RX_TO again after the TE */</span>
		<span class="n">REG_FLD_MOD</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_TIMING2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span> <span class="cm">/* LP_RX_TO */</span>
	<span class="p">}</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">framedone_callback</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">framedone_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">dsi_perf_show</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="s">&quot;DISPC&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_framedone_timeout_work_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsi_data</span><span class="p">,</span>
			<span class="n">framedone_timeout_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="cm">/* XXX While extremely unlikely, we could get FRAMEDONE interrupt after</span>
<span class="cm">	 * 250ms which would conflict with this timeout work. What should be</span>
<span class="cm">	 * done is first cancel the transfer on the HW, and then cancel the</span>
<span class="cm">	 * possibly scheduled framedone work. However, cancelling the transfer</span>
<span class="cm">	 * on the HW is buggy, and would probably require resetting the whole</span>
<span class="cm">	 * DSI */</span>

	<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Framedone not received for 250ms!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dsi_handle_framedone</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_framedone_irq_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="cm">/* Note: We get FRAMEDONE when DISPC has finished sending pixels and</span>
<span class="cm">	 * turns itself off. However, DSI still has the pixels in its buffers,</span>
<span class="cm">	 * and is sending the data.</span>
<span class="cm">	 */</span>

	<span class="n">__cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">framedone_timeout_work</span><span class="p">);</span>

	<span class="n">dsi_handle_framedone</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap_dsi_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dh</span><span class="p">;</span>

	<span class="n">dsi_perf_mark_setup</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">update_channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">framedone_callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">framedone_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_resolution</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dh</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">update_bytes</span> <span class="o">=</span> <span class="n">dw</span> <span class="o">*</span> <span class="n">dh</span> <span class="o">*</span>
		<span class="n">dsi_get_pixel_size</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_pix_fmt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">dsi_update_screen_dispc</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dh</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dsi_update</span><span class="p">);</span>

<span class="cm">/* Display funcs */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_display_init_dispc</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_DSI_CMD_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dh</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">irq</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omap_video_timings</span> <span class="n">timings</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">hsw</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">hfp</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">hbp</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">vsw</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">vfp</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">vbp</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">};</span>

		<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_resolution</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dh</span><span class="p">);</span>
		<span class="n">timings</span><span class="p">.</span><span class="n">x_res</span> <span class="o">=</span> <span class="n">dw</span><span class="p">;</span>
		<span class="n">timings</span><span class="p">.</span><span class="n">y_res</span> <span class="o">=</span> <span class="n">dh</span><span class="p">;</span>

		<span class="n">irq</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span> <span class="o">?</span>
			<span class="n">DISPC_IRQ_FRAMEDONE</span> <span class="o">:</span> <span class="n">DISPC_IRQ_FRAMEDONE2</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dispc_register_isr</span><span class="p">(</span><span class="n">dsi_framedone_irq_callback</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dssdev</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get FRAMEDONE irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dispc_mgr_enable_stallmode</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">dispc_mgr_enable_fifohandcheck</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">dss_mgr_set_timings</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timings</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dispc_mgr_enable_stallmode</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">dispc_mgr_enable_fifohandcheck</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">dss_mgr_set_timings</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">timings</span><span class="p">);</span>
	<span class="p">}</span>

		<span class="n">dispc_mgr_set_lcd_display_type</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">OMAP_DSS_LCD_DISPLAY_TFT</span><span class="p">);</span>
		<span class="n">dispc_mgr_set_tft_data_lines</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">dsi_get_pixel_size</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_pix_fmt</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_display_uninit_dispc</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_DSI_CMD_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">irq</span><span class="p">;</span>

		<span class="n">irq</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">OMAP_DSS_CHANNEL_LCD</span> <span class="o">?</span>
			<span class="n">DISPC_IRQ_FRAMEDONE</span> <span class="o">:</span> <span class="n">DISPC_IRQ_FRAMEDONE2</span><span class="p">;</span>

		<span class="n">omap_dispc_unregister_isr</span><span class="p">(</span><span class="n">dsi_framedone_irq_callback</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dssdev</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_configure_dsi_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_clock_info</span> <span class="n">cinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">cinfo</span><span class="p">.</span><span class="n">regn</span>  <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dsi</span><span class="p">.</span><span class="n">regn</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="p">.</span><span class="n">regm</span>  <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dsi</span><span class="p">.</span><span class="n">regm</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="p">.</span><span class="n">regm_dispc</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dsi</span><span class="p">.</span><span class="n">regm_dispc</span><span class="p">;</span>
	<span class="n">cinfo</span><span class="p">.</span><span class="n">regm_dsi</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dsi</span><span class="p">.</span><span class="n">regm_dsi</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_calc_clock_rates</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to calc dsi clocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_pll_set_clock_div</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to set dsi clocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_configure_dispc_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dispc_clock_info</span> <span class="n">dispc_cinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">fck</span><span class="p">;</span>

	<span class="n">fck</span> <span class="o">=</span> <span class="n">dsi_get_pll_hsdiv_dispc_rate</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">dispc_cinfo</span><span class="p">.</span><span class="n">lck_div</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dispc</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lck_div</span><span class="p">;</span>
	<span class="n">dispc_cinfo</span><span class="p">.</span><span class="n">pck_div</span> <span class="o">=</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dispc</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">pck_div</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dispc_calc_clock_rates</span><span class="p">(</span><span class="n">fck</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dispc_cinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to calc dispc clocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dispc_mgr_set_clock_div</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dispc_cinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Failed to set dispc clocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_display_init_dsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_pll_init</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_configure_dsi_clocks</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">dss_select_dispc_clk_source</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dispc</span><span class="p">.</span><span class="n">dispc_fclk_src</span><span class="p">);</span>
	<span class="n">dss_select_dsi_clk_source</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span><span class="p">,</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dsi</span><span class="p">.</span><span class="n">dsi_fclk_src</span><span class="p">);</span>
	<span class="n">dss_select_lcd_clk_source</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">clocks</span><span class="p">.</span><span class="n">dispc</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lcd_clk_src</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;PLL OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_configure_dispc_clocks</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_cio_init</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="n">_dsi_print_reset_status</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">dsi_proto_timings</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="n">dsi_set_lp_clk_divisor</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">_dsi_print_reset_status</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_proto_config</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>

	<span class="cm">/* enable interface */</span>
	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dsi_force_tx_stop_mode_io</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err3:</span>
	<span class="n">dsi_cio_uninit</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
<span class="nl">err2:</span>
	<span class="n">dss_select_dispc_clk_source</span><span class="p">(</span><span class="n">OMAP_DSS_CLK_SRC_FCK</span><span class="p">);</span>
	<span class="n">dss_select_dsi_clk_source</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span><span class="p">,</span> <span class="n">OMAP_DSS_CLK_SRC_FCK</span><span class="p">);</span>
	<span class="n">dss_select_lcd_clk_source</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">OMAP_DSS_CLK_SRC_FCK</span><span class="p">);</span>

<span class="nl">err1:</span>
	<span class="n">dsi_pll_uninit</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_display_uninit_dsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">disconnect_lanes</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enter_ulps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enter_ulps</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">ulps_enabled</span><span class="p">)</span>
		<span class="n">dsi_enter_ulps</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="cm">/* disable interface */</span>
	<span class="n">dsi_if_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_vc_enable</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dss_select_dispc_clk_source</span><span class="p">(</span><span class="n">OMAP_DSS_CLK_SRC_FCK</span><span class="p">);</span>
	<span class="n">dss_select_dsi_clk_source</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span><span class="p">,</span> <span class="n">OMAP_DSS_CLK_SRC_FCK</span><span class="p">);</span>
	<span class="n">dss_select_lcd_clk_source</span><span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">OMAP_DSS_CLK_SRC_FCK</span><span class="p">);</span>
	<span class="n">dsi_cio_uninit</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="n">dsi_pll_uninit</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">disconnect_lanes</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omapdss_dsi_display_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_display_enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dsi_bus_is_locked</span><span class="p">(</span><span class="n">dsidev</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to enable display: no manager</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_start_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dss_start_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;failed to start device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_start_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_runtime_get</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_get_dsi</span><span class="p">;</span>

	<span class="n">dsi_enable_pll_clock</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">_dsi_initialize_irq</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_display_init_dispc</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_init_dispc</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_display_init_dsi</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_init_dsi</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_init_dsi:</span>
	<span class="n">dsi_display_uninit_dispc</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
<span class="nl">err_init_dispc:</span>
	<span class="n">dsi_enable_pll_clock</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_runtime_put</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
<span class="nl">err_get_dsi:</span>
	<span class="n">omap_dss_stop_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
<span class="nl">err_start_dev:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_display_enable FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapdss_dsi_display_enable</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omapdss_dsi_display_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">disconnect_lanes</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enter_ulps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;dsi_display_disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dsi_bus_is_locked</span><span class="p">(</span><span class="n">dsidev</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dsi_sync_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dsi_sync_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dsi_sync_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dsi_sync_vc</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">dsi_display_uninit_dispc</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="n">dsi_display_uninit_dsi</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">disconnect_lanes</span><span class="p">,</span> <span class="n">enter_ulps</span><span class="p">);</span>

	<span class="n">dsi_runtime_put</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="n">dsi_enable_pll_clock</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">omap_dss_stop_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapdss_dsi_display_disable</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">omapdss_dsi_enable_te</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">te_enabled</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapdss_dsi_enable_te</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dsi_init_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">DSSDBG</span><span class="p">(</span><span class="s">&quot;DSI init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">.</span><span class="n">dsi_mode</span> <span class="o">==</span> <span class="n">OMAP_DSS_DSI_CMD_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="n">OMAP_DSS_DISPLAY_CAP_MANUAL_UPDATE</span> <span class="o">|</span>
			<span class="n">OMAP_DSS_DISPLAY_CAP_TEAR_ELIM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">vdds_dsi</span><span class="p">;</span>

		<span class="n">vdds_dsi</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vdds_dsi&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vdds_dsi</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get VDDS_DSI regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">vdds_dsi</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_reg</span> <span class="o">=</span> <span class="n">vdds_dsi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap_dsi_request_vc</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dssdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dssdev</span> <span class="o">=</span> <span class="n">dssdev</span><span class="p">;</span>
			<span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;cannot get VC for display %s&quot;</span><span class="p">,</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dsi_request_vc</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">omap_dsi_set_vc_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vc_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vc_id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;VC ID out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Virtual Channel out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">dssdev</span> <span class="o">!=</span> <span class="n">dssdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;Virtual Channel not allocated to display %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">vc_id</span> <span class="o">=</span> <span class="n">vc_id</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dsi_set_vc_id</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_dsi_release_vc</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span> <span class="o">=</span> <span class="n">dsi_get_dsidev_from_dssdev</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">dssdev</span> <span class="o">==</span> <span class="n">dssdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">dssdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">vc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dsi_release_vc</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">dsi_wait_pll_hsdiv_dispc_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_STATUS</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;%s (%s) not active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dss_get_generic_clk_source_name</span><span class="p">(</span><span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DISPC</span><span class="p">),</span>
			<span class="n">dss_feat_get_clk_source_name</span><span class="p">(</span><span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DISPC</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dsi_wait_pll_hsdiv_dsi_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit_change</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_PLL_STATUS</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;%s (%s) not active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dss_get_generic_clk_source_name</span><span class="p">(</span><span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DSI</span><span class="p">),</span>
			<span class="n">dss_feat_get_clk_source_name</span><span class="p">(</span><span class="n">OMAP_DSS_CLK_SRC_DSI_PLL_HSDIV_DSI</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_calc_clock_param_ranges</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">regn_max</span> <span class="o">=</span> <span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_DSIPLL_REGN</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">regm_max</span> <span class="o">=</span> <span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_DSIPLL_REGM</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">regm_dispc_max</span> <span class="o">=</span>
		<span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_DSIPLL_REGM_DISPC</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">regm_dsi_max</span> <span class="o">=</span> <span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_DSIPLL_REGM_DSI</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">fint_min</span> <span class="o">=</span> <span class="n">dss_feat_get_param_min</span><span class="p">(</span><span class="n">FEAT_PARAM_DSIPLL_FINT</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">fint_max</span> <span class="o">=</span> <span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_DSIPLL_FINT</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lpdiv_max</span> <span class="o">=</span> <span class="n">dss_feat_get_param_max</span><span class="p">(</span><span class="n">FEAT_PARAM_DSIPLL_LPDIV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_get_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fck&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get fck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">dss_clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>

	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sys_clk&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get sys_clk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">dss_clk</span><span class="p">);</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">dss_clk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">sys_clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsi_put_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">dss_clk</span><span class="p">)</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">dss_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">sys_clk</span><span class="p">)</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">sys_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">dsi_probe_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_dss_board_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_dss_device</span> <span class="o">*</span><span class="n">dssdev</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OMAP_DISPLAY_TYPE_DSI</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dsi</span><span class="p">.</span><span class="n">module</span> <span class="o">!=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_init_display</span><span class="p">(</span><span class="n">dssdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;device %s init failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">omap_dss_register_device</span><span class="p">(</span><span class="n">dssdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;device %s register failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dssdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* DSI1 HW IP initialisation */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_dsihw_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">dsi_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span><span class="p">;</span>

	<span class="n">dsi</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dsi</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsi</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span> <span class="o">=</span> <span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dsidev</span><span class="p">;</span>
	<span class="n">dsi_pdev_map</span><span class="p">[</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsidev</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dsi</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">errors_lock</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_COLLECT_IRQ_STATS</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats_lock</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">.</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">bus_lock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">framedone_timeout_work</span><span class="p">,</span>
			<span class="n">dsi_framedone_timeout_work_callback</span><span class="p">);</span>

<span class="cp">#ifdef DSI_CATCH_MISSING_TE</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">te_timer</span><span class="p">);</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">te_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">dsi_te_timeout</span><span class="p">;</span>
	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">te_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">dsi_mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsi_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get IORESOURCE_MEM DSI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dsi_mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				 <span class="n">resource_size</span><span class="p">(</span><span class="n">dsi_mem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;can&#39;t ioremap DSI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;platform_get_irq failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">omap_dsi_irq_handler</span><span class="p">,</span>
			     <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DSSERR</span><span class="p">(</span><span class="s">&quot;request_irq failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DSI VCs initialization */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">source</span> <span class="o">=</span> <span class="n">DSI_VC_SOURCE_L4</span><span class="p">;</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dssdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsi_calc_clock_param_ranges</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_get_clocks</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dsi_runtime_get</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_runtime_get</span><span class="p">;</span>

	<span class="n">rev</span> <span class="o">=</span> <span class="n">dsi_read_reg</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_REVISION</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OMAP DSI rev %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">FLD_GET</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">FLD_GET</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* DSI on OMAP3 doesn&#39;t have register DSI_GNQ, set number</span>
<span class="cm">	 * of data to 3 by default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dss_has_feature</span><span class="p">(</span><span class="n">FEAT_DSI_GNQ</span><span class="p">))</span>
		<span class="cm">/* NB_DATA_LANES */</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">REG_GET</span><span class="p">(</span><span class="n">dsidev</span><span class="p">,</span> <span class="n">DSI_GNQ</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">num_lanes_supported</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">dsi_probe_pdata</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">dsi_runtime_put</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dss_debugfs_create_file</span><span class="p">(</span><span class="s">&quot;dsi1_regs&quot;</span><span class="p">,</span> <span class="n">dsi1_dump_regs</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dss_debugfs_create_file</span><span class="p">(</span><span class="s">&quot;dsi2_regs&quot;</span><span class="p">,</span> <span class="n">dsi2_dump_regs</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_OMAP2_DSS_COLLECT_IRQ_STATS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dss_debugfs_create_file</span><span class="p">(</span><span class="s">&quot;dsi1_irqs&quot;</span><span class="p">,</span> <span class="n">dsi1_dump_irqs</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">module_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dss_debugfs_create_file</span><span class="p">(</span><span class="s">&quot;dsi2_irqs&quot;</span><span class="p">,</span> <span class="n">dsi2_dump_irqs</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_runtime_get:</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dsi_put_clocks</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">omap_dsihw_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dsidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsi_data</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">dsi_get_dsidrv_data</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">scp_clk_refcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">omap_dss_unregister_child_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dsi_put_clocks</span><span class="p">(</span><span class="n">dsidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_reg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regulator_disable</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_reg</span><span class="p">);</span>
			<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">regulator_put</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_reg</span><span class="p">);</span>
		<span class="n">dsi</span><span class="o">-&gt;</span><span class="n">vdds_dsi_reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dispc_runtime_put</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsi_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dispc_runtime_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">dsi_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">runtime_suspend</span> <span class="o">=</span> <span class="n">dsi_runtime_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span> <span class="o">=</span> <span class="n">dsi_runtime_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omap_dsihw_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">omap_dsihw_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>         <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;omapdss_dsi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dsi_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">dsi_init_platform_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dsihw_driver</span><span class="p">,</span> <span class="n">omap_dsihw_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dsi_uninit_platform_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dsihw_driver</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
