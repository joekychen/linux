<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › s3c-fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>s3c-fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* linux/drivers/video/s3c-fb.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2008 Openmoko Inc.</span>
<span class="cm"> * Copyright 2008-2010 Simtec Electronics</span>
<span class="cm"> *      Ben Dooks &lt;ben@simtec.co.uk&gt;</span>
<span class="cm"> *      http://armlinux.simtec.co.uk/</span>
<span class="cm"> *</span>
<span class="cm"> * Samsung SoC Framebuffer driver</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software FoundatIon.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;mach/map.h&gt;</span>
<span class="cp">#include &lt;plat/regs-fb-v4.h&gt;</span>
<span class="cp">#include &lt;plat/fb.h&gt;</span>

<span class="cm">/* This driver will export a number of framebuffer interfaces depending</span>
<span class="cm"> * on the configuration passed in via the platform data. Each fb instance</span>
<span class="cm"> * maps to a hardware window. Currently there is no support for runtime</span>
<span class="cm"> * setting of the alpha-blending functions that each window has, so only</span>
<span class="cm"> * window 0 is actually useful.</span>
<span class="cm"> *</span>
<span class="cm"> * Window 0 is treated specially, it is used for the basis of the LCD</span>
<span class="cm"> * output timings and as the control for the output power-down state.</span>
<span class="cm">*/</span>

<span class="cm">/* note, the previous use of &lt;mach/regs-fb.h&gt; to get platform specific data</span>
<span class="cm"> * has been replaced by using the platform device name to pick the correct</span>
<span class="cm"> * configuration data for the system.</span>
<span class="cm">*/</span>

<span class="cp">#ifdef CONFIG_FB_S3C_DEBUG_REGWRITE</span>
<span class="cp">#undef writel</span>
<span class="cp">#define writel(v, r) do { \</span>
<span class="cp">	pr_debug(&quot;%s: %08x =&gt; %p\n&quot;, __func__, (unsigned int)v, r); \</span>
<span class="cp">	__raw_writel(v, r); \</span>
<span class="cp">} while (0)</span>
<span class="cp">#endif </span><span class="cm">/* FB_S3C_DEBUG_REGWRITE */</span><span class="cp"></span>

<span class="cm">/* irq_flags bits */</span>
<span class="cp">#define S3C_FB_VSYNC_IRQ_EN	0</span>

<span class="cp">#define VSYNC_TIMEOUT_MSEC 50</span>

<span class="k">struct</span> <span class="n">s3c_fb</span><span class="p">;</span>

<span class="cp">#define VALID_BPP(x) (1 &lt;&lt; ((x) - 1))</span>

<span class="cp">#define OSD_BASE(win, variant) ((variant).osd + ((win) * (variant).osd_stride))</span>
<span class="cp">#define VIDOSD_A(win, variant) (OSD_BASE(win, variant) + 0x00)</span>
<span class="cp">#define VIDOSD_B(win, variant) (OSD_BASE(win, variant) + 0x04)</span>
<span class="cp">#define VIDOSD_C(win, variant) (OSD_BASE(win, variant) + 0x08)</span>
<span class="cp">#define VIDOSD_D(win, variant) (OSD_BASE(win, variant) + 0x0C)</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_fb_variant - fb variant information</span>
<span class="cm"> * @is_2443: Set if S3C2443/S3C2416 style hardware.</span>
<span class="cm"> * @nr_windows: The number of windows.</span>
<span class="cm"> * @vidtcon: The base for the VIDTCONx registers</span>
<span class="cm"> * @wincon: The base for the WINxCON registers.</span>
<span class="cm"> * @winmap: The base for the WINxMAP registers.</span>
<span class="cm"> * @keycon: The abse for the WxKEYCON registers.</span>
<span class="cm"> * @buf_start: Offset of buffer start registers.</span>
<span class="cm"> * @buf_size: Offset of buffer size registers.</span>
<span class="cm"> * @buf_end: Offset of buffer end registers.</span>
<span class="cm"> * @osd: The base for the OSD registers.</span>
<span class="cm"> * @palette: Address of palette memory, or 0 if none.</span>
<span class="cm"> * @has_prtcon: Set if has PRTCON register.</span>
<span class="cm"> * @has_shadowcon: Set if has SHADOWCON register.</span>
<span class="cm"> * @has_blendcon: Set if has BLENDCON register.</span>
<span class="cm"> * @has_clksel: Set if VIDCON0 register has CLKSEL bit.</span>
<span class="cm"> * @has_fixvclk: Set if VIDCON1 register has FIXVCLK bits.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_fb_variant</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">is_2443</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">nr_windows</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">vidtcon</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">wincon</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">winmap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">keycon</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">buf_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">buf_end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">buf_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">osd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">osd_stride</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">palette</span><span class="p">[</span><span class="n">S3C_FB_MAX_WIN</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">has_prtcon</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">has_shadowcon</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">has_blendcon</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">has_clksel</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">has_fixvclk</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_fb_win_variant</span>
<span class="cm"> * @has_osd_c: Set if has OSD C register.</span>
<span class="cm"> * @has_osd_d: Set if has OSD D register.</span>
<span class="cm"> * @has_osd_alpha: Set if can change alpha transparency for a window.</span>
<span class="cm"> * @palette_sz: Size of palette in entries.</span>
<span class="cm"> * @palette_16bpp: Set if palette is 16bits wide.</span>
<span class="cm"> * @osd_size_off: If != 0, supports setting up OSD for a window; the appropriate</span>
<span class="cm"> *                register is located at the given offset from OSD_BASE.</span>
<span class="cm"> * @valid_bpp: 1 bit per BPP setting to show valid bits-per-pixel.</span>
<span class="cm"> *</span>
<span class="cm"> * valid_bpp bit x is set if (x+1)BPP is supported.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_fb_win_variant</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">has_osd_c</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">has_osd_d</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">has_osd_alpha</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">palette_16bpp</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">osd_size_off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">palette_sz</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">valid_bpp</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_fb_driverdata - per-device type driver data for init time.</span>
<span class="cm"> * @variant: The variant information for this driver.</span>
<span class="cm"> * @win: The window information for each window.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_fb_driverdata</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb_variant</span>	<span class="n">variant</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win_variant</span> <span class="o">*</span><span class="n">win</span><span class="p">[</span><span class="n">S3C_FB_MAX_WIN</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_fb_palette - palette information</span>
<span class="cm"> * @r: Red bitfield.</span>
<span class="cm"> * @g: Green bitfield.</span>
<span class="cm"> * @b: Blue bitfield.</span>
<span class="cm"> * @a: Alpha bitfield.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_fb_palette</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_bitfield</span>	<span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_bitfield</span>	<span class="n">g</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_bitfield</span>	<span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_bitfield</span>	<span class="n">a</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_fb_win - per window private data for each framebuffer.</span>
<span class="cm"> * @windata: The platform data supplied for the window configuration.</span>
<span class="cm"> * @parent: The hardware that this window is part of.</span>
<span class="cm"> * @fbinfo: Pointer pack to the framebuffer info for this window.</span>
<span class="cm"> * @varint: The variant information for this window.</span>
<span class="cm"> * @palette_buffer: Buffer/cache to hold palette entries.</span>
<span class="cm"> * @pseudo_palette: For use in TRUECOLOUR modes for entries 0..15/</span>
<span class="cm"> * @index: The window number of this window.</span>
<span class="cm"> * @palette: The bitfields for changing r/g/b into a hardware palette entry.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb_pd_win</span>	<span class="o">*</span><span class="n">windata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span>		<span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span>		<span class="o">*</span><span class="n">fbinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_palette</span>	 <span class="n">palette</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win_variant</span> <span class="n">variant</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="o">*</span><span class="n">palette_buffer</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		 <span class="n">index</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_fb_vsync - vsync information</span>
<span class="cm"> * @wait:	a queue for processes waiting for vsync</span>
<span class="cm"> * @count:	vsync interrupt count</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_fb_vsync</span> <span class="p">{</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">wait</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">count</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_fb - overall hardware state of the hardware</span>
<span class="cm"> * @slock: The spinlock protection for this data sturcture.</span>
<span class="cm"> * @dev: The device that we bound to, for printing, etc.</span>
<span class="cm"> * @bus_clk: The clk (hclk) feeding our interface and possibly pixclk.</span>
<span class="cm"> * @lcd_clk: The clk (sclk) feeding pixclk.</span>
<span class="cm"> * @regs: The mapped hardware registers.</span>
<span class="cm"> * @variant: Variant information for this hardware.</span>
<span class="cm"> * @enabled: A bitmask of enabled hardware windows.</span>
<span class="cm"> * @output_on: Flag if the physical output is enabled.</span>
<span class="cm"> * @pdata: The platform configuration data passed with the device.</span>
<span class="cm"> * @windows: The hardware windows that have been claimed.</span>
<span class="cm"> * @irq_no: IRQ line number</span>
<span class="cm"> * @irq_flags: irq flags</span>
<span class="cm"> * @vsync_info: VSYNC-related information (count, queues...)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>		<span class="n">slock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">bus_clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">lcd_clk</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_variant</span>	 <span class="n">variant</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span>		 <span class="n">enabled</span><span class="p">;</span>
	<span class="n">bool</span>			 <span class="n">output_on</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">s3c_fb_platdata</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win</span>	<span class="o">*</span><span class="n">windows</span><span class="p">[</span><span class="n">S3C_FB_MAX_WIN</span><span class="p">];</span>

	<span class="kt">int</span>			 <span class="n">irq_no</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		 <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_vsync</span>	 <span class="n">vsync_info</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_validate_win_bpp - validate the bits-per-pixel for this mode.</span>
<span class="cm"> * @win: The device window.</span>
<span class="cm"> * @bpp: The bit depth.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">s3c_fb_validate_win_bpp</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">valid_bpp</span> <span class="o">&amp;</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="n">bpp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_check_var() - framebuffer layer request to verify a given mode.</span>
<span class="cm"> * @var: The screen information to verify.</span>
<span class="cm"> * @info: The framebuffer device.</span>
<span class="cm"> *</span>
<span class="cm"> * Framebuffer layer call to verify the given information and allow us to</span>
<span class="cm"> * update various information depending on the hardware capabilities.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;checking parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s3c_fb_validate_win_bpp</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;win %d: unsupported bpp %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* always ensure these are zero, for drop through cases below */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">palette</span><span class="p">[</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* non palletised, A:1,R:2,G:3,B:2 mode */</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">19</span>:
		<span class="cm">/* 666 with one bit alpha/transparency */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">18</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

		<span class="cm">/* 666 format */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">16</span>:
		<span class="cm">/* 16 bpp, 565 format */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">32</span>:
	<span class="k">case</span> <span class="mi">28</span>:
	<span class="k">case</span> <span class="mi">25</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">-</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="cm">/* drop through */</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="cm">/* our 24bpp is unpacked, so 32bpp */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid bpp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: verified parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_calc_pixclk() - calculate the divider to create the pixel clock.</span>
<span class="cm"> * @sfb: The hardware state.</span>
<span class="cm"> * @pixclock: The pixel clock wanted, in picoseconds.</span>
<span class="cm"> *</span>
<span class="cm"> * Given the specified pixel clock, work out the necessary divider to get</span>
<span class="cm"> * close to the output frequency.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_calc_pixclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixclk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_clksel</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">clk</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">*=</span> <span class="n">pixclk</span><span class="p">;</span>

	<span class="n">do_div</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">1000000000UL</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">tmp</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pixclk=%u, clk=%lu, div=%d (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pixclk</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">result</span> <span class="o">?</span> <span class="n">clk</span> <span class="o">/</span> <span class="n">result</span> <span class="o">:</span> <span class="n">clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_align_word() - align pixel count to word boundary</span>
<span class="cm"> * @bpp: The number of bits per pixel</span>
<span class="cm"> * @pix: The value to be aligned.</span>
<span class="cm"> *</span>
<span class="cm"> * Align the given pixel count so that it will start on an 32bit word</span>
<span class="cm"> * boundary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_align_word</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pix_per_word</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pix</span><span class="p">;</span>

	<span class="n">pix_per_word</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">32</span><span class="p">)</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">pix_per_word</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidosd_set_size() - set OSD size for a window</span>
<span class="cm"> *</span>
<span class="cm"> * @win: the window to set OSD size for</span>
<span class="cm"> * @size: OSD size register value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vidosd_set_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="cm">/* OSD can be set up if osd_size_off != 0 for this window */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">osd_size_off</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">OSD_BASE</span><span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">osd_size_off</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidosd_set_alpha() - set alpha transparency for a window</span>
<span class="cm"> *</span>
<span class="cm"> * @win: the window to set OSD size for</span>
<span class="cm"> * @alpha: alpha register value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vidosd_set_alpha</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span><span class="p">,</span> <span class="n">u32</span> <span class="n">alpha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_osd_alpha</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDOSD_C</span><span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * shadow_protect_win() - disable updating values from shadow registers at vsync</span>
<span class="cm"> *</span>
<span class="cm"> * @win: window to protect registers for</span>
<span class="cm"> * @protect: 1 to protect (disable updates)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">shadow_protect_win</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span><span class="p">,</span> <span class="n">bool</span> <span class="n">protect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_prtcon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">PRTCON_PROTECT</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PRTCON</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_shadowcon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SHADOWCON</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="n">SHADOWCON_WINx_PROTECT</span><span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span>
				<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SHADOWCON</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_prtcon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">PRTCON</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_shadowcon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SHADOWCON</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SHADOWCON_WINx_PROTECT</span><span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span>
				<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SHADOWCON</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_enable() - Set the state of the main LCD output</span>
<span class="cm"> * @sfb: The main framebuffer state.</span>
<span class="cm"> * @enable: The state to set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_fb_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">vidcon0</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDCON0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">output_on</span><span class="p">)</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vidcon0</span> <span class="o">|=</span> <span class="n">VIDCON0_ENVID</span> <span class="o">|</span> <span class="n">VIDCON0_ENVID_F</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* see the note in the framebuffer datasheet about</span>
<span class="cm">		 * why you cannot take both of these bits down at the</span>
<span class="cm">		 * same time. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vidcon0</span> <span class="o">&amp;</span> <span class="n">VIDCON0_ENVID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vidcon0</span> <span class="o">|=</span> <span class="n">VIDCON0_ENVID</span><span class="p">;</span>
			<span class="n">vidcon0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIDCON0_ENVID_F</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">vidcon0</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDCON0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">output_on</span><span class="p">)</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">output_on</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_set_par() - framebuffer request to set new framebuffer state.</span>
<span class="cm"> * @info: The framebuffer to change.</span>
<span class="cm"> *</span>
<span class="cm"> * Framebuffer layer request to set a new mode for the specified framebuffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">win_no</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pagewidth</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting framebuffer parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32</span>:
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">16</span>:
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">palette_sz</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_MONO01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* disable the window whilst we update it */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">WINCON</span><span class="p">(</span><span class="n">win_no</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">output_on</span><span class="p">)</span>
		<span class="n">s3c_fb_enable</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write the buffer address */</span>

	<span class="cm">/* start and end registers stride is 8 */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">win_no</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">buf_start</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">buf_end</span><span class="p">);</span>

	<span class="n">pagewidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">VIDW_BUF_SIZE_OFFSET</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">-</span> <span class="n">pagewidth</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDW_BUF_SIZE_PAGEWIDTH</span><span class="p">(</span><span class="n">pagewidth</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDW_BUF_SIZE_OFFSET_E</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">-</span> <span class="n">pagewidth</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDW_BUF_SIZE_PAGEWIDTH_E</span><span class="p">(</span><span class="n">pagewidth</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">win_no</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>

	<span class="cm">/* write &#39;OSD&#39; registers to control position of framebuffer */</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">VIDOSDxA_TOPLEFT_X</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">VIDOSDxA_TOPLEFT_Y</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDOSDxA_TOPLEFT_X_E</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">VIDOSDxA_TOPLEFT_Y_E</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">VIDOSD_A</span><span class="p">(</span><span class="n">win_no</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">));</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">VIDOSDxB_BOTRIGHT_X</span><span class="p">(</span><span class="n">s3c_fb_align_word</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span>
						     <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
	       <span class="n">VIDOSDxB_BOTRIGHT_Y</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDOSDxB_BOTRIGHT_X_E</span><span class="p">(</span><span class="n">s3c_fb_align_word</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span>
						     <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
	       <span class="n">VIDOSDxB_BOTRIGHT_Y_E</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">VIDOSD_B</span><span class="p">(</span><span class="n">win_no</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">));</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="n">alpha</span> <span class="o">=</span> <span class="n">VIDISD14C_ALPHA1_R</span><span class="p">(</span><span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">VIDISD14C_ALPHA1_G</span><span class="p">(</span><span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">VIDISD14C_ALPHA1_B</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>

	<span class="n">vidosd_set_alpha</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span>
	<span class="n">vidosd_set_size</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Enable DMA channel for this window */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_shadowcon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SHADOWCON</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">SHADOWCON_CHx_ENABLE</span><span class="p">(</span><span class="n">win_no</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SHADOWCON</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">WINCONx_ENWIN</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/* note, since we have to round up the bits-per-pixel, we end up</span>
<span class="cm">	 * relying on the bitfield information for r/g/b/a to work out</span>
<span class="cm">	 * exactly which mode of operation is intended. */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON0_BPPMODE_1BPP</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_BITSWP</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_BURSTLEN_4WORD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON0_BPPMODE_2BPP</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_BITSWP</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_BURSTLEN_8WORD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON0_BPPMODE_4BPP</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_BITSWP</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_BURSTLEN_8WORD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON1_BPPMODE_8BPP_1232</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON0_BPPMODE_8BPP_PALETTE</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_BURSTLEN_8WORD</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_BYTSWP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON1_BPPMODE_16BPP_A1555</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON0_BPPMODE_16BPP_565</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_HAWSWP</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_BURSTLEN_16WORD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON1_BPPMODE_19BPP_A1666</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON1_BPPMODE_18BPP_666</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON1_BPPMODE_25BPP_A1888</span>
				<span class="o">|</span> <span class="n">WINCON1_BLD_PIX</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON1_BPPMODE_28BPP_A4888</span>
				<span class="o">|</span> <span class="n">WINCON1_BLD_PIX</span> <span class="o">|</span> <span class="n">WINCON1_ALPHA_SEL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCON0_BPPMODE_24BPP_888</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_WSWP</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">WINCONx_BURSTLEN_16WORD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable the colour keying for the window below this one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win_no</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">keycon0_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">keycon1_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">keycon</span> <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">keycon</span><span class="p">;</span>

		<span class="n">keycon0_data</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">WxKEYCON0_KEYBL_EN</span> <span class="o">|</span>
				<span class="n">WxKEYCON0_KEYEN_F</span> <span class="o">|</span>
				<span class="n">WxKEYCON0_DIRCON</span><span class="p">)</span> <span class="o">|</span> <span class="n">WxKEYCON0_COMPKEY</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="n">keycon1_data</span> <span class="o">=</span> <span class="n">WxKEYCON1_COLVAL</span><span class="p">(</span><span class="mh">0xffffff</span><span class="p">);</span>

		<span class="n">keycon</span> <span class="o">+=</span> <span class="p">(</span><span class="n">win_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">keycon0_data</span><span class="p">,</span> <span class="n">keycon</span> <span class="o">+</span> <span class="n">WKEYCON0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">keycon1_data</span><span class="p">,</span> <span class="n">keycon</span> <span class="o">+</span> <span class="n">WKEYCON1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">wincon</span> <span class="o">+</span> <span class="p">(</span><span class="n">win_no</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">winmap</span> <span class="o">+</span> <span class="p">(</span><span class="n">win_no</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>

	<span class="cm">/* Set alpha value width */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_blendcon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">BLENDCON</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BLENDCON_NEW_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">BLENDCON_NEW_8BIT_ALPHA_VALUE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">BLENDCON_NEW_4BIT_ALPHA_VALUE</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">BLENDCON</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_update_palette() - set or schedule a palette update.</span>
<span class="cm"> * @sfb: The hardware information.</span>
<span class="cm"> * @win: The window being updated.</span>
<span class="cm"> * @reg: The palette index being changed.</span>
<span class="cm"> * @value: The computed palette value.</span>
<span class="cm"> *</span>
<span class="cm"> * Change the value of a palette register, either by directly writing to</span>
<span class="cm"> * the palette (this requires the palette RAM to be disconnected from the</span>
<span class="cm"> * hardware whilst this is in progress) or schedule the update for later.</span>
<span class="cm"> *</span>
<span class="cm"> * At the moment, since we have no VSYNC interrupt support, we simply set</span>
<span class="cm"> * the palette entry directly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_fb_update_palette</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">palreg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">palcon</span><span class="p">;</span>

	<span class="n">palreg</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">palette</span><span class="p">[</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: win %d, reg %d (%p): %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">palreg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette_buffer</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">palcon</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">WPALCON</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">palcon</span> <span class="o">|</span> <span class="n">WPALCON_PAL_UPDATE</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">WPALCON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">palette_16bpp</span><span class="p">)</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">palreg</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">palreg</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">palcon</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">WPALCON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">chan_to_field</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">fb_bitfield</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_setcolreg() - framebuffer layer request to change palette.</span>
<span class="cm"> * @regno: The palette index to change.</span>
<span class="cm"> * @red: The red field for the palette data.</span>
<span class="cm"> * @green: The green field for the palette data.</span>
<span class="cm"> * @blue: The blue field for the palette data.</span>
<span class="cm"> * @trans: The transparency (alpha) field for the palette data.</span>
<span class="cm"> * @info: The framebuffer being changed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: win %d: %d =&gt; rgb=%d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
		<span class="cm">/* true-colour, use pseudo-palette */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

			<span class="n">val</span>  <span class="o">=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">red</span><span class="p">,</span>   <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">);</span>

			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">palette_sz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span>  <span class="o">=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">r</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">g</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">b</span><span class="p">);</span>

			<span class="n">s3c_fb_update_palette</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* unknown type */</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_blank() - blank or unblank the given window</span>
<span class="cm"> * @blank_mode: The blank state from FB_BLANK_*</span>
<span class="cm"> * @info: The framebuffer to blank.</span>
<span class="cm"> *</span>
<span class="cm"> * Framebuffer layer request to change the power state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wincon</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">output_on</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">output_on</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;blank mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blank_mode</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wincon</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">wincon</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="n">wincon</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WINCONx_ENWIN</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
		<span class="cm">/* fall through to FB_BLANK_NORMAL */</span>

	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="cm">/* disable the DMA and display 0x0 (black) */</span>
		<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">WINxMAP_MAP</span> <span class="o">|</span> <span class="n">WINxMAP_MAP_COLOUR</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span>
		       <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">winmap</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">winmap</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wincon</span> <span class="o">|=</span> <span class="n">WINCONx_ENWIN</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
	<span class="nl">default:</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">wincon</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">wincon</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>

	<span class="cm">/* Check the enabled state to see if we need to be running the</span>
<span class="cm">	 * main LCD interface, as if there are no active windows then</span>
<span class="cm">	 * it is highly likely that we also do not need to output</span>
<span class="cm">	 * anything.</span>
<span class="cm">	 */</span>
	<span class="n">s3c_fb_enable</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">output_on</span> <span class="o">==</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">output_on</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_pan_display() - Pan the display.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the offsets can be written to the device at any time, as their</span>
<span class="cm"> * values are latched at each vsync automatically. This also means that only</span>
<span class="cm"> * the last call to this function will have any effect on next vsync, but</span>
<span class="cm"> * there is no need to sleep waiting for it to prevent tearing.</span>
<span class="cm"> *</span>
<span class="cm"> * @var: The screen information to verify.</span>
<span class="cm"> * @info: The framebuffer device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span>	<span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_boff</span><span class="p">,</span> <span class="n">end_boff</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Offset in bytes to the start of the displayed area */</span>
	<span class="n">start_boff</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="cm">/* X offset depends on the current bpp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start_boff</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">start_boff</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">start_boff</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">start_boff</span> <span class="o">+=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid bpp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Offset in bytes to the end of the displayed area */</span>
	<span class="n">end_boff</span> <span class="o">=</span> <span class="n">start_boff</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>

	<span class="cm">/* Temporarily turn off per-vsync update from shadow registers until</span>
<span class="cm">	 * both start and end addresses are updated to prevent corruption */</span>
	<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="n">start_boff</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">buf_start</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="n">end_boff</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">buf_end</span><span class="p">);</span>

	<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_enable_irq() - enable framebuffer interrupts</span>
<span class="cm"> * @sfb: main hardware state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_fb_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_ctrl_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">S3C_FB_VSYNC_IRQ_EN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* IRQ disabled, enable it */</span>
		<span class="n">irq_ctrl_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDINTCON0</span><span class="p">);</span>

		<span class="n">irq_ctrl_reg</span> <span class="o">|=</span> <span class="n">VIDINTCON0_INT_ENABLE</span><span class="p">;</span>
		<span class="n">irq_ctrl_reg</span> <span class="o">|=</span> <span class="n">VIDINTCON0_INT_FRAME</span><span class="p">;</span>

		<span class="n">irq_ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIDINTCON0_FRAMESEL0_MASK</span><span class="p">;</span>
		<span class="n">irq_ctrl_reg</span> <span class="o">|=</span> <span class="n">VIDINTCON0_FRAMESEL0_VSYNC</span><span class="p">;</span>
		<span class="n">irq_ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIDINTCON0_FRAMESEL1_MASK</span><span class="p">;</span>
		<span class="n">irq_ctrl_reg</span> <span class="o">|=</span> <span class="n">VIDINTCON0_FRAMESEL1_NONE</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">irq_ctrl_reg</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">VIDINTCON0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_disable_irq() - disable framebuffer interrupts</span>
<span class="cm"> * @sfb: main hardware state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_fb_disable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_ctrl_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">S3C_FB_VSYNC_IRQ_EN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* IRQ enabled, disable it */</span>
		<span class="n">irq_ctrl_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDINTCON0</span><span class="p">);</span>

		<span class="n">irq_ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIDINTCON0_INT_FRAME</span><span class="p">;</span>
		<span class="n">irq_ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIDINTCON0_INT_ENABLE</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">irq_ctrl_reg</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">VIDINTCON0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">s3c_fb_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>  <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_sts_reg</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="n">irq_sts_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDINTCON1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_sts_reg</span> <span class="o">&amp;</span> <span class="n">VIDINTCON1_INT_FRAME</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* VSYNC interrupt, accept it */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">VIDINTCON1_INT_FRAME</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">VIDINTCON1</span><span class="p">);</span>

		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">vsync_info</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">vsync_info</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We only support waiting for VSYNC for now, so it&#39;s safe</span>
<span class="cm">	 * to always disable irqs here.</span>
<span class="cm">	 */</span>
	<span class="n">s3c_fb_disable_irq</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_wait_for_vsync() - sleep until next VSYNC interrupt or timeout</span>
<span class="cm"> * @sfb: main hardware state</span>
<span class="cm"> * @crtc: head index.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_wait_for_vsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">vsync_info</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="n">s3c_fb_enable_irq</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">vsync_info</span><span class="p">.</span><span class="n">wait</span><span class="p">,</span>
				       <span class="n">count</span> <span class="o">!=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">vsync_info</span><span class="p">.</span><span class="n">count</span><span class="p">,</span>
				       <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">VSYNC_TIMEOUT_MSEC</span><span class="p">));</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crtc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FBIO_WAITFORVSYNC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_fb_wait_for_vsync</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">s3c_fb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">s3c_fb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">s3c_fb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">s3c_fb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">s3c_fb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">s3c_fb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span>	<span class="o">=</span> <span class="n">s3c_fb_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_missing_pixclock() - calculates pixel clock</span>
<span class="cm"> * @mode: The video mode to change.</span>
<span class="cm"> *</span>
<span class="cm"> * Calculate the pixel clock when none has been given through platform data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_fb_missing_pixclock</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">pixclk</span> <span class="o">=</span> <span class="mi">1000000000000ULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">div</span>  <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span>
	       <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">div</span> <span class="o">*=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span>
	       <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">div</span> <span class="o">*=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">60</span><span class="p">;</span>

	<span class="n">do_div</span><span class="p">(</span><span class="n">pixclk</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>

	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">pixclk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_alloc_memory() - allocate display memory for framebuffer window</span>
<span class="cm"> * @sfb: The base resources for the hardware.</span>
<span class="cm"> * @win: The window to initialise memory for.</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate memory for the given framebuffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">s3c_fb_alloc_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb_pd_win</span> <span class="o">*</span><span class="n">windata</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">windata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">real_size</span><span class="p">,</span> <span class="n">virt_size</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">fbinfo</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">map_dma</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;allocating memory for display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">real_size</span> <span class="o">=</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">virt_size</span> <span class="o">=</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">virtual_x</span> <span class="o">*</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">virtual_y</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;real_size=%u (%u.%u), virt_size=%u (%u.%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">real_size</span><span class="p">,</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
		<span class="n">virt_size</span><span class="p">,</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">virtual_x</span><span class="p">,</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">virtual_y</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">real_size</span> <span class="o">&gt;</span> <span class="n">virt_size</span><span class="p">)</span> <span class="o">?</span> <span class="n">real_size</span> <span class="o">:</span> <span class="n">virt_size</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">*=</span> <span class="p">(</span><span class="n">windata</span><span class="o">-&gt;</span><span class="n">max_bpp</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">max_bpp</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">/=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;want %u bytes for window</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">dma_alloc_writecombine</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">map_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mapped %x to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">map_dma</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">map_dma</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_free_memory() - free the display memory for the given window</span>
<span class="cm"> * @sfb: The base resources for the hardware.</span>
<span class="cm"> * @win: The window to free the display memory for.</span>
<span class="cm"> *</span>
<span class="cm"> * Free the display memory allocated by s3c_fb_alloc_memory().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_fb_free_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">fbinfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">dma_free_writecombine</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">),</span>
			      <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_release_win() - release resources for a framebuffer window.</span>
<span class="cm"> * @win: The window to cleanup the resources for.</span>
<span class="cm"> *</span>
<span class="cm"> * Release the resources that where claimed for the hardware window,</span>
<span class="cm"> * such as the framebuffer instance and any memory claimed for it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_fb_release_win</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">fbinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_shadowcon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SHADOWCON</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SHADOWCON_CHx_ENABLE</span><span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SHADOWCON_CHx_LOCAL_ENABLE</span><span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SHADOWCON</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">fbinfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
			<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
		<span class="n">s3c_fb_free_memory</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">win</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">fbinfo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_probe_win() - register an hardware window</span>
<span class="cm"> * @sfb: The base resources for the hardware</span>
<span class="cm"> * @variant: The variant information for this window.</span>
<span class="cm"> * @res: Pointer to where to place the resultant window.</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate and do the basic initialisation for one of the hardware&#39;s graphics</span>
<span class="cm"> * windows.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">s3c_fb_probe_win</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">win_no</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">s3c_fb_win_variant</span> <span class="o">*</span><span class="n">variant</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">**</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">initmode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_pd_win</span> <span class="o">*</span><span class="n">windata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">palette_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probing window %d, variant %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">win_no</span><span class="p">,</span> <span class="n">variant</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">vsync_info</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">palette_size</span> <span class="o">=</span> <span class="n">variant</span><span class="o">-&gt;</span><span class="n">palette_sz</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">fbinfo</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb_win</span><span class="p">)</span> <span class="o">+</span>
				   <span class="n">palette_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">windata</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">win_no</span><span class="p">];</span>
	<span class="n">initmode</span> <span class="o">=</span> <span class="o">*</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vtiming</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">windata</span><span class="o">-&gt;</span><span class="n">max_bpp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">windata</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">windata</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">win</span> <span class="o">=</span> <span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">win</span><span class="p">;</span>
	<span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">=</span> <span class="o">*</span><span class="n">variant</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">fbinfo</span> <span class="o">=</span> <span class="n">fbinfo</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">sfb</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">windata</span> <span class="o">=</span> <span class="n">windata</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">win_no</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">win</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_fb_alloc_memory</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">win</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate display memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup the r/b/g positions for the window&#39;s palette */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">palette_16bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set RGB 5:6:5 as default */</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set 8bpp or 8bpp and 1bit alpha */</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup the initial video mode from the window */</span>
	<span class="n">initmode</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">initmode</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">fb_videomode_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">initmode</span><span class="p">);</span>

	<span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span>	<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>
	<span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span>	<span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span>	<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">windata</span><span class="o">-&gt;</span><span class="n">default_bpp</span><span class="p">;</span>
	<span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">fbops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_ops</span><span class="p">;</span>
	<span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>
	<span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="cm">/* prepare to actually start the framebuffer */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_fb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">fbinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;check_var failed on initial video params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create initial colour map */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">palette_sz</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fb_set_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">fbinfo</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate fb cmap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">s3c_fb_set_par</span><span class="p">(</span><span class="n">fbinfo</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;about to register framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* run the check_var and set_par on our configuration. */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">fbinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;window %d: fb %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">win_no</span><span class="p">,</span> <span class="n">fbinfo</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_set_rgb_timing() - set video timing for rgb interface.</span>
<span class="cm"> * @sfb: The base resources for the hardware.</span>
<span class="cm"> *</span>
<span class="cm"> * Set horizontal and vertical lcd rgb interface timing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_fb_set_rgb_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vtiming</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clkdiv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vmode</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span>
		<span class="n">s3c_fb_missing_pixclock</span><span class="p">(</span><span class="n">vmode</span><span class="p">);</span>

	<span class="n">clkdiv</span> <span class="o">=</span> <span class="n">s3c_fb_calc_pixclk</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">vmode</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vidcon0</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VIDCON0_CLKVAL_F_MASK</span> <span class="o">|</span> <span class="n">VIDCON0_CLKDIR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clkdiv</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">VIDCON0_CLKVAL_F</span><span class="p">(</span><span class="n">clkdiv</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">VIDCON0_CLKDIR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIDCON0_CLKDIR</span><span class="p">;</span>	<span class="cm">/* 1:1 clock */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">is_2443</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">VIDCON0</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">VIDTCON0_VBPD</span><span class="p">(</span><span class="n">vmode</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDTCON0_VFPD</span><span class="p">(</span><span class="n">vmode</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDTCON0_VSPW</span><span class="p">(</span><span class="n">vmode</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">vidtcon</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">VIDTCON1_HBPD</span><span class="p">(</span><span class="n">vmode</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDTCON1_HFPD</span><span class="p">(</span><span class="n">vmode</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDTCON1_HSPW</span><span class="p">(</span><span class="n">vmode</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">vidtcon</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">VIDTCON2_LINEVAL</span><span class="p">(</span><span class="n">vmode</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDTCON2_HOZVAL</span><span class="p">(</span><span class="n">vmode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDTCON2_LINEVAL_E</span><span class="p">(</span><span class="n">vmode</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VIDTCON2_HOZVAL_E</span><span class="p">(</span><span class="n">vmode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">vidtcon</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_clear_win() - clear hardware window registers.</span>
<span class="cm"> * @sfb: The base resources for the hardware.</span>
<span class="cm"> * @win: The window to process.</span>
<span class="cm"> *</span>
<span class="cm"> * Reset the specific window registers to a known state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_fb_clear_win</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">wincon</span> <span class="o">+</span> <span class="p">(</span><span class="n">win</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">VIDOSD_A</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">VIDOSD_B</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">VIDOSD_C</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_shadowcon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SHADOWCON</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SHADOWCON_WINx_PROTECT</span><span class="p">(</span><span class="n">win</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">SHADOWCON_CHx_ENABLE</span><span class="p">(</span><span class="n">win</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">SHADOWCON_CHx_LOCAL_ENABLE</span><span class="p">(</span><span class="n">win</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SHADOWCON</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">s3c_fb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="o">*</span><span class="n">platid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_driverdata</span> <span class="o">*</span><span class="n">fbdrv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_platdata</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">win</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">platid</span> <span class="o">=</span> <span class="n">platform_get_device_id</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">fbdrv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb_driverdata</span> <span class="o">*</span><span class="p">)</span><span class="n">platid</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdrv</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">nr_windows</span> <span class="o">&gt;</span> <span class="n">S3C_FB_MAX_WIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;too many windows, cannot attach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sfb</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no memory for framebuffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;allocate new framebuffer %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">=</span> <span class="n">fbdrv</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lcd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get bus clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_sfb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_clksel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sclk_fimd&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get lcd clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_bus_clk</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">clk_enable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to find registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_lcd_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">devm_request_and_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to map registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_lcd_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to acquire irq resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_lcd_clk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">irq_no</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">irq_no</span><span class="p">,</span> <span class="n">s3c_fb_irq</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s3c_fb&quot;</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_lcd_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;got resources (regs %p), probing windows</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* setup gpio and output polarity controls */</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">setup_gpio</span><span class="p">();</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">vidcon1</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDCON1</span><span class="p">);</span>

	<span class="cm">/* set video clock running at under-run */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_fixvclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDCON1</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIDCON1_VCLK_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">VIDCON1_VCLK_RUN</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDCON1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* zero all windows before we do anything */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">win</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">win</span> <span class="o">&lt;</span> <span class="n">fbdrv</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">nr_windows</span><span class="p">;</span> <span class="n">win</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s3c_fb_clear_win</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">win</span><span class="p">);</span>

	<span class="cm">/* initialise colour key controls */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">win</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">win</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fbdrv</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">nr_windows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">win</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">keycon</span><span class="p">;</span>

		<span class="n">regs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">win</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffff</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">WKEYCON0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffff</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">WKEYCON1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">s3c_fb_set_rgb_timing</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>

	<span class="cm">/* we have the register setup, start allocating framebuffers */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">win</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">win</span> <span class="o">&lt;</span> <span class="n">fbdrv</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">nr_windows</span><span class="p">;</span> <span class="n">win</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">win</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_fb_probe_win</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">fbdrv</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">win</span><span class="p">],</span>
				       <span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">windows</span><span class="p">[</span><span class="n">win</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create window %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">win</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">win</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">win</span><span class="o">--</span><span class="p">)</span>
				<span class="n">s3c_fb_release_win</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">windows</span><span class="p">[</span><span class="n">win</span><span class="p">]);</span>
			<span class="k">goto</span> <span class="n">err_pm_runtime</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>
	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_pm_runtime:</span>
	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_lcd_clk:</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_clksel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err_bus_clk:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">);</span>

<span class="nl">err_sfb:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_fb_remove() - Cleanup on module finalisation</span>
<span class="cm"> * @pdev: The platform device we are bound to.</span>
<span class="cm"> *</span>
<span class="cm"> * Shutdown and then release all the resources that the driver allocated</span>
<span class="cm"> * on initialisation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">s3c_fb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">win</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">win</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">win</span> <span class="o">&lt;</span> <span class="n">S3C_FB_MAX_WIN</span><span class="p">;</span> <span class="n">win</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">windows</span><span class="p">[</span><span class="n">win</span><span class="p">])</span>
			<span class="n">s3c_fb_release_win</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">windows</span><span class="p">[</span><span class="n">win</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_clksel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">);</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">win_no</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">win_no</span> <span class="o">=</span> <span class="n">S3C_FB_MAX_WIN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">win_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">win_no</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">win</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">windows</span><span class="p">[</span><span class="n">win_no</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">win</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* use the blank function to push into power-down */</span>
		<span class="n">s3c_fb_blank</span><span class="p">(</span><span class="n">FB_BLANK_POWERDOWN</span><span class="p">,</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">fbinfo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_clksel</span><span class="p">)</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">);</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_fb_platdata</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_fb_win</span> <span class="o">*</span><span class="n">win</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">win_no</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_clksel</span><span class="p">)</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">);</span>

	<span class="cm">/* setup gpio and output polarity controls */</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">setup_gpio</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">vidcon1</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDCON1</span><span class="p">);</span>

	<span class="cm">/* set video clock running at under-run */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_fixvclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDCON1</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIDCON1_VCLK_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">VIDCON1_VCLK_RUN</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDCON1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* zero all windows before we do anything */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">win_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">win_no</span> <span class="o">&lt;</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">nr_windows</span><span class="p">;</span> <span class="n">win_no</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s3c_fb_clear_win</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">win_no</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">win_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">win_no</span> <span class="o">&lt;</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">nr_windows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">win_no</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">keycon</span><span class="p">;</span>
		<span class="n">win</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">windows</span><span class="p">[</span><span class="n">win_no</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">win</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">regs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">win_no</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffff</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">WKEYCON0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffff</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">WKEYCON1</span><span class="p">);</span>
		<span class="n">shadow_protect_win</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">s3c_fb_set_rgb_timing</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>

	<span class="cm">/* restore framebuffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">win_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">win_no</span> <span class="o">&lt;</span> <span class="n">S3C_FB_MAX_WIN</span><span class="p">;</span> <span class="n">win_no</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">win</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">windows</span><span class="p">[</span><span class="n">win_no</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">win</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resuming window %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">win_no</span><span class="p">);</span>
		<span class="n">s3c_fb_set_par</span><span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">fbinfo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_clksel</span><span class="p">)</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_fb_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_fb</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_fb_platdata</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">bus_clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">.</span><span class="n">has_clksel</span><span class="p">)</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">lcd_clk</span><span class="p">);</span>

	<span class="cm">/* setup gpio and output polarity controls */</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">setup_gpio</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">vidcon1</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">VIDCON1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define VALID_BPP124 (VALID_BPP(1) | VALID_BPP(2) | VALID_BPP(4))</span>
<span class="cp">#define VALID_BPP1248 (VALID_BPP124 | VALID_BPP(8))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c_fb_win_variant</span> <span class="n">s3c_fb_data_64xx_wins</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">has_osd_c</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_size_off</span>	<span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="p">(</span><span class="n">VALID_BPP1248</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">)),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">has_osd_c</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_d</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_size_off</span>	<span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_alpha</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="p">(</span><span class="n">VALID_BPP1248</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">28</span><span class="p">)),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">has_osd_c</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_d</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_size_off</span>	<span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_alpha</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_16bpp</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="p">(</span><span class="n">VALID_BPP1248</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">28</span><span class="p">)),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">has_osd_c</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_alpha</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_16bpp</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="p">(</span><span class="n">VALID_BPP124</span>  <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">28</span><span class="p">)),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">has_osd_c</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_alpha</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_16bpp</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="p">(</span><span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">28</span><span class="p">)),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c_fb_win_variant</span> <span class="n">s3c_fb_data_s5p_wins</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">has_osd_c</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_size_off</span>	<span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="p">(</span><span class="n">VALID_BPP1248</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">32</span><span class="p">)),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">has_osd_c</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_d</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_size_off</span>	<span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_alpha</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="p">(</span><span class="n">VALID_BPP1248</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">32</span><span class="p">)),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">has_osd_c</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_d</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_size_off</span>	<span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_alpha</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="p">(</span><span class="n">VALID_BPP1248</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">32</span><span class="p">)),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">has_osd_c</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_alpha</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="p">(</span><span class="n">VALID_BPP1248</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">32</span><span class="p">)),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">has_osd_c</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_alpha</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="p">(</span><span class="n">VALID_BPP1248</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">32</span><span class="p">)),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c_fb_driverdata</span> <span class="n">s3c_fb_data_64xx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nr_windows</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vidtcon</span>	<span class="o">=</span> <span class="n">VIDTCON0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wincon</span>		<span class="o">=</span> <span class="n">WINCON</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">winmap</span>		<span class="o">=</span> <span class="n">WINxMAP</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">keycon</span>		<span class="o">=</span> <span class="n">WKEYCON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd</span>		<span class="o">=</span> <span class="n">VIDOSD_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_stride</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_start</span>	<span class="o">=</span> <span class="n">VIDW_BUF_START</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_size</span>	<span class="o">=</span> <span class="n">VIDW_BUF_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_end</span>	<span class="o">=</span> <span class="n">VIDW_BUF_END</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>

		<span class="p">.</span><span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x320</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x340</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">has_prtcon</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_clksel</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_64xx_wins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_64xx_wins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_64xx_wins</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_64xx_wins</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_64xx_wins</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c_fb_driverdata</span> <span class="n">s3c_fb_data_s5pc100</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nr_windows</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vidtcon</span>	<span class="o">=</span> <span class="n">VIDTCON0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wincon</span>		<span class="o">=</span> <span class="n">WINCON</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">winmap</span>		<span class="o">=</span> <span class="n">WINxMAP</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">keycon</span>		<span class="o">=</span> <span class="n">WKEYCON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd</span>		<span class="o">=</span> <span class="n">VIDOSD_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_stride</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_start</span>	<span class="o">=</span> <span class="n">VIDW_BUF_START</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_size</span>	<span class="o">=</span> <span class="n">VIDW_BUF_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_end</span>	<span class="o">=</span> <span class="n">VIDW_BUF_END</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>

		<span class="p">.</span><span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2400</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2800</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2c00</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3000</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3400</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">has_prtcon</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_blendcon</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_clksel</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c_fb_driverdata</span> <span class="n">s3c_fb_data_s5pv210</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nr_windows</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vidtcon</span>	<span class="o">=</span> <span class="n">VIDTCON0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wincon</span>		<span class="o">=</span> <span class="n">WINCON</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">winmap</span>		<span class="o">=</span> <span class="n">WINxMAP</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">keycon</span>		<span class="o">=</span> <span class="n">WKEYCON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd</span>		<span class="o">=</span> <span class="n">VIDOSD_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_stride</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_start</span>	<span class="o">=</span> <span class="n">VIDW_BUF_START</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_size</span>	<span class="o">=</span> <span class="n">VIDW_BUF_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_end</span>	<span class="o">=</span> <span class="n">VIDW_BUF_END</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>

		<span class="p">.</span><span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2400</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2800</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2c00</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3000</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3400</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">has_shadowcon</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_blendcon</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_clksel</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_fixvclk</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c_fb_driverdata</span> <span class="n">s3c_fb_data_exynos4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nr_windows</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vidtcon</span>	<span class="o">=</span> <span class="n">VIDTCON0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wincon</span>		<span class="o">=</span> <span class="n">WINCON</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">winmap</span>		<span class="o">=</span> <span class="n">WINxMAP</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">keycon</span>		<span class="o">=</span> <span class="n">WKEYCON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd</span>		<span class="o">=</span> <span class="n">VIDOSD_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_stride</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_start</span>	<span class="o">=</span> <span class="n">VIDW_BUF_START</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_size</span>	<span class="o">=</span> <span class="n">VIDW_BUF_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_end</span>	<span class="o">=</span> <span class="n">VIDW_BUF_END</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>

		<span class="p">.</span><span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2400</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2800</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2c00</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3000</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3400</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">has_shadowcon</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_blendcon</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_fixvclk</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c_fb_driverdata</span> <span class="n">s3c_fb_data_exynos5</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nr_windows</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vidtcon</span>	<span class="o">=</span> <span class="n">VIDTCON0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wincon</span>		<span class="o">=</span> <span class="n">WINCON</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">winmap</span>		<span class="o">=</span> <span class="n">WINxMAP</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">keycon</span>		<span class="o">=</span> <span class="n">WKEYCON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd</span>		<span class="o">=</span> <span class="n">VIDOSD_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_stride</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_start</span>	<span class="o">=</span> <span class="n">VIDW_BUF_START</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_size</span>	<span class="o">=</span> <span class="n">VIDW_BUF_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_end</span>	<span class="o">=</span> <span class="n">VIDW_BUF_END</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>

		<span class="p">.</span><span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2400</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2800</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2c00</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3000</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3400</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">has_shadowcon</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_blendcon</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_fixvclk</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="p">};</span>

<span class="cm">/* S3C2443/S3C2416 style hardware */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c_fb_driverdata</span> <span class="n">s3c_fb_data_s3c2443</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nr_windows</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">is_2443</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vidtcon</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wincon</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">winmap</span>		<span class="o">=</span> <span class="mh">0xd0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">keycon</span>		<span class="o">=</span> <span class="mh">0xb0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd</span>		<span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_stride</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_start</span>	<span class="o">=</span> <span class="mh">0x64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_size</span>	<span class="o">=</span> <span class="mh">0x94</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_end</span>	<span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>

		<span class="p">.</span><span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">has_clksel</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb_win_variant</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="n">VALID_BPP1248</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_fb_win_variant</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">has_osd_c</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_osd_alpha</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">palette_sz</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_bpp</span>	<span class="o">=</span> <span class="p">(</span><span class="n">VALID_BPP1248</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">VALID_BPP</span><span class="p">(</span><span class="mi">28</span><span class="p">)),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c_fb_driverdata</span> <span class="n">s3c_fb_data_s5p64x0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nr_windows</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vidtcon</span>	<span class="o">=</span> <span class="n">VIDTCON0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wincon</span>		<span class="o">=</span> <span class="n">WINCON</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">winmap</span>		<span class="o">=</span> <span class="n">WINxMAP</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">keycon</span>		<span class="o">=</span> <span class="n">WKEYCON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd</span>		<span class="o">=</span> <span class="n">VIDOSD_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">osd_stride</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_start</span>	<span class="o">=</span> <span class="n">VIDW_BUF_START</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_size</span>	<span class="o">=</span> <span class="n">VIDW_BUF_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">buf_end</span>	<span class="o">=</span> <span class="n">VIDW_BUF_END</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>

		<span class="p">.</span><span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2400</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2800</span><span class="p">,</span>
			<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2c00</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">has_blendcon</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">has_fixvclk</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	<span class="p">.</span><span class="n">win</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_fb_data_s5p_wins</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">s3c_fb_driver_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s3c-fb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s3c_fb_data_64xx</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s5pc100-fb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s3c_fb_data_s5pc100</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s5pv210-fb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s3c_fb_data_s5pv210</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;exynos4-fb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s3c_fb_data_exynos4</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;exynos5-fb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s3c_fb_data_exynos5</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s3c2443-fb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s3c_fb_data_s3c2443</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s5p64x0-fb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s3c_fb_data_s5p64x0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">s3c_fb_driver_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">s3cfb_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SET_SYSTEM_SLEEP_PM_OPS</span><span class="p">(</span><span class="n">s3c_fb_suspend</span><span class="p">,</span> <span class="n">s3c_fb_resume</span><span class="p">)</span>
	<span class="n">SET_RUNTIME_PM_OPS</span><span class="p">(</span><span class="n">s3c_fb_runtime_suspend</span><span class="p">,</span> <span class="n">s3c_fb_runtime_resume</span><span class="p">,</span>
			   <span class="nb">NULL</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">s3c_fb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">s3c_fb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">s3c_fb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">s3c_fb_driver_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;s3c-fb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s3cfb_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">s3c_fb_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ben Dooks &lt;ben@simtec.co.uk&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Samsung S3C SoC Framebuffer driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:s3c-fb&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
