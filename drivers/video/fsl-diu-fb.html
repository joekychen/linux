<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › fsl-diu-fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>fsl-diu-fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2008 Freescale Semiconductor, Inc. All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  Freescale DIU Frame Buffer device driver</span>
<span class="cm"> *</span>
<span class="cm"> *  Authors: Hongjun Chen &lt;hong-jun.chen@freescale.com&gt;</span>
<span class="cm"> *           Paul Widmer &lt;paul.widmer@freescale.com&gt;</span>
<span class="cm"> *           Srikanth Srinivasan &lt;srikanth.srinivasan@freescale.com&gt;</span>
<span class="cm"> *           York Sun &lt;yorksun@freescale.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   Based on imxfb.c Copyright (C) 2004 S.Hauer, Pengutronix</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#include &lt;sysdev/fsl_soc.h&gt;</span>
<span class="cp">#include &lt;linux/fsl-diu-fb.h&gt;</span>
<span class="cp">#include &quot;edid.h&quot;</span>

<span class="cp">#define NUM_AOIS	5	</span><span class="cm">/* 1 for plane 0, 2 for planes 1 &amp; 2 each */</span><span class="cp"></span>

<span class="cm">/* HW cursor parameters */</span>
<span class="cp">#define MAX_CURS		32</span>

<span class="cm">/* INT_STATUS/INT_MASK field descriptions */</span>
<span class="cp">#define INT_VSYNC	0x01	</span><span class="cm">/* Vsync interrupt  */</span><span class="cp"></span>
<span class="cp">#define INT_VSYNC_WB	0x02	</span><span class="cm">/* Vsync interrupt for write back operation */</span><span class="cp"></span>
<span class="cp">#define INT_UNDRUN	0x04	</span><span class="cm">/* Under run exception interrupt */</span><span class="cp"></span>
<span class="cp">#define INT_PARERR	0x08	</span><span class="cm">/* Display parameters error interrupt */</span><span class="cp"></span>
<span class="cp">#define INT_LS_BF_VS	0x10	</span><span class="cm">/* Lines before vsync. interrupt */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * List of supported video modes</span>
<span class="cm"> *</span>
<span class="cm"> * The first entry is the default video mode.  The remain entries are in</span>
<span class="cm"> * order if increasing resolution and frequency.  The 320x240-60 mode is</span>
<span class="cm"> * the initial AOI for the second and third planes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">__devinitdata</span> <span class="n">fsl_diu_mode_db</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">15385</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">160</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">29</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">136</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">320</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">79440</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>        <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>           <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>           <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>       <span class="o">=</span> <span class="mi">39722</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>    <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>   <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>   <span class="o">=</span> <span class="mi">33</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>   <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>      <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>           <span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>          <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>        <span class="o">=</span> <span class="mi">72</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>           <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>           <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>       <span class="o">=</span> <span class="mi">32052</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>    <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>   <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>   <span class="o">=</span> <span class="mi">28</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>   <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>      <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>           <span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>          <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>        <span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>           <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>           <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>       <span class="o">=</span> <span class="mi">31747</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>    <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>   <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>   <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>      <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>           <span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>          <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>        <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>           <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>           <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>       <span class="o">=</span> <span class="mi">25057</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>    <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>   <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>   <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>   <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>      <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>           <span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>          <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>        <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>           <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>           <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>       <span class="o">=</span> <span class="mi">22272</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>    <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>   <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>   <span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>   <span class="o">=</span> <span class="mi">22</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>      <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>           <span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>          <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">33805</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">72</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>        <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>           <span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>           <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>       <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>    <span class="o">=</span> <span class="mi">88</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>   <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>   <span class="o">=</span> <span class="mi">23</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>      <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>           <span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>          <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">854</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">31518</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">104</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">88</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">70</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">16886</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">15009</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">1280</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">18939</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">353</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">47</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">39</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">1280</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">13426</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">192</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">22</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">136</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">1280</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">9375</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">38</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">216</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">37</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">70</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">1280</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">9380</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">94</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">1280</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">9380</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">1920</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">1080</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">5787</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">328</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">34</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">208</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fb_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">default_bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">fsl_diu_monitor_port</span> <span class="n">monitor_port</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">monitor_string</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_NOT_COHERENT_CACHE)</span>
<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="n">coherence_data</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">coherence_data_size</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d_cache_line_size</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">diu_lock</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">mfb_index</span> <span class="p">{</span>
	<span class="n">PLANE0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Plane 0, only one AOI that fills the screen */</span>
	<span class="n">PLANE1_AOI0</span><span class="p">,</span>	<span class="cm">/* Plane 1, first AOI */</span>
	<span class="n">PLANE1_AOI1</span><span class="p">,</span>	<span class="cm">/* Plane 1, second AOI */</span>
	<span class="n">PLANE2_AOI0</span><span class="p">,</span>	<span class="cm">/* Plane 2, first AOI */</span>
	<span class="n">PLANE2_AOI1</span><span class="p">,</span>	<span class="cm">/* Plane 2, second AOI */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mfb_info</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">mfb_index</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">registered</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">diu_ad</span> <span class="o">*</span><span class="n">ad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cursor_reset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g_alpha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x_aoi_d</span><span class="p">;</span>		<span class="cm">/* aoi display x offset to physical screen */</span>
	<span class="kt">int</span> <span class="n">y_aoi_d</span><span class="p">;</span>		<span class="cm">/* aoi display y offset to physical screen */</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">edid_data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct fsl_diu_data - per-DIU data structure</span>
<span class="cm"> * @dma_addr: DMA address of this structure</span>
<span class="cm"> * @fsl_diu_info: fb_info objects, one per AOI</span>
<span class="cm"> * @dev_attr: sysfs structure</span>
<span class="cm"> * @irq: IRQ</span>
<span class="cm"> * @monitor_port: the monitor port this DIU is connected to</span>
<span class="cm"> * @diu_reg: pointer to the DIU hardware registers</span>
<span class="cm"> * @reg_lock: spinlock for register access</span>
<span class="cm"> * @dummy_aoi: video buffer for the 4x4 32-bit dummy AOI</span>
<span class="cm"> * dummy_ad: DIU Area Descriptor for the dummy AOI</span>
<span class="cm"> * @ad[]: Area Descriptors for each real AOI</span>
<span class="cm"> * @gamma: gamma color table</span>
<span class="cm"> * @cursor: hardware cursor data</span>
<span class="cm"> *</span>
<span class="cm"> * This data structure must be allocated with 32-byte alignment, so that the</span>
<span class="cm"> * internal fields can be aligned properly.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="n">fsl_diu_info</span><span class="p">[</span><span class="n">NUM_AOIS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="n">mfb</span><span class="p">[</span><span class="n">NUM_AOIS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fsl_diu_monitor_port</span> <span class="n">monitor_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">diu_reg</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dummy_aoi</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">diu_ad</span> <span class="n">dummy_ad</span> <span class="n">__aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">diu_ad</span> <span class="n">ad</span><span class="p">[</span><span class="n">NUM_AOIS</span><span class="p">]</span> <span class="n">__aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="n">__aligned</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">cursor</span><span class="p">[</span><span class="n">MAX_CURS</span> <span class="o">*</span> <span class="n">MAX_CURS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="n">__aligned</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
<span class="p">}</span> <span class="n">__aligned</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="cm">/* Determine the DMA address of a member of the fsl_diu_data structure */</span>
<span class="cp">#define DMA_ADDR(p, f) ((p)-&gt;dma_addr + offsetof(struct fsl_diu_data, f))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mfb_info</span> <span class="n">mfb_template</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">PLANE0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;Panel0&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">x_aoi_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">PLANE1_AOI0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;Panel1 AOI0&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">g_alpha</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">x_aoi_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">PLANE1_AOI1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;Panel1 AOI1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">g_alpha</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">x_aoi_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">PLANE2_AOI0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;Panel2 AOI0&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">g_alpha</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">x_aoi_d</span> <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">PLANE2_AOI1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;Panel2 AOI1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">g_alpha</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">x_aoi_d</span> <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_diu_name_to_port - convert a port name to a monitor port enum</span>
<span class="cm"> *</span>
<span class="cm"> * Takes the name of a monitor port (&quot;dvi&quot;, &quot;lvds&quot;, or &quot;dlvds&quot;) and returns</span>
<span class="cm"> * the enum fsl_diu_monitor_port that corresponds to that string.</span>
<span class="cm"> *</span>
<span class="cm"> * For compatibility with older versions, a number (&quot;0&quot;, &quot;1&quot;, or &quot;2&quot;) is also</span>
<span class="cm"> * supported.</span>
<span class="cm"> *</span>
<span class="cm"> * If the string is unknown, DVI is assumed.</span>
<span class="cm"> *</span>
<span class="cm"> * If the particular port is not supported by the platform, another port</span>
<span class="cm"> * (platform-specific) is chosen instead.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">fsl_diu_monitor_port</span> <span class="nf">fsl_diu_name_to_port</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">fsl_diu_monitor_port</span> <span class="n">port</span> <span class="o">=</span> <span class="n">FSL_DIU_PORT_DVI</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">fsl_diu_monitor_port</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;lvds&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">port</span> <span class="o">=</span> <span class="n">FSL_DIU_PORT_LVDS</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;dlvds&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">port</span> <span class="o">=</span> <span class="n">FSL_DIU_PORT_DLVDS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">diu_ops</span><span class="p">.</span><span class="n">valid_monitor_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Workaround for failed writing desc register of planes.</span>
<span class="cm"> * Needed with MPC5121 DIU rev 2.0 silicon.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">wr_reg_wa</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsl_diu_enable_panel</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">pmfbi</span><span class="p">,</span> <span class="o">*</span><span class="n">cmfbi</span><span class="p">,</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu_ad</span> <span class="o">*</span><span class="n">ad</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PLANE0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">)</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE1_AOI0</span>:
		<span class="n">cmfbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mfb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* AOI0 closed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmfbi</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* AOI1 open */</span>
				<span class="n">ad</span><span class="o">-&gt;</span><span class="n">next_ad</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ad</span><span class="o">-&gt;</span><span class="n">next_ad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE2_AOI0</span>:
		<span class="n">cmfbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mfb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* AOI0 closed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmfbi</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* AOI1 open */</span>
				<span class="n">ad</span><span class="o">-&gt;</span><span class="n">next_ad</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ad</span><span class="o">-&gt;</span><span class="n">next_ad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE1_AOI1</span>:
		<span class="n">pmfbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mfb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">ad</span><span class="o">-&gt;</span><span class="n">next_ad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span><span class="p">)</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
		<span class="k">else</span>					<span class="cm">/* AOI0 open */</span>
			<span class="n">pmfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">next_ad</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE2_AOI1</span>:
		<span class="n">pmfbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mfb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">ad</span><span class="o">-&gt;</span><span class="n">next_ad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span><span class="p">)</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
		<span class="k">else</span>				<span class="cm">/* AOI0 was open */</span>
			<span class="n">pmfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">next_ad</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsl_diu_disable_panel</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">pmfbi</span><span class="p">,</span> <span class="o">*</span><span class="n">cmfbi</span><span class="p">,</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu_ad</span> <span class="o">*</span><span class="n">ad</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PLANE0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span><span class="p">)</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE1_AOI0</span>:
		<span class="n">cmfbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mfb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmfbi</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* AOI1 is open */</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
					<span class="cm">/* move AOI1 to the first */</span>
		<span class="k">else</span>			<span class="cm">/* AOI1 was closed */</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>
					<span class="cm">/* close AOI 0 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE2_AOI0</span>:
		<span class="n">cmfbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mfb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmfbi</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* AOI1 is open */</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
					<span class="cm">/* move AOI1 to the first */</span>
		<span class="k">else</span>			<span class="cm">/* AOI1 was closed */</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>
					<span class="cm">/* close AOI 0 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE1_AOI1</span>:
		<span class="n">pmfbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mfb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* AOI1 is not the first in the chain */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmfbi</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="cm">/* AOI0 is open, must be the first */</span>
				<span class="n">pmfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">next_ad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>			<span class="cm">/* AOI1 is the first in the chain */</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>
					<span class="cm">/* close AOI 1 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE2_AOI1</span>:
		<span class="n">pmfbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mfb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* AOI1 is not the first in the chain */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmfbi</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* AOI0 is open, must be the first */</span>
				<span class="n">pmfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">next_ad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>		<span class="cm">/* AOI1 is the first in the chain */</span>
			<span class="n">wr_reg_wa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>
				<span class="cm">/* close AOI 1 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_lcdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="p">;</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">diu_mode</span><span class="p">,</span> <span class="n">MFB_MODE1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_lcdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="p">;</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">diu_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adjust_aoi_size_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">lower_aoi_mfbi</span><span class="p">,</span> <span class="o">*</span><span class="n">upper_aoi_mfbi</span><span class="p">,</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">available_height</span><span class="p">,</span> <span class="n">upper_aoi_bottom</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">mfb_index</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lower_aoi_is_open</span><span class="p">,</span> <span class="n">upper_aoi_is_open</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">base_plane_width</span><span class="p">,</span> <span class="n">base_plane_height</span><span class="p">,</span> <span class="n">upper_aoi_height</span><span class="p">;</span>

	<span class="n">base_plane_width</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">base_plane_height</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PLANE0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE1_AOI0</span>:
	<span class="k">case</span> <span class="n">PLANE2_AOI0</span>:
		<span class="n">lower_aoi_mfbi</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">par</span><span class="p">;</span>
		<span class="n">lower_aoi_is_open</span> <span class="o">=</span> <span class="n">lower_aoi_mfbi</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">base_plane_width</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">base_plane_width</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">base_plane_width</span><span class="p">)</span>
			<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span> <span class="o">=</span> <span class="n">base_plane_width</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lower_aoi_is_open</span><span class="p">)</span>
			<span class="n">available_height</span> <span class="o">=</span> <span class="n">lower_aoi_mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">available_height</span> <span class="o">=</span> <span class="n">base_plane_height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">available_height</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">available_height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">available_height</span><span class="p">)</span>
			<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="n">available_height</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE1_AOI1</span>:
	<span class="k">case</span> <span class="n">PLANE2_AOI1</span>:
		<span class="n">upper_aoi_mfbi</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">par</span><span class="p">;</span>
		<span class="n">upper_aoi_height</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">upper_aoi_bottom</span> <span class="o">=</span> <span class="n">upper_aoi_mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">+</span> <span class="n">upper_aoi_height</span><span class="p">;</span>
		<span class="n">upper_aoi_is_open</span> <span class="o">=</span> <span class="n">upper_aoi_mfbi</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">base_plane_width</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">base_plane_width</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">base_plane_width</span><span class="p">)</span>
			<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span> <span class="o">=</span> <span class="n">base_plane_width</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">upper_aoi_is_open</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">&lt;</span> <span class="n">upper_aoi_bottom</span><span class="p">)</span>
				<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="n">upper_aoi_bottom</span><span class="p">;</span>
			<span class="n">available_height</span> <span class="o">=</span> <span class="n">base_plane_height</span>
						<span class="o">-</span> <span class="n">upper_aoi_bottom</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">available_height</span> <span class="o">=</span> <span class="n">base_plane_height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">available_height</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">available_height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">base_plane_height</span><span class="p">)</span>
			<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="n">base_plane_height</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Checks to see if the hardware supports the state requested by var passed</span>
<span class="cm"> * in. This function does not alter the hardware state! If the var passed in</span>
<span class="cm"> * is slightly off by what the hardware can support then we alter the var</span>
<span class="cm"> * PASSED in to what we can do. If the hardware doesn&#39;t support mode change</span>
<span class="cm"> * a -EINVAL will be returned by the upper layers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_diu_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">))</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">default_bpp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Copy nonstd field to/from sync for fbset usage */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">|=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">;</span>

	<span class="n">adjust_aoi_size_position</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_lcdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">gamma_table_base</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="p">;</span>

	<span class="n">diu_ops</span><span class="p">.</span><span class="n">set_monitor_port</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">monitor_port</span><span class="p">);</span>
	<span class="n">gamma_table_base</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">gamma</span><span class="p">;</span>

	<span class="cm">/* Prep for DIU init  - gamma table, cursor table */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">gamma_table_base</span><span class="o">++</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diu_ops</span><span class="p">.</span><span class="n">set_gamma_table</span><span class="p">)</span>
		<span class="n">diu_ops</span><span class="p">.</span><span class="n">set_gamma_table</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">monitor_port</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">gamma</span><span class="p">);</span>

	<span class="n">disable_lcdc</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Program DIU registers */</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">gamma</span><span class="p">,</span> <span class="n">DMA_ADDR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gamma</span><span class="p">));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">,</span> <span class="n">DMA_ADDR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cursor</span><span class="p">));</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bgnd</span><span class="p">,</span> <span class="mh">0x007F7F7F</span><span class="p">);</span> 	<span class="cm">/* BGND */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bgnd_wb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 		<span class="cm">/* BGND_WB */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_size</span><span class="p">,</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">));</span>
						<span class="cm">/* DISP SIZE */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wb_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* WB SIZE */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wb_mem_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* WB MEM ADDR */</span>

	<span class="cm">/* Horizontal and vertical configuration register */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span> <span class="o">|</span> <span class="cm">/* BP_H */</span>
	       <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span> <span class="o">|</span>   <span class="cm">/* PW_H */</span>
	       <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>       <span class="cm">/* FP_H */</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hsyn_para</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span> <span class="o">|</span> <span class="cm">/* BP_V */</span>
	       <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span> <span class="o">|</span>    <span class="cm">/* PW_V  */</span>
	       <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>        <span class="cm">/* FP_V  */</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vsyn_para</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">diu_ops</span><span class="p">.</span><span class="n">set_pixel_clock</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">syn_pol</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* SYNC SIGNALS POLARITY */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">int_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* INTERRUPT STATUS */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">plut</span><span class="p">,</span> <span class="mh">0x01F5F666</span><span class="p">);</span>

	<span class="cm">/* Enable the DIU */</span>
	<span class="n">enable_lcdc</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">map_video_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">smem_len</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">alloc_pages_exact</span><span class="p">(</span><span class="n">smem_len</span><span class="p">,</span> <span class="n">GFP_DMA</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to allocate fb memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">smem_len</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unmap_video_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">l</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="n">free_pages_exact</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Using the fb_var_screeninfo in fb_info we set the aoi of this</span>
<span class="cm"> * particular framebuffer. It is a light version of fsl_diu_set_par.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_diu_set_aoi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu_ad</span> <span class="o">*</span><span class="n">ad</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">;</span>

	<span class="cm">/* AOI should not be greater than display size */</span>
	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">offset_xyi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">);</span>
	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">offset_xyd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_diu_get_pixel_format: return the pixel format for a given color depth</span>
<span class="cm"> *</span>
<span class="cm"> * The pixel format is a 32-bit value that determine which bits in each</span>
<span class="cm"> * pixel are to be used for each color.  This is the default function used</span>
<span class="cm"> * if the platform does not define its own version.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">fsl_diu_get_pixel_format</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits_per_pixel</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define PF_BYTE_F		0x10000000</span>
<span class="cp">#define PF_ALPHA_C_MASK		0x0E000000</span>
<span class="cp">#define PF_ALPHA_C_SHIFT	25</span>
<span class="cp">#define PF_BLUE_C_MASK		0x01800000</span>
<span class="cp">#define PF_BLUE_C_SHIFT		23</span>
<span class="cp">#define PF_GREEN_C_MASK		0x00600000</span>
<span class="cp">#define PF_GREEN_C_SHIFT	21</span>
<span class="cp">#define PF_RED_C_MASK		0x00180000</span>
<span class="cp">#define PF_RED_C_SHIFT		19</span>
<span class="cp">#define PF_PALETTE		0x00040000</span>
<span class="cp">#define PF_PIXEL_S_MASK		0x00030000</span>
<span class="cp">#define PF_PIXEL_S_SHIFT	16</span>
<span class="cp">#define PF_COMP_3_MASK		0x0000F000</span>
<span class="cp">#define PF_COMP_3_SHIFT		12</span>
<span class="cp">#define PF_COMP_2_MASK		0x00000F00</span>
<span class="cp">#define PF_COMP_2_SHIFT		8</span>
<span class="cp">#define PF_COMP_1_MASK		0x000000F0</span>
<span class="cp">#define PF_COMP_1_SHIFT		4</span>
<span class="cp">#define PF_COMP_0_MASK		0x0000000F</span>
<span class="cp">#define PF_COMP_0_SHIFT		0</span>

<span class="cp">#define MAKE_PF(alpha, red, blue, green, size, c0, c1, c2, c3) \</span>
<span class="cp">	cpu_to_le32(PF_BYTE_F | (alpha &lt;&lt; PF_ALPHA_C_SHIFT) | \</span>
<span class="cp">	(blue &lt;&lt; PF_BLUE_C_SHIFT) | (green &lt;&lt; PF_GREEN_C_SHIFT) | \</span>
<span class="cp">	(red &lt;&lt; PF_RED_C_SHIFT) | (c3 &lt;&lt; PF_COMP_3_SHIFT) | \</span>
<span class="cp">	(c2 &lt;&lt; PF_COMP_2_SHIFT) | (c1 &lt;&lt; PF_COMP_1_SHIFT) | \</span>
<span class="cp">	(c0 &lt;&lt; PF_COMP_0_SHIFT) | (size &lt;&lt; PF_PIXEL_S_SHIFT))</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="cm">/* 0x88883316 */</span>
		<span class="k">return</span> <span class="n">MAKE_PF</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="cm">/* 0x88082219 */</span>
		<span class="k">return</span> <span class="n">MAKE_PF</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="cm">/* 0x65053118 */</span>
		<span class="k">return</span> <span class="n">MAKE_PF</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;fsl-diu: unsupported color depth %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Using the fb_var_screeninfo in fb_info we set the resolution of this</span>
<span class="cm"> * particular framebuffer. This function alters the fb_fix_screeninfo stored</span>
<span class="cm"> * in fb_info. It does not alter var in fb_info since we are using that</span>
<span class="cm"> * data. This means we depend on the data in var inside fb_info to be</span>
<span class="cm"> * supported by the hardware. fsl_diu_check_var is always called before</span>
<span class="cm"> * fsl_diu_set_par to ensure this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_diu_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu_ad</span> <span class="o">*</span><span class="n">ad</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="p">;</span>

	<span class="n">set_fix</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">cursor_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="cm">/* Alloc &amp; dealloc each time resolution/bpp change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">)</span>
			<span class="n">unmap_video_memory</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="cm">/* Memory allocation for framebuffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map_video_memory</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to allocate fb memory 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diu_ops</span><span class="p">.</span><span class="n">get_pixel_format</span><span class="p">)</span>
		<span class="n">ad</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">diu_ops</span><span class="p">.</span><span class="n">get_pixel_format</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">monitor_port</span><span class="p">,</span>
						       <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ad</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">fsl_diu_get_pixel_format</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">addr</span>    <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">);</span>
	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">src_size_g_alpha</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span> <span class="o">|</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">g_alpha</span><span class="p">;</span>
	<span class="cm">/* AOI should not be greater than display size */</span>
	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">aoi_size</span> 	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">offset_xyi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">);</span>
	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">offset_xyd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span><span class="p">);</span>

	<span class="cm">/* Disable chroma keying function */</span>
	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmax_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmax_g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmax_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmin_r</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmin_g</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmin_b</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">PLANE0</span><span class="p">)</span>
		<span class="n">update_lcdc</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">CNVT_TOHW</span><span class="p">(</span><span class="n">__u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">width</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x7FFF</span> <span class="o">-</span> <span class="n">val</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set a single color register. The values supplied have a 16 bit magnitude</span>
<span class="cm"> * which needs to be scaled in this function for the hardware. Things to take</span>
<span class="cm"> * into consideration are how many color registers, if any, are supported with</span>
<span class="cm"> * the current color visual. With truecolor mode no color palettes are</span>
<span class="cm"> * supported. Here a pseudo palette is created which we store the value in</span>
<span class="cm"> * pseudo_palette in struct fb_info. For pseudocolor mode we have a limited</span>
<span class="cm"> * color palette.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_diu_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If greyscale is true, then we convert the RGB value</span>
<span class="cm">	 * to greyscale no matter what visual we are using.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">green</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="mi">19595</span> <span class="o">*</span> <span class="n">red</span> <span class="o">+</span> <span class="mi">38470</span> <span class="o">*</span> <span class="n">green</span> <span class="o">+</span>
				      <span class="mi">7471</span> <span class="o">*</span> <span class="n">blue</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * 16-bit True Colour.  We encode the RGB value</span>
<span class="cm">		 * according to the RGB bitfield information.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

			<span class="n">red</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
			<span class="n">green</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
			<span class="n">blue</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
			<span class="n">transp</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">transp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

			<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">blue</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">transp</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>

			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Pan (or wrap, depending on the `vmode&#39; field) the display using the</span>
<span class="cm"> * &#39;xoffset&#39; and &#39;yoffset&#39; fields of the &#39;var&#39; structure. If the values</span>
<span class="cm"> * don&#39;t fit, return -EINVAL.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_diu_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No change, do nothing */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span>
	    <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>

	<span class="n">fsl_diu_set_aoi</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_diu_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diu_ad</span> <span class="o">*</span><span class="n">ad</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mfb_chroma_key</span> <span class="n">ck</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">global_alpha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoi_display_offset</span> <span class="n">aoi_d</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">pix_fmt</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MFB_SET_PIXFMT_OLD</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;MFB_SET_PIXFMT value of 0x%08x is deprecated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">MFB_SET_PIXFMT_OLD</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MFB_SET_PIXFMT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pix_fmt</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pix_fmt</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ad</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">pix_fmt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MFB_GET_PIXFMT_OLD</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;MFB_GET_PIXFMT value of 0x%08x is deprecated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">MFB_GET_PIXFMT_OLD</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MFB_GET_PIXFMT</span>:
		<span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pix_fmt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pix_fmt</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MFB_SET_AOID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aoi_d</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">aoi_d</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span> <span class="o">=</span> <span class="n">aoi_d</span><span class="p">.</span><span class="n">x_aoi_d</span><span class="p">;</span>
		<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="n">aoi_d</span><span class="p">.</span><span class="n">y_aoi_d</span><span class="p">;</span>
		<span class="n">fsl_diu_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">fsl_diu_set_aoi</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MFB_GET_AOID</span>:
		<span class="n">aoi_d</span><span class="p">.</span><span class="n">x_aoi_d</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">x_aoi_d</span><span class="p">;</span>
		<span class="n">aoi_d</span><span class="p">.</span><span class="n">y_aoi_d</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">y_aoi_d</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aoi_d</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">aoi_d</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MFB_GET_ALPHA</span>:
		<span class="n">global_alpha</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">g_alpha</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global_alpha</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">global_alpha</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MFB_SET_ALPHA</span>:
		<span class="cm">/* set panel information */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_alpha</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">global_alpha</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ad</span><span class="o">-&gt;</span><span class="n">src_size_g_alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">src_size_g_alpha</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xff</span><span class="p">))</span> <span class="o">|</span>
							<span class="p">(</span><span class="n">global_alpha</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">g_alpha</span> <span class="o">=</span> <span class="n">global_alpha</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MFB_SET_CHROMA_KEY</span>:
		<span class="cm">/* set panel winformation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ck</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ck</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ck</span><span class="p">.</span><span class="n">enable</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">ck</span><span class="p">.</span><span class="n">red_max</span> <span class="o">&lt;</span> <span class="n">ck</span><span class="p">.</span><span class="n">red_min</span> <span class="o">||</span>
		    <span class="n">ck</span><span class="p">.</span><span class="n">green_max</span> <span class="o">&lt;</span> <span class="n">ck</span><span class="p">.</span><span class="n">green_min</span> <span class="o">||</span>
		    <span class="n">ck</span><span class="p">.</span><span class="n">blue_max</span> <span class="o">&lt;</span> <span class="n">ck</span><span class="p">.</span><span class="n">blue_min</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ck</span><span class="p">.</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmax_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmax_g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmax_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmin_r</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmin_g</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmin_b</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmax_r</span> <span class="o">=</span> <span class="n">ck</span><span class="p">.</span><span class="n">red_max</span><span class="p">;</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmax_g</span> <span class="o">=</span> <span class="n">ck</span><span class="p">.</span><span class="n">green_max</span><span class="p">;</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmax_b</span> <span class="o">=</span> <span class="n">ck</span><span class="p">.</span><span class="n">blue_max</span><span class="p">;</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmin_r</span> <span class="o">=</span> <span class="n">ck</span><span class="p">.</span><span class="n">red_min</span><span class="p">;</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmin_g</span> <span class="o">=</span> <span class="n">ck</span><span class="p">.</span><span class="n">green_min</span><span class="p">;</span>
			<span class="n">ad</span><span class="o">-&gt;</span><span class="n">ckmin_b</span> <span class="o">=</span> <span class="n">ck</span><span class="p">.</span><span class="n">blue_min</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown ioctl command (0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* turn on fb if count == 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_diu_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* free boot splash memory on first /dev/fb0 open */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">PLANE0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">diu_ops</span><span class="p">.</span><span class="n">release_bootmem</span><span class="p">)</span>
		<span class="n">diu_ops</span><span class="p">.</span><span class="n">release_bootmem</span><span class="p">();</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diu_lock</span><span class="p">);</span>
	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fsl_diu_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">fsl_diu_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fsl_diu_enable_panel</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diu_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* turn off fb if count == 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_diu_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diu_lock</span><span class="p">);</span>
	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fsl_diu_disable_panel</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diu_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">fsl_diu_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span> <span class="o">=</span> <span class="n">fsl_diu_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span> <span class="o">=</span> <span class="n">fsl_diu_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="n">fsl_diu_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">fsl_diu_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span> <span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span> <span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span> <span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span> <span class="o">=</span> <span class="n">fsl_diu_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span> <span class="o">=</span> <span class="n">fsl_diu_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span> <span class="o">=</span> <span class="n">fsl_diu_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">install_fb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aoi_mode</span><span class="p">,</span> <span class="o">*</span><span class="n">init_aoi_mode</span> <span class="o">=</span> <span class="s">&quot;320x240&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">fsl_diu_mode_db</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dbsize</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fsl_diu_mode_db</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">has_default_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsl_diu_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_VIRTFB</span> <span class="o">|</span> <span class="n">FBINFO_PARTIAL_PAN_OK</span> <span class="o">|</span>
		<span class="n">FBINFO_READS_FAST</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">PLANE0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">edid_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Now build modedb from EDID */</span>
			<span class="n">fb_edid_to_monspecs</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">edid_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">);</span>
			<span class="n">fb_videomode_to_modelist</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span><span class="p">,</span>
						 <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb_len</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
			<span class="n">db</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span><span class="p">;</span>
			<span class="n">dbsize</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">aoi_mode</span> <span class="o">=</span> <span class="n">fb_mode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">aoi_mode</span> <span class="o">=</span> <span class="n">init_aoi_mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">aoi_mode</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">dbsize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">default_bpp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For plane 0 we continue and look into</span>
<span class="cm">		 * driver&#39;s internal modedb.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">PLANE0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">edid_data</span><span class="p">)</span>
			<span class="n">has_default_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_default_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">aoi_mode</span><span class="p">,</span> <span class="n">fsl_diu_mode_db</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fsl_diu_mode_db</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">default_bpp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">has_default_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Still not found, use preferred mode from database if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_default_mode</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">modedb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * Get preferred timing. If not found,</span>
<span class="cm">		 * first mode in database will be used.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">FB_MISC_1ST_DETAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">FB_MODE_IS_FIRST</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">modedb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">default_bpp</span><span class="p">;</span>
		<span class="n">fb_videomode_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">modedb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsl_diu_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fsl_diu_check_var failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">unmap_video_memory</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;register_framebuffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">unmap_video_memory</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s registered successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uninstall_fb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">registered</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">PLANE0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">edid_data</span><span class="p">);</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">unmap_video_memory</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">)</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>

	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">fsl_diu_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">diu</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">int_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is the workaround for underrun */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">INT_UNDRUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">diu_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">diu_mode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#if defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">INT_VSYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">coherence_data_size</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">+=</span> <span class="n">d_cache_line_size</span><span class="p">)</span>
				<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
					<span class="s">&quot;dcbz 0, %[input]&quot;</span>
				<span class="o">::</span><span class="p">[</span><span class="n">input</span><span class="p">]</span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coherence_data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_irq_local</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">diu</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ints</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Read to clear the status */</span>
	<span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">int_status</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">fsl_diu_isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsl-diu-fb&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ints</span> <span class="o">=</span> <span class="n">INT_PARERR</span> <span class="o">|</span> <span class="n">INT_LS_BF_VS</span><span class="p">;</span>
<span class="cp">#if !defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="n">ints</span> <span class="o">|=</span>	<span class="n">INT_VSYNC</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="cm">/* Read to clear the status */</span>
		<span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">int_status</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_irq_local</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">diu</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="p">;</span>

	<span class="cm">/* Disable all LCDC interrupt */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * Power management hooks. Note that we won&#39;t be called from IRQ context,</span>
<span class="cm"> * unlike the blank functions above, so we may sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_diu_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">disable_lcdc</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_diu_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_lcdc</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define fsl_diu_suspend NULL</span>
<span class="cp">#define fsl_diu_resume NULL</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">fsl_diu_monitor_port</span> <span class="n">old_monitor_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsl_diu_data</span><span class="p">,</span> <span class="n">dev_attr</span><span class="p">);</span>

	<span class="n">old_monitor_port</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">monitor_port</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">monitor_port</span> <span class="o">=</span> <span class="n">fsl_diu_name_to_port</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_monitor_port</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">monitor_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All AOIs need adjust pixel format</span>
<span class="cm">		 * fsl_diu_set_par only change the pixsel format here</span>
<span class="cm">		 * unlikely to fail. */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_AOIS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">fsl_diu_set_par</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsl_diu_data</span><span class="p">,</span> <span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">monitor_port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSL_DIU_PORT_DVI</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;DVI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FSL_DIU_PORT_LVDS</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Single-link LVDS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FSL_DIU_PORT_DLVDS</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Dual-link LVDS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">fsl_diu_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mfb_info</span> <span class="o">*</span><span class="n">mfbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diu_mode</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span> <span class="cm">/* DMA addr of fsl_diu_data struct */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsl_diu_data</span><span class="p">),</span>
				  <span class="o">&amp;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">GFP_DMA</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * dma_alloc_coherent() uses a page allocator, so the address is</span>
<span class="cm">	 * always page-aligned.  We need the memory to be 32-byte aligned,</span>
<span class="cm">	 * so that&#39;s good.  However, if one day the allocator changes, we</span>
<span class="cm">	 * need to catch that.  It&#39;s not worth the effort to handle unaligned</span>
<span class="cm">	 * alloctions now because it&#39;s highly unlikely to ever be a problem.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;misaligned allocation&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_AOIS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mfb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * We store the physical address of the AD in the reserved</span>
<span class="cm">		 * &#39;paddr&#39; field of the AD itself.</span>
<span class="cm">		 */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">DMA_ADDR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ad</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Initialize the AOI data structure */</span>
		<span class="n">mfbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mfbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mfb_template</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mfb_info</span><span class="p">));</span>
		<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">ad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">PLANE0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

			<span class="cm">/* Get EDID */</span>
			<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;edid&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="n">EDID_LENGTH</span><span class="p">)</span>
				<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">edid_data</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">EDID_LENGTH</span><span class="p">,</span>
							  <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot map DIU registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">diu_mode</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="o">-&gt;</span><span class="n">diu_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diu_mode</span> <span class="o">==</span> <span class="n">MFB_MODE0</span><span class="p">)</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="o">-&gt;</span><span class="n">diu_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* disable DIU */</span>

	<span class="cm">/* Get the IRQ of the DIU */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not get DIU IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">monitor_port</span> <span class="o">=</span> <span class="n">monitor_port</span><span class="p">;</span>

	<span class="cm">/* Initialize the dummy Area Descriptor */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DMA_ADDR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dummy_aoi</span><span class="p">));</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="mh">0x88882317</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">src_size_g_alpha</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">aoi_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>  <span class="mi">2</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">offset_xyi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">offset_xyd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">next_ad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">DMA_ADDR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dummy_ad</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Let DIU display splash screen if it was pre-initialized</span>
<span class="cm">	 * by the bootloader, set dummy area descriptor otherwise.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diu_mode</span> <span class="o">==</span> <span class="n">MFB_MODE0</span><span class="p">)</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dummy_ad</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_AOIS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">install_fb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not register fb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq_local</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not claim irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;monitor&quot;</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">show_monitor</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store_monitor</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not create sysfs file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_AOIS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">uninstall_fb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsl_diu_data</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span>
			  <span class="n">data</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_diu_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsl_diu_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">disable_lcdc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">free_irq_local</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_AOIS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">uninstall_fb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fsl_diu_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">diu_reg</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsl_diu_data</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span>
			  <span class="n">data</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fsl_diu_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;monitor=&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">monitor_port</span> <span class="o">=</span> <span class="n">fsl_diu_name_to_port</span><span class="p">(</span><span class="n">opt</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;bpp=&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">opt</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
				<span class="n">default_bpp</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">fb_mode</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">fsl_diu_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_MPC512x</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5121-diu&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,diu&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">fsl_diu_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">fsl_diu_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fsl-diu-fb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">fsl_diu_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>  	<span class="o">=</span> <span class="n">fsl_diu_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> 	<span class="o">=</span> <span class="n">fsl_diu_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">fsl_diu_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">fsl_diu_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fsl_diu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_NOT_COHERENT_CACHE</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For kernel boot options (in &#39;video=xxxfb:&lt;options&gt;&#39; format)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;fslfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">fsl_diu_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">monitor_port</span> <span class="o">=</span> <span class="n">fsl_diu_name_to_port</span><span class="p">(</span><span class="n">monitor_string</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Freescale Display Interface Unit (DIU) framebuffer driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_NOT_COHERENT_CACHE</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_type</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;fsl-diu-fb: can&#39;t find &#39;cpu&#39; device node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;d-cache-size&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;fsl-diu-fb: missing &#39;d-cache-size&#39; property&#39; &quot;</span>
		       <span class="s">&quot;in &#39;cpu&#39; node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Freescale PLRU requires 13/8 times the cache size to do a proper</span>
<span class="cm">	 * displacement flush</span>
<span class="cm">	 */</span>
	<span class="n">coherence_data_size</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="o">*</span> <span class="mi">13</span><span class="p">;</span>
	<span class="n">coherence_data_size</span> <span class="o">/=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;d-cache-line-size&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;fsl-diu-fb: missing &#39;d-cache-line-size&#39; property&#39; &quot;</span>
		       <span class="s">&quot;in &#39;cpu&#39; node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">d_cache_line_size</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>

	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">coherence_data</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">coherence_data_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">coherence_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsl_diu_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;fsl-diu-fb: failed to register platform driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">coherence_data</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">fsl_diu_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsl_diu_driver</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_NOT_COHERENT_CACHE)</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">coherence_data</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">fsl_diu_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">fsl_diu_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;York Sun &lt;yorksun@freescale.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Freescale DIU framebuffer driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">fb_mode</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span>
	<span class="s">&quot;Specify resolution as </span><span class="se">\&quot;</span><span class="s">&lt;xres&gt;x&lt;yres&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]</span><span class="se">\&quot;</span><span class="s"> &quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">default_bpp</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="s">&quot;Specify bit-per-pixel if not specified in &#39;mode&#39;&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">monitor</span><span class="p">,</span> <span class="n">monitor_string</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">monitor</span><span class="p">,</span> <span class="s">&quot;Specify the monitor port &quot;</span>
	<span class="s">&quot;(</span><span class="se">\&quot;</span><span class="s">dvi</span><span class="se">\&quot;</span><span class="s">, </span><span class="se">\&quot;</span><span class="s">lvds</span><span class="se">\&quot;</span><span class="s">, or </span><span class="se">\&quot;</span><span class="s">dlvds</span><span class="se">\&quot;</span><span class="s">) if supported by the platform&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
