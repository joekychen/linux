<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › tridentfb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tridentfb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Frame buffer driver for Trident TGUI, Blade and Image series</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2001, 2002 - Jani Monoses   &lt;jani@iv.ro&gt;</span>
<span class="cm"> * Copyright 2009 Krzysztof Helt &lt;krzysztof.h1@wp.pl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * CREDITS:(in order of appearance)</span>
<span class="cm"> *	skeletonfb.c by Geert Uytterhoeven and other fb code in drivers/video</span>
<span class="cm"> *	Special thanks ;) to Mattia Crivellini &lt;tia@mclink.it&gt;</span>
<span class="cm"> *	much inspired by the XFree86 4.x Trident driver sources</span>
<span class="cm"> *	by Alan Hourihane the FreeVGA project</span>
<span class="cm"> *	Francesco Salvestrini &lt;salvestrini@users.sf.net&gt; XP support,</span>
<span class="cm"> *	code, suggestions</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *	timing value tweaking so it looks good on every monitor in every mode</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;video/vga.h&gt;</span>
<span class="cp">#include &lt;video/trident.h&gt;</span>

<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">io_virt</span><span class="p">;</span>	<span class="cm">/* iospace virtual memory address */</span>
	<span class="n">u32</span> <span class="n">pseudo_pal</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">chip_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flatpanel</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init_accel</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">wait_engine</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fill_rect</span><span class="p">)</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">copy_rect</span><span class="p">)</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">image_blit</span><span class="p">)</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span>
		 <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">eng_oper</span><span class="p">;</span>	<span class="cm">/* engine operation... */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">tridentfb_fix</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;Trident&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* defaults which are normally overriden by user values */</span>

<span class="cm">/* video mode */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;640x480-8@60&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bpp</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">noaccel</span> <span class="n">__devinitdata</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">center</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">stretch</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fp</span> <span class="n">__devinitdata</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">crt</span> <span class="n">__devinitdata</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">memsize</span> <span class="n">__devinitdata</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">memdiff</span> <span class="n">__devinitdata</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nativex</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="s">&quot;Initial video mode e.g. &#39;648x480-8@60&#39;&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;Initial video mode e.g. &#39;648x480-8@60&#39; (deprecated)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">stretch</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">memsize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">memdiff</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nativex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;Define if flatpanel is connected&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">crt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">crt</span><span class="p">,</span> <span class="s">&quot;Define if CRT is connected&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_oldclock</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>	<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">TGUI9440</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">TGUI9660</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBER9320</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_oldprotect</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>	<span class="n">is_oldclock</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">PROVIDIA9685</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBER9382</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBER9385</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_blade</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>	<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">BLADE3D</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBERBLADEE4</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBERBLADEi7</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBERBLADEi7D</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBERBLADEi1</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBERBLADEi1D</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBERBLADEAi1</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBERBLADEAi1D</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_xp</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>	<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBERBLADEXPAi1</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBERBLADEXPm8</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBERBLADEXPm16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is3Dchip</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>	<span class="n">is_blade</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_xp</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBER9397</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBER9397DVD</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBER9520</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">CYBER9525DVD</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">IMAGE975</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">IMAGE985</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">iscyber</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CYBER9388</span>:
	<span class="k">case</span> <span class="n">CYBER9382</span>:
	<span class="k">case</span> <span class="n">CYBER9385</span>:
	<span class="k">case</span> <span class="n">CYBER9397</span>:
	<span class="k">case</span> <span class="n">CYBER9397DVD</span>:
	<span class="k">case</span> <span class="n">CYBER9520</span>:
	<span class="k">case</span> <span class="n">CYBER9525DVD</span>:
	<span class="k">case</span> <span class="n">CYBERBLADEE4</span>:
	<span class="k">case</span> <span class="n">CYBERBLADEi7D</span>:
	<span class="k">case</span> <span class="n">CYBERBLADEi1</span>:
	<span class="k">case</span> <span class="n">CYBERBLADEi1D</span>:
	<span class="k">case</span> <span class="n">CYBERBLADEAi1</span>:
	<span class="k">case</span> <span class="n">CYBERBLADEAi1D</span>:
	<span class="k">case</span> <span class="n">CYBERBLADEXPAi1</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CYBER9320</span>:
	<span class="k">case</span> <span class="n">CYBERBLADEi7</span>:	<span class="cm">/* VIA MPV4 integrated version */</span>
	<span class="nl">default:</span>
		<span class="cm">/* case CYBERBLDAEXPm8:  Strange */</span>
		<span class="cm">/* case CYBERBLDAEXPm16: Strange */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t_outb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fb_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">io_virt</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">t_inb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fb_readb</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">io_virt</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">writemmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u16</span> <span class="n">r</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span> <span class="o">+</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">readmmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u16</span> <span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fb_readl</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span> <span class="o">+</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Blade specific acceleration.</span>
<span class="cm"> */</span>

<span class="cp">#define point(x, y) ((y) &lt;&lt; 16 | (x))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blade_init_accel</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x21C0</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x21C4</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x21B8</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x21BC</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x21D0</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x21D4</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x21C8</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x21CC</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x216C</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blade_wait_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readmmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFA800000</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blade_fill_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COLOR</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ROP</span><span class="p">,</span> <span class="n">rop</span> <span class="o">?</span> <span class="n">ROP_X</span> <span class="o">:</span> <span class="n">ROP_S</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="mh">0x20000000</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DST1</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">));</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DST2</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blade_image_blit</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">w</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">COLOR</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BGCOLOR</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="mh">0xa0000000</span> <span class="o">|</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DST1</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">));</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DST2</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span> <span class="o">+</span> <span class="mh">0x10000</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blade_copy_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">x1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">x2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">point</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">point</span><span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">point</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">point</span><span class="p">(</span><span class="n">x2</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">y1</span> <span class="o">&gt;</span> <span class="n">y2</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">y1</span> <span class="o">==</span> <span class="n">y2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">x2</span><span class="p">)))</span>
		<span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ROP</span><span class="p">,</span> <span class="n">ROP_S</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="mh">0xE0000000</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">direction</span><span class="p">);</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SRC1</span><span class="p">,</span> <span class="n">direction</span> <span class="o">?</span> <span class="n">s2</span> <span class="o">:</span> <span class="n">s1</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SRC2</span><span class="p">,</span> <span class="n">direction</span> <span class="o">?</span> <span class="n">s1</span> <span class="o">:</span> <span class="n">s2</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DST1</span><span class="p">,</span> <span class="n">direction</span> <span class="o">?</span> <span class="n">d2</span> <span class="o">:</span> <span class="n">d1</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DST2</span><span class="p">,</span> <span class="n">direction</span> <span class="o">?</span> <span class="n">d1</span> <span class="o">:</span> <span class="n">d2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * BladeXP specific acceleration functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xp_init_accel</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">pitch</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span> <span class="o">?</span> <span class="mi">20</span> <span class="o">:</span> <span class="p">(</span><span class="mi">18</span> <span class="o">+</span> <span class="n">x</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8192</span>:
	<span class="k">case</span> <span class="mi">512</span>:
		<span class="n">x</span> <span class="o">|=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1024</span>:
		<span class="n">x</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2048</span>:
		<span class="n">x</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4096</span>:
		<span class="n">x</span> <span class="o">|=</span> <span class="mh">0x0C</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x2125</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">eng_oper</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2154</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2150</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x2126</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xp_wait_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">t_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">10000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Timeout */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">9990000</span><span class="p">;</span>
			<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Reset engine */</span>
				<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xp_fill_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2127</span><span class="p">,</span> <span class="n">ROP_P</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2158</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DRAWFL</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OLDDIM</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">));</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OLDDST</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">));</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">OLDCMD</span><span class="p">);</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">eng_oper</span><span class="p">,</span> <span class="mh">0x2125</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xp_copy_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">x1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">x2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">x1_tmp</span><span class="p">,</span> <span class="n">x2_tmp</span><span class="p">,</span> <span class="n">y1_tmp</span><span class="p">,</span> <span class="n">y2_tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">direction</span> <span class="o">=</span> <span class="mh">0x0004</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">x1</span> <span class="o">&lt;</span> <span class="n">x2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">y1</span> <span class="o">==</span> <span class="n">y2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">direction</span> <span class="o">|=</span> <span class="mh">0x0200</span><span class="p">;</span>
		<span class="n">x1_tmp</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">x2_tmp</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">x1_tmp</span> <span class="o">=</span> <span class="n">x1</span><span class="p">;</span>
		<span class="n">x2_tmp</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y1</span> <span class="o">&lt;</span> <span class="n">y2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">direction</span> <span class="o">|=</span> <span class="mh">0x0100</span><span class="p">;</span>
		<span class="n">y1_tmp</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">y2_tmp</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">y1_tmp</span> <span class="o">=</span> <span class="n">y1</span><span class="p">;</span>
		<span class="n">y2_tmp</span> <span class="o">=</span> <span class="n">y2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DRAWFL</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ROP_S</span><span class="p">,</span> <span class="mh">0x2127</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OLDSRC</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">y1_tmp</span><span class="p">,</span> <span class="n">x1_tmp</span><span class="p">));</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OLDDST</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">y2_tmp</span><span class="p">,</span> <span class="n">x2_tmp</span><span class="p">));</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OLDDIM</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">));</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">OLDCMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Image specific acceleration functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">image_init_accel</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span> <span class="o">?</span> <span class="mi">2</span><span class="o">:</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2120</span><span class="p">,</span> <span class="mh">0xF0000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2120</span><span class="p">,</span> <span class="mh">0x40000000</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2120</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2144</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2148</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2150</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2154</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2120</span><span class="p">,</span> <span class="mh">0x60000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">pitch</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x216C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2170</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x217C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2120</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2130</span><span class="p">,</span> <span class="p">(</span><span class="mi">2047</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2047</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">image_wait_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readmmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2164</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0000000</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">image_fill_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2120</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2120</span><span class="p">,</span> <span class="mh">0x90000000</span> <span class="o">|</span> <span class="n">ROP_S</span><span class="p">);</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2144</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DST1</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">));</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DST2</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2124</span><span class="p">,</span> <span class="mh">0x80000000</span> <span class="o">|</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">image_copy_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">x1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">x2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">direction</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">point</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">point</span><span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">point</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">point</span><span class="p">(</span><span class="n">x2</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">y1</span> <span class="o">&gt;</span> <span class="n">y2</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">y1</span> <span class="o">==</span> <span class="n">y2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">x2</span><span class="p">)))</span>
		<span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2120</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2120</span><span class="p">,</span> <span class="mh">0x90000000</span> <span class="o">|</span> <span class="n">ROP_S</span><span class="p">);</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SRC1</span><span class="p">,</span> <span class="n">direction</span> <span class="o">?</span> <span class="n">s2</span> <span class="o">:</span> <span class="n">s1</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SRC2</span><span class="p">,</span> <span class="n">direction</span> <span class="o">?</span> <span class="n">s1</span> <span class="o">:</span> <span class="n">s2</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DST1</span><span class="p">,</span> <span class="n">direction</span> <span class="o">?</span> <span class="n">d2</span> <span class="o">:</span> <span class="n">d1</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DST2</span><span class="p">,</span> <span class="n">direction</span> <span class="o">?</span> <span class="n">d1</span> <span class="o">:</span> <span class="n">d2</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2124</span><span class="p">,</span>
		 <span class="mh">0x80000000</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span> <span class="o">|</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TGUI 9440/96XX acceleration</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tgui_init_accel</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* disable clipping */</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x2148</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x214C</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="mi">4095</span><span class="p">,</span> <span class="mi">2047</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">pitch</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8192</span>:
	<span class="k">case</span> <span class="mi">512</span>:
		<span class="n">x</span> <span class="o">|=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1024</span>:
		<span class="n">x</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2048</span>:
		<span class="n">x</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4096</span>:
		<span class="n">x</span> <span class="o">|=</span> <span class="mh">0x0C</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_writew</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span> <span class="o">+</span> <span class="mh">0x2122</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tgui_fill_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ROP_P</span><span class="p">,</span> <span class="mh">0x2127</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OLDCLR</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DRAWFL</span><span class="p">,</span> <span class="mh">0x4020</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OLDDIM</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OLDDST</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">));</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OLDCMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tgui_copy_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">x1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">x2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">x1_tmp</span><span class="p">,</span> <span class="n">x2_tmp</span><span class="p">,</span> <span class="n">y1_tmp</span><span class="p">,</span> <span class="n">y2_tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">x1</span> <span class="o">&lt;</span> <span class="n">x2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">y1</span> <span class="o">==</span> <span class="n">y2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x0200</span><span class="p">;</span>
		<span class="n">x1_tmp</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">x2_tmp</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">x1_tmp</span> <span class="o">=</span> <span class="n">x1</span><span class="p">;</span>
		<span class="n">x2_tmp</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y1</span> <span class="o">&lt;</span> <span class="n">y2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x0100</span><span class="p">;</span>
		<span class="n">y1_tmp</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">y2_tmp</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">y1_tmp</span> <span class="o">=</span> <span class="n">y1</span><span class="p">;</span>
		<span class="n">y2_tmp</span> <span class="o">=</span> <span class="n">y2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DRAWFL</span><span class="p">,</span> <span class="mh">0x4</span> <span class="o">|</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ROP_S</span><span class="p">,</span> <span class="mh">0x2127</span><span class="p">);</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OLDSRC</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">x1_tmp</span><span class="p">,</span> <span class="n">y1_tmp</span><span class="p">));</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OLDDST</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">x2_tmp</span><span class="p">,</span> <span class="n">y2_tmp</span><span class="p">));</span>
	<span class="n">writemmr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OLDDIM</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OLDCMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Accel functions called by the upper layers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tridentfb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">fr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">col</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">fr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">col</span> <span class="o">=</span> <span class="n">fr</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>
		<span class="n">col</span> <span class="o">|=</span> <span class="n">col</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">col</span> <span class="o">|=</span> <span class="n">col</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">col</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">fr</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">];</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">wait_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">fill_rect</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">fr</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">fr</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="n">fr</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
		       <span class="n">fr</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">fr</span><span class="o">-&gt;</span><span class="n">rop</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tridentfb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">img</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">col</span><span class="p">,</span> <span class="n">bgcol</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="o">||</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">img</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">col</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">;</span>
		<span class="n">col</span> <span class="o">|=</span> <span class="n">col</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">col</span> <span class="o">|=</span> <span class="n">col</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">bgcol</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">;</span>
		<span class="n">bgcol</span> <span class="o">|=</span> <span class="n">bgcol</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">bgcol</span> <span class="o">|=</span> <span class="n">bgcol</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">col</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">];</span>
		<span class="n">bgcol</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">wait_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">image_blit</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">image_blit</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span>
				<span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">bgcol</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">img</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tridentfb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">ca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ca</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">wait_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">copy_rect</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">sx</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span>
		       <span class="n">ca</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tridentfb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">))</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">wait_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Hardware access functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">read3X4</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vga_mm_rcrt</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write3X4</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vga_mm_wcrt</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">read3CE</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vga_mm_rgfx</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">writeAttr</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fb_readb</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span> <span class="o">+</span> <span class="n">VGA_IS1_RC</span><span class="p">);</span>	<span class="cm">/* flip-flop to index */</span>
	<span class="n">vga_mm_wattr</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write3CE</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vga_mm_wgfx</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Goto New Mode */</span>
	<span class="n">vga_io_rseq</span><span class="p">(</span><span class="mh">0x0B</span><span class="p">);</span>

	<span class="cm">/* Unprotect registers */</span>
	<span class="n">vga_io_wseq</span><span class="p">(</span><span class="n">NewMode1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_oldprotect</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">))</span>
		<span class="n">vga_io_wseq</span><span class="p">(</span><span class="n">Protection</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">);</span>

	<span class="cm">/* Enable MMIO */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">PCIReg</span><span class="p">,</span> <span class="mh">0x3D4</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3D5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Goto New Mode */</span>
	<span class="n">vga_mm_rseq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">);</span>

	<span class="cm">/* Unprotect registers */</span>
	<span class="n">vga_mm_wseq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="n">NewMode1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_oldprotect</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">))</span>
		<span class="n">vga_mm_wseq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="n">Protection</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">);</span>

	<span class="cm">/* Disable MMIO */</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PCIReg</span><span class="p">,</span> <span class="mh">0x3D4</span><span class="p">);</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">t_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">crtc_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">,</span>
		 <span class="n">read3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*  Return flat panel&#39;s maximum x resolution */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">get_nativex</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nativex</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nativex</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VertStretch</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">x</span> <span class="o">=</span> <span class="mi">1280</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">x</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">768</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">x</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">x</span> <span class="o">=</span> <span class="mi">1400</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1050</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="nl">default:</span>
		<span class="n">x</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span>  <span class="n">y</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">output</span><span class="p">(</span><span class="s">&quot;%dx%d flat panel found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set pitch */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_lwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_OFFSET</span><span class="p">,</span> <span class="n">width</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">AddColReg</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">read3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">AddColReg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xCF</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* For resolutions smaller than FP resolution stretch */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">screen_stretch</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="n">CYBERBLADEXPAi1</span><span class="p">)</span>
		<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BiosReg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BiosReg</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VertStretch</span><span class="p">,</span> <span class="p">(</span><span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VertStretch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7C</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">HorStretch</span><span class="p">,</span> <span class="p">(</span><span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">HorStretch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7C</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* For resolutions smaller than FP resolution center */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">screen_center</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VertStretch</span><span class="p">,</span> <span class="p">(</span><span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VertStretch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7C</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">HorStretch</span><span class="p">,</span> <span class="p">(</span><span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">HorStretch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7C</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Address of first shown pixel in display memory */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_screen_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_START_LO</span><span class="p">,</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_START_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">read3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CRTCModuleTest</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xDF</span><span class="p">;</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CRTCModuleTest</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">((</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">read3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CRTHiOrd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">;</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CRTHiOrd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">((</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xE0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Set dotclock frequency */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_vclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fi</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">di</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">best_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">best_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">best_k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shift</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_oldclock</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">shift</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="p">((</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">n</span><span class="p">);</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">122</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fi</span> <span class="o">=</span> <span class="p">((</span><span class="mi">14318l</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">k</span><span class="p">;</span>
				<span class="n">di</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">fi</span> <span class="o">-</span> <span class="n">freq</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">di</span> <span class="o">&lt;</span> <span class="n">d</span> <span class="o">||</span> <span class="p">(</span><span class="n">di</span> <span class="o">==</span> <span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">==</span> <span class="n">best_k</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">d</span> <span class="o">=</span> <span class="n">di</span><span class="p">;</span>
					<span class="n">best_n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
					<span class="n">best_m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
					<span class="n">best_k</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fi</span> <span class="o">&gt;</span> <span class="n">freq</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_oldclock</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="n">best_n</span> <span class="o">|</span> <span class="p">(</span><span class="n">best_m</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_m</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">best_k</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="n">best_n</span><span class="p">;</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">best_m</span> <span class="o">|</span> <span class="p">(</span><span class="n">best_k</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is3Dchip</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vga_mm_wseq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="n">ClockHigh</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
		<span class="n">vga_mm_wseq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="n">ClockLow</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="mh">0x43C8</span><span class="p">);</span>
		<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="mh">0x43C9</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;VCLK = %X %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set number of lines for flat panels*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_number_of_lines</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CyberEnhance</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lines</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x50</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lines</span> <span class="o">&gt;</span> <span class="mi">768</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lines</span> <span class="o">&gt;</span> <span class="mi">600</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lines</span> <span class="o">&gt;</span> <span class="mi">480</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CyberEnhance</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If we see that FP is active we assume we have one.</span>
<span class="cm"> * Otherwise we have a CRT display. User can override.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">is_flatpanel</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crt</span> <span class="o">||</span> <span class="o">!</span><span class="n">iscyber</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FPConfig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Try detecting the video memory size */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">get_memsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="cm">/* If memory size provided by user */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memsize</span><span class="p">)</span>
		<span class="n">k</span> <span class="o">=</span> <span class="n">memsize</span> <span class="o">*</span> <span class="n">Kb</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CYBER9525DVD</span>:
			<span class="n">k</span> <span class="o">=</span> <span class="mi">2560</span> <span class="o">*</span> <span class="n">Kb</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">read3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">SPR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">case</span> <span class="mh">0x01</span>:
				<span class="n">k</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="n">Kb</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x02</span>:
				<span class="n">k</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>	<span class="cm">/* XP */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x03</span>:
				<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x04</span>:
				<span class="n">k</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x06</span>:
				<span class="n">k</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>	<span class="cm">/* XP */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x07</span>:
				<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x08</span>:
				<span class="n">k</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>	<span class="cm">/* XP */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x0A</span>:
				<span class="n">k</span> <span class="o">=</span> <span class="mi">14</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>	<span class="cm">/* XP */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x0C</span>:
				<span class="n">k</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>	<span class="cm">/* XP */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x0E</span>:		<span class="cm">/* XP */</span>

				<span class="n">tmp2</span> <span class="o">=</span> <span class="n">vga_mm_rseq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">tmp2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mh">0x00</span>:
					<span class="n">k</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x01</span>:
					<span class="n">k</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x10</span>:
					<span class="n">k</span> <span class="o">=</span> <span class="mi">28</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x11</span>:
					<span class="n">k</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mh">0x0F</span>:
				<span class="n">k</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">Mb</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="n">k</span> <span class="o">-=</span> <span class="n">memdiff</span> <span class="o">*</span> <span class="n">Kb</span><span class="p">;</span>
	<span class="n">output</span><span class="p">(</span><span class="s">&quot;framebuffer size = %d Kb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">/</span> <span class="n">Kb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">k</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* See if we can handle the video mode described in var */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tridentfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ramdac</span> <span class="o">=</span> <span class="mi">230000</span><span class="p">;</span> <span class="cm">/* 230MHz for most 3D chips */</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* check color depth */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">bpp</span> <span class="o">!=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">bpp</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">TGUI9440</span> <span class="o">&amp;&amp;</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* check whether resolution fits on panel and in memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">flatpanel</span> <span class="o">&amp;&amp;</span> <span class="n">nativex</span> <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">nativex</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* various resolution checks */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&gt;</span> <span class="mi">4095</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* prevent from position overflow for acceleration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is3Dchip</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* acceleration requires line length to be power of 2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line_length</span> <span class="o">&lt;=</span> <span class="mi">512</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">line_length</span> <span class="o">&lt;=</span> <span class="mi">1024</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">line_length</span> <span class="o">&lt;=</span> <span class="mi">2048</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="mi">2048</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">line_length</span> <span class="o">&lt;=</span> <span class="mi">4096</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">line_length</span> <span class="o">&lt;=</span> <span class="mi">8192</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="mi">8192</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* datasheet specifies how to set panning only up to 4 MB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line_length</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="p">((</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">/</span> <span class="n">line_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_xp</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">))</span>
		<span class="n">ramdac</span> <span class="o">=</span> <span class="mi">350000</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TGUI9440</span>:
		<span class="n">ramdac</span> <span class="o">=</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="mi">45000</span> <span class="o">:</span> <span class="mi">90000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYBER9320</span>:
	<span class="k">case</span> <span class="n">TGUI9660</span>:
		<span class="n">ramdac</span> <span class="o">=</span> <span class="mi">135000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PROVIDIA9685</span>:
	<span class="k">case</span> <span class="n">CYBER9388</span>:
	<span class="k">case</span> <span class="n">CYBER9382</span>:
	<span class="k">case</span> <span class="n">CYBER9385</span>:
		<span class="n">ramdac</span> <span class="o">=</span> <span class="mi">170000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The clock is doubled for 32 bpp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">ramdac</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ramdac</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Pan the display */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tridentfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">))</span>
		<span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">set_screen_start</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">shadowmode_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CyberControl</span><span class="p">,</span> <span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CyberControl</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x81</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">shadowmode_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CyberControl</span><span class="p">,</span> <span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CyberControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7E</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set the hardware to the requested video mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tridentfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">hdispend</span><span class="p">,</span> <span class="n">hsyncstart</span><span class="p">,</span> <span class="n">hsyncend</span><span class="p">,</span> <span class="n">hblankstart</span><span class="p">,</span> <span class="n">hblankend</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vtotal</span><span class="p">,</span> <span class="n">vdispend</span><span class="p">,</span> <span class="n">vsyncstart</span><span class="p">,</span> <span class="n">vsyncend</span><span class="p">,</span> <span class="n">vblankstart</span><span class="p">,</span> <span class="n">vblankend</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vclk</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">hdispend</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hsyncstart</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">hsyncend</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">htotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span>
		  <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">hblankstart</span> <span class="o">=</span> <span class="n">hdispend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hblankend</span> <span class="o">=</span> <span class="n">htotal</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">vdispend</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vsyncstart</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">vsyncend</span> <span class="o">=</span> <span class="n">vsyncstart</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">vtotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">vsyncend</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">vblankstart</span> <span class="o">=</span> <span class="n">vdispend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vblankend</span> <span class="o">=</span> <span class="n">vtotal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vtotal</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vdispend</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vsyncstart</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vsyncend</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vblankstart</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vblankend</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">enable_mmio</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">crtc_unlock</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CyberControl</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0xEB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">flatpanel</span> <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="n">nativex</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * on flat panels with native size larger</span>
<span class="cm">		 * than requested resolution decide whether</span>
<span class="cm">		 * we stretch or center</span>
<span class="cm">		 */</span>
		<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="n">VGA_MIS_W</span><span class="p">);</span>

		<span class="n">shadowmode_on</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">center</span><span class="p">)</span>
			<span class="n">screen_center</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stretch</span><span class="p">)</span>
			<span class="n">screen_stretch</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">VGA_MIS_W</span><span class="p">);</span>
		<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CyberControl</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* vertical timing values */</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_V_TOTAL</span><span class="p">,</span> <span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_V_DISP_END</span><span class="p">,</span> <span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_V_SYNC_START</span><span class="p">,</span> <span class="n">vsyncstart</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">,</span> <span class="p">(</span><span class="n">vsyncend</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">));</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_V_BLANK_START</span><span class="p">,</span> <span class="n">vblankstart</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_V_BLANK_END</span><span class="p">,</span> <span class="n">vblankend</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="cm">/* horizontal timing values */</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_H_TOTAL</span><span class="p">,</span> <span class="n">htotal</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_H_DISP</span><span class="p">,</span> <span class="n">hdispend</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_H_SYNC_START</span><span class="p">,</span> <span class="n">hsyncstart</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_H_SYNC_END</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">hsyncend</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">hblankend</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_H_BLANK_START</span><span class="p">,</span> <span class="n">hblankstart</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_H_BLANK_END</span><span class="p">,</span> <span class="n">hblankend</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>

	<span class="cm">/* higher bits of vertical timing values */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vsyncstart</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vblankstart</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vsyncstart</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_OVERFLOW</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">read3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CRTHiOrd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>	<span class="cm">/* line compare bit 10 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vblankstart</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vsyncstart</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CRTHiOrd</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">htotal</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hdispend</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hsyncstart</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hblankstart</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">HorizOverflow</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vblankstart</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME    if (info->var.vmode &amp; FB<em>VMODE</em>DOUBLE) tmp |= 0x80;  /* double scan for 200 line modes */</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_MAX_SCAN</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_LINE_COMPARE</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_PRESET_ROW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_CRTC_MODE</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">);</span>

	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">LinearAddReg</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>	<span class="cm">/* enable linear addressing */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x84</span> <span class="o">:</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="cm">/* enable access extended memory */</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CRTCModuleTest</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MiscIntContReg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MiscIntContReg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* enable GE for text acceleration */</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">GraphEngReg</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PixelBusReg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">read3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DRAMControl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_oldprotect</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">))</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iscyber</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">))</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">DRAMControl</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>	<span class="cm">/* both IO, linear enable */</span>

	<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">InterfaceSel</span><span class="p">,</span> <span class="n">read3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">InterfaceSel</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_xp</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">))</span>
		<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">Performance</span><span class="p">,</span> <span class="n">read3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">Performance</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="cm">/* MMIO &amp; PCI read and write burst enable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="n">TGUI9440</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="n">IMAGE975</span><span class="p">)</span>
		<span class="n">write3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PCIReg</span><span class="p">,</span> <span class="n">read3X4</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PCIReg</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x06</span><span class="p">);</span>

	<span class="n">vga_mm_wseq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">vga_mm_wseq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* set char clock 8 dots wide */</span>
	<span class="cm">/* enable 4 maps because needed in chain4 mode */</span>
	<span class="n">vga_mm_wseq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">);</span>
	<span class="n">vga_mm_wseq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vga_mm_wseq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">);</span> <span class="cm">/* memory mode enable bitmaps ?? */</span>

	<span class="cm">/* convert from picoseconds to kHz */</span>
	<span class="n">vclk</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">);</span>

	<span class="cm">/* divide clock by 2 if 32bpp chain4 mode display and CPU path */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MiscExtFunc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">TGUI9440</span> <span class="o">&amp;&amp;</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">vclk</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_vclk</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vclk</span><span class="p">);</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">MiscExtFunc</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x12</span><span class="p">);</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* no CGA compat, allow 256 col */</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>	<span class="cm">/* graphics mode */</span>
	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">);</span>	<span class="cm">/* planes? */</span>

	<span class="cm">/* graphics mode and support 256 color modes */</span>
	<span class="n">writeAttr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
	<span class="n">writeAttr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">);</span>	<span class="cm">/* planes */</span>
	<span class="n">writeAttr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* horizontal pel panning */</span>

	<span class="cm">/* colors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writeAttr</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">fb_readb</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span> <span class="o">+</span> <span class="n">VGA_IS1_RC</span><span class="p">);</span>	<span class="cm">/* flip-flop to index */</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">VGA_ATT_W</span><span class="p">);</span>		<span class="cm">/* enable attr */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0xD0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_PEL_IW</span><span class="p">);</span>
	<span class="n">t_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">);</span>
	<span class="n">t_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">);</span>
	<span class="n">t_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">);</span>
	<span class="n">t_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">);</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">);</span>
	<span class="n">t_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VGA_PEL_IW</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">flatpanel</span><span class="p">)</span>
		<span class="n">set_number_of_lines</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">set_lwidth</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">))</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">init_accel</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set one color register */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tridentfb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">);</span>
		<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">VGA_PEL_IW</span><span class="p">);</span>

		<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>
		<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>
		<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* RGB 565 */</span>
			<span class="n">u32</span> <span class="n">col</span><span class="p">;</span>

			<span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xF800</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xFC00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xF800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">|=</span> <span class="n">col</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>		<span class="cm">/* ARGB 8888 */</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">transp</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>	<span class="o">|</span>
				<span class="p">((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>		<span class="o">|</span>
				<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">))</span>		<span class="o">|</span>
				<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Try blanking the screen. For flat panels it does nothing */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tridentfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">PMCont</span><span class="p">,</span> <span class="n">DPMSCont</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">flatpanel</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x83C8</span><span class="p">);</span> <span class="cm">/* Read DPMS Control */</span>
	<span class="n">PMCont</span> <span class="o">=</span> <span class="n">t_inb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x83C6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">;</span>
	<span class="n">DPMSCont</span> <span class="o">=</span> <span class="n">read3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PowerStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="cm">/* Screen: On, HSync: On, VSync: On */</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="cm">/* Screen: Off, HSync: On, VSync: On */</span>
		<span class="n">PMCont</span> <span class="o">|=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">DPMSCont</span> <span class="o">|=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="cm">/* Screen: Off, HSync: Off, VSync: On */</span>
		<span class="n">PMCont</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">DPMSCont</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="cm">/* Screen: Off, HSync: On, VSync: Off */</span>
		<span class="n">PMCont</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">DPMSCont</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="cm">/* Screen: Off, HSync: Off, VSync: Off */</span>
		<span class="n">PMCont</span> <span class="o">|=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">DPMSCont</span> <span class="o">|=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write3CE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PowerStatus</span><span class="p">,</span> <span class="n">DPMSCont</span><span class="p">);</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x83C8</span><span class="p">);</span>
	<span class="n">t_outb</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PMCont</span><span class="p">,</span> <span class="mh">0x83C6</span><span class="p">);</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* let fbcon do a softblank for us */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">blank_mode</span> <span class="o">==</span> <span class="n">FB_BLANK_NORMAL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">tridentfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="n">tridentfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">tridentfb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span> <span class="o">=</span> <span class="n">tridentfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span> <span class="o">=</span> <span class="n">tridentfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span> <span class="o">=</span> <span class="n">tridentfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span> <span class="o">=</span> <span class="n">tridentfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span> <span class="o">=</span> <span class="n">tridentfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span> <span class="o">=</span> <span class="n">tridentfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_sync</span> <span class="o">=</span> <span class="n">tridentfb_sync</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">trident_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">revision</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">default_par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip3D</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip_id</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tridentfb_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">default_par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">chip_id</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="cm">/* If PCI id is 0x9660 then further detect chip type */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">TGUI9660</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">revision</span> <span class="o">=</span> <span class="n">vga_io_rseq</span><span class="p">(</span><span class="n">RevisionID</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x21</span>:
			<span class="n">chip_id</span> <span class="o">=</span> <span class="n">PROVIDIA9685</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x22</span>:
		<span class="k">case</span> <span class="mh">0x23</span>:
			<span class="n">chip_id</span> <span class="o">=</span> <span class="n">CYBER9397</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x2A</span>:
			<span class="n">chip_id</span> <span class="o">=</span> <span class="n">CYBER9397DVD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x30</span>:
		<span class="k">case</span> <span class="mh">0x33</span>:
		<span class="k">case</span> <span class="mh">0x34</span>:
		<span class="k">case</span> <span class="mh">0x35</span>:
		<span class="k">case</span> <span class="mh">0x38</span>:
		<span class="k">case</span> <span class="mh">0x3A</span>:
		<span class="k">case</span> <span class="mh">0xB3</span>:
			<span class="n">chip_id</span> <span class="o">=</span> <span class="n">CYBER9385</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x40</span> <span class="p">...</span> <span class="mh">0x43</span>:
			<span class="n">chip_id</span> <span class="o">=</span> <span class="n">CYBER9382</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x4A</span>:
			<span class="n">chip_id</span> <span class="o">=</span> <span class="n">CYBER9388</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">chip3D</span> <span class="o">=</span> <span class="n">is3Dchip</span><span class="p">(</span><span class="n">chip_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_xp</span><span class="p">(</span><span class="n">chip_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">init_accel</span> <span class="o">=</span> <span class="n">xp_init_accel</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">wait_engine</span> <span class="o">=</span> <span class="n">xp_wait_engine</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">fill_rect</span> <span class="o">=</span> <span class="n">xp_fill_rect</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">copy_rect</span> <span class="o">=</span> <span class="n">xp_copy_rect</span><span class="p">;</span>
		<span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_TRIDENT_BLADEXP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_blade</span><span class="p">(</span><span class="n">chip_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">init_accel</span> <span class="o">=</span> <span class="n">blade_init_accel</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">wait_engine</span> <span class="o">=</span> <span class="n">blade_wait_engine</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">fill_rect</span> <span class="o">=</span> <span class="n">blade_fill_rect</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">copy_rect</span> <span class="o">=</span> <span class="n">blade_copy_rect</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">image_blit</span> <span class="o">=</span> <span class="n">blade_image_blit</span><span class="p">;</span>
		<span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_TRIDENT_BLADE3D</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip3D</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* 3DImage family left */</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">init_accel</span> <span class="o">=</span> <span class="n">image_init_accel</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">wait_engine</span> <span class="o">=</span> <span class="n">image_wait_engine</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">fill_rect</span> <span class="o">=</span> <span class="n">image_fill_rect</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">copy_rect</span> <span class="o">=</span> <span class="n">image_copy_rect</span><span class="p">;</span>
		<span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_TRIDENT_3DIMAGE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 				<span class="cm">/* TGUI 9440/96XX family */</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">init_accel</span> <span class="o">=</span> <span class="n">tgui_init_accel</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">wait_engine</span> <span class="o">=</span> <span class="n">xp_wait_engine</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">fill_rect</span> <span class="o">=</span> <span class="n">tgui_fill_rect</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">copy_rect</span> <span class="o">=</span> <span class="n">tgui_copy_rect</span><span class="p">;</span>
		<span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_TRIDENT_TGUI</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">chip_id</span><span class="p">;</span>

	<span class="cm">/* setup MMIO region */</span>
	<span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span>
				<span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">,</span> <span class="s">&quot;tridentfb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;request_region failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">io_virt</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span>
					       <span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">enable_mmio</span><span class="p">(</span><span class="n">default_par</span><span class="p">);</span>

	<span class="cm">/* setup framebuffer memory */</span>
	<span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">get_memsize</span><span class="p">(</span><span class="n">default_par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
				<span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span> <span class="s">&quot;tridentfb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;request_mem_region failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">disable_mmio</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
					    <span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">flatpanel</span> <span class="o">=</span> <span class="n">is_flatpanel</span><span class="p">(</span><span class="n">default_par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">flatpanel</span><span class="p">)</span>
		<span class="n">nativex</span> <span class="o">=</span> <span class="n">get_nativex</span><span class="p">(</span><span class="n">default_par</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">tridentfb_fix</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tridentfb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">default_par</span><span class="o">-&gt;</span><span class="n">pseudo_pal</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">noaccel</span> <span class="o">&amp;&amp;</span> <span class="n">default_par</span><span class="o">-&gt;</span><span class="n">init_accel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_COPYAREA</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_FILLRECT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_blade</span><span class="p">(</span><span class="n">chip_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip_id</span> <span class="o">!=</span> <span class="n">BLADE3D</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_READS_FAST</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">buf_align</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">access_align</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FB_PIXMAP_SYSTEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">image_blit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_IMAGEBLIT</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">noaccel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;disabling acceleration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span>
			  <span class="n">mode_option</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bpp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unmap2</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">|=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tridentfb: could not register framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">output</span><span class="p">(</span><span class="s">&quot;fb%d: %s frame buffer device %dx%d-%dbpp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span>
	   <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unmap2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">disable_mmio</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
<span class="nl">out_unmap1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">trident_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tridentfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">io_virt</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">tridentfb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* List of boards that we are trying to support */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">trident_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">BLADE3D</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBERBLADEi7</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBERBLADEi7D</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBERBLADEi1</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBERBLADEi1D</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBERBLADEAi1</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBERBLADEAi1D</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBERBLADEE4</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">TGUI9440</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">TGUI9660</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">IMAGE975</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">IMAGE985</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBER9320</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBER9388</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBER9520</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBER9525DVD</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBER9397</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBER9397DVD</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBERBLADEXPAi1</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBERBLADEXPm8</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_TRIDENT</span><span class="p">,</span>	<span class="n">CYBERBLADEXPm16</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">trident_devices</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">tridentfb_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tridentfb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">trident_devices</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">trident_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">trident_pci_remove</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Parse user specified options (`video=trident:&#39;)</span>
<span class="cm"> * example:</span>
<span class="cm"> *	video=trident:800x600,bpp=16,noaccel</span>
<span class="cm"> */</span>
<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tridentfb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;noaccel&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">noaccel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;fp&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">fp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;crt&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;bpp=&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">bpp</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">opt</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;center&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">center</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;stretch&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">stretch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;memsize=&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">memsize</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">opt</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;memdiff=&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">memdiff</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">opt</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;nativex=&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">nativex</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">opt</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tridentfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;tridentfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">tridentfb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tridentfb_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tridentfb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tridentfb_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tridentfb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tridentfb_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jani Monoses &lt;jani@iv.ro&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Framebuffer driver for Trident cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;cyblafb&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
