<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › pxafb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pxafb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/video/pxafb.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1999 Eric A. Thomas.</span>
<span class="cm"> *  Copyright (C) 2004 Jean-Frederic Clere.</span>
<span class="cm"> *  Copyright (C) 2004 Ian Campbell.</span>
<span class="cm"> *  Copyright (C) 2004 Jeff Lackey.</span>
<span class="cm"> *   Based on sa1100fb.c Copyright (C) 1999 Eric A. Thomas</span>
<span class="cm"> *  which in turn is</span>
<span class="cm"> *   Based on acornfb.c Copyright (C) Russell King.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> *	        Intel PXA250/210 LCD Controller Frame Buffer Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Please direct your questions and comments on this driver to the following</span>
<span class="cm"> * email address:</span>
<span class="cm"> *</span>
<span class="cm"> *	linux-arm-kernel@lists.arm.linux.org.uk</span>
<span class="cm"> *</span>
<span class="cm"> * Add support for overlay1 and overlay2 based on pxafb_overlay.c:</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) 2004, Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> *     2003/08/27: &lt;yu.tang@intel.com&gt;</span>
<span class="cm"> *     2004/03/10: &lt;stanley.cai@intel.com&gt;</span>
<span class="cm"> *     2004/10/28: &lt;yan.yin@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) 2006-2008 Marvell International Ltd.</span>
<span class="cm"> *   All Rights Reserved</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &lt;mach/bitfield.h&gt;</span>
<span class="cp">#include &lt;mach/pxafb.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Complain if VAR is out of range.</span>
<span class="cm"> */</span>
<span class="cp">#define DEBUG_VAR 1</span>

<span class="cp">#include &quot;pxafb.h&quot;</span>

<span class="cm">/* Bits which should not be set in machine configuration structures */</span>
<span class="cp">#define LCCR0_INVALID_CONFIG_MASK	(LCCR0_OUM | LCCR0_BM | LCCR0_QDM |\</span>
<span class="cp">					 LCCR0_DIS | LCCR0_EFM | LCCR0_IUM |\</span>
<span class="cp">					 LCCR0_SFM | LCCR0_LDM | LCCR0_ENB)</span>

<span class="cp">#define LCCR3_INVALID_CONFIG_MASK	(LCCR3_HSP | LCCR3_VSP |\</span>
<span class="cp">					 LCCR3_PCD | LCCR3_BPP(0xf))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pxafb_activate_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_ctrlr_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">setup_base_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
                             <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="kt">int</span> <span class="n">branch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_frame_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pal</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">video_mem_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">lcd_readl</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lcd_writel</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pxafb_schedule_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to handle two requests being made at the same time.</span>
<span class="cm">	 * There are two important cases:</span>
<span class="cm">	 *  1. When we are changing VT (C_REENABLE) while unblanking</span>
<span class="cm">	 *     (C_ENABLE) We must perform the unblanking, which will</span>
<span class="cm">	 *     do our REENABLE for us.</span>
<span class="cm">	 *  2. When we are blanking, but immediately unblank before</span>
<span class="cm">	 *     we have blanked.  We do the &quot;REENABLE&quot; thing here as</span>
<span class="cm">	 *     well, just to be sure.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task_state</span> <span class="o">==</span> <span class="n">C_ENABLE</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="n">C_REENABLE</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task_state</span> <span class="o">==</span> <span class="n">C_DISABLE</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="n">C_ENABLE</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">C_REENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_int</span> <span class="nf">chan_to_field</span><span class="p">(</span><span class="n">u_int</span> <span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_bitfield</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pxafb_setpalettereg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
		       <span class="n">u_int</span> <span class="n">trans</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_cpu</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr4</span> <span class="o">&amp;</span> <span class="n">LCCR4_PAL_FOR_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LCCR4_PAL_FOR_0</span>:
		<span class="n">val</span>  <span class="o">=</span> <span class="p">((</span><span class="n">red</span>   <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">green</span> <span class="o">&gt;&gt;</span>  <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07e0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">blue</span>  <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x001f</span><span class="p">);</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_cpu</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LCCR4_PAL_FOR_1</span>:
		<span class="n">val</span>  <span class="o">=</span> <span class="p">((</span><span class="n">red</span>   <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00f80000</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000fc00</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">blue</span>  <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000f8</span><span class="p">);</span>
		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_cpu</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LCCR4_PAL_FOR_2</span>:
		<span class="n">val</span>  <span class="o">=</span> <span class="p">((</span><span class="n">red</span>   <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00fc0000</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000fc00</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">blue</span>  <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000fc</span><span class="p">);</span>
		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_cpu</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LCCR4_PAL_FOR_3</span>:
		<span class="n">val</span>  <span class="o">=</span> <span class="p">((</span><span class="n">red</span>   <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">blue</span>  <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">);</span>
		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_cpu</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pxafb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
		   <span class="n">u_int</span> <span class="n">trans</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If inverse mode was selected, invert all the colours</span>
<span class="cm">	 * rather than the register number.  The register number</span>
<span class="cm">	 * is what you poke into the framebuffer to produce the</span>
<span class="cm">	 * colour you requested.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap_inverse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">red</span>   <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">-</span> <span class="n">red</span><span class="p">;</span>
		<span class="n">green</span> <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">-</span> <span class="n">green</span><span class="p">;</span>
		<span class="n">blue</span>  <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">-</span> <span class="n">blue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If greyscale is true, then we convert the RGB value</span>
<span class="cm">	 * to greyscale no matter what visual we are using.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">green</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="mi">19595</span> <span class="o">*</span> <span class="n">red</span> <span class="o">+</span> <span class="mi">38470</span> <span class="o">*</span> <span class="n">green</span> <span class="o">+</span>
					<span class="mi">7471</span> <span class="o">*</span> <span class="n">blue</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * 16-bit True Colour.  We encode the RGB value</span>
<span class="cm">		 * according to the RGB bitfield information.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">;</span>

			<span class="n">val</span>  <span class="o">=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">);</span>

			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span>:
	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pxafb_setpalettereg</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* calculate pixel depth, transparency bit included, &gt;=16bpp formats _only_ */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">var_to_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* calculate 4-bit BPP value for LCCR3 and OVLxC1 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxafb_var_to_bpp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:  <span class="n">bpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:  <span class="n">bpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:  <span class="n">bpp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:  <span class="n">bpp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">var_to_depth</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">18</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* 18-bits/pixel packed */</span>
		<span class="k">case</span> <span class="mi">19</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* 19-bits/pixel packed */</span>
		<span class="k">case</span> <span class="mi">24</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">var_to_depth</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">18</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* 18-bits/pixel unpacked */</span>
		<span class="k">case</span> <span class="mi">19</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* 19-bits/pixel unpacked */</span>
		<span class="k">case</span> <span class="mi">25</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bpp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  pxafb_var_to_lccr3():</span>
<span class="cm"> *    Convert a bits per pixel value to the correct bit pattern for LCCR3</span>
<span class="cm"> *</span>
<span class="cm"> *  NOTE: for PXA27x with overlays support, the LCCR3_PDFOR_x bits have an</span>
<span class="cm"> *  implication of the acutal use of transparency bit,  which we handle it</span>
<span class="cm"> *  here separatedly. See PXA27x Developer&#39;s Manual, Section &lt;&lt;7.4.6 Pixel</span>
<span class="cm"> *  Formats&gt;&gt; for the valid combination of PDFOR, PAL_FOR for various BPP.</span>
<span class="cm"> *</span>
<span class="cm"> *  Transparency for palette pixel formats is not supported at the moment.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">pxafb_var_to_lccr3</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">pxafb_var_to_bpp</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">lccr3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lccr3</span> <span class="o">=</span> <span class="n">LCCR3_BPP</span><span class="p">(</span><span class="n">bpp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var_to_depth</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>: <span class="n">lccr3</span> <span class="o">|=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">?</span> <span class="n">LCCR3_PDFOR_3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">18</span>: <span class="n">lccr3</span> <span class="o">|=</span> <span class="n">LCCR3_PDFOR_3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>: <span class="n">lccr3</span> <span class="o">|=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">?</span> <span class="n">LCCR3_PDFOR_2</span> <span class="o">:</span> <span class="n">LCCR3_PDFOR_3</span><span class="p">;</span>
		 <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">19</span>:
	<span class="k">case</span> <span class="mi">25</span>: <span class="n">lccr3</span> <span class="o">|=</span> <span class="n">LCCR3_PDFOR_0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lccr3</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SET_PIXFMT(v, r, g, b, t)				\</span>
<span class="cp">({								\</span>
<span class="cp">	(v)-&gt;transp.offset = (t) ? (r) + (g) + (b) : 0;		\</span>
<span class="cp">	(v)-&gt;transp.length = (t) ? (t) : 0;			\</span>
<span class="cp">	(v)-&gt;blue.length   = (b); (v)-&gt;blue.offset = 0;		\</span>
<span class="cp">	(v)-&gt;green.length  = (g); (v)-&gt;green.offset = (b);	\</span>
<span class="cp">	(v)-&gt;red.length    = (r); (v)-&gt;red.offset = (b) + (g);	\</span>
<span class="cp">})</span>

<span class="cm">/* set the RGBT bitfields of fb_var_screeninf according to</span>
<span class="cm"> * var-&gt;bits_per_pixel and given depth</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxafb_set_pixfmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* indexed pixel formats */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>   <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>: <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">?</span>
		 <span class="n">SET_PIXFMT</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span>		<span class="cm">/* RGBT555 */</span>
		 <span class="n">SET_PIXFMT</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>	<span class="cm">/* RGB565 */</span>
	<span class="k">case</span> <span class="mi">18</span>: <span class="n">SET_PIXFMT</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>	<span class="cm">/* RGB666 */</span>
	<span class="k">case</span> <span class="mi">19</span>: <span class="n">SET_PIXFMT</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>	<span class="cm">/* RGBT666 */</span>
	<span class="k">case</span> <span class="mi">24</span>: <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">?</span>
		 <span class="n">SET_PIXFMT</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span>		<span class="cm">/* RGBT887 */</span>
		 <span class="n">SET_PIXFMT</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>	<span class="cm">/* RGB888 */</span>
	<span class="k">case</span> <span class="mi">25</span>: <span class="n">SET_PIXFMT</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>	<span class="cm">/* RGBT888 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
<span class="cm">/*</span>
<span class="cm"> *  pxafb_display_dma_period()</span>
<span class="cm"> *    Calculate the minimum period (in picoseconds) between two DMA</span>
<span class="cm"> *    requests for the LCD controller.  If we hit this, it means we&#39;re</span>
<span class="cm"> *    doing nothing but LCD DMA.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pxafb_display_dma_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Period = pixclock * bits_per_byte * bytes_per_transfer</span>
<span class="cm">	 *              / memory_bits_per_pixel;</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Select the smallest mode that allows the desired resolution to be</span>
<span class="cm"> * displayed. If desired parameters can be rounded up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="o">*</span><span class="nf">pxafb_getmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="o">*</span><span class="n">mach</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="o">*</span><span class="n">modelist</span> <span class="o">=</span> <span class="n">mach</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">best_x</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">best_y</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mach</span><span class="o">-&gt;</span><span class="n">num_modes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">modelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xres</span> <span class="o">&gt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&amp;&amp;</span>
		    <span class="n">modelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">yres</span> <span class="o">&gt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&amp;&amp;</span>
		    <span class="n">modelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="n">best_x</span> <span class="o">&amp;&amp;</span>
		    <span class="n">modelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="n">best_y</span> <span class="o">&amp;&amp;</span>
		    <span class="n">modelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bpp</span> <span class="o">&gt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_x</span> <span class="o">=</span> <span class="n">modelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xres</span><span class="p">;</span>
			<span class="n">best_y</span> <span class="o">=</span> <span class="n">modelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">yres</span><span class="p">;</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">modelist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxafb_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span>		<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span>		<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span>	<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span>		<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span>		<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span>		<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span>		<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">cmap_greyscale</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">transparency</span><span class="p">;</span>

	<span class="cm">/* set the initial RGBA bitfields */</span>
	<span class="n">pxafb_set_pixfmt</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxafb_adjust_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">line_length</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">MIN_XRES</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">MIN_YRES</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_LCDT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clamp_val</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">clamp_val</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">clamp_val</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">clamp_val</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">clamp_val</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">clamp_val</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* make sure each line is aligned on word boundary */</span>
	<span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">line_length</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">line_length</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">line_length</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="cm">/* we don&#39;t support xpan, force xres_virtual to be equal to xres */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">&amp;</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">/</span> <span class="n">line_length</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>

	<span class="cm">/* check for limits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">MAX_XRES</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">MAX_YRES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  pxafb_check_var():</span>
<span class="cm"> *    Get the video params out of &#39;var&#39;. If a value doesn&#39;t fit, round it up,</span>
<span class="cm"> *    if it&#39;s too big, return -EINVAL.</span>
<span class="cm"> *</span>
<span class="cm"> *    Round up in the following order: bits_per_pixel, xres,</span>
<span class="cm"> *    yres, xres_virtual, yres_virtual, xoffset, yoffset, grayscale,</span>
<span class="cm"> *    bitfields, horizontal timing, vertical timing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxafb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="o">*</span><span class="n">inf</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">fixed_modes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

		<span class="n">mode</span> <span class="o">=</span> <span class="n">pxafb_getmode</span><span class="p">(</span><span class="n">inf</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">pxafb_setmode</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* do a test conversion to BPP fields to check the color formats */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pxafb_var_to_bpp</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pxafb_set_pixfmt</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">var_to_depth</span><span class="p">(</span><span class="n">var</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pxafb_adjust_timing</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pxafb: dma period = %d ps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pxafb_display_dma_period</span><span class="p">(</span><span class="n">var</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pxafb_set_par():</span>
<span class="cm"> *	Set the user defined part of the display for the specified console</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxafb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap_static</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Some people have weird ideas about wanting static</span>
<span class="cm">		 * pseudocolor maps.  I suspect their user space</span>
<span class="cm">		 * applications are broken.</span>
<span class="cm">		 */</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span>
				  <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_size</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span>
					<span class="mi">4</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_cpu</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pxafb_activate_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxafb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">newvar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_MAX</span> <span class="o">+</span> <span class="n">DMA_BASE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">C_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Only take .xoffset, .yoffset and .vmode &amp; FB_VMODE_YWRAP from what</span>
<span class="cm">	 * was passed in and copy the rest from the old screeninfo.</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newvar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">newvar</span><span class="p">));</span>
	<span class="n">newvar</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">newvar</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="n">newvar</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>
	<span class="n">newvar</span><span class="p">.</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>

	<span class="n">setup_base_frame</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newvar</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_SDS</span><span class="p">)</span>
		<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FBR1</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">dma</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FBR0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">dma</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pxafb_blank():</span>
<span class="cm"> *	Blank the display by setting all palette values to zero.  Note, the</span>
<span class="cm"> * 	16 bpp mode does not really use the palette, so this will not</span>
<span class="cm"> *      blank the display in all modes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxafb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">||</span>
		    <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pxafb_setpalettereg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

		<span class="n">pxafb_schedule_work</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_DISABLE</span><span class="p">);</span>
		<span class="cm">/* TODO if (pxafb_blank_helper) pxafb_blank_helper(blank); */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="cm">/* TODO if (pxafb_blank_helper) pxafb_blank_helper(blank); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">||</span>
		    <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span><span class="p">)</span>
			<span class="n">fb_set_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">pxafb_schedule_work</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">pxafb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">pxafb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">pxafb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">pxafb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">pxafb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">pxafb_blank</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_FB_PXA_OVERLAY</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">overlay1fb_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem_phys</span><span class="p">;</span>
	<span class="n">setup_frame_dma</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">DMA_OV1</span><span class="p">,</span> <span class="n">PAL_NONE</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Depending on the enable status of overlay1/2, the DMA should be</span>
<span class="cm"> * updated from FDADRx (when disabled) or FBRx (when enabled).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">overlay1fb_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">enabled</span> <span class="o">=</span> <span class="n">lcd_readl</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">OVL1C1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OVLxC1_OEN</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fdadr1</span> <span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">DMA_OV1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">?</span> <span class="mh">0x1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">enabled</span> <span class="o">?</span> <span class="n">FBR1</span> <span class="o">:</span> <span class="n">FDADR1</span><span class="p">,</span> <span class="n">fdadr1</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">OVL1C2</span><span class="p">,</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">OVL1C1</span><span class="p">,</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">OVLxC1_OEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">overlay1fb_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">lccr5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lcd_readl</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">OVL1C1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OVLxC1_OEN</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">lccr5</span> <span class="o">=</span> <span class="n">lcd_readl</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR5</span><span class="p">);</span>

	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">OVL1C1</span><span class="p">,</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OVLxC1_OEN</span><span class="p">);</span>

	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCSR1</span><span class="p">,</span> <span class="n">LCSR1_BS</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR5</span><span class="p">,</span> <span class="n">lccr5</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCSR1_BS</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FBR1</span><span class="p">,</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">DMA_OV1</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">branch_done</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: timeout disabling overlay1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR5</span><span class="p">,</span> <span class="n">lccr5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">overlay2fb_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pfor</span> <span class="o">=</span> <span class="n">NONSTD_TO_PFOR</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">nonstd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem_phys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfor</span> <span class="o">==</span> <span class="n">OVERLAY_FORMAT_RGB</span> <span class="o">||</span> <span class="n">pfor</span> <span class="o">==</span> <span class="n">OVERLAY_FORMAT_YUV444_PACKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
		<span class="n">setup_frame_dma</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">DMA_OV2_Y</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pfor</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OVERLAY_FORMAT_YUV444_PLANAR</span>: <span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OVERLAY_FORMAT_YUV422_PLANAR</span>: <span class="n">div</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OVERLAY_FORMAT_YUV420_PLANAR</span>: <span class="n">div</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">start</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">size</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
		<span class="n">setup_frame_dma</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">DMA_OV2_Y</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">setup_frame_dma</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">DMA_OV2_Cb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span> <span class="o">/</span> <span class="n">div</span><span class="p">);</span>
		<span class="n">setup_frame_dma</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">DMA_OV2_Cr</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">size</span> <span class="o">/</span> <span class="n">div</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">overlay2fb_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pfor</span> <span class="o">=</span> <span class="n">NONSTD_TO_PFOR</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">nonstd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">enabled</span> <span class="o">=</span> <span class="n">lcd_readl</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">OVL2C1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OVLxC1_OEN</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fdadr2</span> <span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">DMA_OV2_Y</span><span class="p">]</span>  <span class="o">|</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">?</span> <span class="mh">0x1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">fdadr3</span> <span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">DMA_OV2_Cb</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">?</span> <span class="mh">0x1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">fdadr4</span> <span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">DMA_OV2_Cr</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">?</span> <span class="mh">0x1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfor</span> <span class="o">==</span> <span class="n">OVERLAY_FORMAT_RGB</span> <span class="o">||</span> <span class="n">pfor</span> <span class="o">==</span> <span class="n">OVERLAY_FORMAT_YUV444_PACKED</span><span class="p">)</span>
		<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">enabled</span> <span class="o">?</span> <span class="n">FBR2</span> <span class="o">:</span> <span class="n">FDADR2</span><span class="p">,</span> <span class="n">fdadr2</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">enabled</span> <span class="o">?</span> <span class="n">FBR2</span> <span class="o">:</span> <span class="n">FDADR2</span><span class="p">,</span> <span class="n">fdadr2</span><span class="p">);</span>
		<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">enabled</span> <span class="o">?</span> <span class="n">FBR3</span> <span class="o">:</span> <span class="n">FDADR3</span><span class="p">,</span> <span class="n">fdadr3</span><span class="p">);</span>
		<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">enabled</span> <span class="o">?</span> <span class="n">FBR4</span> <span class="o">:</span> <span class="n">FDADR4</span><span class="p">,</span> <span class="n">fdadr4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">OVL2C2</span><span class="p">,</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">OVL2C1</span><span class="p">,</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">OVLxC1_OEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">overlay2fb_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">lccr5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lcd_readl</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">OVL2C1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OVLxC1_OEN</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">lccr5</span> <span class="o">=</span> <span class="n">lcd_readl</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR5</span><span class="p">);</span>

	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">OVL2C1</span><span class="p">,</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OVLxC1_OEN</span><span class="p">);</span>

	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCSR1</span><span class="p">,</span> <span class="n">LCSR1_BS</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR5</span><span class="p">,</span> <span class="n">lccr5</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCSR1_BS</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FBR2</span><span class="p">,</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">DMA_OV2_Y</span><span class="p">]</span>  <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FBR3</span><span class="p">,</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">DMA_OV2_Cb</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FBR4</span><span class="p">,</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">DMA_OV2_Cr</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">branch_done</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: timeout disabling overlay2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxafb_layer_ops</span> <span class="n">ofb_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">overlay1fb_enable</span><span class="p">,</span>
		<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">overlay1fb_disable</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">overlay1fb_setup</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">overlay2fb_enable</span><span class="p">,</span>
		<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">overlay2fb_disable</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">overlay2fb_setup</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">overlayfb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>

	<span class="cm">/* no support for framebuffer console on overlay */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">usage</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unblank the base framebuffer */</span>
		<span class="n">console_lock</span><span class="p">();</span>
		<span class="n">fb_blank</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">,</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">);</span>
		<span class="n">console_unlock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">overlayfb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_layer</span><span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">ofb</span><span class="p">);</span>
		<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">usage</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">overlayfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">base_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">pfor</span><span class="p">,</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="n">xpos</span> <span class="o">=</span> <span class="n">NONSTD_TO_XPOS</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">);</span>
	<span class="n">ypos</span> <span class="o">=</span> <span class="n">NONSTD_TO_YPOS</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">);</span>
	<span class="n">pfor</span> <span class="o">=</span> <span class="n">NONSTD_TO_PFOR</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">);</span>

	<span class="n">bpp</span> <span class="o">=</span> <span class="n">pxafb_var_to_bpp</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* no support for YUV format on overlay1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">OVERLAY1</span> <span class="o">&amp;&amp;</span> <span class="n">pfor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* for YUV packed formats, bpp = &#39;minimum bpp of YUV components&#39; */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pfor</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OVERLAY_FORMAT_RGB</span>:
		<span class="n">bpp</span> <span class="o">=</span> <span class="n">pxafb_var_to_bpp</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">pxafb_set_pixfmt</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">var_to_depth</span><span class="p">(</span><span class="n">var</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OVERLAY_FORMAT_YUV444_PACKED</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OVERLAY_FORMAT_YUV444_PLANAR</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OVERLAY_FORMAT_YUV422_PLANAR</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OVERLAY_FORMAT_YUV420_PLANAR</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* each line must start at a 32-bit word boundary */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">xpos</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">)</span> <span class="o">%</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* xres must align on 32-bit word boundary */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">xpos</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">base_var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ypos</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">base_var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">overlayfb_check_video_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pfor</span> <span class="o">=</span> <span class="n">NONSTD_TO_PFOR</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">bpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pfor</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OVERLAY_FORMAT_RGB</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OVERLAY_FORMAT_YUV444_PACKED</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OVERLAY_FORMAT_YUV444_PLANAR</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OVERLAY_FORMAT_YUV422_PLANAR</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OVERLAY_FORMAT_YUV420_PLANAR</span>: <span class="n">bpp</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem_size</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">overlayfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">pfor</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">overlayfb_check_video_memory</span><span class="p">(</span><span class="n">ofb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">bpp</span>  <span class="o">=</span> <span class="n">pxafb_var_to_bpp</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
	<span class="n">xpos</span> <span class="o">=</span> <span class="n">NONSTD_TO_XPOS</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">);</span>
	<span class="n">ypos</span> <span class="o">=</span> <span class="n">NONSTD_TO_YPOS</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">);</span>
	<span class="n">pfor</span> <span class="o">=</span> <span class="n">NONSTD_TO_PFOR</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">);</span>

	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OVLxC1_PPL</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">|</span> <span class="n">OVLxC1_LPO</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="o">|</span>
			  <span class="n">OVLxC1_BPP</span><span class="p">(</span><span class="n">bpp</span><span class="p">);</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">OVLxC2_XPOS</span><span class="p">(</span><span class="n">xpos</span><span class="p">)</span> <span class="o">|</span> <span class="n">OVLxC2_YPOS</span><span class="p">(</span><span class="n">ypos</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">OVERLAY2</span><span class="p">)</span>
		<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">OVL2C2_PFOR</span><span class="p">(</span><span class="n">pfor</span><span class="p">);</span>

	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">ofb</span><span class="p">);</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">ofb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">overlay_fb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>		<span class="o">=</span> <span class="n">overlayfb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>		<span class="o">=</span> <span class="n">overlayfb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span> 		<span class="o">=</span> <span class="n">overlayfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>		<span class="o">=</span> <span class="n">overlayfb_set_par</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">init_pxafb_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;overlay%d&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span>		<span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>

	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fbops</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">overlay_fb_ops</span><span class="p">;</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">node</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">pseudo_palette</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofb_ops</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">branch_done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pxafb_overlay_supported</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_pxa27x</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_pxa3xx</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pxafb_overlay_map_video_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">pxafb</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We assume that user will use at most video_mem_size for overlay fb,</span>
<span class="cm">	 * anyway, it&#39;s useless to use 16bpp main plane and 24bpp overlay</span>
<span class="cm">	 */</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem</span> <span class="o">=</span> <span class="n">alloc_pages_exact</span><span class="p">(</span><span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">pxafb</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">),</span>
		<span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem_phys</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem</span><span class="p">);</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem_size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">pxafb</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span>	<span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem_phys</span><span class="p">;</span>
	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span>	<span class="o">=</span> <span class="n">pxafb</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">mm_lock</span><span class="p">);</span>

	<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">screen_base</span>	<span class="o">=</span> <span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pxafb_overlay_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pxafb_overlay_supported</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">init_pxafb_overlay</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">ofb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register overlay %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pxafb_overlay_map_video_memory</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">ofb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to map video memory for overlay %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">);</span>
			<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* mask all IU/BS/EOF/SOF interrupts */</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR5</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PXA Overlay driver loaded successfully!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">pxafb_overlay_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pxafb_overlay_supported</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pxafb_layer</span> <span class="o">*</span><span class="n">ofb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">registered</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem</span><span class="p">)</span>
				<span class="n">free_pages_exact</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem</span><span class="p">,</span>
					<span class="n">ofb</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">);</span>
			<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pxafb_overlay_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pxafb_overlay_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_PXA_OVERLAY */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Calculate the PCD value from the clock rate (in picoseconds).</span>
<span class="cm"> * We take account of the PPCR clock setting.</span>
<span class="cm"> * From PXA Developer&#39;s Manual:</span>
<span class="cm"> *</span>
<span class="cm"> *   PixelClock =      LCLK</span>
<span class="cm"> *                -------------</span>
<span class="cm"> *                2 ( PCD + 1 )</span>
<span class="cm"> *</span>
<span class="cm"> *   PCD =      LCLK</span>
<span class="cm"> *         ------------- - 1</span>
<span class="cm"> *         2(PixelClock)</span>
<span class="cm"> *</span>
<span class="cm"> * Where:</span>
<span class="cm"> *   LCLK = LCD/Memory Clock</span>
<span class="cm"> *   PCD = LCCR3[7:0]</span>
<span class="cm"> *</span>
<span class="cm"> * PixelClock here is in Hz while the pixclock argument given is the</span>
<span class="cm"> * period in picoseconds. Hence PixelClock = 1 / ( pixclock * 10^-12 )</span>
<span class="cm"> *</span>
<span class="cm"> * The function get_lclk_frequency_10khz returns LCLK in units of</span>
<span class="cm"> * 10khz. Calling the result of this function lclk gives us the</span>
<span class="cm"> * following</span>
<span class="cm"> *</span>
<span class="cm"> *    PCD = (lclk * 10^4 ) * ( pixclock * 10^-12 )</span>
<span class="cm"> *          -------------------------------------- - 1</span>
<span class="cm"> *                          2</span>
<span class="cm"> *</span>
<span class="cm"> * Factoring the 10^4 and 10^-12 out gives 10^-8 == 1 / 100000000 as used below.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_pcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixclock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">pcd</span><span class="p">;</span>

	<span class="cm">/* FIXME: Need to take into account Double Pixel Clock mode</span>
<span class="cm">	 * (DPC) bit? or perhaps set it based on the various clock</span>
<span class="cm">	 * speeds */</span>
	<span class="n">pcd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">clk_get_rate</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">);</span>
	<span class="n">pcd</span> <span class="o">*=</span> <span class="n">pixclock</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">pcd</span><span class="p">,</span> <span class="mi">100000000</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* no need for this, since we should subtract 1 anyway. they cancel */</span>
	<span class="cm">/* pcd += 1; */</span> <span class="cm">/* make up for integer math truncations */</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">pcd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Some touchscreens need hsync information from the video driver to</span>
<span class="cm"> * function correctly. We export it here.  Note that &#39;hsync_time&#39; and</span>
<span class="cm"> * the value returned from pxafb_get_hsync_time() is the *reciprocal*</span>
<span class="cm"> * of the hsync period in seconds.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_hsync_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">htime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pcd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">hsync_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">htime</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">pcd</span> <span class="o">*</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">hsync_time</span> <span class="o">=</span> <span class="n">htime</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pxafb_get_hsync_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* If display is blanked/suspended, hsync isn&#39;t active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span> <span class="o">||</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">C_ENABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">hsync_time</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pxafb_get_hsync_time</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_frame_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pal</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_dma_descriptor</span> <span class="o">*</span><span class="n">dma_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">pal_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_desc_off</span><span class="p">,</span> <span class="n">pal_desc_off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dma</span> <span class="o">&gt;=</span> <span class="n">DMA_MAX</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dma_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="o">-&gt;</span><span class="n">dma_desc</span><span class="p">[</span><span class="n">dma</span><span class="p">];</span>
	<span class="n">dma_desc_off</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_dma_buff</span><span class="p">,</span> <span class="n">dma_desc</span><span class="p">[</span><span class="n">dma</span><span class="p">]);</span>

	<span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">fsadr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">fidr</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">ldcmd</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pal</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pal</span> <span class="o">&gt;=</span> <span class="n">PAL_MAX</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">fdadr</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_phys</span> <span class="o">+</span> <span class="n">dma_desc_off</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">dma</span><span class="p">]</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_phys</span> <span class="o">+</span> <span class="n">dma_desc_off</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pal_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="o">-&gt;</span><span class="n">pal_desc</span><span class="p">[</span><span class="n">pal</span><span class="p">];</span>
		<span class="n">pal_desc_off</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_dma_buff</span><span class="p">,</span> <span class="n">pal_desc</span><span class="p">[</span><span class="n">pal</span><span class="p">]);</span>

		<span class="n">pal_desc</span><span class="o">-&gt;</span><span class="n">fsadr</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_phys</span> <span class="o">+</span> <span class="n">pal</span> <span class="o">*</span> <span class="n">PALETTE_SIZE</span><span class="p">;</span>
		<span class="n">pal_desc</span><span class="o">-&gt;</span><span class="n">fidr</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr4</span> <span class="o">&amp;</span> <span class="n">LCCR4_PAL_FOR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">LCCR4_PAL_FOR_0</span><span class="p">)</span>
			<span class="n">pal_desc</span><span class="o">-&gt;</span><span class="n">ldcmd</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pal_desc</span><span class="o">-&gt;</span><span class="n">ldcmd</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="n">pal_desc</span><span class="o">-&gt;</span><span class="n">ldcmd</span> <span class="o">|=</span> <span class="n">LDCMD_PAL</span><span class="p">;</span>

		<span class="cm">/* flip back and forth between palette and frame buffer */</span>
		<span class="n">pal_desc</span><span class="o">-&gt;</span><span class="n">fdadr</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_phys</span> <span class="o">+</span> <span class="n">dma_desc_off</span><span class="p">;</span>
		<span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">fdadr</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_phys</span> <span class="o">+</span> <span class="n">pal_desc_off</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">dma</span><span class="p">]</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_phys</span> <span class="o">+</span> <span class="n">dma_desc_off</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_base_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
                             <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
                             <span class="kt">int</span> <span class="n">branch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">pal</span><span class="p">,</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">branch</span> <span class="o">?</span> <span class="n">DMA_MAX</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pal</span> <span class="o">=</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="n">PAL_NONE</span> <span class="o">:</span> <span class="n">PAL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">branch</span> <span class="o">?</span> <span class="n">PAL_MAX</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">nbytes</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_phys</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_SDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nbytes</span> <span class="o">=</span> <span class="n">nbytes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">setup_frame_dma</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">dma</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PAL_NONE</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">setup_frame_dma</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">pal</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_PXA_SMARTPANEL</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_smart_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_dma_descriptor</span> <span class="o">*</span><span class="n">dma_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_desc_off</span><span class="p">,</span> <span class="n">cmd_buff_off</span><span class="p">;</span>

	<span class="n">dma_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="o">-&gt;</span><span class="n">dma_desc</span><span class="p">[</span><span class="n">DMA_CMD</span><span class="p">];</span>
	<span class="n">dma_desc_off</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_dma_buff</span><span class="p">,</span> <span class="n">dma_desc</span><span class="p">[</span><span class="n">DMA_CMD</span><span class="p">]);</span>
	<span class="n">cmd_buff_off</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_dma_buff</span><span class="p">,</span> <span class="n">cmd_buff</span><span class="p">);</span>

	<span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">fdadr</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_phys</span> <span class="o">+</span> <span class="n">dma_desc_off</span><span class="p">;</span>
	<span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">fsadr</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_phys</span> <span class="o">+</span> <span class="n">cmd_buff_off</span><span class="p">;</span>
	<span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">fidr</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">ldcmd</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">n_smart_cmds</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="n">DMA_CMD</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pxafb_smart_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxafb_info</span><span class="p">,</span> <span class="n">fb</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">prsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* disable controller until all registers are set up */</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_ENB</span><span class="p">);</span>

	<span class="cm">/* 1. make it an even number of commands to align on 32-bit boundary</span>
<span class="cm">	 * 2. add the interrupt command to the end of the chain so we can</span>
<span class="cm">	 *    keep track of the end of the transfer</span>
<span class="cm">	 */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">n_smart_cmds</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">smart_cmds</span><span class="p">[</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">n_smart_cmds</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMART_CMD_NOOP</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">smart_cmds</span><span class="p">[</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">n_smart_cmds</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMART_CMD_INTERRUPT</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">smart_cmds</span><span class="p">[</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">n_smart_cmds</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMART_CMD_WAIT_FOR_VSYNC</span><span class="p">;</span>
	<span class="n">setup_smart_dma</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="cm">/* continue to execute next command */</span>
	<span class="n">prsr</span> <span class="o">=</span> <span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">PRSR</span><span class="p">)</span> <span class="o">|</span> <span class="n">PRSR_ST_OK</span> <span class="o">|</span> <span class="n">PRSR_CON_NT</span><span class="p">;</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">PRSR</span><span class="p">,</span> <span class="n">prsr</span><span class="p">);</span>

	<span class="cm">/* stop the processor in case it executed &quot;wait for sync&quot; cmd */</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">CMDCR</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>

	<span class="cm">/* don&#39;t send interrupts for fifo underruns on channel 6 */</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR5</span><span class="p">,</span> <span class="n">LCCR5_IUM</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span>

	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR1</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr1</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR2</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr2</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR3</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR4</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr4</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FDADR0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FDADR6</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

	<span class="cm">/* begin sending */</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">|</span> <span class="n">LCCR0_ENB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">command_done</span><span class="p">,</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: timeout waiting for command done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* quick disable */</span>
	<span class="n">prsr</span> <span class="o">=</span> <span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">PRSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PRSR_ST_OK</span> <span class="o">|</span> <span class="n">PRSR_CON_NT</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">PRSR</span><span class="p">,</span> <span class="n">prsr</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_ENB</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FDADR6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">n_smart_cmds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pxafb_smart_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">cmds</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_cmds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxafb_info</span><span class="p">,</span> <span class="n">fb</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_cmds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cmds</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if it is a software delay, flush and delay */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">cmds</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="n">SMART_CMD_DELAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pxafb_smart_flush</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="o">*</span><span class="n">cmds</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* leave 2 commands for INTERRUPT and WAIT_FOR_SYNC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">n_smart_cmds</span> <span class="o">==</span> <span class="n">CMD_BUFF_SIZE</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">pxafb_smart_flush</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">smart_cmds</span><span class="p">[</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">n_smart_cmds</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">cmds</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">__smart_timing</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">time_ns</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lcd_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_ns</span> <span class="o">*</span> <span class="p">(</span><span class="n">lcd_clk</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">t</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_smart_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="o">*</span><span class="n">inf</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lclk</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">t4</span><span class="p">;</span>

	<span class="n">t1</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">a0csrd_set_hld</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">a0cswr_set_hld</span><span class="p">);</span>
	<span class="n">t2</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">rd_pulse_width</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">wr_pulse_width</span><span class="p">);</span>
	<span class="n">t3</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">op_hold_time</span><span class="p">;</span>
	<span class="n">t4</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">cmd_inh_time</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr1</span> <span class="o">=</span>
		<span class="n">LCCR1_DisWdth</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">LCCR1_BegLnDel</span><span class="p">(</span><span class="n">__smart_timing</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">lclk</span><span class="p">))</span> <span class="o">|</span>
		<span class="n">LCCR1_EndLnDel</span><span class="p">(</span><span class="n">__smart_timing</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">lclk</span><span class="p">))</span> <span class="o">|</span>
		<span class="n">LCCR1_HorSnchWdth</span><span class="p">(</span><span class="n">__smart_timing</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="n">lclk</span><span class="p">));</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr2</span> <span class="o">=</span> <span class="n">LCCR2_DisHght</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">|</span> <span class="n">LCCR3_PixClkDiv</span><span class="p">(</span><span class="n">__smart_timing</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span> <span class="n">lclk</span><span class="p">));</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">|=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span> <span class="o">?</span> <span class="n">LCCR3_HSP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">|=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span> <span class="o">?</span> <span class="n">LCCR3_VSP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* FIXME: make this configurable */</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_cmdcr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxafb_smart_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="o">*</span><span class="n">inf</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">smart_update</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: not properly initialized, thread terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">inf</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s(): task starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">try_to_freeze</span><span class="p">())</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">C_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">smart_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">refresh_done</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_lock</span><span class="p">);</span>

		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">schedule_timeout</span><span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s(): task ending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxafb_smart_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_LCDT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">smart_cmds</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="o">-&gt;</span><span class="n">cmd_buff</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">n_smart_cmds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">command_done</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">refresh_done</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">smart_thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">pxafb_smart_thread</span><span class="p">,</span> <span class="n">fbi</span><span class="p">,</span>
					<span class="s">&quot;lcd_refresh&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">smart_thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: unable to create kernel thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">smart_thread</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pxafb_smart_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_PXA_SMARTPANEL */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_parallel_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lines_per_panel</span><span class="p">,</span> <span class="n">pcd</span> <span class="o">=</span> <span class="n">get_pcd</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr1</span> <span class="o">=</span>
		<span class="n">LCCR1_DisWdth</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR1_HorSnchWdth</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR1_BegLnDel</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR1_EndLnDel</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have a dual scan LCD, we need to halve</span>
<span class="cm">	 * the YRES parameter.</span>
<span class="cm">	 */</span>
	<span class="n">lines_per_panel</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_SDS</span><span class="p">)</span> <span class="o">==</span> <span class="n">LCCR0_Dual</span><span class="p">)</span>
		<span class="n">lines_per_panel</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr2</span> <span class="o">=</span>
		<span class="n">LCCR2_DisHght</span><span class="p">(</span><span class="n">lines_per_panel</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR2_VrtSnchWdth</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR2_BegFrmDel</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR2_EndFrmDel</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span> <span class="o">?</span>
		 <span class="n">LCCR3_HorSnchH</span> <span class="o">:</span> <span class="n">LCCR3_HorSnchL</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span> <span class="o">?</span>
		 <span class="n">LCCR3_VrtSnchH</span> <span class="o">:</span> <span class="n">LCCR3_VrtSnchL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">|=</span> <span class="n">LCCR3_PixClkDiv</span><span class="p">(</span><span class="n">pcd</span><span class="p">);</span>
		<span class="n">set_hsync_time</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">pcd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pxafb_activate_var():</span>
<span class="cm"> *	Configures LCD Controller based on entries in var parameter.</span>
<span class="cm"> *	Settings are only written to the controller if changes were made.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxafb_activate_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Update shadow copy atomically */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_PXA_SMARTPANEL</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_LCDT</span><span class="p">)</span>
		<span class="n">setup_smart_timing</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">setup_parallel_timing</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>

	<span class="n">setup_base_frame</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">LCCR0_LDM</span> <span class="o">|</span> <span class="n">LCCR0_SFM</span> <span class="o">|</span> <span class="n">LCCR0_IUM</span> <span class="o">|</span> <span class="n">LCCR0_EFM</span> <span class="o">|</span>
		 <span class="n">LCCR0_QDM</span> <span class="o">|</span> <span class="n">LCCR0_BM</span>  <span class="o">|</span> <span class="n">LCCR0_OUM</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">|=</span> <span class="n">pxafb_var_to_lccr3</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr4</span> <span class="o">=</span> <span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR4_PAL_FOR_MASK</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr4</span> <span class="o">|=</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr4</span> <span class="o">&amp;</span> <span class="n">LCCR4_PAL_FOR_MASK</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only update the registers if the controller is enabled</span>
<span class="cm">	 * and something has changed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR3</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR4</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr4</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FDADR0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_SDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FDADR1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
		<span class="n">pxafb_schedule_work</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_REENABLE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE!  The following functions are purely helpers for set_ctrlr_state.</span>
<span class="cm"> * Do not call them directly; set_ctrlr_state does the correct serialisation</span>
<span class="cm"> * to ensure that things happen in the right way 100% of time time.</span>
<span class="cm"> *	-- rmk</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__pxafb_backlight_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pxafb: backlight o%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">on</span> <span class="o">?</span> <span class="s">&quot;n&quot;</span> <span class="o">:</span> <span class="s">&quot;ff&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">backlight_power</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">backlight_power</span><span class="p">(</span><span class="n">on</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__pxafb_lcd_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pxafb: LCD power o%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">on</span> <span class="o">?</span> <span class="s">&quot;n&quot;</span> <span class="o">:</span> <span class="s">&quot;ff&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lcd_power</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lcd_power</span><span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxafb_enable_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pxafb: Enabling LCD controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;fdadr0 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;fdadr1 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;reg_lccr0 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;reg_lccr1 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr1</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;reg_lccr2 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr2</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;reg_lccr3 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span><span class="p">);</span>

	<span class="cm">/* enable LCD controller clock */</span>
	<span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_LCDT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Sequence from 11.7.10 */</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR4</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr4</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR3</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR2</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr2</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR1</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr1</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_ENB</span><span class="p">);</span>

	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FDADR0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_SDS</span><span class="p">)</span>
		<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">FDADR1</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fdadr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">|</span> <span class="n">LCCR0_ENB</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxafb_disable_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">lccr0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_PXA_SMARTPANEL</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_LCDT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">refresh_done</span><span class="p">,</span>
				<span class="mi">200</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Clear LCD Status Register */</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCSR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="n">lccr0</span> <span class="o">=</span> <span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_LDM</span><span class="p">;</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR0</span><span class="p">,</span> <span class="n">lccr0</span><span class="p">);</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR0</span><span class="p">,</span> <span class="n">lccr0</span> <span class="o">|</span> <span class="n">LCCR0_DIS</span><span class="p">);</span>

	<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">disable_done</span><span class="p">,</span> <span class="mi">200</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* disable LCD controller clock */</span>
	<span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  pxafb_handle_irq: Handle &#39;LCD DONE&#39; interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pxafb_handle_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lccr0</span><span class="p">,</span> <span class="n">lcsr</span><span class="p">;</span>

	<span class="n">lcsr</span> <span class="o">=</span> <span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcsr</span> <span class="o">&amp;</span> <span class="n">LCSR_LDD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lccr0</span> <span class="o">=</span> <span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR0</span><span class="p">);</span>
		<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCCR0</span><span class="p">,</span> <span class="n">lccr0</span> <span class="o">|</span> <span class="n">LCCR0_LDM</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">disable_done</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_PXA_SMARTPANEL</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcsr</span> <span class="o">&amp;</span> <span class="n">LCSR_CMD_INT</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">command_done</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCSR</span><span class="p">,</span> <span class="n">lcsr</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_PXA_OVERLAY</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lcsr1</span> <span class="o">=</span> <span class="n">lcd_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCSR1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lcsr1</span> <span class="o">&amp;</span> <span class="n">LCSR1_BS</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">branch_done</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lcsr1</span> <span class="o">&amp;</span> <span class="n">LCSR1_BS</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">branch_done</span><span class="p">);</span>

		<span class="n">lcd_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">LCSR1</span><span class="p">,</span> <span class="n">lcsr1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function must be called from task context only, since it will</span>
<span class="cm"> * sleep when disabling the LCD controller, or if we get two contending</span>
<span class="cm"> * processes trying to alter state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_ctrlr_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">old_state</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_lock</span><span class="p">);</span>

	<span class="n">old_state</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hack around fbcon initialisation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">C_STARTUP</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="n">C_REENABLE</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">C_ENABLE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">C_DISABLE_CLKCHANGE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Disable controller for clock change.  If the</span>
<span class="cm">		 * controller is already disabled, then do nothing.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_DISABLE</span> <span class="o">&amp;&amp;</span> <span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_DISABLE_PM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
			<span class="cm">/* TODO __pxafb_lcd_power(fbi, 0); */</span>
			<span class="n">pxafb_disable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">C_DISABLE_PM</span>:
	<span class="k">case</span> <span class="n">C_DISABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Disable controller</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_DISABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
			<span class="n">__pxafb_backlight_power</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">__pxafb_lcd_power</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_DISABLE_CLKCHANGE</span><span class="p">)</span>
				<span class="n">pxafb_disable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">C_ENABLE_CLKCHANGE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Enable the controller after clock change.  Only</span>
<span class="cm">		 * do this if we were disabled for the clock change.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">C_DISABLE_CLKCHANGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">C_ENABLE</span><span class="p">;</span>
			<span class="n">pxafb_enable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
			<span class="cm">/* TODO __pxafb_lcd_power(fbi, 1); */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">C_REENABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Re-enable the controller only if it was already</span>
<span class="cm">		 * enabled.  This is so we reprogram the control</span>
<span class="cm">		 * registers.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">C_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__pxafb_lcd_power</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pxafb_disable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
			<span class="n">pxafb_enable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
			<span class="n">__pxafb_lcd_power</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">C_ENABLE_PM</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Re-enable the controller after PM.  This is not</span>
<span class="cm">		 * perfect - think about the case where we were doing</span>
<span class="cm">		 * a clock change, and we suspended half-way through.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_DISABLE_PM</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>

	<span class="k">case</span> <span class="n">C_ENABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Power up the LCD screen, enable controller, and</span>
<span class="cm">		 * turn on the backlight.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">C_ENABLE</span><span class="p">;</span>
			<span class="n">pxafb_enable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
			<span class="n">__pxafb_lcd_power</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">__pxafb_backlight_power</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Our LCD controller task (which is called when we blank or unblank)</span>
<span class="cm"> * via keventd.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxafb_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxafb_info</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="n">u_int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task_state</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">set_ctrlr_state</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
<span class="cm">/*</span>
<span class="cm"> * CPU clock speed change handler.  We need to adjust the LCD timing</span>
<span class="cm"> * parameters when the CPU clock is adjusted by the power management</span>
<span class="cm"> * subsystem.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: Determine why f-&gt;new != 10*get_lclk_frequency_10khz()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pxafb_freq_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">TO_INF</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">freq_transition</span><span class="p">);</span>
	<span class="cm">/* TODO struct cpufreq_freqs *f = data; */</span>
	<span class="n">u_int</span> <span class="n">pcd</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPUFREQ_PRECHANGE</span>:
<span class="cp">#ifdef CONFIG_FB_PXA_OVERLAY</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">usage</span> <span class="o">||</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">usage</span><span class="p">))</span>
<span class="cp">#endif</span>
			<span class="n">set_ctrlr_state</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_DISABLE_CLKCHANGE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CPUFREQ_POSTCHANGE</span>:
		<span class="n">pcd</span> <span class="o">=</span> <span class="n">get_pcd</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">);</span>
		<span class="n">set_hsync_time</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">pcd</span><span class="p">);</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">=</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">LCCR3_PixClkDiv</span><span class="p">(</span><span class="n">pcd</span><span class="p">);</span>
		<span class="n">set_ctrlr_state</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_ENABLE_CLKCHANGE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pxafb_freq_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">TO_INF</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">freq_policy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPUFREQ_ADJUST</span>:
	<span class="k">case</span> <span class="n">CPUFREQ_INCOMPATIBLE</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;min dma period: %d ps, &quot;</span>
			<span class="s">&quot;new clock %d kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pxafb_display_dma_period</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
			<span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>
		<span class="cm">/* TODO: fill in min/max values */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * Power management hooks.  Note that we won&#39;t be called from IRQ context,</span>
<span class="cm"> * unlike the blank functions above, so we may sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxafb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">set_ctrlr_state</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_DISABLE_PM</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxafb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">set_ctrlr_state</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_ENABLE_PM</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">pxafb_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">pxafb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">pxafb_resume</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pxafb_init_video_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem</span> <span class="o">=</span> <span class="n">alloc_pages_exact</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_phys</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span>	<span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_phys</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span>	<span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">screen_base</span>	<span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxafb_decode_mach_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lcd_conn</span> <span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">lcd_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap_inverse</span>	<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">cmap_inverse</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap_static</span>	<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">cmap_static</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr4</span> 		<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr4</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lcd_conn</span> <span class="o">&amp;</span> <span class="n">LCD_TYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LCD_TYPE_MONO_STN</span>:
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="n">LCCR0_CMS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LCD_TYPE_MONO_DSTN</span>:
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="n">LCCR0_CMS</span> <span class="o">|</span> <span class="n">LCCR0_SDS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LCD_TYPE_COLOR_STN</span>:
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LCD_TYPE_COLOR_DSTN</span>:
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="n">LCCR0_SDS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LCD_TYPE_COLOR_TFT</span>:
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="n">LCCR0_PAS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LCD_TYPE_SMART_PANEL</span>:
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="n">LCCR0_LCDT</span> <span class="o">|</span> <span class="n">LCCR0_PAS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* fall back to backward compatibility way */</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">decode_mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_conn</span> <span class="o">==</span> <span class="n">LCD_MONO_STN_8BPP</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">|=</span> <span class="n">LCCR0_DPD</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lcd_conn</span> <span class="o">&amp;</span> <span class="n">LCD_ALTERNATE_MAPPING</span><span class="p">)</span> <span class="o">?</span> <span class="n">LCCR0_LDDALT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">=</span> <span class="n">LCCR3_Acb</span><span class="p">((</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lcd_conn</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lcd_conn</span> <span class="o">&amp;</span> <span class="n">LCD_BIAS_ACTIVE_LOW</span><span class="p">)</span> <span class="o">?</span> <span class="n">LCCR3_OEP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lcd_conn</span> <span class="o">&amp;</span> <span class="n">LCD_PCLK_EDGE_FALL</span><span class="p">)</span>  <span class="o">?</span> <span class="n">LCCR3_PCP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">decode_mode:</span>
	<span class="n">pxafb_setmode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* decide video memory size as follows:</span>
<span class="cm">	 * 1. default to mode of maximum resolution</span>
<span class="cm">	 * 2. allow platform to override</span>
<span class="cm">	 * 3. allow module parameter to override</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">num_modes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_size</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">,</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">*</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">video_mem_size</span> <span class="o">&gt;</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_size</span> <span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video_mem_size</span> <span class="o">&gt;</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_size</span> <span class="o">=</span> <span class="n">video_mem_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">pxafb_init_fbinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="o">*</span><span class="n">inf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="cm">/* Alloc the pxafb_info and pseudo_palette in one step */</span>
	<span class="n">fbi</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span><span class="p">));</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">PXA_NAME</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span>	<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">nonstd</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span>	<span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span>	<span class="o">=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span>	<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fbops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxafb_ops</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FBINFO_DEFAULT</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">node</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">fbi</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_info</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">pseudo_palette</span>	<span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span>		<span class="o">=</span> <span class="n">C_STARTUP</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task_state</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pxafb_decode_mach_info</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_PXA_OVERLAY</span>
	<span class="cm">/* place overlay(s) on top of base */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pxafb_overlay_supported</span><span class="p">())</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">|=</span> <span class="n">LCCR0_OUC</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_wait</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">pxafb_task</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_lock</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">disable_done</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fbi</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_PXA_PARAMETERS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">parse_opt_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="o">*</span><span class="n">inf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">this_opt</span><span class="o">+</span><span class="mi">5</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">namelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res_specified</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bpp_specified</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">yres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yres_specified</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">namelen</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;-&#39;</span>:
			<span class="n">namelen</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bpp_specified</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">yres_specified</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bpp</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">bpp_specified</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;x&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">yres_specified</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">yres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">yres_specified</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;0&#39;</span> <span class="p">...</span> <span class="sc">&#39;9&#39;</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">yres_specified</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">res_specified</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_specified</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;overriding resolution: %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">);</span>
		<span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpp_specified</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">bpp</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;overriding bit depth: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Depth %d is not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">parse_opt</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="o">*</span><span class="n">inf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vmem:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">video_mem_size</span> <span class="o">=</span> <span class="n">memparse</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mode:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">parse_opt_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">this_opt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;pixclock:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;pixclock: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;left:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;left: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;right:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;right: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;upper:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;upper: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;lower:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;lower: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;hsynclen:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;hsynclen: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vsynclen:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;vsynclen: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;hsync:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;hsync: Active Low</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;hsync: Active High</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vsync:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;vsync: Active Low</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;vsync: Active High</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;dpc:&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;double pixel clock: false</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LCCR3_DPC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;double pixel clock: true</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">|=</span> <span class="n">LCCR3_DPC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;outputen:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;output enable: active low</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR3_OEP</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR3_OutEnL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;output enable: active high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR3_OEP</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR3_OutEnH</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;pixclockpol:&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;pixel clock polarity: falling edge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR3_PCP</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR3_PixFlEdg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;pixel clock polarity: rising edge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR3_PCP</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR3_PixRsEdg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;color&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_CMS</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR0_Color</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mono&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_CMS</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR0_Mono</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;active&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_PAS</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR0_Act</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;passive&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_PAS</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR0_Pas</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;single&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_SDS</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR0_Sngl</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;dual&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_SDS</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR0_Dual</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;4pix&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_DPD</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR0_4PixMono</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;8pix&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_DPD</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR0_8PixMono</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown option: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">this_opt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;override %s&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pxafb_parse_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;options are </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">options</span> <span class="o">?</span> <span class="n">options</span> <span class="o">:</span> <span class="s">&quot;null&quot;</span><span class="p">);</span>

	<span class="cm">/* could be made table driven or similar?... */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_opt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">this_opt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">g_options</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pxafb_setup_options</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;pxafb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">g_options</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">g_options</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define pxafb_setup_options()		(0)</span>

<span class="n">module_param_string</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">g_options</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">g_options</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;LCD parameters (see Documentation/fb/pxafb.txt)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#else</span>
<span class="cp">#define pxafb_parse_options(...)	(0)</span>
<span class="cp">#define pxafb_setup_options()		(0)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG_VAR</span>
<span class="cm">/* Check for various illegal bit-combinations. Currently only</span>
<span class="cm"> * a warning is given. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pxafb_check_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lcd_conn</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_INVALID_CONFIG_MASK</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;machine LCCR0 setting contains &quot;</span>
				<span class="s">&quot;illegal bits: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_INVALID_CONFIG_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">&amp;</span> <span class="n">LCCR3_INVALID_CONFIG_MASK</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;machine LCCR3 setting contains &quot;</span>
				<span class="s">&quot;illegal bits: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">&amp;</span> <span class="n">LCCR3_INVALID_CONFIG_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_DPD</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_PAS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LCCR0_Pas</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_SDS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LCCR0_Sngl</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_CMS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LCCR0_Mono</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Double Pixel Data (DPD) mode is &quot;</span>
				<span class="s">&quot;only valid in passive mono&quot;</span>
				<span class="s">&quot; single panel mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_PAS</span><span class="p">)</span> <span class="o">==</span> <span class="n">LCCR0_Act</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_SDS</span><span class="p">)</span> <span class="o">==</span> <span class="n">LCCR0_Dual</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Dual panel only valid in passive mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_PAS</span><span class="p">)</span> <span class="o">==</span> <span class="n">LCCR0_Pas</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">||</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Upper and lower margins must be 0 in &quot;</span>
				<span class="s">&quot;passive mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define pxafb_check_options(...)	do {} while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pxafb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="o">*</span><span class="n">inf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pxafb_probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">inf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">fbi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pxafb_parse_options</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">g_options</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">pxafb_check_options</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;got a %dx%dx%d LCD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
			<span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">inf</span><span class="o">-&gt;</span><span class="n">modes</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid resolution or bit depth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbi</span> <span class="o">=</span> <span class="n">pxafb_init_fbinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only reason for pxafb_init_fbinfo to fail is kmalloc */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize framebuffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_pxa3xx</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">acceleration_enabled</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_PXA3XX</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">backlight_power</span> <span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">pxafb_backlight_power</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">lcd_power</span> <span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">pxafb_lcd_power</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no I/O memory resource defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_fbi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request I/O memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_fbi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to map I/O memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxafb_dma_buff</span><span class="p">));</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_size</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate memory for DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_free_io</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pxafb_init_video_memory</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate video RAM: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_free_dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no IRQ defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_free_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">pxafb_handle_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;LCD&quot;</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_free_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pxafb_smart_init</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to initialize smartpanel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This makes sure that our colour bitfield</span>
<span class="cm">	 * descriptors are correctly initialised.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pxafb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get suitable mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pxafb_set_par</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to set parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to register framebuffer device: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_free_cmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pxafb_overlay_init</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">pxafb_freq_transition</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">freq_policy</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">pxafb_freq_policy</span><span class="p">;</span>
	<span class="n">cpufreq_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">,</span>
				<span class="n">CPUFREQ_TRANSITION_NOTIFIER</span><span class="p">);</span>
	<span class="n">cpufreq_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">freq_policy</span><span class="p">,</span>
				<span class="n">CPUFREQ_POLICY_NOTIFIER</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ok, now enable the LCD controller</span>
<span class="cm">	 */</span>
	<span class="n">set_ctrlr_state</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_ENABLE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed_free_cmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">failed_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>
<span class="nl">failed_free_mem:</span>
	<span class="n">free_pages_exact</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">);</span>
<span class="nl">failed_free_dma:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_size</span><span class="p">,</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_phys</span><span class="p">);</span>
<span class="nl">failed_free_io:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>
<span class="nl">failed_free_res:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
<span class="nl">failed_fbi:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
<span class="nl">failed:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">pxafb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxafb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>

	<span class="n">pxafb_overlay_exit</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">pxafb_disable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>

	<span class="n">free_pages_exact</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">video_mem_size</span><span class="p">);</span>

	<span class="n">dma_free_writecombine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_size</span><span class="p">,</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dma_buff_phys</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">pxafb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pxafb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> 	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pxafb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;pxa2xx-fb&quot;</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxafb_pm_ops</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pxafb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pxafb_setup_options</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxafb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pxafb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxafb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pxafb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pxafb_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;loadable framebuffer driver for PXA&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
