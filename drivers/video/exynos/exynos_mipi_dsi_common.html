<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › exynos › exynos_mipi_dsi_common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>exynos_mipi_dsi_common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* linux/drivers/video/exynos/exynos_mipi_dsi_common.c</span>
<span class="cm"> *</span>
<span class="cm"> * Samsung SoC MIPI-DSI common driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2012 Samsung Electronics Co., Ltd</span>
<span class="cm"> *</span>
<span class="cm"> * InKi Dae, &lt;inki.dae@samsung.com&gt;</span>
<span class="cm"> * Donghwa Lee, &lt;dh09.lee@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/memory.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>

<span class="cp">#include &lt;video/mipi_display.h&gt;</span>
<span class="cp">#include &lt;video/exynos_mipi_dsim.h&gt;</span>

<span class="cp">#include &lt;mach/map.h&gt;</span>

<span class="cp">#include &quot;exynos_mipi_dsi_regs.h&quot;</span>
<span class="cp">#include &quot;exynos_mipi_dsi_lowlevel.h&quot;</span>
<span class="cp">#include &quot;exynos_mipi_dsi_common.h&quot;</span>

<span class="cp">#define MIPI_FIFO_TIMEOUT	msecs_to_jiffies(250)</span>
<span class="cp">#define MIPI_RX_FIFO_READ_DONE  0x30800002</span>
<span class="cp">#define MIPI_MAX_RX_FIFO        20</span>
<span class="cp">#define MHZ			(1000 * 1000)</span>
<span class="cp">#define FIN_HZ			(24 * MHZ)</span>

<span class="cp">#define DFIN_PLL_MIN_HZ		(6 * MHZ)</span>
<span class="cp">#define DFIN_PLL_MAX_HZ		(12 * MHZ)</span>

<span class="cp">#define DFVCO_MIN_HZ		(500 * MHZ)</span>
<span class="cp">#define DFVCO_MAX_HZ		(1000 * MHZ)</span>

<span class="cp">#define TRY_GET_FIFO_TIMEOUT	(5000 * 2)</span>
<span class="cp">#define TRY_FIFO_CLEAR		(10)</span>

<span class="cm">/* MIPI-DSIM status types. */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">DSIM_STATE_INIT</span><span class="p">,</span>	<span class="cm">/* should be initialized. */</span>
	<span class="n">DSIM_STATE_STOP</span><span class="p">,</span>	<span class="cm">/* CPU and LCDC are LP mode. */</span>
	<span class="n">DSIM_STATE_HSCLKEN</span><span class="p">,</span>	<span class="cm">/* HS clock was enabled. */</span>
	<span class="n">DSIM_STATE_ULPS</span>
<span class="p">};</span>

<span class="cm">/* define DSI lane types. */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">DSIM_LANE_CLOCK</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">DSIM_LANE_DATA0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">DSIM_LANE_DATA1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">DSIM_LANE_DATA2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">DSIM_LANE_DATA3</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dpll_table</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span>
	<span class="mi">320</span><span class="p">,</span> <span class="mi">390</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">560</span><span class="p">,</span>
	<span class="mi">640</span><span class="p">,</span> <span class="mi">690</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mi">870</span><span class="p">,</span> <span class="mi">950</span>
<span class="p">};</span>

<span class="n">irqreturn_t</span> <span class="nf">exynos_mipi_dsi_interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intsrc</span><span class="p">,</span> <span class="n">intmsk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsim</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: wrong parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intsrc</span> <span class="o">=</span> <span class="n">exynos_mipi_dsi_read_interrupt</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>
	<span class="n">intmsk</span> <span class="o">=</span> <span class="n">exynos_mipi_dsi_read_interrupt_mask</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>
	<span class="n">intmsk</span> <span class="o">=</span> <span class="o">~</span><span class="n">intmsk</span> <span class="o">&amp;</span> <span class="n">intsrc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intsrc</span> <span class="o">&amp;</span> <span class="n">INTMSK_RX_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim_rd_comp</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MIPI INTMSK_RX_DONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intsrc</span> <span class="o">&amp;</span> <span class="n">INTMSK_FIFO_EMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim_wr_comp</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MIPI INTMSK_FIFO_EMPTY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">exynos_mipi_dsi_clear_interrupt</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">intmsk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write long packet to mipi dsi slave</span>
<span class="cm"> * @dsim: mipi dsim device structure.</span>
<span class="cm"> * @data0: packet data to send.</span>
<span class="cm"> * @data1: size of packet data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">exynos_mipi_dsi_long_data_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* in case that data count is more then 4 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">data_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">data_cnt</span> <span class="o">&lt;</span> <span class="n">data_size</span><span class="p">;</span> <span class="n">data_cnt</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * after sending 4bytes per one time,</span>
<span class="cm">		 * send remainder data less then 4.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data_size</span> <span class="o">-</span> <span class="n">data_cnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data_size</span> <span class="o">-</span> <span class="n">data_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">payload</span> <span class="o">=</span> <span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span><span class="p">]</span> <span class="o">|</span>
				    <span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
					<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;count = 3 payload = %x, %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">payload</span><span class="p">,</span> <span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span><span class="p">],</span>
				<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
				<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">data_size</span> <span class="o">-</span> <span class="n">data_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">payload</span> <span class="o">=</span> <span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span><span class="p">]</span> <span class="o">|</span>
					<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;count = 2 payload = %x, %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span>
				<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span><span class="p">],</span>
				<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">data_size</span> <span class="o">-</span> <span class="n">data_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">payload</span> <span class="o">=</span> <span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="n">exynos_mipi_dsi_wr_tx_data</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
		<span class="cm">/* send 4bytes per one time. */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">payload</span> <span class="o">=</span> <span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span><span class="p">]</span> <span class="o">|</span>
				<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
				<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
				<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;count = 4 payload = %x, %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">data0</span> <span class="o">+</span> <span class="n">data_cnt</span><span class="p">),</span>
				<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
				<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span>
				<span class="n">data0</span><span class="p">[</span><span class="n">data_cnt</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]);</span>

			<span class="n">exynos_mipi_dsi_wr_tx_data</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exynos_mipi_dsi_wr_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_id</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">check_rx_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DSIM_STATE_ULPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;state is ULPS.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME!!! why does it need this delay? */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* short packet types of packet types for command. */</span>
	<span class="k">case</span> <span class="n">MIPI_DSI_GENERIC_SHORT_WRITE_0_PARAM</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_GENERIC_SHORT_WRITE_1_PARAM</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_GENERIC_SHORT_WRITE_2_PARAM</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_DCS_SHORT_WRITE</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_DCS_SHORT_WRITE_PARAM</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_SET_MAXIMUM_RETURN_PACKET_SIZE</span>:
		<span class="n">exynos_mipi_dsi_wr_tx_header</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">data_id</span><span class="p">,</span> <span class="n">data0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data0</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_rx_ack</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* process response func should be implemented */</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* general command */</span>
	<span class="k">case</span> <span class="n">MIPI_DSI_COLOR_MODE_OFF</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_COLOR_MODE_ON</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_SHUTDOWN_PERIPHERAL</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_TURN_ON_PERIPHERAL</span>:
		<span class="n">exynos_mipi_dsi_wr_tx_header</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">data_id</span><span class="p">,</span> <span class="n">data0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data0</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_rx_ack</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* process response func should be implemented. */</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* packet types for video data */</span>
	<span class="k">case</span> <span class="n">MIPI_DSI_V_SYNC_START</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_V_SYNC_END</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_H_SYNC_START</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_H_SYNC_END</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_END_OF_TRANSMISSION</span>:
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* long packet type and null packet */</span>
	<span class="k">case</span> <span class="n">MIPI_DSI_NULL_PACKET</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_BLANKING_PACKET</span>:
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_DSI_GENERIC_LONG_WRITE</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_DCS_LONG_WRITE</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">dsim_wr_comp</span><span class="p">);</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">data_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

		<span class="cm">/* if data count is less then 4, then send 3bytes data.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">payload</span> <span class="o">=</span> <span class="n">data0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span>
				<span class="n">data0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
				<span class="n">data0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

			<span class="n">exynos_mipi_dsi_wr_tx_data</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;count = %d payload = %x,%x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">data_size</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">data0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">data0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data0</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="cm">/* in case that data count is more then 4 */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">exynos_mipi_dsi_long_data_wr</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">data0</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>

		<span class="cm">/* put data into header fifo */</span>
		<span class="n">exynos_mipi_dsi_wr_tx_header</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">data_id</span><span class="p">,</span> <span class="n">data_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			<span class="p">(</span><span class="n">data_size</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim_wr_comp</span><span class="p">,</span>
							<span class="n">MIPI_FIFO_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;command write timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">check_rx_ack</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* process response func should be implemented. */</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* packet typo for video data */</span>
	<span class="k">case</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_16</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_18</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_PIXEL_STREAM_3BYTE_18</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_24</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">check_rx_ack</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* process response func should be implemented. */</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;data id %x is not supported current DSI spec.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data_id</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">exynos_mipi_dsi_long_data_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">req_size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rx_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rcv_pkt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rxsize</span><span class="p">;</span>

	<span class="cm">/* for long packet */</span>
	<span class="n">rxsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">rx_data</span> <span class="o">&amp;</span> <span class="mh">0x00ffff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mipi dsi rx size : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxsize</span> <span class="o">!=</span> <span class="n">req_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;received size mismatch received: %d, requested: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rxsize</span><span class="p">,</span> <span class="n">req_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">rxsize</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcv_pkt</span> <span class="o">=</span> <span class="n">exynos_mipi_dsi_rd_rx_fifo</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;received pkt : %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcv_pkt</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx_buf</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">rcv_pkt</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;received value : %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">rcv_pkt</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxsize</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcv_pkt</span> <span class="o">=</span> <span class="n">exynos_mipi_dsi_rd_rx_fifo</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;received pkt : %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcv_pkt</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">rxsize</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx_buf</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">rcv_pkt</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;received value : %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">rcv_pkt</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rxsize</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">exynos_mipi_dsi_response_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">req_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">req_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">MIPI_DSI_RX_GENERIC_SHORT_READ_RESPONSE_1BYTE</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">MIPI_DSI_RX_GENERIC_SHORT_READ_RESPONSE_2BYTE</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">MIPI_DSI_RX_GENERIC_LONG_READ_RESPONSE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exynos_mipi_dsi_rd_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_id</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">req_size</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rx_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_data</span><span class="p">,</span> <span class="n">rcv_pkt</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">response</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rxsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DSIM_STATE_ULPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;state is ULPS.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME!!! */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">dsim_rd_comp</span><span class="p">);</span>
	<span class="n">exynos_mipi_dsi_rd_tx_header</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span>
		<span class="n">MIPI_DSI_SET_MAXIMUM_RETURN_PACKET_SIZE</span><span class="p">,</span> <span class="n">req_size</span><span class="p">);</span>

	<span class="n">response</span> <span class="o">=</span> <span class="n">exynos_mipi_dsi_response_size</span><span class="p">(</span><span class="n">req_size</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MIPI_DSI_GENERIC_READ_REQUEST_0_PARAM</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_GENERIC_READ_REQUEST_1_PARAM</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_GENERIC_READ_REQUEST_2_PARAM</span>:
	<span class="k">case</span> <span class="n">MIPI_DSI_DCS_READ</span>:
		<span class="n">exynos_mipi_dsi_rd_tx_header</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span>
			<span class="n">data_id</span><span class="p">,</span> <span class="n">data0</span><span class="p">);</span>
		<span class="cm">/* process response func should be implemented. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;data id %x is not supported current DSI spec.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data_id</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim_rd_comp</span><span class="p">,</span>
				<span class="n">MIPI_FIFO_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RX done interrupt timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">rx_data</span> <span class="o">=</span> <span class="n">exynos_mipi_dsi_rd_rx_fifo</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">rx_data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;mipi dsi wrong response rx_data : %x, response:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rx_data</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clear_rx_fifo</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req_size</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for short packet */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">req_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rx_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">rxsize</span> <span class="o">=</span> <span class="n">req_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* for long packet */</span>
		<span class="n">rxsize</span> <span class="o">=</span> <span class="n">exynos_mipi_dsi_long_data_rd</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">req_size</span><span class="p">,</span> <span class="n">rx_data</span><span class="p">,</span>
							<span class="n">rx_buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxsize</span> <span class="o">!=</span> <span class="n">req_size</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">clear_rx_fifo</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rcv_pkt</span> <span class="o">=</span> <span class="n">exynos_mipi_dsi_rd_rx_fifo</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcv_pkt</span> <span class="o">!=</span> <span class="n">MIPI_RX_FIFO_READ_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Can&#39;t found RX FIFO READ DONE FLAG : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcv_pkt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clear_rx_fifo</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rxsize</span><span class="p">;</span>

<span class="nl">clear_rx_fifo:</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcv_pkt</span> <span class="o">=</span> <span class="n">exynos_mipi_dsi_rd_rx_fifo</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rcv_pkt</span> <span class="o">==</span> <span class="n">MIPI_RX_FIFO_READ_DONE</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">MIPI_MAX_RX_FIFO</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;mipi dsi clear rx fifo : %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcv_pkt</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;mipi dsi rx done count : %d, rcv_pkt : %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rcv_pkt</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos_mipi_dsi_pll_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sw_timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sw_timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

		<span class="n">exynos_mipi_dsi_enable_pll</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sw_timeout</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exynos_mipi_dsi_is_pll_stable</span><span class="p">(</span><span class="n">dsim</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sw_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">exynos_mipi_dsi_enable_pll</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">exynos_mipi_dsi_change_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pre_divider</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">main_divider</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scaler</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dfin_pll</span><span class="p">,</span> <span class="n">dfvco</span><span class="p">,</span> <span class="n">dpll_out</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">freq_band</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="n">dfin_pll</span> <span class="o">=</span> <span class="p">(</span><span class="n">FIN_HZ</span> <span class="o">/</span> <span class="n">pre_divider</span><span class="p">);</span>

	<span class="cm">/******************************************************</span>
<span class="cm">	 *	Serial Clock(=ByteClk X 8)	FreqBand[3:0] *</span>
<span class="cm">	 ******************************************************</span>
<span class="cm">	 *	~ 99.99 MHz			0000</span>
<span class="cm">	 *	100 ~ 119.99 MHz		0001</span>
<span class="cm">	 *	120 ~ 159.99 MHz		0010</span>
<span class="cm">	 *	160 ~ 199.99 MHz		0011</span>
<span class="cm">	 *	200 ~ 239.99 MHz		0100</span>
<span class="cm">	 *	140 ~ 319.99 MHz		0101</span>
<span class="cm">	 *	320 ~ 389.99 MHz		0110</span>
<span class="cm">	 *	390 ~ 449.99 MHz		0111</span>
<span class="cm">	 *	450 ~ 509.99 MHz		1000</span>
<span class="cm">	 *	510 ~ 559.99 MHz		1001</span>
<span class="cm">	 *	560 ~ 639.99 MHz		1010</span>
<span class="cm">	 *	640 ~ 689.99 MHz		1011</span>
<span class="cm">	 *	690 ~ 769.99 MHz		1100</span>
<span class="cm">	 *	770 ~ 869.99 MHz		1101</span>
<span class="cm">	 *	870 ~ 949.99 MHz		1110</span>
<span class="cm">	 *	950 ~ 1000 MHz			1111</span>
<span class="cm">	 ******************************************************/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dfin_pll</span> <span class="o">&lt;</span> <span class="n">DFIN_PLL_MIN_HZ</span> <span class="o">||</span> <span class="n">dfin_pll</span> <span class="o">&gt;</span> <span class="n">DFIN_PLL_MAX_HZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fin_pll range should be 6MHz ~ 12MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exynos_mipi_dsi_enable_afc</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dfin_pll</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">)</span>
			<span class="n">exynos_mipi_dsi_enable_afc</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dfin_pll</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">)</span>
			<span class="n">exynos_mipi_dsi_enable_afc</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dfin_pll</span> <span class="o">&lt;</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">)</span>
			<span class="n">exynos_mipi_dsi_enable_afc</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dfin_pll</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">)</span>
			<span class="n">exynos_mipi_dsi_enable_afc</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dfin_pll</span> <span class="o">&lt;</span> <span class="mi">11</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">)</span>
			<span class="n">exynos_mipi_dsi_enable_afc</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">exynos_mipi_dsi_enable_afc</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dfvco</span> <span class="o">=</span> <span class="n">dfin_pll</span> <span class="o">*</span> <span class="n">main_divider</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dfvco = %lu, dfin_pll = %lu, main_divider = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dfvco</span><span class="p">,</span> <span class="n">dfin_pll</span><span class="p">,</span> <span class="n">main_divider</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dfvco</span> <span class="o">&lt;</span> <span class="n">DFVCO_MIN_HZ</span> <span class="o">||</span> <span class="n">dfvco</span> <span class="o">&gt;</span> <span class="n">DFVCO_MAX_HZ</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fvco range should be 500MHz ~ 1000MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dpll_out</span> <span class="o">=</span> <span class="n">dfvco</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scaler</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpll_out = %lu, dfvco = %lu, scaler = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dpll_out</span><span class="p">,</span> <span class="n">dfvco</span><span class="p">,</span> <span class="n">scaler</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dpll_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpll_out</span> <span class="o">&lt;</span> <span class="n">dpll_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">freq_band</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;freq_band = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq_band</span><span class="p">);</span>

	<span class="n">exynos_mipi_dsi_pll_freq</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">pre_divider</span><span class="p">,</span> <span class="n">main_divider</span><span class="p">,</span> <span class="n">scaler</span><span class="p">);</span>

	<span class="n">exynos_mipi_dsi_hs_zero_ctrl</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">exynos_mipi_dsi_prep_ctrl</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Freq Band */</span>
	<span class="n">exynos_mipi_dsi_pll_freq_band</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">freq_band</span><span class="p">);</span>

	<span class="cm">/* Stable time */</span>
	<span class="n">exynos_mipi_dsi_pll_stable_time</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">pll_stable_time</span><span class="p">);</span>

	<span class="cm">/* Enable PLL */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FOUT of mipi dphy pll is %luMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">dpll_out</span> <span class="o">/</span> <span class="n">MHZ</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">dpll_out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos_mipi_dsi_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte_clk_sel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">esc_div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esc_clk_error_rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hs_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">byte_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">escape_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">e_clk_src</span> <span class="o">=</span> <span class="n">byte_clk_sel</span><span class="p">;</span>

		<span class="cm">/* Escape mode clock and byte clock source */</span>
		<span class="n">exynos_mipi_dsi_set_byte_clock_src</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">byte_clk_sel</span><span class="p">);</span>

		<span class="cm">/* DPHY, DSIM Link : D-PHY clock out */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">byte_clk_sel</span> <span class="o">==</span> <span class="n">DSIM_PLL_OUT_DIV8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hs_clk</span> <span class="o">=</span> <span class="n">exynos_mipi_dsi_change_pll</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span>
				<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">,</span>
				<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hs_clk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;failed to get hs clock.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">byte_clk</span> <span class="o">=</span> <span class="n">hs_clk</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">exynos_mipi_dsi_enable_pll_bypass</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">exynos_mipi_dsi_pll_on</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* DPHY : D-PHY clock out, DSIM link : external clock out */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byte_clk_sel</span> <span class="o">==</span> <span class="n">DSIM_EXT_CLK_DIV8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;this project is not support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;external clock source for MIPI DSIM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byte_clk_sel</span> <span class="o">==</span> <span class="n">DSIM_EXT_CLK_BYPASS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;this project is not support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;external clock source for MIPI DSIM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* escape clock divider */</span>
		<span class="n">esc_div</span> <span class="o">=</span> <span class="n">byte_clk</span> <span class="o">/</span> <span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">esc_clk</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;esc_div = %d, byte_clk = %lu, esc_clk = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">esc_div</span><span class="p">,</span> <span class="n">byte_clk</span><span class="p">,</span> <span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">esc_clk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">byte_clk</span> <span class="o">/</span> <span class="n">esc_div</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">byte_clk</span> <span class="o">/</span> <span class="n">esc_div</span><span class="p">)</span> <span class="o">&gt;</span>
					<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">esc_clk</span><span class="p">)</span>
			<span class="n">esc_div</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">escape_clk</span> <span class="o">=</span> <span class="n">byte_clk</span> <span class="o">/</span> <span class="n">esc_div</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;escape_clk = %lu, byte_clk = %lu, esc_div = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">escape_clk</span><span class="p">,</span> <span class="n">byte_clk</span><span class="p">,</span> <span class="n">esc_div</span><span class="p">);</span>

		<span class="cm">/* enable escape clock. */</span>
		<span class="n">exynos_mipi_dsi_enable_byte_clock</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* enable byte clk and escape clock */</span>
		<span class="n">exynos_mipi_dsi_set_esc_clk_prs</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">esc_div</span><span class="p">);</span>
		<span class="cm">/* escape clock on lane */</span>
		<span class="n">exynos_mipi_dsi_enable_esc_clk_on_lane</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span>
			<span class="p">(</span><span class="n">DSIM_LANE_CLOCK</span> <span class="o">|</span> <span class="n">dsim</span><span class="o">-&gt;</span><span class="n">data_lane</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;byte clock is %luMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">byte_clk</span> <span class="o">/</span> <span class="n">MHZ</span><span class="p">));</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;escape clock that user&#39;s need is %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">esc_clk</span> <span class="o">/</span> <span class="n">MHZ</span><span class="p">));</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;escape clock divider is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">esc_div</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;escape clock is %luMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">((</span><span class="n">byte_clk</span> <span class="o">/</span> <span class="n">esc_div</span><span class="p">)</span> <span class="o">/</span> <span class="n">MHZ</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">byte_clk</span> <span class="o">/</span> <span class="n">esc_div</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">escape_clk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">esc_clk_error_rate</span> <span class="o">=</span> <span class="n">escape_clk</span> <span class="o">/</span>
				<span class="p">(</span><span class="n">byte_clk</span> <span class="o">/</span> <span class="n">esc_div</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error rate is %lu over.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">esc_clk_error_rate</span> <span class="o">/</span> <span class="mi">100</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">byte_clk</span> <span class="o">/</span> <span class="n">esc_div</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">escape_clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">esc_clk_error_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte_clk</span> <span class="o">/</span> <span class="n">esc_div</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">escape_clk</span><span class="p">;</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error rate is %lu under.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">esc_clk_error_rate</span> <span class="o">/</span> <span class="mi">100</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">exynos_mipi_dsi_enable_esc_clk_on_lane</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span>
			<span class="p">(</span><span class="n">DSIM_LANE_CLOCK</span> <span class="o">|</span> <span class="n">dsim</span><span class="o">-&gt;</span><span class="n">data_lane</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">exynos_mipi_dsi_set_esc_clk_prs</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* disable escape clock. */</span>
		<span class="n">exynos_mipi_dsi_enable_byte_clock</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">byte_clk_sel</span> <span class="o">==</span> <span class="n">DSIM_PLL_OUT_DIV8</span><span class="p">)</span>
			<span class="n">exynos_mipi_dsi_pll_on</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exynos_mipi_dsi_init_dsim</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DSIM_STATE_INIT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">e_no_data_lane</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DSIM_DATA_LANE_1</span>:
		<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">data_lane</span> <span class="o">=</span> <span class="n">DSIM_LANE_DATA0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSIM_DATA_LANE_2</span>:
		<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">data_lane</span> <span class="o">=</span> <span class="n">DSIM_LANE_DATA0</span> <span class="o">|</span> <span class="n">DSIM_LANE_DATA1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSIM_DATA_LANE_3</span>:
		<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">data_lane</span> <span class="o">=</span> <span class="n">DSIM_LANE_DATA0</span> <span class="o">|</span> <span class="n">DSIM_LANE_DATA1</span> <span class="o">|</span>
			<span class="n">DSIM_LANE_DATA2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSIM_DATA_LANE_4</span>:
		<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">data_lane</span> <span class="o">=</span> <span class="n">DSIM_LANE_DATA0</span> <span class="o">|</span> <span class="n">DSIM_LANE_DATA1</span> <span class="o">|</span>
			<span class="n">DSIM_LANE_DATA2</span> <span class="o">|</span> <span class="n">DSIM_LANE_DATA3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;data lane is invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">exynos_mipi_dsi_sw_reset</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>
	<span class="n">exynos_mipi_dsi_func_reset</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>

	<span class="n">exynos_mipi_dsi_dp_dn_swap</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">exynos_mipi_dsi_init_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">INTSRC_SFR_FIFO_EMPTY</span> <span class="o">|</span> <span class="n">INTSRC_RX_DATA_DONE</span><span class="p">);</span>
	<span class="n">exynos_mipi_dsi_set_interrupt</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">src</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">src</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">INTMSK_RX_DONE</span> <span class="o">|</span> <span class="n">INTMSK_FIFO_EMPTY</span><span class="p">);</span>
	<span class="n">exynos_mipi_dsi_set_interrupt_mask</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exynos_mipi_dsi_enable_frame_done_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enable only frame done interrupt */</span>
	<span class="n">exynos_mipi_dsi_set_interrupt_mask</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">INTMSK_FRAME_DONE</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">exynos_mipi_dsi_stand_by</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* consider Main display and Sub display. */</span>

	<span class="n">exynos_mipi_dsi_set_main_stand_by</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exynos_mipi_dsi_set_display_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mipi_dsim_config</span> <span class="o">*</span><span class="n">dsim_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mipi_dsim_platform_data</span> <span class="o">*</span><span class="n">dsim_pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">timing</span><span class="p">;</span>

	<span class="n">dsim_pd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_platform_data</span> <span class="o">*</span><span class="p">)</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">;</span>
	<span class="n">timing</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="p">)</span><span class="n">dsim_pd</span><span class="o">-&gt;</span><span class="n">lcd_panel_info</span><span class="p">;</span>

	<span class="cm">/* in case of VIDEO MODE (RGB INTERFACE), it sets polarities. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">e_interface</span> <span class="o">==</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">DSIM_VIDEO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">auto_vertical_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">exynos_mipi_dsi_set_main_disp_vporch</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span>
				<span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">cmd_allow</span><span class="p">,</span>
				<span class="n">timing</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">,</span>
				<span class="n">timing</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">);</span>
			<span class="n">exynos_mipi_dsi_set_main_disp_hporch</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span>
				<span class="n">timing</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">,</span>
				<span class="n">timing</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">);</span>
			<span class="n">exynos_mipi_dsi_set_main_disp_sync_area</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span>
				<span class="n">timing</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">,</span>
				<span class="n">timing</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">exynos_mipi_dsi_set_main_disp_resol</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span>
			<span class="n">timing</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>

	<span class="n">exynos_mipi_dsi_display_config</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">dsim_config</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lcd panel ==&gt; width = %d, height = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">timing</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exynos_mipi_dsi_init_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time_out</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DSIM_STATE_INIT</span>:
		<span class="n">exynos_mipi_dsi_init_fifo_pointer</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>

		<span class="cm">/* dsi configuration */</span>
		<span class="n">exynos_mipi_dsi_init_config</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>
		<span class="n">exynos_mipi_dsi_enable_lane</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">DSIM_LANE_CLOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">exynos_mipi_dsi_enable_lane</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">dsim</span><span class="o">-&gt;</span><span class="n">data_lane</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* set clock configuration */</span>
		<span class="n">exynos_mipi_dsi_set_clock</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">e_byte_clk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* check clock and data lane state are stop state */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">exynos_mipi_dsi_is_lane_state</span><span class="p">(</span><span class="n">dsim</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">time_out</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_out</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;DSI Master is not stop state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Check initialization process</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_out</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;DSI Master driver has been completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DSI Master state is stop state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DSIM_STATE_STOP</span><span class="p">;</span>

		<span class="cm">/* BTA sequence counters */</span>
		<span class="n">exynos_mipi_dsi_set_stop_state_counter</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span>
			<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">stop_holding_cnt</span><span class="p">);</span>
		<span class="n">exynos_mipi_dsi_set_bta_timeout</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span>
			<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">bta_timeout</span><span class="p">);</span>
		<span class="n">exynos_mipi_dsi_set_lpdr_timeout</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span>
			<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dsim_config</span><span class="o">-&gt;</span><span class="n">rx_timeout</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DSI Master is already init.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exynos_mipi_dsi_set_hs_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DSIM_STATE_STOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DSIM is not in stop state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">e_clk_src</span> <span class="o">==</span> <span class="n">DSIM_EXT_CLK_BYPASS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clock source is external bypass.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsim</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DSIM_STATE_HSCLKEN</span><span class="p">;</span>

	 <span class="cm">/* set LCDC and CPU transfer mode to HS. */</span>
	<span class="n">exynos_mipi_dsi_set_lcdc_transfer_mode</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">exynos_mipi_dsi_set_cpu_transfer_mode</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">exynos_mipi_dsi_enable_hs_clock</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exynos_mipi_dsi_set_data_transfer_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DSIM_STATE_HSCLKEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HS Clock lane is not enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">exynos_mipi_dsi_set_lcdc_transfer_mode</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DSIM_STATE_INIT</span> <span class="o">||</span> <span class="n">dsim</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span>
			<span class="n">DSIM_STATE_ULPS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;DSI Master is not STOP or HSDT state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">exynos_mipi_dsi_set_cpu_transfer_mode</span><span class="p">(</span><span class="n">dsim</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exynos_mipi_dsi_get_frame_done_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_exynos_mipi_dsi_get_frame_done_status</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exynos_mipi_dsi_clear_frame_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_exynos_mipi_dsi_clear_frame_done</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exynos_mipi_dsi_fifo_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">mipi_dsim_device</span> <span class="o">*</span><span class="n">dsim</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">try</span> <span class="o">=</span> <span class="n">TRY_FIFO_CLEAR</span><span class="p">;</span>

	<span class="n">exynos_mipi_dsi_sw_reset_release</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>
	<span class="n">exynos_mipi_dsi_func_reset</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exynos_mipi_dsi_get_sw_reset_release</span><span class="p">(</span><span class="n">dsim</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">exynos_mipi_dsi_init_interrupt</span><span class="p">(</span><span class="n">dsim</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reset release done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">try</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">dsim</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to clear dsim fifo.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;InKi Dae &lt;inki.dae@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Samusung SoC MIPI-DSI common driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
