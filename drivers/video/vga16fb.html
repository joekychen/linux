<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › vga16fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>vga16fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/vga16.c -- VGA 16-color framebuffer driver</span>
<span class="cm"> * </span>
<span class="cm"> * Copyright 1999 Ben Pfaff &lt;pfaffben@debian.org&gt; and Petr Vandrovec &lt;VANDROVE@vc.cvut.cz&gt;</span>
<span class="cm"> * Based on VGA info at http://www.goodnet.com/~tinara/FreeVGA/home.htm</span>
<span class="cm"> * Based on VESA framebuffer (c) 1998 Gerd Knorr &lt;kraxel@goldbach.in-berlin.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General</span>
<span class="cm"> * Public License.  See the file COPYING in the main directory of this</span>
<span class="cm"> * archive for more details.  </span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/screen_info.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;video/vga.h&gt;</span>

<span class="cp">#define VGA_FB_PHYS 0xA0000</span>
<span class="cp">#define VGA_FB_PHYS_LEN 65536</span>

<span class="cp">#define MODE_SKIP4	1</span>
<span class="cp">#define MODE_8BPP	2</span>
<span class="cp">#define MODE_CFB	4</span>
<span class="cp">#define MODE_TEXT	8</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * card parameters</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="p">{</span>
	<span class="cm">/* structure holding original VGA register settings when the</span>
<span class="cm">           screen is blanked */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">SeqCtrlIndex</span><span class="p">;</span>	  <span class="cm">/* Sequencer Index reg.   */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">CrtCtrlIndex</span><span class="p">;</span>	  <span class="cm">/* CRT-Contr. Index reg.  */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">CrtMiscIO</span><span class="p">;</span>	  <span class="cm">/* Miscellaneous register */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">HorizontalTotal</span><span class="p">;</span>  <span class="cm">/* CRT-Controller:00h */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">HorizDisplayEnd</span><span class="p">;</span>  <span class="cm">/* CRT-Controller:01h */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">StartHorizRetrace</span><span class="p">;</span><span class="cm">/* CRT-Controller:04h */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">EndHorizRetrace</span><span class="p">;</span>  <span class="cm">/* CRT-Controller:05h */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">Overflow</span><span class="p">;</span>	  <span class="cm">/* CRT-Controller:07h */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">StartVertRetrace</span><span class="p">;</span> <span class="cm">/* CRT-Controller:10h */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">EndVertRetrace</span><span class="p">;</span>	  <span class="cm">/* CRT-Controller:11h */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">ModeControl</span><span class="p">;</span>	  <span class="cm">/* CRT-Controller:17h */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">ClockingMode</span><span class="p">;</span>	  <span class="cm">/* Seq-Controller:01h */</span>
	<span class="p">}</span> <span class="n">vga_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vgastate</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ref_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">palette_blanked</span><span class="p">,</span> <span class="n">vesa_blanked</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">isVGA</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">misc</span><span class="p">,</span> <span class="n">pel_msk</span><span class="p">,</span> <span class="n">vss</span><span class="p">,</span> <span class="n">clkdiv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRT_C</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">vga16fb_defined</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres_virtual</span>	<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres_virtual</span>	<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bits_per_pixel</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	
	<span class="p">.</span><span class="n">activate</span>	<span class="o">=</span> <span class="n">FB_ACTIVATE_TEST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">39721</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">33</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsync_len</span> 	<span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* name should not depend on EGA/VGA */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">vga16fb_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="s">&quot;VGA16 VGA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">smem_start</span>	<span class="o">=</span> <span class="n">VGA_FB_PHYS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">smem_len</span>	<span class="o">=</span> <span class="n">VGA_FB_PHYS_LEN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">FB_TYPE_VGA_PLANES</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type_aux</span>	<span class="o">=</span> <span class="n">FB_AUX_VGA_PLANES_VGA4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span>		<span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpanstep</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line_length</span>	<span class="o">=</span> <span class="mi">640</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span>		<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span>
<span class="p">};</span>

<span class="cm">/* The VGA&#39;s weird architecture often requires that we read a byte and</span>
<span class="cm">   write a byte to the same location.  It doesn&#39;t matter *what* byte</span>
<span class="cm">   we write, however.  This is because all the action goes on behind</span>
<span class="cm">   the scenes in the VGA&#39;s 32-bit latch register, and reading and writing</span>
<span class="cm">   video memory just invokes latch behavior.</span>

<span class="cm">   To avoid race conditions (is this necessary?), reading and writing</span>
<span class="cm">   the memory byte should be done with a single instruction.  One</span>
<span class="cm">   suitable instruction is the x86 bitwise OR.  The following</span>
<span class="cm">   read-modify-write routine should optimize to one such bitwise</span>
<span class="cm">   OR. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rmw</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">readb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set the Graphics Mode Register, and return its previous value.</span>
<span class="cm">   Bits 0-1 are write mode, bit 3 is read mode. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">setmode</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">oldmode</span><span class="p">;</span>
	
	<span class="n">oldmode</span> <span class="o">=</span> <span class="n">vga_io_rgfx</span><span class="p">(</span><span class="n">VGA_GFX_MODE</span><span class="p">);</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_GFX_D</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">oldmode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Select the Bit Mask Register and return its value. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">selectmask</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vga_io_rgfx</span><span class="p">(</span><span class="n">VGA_GFX_BIT_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set the value of the Bit Mask Register.  It must already have been</span>
<span class="cm">   selected with selectmask(). */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">setmask</span><span class="p">(</span><span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_GFX_D</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set the Data Rotate Register and return its old value. </span>
<span class="cm">   Bits 0-2 are rotate count, bits 3-4 are logical operation</span>
<span class="cm">   (0=NOP, 1=AND, 2=OR, 3=XOR). */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">setop</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">oldop</span><span class="p">;</span>
	
	<span class="n">oldop</span> <span class="o">=</span> <span class="n">vga_io_rgfx</span><span class="p">(</span><span class="n">VGA_GFX_DATA_ROTATE</span><span class="p">);</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_GFX_D</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">oldop</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set the Enable Set/Reset Register and return its old value.  </span>
<span class="cm">   The code here always uses value 0xf for this register. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">setsr</span><span class="p">(</span><span class="kt">int</span> <span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">oldsr</span><span class="p">;</span>

	<span class="n">oldsr</span> <span class="o">=</span> <span class="n">vga_io_rgfx</span><span class="p">(</span><span class="n">VGA_GFX_SR_ENABLE</span><span class="p">);</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_GFX_D</span><span class="p">,</span> <span class="n">sr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">oldsr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set the Set/Reset Register and return its old value. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">setcolor</span><span class="p">(</span><span class="kt">int</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">oldcolor</span><span class="p">;</span>

	<span class="n">oldcolor</span> <span class="o">=</span> <span class="n">vga_io_rgfx</span><span class="p">(</span><span class="n">VGA_GFX_SR_VALUE</span><span class="p">);</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_GFX_D</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">oldcolor</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the value in the Graphics Address Register. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">getindex</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_GFX_I</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set the value in the Graphics Address Register. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">setindex</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_GFX_I</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga16fb_pan_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> 
			    <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xoffset</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_TEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">fh</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="c1">// FIXME !!! font height. Fugde for now.</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">/</span> <span class="n">fh</span><span class="p">)</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">nonstd</span><span class="p">)</span>
			<span class="n">xoffset</span><span class="o">--</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="n">VGA_CRTC_START_HI</span><span class="p">,</span> <span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="n">VGA_CRTC_START_LO</span><span class="p">,</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="cm">/* if we support CFB4, then we must! support xoffset with pixel</span>
<span class="cm">	 * granularity if someone supports xoffset in bit resolution */</span>
	<span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_IS1_RC</span><span class="p">);</span>		<span class="cm">/* reset flip-flop */</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_ATT_IW</span><span class="p">,</span> <span class="n">VGA_ATC_PEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_ATT_IW</span><span class="p">,</span> <span class="p">(</span><span class="n">xoffset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_ATT_IW</span><span class="p">,</span> <span class="n">xoffset</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_IS1_RC</span><span class="p">);</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_ATT_IW</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga16fb_update_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">nonstd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_VGA_PLANES</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="n">FB_AUX_VGA_PLANES_VGA4</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_TEXT</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="n">FB_AUX_TEXT_CGA</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* 8bpp */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">nonstd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_VGA_PLANES</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="n">FB_AUX_VGA_PLANES_CFB8</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga16fb_clock_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixclock</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">mul</span><span class="p">,</span> <span class="kt">int</span> <span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pixclock</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">misc</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">seq_clock_mode</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">best</span><span class="p">,</span> <span class="n">vgaclocks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">79442</span> <span class="cm">/* 12.587 */</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span>
		<span class="p">{</span> <span class="mi">70616</span> <span class="cm">/* 14.161 */</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span>
		<span class="p">{</span> <span class="mi">39721</span> <span class="cm">/* 25.175 */</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span> <span class="mi">35308</span> <span class="cm">/* 28.322 */</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span>     <span class="mi">0</span> <span class="cm">/* bad */</span><span class="p">,</span>    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pixclock</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixclock</span> <span class="o">*</span> <span class="n">mul</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">best</span> <span class="o">=</span> <span class="n">vgaclocks</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pixclock</span> <span class="o">-</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">vgaclocks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">pixclock</span> <span class="o">-</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">tmp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">|=</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">misc</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">clkdiv</span> <span class="o">=</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">seq_clock_mode</span><span class="p">;</span>
	<span class="n">pixclock</span> <span class="o">=</span> <span class="p">(</span><span class="n">best</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">*</span> <span class="n">div</span><span class="p">)</span> <span class="o">/</span> <span class="n">mul</span><span class="p">;</span>		
<span class="p">}</span>
			       
<span class="cp">#define FAIL(X) return -EINVAL</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vga16fb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vgastate</span><span class="p">));</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">VGA_SAVE_FONTS</span> <span class="o">|</span> <span class="n">VGA_SAVE_MODE</span> <span class="o">|</span>
			<span class="n">VGA_SAVE_CMAP</span><span class="p">;</span>
		<span class="n">save_vga</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vga16fb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">restore_vga</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vga16fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xres</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">hslen</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">xtotal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">yres</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">vslen</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">ytotal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">xoffset</span><span class="p">,</span> <span class="n">vyres</span><span class="p">,</span> <span class="n">yoffset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">r7</span><span class="p">,</span> <span class="n">rMode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">maxmem</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pel_msk</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">isVGA</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">shift</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_SKIP4</span> <span class="o">|</span> <span class="n">MODE_CFB</span><span class="p">;</span>
			<span class="n">maxmem</span> <span class="o">=</span> <span class="mi">16384</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pel_msk</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">shift</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">maxmem</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">isVGA</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* no support on EGA */</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_8BPP</span> <span class="o">|</span> <span class="n">MODE_CFB</span><span class="p">;</span>
			<span class="n">maxmem</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_SKIP4</span> <span class="o">|</span> <span class="n">MODE_8BPP</span> <span class="o">|</span> <span class="n">MODE_CFB</span><span class="p">;</span>
			<span class="n">maxmem</span> <span class="o">=</span> <span class="mi">16384</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">vxres</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xF</span><span class="p">;</span>
	<span class="n">xoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">hslen</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vxres</span> <span class="o">&lt;</span> <span class="n">xres</span><span class="p">)</span>
		<span class="n">vxres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">+</span> <span class="n">xoffset</span> <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">xoffset</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">xres</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">hslen</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">vxres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">xoffset</span><span class="p">;</span>

	<span class="n">xres</span> <span class="o">&gt;&gt;=</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">&gt;&gt;=</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">hslen</span> <span class="o">&gt;&gt;=</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">&gt;&gt;=</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">vxres</span> <span class="o">&gt;&gt;=</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">xtotal</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">right</span> <span class="o">+</span> <span class="n">hslen</span> <span class="o">+</span> <span class="n">left</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xtotal</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;xtotal too big&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hslen</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;hslen too big&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">+</span> <span class="n">hslen</span> <span class="o">+</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;hblank too big&quot;</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_H_TOTAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">xtotal</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_H_BLANK_START</span><span class="p">]</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_H_DISP</span><span class="p">]</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">right</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_H_SYNC_START</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">hslen</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_H_SYNC_END</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">left</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* blank_end + 2 &lt;= total + 5 */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_H_BLANK_END</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_H_SYNC_END</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">lower</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">vslen</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">upper</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">vyres</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vxres</span> <span class="o">*</span> <span class="n">vyres</span> <span class="o">&gt;</span> <span class="n">maxmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vyres</span> <span class="o">=</span> <span class="n">maxmem</span> <span class="o">/</span> <span class="n">vxres</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vyres</span> <span class="o">&lt;</span> <span class="n">yres</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">yoffset</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">yres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">lower</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">vslen</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">upper</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">yoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">yres</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">lower</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vslen</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">upper</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ytotal</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">+</span> <span class="n">lower</span> <span class="o">+</span> <span class="n">vslen</span> <span class="o">+</span> <span class="n">upper</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ytotal</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ytotal</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">yres</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">lower</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vslen</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">upper</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rMode</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rMode</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ytotal</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;ytotal too big&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vslen</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;vslen too big&quot;</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_V_TOTAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">ytotal</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">r7</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* disable linecompare */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ytotal</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="n">r7</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ytotal</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="n">r7</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_PRESET_ROW</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_MAX_SCAN</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>	<span class="cm">/* 1 scanline, no linecmp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_MAX_SCAN</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_CURSOR_START</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_CURSOR_END</span><span class="p">]</span>   <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MODE_CFB</span> <span class="o">|</span> <span class="n">MODE_8BPP</span><span class="p">))</span> <span class="o">==</span> <span class="n">MODE_CFB</span><span class="p">)</span>
		<span class="n">xoffset</span><span class="o">--</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">yoffset</span> <span class="o">*</span> <span class="n">vxres</span> <span class="o">+</span> <span class="p">(</span><span class="n">xoffset</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_START_HI</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_START_LO</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_CURSOR_HI</span><span class="p">]</span>    <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_CURSOR_LO</span><span class="p">]</span>    <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_V_DISP_END</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_V_BLANK_START</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="n">r7</span> <span class="o">|=</span> <span class="mh">0x0A</span><span class="p">;</span>	<span class="cm">/* 0x02 -&gt; DISP_END, 0x08 -&gt; BLANK_START */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r7</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>	<span class="cm">/* 0x40 -&gt; DISP_END */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_MAX_SCAN</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* BLANK_START */</span>
	<span class="p">}</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">lower</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_V_SYNC_START</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="n">r7</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
		<span class="n">r7</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">vslen</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* disabled IRQ */</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">upper</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* blank_end + 1 &lt;= ytotal + 2 */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_V_BLANK_END</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="cm">/* 0x7F for original VGA,</span>
<span class="cm">                     but some SVGA chips requires all 8 bits to set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vxres</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;vxres too long&quot;</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_OFFSET</span><span class="p">]</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_SKIP4</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_UNDERLINE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5F</span><span class="p">;</span>	<span class="cm">/* 256, cfb8 */</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_UNDERLINE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>	<span class="cm">/* 16, vgap */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="n">rMode</span> <span class="o">|</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_TEXT</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xA3</span> <span class="o">:</span> <span class="mh">0xE3</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_LINE_COMPARE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_OVERFLOW</span><span class="p">]</span> <span class="o">=</span> <span class="n">r7</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vss</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 3DA */</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">=</span> <span class="mh">0xE3</span><span class="p">;</span>	<span class="cm">/* enable CPU, ports 0x3Dx, positive sync */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
	
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_8BPP</span><span class="p">)</span>
		<span class="cm">/* pixel clock == vga clock / 2 */</span>
		<span class="n">vga16fb_clock_chip</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* pixel clock == vga clock */</span>
		<span class="n">vga16fb_clock_chip</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> 
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">isVGA</span><span class="p">)</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#undef FAIL</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vga16fb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_C</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">seq</span><span class="p">[</span><span class="n">VGA_SEQ_C</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">atc</span><span class="p">[</span><span class="n">VGA_ATT_C</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">fh</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">seq</span><span class="p">[</span><span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="o">|</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clkdiv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_TEXT</span><span class="p">)</span>
		<span class="n">seq</span><span class="p">[</span><span class="n">VGA_SEQ_PLANE_WRITE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">seq</span><span class="p">[</span><span class="n">VGA_SEQ_PLANE_WRITE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">seq</span><span class="p">[</span><span class="n">VGA_SEQ_CHARACTER_MAP</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_TEXT</span><span class="p">)</span>
		<span class="n">seq</span><span class="p">[</span><span class="n">VGA_SEQ_MEMORY_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_SKIP4</span><span class="p">)</span>
		<span class="n">seq</span><span class="p">[</span><span class="n">VGA_SEQ_MEMORY_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0E</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">seq</span><span class="p">[</span><span class="n">VGA_SEQ_MEMORY_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>

	<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_SR_VALUE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_SR_ENABLE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_COMPARE_VALUE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_DATA_ROTATE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_PLANE_READ</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_TEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_MISC</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_CFB</span><span class="p">)</span>
			<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_MISC</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_COMPARE_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">gdc</span><span class="p">[</span><span class="n">VGA_GFX_BIT_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">atc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_TEXT</span><span class="p">)</span>
		<span class="n">atc</span><span class="p">[</span><span class="n">VGA_ATC_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_8BPP</span><span class="p">)</span>
		<span class="n">atc</span><span class="p">[</span><span class="n">VGA_ATC_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">atc</span><span class="p">[</span><span class="n">VGA_ATC_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
	<span class="n">atc</span><span class="p">[</span><span class="n">VGA_ATC_OVERSCAN</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 0 for EGA, 0xFF for VGA */</span>
	<span class="n">atc</span><span class="p">[</span><span class="n">VGA_ATC_PLANE_ENABLE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_8BPP</span><span class="p">)</span>
		<span class="n">atc</span><span class="p">[</span><span class="n">VGA_ATC_PEL</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">atc</span><span class="p">[</span><span class="n">VGA_ATC_PEL</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">atc</span><span class="p">[</span><span class="n">VGA_ATC_COLOR_PAGE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_TEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="c1">// FIXME !!! Fudge font height. </span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_MAX_SCAN</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_MAX_SCAN</span><span class="p">]</span> 
					       <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">fh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_MIS_W</span><span class="p">,</span> <span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_MIS_R</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="cm">/* Enable graphics register modification */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">isVGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_io_w</span><span class="p">(</span><span class="n">EGA_GFX_E0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">vga_io_w</span><span class="p">(</span><span class="n">EGA_GFX_E1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="cm">/* update misc output register */</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_MIS_W</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">misc</span><span class="p">);</span>
	
	<span class="cm">/* synchronous reset on */</span>
	<span class="n">vga_io_wseq</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">isVGA</span><span class="p">)</span>
		<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_PEL_MSK</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pel_msk</span><span class="p">);</span>

	<span class="cm">/* write sequencer registers */</span>
	<span class="n">vga_io_wseq</span><span class="p">(</span><span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">,</span> <span class="n">seq</span><span class="p">[</span><span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VGA_SEQ_C</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_io_wseq</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	
	<span class="cm">/* synchronous reset off */</span>
	<span class="n">vga_io_wseq</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="cm">/* deprotect CRT registers 0-7 */</span>
	<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">]);</span>

	<span class="cm">/* write CRT registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VGA_CRTC_REGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	
	<span class="cm">/* write graphics controller registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VGA_GFX_C</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_io_wgfx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">gdc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	
	<span class="cm">/* write attribute controller registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VGA_ATT_C</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_IS1_RC</span><span class="p">);</span>		<span class="cm">/* reset flip-flop */</span>
		<span class="n">vga_io_wattr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">atc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for screen to stabilize. */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="n">vga_io_wseq</span><span class="p">(</span><span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">,</span> <span class="n">seq</span><span class="p">[</span><span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">]);</span>

	<span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_IS1_RC</span><span class="p">);</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_ATT_IW</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">vga16fb_update_fix</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ega16_setpalette</span><span class="p">(</span><span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mo">000</span><span class="p">,</span> <span class="mo">001</span><span class="p">,</span> <span class="mo">010</span><span class="p">,</span> <span class="mo">011</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">map</span><span class="p">[</span><span class="n">red</span><span class="o">&gt;&gt;</span><span class="mi">14</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">map</span><span class="p">[</span><span class="n">green</span><span class="o">&gt;&gt;</span><span class="mi">14</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">map</span><span class="p">[</span><span class="n">blue</span><span class="o">&gt;&gt;</span><span class="mi">14</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_IS1_RC</span><span class="p">);</span>   <span class="cm">/* ! 0x3BA */</span>
	<span class="n">vga_io_wattr</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_IS1_RC</span><span class="p">);</span>   <span class="cm">/* some clones need it */</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_ATT_IW</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span> <span class="cm">/* unblank screen */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga16_setpalette</span><span class="p">(</span><span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span>       <span class="n">VGA_PEL_IW</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">red</span>   <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">blue</span>  <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vga16fb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gray</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Set a single color register. The values supplied are</span>
<span class="cm">	 *  already rounded down to the hardware&#39;s capabilities</span>
<span class="cm">	 *  (according to the entries in the `var&#39; structure). Return</span>
<span class="cm">	 *  != 0 for invalid regno.</span>
<span class="cm">	 */</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">gray</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">gray</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* gray = 0.30*R + 0.59*G + 0.11*B */</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">green</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">*</span> <span class="mi">77</span> <span class="o">+</span> <span class="n">green</span> <span class="o">*</span> <span class="mi">151</span> <span class="o">+</span> <span class="n">blue</span> <span class="o">*</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">isVGA</span><span class="p">)</span> 
		<span class="n">vga16_setpalette</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span><span class="n">red</span><span class="p">,</span><span class="n">green</span><span class="p">,</span><span class="n">blue</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ega16_setpalette</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span><span class="n">red</span><span class="p">,</span><span class="n">green</span><span class="p">,</span><span class="n">blue</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vga16fb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">vga16fb_pan_var</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The following VESA blanking code is taken from vgacon.c.  The VGA</span>
<span class="cm">   blanking code was originally by Huang shi chao, and modified by</span>
<span class="cm">   Christoph Rimek (chrimek@toppoint.de) and todd j. derr</span>
<span class="cm">   (tjd@barefoot.org) for Linux. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_vesa_blank</span><span class="p">(</span><span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SeqCtrlIndex</span> <span class="o">=</span> <span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_SEQ_I</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CrtCtrlIndex</span> <span class="o">=</span> <span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_CRT_IC</span><span class="p">);</span>
	
	<span class="cm">/* save original values of VGA controller registers */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vesa_blanked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">CrtMiscIO</span> <span class="o">=</span> <span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_MIS_R</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>sti();</p></td><td class="code"><div class="highlight"><pre>		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">HorizontalTotal</span> <span class="o">=</span> <span class="n">vga_io_rcrt</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* HorizontalTotal */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">HorizDisplayEnd</span> <span class="o">=</span> <span class="n">vga_io_rcrt</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span>	<span class="cm">/* HorizDisplayEnd */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">StartHorizRetrace</span> <span class="o">=</span> <span class="n">vga_io_rcrt</span><span class="p">(</span><span class="mh">0x04</span><span class="p">);</span>	<span class="cm">/* StartHorizRetrace */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">EndHorizRetrace</span> <span class="o">=</span> <span class="n">vga_io_rcrt</span><span class="p">(</span><span class="mh">0x05</span><span class="p">);</span>	<span class="cm">/* EndHorizRetrace */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">Overflow</span> <span class="o">=</span> <span class="n">vga_io_rcrt</span><span class="p">(</span><span class="mh">0x07</span><span class="p">);</span>		<span class="cm">/* Overflow */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">StartVertRetrace</span> <span class="o">=</span> <span class="n">vga_io_rcrt</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>	<span class="cm">/* StartVertRetrace */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">EndVertRetrace</span> <span class="o">=</span> <span class="n">vga_io_rcrt</span><span class="p">(</span><span class="mh">0x11</span><span class="p">);</span>	<span class="cm">/* EndVertRetrace */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">ModeControl</span> <span class="o">=</span> <span class="n">vga_io_rcrt</span><span class="p">(</span><span class="mh">0x17</span><span class="p">);</span>	<span class="cm">/* ModeControl */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">ClockingMode</span> <span class="o">=</span> <span class="n">vga_io_rseq</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span>	<span class="cm">/* ClockingMode */</span>
	<span class="p">}</span>

	<span class="cm">/* assure that video is enabled */</span>
	<span class="cm">/* &quot;0x20&quot; is VIDEO_ENABLE_bit in register 01 of sequencer */</span>
	<span class="n">vga_io_wseq</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">ClockingMode</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="cm">/* test for vertical retrace in process.... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">CrtMiscIO</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_MIS_W</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">CrtMiscIO</span> <span class="o">&amp;</span> <span class="mh">0xef</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set &lt;End of vertical retrace&gt; to minimum (0) and</span>
<span class="cm">	 * &lt;Start of vertical Retrace&gt; to maximum (incl. overflow)</span>
<span class="cm">	 * Result: turn off vertical sync (VSync) pulse.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="n">VGA_CRTC_V_SYNC_START</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="cm">/* bits 9,10 of vert. retrace */</span>
		<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="n">VGA_CRTC_OVERFLOW</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">Overflow</span> <span class="o">|</span> <span class="mh">0x84</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set &lt;End of horizontal retrace&gt; to minimum (0) and</span>
<span class="cm">		 *  &lt;Start of horizontal Retrace&gt; to maximum</span>
<span class="cm">		 * Result: turn off horizontal sync (HSync) pulse.</span>
<span class="cm">		 */</span>
		<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="n">VGA_CRTC_H_SYNC_START</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="n">VGA_CRTC_H_SYNC_END</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* restore both index registers */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">SeqCtrlIndex</span><span class="p">,</span> <span class="n">VGA_SEQ_I</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">CrtCtrlIndex</span><span class="p">,</span> <span class="n">VGA_CRT_IC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_vesa_unblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SeqCtrlIndex</span> <span class="o">=</span> <span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_SEQ_I</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CrtCtrlIndex</span> <span class="o">=</span> <span class="n">vga_io_r</span><span class="p">(</span><span class="n">VGA_CRT_IC</span><span class="p">);</span>
	
	<span class="cm">/* restore original values of VGA controller registers */</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_MIS_W</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">CrtMiscIO</span><span class="p">);</span>

	<span class="cm">/* HorizontalTotal */</span>
	<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">HorizontalTotal</span><span class="p">);</span>
	<span class="cm">/* HorizDisplayEnd */</span>
	<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">HorizDisplayEnd</span><span class="p">);</span>
	<span class="cm">/* StartHorizRetrace */</span>
	<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">StartHorizRetrace</span><span class="p">);</span>
	<span class="cm">/* EndHorizRetrace */</span>
	<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">EndHorizRetrace</span><span class="p">);</span>
	<span class="cm">/* Overflow */</span>
	<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">Overflow</span><span class="p">);</span>
	<span class="cm">/* StartVertRetrace */</span>
	<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">StartVertRetrace</span><span class="p">);</span>
	<span class="cm">/* EndVertRetrace */</span>
	<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">EndVertRetrace</span><span class="p">);</span>
	<span class="cm">/* ModeControl */</span>
	<span class="n">vga_io_wcrt</span><span class="p">(</span><span class="mh">0x17</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">ModeControl</span><span class="p">);</span>
	<span class="cm">/* ClockingMode */</span>
	<span class="n">vga_io_wseq</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vga_state</span><span class="p">.</span><span class="n">ClockingMode</span><span class="p">);</span>

	<span class="cm">/* restore index/control registers */</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_SEQ_I</span><span class="p">,</span> <span class="n">SeqCtrlIndex</span><span class="p">);</span>
	<span class="n">vga_io_w</span><span class="p">(</span><span class="n">VGA_CRT_IC</span><span class="p">,</span> <span class="n">CrtCtrlIndex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_pal_blank</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">VGA_PEL_IW</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* 0 unblank, 1 blank, 2 no vsync, 3 no hsync, 4 off */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vga16fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:				<span class="cm">/* Unblank */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vesa_blanked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vga_vesa_unblank</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vesa_blanked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">palette_blanked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette_blanked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:				<span class="cm">/* blank */</span>
		<span class="n">vga_pal_blank</span><span class="p">();</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette_blanked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>			<span class="cm">/* VESA blanking */</span>
		<span class="n">vga_vesa_blank</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">blank</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vesa_blanked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_8planes_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">oldindex</span> <span class="o">=</span> <span class="n">getindex</span><span class="p">();</span>
        <span class="kt">char</span> <span class="n">oldmode</span> <span class="o">=</span> <span class="n">setmode</span><span class="p">(</span><span class="mh">0x40</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">oldmask</span> <span class="o">=</span> <span class="n">selectmask</span><span class="p">();</span>
        <span class="kt">int</span> <span class="n">line_ofs</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">oldop</span><span class="p">,</span> <span class="n">oldsr</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">where</span><span class="p">;</span>

        <span class="n">dx</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">where</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">==</span> <span class="n">ROP_COPY</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">oldop</span> <span class="o">=</span> <span class="n">setop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="n">oldsr</span> <span class="o">=</span> <span class="n">setsr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

                <span class="n">width</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
                <span class="n">line_ofs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">-</span> <span class="n">width</span><span class="p">;</span>
                <span class="n">setmask</span><span class="p">(</span><span class="mh">0xff</span><span class="p">);</span>

                <span class="n">height</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

                <span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

                        <span class="cm">/* we can do memset... */</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">writeb</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>
                                <span class="n">where</span><span class="o">++</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">where</span> <span class="o">+=</span> <span class="n">line_ofs</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kt">char</span> <span class="n">oldcolor</span> <span class="o">=</span> <span class="n">setcolor</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
                <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>

                <span class="n">oldop</span> <span class="o">=</span> <span class="n">setop</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
                <span class="n">oldsr</span> <span class="o">=</span> <span class="n">setsr</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
                <span class="n">setmask</span><span class="p">(</span><span class="mh">0x0F</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">rmw</span><span class="p">(</span><span class="n">where</span><span class="p">);</span>
                        <span class="n">rmw</span><span class="p">(</span><span class="n">where</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">where</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">setcolor</span><span class="p">(</span><span class="n">oldcolor</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">setmask</span><span class="p">(</span><span class="n">oldmask</span><span class="p">);</span>
        <span class="n">setsr</span><span class="p">(</span><span class="n">oldsr</span><span class="p">);</span>
        <span class="n">setop</span><span class="p">(</span><span class="n">oldop</span><span class="p">);</span>
        <span class="n">setmode</span><span class="p">(</span><span class="n">oldmode</span><span class="p">);</span>
        <span class="n">setindex</span><span class="p">(</span><span class="n">oldindex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga16fb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">line_ofs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>

	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">||</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We could use hardware clipping but on many cards you get around</span>
<span class="cm">	 * hardware clipping by writing to framebuffer directly. */</span>

	<span class="n">x2</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">vxres</span> <span class="o">?</span> <span class="n">x2</span> <span class="o">:</span> <span class="n">vxres</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">&lt;</span> <span class="n">vyres</span> <span class="o">?</span> <span class="n">y2</span> <span class="o">:</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_TYPE_VGA_PLANES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">==</span> <span class="n">FB_AUX_VGA_PLANES_VGA4</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">height</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>

			<span class="n">line_ofs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">-</span> <span class="n">width</span><span class="p">;</span>
			<span class="n">dst</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ROP_COPY</span>:
				<span class="n">setmode</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">setop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">setsr</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
				<span class="n">setcolor</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
				<span class="n">selectmask</span><span class="p">();</span>

				<span class="n">setmask</span><span class="p">(</span><span class="mh">0xff</span><span class="p">);</span>

				<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
						<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">dst</span> <span class="o">+=</span> <span class="n">line_ofs</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ROP_XOR</span>:
				<span class="n">setmode</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">setop</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
				<span class="n">setsr</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
				<span class="n">setcolor</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
				<span class="n">selectmask</span><span class="p">();</span>

				<span class="n">setmask</span><span class="p">(</span><span class="mh">0xff</span><span class="p">);</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">rmw</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
						<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">dst</span> <span class="o">+=</span> <span class="n">line_ofs</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> 
			<span class="n">vga_8planes_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_TYPE_PACKED_PIXELS</span>:
	<span class="nl">default:</span>
		<span class="n">cfb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_8planes_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">char</span> <span class="n">oldindex</span> <span class="o">=</span> <span class="n">getindex</span><span class="p">();</span>
        <span class="kt">char</span> <span class="n">oldmode</span> <span class="o">=</span> <span class="n">setmode</span><span class="p">(</span><span class="mh">0x41</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">oldop</span> <span class="o">=</span> <span class="n">setop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">oldsr</span> <span class="o">=</span> <span class="n">setsr</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="n">line_ofs</span><span class="p">,</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">width</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

        <span class="n">height</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

        <span class="n">sx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&lt;</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">||</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">==</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">&amp;&amp;</span> <span class="n">dx</span> <span class="o">&lt;</span> <span class="n">sx</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">line_ofs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">-</span> <span class="n">width</span><span class="p">;</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">readb</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
                                <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
                                <span class="n">src</span><span class="o">++</span><span class="p">;</span>
                                <span class="n">dest</span><span class="o">++</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">src</span> <span class="o">+=</span> <span class="n">line_ofs</span><span class="p">;</span>
                        <span class="n">dest</span> <span class="o">+=</span> <span class="n">line_ofs</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">line_ofs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">-</span> <span class="n">width</span><span class="p">;</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                <span class="o">--</span><span class="n">src</span><span class="p">;</span>
                                <span class="o">--</span><span class="n">dest</span><span class="p">;</span>
                                <span class="n">readb</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
                                <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="n">src</span> <span class="o">-=</span> <span class="n">line_ofs</span><span class="p">;</span>
                        <span class="n">dest</span> <span class="o">-=</span> <span class="n">line_ofs</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">setsr</span><span class="p">(</span><span class="n">oldsr</span><span class="p">);</span>
        <span class="n">setop</span><span class="p">(</span><span class="n">oldop</span><span class="p">);</span>
        <span class="n">setmode</span><span class="p">(</span><span class="n">oldmode</span><span class="p">);</span>
        <span class="n">setindex</span><span class="p">(</span><span class="n">oldindex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga16fb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="n">sx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">;</span> 
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">old_dx</span><span class="p">,</span> <span class="n">old_dy</span><span class="p">,</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">line_ofs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">&gt;</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="n">vyres</span> <span class="o">||</span>
	    <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* clip the destination */</span>
	<span class="n">old_dx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">old_dy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We could use hardware clipping but on many cards you get around</span>
<span class="cm">	 * hardware clipping by writing to framebuffer directly.</span>
<span class="cm">	 */</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">dx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">vxres</span> <span class="o">?</span> <span class="n">x2</span> <span class="o">:</span> <span class="n">vxres</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">&lt;</span> <span class="n">vyres</span> <span class="o">?</span> <span class="n">y2</span> <span class="o">:</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">dx</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">dy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sx</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">&lt;</span> <span class="n">old_dx</span> <span class="o">||</span> <span class="n">sy</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">&lt;</span> <span class="n">old_dy</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* update sx1,sy1 */</span>
	<span class="n">sx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dx</span> <span class="o">-</span> <span class="n">old_dx</span><span class="p">);</span>
	<span class="n">sy</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dy</span> <span class="o">-</span> <span class="n">old_dy</span><span class="p">);</span>

	<span class="cm">/* the source must be completely inside the virtual screen */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">sy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_TYPE_VGA_PLANES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">==</span> <span class="n">FB_AUX_VGA_PLANES_VGA4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
			<span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
			<span class="n">line_ofs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">-</span> <span class="n">width</span><span class="p">;</span>

			<span class="n">setmode</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">setop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">setsr</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">&lt;</span> <span class="n">sy</span> <span class="o">||</span> <span class="p">(</span><span class="n">dy</span> <span class="o">==</span> <span class="n">sy</span> <span class="o">&amp;&amp;</span> <span class="n">dx</span> <span class="o">&lt;</span> <span class="n">sx</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dst</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">dx</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
				<span class="n">src</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">sx</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">readb</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
						<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
						<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
						<span class="n">src</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">src</span> <span class="o">+=</span> <span class="n">line_ofs</span><span class="p">;</span>
					<span class="n">dst</span> <span class="o">+=</span> <span class="n">line_ofs</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dst</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">dx</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">width</span> <span class="o">+</span> 
					<span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
				<span class="n">src</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">sx</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">width</span> <span class="o">+</span> 
					<span class="p">(</span><span class="n">sy</span> <span class="o">+</span> <span class="n">height</span>  <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dst</span><span class="o">--</span><span class="p">;</span>
						<span class="n">src</span><span class="o">--</span><span class="p">;</span>
						<span class="n">readb</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
						<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">src</span> <span class="o">-=</span> <span class="n">line_ofs</span><span class="p">;</span>
					<span class="n">dst</span> <span class="o">-=</span> <span class="n">line_ofs</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> 
			<span class="n">vga_8planes_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_TYPE_PACKED_PIXELS</span>:
	<span class="nl">default:</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define TRANS_MASK_LOW  {0x0,0x8,0x4,0xC,0x2,0xA,0x6,0xE,0x1,0x9,0x5,0xD,0x3,0xB,0x7,0xF}</span>
<span class="cp">#define TRANS_MASK_HIGH {0x000, 0x800, 0x400, 0xC00, 0x200, 0xA00, 0x600, 0xE00, \</span>
<span class="cp">			 0x100, 0x900, 0x500, 0xD00, 0x300, 0xB00, 0x700, 0xF00}</span>

<span class="cp">#if defined(__LITTLE_ENDIAN)</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">transl_l</span><span class="p">[]</span> <span class="o">=</span> <span class="n">TRANS_MASK_LOW</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">transl_h</span><span class="p">[]</span> <span class="o">=</span> <span class="n">TRANS_MASK_HIGH</span><span class="p">;</span>
<span class="cp">#elif defined(__BIG_ENDIAN)</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">transl_l</span><span class="p">[]</span> <span class="o">=</span> <span class="n">TRANS_MASK_HIGH</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">transl_h</span><span class="p">[]</span> <span class="o">=</span> <span class="n">TRANS_MASK_LOW</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Only __BIG_ENDIAN and __LITTLE_ENDIAN are supported in vga-planes&quot;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_8planes_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">char</span> <span class="n">oldindex</span> <span class="o">=</span> <span class="n">getindex</span><span class="p">();</span>
        <span class="kt">char</span> <span class="n">oldmode</span> <span class="o">=</span> <span class="n">setmode</span><span class="p">(</span><span class="mh">0x40</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">oldop</span> <span class="o">=</span> <span class="n">setop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">oldsr</span> <span class="o">=</span> <span class="n">setsr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">oldmask</span> <span class="o">=</span> <span class="n">selectmask</span><span class="p">();</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdat</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">where</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>

        <span class="n">dx</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">where</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>

        <span class="n">setmask</span><span class="p">(</span><span class="mh">0xff</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>
        <span class="n">readb</span><span class="p">(</span><span class="n">where</span><span class="p">);</span>
        <span class="n">selectmask</span><span class="p">();</span>
        <span class="n">setmask</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span> <span class="o">^</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">);</span>
        <span class="n">setmode</span><span class="p">(</span><span class="mh">0x42</span><span class="p">);</span>
        <span class="n">setop</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">,</span> <span class="n">where</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">)</span>
                <span class="n">writew</span><span class="p">(</span><span class="n">transl_h</span><span class="p">[</span><span class="n">cdat</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xF</span><span class="p">]</span> <span class="o">|</span> <span class="n">transl_l</span><span class="p">[</span><span class="n">cdat</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">],</span> <span class="n">where</span><span class="p">);</span>
        <span class="n">setmask</span><span class="p">(</span><span class="n">oldmask</span><span class="p">);</span>
        <span class="n">setsr</span><span class="p">(</span><span class="n">oldsr</span><span class="p">);</span>
        <span class="n">setop</span><span class="p">(</span><span class="n">oldop</span><span class="p">);</span>
        <span class="n">setmode</span><span class="p">(</span><span class="n">oldmode</span><span class="p">);</span>
        <span class="n">setindex</span><span class="p">(</span><span class="n">oldindex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_imageblit_expand</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">where</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cdat</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_TYPE_VGA_PLANES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">==</span> <span class="n">FB_AUX_VGA_PLANES_VGA4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">isVGA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">setmode</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
				<span class="n">setop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">setsr</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
				<span class="n">setcolor</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">);</span>
				<span class="n">selectmask</span><span class="p">();</span>
				
				<span class="n">setmask</span><span class="p">(</span><span class="mh">0xff</span><span class="p">);</span>
				<span class="n">writeb</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>
				<span class="n">rmb</span><span class="p">();</span>
				<span class="n">readb</span><span class="p">(</span><span class="n">where</span><span class="p">);</span> <span class="cm">/* fill latches */</span>
				<span class="n">setmode</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
				<span class="n">wmb</span><span class="p">();</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dst</span> <span class="o">=</span> <span class="n">where</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">;)</span> 
						<span class="n">writeb</span><span class="p">(</span><span class="o">*</span><span class="n">cdat</span><span class="o">++</span><span class="p">,</span> <span class="n">dst</span><span class="o">++</span><span class="p">);</span>
					<span class="n">where</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">wmb</span><span class="p">();</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">setmode</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">setop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">setsr</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
				<span class="n">setcolor</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">);</span>
				<span class="n">selectmask</span><span class="p">();</span>
				
				<span class="n">setmask</span><span class="p">(</span><span class="mh">0xff</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dst</span> <span class="o">=</span> <span class="n">where</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">;){</span>
						<span class="n">rmw</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
						<span class="n">setcolor</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">);</span>
						<span class="n">selectmask</span><span class="p">();</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cdat</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">setmask</span><span class="p">(</span><span class="o">*</span><span class="n">cdat</span><span class="o">++</span><span class="p">);</span>
							<span class="n">rmw</span><span class="p">(</span><span class="n">dst</span><span class="o">++</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">where</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> 
			<span class="n">vga_8planes_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_TYPE_PACKED_PIXELS</span>:
	<span class="nl">default:</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_imageblit_color</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Draw logo </span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">where</span> <span class="o">=</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">+</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdat</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_TYPE_VGA_PLANES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">==</span> <span class="n">FB_AUX_VGA_PLANES_VGA4</span> <span class="o">&amp;&amp;</span>
		    <span class="n">par</span><span class="o">-&gt;</span><span class="n">isVGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">setsr</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
			<span class="n">setop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">setmode</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			
			<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dst</span> <span class="o">=</span> <span class="n">where</span> <span class="o">+</span> <span class="n">x</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>

					<span class="n">setcolor</span><span class="p">(</span><span class="o">*</span><span class="n">cdat</span><span class="p">);</span>
					<span class="n">selectmask</span><span class="p">();</span>
					<span class="n">setmask</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)));</span>
					<span class="n">fb_readb</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
					<span class="n">fb_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>

					<span class="n">cdat</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">where</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_TYPE_PACKED_PIXELS</span>:
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
				
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga16fb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">vga_imageblit_expand</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vga_imageblit_color</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga16fb_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
	<span class="cm">/* XXX unshare VGA regions */</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">vga16fb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>        <span class="o">=</span> <span class="n">vga16fb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>     <span class="o">=</span> <span class="n">vga16fb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_destroy</span>	<span class="o">=</span> <span class="n">vga16fb_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">vga16fb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">vga16fb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span> 	<span class="o">=</span> <span class="n">vga16fb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">vga16fb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span> 	<span class="o">=</span> <span class="n">vga16fb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">vga16fb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">vga16fb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">vga16fb_imageblit</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">vga16fb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">vga16fb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vga16fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;vga16fb: initializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vga16fb_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_fb_alloc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">apertures</span> <span class="o">=</span> <span class="n">alloc_apertures</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">apertures</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* XXX share VGA_FB_PHYS and I/O region with vgacon and others */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">VGA_MAP_MEM</span><span class="p">(</span><span class="n">VGA_FB_PHYS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vga16fb: unable to map device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;vga16fb: mapped to 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">isVGA</span> <span class="o">=</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_isVGA</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette_blanked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vesa_blanked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">isVGA</span><span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	
	<span class="n">vga16fb_defined</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>   <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">vga16fb_defined</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">vga16fb_defined</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="n">i</span><span class="p">;</span>	

	<span class="cm">/* name should not depend on EGA/VGA */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vga16fb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">vga16fb_defined</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">vga16fb_fix</span><span class="p">;</span>
	<span class="cm">/* supports rectangles with widths of multiples of 8 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">blit_x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_MISC_FIRMWARE</span> <span class="o">|</span>
		<span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vga16fb: unable to allocate colormap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc_cmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vga16fb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vga16fb: unable to validate variable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_check_var</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vga16fb_update_fix</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">apertures</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">VGA_FB_PHYS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">apertures</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">VGA_FB_PHYS_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vga16fb: unable to register framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_check_var</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_check_var:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
 <span class="nl">err_alloc_cmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
 <span class="nl">err_ioremap:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
 <span class="nl">err_fb_alloc:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">vga16fb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span>
		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">vga16fb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">vga16fb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">vga16fb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;vga16fb&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">vga16fb_device</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">vga16fb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;vga16fb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">vga16fb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga16fb_driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga16fb_device</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;vga16fb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vga16fb_device</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">vga16fb_device</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">platform_device_put</span><span class="p">(</span><span class="n">vga16fb_device</span><span class="p">);</span>
			<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga16fb_driver</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">vga16fb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">vga16fb_device</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga16fb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Legacy VGA framebuffer device driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">vga16fb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">vga16fb_exit</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Overrides for Emacs so that we follow Linus&#39;s tabbing style.</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
