<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › riva › riva_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>riva_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre> <span class="cm">/***************************************************************************\</span>
<span class="cm">|*                                                                           *|</span>
<span class="cm">|*       Copyright 1993-1999 NVIDIA, Corporation.  All rights reserved.      *|</span>
<span class="cm">|*                                                                           *|</span>
<span class="cm">|*     NOTICE TO USER:   The source code  is copyrighted under  U.S. and     *|</span>
<span class="cm">|*     international laws.  Users and possessors of this source code are     *|</span>
<span class="cm">|*     hereby granted a nonexclusive,  royalty-free copyright license to     *|</span>
<span class="cm">|*     use this code in individual and commercial software.                  *|</span>
<span class="cm">|*                                                                           *|</span>
<span class="cm">|*     Any use of this source code must include,  in the user documenta-     *|</span>
<span class="cm">|*     tion and  internal comments to the code,  notices to the end user     *|</span>
<span class="cm">|*     as follows:                                                           *|</span>
<span class="cm">|*                                                                           *|</span>
<span class="cm">|*       Copyright 1993-1999 NVIDIA, Corporation.  All rights reserved.      *|</span>
<span class="cm">|*                                                                           *|</span>
<span class="cm">|*     NVIDIA, CORPORATION MAKES NO REPRESENTATION ABOUT THE SUITABILITY     *|</span>
<span class="cm">|*     OF  THIS SOURCE  CODE  FOR ANY PURPOSE.  IT IS  PROVIDED  &quot;AS IS&quot;     *|</span>
<span class="cm">|*     WITHOUT EXPRESS OR IMPLIED WARRANTY OF ANY KIND.  NVIDIA, CORPOR-     *|</span>
<span class="cm">|*     ATION DISCLAIMS ALL WARRANTIES  WITH REGARD  TO THIS SOURCE CODE,     *|</span>
<span class="cm">|*     INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY, NONINFRINGE-     *|</span>
<span class="cm">|*     MENT,  AND FITNESS  FOR A PARTICULAR PURPOSE.   IN NO EVENT SHALL     *|</span>
<span class="cm">|*     NVIDIA, CORPORATION  BE LIABLE FOR ANY SPECIAL,  INDIRECT,  INCI-     *|</span>
<span class="cm">|*     DENTAL, OR CONSEQUENTIAL DAMAGES,  OR ANY DAMAGES  WHATSOEVER RE-     *|</span>
<span class="cm">|*     SULTING FROM LOSS OF USE,  DATA OR PROFITS,  WHETHER IN AN ACTION     *|</span>
<span class="cm">|*     OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION,  ARISING OUT OF     *|</span>
<span class="cm">|*     OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOURCE CODE.     *|</span>
<span class="cm">|*                                                                           *|</span>
<span class="cm">|*     U.S. Government  End  Users.   This source code  is a &quot;commercial     *|</span>
<span class="cm">|*     item,&quot;  as that  term is  defined at  48 C.F.R. 2.101 (OCT 1995),     *|</span>
<span class="cm">|*     consisting  of &quot;commercial  computer  software&quot;  and  &quot;commercial     *|</span>
<span class="cm">|*     computer  software  documentation,&quot;  as such  terms  are  used in     *|</span>
<span class="cm">|*     48 C.F.R. 12.212 (SEPT 1995)  and is provided to the U.S. Govern-     *|</span>
<span class="cm">|*     ment only as  a commercial end item.   Consistent with  48 C.F.R.     *|</span>
<span class="cm">|*     12.212 and  48 C.F.R. 227.7202-1 through  227.7202-4 (JUNE 1995),     *|</span>
<span class="cm">|*     all U.S. Government End Users  acquire the source code  with only     *|</span>
<span class="cm">|*     those rights set forth herein.                                        *|</span>
<span class="cm">|*                                                                           *|</span>
<span class="cm"> \***************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * GPL licensing note -- nVidia is allowing a liberal interpretation of</span>
<span class="cm"> * the documentation restriction above, to merely say that this nVidia&#39;s</span>
<span class="cm"> * copyright and disclaimer should be included with all code derived</span>
<span class="cm"> * from this source.  -- Jeff Garzik &lt;jgarzik@pobox.com&gt;, 01/Nov/99 </span>
<span class="cm"> */</span>

<span class="cm">/* $XFree86: xc/programs/Xserver/hw/xfree86/drivers/nv/riva_hw.c,v 1.33 2002/08/05 20:47:06 mvojkovi Exp $ */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>
<span class="cp">#include &quot;riva_hw.h&quot;</span>
<span class="cp">#include &quot;riva_tbl.h&quot;</span>
<span class="cp">#include &quot;nv_type.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * This file is an OS-agnostic file used to make RIVA 128 and RIVA TNT</span>
<span class="cm"> * operate identically (except TNT has more memory and better 3D quality.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv3Busy</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Rop</span><span class="o">-&gt;</span><span class="n">FifoFree</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">FifoEmptyCount</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">[</span><span class="mh">0x000006B0</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv4Busy</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Rop</span><span class="o">-&gt;</span><span class="n">FifoFree</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">FifoEmptyCount</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">[</span><span class="mh">0x00000700</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv10Busy</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Rop</span><span class="o">-&gt;</span><span class="n">FifoFree</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">FifoEmptyCount</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">[</span><span class="mh">0x00000700</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgaLockUnlock</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">int</span>           <span class="n">Lock</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">U008</span> <span class="n">cr11</span><span class="p">;</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D4</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
    <span class="n">cr11</span> <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Lock</span><span class="p">)</span> <span class="n">cr11</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="k">else</span> <span class="n">cr11</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">,</span> <span class="n">cr11</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv3LockUnlock</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">int</span>           <span class="n">Lock</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PVIO</span><span class="p">,</span> <span class="mh">0x3C4</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PVIO</span><span class="p">,</span> <span class="mh">0x3C5</span><span class="p">,</span> <span class="n">Lock</span> <span class="o">?</span> <span class="mh">0x99</span> <span class="o">:</span> <span class="mh">0x57</span><span class="p">);</span>
    <span class="n">vgaLockUnlock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv4LockUnlock</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">int</span>           <span class="n">Lock</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D4</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">,</span> <span class="n">Lock</span> <span class="o">?</span> <span class="mh">0x99</span> <span class="o">:</span> <span class="mh">0x57</span><span class="p">);</span>
    <span class="n">vgaLockUnlock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ShowHideCursor</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">int</span>           <span class="n">ShowHide</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">cursor</span><span class="p">;</span>
    <span class="n">cursor</span>                      <span class="o">=</span>  <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CurrentState</span><span class="o">-&gt;</span><span class="n">cursor1</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CurrentState</span><span class="o">-&gt;</span><span class="n">cursor1</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">CurrentState</span><span class="o">-&gt;</span><span class="n">cursor1</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span> <span class="o">|</span>
                                  <span class="p">(</span><span class="n">ShowHide</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D4</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CurrentState</span><span class="o">-&gt;</span><span class="n">cursor1</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">cursor</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************\</span>
<span class="cm">*                                                                            *</span>
<span class="cm">* The video arbitration routines calculate some &quot;magic&quot; numbers.  Fixes      *</span>
<span class="cm">* the snow seen when accessing the framebuffer without it.                   *</span>
<span class="cm">* It just works (I hope).                                                    *</span>
<span class="cm">*                                                                            *</span>
<span class="cm">\****************************************************************************/</span>

<span class="cp">#define DEFAULT_GR_LWM 100</span>
<span class="cp">#define DEFAULT_VID_LWM 100</span>
<span class="cp">#define DEFAULT_GR_BURST_SIZE 256</span>
<span class="cp">#define DEFAULT_VID_BURST_SIZE 128</span>
<span class="cp">#define VIDEO		0</span>
<span class="cp">#define GRAPHICS	1</span>
<span class="cp">#define MPORT		2</span>
<span class="cp">#define ENGINE		3</span>
<span class="cp">#define GFIFO_SIZE	320</span>
<span class="cp">#define GFIFO_SIZE_128	256</span>
<span class="cp">#define MFIFO_SIZE	120</span>
<span class="cp">#define VFIFO_SIZE	256</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">gdrain_rate</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">vdrain_rate</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mdrain_rate</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">gburst_size</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">vburst_size</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">vid_en</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">gr_en</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">wcmocc</span><span class="p">,</span> <span class="n">wcgocc</span><span class="p">,</span> <span class="n">wcvocc</span><span class="p">,</span> <span class="n">wcvlwm</span><span class="p">,</span> <span class="n">wcglwm</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">by_gfacc</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">vid_only_once</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">gr_only_once</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">first_vacc</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">first_gacc</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">first_macc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">vocc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">gocc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mocc</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">cur</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">engine_en</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">converged</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>
<span class="p">}</span> <span class="n">nv3_arb_info</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">graphics_lwm</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">video_lwm</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">graphics_burst_size</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">video_burst_size</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">graphics_hi_priority</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">media_hi_priority</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rtl_values</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">valid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">nv3_fifo_info</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">pix_bpp</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">enable_video</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">gr_during_vid</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">enable_mp</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">memory_width</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">video_scale</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">pclk_khz</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mclk_khz</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mem_page_miss</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mem_latency</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">mem_aligned</span><span class="p">;</span>
<span class="p">}</span> <span class="n">nv3_sim_state</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">graphics_lwm</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">video_lwm</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">graphics_burst_size</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">video_burst_size</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">valid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">nv4_fifo_info</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">pclk_khz</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mclk_khz</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nvclk_khz</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">mem_page_miss</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">mem_latency</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">memory_width</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">enable_video</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">gr_during_vid</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">pix_bpp</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">mem_aligned</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">enable_mp</span><span class="p">;</span>
<span class="p">}</span> <span class="n">nv4_sim_state</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">graphics_lwm</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">video_lwm</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">graphics_burst_size</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">video_burst_size</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">valid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">nv10_fifo_info</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">pclk_khz</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mclk_khz</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nvclk_khz</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">mem_page_miss</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">mem_latency</span><span class="p">;</span>
  <span class="n">u32</span> <span class="n">memory_type</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">memory_width</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">enable_video</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">gr_during_vid</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">pix_bpp</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">mem_aligned</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">enable_mp</span><span class="p">;</span>
<span class="p">}</span> <span class="n">nv10_sim_state</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv3_iterate</span><span class="p">(</span><span class="n">nv3_fifo_info</span> <span class="o">*</span><span class="n">res_info</span><span class="p">,</span> <span class="n">nv3_sim_state</span> <span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="n">nv3_arb_info</span> <span class="o">*</span><span class="n">ainfo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">vfsize</span><span class="p">,</span> <span class="n">mfsize</span><span class="p">,</span> <span class="n">gfsize</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">mburst_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">mmisses</span><span class="p">,</span> <span class="n">gmisses</span><span class="p">,</span> <span class="n">vmisses</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">misses</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">vlwm</span><span class="p">,</span> <span class="n">glwm</span><span class="p">,</span> <span class="n">mlwm</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">last</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">cur</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">max_gfsize</span> <span class="p">;</span>
    <span class="kt">long</span> <span class="n">ns</span><span class="p">;</span>

    <span class="n">vlwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">glwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">mlwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">vfsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">gfsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">;</span>
    <span class="n">mmisses</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">gmisses</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">vmisses</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gburst_size</span> <span class="o">==</span> <span class="mi">128</span><span class="p">)</span> <span class="n">max_gfsize</span> <span class="o">=</span> <span class="n">GFIFO_SIZE_128</span><span class="p">;</span>
    <span class="k">else</span>  <span class="n">max_gfsize</span> <span class="o">=</span> <span class="n">GFIFO_SIZE</span><span class="p">;</span>
    <span class="n">max_gfsize</span> <span class="o">=</span> <span class="n">GFIFO_SIZE</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_en</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcvocc</span> <span class="o">&gt;</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span><span class="p">)</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcvocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcvlwm</span> <span class="o">&gt;</span> <span class="n">vlwm</span><span class="p">)</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcvlwm</span> <span class="o">=</span> <span class="n">vlwm</span> <span class="p">;</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vburst_size</span><span class="o">/</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
            <span class="n">vfsize</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">*</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vdrain_rate</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
            <span class="n">vfsize</span> <span class="o">=</span>  <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcvlwm</span> <span class="o">-</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vburst_size</span> <span class="o">+</span> <span class="n">vfsize</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_mp</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcmocc</span> <span class="o">&gt;</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span><span class="p">)</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcmocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gr_en</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcglwm</span> <span class="o">&gt;</span> <span class="n">glwm</span><span class="p">)</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcglwm</span> <span class="o">=</span> <span class="n">glwm</span> <span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcgocc</span> <span class="o">&gt;</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span><span class="p">)</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcgocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span><span class="p">;</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gburst_size</span><span class="o">/</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
            <span class="n">gfsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns</span> <span class="o">*</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gdrain_rate</span><span class="p">)</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
            <span class="n">gfsize</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcglwm</span> <span class="o">-</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gburst_size</span> <span class="o">+</span> <span class="n">gfsize</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">mfsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">gr_during_vid</span> <span class="o">&amp;&amp;</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_en</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_only_once</span><span class="p">)</span>
                <span class="n">next</span> <span class="o">=</span> <span class="n">VIDEO</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">next</span> <span class="o">=</span> <span class="n">MPORT</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span><span class="o">&lt;</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">by_gfacc</span><span class="p">)</span>
                <span class="n">next</span> <span class="o">=</span> <span class="n">GRAPHICS</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">switch</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="n">VIDEO</span>:
                    <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_en</span> <span class="o">&amp;&amp;</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_only_once</span><span class="p">)</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">VIDEO</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gr_en</span> <span class="o">&amp;&amp;</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gr_only_once</span><span class="p">)</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">GRAPHICS</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">MPORT</span><span class="p">;</span>
                    <span class="k">else</span>    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">GRAPHICS</span>:
                    <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gr_en</span> <span class="o">&amp;&amp;</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gr_only_once</span><span class="p">)</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">GRAPHICS</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_en</span> <span class="o">&amp;&amp;</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_only_once</span><span class="p">)</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">VIDEO</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">MPORT</span><span class="p">;</span>
                    <span class="k">else</span>    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="nl">default:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">MPORT</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gr_en</span> <span class="o">&amp;&amp;</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gr_only_once</span><span class="p">)</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">GRAPHICS</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_en</span> <span class="o">&amp;&amp;</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_only_once</span><span class="p">)</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">VIDEO</span><span class="p">;</span>
                    <span class="k">else</span>    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
        <span class="n">iter</span><span class="o">++</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="n">VIDEO</span>:
                <span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="o">==</span><span class="n">cur</span><span class="p">)</span>    <span class="n">misses</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_vacc</span><span class="p">)</span>   <span class="n">misses</span> <span class="o">=</span> <span class="n">vmisses</span><span class="p">;</span>
                <span class="k">else</span>    <span class="n">misses</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_vacc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="o">!=</span><span class="n">cur</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">ns</span> <span class="o">=</span>  <span class="mi">1000000</span> <span class="o">*</span> <span class="p">(</span><span class="n">vmisses</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_latency</span><span class="p">)</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span> 
                    <span class="n">vlwm</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">*</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vdrain_rate</span><span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
                    <span class="n">vlwm</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">-</span> <span class="n">vlwm</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">*</span><span class="p">(</span><span class="n">misses</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span> <span class="o">+</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vburst_size</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">+</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vburst_size</span> <span class="o">-</span> <span class="n">ns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span> <span class="o">-</span> <span class="n">ns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span> <span class="o">-</span> <span class="n">ns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">GRAPHICS</span>:
                <span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="o">==</span><span class="n">cur</span><span class="p">)</span>    <span class="n">misses</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_gacc</span><span class="p">)</span>   <span class="n">misses</span> <span class="o">=</span> <span class="n">gmisses</span><span class="p">;</span>
                <span class="k">else</span>    <span class="n">misses</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_gacc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="o">!=</span><span class="n">cur</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">ns</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">*</span><span class="p">(</span><span class="n">gmisses</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_latency</span><span class="p">)</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span> <span class="p">;</span>
                    <span class="n">glwm</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">*</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
                    <span class="n">glwm</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span> <span class="o">-</span> <span class="n">glwm</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">*</span><span class="p">(</span><span class="n">misses</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span> <span class="o">+</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gburst_size</span><span class="o">/</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">ns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span> <span class="o">+</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gburst_size</span> <span class="o">-</span> <span class="n">ns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">ns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="nl">default:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="o">==</span><span class="n">cur</span><span class="p">)</span>    <span class="n">misses</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_macc</span><span class="p">)</span>   <span class="n">misses</span> <span class="o">=</span> <span class="n">mmisses</span><span class="p">;</span>
                <span class="k">else</span>    <span class="n">misses</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_macc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">*</span><span class="p">(</span><span class="n">misses</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span> <span class="o">+</span> <span class="n">mburst_size</span><span class="o">/</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">ns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">ns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span> <span class="o">+</span> <span class="n">mburst_size</span> <span class="o">-</span> <span class="n">ns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gburst_size</span><span class="o">/</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">*</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gburst_size</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">abs</span><span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcglwm</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">)</span> <span class="o">-</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">max_gfsize</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vburst_size</span><span class="o">/</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">*</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vburst_size</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcvlwm</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">)</span>  <span class="o">-</span> <span class="n">tmp</span><span class="o">&gt;</span> <span class="n">VFIFO_SIZE</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_gfsize</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">VFIFO_SIZE</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MFIFO_SIZE</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">vfsize</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">VFIFO_SIZE</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">gfsize</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_gfsize</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">mfsize</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MFIFO_SIZE</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">char</span> <span class="nf">nv3_arb</span><span class="p">(</span><span class="n">nv3_fifo_info</span> <span class="o">*</span> <span class="n">res_info</span><span class="p">,</span> <span class="n">nv3_sim_state</span> <span class="o">*</span> <span class="n">state</span><span class="p">,</span>  <span class="n">nv3_arb_info</span> <span class="o">*</span><span class="n">ainfo</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="kt">long</span> <span class="n">ens</span><span class="p">,</span> <span class="n">vns</span><span class="p">,</span> <span class="n">mns</span><span class="p">,</span> <span class="n">gns</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">mmisses</span><span class="p">,</span> <span class="n">gmisses</span><span class="p">,</span> <span class="n">vmisses</span><span class="p">,</span> <span class="n">eburst_size</span><span class="p">,</span> <span class="n">mburst_size</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">refresh_cycle</span><span class="p">;</span>

    <span class="n">refresh_cycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">refresh_cycle</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pclk_khz</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">mmisses</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_aligned</span><span class="p">)</span> <span class="n">gmisses</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">else</span>    <span class="n">gmisses</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">vmisses</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">eburst_size</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span> <span class="o">*</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mburst_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
    <span class="n">gns</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="p">(</span><span class="n">gmisses</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_latency</span><span class="p">)</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">by_gfacc</span> <span class="o">=</span> <span class="n">gns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcmocc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcgocc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcvocc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcvlwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcglwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">engine_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">engine_en</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ens</span> <span class="o">=</span>  <span class="mi">1000000</span><span class="o">*</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span> <span class="o">+</span> <span class="n">eburst_size</span><span class="o">/</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span><span class="n">refresh_cycle</span><span class="p">)</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_mp</span> <span class="o">?</span> <span class="mi">0</span><span class="o">-</span><span class="n">ens</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mdrain_rate</span><span class="o">/</span><span class="mi">1000000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_en</span> <span class="o">?</span> <span class="mi">0</span><span class="o">-</span><span class="n">ens</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vdrain_rate</span><span class="o">/</span><span class="mi">1000000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gr_en</span> <span class="o">?</span> <span class="mi">0</span><span class="o">-</span><span class="n">ens</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gdrain_rate</span><span class="o">/</span><span class="mi">1000000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">ENGINE</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_vacc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_gacc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_macc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">nv3_iterate</span><span class="p">(</span><span class="n">res_info</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span><span class="n">ainfo</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_mp</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">mns</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="p">(</span><span class="n">mmisses</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span> <span class="o">+</span> <span class="n">mburst_size</span><span class="o">/</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">refresh_cycle</span><span class="p">)</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_mp</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">mburst_size</span> <span class="o">-</span> <span class="n">mns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_en</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">0</span><span class="o">-</span> <span class="n">mns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gr_en</span> <span class="o">?</span> <span class="mi">0</span><span class="o">:</span> <span class="mi">0</span><span class="o">-</span> <span class="n">mns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">MPORT</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_vacc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_gacc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_macc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">nv3_iterate</span><span class="p">(</span><span class="n">res_info</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span><span class="n">ainfo</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gr_en</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_vacc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_gacc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_macc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">gns</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">*</span><span class="p">(</span><span class="n">gmisses</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span> <span class="o">+</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gburst_size</span><span class="o">/</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">refresh_cycle</span><span class="p">)</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gburst_size</span> <span class="o">-</span> <span class="n">gns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_en</span><span class="o">?</span> <span class="mi">0</span><span class="o">-</span><span class="n">gns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vdrain_rate</span><span class="o">/</span><span class="mi">1000000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_mp</span> <span class="o">?</span>  <span class="mi">0</span><span class="o">-</span><span class="n">gns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">GRAPHICS</span><span class="p">;</span>
        <span class="n">nv3_iterate</span><span class="p">(</span><span class="n">res_info</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span><span class="n">ainfo</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vid_en</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_vacc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_gacc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">first_macc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">vns</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">*</span><span class="p">(</span><span class="n">vmisses</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span> <span class="o">+</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vburst_size</span><span class="o">/</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">refresh_cycle</span><span class="p">)</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vburst_size</span> <span class="o">-</span> <span class="n">vns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gocc</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gr_en</span><span class="o">?</span> <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">vns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gdrain_rate</span><span class="o">/</span><span class="mi">1000000</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mocc</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_mp</span><span class="o">?</span> <span class="mi">0</span><span class="o">-</span><span class="n">vns</span><span class="o">*</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">mdrain_rate</span><span class="o">/</span><span class="mi">1000000</span> <span class="o">:</span><span class="mi">0</span> <span class="p">;</span>
        <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">VIDEO</span><span class="p">;</span>
        <span class="n">nv3_iterate</span><span class="p">(</span><span class="n">res_info</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">ainfo</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">graphics_lwm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">abs</span><span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcglwm</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_lwm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">abs</span><span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">wcvlwm</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">graphics_burst_size</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gburst_size</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_burst_size</span> <span class="o">=</span> <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vburst_size</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">graphics_hi_priority</span> <span class="o">=</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">==</span> <span class="n">GRAPHICS</span><span class="p">);</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">media_hi_priority</span> <span class="o">=</span> <span class="p">(</span><span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">==</span> <span class="n">MPORT</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_lwm</span> <span class="o">&gt;</span> <span class="mi">160</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">graphics_lwm</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
            <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_lwm</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
            <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">graphics_burst_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
            <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_burst_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
            <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">graphics_hi_priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">media_hi_priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">converged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_lwm</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_lwm</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">graphics_lwm</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_lwm</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">graphics_burst_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_burst_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">graphics_hi_priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">media_hi_priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">char</span> <span class="nf">nv3_get_param</span><span class="p">(</span><span class="n">nv3_fifo_info</span> <span class="o">*</span><span class="n">res_info</span><span class="p">,</span> <span class="n">nv3_sim_state</span> <span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="n">nv3_arb_info</span> <span class="o">*</span><span class="n">ainfo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">done</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
    
    <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">g</span><span class="o">=</span><span class="mi">128</span> <span class="p">;</span> <span class="n">g</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">g</span><span class="o">=</span> <span class="n">g</span><span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="mi">128</span><span class="p">;</span> <span class="n">v</span> <span class="o">&gt;=</span><span class="mi">32</span><span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">gburst_size</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>     
                <span class="n">ainfo</span><span class="o">-&gt;</span><span class="n">vburst_size</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
                <span class="n">done</span> <span class="o">=</span> <span class="n">nv3_arb</span><span class="p">(</span><span class="n">res_info</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span><span class="n">ainfo</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">g</span><span class="o">==</span><span class="mi">128</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">res_info</span><span class="o">-&gt;</span><span class="n">graphics_lwm</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
                        <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span>
                    <span class="k">goto</span> <span class="n">Done</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

 <span class="nl">Done:</span>
    <span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv3CalcArbitration</span> 
<span class="p">(</span>
    <span class="n">nv3_fifo_info</span> <span class="o">*</span> <span class="n">res_info</span><span class="p">,</span>
    <span class="n">nv3_sim_state</span> <span class="o">*</span> <span class="n">state</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">nv3_fifo_info</span> <span class="n">save_info</span><span class="p">;</span>
    <span class="n">nv3_arb_info</span> <span class="n">ainfo</span><span class="p">;</span>
    <span class="kt">char</span>   <span class="n">res_gr</span><span class="p">,</span> <span class="n">res_vid</span><span class="p">;</span>

    <span class="n">ainfo</span><span class="p">.</span><span class="n">gr_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="p">.</span><span class="n">vid_en</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_video</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="p">.</span><span class="n">vid_only_once</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="p">.</span><span class="n">gr_only_once</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="p">.</span><span class="n">gdrain_rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pclk_khz</span> <span class="o">*</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pix_bpp</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
    <span class="n">ainfo</span><span class="p">.</span><span class="n">vdrain_rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pclk_khz</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">video_scale</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ainfo</span><span class="p">.</span><span class="n">vdrain_rate</span> <span class="o">=</span> <span class="n">ainfo</span><span class="p">.</span><span class="n">vdrain_rate</span><span class="o">/</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">video_scale</span><span class="p">;</span>
    <span class="n">ainfo</span><span class="p">.</span><span class="n">mdrain_rate</span> <span class="o">=</span> <span class="mi">33000</span><span class="p">;</span>
    <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">rtl_values</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">gr_during_vid</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_video</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ainfo</span><span class="p">.</span><span class="n">gr_only_once</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="p">.</span><span class="n">gr_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="p">.</span><span class="n">gdrain_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">res_vid</span> <span class="o">=</span> <span class="n">nv3_get_param</span><span class="p">(</span><span class="n">res_info</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">ainfo</span><span class="p">);</span>
        <span class="n">res_vid</span> <span class="o">=</span> <span class="n">ainfo</span><span class="p">.</span><span class="n">converged</span><span class="p">;</span>
        <span class="n">save_info</span><span class="p">.</span><span class="n">video_lwm</span> <span class="o">=</span> <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_lwm</span><span class="p">;</span>
        <span class="n">save_info</span><span class="p">.</span><span class="n">video_burst_size</span> <span class="o">=</span> <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_burst_size</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="p">.</span><span class="n">vid_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="p">.</span><span class="n">vid_only_once</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="p">.</span><span class="n">gr_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">ainfo</span><span class="p">.</span><span class="n">gdrain_rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pclk_khz</span> <span class="o">*</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pix_bpp</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
        <span class="n">ainfo</span><span class="p">.</span><span class="n">vdrain_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">res_gr</span> <span class="o">=</span> <span class="n">nv3_get_param</span><span class="p">(</span><span class="n">res_info</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">ainfo</span><span class="p">);</span>
        <span class="n">res_gr</span> <span class="o">=</span> <span class="n">ainfo</span><span class="p">.</span><span class="n">converged</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_lwm</span> <span class="o">=</span> <span class="n">save_info</span><span class="p">.</span><span class="n">video_lwm</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">video_burst_size</span> <span class="o">=</span> <span class="n">save_info</span><span class="p">.</span><span class="n">video_burst_size</span><span class="p">;</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="n">res_gr</span> <span class="o">&amp;</span> <span class="n">res_vid</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ainfo</span><span class="p">.</span><span class="n">gr_en</span><span class="p">)</span> <span class="n">ainfo</span><span class="p">.</span><span class="n">gdrain_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ainfo</span><span class="p">.</span><span class="n">vid_en</span><span class="p">)</span> <span class="n">ainfo</span><span class="p">.</span><span class="n">vdrain_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">res_gr</span> <span class="o">=</span> <span class="n">nv3_get_param</span><span class="p">(</span><span class="n">res_info</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">ainfo</span><span class="p">);</span>
        <span class="n">res_info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="n">ainfo</span><span class="p">.</span><span class="n">converged</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv3UpdateArbitrationSettings</span>
<span class="p">(</span>
    <span class="kt">unsigned</span>      <span class="n">VClk</span><span class="p">,</span> 
    <span class="kt">unsigned</span>      <span class="n">pixelDepth</span><span class="p">,</span> 
    <span class="kt">unsigned</span>     <span class="o">*</span><span class="n">burst</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="o">*</span><span class="n">lwm</span><span class="p">,</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">nv3_fifo_info</span> <span class="n">fifo_data</span><span class="p">;</span>
    <span class="n">nv3_sim_state</span> <span class="n">sim_data</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">pll</span><span class="p">,</span> <span class="n">MClk</span><span class="p">;</span>
    
    <span class="n">pll</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">[</span><span class="mh">0x00000504</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
    <span class="n">MClk</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">P</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">pix_bpp</span>        <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">pixelDepth</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">enable_video</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">enable_mp</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">video_scale</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">memory_width</span>   <span class="o">=</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PEXTDEV</span><span class="p">[</span><span class="mh">0x00000000</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span>
	<span class="mi">128</span> <span class="o">:</span> <span class="mi">64</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">memory_width</span>   <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_latency</span>    <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_aligned</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_page_miss</span>  <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">gr_during_vid</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">pclk_khz</span>       <span class="o">=</span> <span class="n">VClk</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mclk_khz</span>       <span class="o">=</span> <span class="n">MClk</span><span class="p">;</span>
    <span class="n">nv3CalcArbitration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sim_data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fifo_data</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span>  <span class="n">b</span> <span class="o">=</span> <span class="n">fifo_data</span><span class="p">.</span><span class="n">graphics_burst_size</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
        <span class="o">*</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">burst</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
        <span class="o">*</span><span class="n">lwm</span>   <span class="o">=</span> <span class="n">fifo_data</span><span class="p">.</span><span class="n">graphics_lwm</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">lwm</span>   <span class="o">=</span> <span class="mh">0x24</span><span class="p">;</span>
        <span class="o">*</span><span class="n">burst</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv4CalcArbitration</span> 
<span class="p">(</span>
    <span class="n">nv4_fifo_info</span> <span class="o">*</span><span class="n">fifo</span><span class="p">,</span>
    <span class="n">nv4_sim_state</span> <span class="o">*</span><span class="n">arb</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="n">pagemiss</span><span class="p">,</span> <span class="n">cas</span><span class="p">,</span><span class="n">width</span><span class="p">,</span> <span class="n">video_enable</span><span class="p">,</span> <span class="n">color_key_enable</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">align</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nvclks</span><span class="p">,</span> <span class="n">mclks</span><span class="p">,</span> <span class="n">pclks</span><span class="p">,</span> <span class="n">vpagemiss</span><span class="p">,</span> <span class="n">crtpagemiss</span><span class="p">,</span> <span class="n">vbs</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">found</span><span class="p">,</span> <span class="n">mclk_extra</span><span class="p">,</span> <span class="n">mclk_loop</span><span class="p">,</span> <span class="n">cbs</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">mclk_freq</span><span class="p">,</span> <span class="n">pclk_freq</span><span class="p">,</span> <span class="n">nvclk_freq</span><span class="p">,</span> <span class="n">mp_enable</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">us_m</span><span class="p">,</span> <span class="n">us_n</span><span class="p">,</span> <span class="n">us_p</span><span class="p">,</span> <span class="n">video_drain_rate</span><span class="p">,</span> <span class="n">crtc_drain_rate</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">vpm_us</span><span class="p">,</span> <span class="n">us_video</span><span class="p">,</span> <span class="n">vlwm</span><span class="p">,</span> <span class="n">video_fill_us</span><span class="p">,</span> <span class="n">cpm_us</span><span class="p">,</span> <span class="n">us_crt</span><span class="p">,</span><span class="n">clwm</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">craw</span><span class="p">,</span> <span class="n">vraw</span><span class="p">;</span>

    <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">pclk_freq</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">pclk_khz</span><span class="p">;</span>
    <span class="n">mclk_freq</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
    <span class="n">nvclk_freq</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">nvclk_khz</span><span class="p">;</span>
    <span class="n">pagemiss</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span><span class="p">;</span>
    <span class="n">cas</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">mem_latency</span><span class="p">;</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">memory_width</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">video_enable</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">enable_video</span><span class="p">;</span>
    <span class="n">color_key_enable</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">gr_during_vid</span><span class="p">;</span>
    <span class="n">bpp</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">pix_bpp</span><span class="p">;</span>
    <span class="n">align</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">mem_aligned</span><span class="p">;</span>
    <span class="n">mp_enable</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">enable_mp</span><span class="p">;</span>
    <span class="n">clwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">vlwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">cbs</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
    <span class="n">pclks</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">nvclks</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mclks</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mclks</span> <span class="o">+=</span> <span class="n">cas</span><span class="p">;</span>
    <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mclk_extra</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mp_enable</span><span class="p">)</span>
        <span class="n">mclks</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pclks</span> <span class="o">+=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">vbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">found</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">mclk_loop</span> <span class="o">=</span> <span class="n">mclks</span><span class="o">+</span><span class="n">mclk_extra</span><span class="p">;</span>
        <span class="n">us_m</span> <span class="o">=</span> <span class="n">mclk_loop</span> <span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span>
        <span class="n">us_n</span> <span class="o">=</span> <span class="n">nvclks</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">nvclk_freq</span><span class="p">;</span>
        <span class="n">us_p</span> <span class="o">=</span> <span class="n">nvclks</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">pclk_freq</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">video_enable</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">video_drain_rate</span> <span class="o">=</span> <span class="n">pclk_freq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">crtc_drain_rate</span> <span class="o">=</span> <span class="n">pclk_freq</span> <span class="o">*</span> <span class="n">bpp</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
            <span class="n">vpagemiss</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">vpagemiss</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">crtpagemiss</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">vpm_us</span> <span class="o">=</span> <span class="p">(</span><span class="n">vpagemiss</span> <span class="o">*</span> <span class="n">pagemiss</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="n">mclk_freq</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nvclk_freq</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">mclk_freq</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
                <span class="n">video_fill_us</span> <span class="o">=</span> <span class="n">cbs</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">nvclk_freq</span> <span class="p">;</span>
            <span class="k">else</span>
                <span class="n">video_fill_us</span> <span class="o">=</span> <span class="n">cbs</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span>
            <span class="n">us_video</span> <span class="o">=</span> <span class="n">vpm_us</span> <span class="o">+</span> <span class="n">us_m</span> <span class="o">+</span> <span class="n">us_n</span> <span class="o">+</span> <span class="n">us_p</span> <span class="o">+</span> <span class="n">video_fill_us</span><span class="p">;</span>
            <span class="n">vlwm</span> <span class="o">=</span> <span class="n">us_video</span> <span class="o">*</span> <span class="n">video_drain_rate</span><span class="o">/</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
            <span class="n">vlwm</span><span class="o">++</span><span class="p">;</span>
            <span class="n">vbs</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">vlwm</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="n">vbs</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">vlwm</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">256</span><span class="o">-</span><span class="mi">64</span><span class="p">))</span> <span class="n">vbs</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nvclk_freq</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">mclk_freq</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
                <span class="n">video_fill_us</span> <span class="o">=</span> <span class="n">vbs</span> <span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">nvclk_freq</span> <span class="p">;</span>
            <span class="k">else</span>
                <span class="n">video_fill_us</span> <span class="o">=</span> <span class="n">vbs</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span>
            <span class="n">cpm_us</span> <span class="o">=</span> <span class="n">crtpagemiss</span>  <span class="o">*</span> <span class="n">pagemiss</span> <span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span>
            <span class="n">us_crt</span> <span class="o">=</span>
            <span class="n">us_video</span>
            <span class="o">+</span><span class="n">video_fill_us</span>
            <span class="o">+</span><span class="n">cpm_us</span>
            <span class="o">+</span><span class="n">us_m</span> <span class="o">+</span> <span class="n">us_n</span> <span class="o">+</span><span class="n">us_p</span>
            <span class="p">;</span>
            <span class="n">clwm</span> <span class="o">=</span> <span class="n">us_crt</span> <span class="o">*</span> <span class="n">crtc_drain_rate</span><span class="o">/</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
            <span class="n">clwm</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">crtc_drain_rate</span> <span class="o">=</span> <span class="n">pclk_freq</span> <span class="o">*</span> <span class="n">bpp</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
            <span class="n">crtpagemiss</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">crtpagemiss</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">cpm_us</span> <span class="o">=</span> <span class="n">crtpagemiss</span>  <span class="o">*</span> <span class="n">pagemiss</span> <span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span>
            <span class="n">us_crt</span> <span class="o">=</span>  <span class="n">cpm_us</span> <span class="o">+</span> <span class="n">us_m</span> <span class="o">+</span> <span class="n">us_n</span> <span class="o">+</span> <span class="n">us_p</span> <span class="p">;</span>
            <span class="n">clwm</span> <span class="o">=</span> <span class="n">us_crt</span> <span class="o">*</span> <span class="n">crtc_drain_rate</span><span class="o">/</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
            <span class="n">clwm</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">clwm</span> <span class="o">+</span> <span class="n">cbs</span> <span class="o">-</span> <span class="mi">512</span><span class="p">;</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">m1</span> <span class="o">*</span> <span class="n">pclk_freq</span> <span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">p1</span> <span class="o">&lt;</span> <span class="n">m1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mclk_extra</span> <span class="o">==</span><span class="mi">0</span><span class="p">)</span>   <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">mclk_extra</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">video_enable</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">clwm</span> <span class="o">&gt;</span> <span class="mi">511</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vlwm</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mclk_extra</span> <span class="o">==</span><span class="mi">0</span><span class="p">)</span>   <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">mclk_extra</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">clwm</span> <span class="o">&gt;</span> <span class="mi">519</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mclk_extra</span> <span class="o">==</span><span class="mi">0</span><span class="p">)</span>   <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">mclk_extra</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">craw</span> <span class="o">=</span> <span class="n">clwm</span><span class="p">;</span>
        <span class="n">vraw</span> <span class="o">=</span> <span class="n">vlwm</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">clwm</span> <span class="o">&lt;</span> <span class="mi">384</span><span class="p">)</span> <span class="n">clwm</span> <span class="o">=</span> <span class="mi">384</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vlwm</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="n">vlwm</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">clwm</span><span class="p">);</span>
        <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">graphics_lwm</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">graphics_burst_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">vlwm</span><span class="o">+</span><span class="mi">15</span><span class="p">));</span>
        <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">video_lwm</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">video_burst_size</span> <span class="o">=</span> <span class="n">vbs</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv4UpdateArbitrationSettings</span>
<span class="p">(</span>
    <span class="kt">unsigned</span>      <span class="n">VClk</span><span class="p">,</span> 
    <span class="kt">unsigned</span>      <span class="n">pixelDepth</span><span class="p">,</span> 
    <span class="kt">unsigned</span>     <span class="o">*</span><span class="n">burst</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="o">*</span><span class="n">lwm</span><span class="p">,</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">nv4_fifo_info</span> <span class="n">fifo_data</span><span class="p">;</span>
    <span class="n">nv4_sim_state</span> <span class="n">sim_data</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">pll</span><span class="p">,</span> <span class="n">MClk</span><span class="p">,</span> <span class="n">NVClk</span><span class="p">,</span> <span class="n">cfg1</span><span class="p">;</span>

    <span class="n">pll</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">[</span><span class="mh">0x00000504</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
    <span class="n">MClk</span>  <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">P</span><span class="p">;</span>
    <span class="n">pll</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">[</span><span class="mh">0x00000500</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
    <span class="n">NVClk</span>  <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">P</span><span class="p">;</span>
    <span class="n">cfg1</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">[</span><span class="mh">0x00000204</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">pix_bpp</span>        <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">pixelDepth</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">enable_video</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">enable_mp</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">memory_width</span>   <span class="o">=</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PEXTDEV</span><span class="p">[</span><span class="mh">0x00000000</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span>
	<span class="mi">128</span> <span class="o">:</span> <span class="mi">64</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_latency</span>    <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">cfg1</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_aligned</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_page_miss</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(((</span><span class="n">cfg1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span><span class="mh">0x0F</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">cfg1</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">gr_during_vid</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">pclk_khz</span>       <span class="o">=</span> <span class="n">VClk</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mclk_khz</span>       <span class="o">=</span> <span class="n">MClk</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">nvclk_khz</span>      <span class="o">=</span> <span class="n">NVClk</span><span class="p">;</span>
    <span class="n">nv4CalcArbitration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sim_data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fifo_data</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span>  <span class="n">b</span> <span class="o">=</span> <span class="n">fifo_data</span><span class="p">.</span><span class="n">graphics_burst_size</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
        <span class="o">*</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">burst</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
        <span class="o">*</span><span class="n">lwm</span>   <span class="o">=</span> <span class="n">fifo_data</span><span class="p">.</span><span class="n">graphics_lwm</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv10CalcArbitration</span> 
<span class="p">(</span>
    <span class="n">nv10_fifo_info</span> <span class="o">*</span><span class="n">fifo</span><span class="p">,</span>
    <span class="n">nv10_sim_state</span> <span class="o">*</span><span class="n">arb</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="n">pagemiss</span><span class="p">,</span> <span class="n">cas</span><span class="p">,</span><span class="n">width</span><span class="p">,</span> <span class="n">video_enable</span><span class="p">,</span> <span class="n">color_key_enable</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">align</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nvclks</span><span class="p">,</span> <span class="n">mclks</span><span class="p">,</span> <span class="n">pclks</span><span class="p">,</span> <span class="n">vpagemiss</span><span class="p">,</span> <span class="n">crtpagemiss</span><span class="p">,</span> <span class="n">vbs</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nvclk_fill</span><span class="p">,</span> <span class="n">us_extra</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">found</span><span class="p">,</span> <span class="n">mclk_extra</span><span class="p">,</span> <span class="n">mclk_loop</span><span class="p">,</span> <span class="n">cbs</span><span class="p">,</span> <span class="n">m1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">mclk_freq</span><span class="p">,</span> <span class="n">pclk_freq</span><span class="p">,</span> <span class="n">nvclk_freq</span><span class="p">,</span> <span class="n">mp_enable</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">us_m</span><span class="p">,</span> <span class="n">us_m_min</span><span class="p">,</span> <span class="n">us_n</span><span class="p">,</span> <span class="n">us_p</span><span class="p">,</span> <span class="n">video_drain_rate</span><span class="p">,</span> <span class="n">crtc_drain_rate</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">vus_m</span><span class="p">,</span> <span class="n">vus_n</span><span class="p">,</span> <span class="n">vus_p</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">vpm_us</span><span class="p">,</span> <span class="n">us_video</span><span class="p">,</span> <span class="n">vlwm</span><span class="p">,</span> <span class="n">cpm_us</span><span class="p">,</span> <span class="n">us_crt</span><span class="p">,</span><span class="n">clwm</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">clwm_rnd_down</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">craw</span><span class="p">,</span> <span class="n">m2us</span><span class="p">,</span> <span class="n">us_pipe</span><span class="p">,</span> <span class="n">us_pipe_min</span><span class="p">,</span> <span class="n">vus_pipe</span><span class="p">,</span> <span class="n">p1clk</span><span class="p">,</span> <span class="n">p2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">pclks_2_top_fifo</span><span class="p">,</span> <span class="n">min_mclk_extra</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">us_min_mclk_extra</span><span class="p">;</span>

    <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">pclk_freq</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">pclk_khz</span><span class="p">;</span> <span class="cm">/* freq in KHz */</span>
    <span class="n">mclk_freq</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">mclk_khz</span><span class="p">;</span>
    <span class="n">nvclk_freq</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">nvclk_khz</span><span class="p">;</span>
    <span class="n">pagemiss</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">mem_page_miss</span><span class="p">;</span>
    <span class="n">cas</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">mem_latency</span><span class="p">;</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">memory_width</span><span class="o">/</span><span class="mi">64</span><span class="p">;</span>
    <span class="n">video_enable</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">enable_video</span><span class="p">;</span>
    <span class="n">color_key_enable</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">gr_during_vid</span><span class="p">;</span>
    <span class="n">bpp</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">pix_bpp</span><span class="p">;</span>
    <span class="n">align</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">mem_aligned</span><span class="p">;</span>
    <span class="n">mp_enable</span> <span class="o">=</span> <span class="n">arb</span><span class="o">-&gt;</span><span class="n">enable_mp</span><span class="p">;</span>
    <span class="n">clwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">vlwm</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

    <span class="n">cbs</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
    <span class="n">vbs</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>

    <span class="n">pclks</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* lwm detect. */</span>

    <span class="n">nvclks</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* lwm -&gt; sync. */</span>
    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* fbi bus cycles (1 req + 1 busy) */</span>

    <span class="n">mclks</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* 2 edge sync.  may be very close to edge so just put one. */</span>

    <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* arb_hp_req */</span>
    <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>   <span class="cm">/* ap_hp_req   tiling pipeline */</span>

    <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>    <span class="cm">/* tc_req     latency fifo */</span>
    <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>    <span class="cm">/* fb_cas_n_  memory request to fbio block */</span>
    <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>    <span class="cm">/* sm_d_rdv   data returned from fbio block */</span>

    <span class="cm">/* fb.rd.d.Put_gc   need to accumulate 256 bits for read */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">arb</span><span class="o">-&gt;</span><span class="n">memory_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">arb</span><span class="o">-&gt;</span><span class="n">memory_width</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="cm">/* 64 bit bus */</span>
        <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">arb</span><span class="o">-&gt;</span><span class="n">memory_width</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="cm">/* 64 bit bus */</span>
        <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">mclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">video_enable</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">arb</span><span class="o">-&gt;</span><span class="n">memory_width</span> <span class="o">==</span> <span class="mi">128</span><span class="p">))</span>
    <span class="p">{</span>  
      <span class="n">mclk_extra</span> <span class="o">=</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="o">?</span> <span class="mi">31</span> <span class="o">:</span> <span class="mi">42</span><span class="p">;</span> <span class="cm">/* Margin of error */</span>
      <span class="n">min_mclk_extra</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">mclk_extra</span> <span class="o">=</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* Margin of error */</span>
      <span class="cm">/* mclk_extra = 4; */</span> <span class="cm">/* Margin of error */</span>
      <span class="n">min_mclk_extra</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 2 edge sync.  may be very close to edge so just put one. */</span>
    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* fbi_d_rdv_n */</span>
    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Fbi_d_rdata */</span>
    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* crtfifo load */</span>

    <span class="k">if</span><span class="p">(</span><span class="n">mp_enable</span><span class="p">)</span>
      <span class="n">mclks</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span> <span class="cm">/* Mp can get in with a burst of 8. */</span>
    <span class="cm">/* Extra clocks determined by heuristics */</span>

    <span class="n">nvclks</span> <span class="o">+=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pclks</span> <span class="o">+=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">found</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">mclk_loop</span> <span class="o">=</span> <span class="n">mclks</span><span class="o">+</span><span class="n">mclk_extra</span><span class="p">;</span>
      <span class="n">us_m</span> <span class="o">=</span> <span class="n">mclk_loop</span> <span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span> <span class="cm">/* Mclk latency in us */</span>
      <span class="n">us_m_min</span> <span class="o">=</span> <span class="n">mclks</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span> <span class="cm">/* Minimum Mclk latency in us */</span>
      <span class="n">us_min_mclk_extra</span> <span class="o">=</span> <span class="n">min_mclk_extra</span> <span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span>
      <span class="n">us_n</span> <span class="o">=</span> <span class="n">nvclks</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">nvclk_freq</span><span class="p">;</span><span class="cm">/* nvclk latency in us */</span>
      <span class="n">us_p</span> <span class="o">=</span> <span class="n">pclks</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">pclk_freq</span><span class="p">;</span><span class="cm">/* nvclk latency in us */</span>
      <span class="n">us_pipe</span> <span class="o">=</span> <span class="n">us_m</span> <span class="o">+</span> <span class="n">us_n</span> <span class="o">+</span> <span class="n">us_p</span><span class="p">;</span>
      <span class="n">us_pipe_min</span> <span class="o">=</span> <span class="n">us_m_min</span> <span class="o">+</span> <span class="n">us_n</span> <span class="o">+</span> <span class="n">us_p</span><span class="p">;</span>
      <span class="n">us_extra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="n">vus_m</span> <span class="o">=</span> <span class="n">mclk_loop</span> <span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span> <span class="cm">/* Mclk latency in us */</span>
      <span class="n">vus_n</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">nvclk_freq</span><span class="p">;</span><span class="cm">/* nvclk latency in us */</span>
      <span class="n">vus_p</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">pclk_freq</span><span class="p">;</span><span class="cm">/* pclk latency in us */</span>
      <span class="n">vus_pipe</span> <span class="o">=</span> <span class="n">vus_m</span> <span class="o">+</span> <span class="n">vus_n</span> <span class="o">+</span> <span class="n">vus_p</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="n">video_enable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">video_drain_rate</span> <span class="o">=</span> <span class="n">pclk_freq</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* MB/s */</span>
        <span class="n">crtc_drain_rate</span> <span class="o">=</span> <span class="n">pclk_freq</span> <span class="o">*</span> <span class="n">bpp</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span> <span class="cm">/* MB/s */</span>

        <span class="n">vpagemiss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* self generating page miss */</span>
        <span class="n">vpagemiss</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* One higher priority before */</span>

        <span class="n">crtpagemiss</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* self generating page miss */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mp_enable</span><span class="p">)</span>
            <span class="n">crtpagemiss</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* if MA0 conflict */</span>

        <span class="n">vpm_us</span> <span class="o">=</span> <span class="p">(</span><span class="n">vpagemiss</span> <span class="o">*</span> <span class="n">pagemiss</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="n">mclk_freq</span><span class="p">;</span>

        <span class="n">us_video</span> <span class="o">=</span> <span class="n">vpm_us</span> <span class="o">+</span> <span class="n">vus_m</span><span class="p">;</span> <span class="cm">/* Video has separate read return path */</span>

        <span class="n">cpm_us</span> <span class="o">=</span> <span class="n">crtpagemiss</span>  <span class="o">*</span> <span class="n">pagemiss</span> <span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span>
        <span class="n">us_crt</span> <span class="o">=</span>
          <span class="n">us_video</span>  <span class="cm">/* Wait for video */</span>
          <span class="o">+</span><span class="n">cpm_us</span> <span class="cm">/* CRT Page miss */</span>
          <span class="o">+</span><span class="n">us_m</span> <span class="o">+</span> <span class="n">us_n</span> <span class="o">+</span><span class="n">us_p</span> <span class="cm">/* other latency */</span>
          <span class="p">;</span>

        <span class="n">clwm</span> <span class="o">=</span> <span class="n">us_crt</span> <span class="o">*</span> <span class="n">crtc_drain_rate</span><span class="o">/</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
        <span class="n">clwm</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* fixed point &lt;= float_point - 1.  Fixes that */</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">crtc_drain_rate</span> <span class="o">=</span> <span class="n">pclk_freq</span> <span class="o">*</span> <span class="n">bpp</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span> <span class="cm">/* bpp * pclk/8 */</span>

        <span class="n">crtpagemiss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* self generating page miss */</span>
        <span class="n">crtpagemiss</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* MA0 page miss */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mp_enable</span><span class="p">)</span>
            <span class="n">crtpagemiss</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* if MA0 conflict */</span>
        <span class="n">cpm_us</span> <span class="o">=</span> <span class="n">crtpagemiss</span>  <span class="o">*</span> <span class="n">pagemiss</span> <span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span> <span class="n">mclk_freq</span><span class="p">;</span>
        <span class="n">us_crt</span> <span class="o">=</span>  <span class="n">cpm_us</span> <span class="o">+</span> <span class="n">us_m</span> <span class="o">+</span> <span class="n">us_n</span> <span class="o">+</span> <span class="n">us_p</span> <span class="p">;</span>
        <span class="n">clwm</span> <span class="o">=</span> <span class="n">us_crt</span> <span class="o">*</span> <span class="n">crtc_drain_rate</span><span class="o">/</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
        <span class="n">clwm</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* fixed point &lt;= float_point - 1.  Fixes that */</span>

  <span class="cm">/*</span>

<span class="cm">//DIVIDER</span>
<span class="cm">          us_crt = (cbs * 1000 * 1000)/ (8*width)/mclk_freq ;</span>
<span class="cm">          us_crt = us_crt + us_m + us_n + us_p + (4 * 1000 * 1000)/mclk_freq;</span>
<span class="cm">          clwm_mt = us_crt * crtc_drain_rate/(1000*1000);</span>
<span class="cm">          clwm_mt ++;</span>
<span class="cm">          if(clwm_mt &gt; clwm)</span>
<span class="cm">              clwm = clwm_mt;</span>
<span class="cm">  */</span>
          <span class="cm">/* Finally, a heuristic check when width == 64 bits */</span>
          <span class="k">if</span><span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
              <span class="n">nvclk_fill</span> <span class="o">=</span> <span class="n">nvclk_freq</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
              <span class="k">if</span><span class="p">(</span><span class="n">crtc_drain_rate</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">&gt;=</span> <span class="n">nvclk_fill</span> <span class="o">*</span> <span class="mi">102</span><span class="p">)</span>
                      <span class="n">clwm</span> <span class="o">=</span> <span class="mh">0xfff</span><span class="p">;</span> <span class="cm">/*Large number to fail */</span>

              <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">crtc_drain_rate</span> <span class="o">*</span> <span class="mi">100</span>  <span class="o">&gt;=</span> <span class="n">nvclk_fill</span> <span class="o">*</span> <span class="mi">98</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">clwm</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
                  <span class="n">cbs</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
                  <span class="n">us_extra</span> <span class="o">=</span> <span class="p">(</span><span class="n">cbs</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="o">/</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">width</span><span class="p">)</span><span class="o">/</span><span class="n">mclk_freq</span> <span class="p">;</span>
              <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">}</span>


      <span class="cm">/*</span>
<span class="cm">        Overfill check:</span>

<span class="cm">        */</span>

      <span class="n">clwm_rnd_down</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">clwm</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">clwm_rnd_down</span> <span class="o">&lt;</span> <span class="n">clwm</span><span class="p">)</span>
          <span class="n">clwm</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

      <span class="n">m1</span> <span class="o">=</span> <span class="n">clwm</span> <span class="o">+</span> <span class="n">cbs</span> <span class="o">-</span>  <span class="mi">1024</span><span class="p">;</span> <span class="cm">/* Amount of overfill */</span>
      <span class="n">m2us</span> <span class="o">=</span> <span class="n">us_pipe_min</span> <span class="o">+</span> <span class="n">us_min_mclk_extra</span><span class="p">;</span>
      <span class="n">pclks_2_top_fifo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1024</span><span class="o">-</span><span class="n">clwm</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">width</span><span class="p">);</span>

      <span class="cm">/* pclk cycles to drain */</span>
      <span class="n">p1clk</span> <span class="o">=</span> <span class="n">m2us</span> <span class="o">*</span> <span class="n">pclk_freq</span><span class="o">/</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span> 
      <span class="n">p2</span> <span class="o">=</span> <span class="n">p1clk</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* bytes drained. */</span>

      <span class="k">if</span><span class="p">((</span><span class="n">p2</span> <span class="o">&lt;</span> <span class="n">m1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="n">min_mclk_extra</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>   <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">cbs</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Can&#39;t adjust anymore! */</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="n">cbs</span> <span class="o">=</span> <span class="n">cbs</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>  <span class="cm">/* reduce the burst size */</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">min_mclk_extra</span><span class="o">--</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">clwm</span> <span class="o">&gt;</span> <span class="mi">1023</span><span class="p">){</span> <span class="cm">/* Have some margin */</span>
          <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="n">min_mclk_extra</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>   
              <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Can&#39;t adjust anymore! */</span>
          <span class="k">else</span> 
              <span class="n">min_mclk_extra</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">craw</span> <span class="o">=</span> <span class="n">clwm</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="n">clwm</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1024</span><span class="o">-</span><span class="n">cbs</span><span class="o">+</span><span class="mi">8</span><span class="p">))</span> <span class="n">clwm</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">-</span><span class="n">cbs</span><span class="o">+</span><span class="mi">8</span><span class="p">;</span>
      <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">clwm</span><span class="p">);</span>
      <span class="cm">/*  printf(&quot;CRT LWM: %f bytes, prog: 0x%x, bs: 256\n&quot;, clwm, data ); */</span>
      <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">graphics_lwm</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>   <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">graphics_burst_size</span> <span class="o">=</span> <span class="n">cbs</span><span class="p">;</span>

      <span class="cm">/*  printf(&quot;VID LWM: %f bytes, prog: 0x%x, bs: %d\n, &quot;, vlwm, data, vbs ); */</span>
      <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">video_lwm</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>  <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">video_burst_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv10UpdateArbitrationSettings</span>
<span class="p">(</span>
    <span class="kt">unsigned</span>      <span class="n">VClk</span><span class="p">,</span> 
    <span class="kt">unsigned</span>      <span class="n">pixelDepth</span><span class="p">,</span> 
    <span class="kt">unsigned</span>     <span class="o">*</span><span class="n">burst</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="o">*</span><span class="n">lwm</span><span class="p">,</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">nv10_fifo_info</span> <span class="n">fifo_data</span><span class="p">;</span>
    <span class="n">nv10_sim_state</span> <span class="n">sim_data</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">pll</span><span class="p">,</span> <span class="n">MClk</span><span class="p">,</span> <span class="n">NVClk</span><span class="p">,</span> <span class="n">cfg1</span><span class="p">;</span>

    <span class="n">pll</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">[</span><span class="mh">0x00000504</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
    <span class="n">MClk</span>  <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">P</span><span class="p">;</span>
    <span class="n">pll</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">[</span><span class="mh">0x00000500</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
    <span class="n">NVClk</span>  <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">P</span><span class="p">;</span>
    <span class="n">cfg1</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">[</span><span class="mh">0x00000204</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">pix_bpp</span>        <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">pixelDepth</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">enable_video</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">enable_mp</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">memory_type</span>    <span class="o">=</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">[</span><span class="mh">0x00000200</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span>
	<span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">memory_width</span>   <span class="o">=</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PEXTDEV</span><span class="p">[</span><span class="mh">0x00000000</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span>
	<span class="mi">128</span> <span class="o">:</span> <span class="mi">64</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_latency</span>    <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">cfg1</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_aligned</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_page_miss</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(((</span><span class="n">cfg1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span><span class="mh">0x0F</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">cfg1</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">gr_during_vid</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">pclk_khz</span>       <span class="o">=</span> <span class="n">VClk</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mclk_khz</span>       <span class="o">=</span> <span class="n">MClk</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">nvclk_khz</span>      <span class="o">=</span> <span class="n">NVClk</span><span class="p">;</span>
    <span class="n">nv10CalcArbitration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sim_data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fifo_data</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span>  <span class="n">b</span> <span class="o">=</span> <span class="n">fifo_data</span><span class="p">.</span><span class="n">graphics_burst_size</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
        <span class="o">*</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">burst</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
        <span class="o">*</span><span class="n">lwm</span>   <span class="o">=</span> <span class="n">fifo_data</span><span class="p">.</span><span class="n">graphics_lwm</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nForceUpdateArbitrationSettings</span>
<span class="p">(</span>
    <span class="kt">unsigned</span>      <span class="n">VClk</span><span class="p">,</span>
    <span class="kt">unsigned</span>      <span class="n">pixelDepth</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="o">*</span><span class="n">burst</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="o">*</span><span class="n">lwm</span><span class="p">,</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">nv10_fifo_info</span> <span class="n">fifo_data</span><span class="p">;</span>
    <span class="n">nv10_sim_state</span> <span class="n">sim_data</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">pll</span><span class="p">,</span> <span class="n">MClk</span><span class="p">,</span> <span class="n">NVClk</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uMClkPostDiv</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

    <span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uMClkPostDiv</span><span class="p">);</span>
    <span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">uMClkPostDiv</span> <span class="o">=</span> <span class="p">(</span><span class="n">uMClkPostDiv</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">uMClkPostDiv</span><span class="p">)</span> <span class="n">uMClkPostDiv</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">MClk</span> <span class="o">=</span> <span class="mi">400000</span> <span class="o">/</span> <span class="n">uMClkPostDiv</span><span class="p">;</span>

    <span class="n">pll</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">[</span><span class="mh">0x00000500</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
    <span class="n">NVClk</span>  <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">P</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">pix_bpp</span>        <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">pixelDepth</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">enable_video</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">enable_mp</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sim_data</span><span class="p">.</span><span class="n">memory_type</span><span class="p">);</span>
    <span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">memory_type</span>    <span class="o">=</span> <span class="p">(</span><span class="n">sim_data</span><span class="p">.</span><span class="n">memory_type</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">sim_data</span><span class="p">.</span><span class="n">memory_width</span>   <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_latency</span>    <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_aligned</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mem_page_miss</span>  <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">gr_during_vid</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">pclk_khz</span>       <span class="o">=</span> <span class="n">VClk</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">mclk_khz</span>       <span class="o">=</span> <span class="n">MClk</span><span class="p">;</span>
    <span class="n">sim_data</span><span class="p">.</span><span class="n">nvclk_khz</span>      <span class="o">=</span> <span class="n">NVClk</span><span class="p">;</span>
    <span class="n">nv10CalcArbitration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sim_data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fifo_data</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span>  <span class="n">b</span> <span class="o">=</span> <span class="n">fifo_data</span><span class="p">.</span><span class="n">graphics_burst_size</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
        <span class="o">*</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">burst</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
        <span class="o">*</span><span class="n">lwm</span>   <span class="o">=</span> <span class="n">fifo_data</span><span class="p">.</span><span class="n">graphics_lwm</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************\</span>
<span class="cm">*                                                                            *</span>
<span class="cm">*                          RIVA Mode State Routines                          *</span>
<span class="cm">*                                                                            *</span>
<span class="cm">\****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate the Video Clock parameters for the PLL.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">CalcVClock</span>
<span class="p">(</span>
    <span class="kt">int</span>           <span class="n">clockIn</span><span class="p">,</span>
    <span class="kt">int</span>          <span class="o">*</span><span class="n">clockOut</span><span class="p">,</span>
    <span class="kt">int</span>          <span class="o">*</span><span class="n">mOut</span><span class="p">,</span>
    <span class="kt">int</span>          <span class="o">*</span><span class="n">nOut</span><span class="p">,</span>
    <span class="kt">int</span>          <span class="o">*</span><span class="n">pOut</span><span class="p">,</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">lowM</span><span class="p">,</span> <span class="n">highM</span><span class="p">,</span> <span class="n">highP</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">DeltaNew</span><span class="p">,</span> <span class="n">DeltaOld</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">VClk</span><span class="p">,</span> <span class="n">Freq</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">P</span><span class="p">;</span>
    
    <span class="n">DeltaOld</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>

    <span class="n">VClk</span>     <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">clockIn</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span> <span class="o">==</span> <span class="mi">13500</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">lowM</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
        <span class="n">highM</span> <span class="o">=</span> <span class="mi">13</span> <span class="o">-</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Architecture</span> <span class="o">==</span> <span class="n">NV_ARCH_03</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">lowM</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="n">highM</span> <span class="o">=</span> <span class="mi">14</span> <span class="o">-</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Architecture</span> <span class="o">==</span> <span class="n">NV_ARCH_03</span><span class="p">);</span>
    <span class="p">}</span>                      

    <span class="n">highP</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Architecture</span> <span class="o">==</span> <span class="n">NV_ARCH_03</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">P</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">P</span> <span class="o">&lt;=</span> <span class="n">highP</span><span class="p">;</span> <span class="n">P</span> <span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Freq</span> <span class="o">=</span> <span class="n">VClk</span> <span class="o">&lt;&lt;</span> <span class="n">P</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">Freq</span> <span class="o">&gt;=</span> <span class="mi">128000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Freq</span> <span class="o">&lt;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">MaxVClockFreqKHz</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">M</span> <span class="o">=</span> <span class="n">lowM</span><span class="p">;</span> <span class="n">M</span> <span class="o">&lt;=</span> <span class="n">highM</span><span class="p">;</span> <span class="n">M</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">N</span>    <span class="o">=</span> <span class="p">(</span><span class="n">VClk</span> <span class="o">&lt;&lt;</span> <span class="n">P</span><span class="p">)</span> <span class="o">*</span> <span class="n">M</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span> <span class="o">*</span> <span class="n">N</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">P</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Freq</span> <span class="o">&gt;</span> <span class="n">VClk</span><span class="p">)</span>
                    <span class="n">DeltaNew</span> <span class="o">=</span> <span class="n">Freq</span> <span class="o">-</span> <span class="n">VClk</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">DeltaNew</span> <span class="o">=</span> <span class="n">VClk</span> <span class="o">-</span> <span class="n">Freq</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">DeltaNew</span> <span class="o">&lt;</span> <span class="n">DeltaOld</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="o">*</span><span class="n">mOut</span>     <span class="o">=</span> <span class="n">M</span><span class="p">;</span>
                    <span class="o">*</span><span class="n">nOut</span>     <span class="o">=</span> <span class="n">N</span><span class="p">;</span>
                    <span class="o">*</span><span class="n">pOut</span>     <span class="o">=</span> <span class="n">P</span><span class="p">;</span>
                    <span class="o">*</span><span class="n">clockOut</span> <span class="o">=</span> <span class="n">Freq</span><span class="p">;</span>
                    <span class="n">DeltaOld</span>  <span class="o">=</span> <span class="n">DeltaNew</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* non-zero: M/N/P/clock values assigned.  zero: error (not set) */</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">DeltaOld</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Calculate extended mode parameters (SVGA) and save in a </span>
<span class="cm"> * mode state structure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">CalcStateExt</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span>  <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="n">RIVA_HW_STATE</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
    <span class="kt">int</span>            <span class="n">bpp</span><span class="p">,</span>
    <span class="kt">int</span>            <span class="n">width</span><span class="p">,</span>
    <span class="kt">int</span>            <span class="n">hDisplaySize</span><span class="p">,</span>
    <span class="kt">int</span>            <span class="n">height</span><span class="p">,</span>
    <span class="kt">int</span>            <span class="n">dotClock</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">pixelDepth</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">VClk</span><span class="p">),</span><span class="n">uninitialized_var</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">n</span><span class="p">),</span>	<span class="n">uninitialized_var</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     * Save mode parameters.</span>
<span class="cm">     */</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">bpp</span>    <span class="o">=</span> <span class="n">bpp</span><span class="p">;</span>    <span class="cm">/* this is not bitsPerPixel, it&#39;s 8,15,16,32 */</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">width</span>  <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * Extended RIVA registers.</span>
<span class="cm">     */</span>
    <span class="n">pixelDepth</span> <span class="o">=</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CalcVClock</span><span class="p">(</span><span class="n">dotClock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">VClk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span>
    	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Architecture</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">NV_ARCH_03</span>:
            <span class="n">nv3UpdateArbitrationSettings</span><span class="p">(</span><span class="n">VClk</span><span class="p">,</span> 
                                         <span class="n">pixelDepth</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> 
                                        <span class="o">&amp;</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration0</span><span class="p">),</span>
                                        <span class="o">&amp;</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration1</span><span class="p">),</span>
                                         <span class="n">chip</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor0</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor1</span>  <span class="o">=</span> <span class="mh">0x78</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor2</span>  <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span>   <span class="o">=</span> <span class="mh">0x10010100</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span>   <span class="o">=</span> <span class="p">((</span><span class="n">width</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span><span class="o">/</span><span class="mi">32</span><span class="p">)</span>
                            <span class="o">|</span> <span class="p">(((</span><span class="n">pixelDepth</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="n">pixelDepth</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
                            <span class="o">|</span> <span class="mh">0x1000</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">general</span>  <span class="o">=</span> <span class="mh">0x00100100</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">repaint1</span> <span class="o">=</span> <span class="n">hDisplaySize</span> <span class="o">&lt;</span> <span class="mi">1280</span> <span class="o">?</span> <span class="mh">0x06</span> <span class="o">:</span> <span class="mh">0x02</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">NV_ARCH_04</span>:
            <span class="n">nv4UpdateArbitrationSettings</span><span class="p">(</span><span class="n">VClk</span><span class="p">,</span> 
                                         <span class="n">pixelDepth</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> 
                                        <span class="o">&amp;</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration0</span><span class="p">),</span>
                                        <span class="o">&amp;</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration1</span><span class="p">),</span>
                                         <span class="n">chip</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor0</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor1</span>  <span class="o">=</span> <span class="mh">0xFC</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor2</span>  <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span>   <span class="o">=</span> <span class="mh">0x10000700</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span>   <span class="o">=</span> <span class="mh">0x00001114</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">general</span>  <span class="o">=</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">?</span> <span class="mh">0x00101100</span> <span class="o">:</span> <span class="mh">0x00100100</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">repaint1</span> <span class="o">=</span> <span class="n">hDisplaySize</span> <span class="o">&lt;</span> <span class="mi">1280</span> <span class="o">?</span> <span class="mh">0x04</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">NV_ARCH_10</span>:
        <span class="k">case</span> <span class="n">NV_ARCH_20</span>:
        <span class="k">case</span> <span class="n">NV_ARCH_30</span>:
            <span class="k">if</span><span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Chipset</span> <span class="o">==</span> <span class="n">NV_CHIP_IGEFORCE2</span><span class="p">)</span> <span class="o">||</span>
               <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Chipset</span> <span class="o">==</span> <span class="n">NV_CHIP_0x01F0</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">nForceUpdateArbitrationSettings</span><span class="p">(</span><span class="n">VClk</span><span class="p">,</span>
                                          <span class="n">pixelDepth</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
                                         <span class="o">&amp;</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration0</span><span class="p">),</span>
                                         <span class="o">&amp;</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration1</span><span class="p">),</span>
                                          <span class="n">chip</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">nv10UpdateArbitrationSettings</span><span class="p">(</span><span class="n">VClk</span><span class="p">,</span> 
                                          <span class="n">pixelDepth</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> 
                                         <span class="o">&amp;</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration0</span><span class="p">),</span>
                                         <span class="o">&amp;</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration1</span><span class="p">),</span>
                                          <span class="n">chip</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor0</span>  <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">CursorStart</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor1</span>  <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">CursorStart</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor2</span>  <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CursorStart</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span>   <span class="o">=</span> <span class="mh">0x10000700</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">[</span><span class="mh">0x00000200</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">general</span>  <span class="o">=</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">?</span> <span class="mh">0x00101100</span> <span class="o">:</span> <span class="mh">0x00100100</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">repaint1</span> <span class="o">=</span> <span class="n">hDisplaySize</span> <span class="o">&lt;</span> <span class="mi">1280</span> <span class="o">?</span> <span class="mh">0x04</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

     <span class="cm">/* Paul Richards: below if block borks things in kernel for some reason */</span>
     <span class="cm">/* Tony: Below is needed to set hardware in DirectColor */</span>
    <span class="k">if</span><span class="p">((</span><span class="n">bpp</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Architecture</span> <span class="o">!=</span> <span class="n">NV_ARCH_03</span><span class="p">))</span>
	    <span class="n">state</span><span class="o">-&gt;</span><span class="n">general</span> <span class="o">|=</span> <span class="mh">0x00000030</span><span class="p">;</span>

    <span class="n">state</span><span class="o">-&gt;</span><span class="n">vpll</span>     <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">m</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">repaint0</span> <span class="o">=</span> <span class="p">(((</span><span class="n">width</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="n">pixelDepth</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x700</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">pixel</span>    <span class="o">=</span> <span class="n">pixelDepth</span> <span class="o">&gt;</span> <span class="mi">2</span>   <span class="o">?</span> <span class="mi">3</span>    <span class="o">:</span> <span class="n">pixelDepth</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset0</span>  <span class="o">=</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset1</span>  <span class="o">=</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset2</span>  <span class="o">=</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset3</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch0</span>   <span class="o">=</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch1</span>   <span class="o">=</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch2</span>   <span class="o">=</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch3</span>   <span class="o">=</span> <span class="n">pixelDepth</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Load fixed function state and pre-calculated/stored state.</span>
<span class="cm"> */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define LOAD_FIXED_STATE(tbl,dev)                                       \</span>
<span class="c">    for (i = 0; i &lt; sizeof(tbl##Table##dev)/8; i++)                 \</span>
<span class="c">        chip-&gt;dev[tbl##Table##dev[i][0]] = tbl##Table##dev[i][1]</span>
<span class="c">#define LOAD_FIXED_STATE_8BPP(tbl,dev)                                  \</span>
<span class="c">    for (i = 0; i &lt; sizeof(tbl##Table##dev##_8BPP)/8; i++)            \</span>
<span class="c">        chip-&gt;dev[tbl##Table##dev##_8BPP[i][0]] = tbl##Table##dev##_8BPP[i][1]</span>
<span class="c">#define LOAD_FIXED_STATE_15BPP(tbl,dev)                                 \</span>
<span class="c">    for (i = 0; i &lt; sizeof(tbl##Table##dev##_15BPP)/8; i++)           \</span>
<span class="c">        chip-&gt;dev[tbl##Table##dev##_15BPP[i][0]] = tbl##Table##dev##_15BPP[i][1]</span>
<span class="c">#define LOAD_FIXED_STATE_16BPP(tbl,dev)                                 \</span>
<span class="c">    for (i = 0; i &lt; sizeof(tbl##Table##dev##_16BPP)/8; i++)           \</span>
<span class="c">        chip-&gt;dev[tbl##Table##dev##_16BPP[i][0]] = tbl##Table##dev##_16BPP[i][1]</span>
<span class="c">#define LOAD_FIXED_STATE_32BPP(tbl,dev)                                 \</span>
<span class="c">    for (i = 0; i &lt; sizeof(tbl##Table##dev##_32BPP)/8; i++)           \</span>
<span class="c">        chip-&gt;dev[tbl##Table##dev##_32BPP[i][0]] = tbl##Table##dev##_32BPP[i][1]</span>
<span class="cp">#endif</span>

<span class="cp">#define LOAD_FIXED_STATE(tbl,dev)                                       \</span>
<span class="cp">    for (i = 0; i &lt; sizeof(tbl##Table##dev)/8; i++)                 \</span>
<span class="cp">        NV_WR32(&amp;chip-&gt;dev[tbl##Table##dev[i][0]], 0, tbl##Table##dev[i][1])</span>
<span class="cp">#define LOAD_FIXED_STATE_8BPP(tbl,dev)                                  \</span>
<span class="cp">    for (i = 0; i &lt; sizeof(tbl##Table##dev##_8BPP)/8; i++)            \</span>
<span class="cp">        NV_WR32(&amp;chip-&gt;dev[tbl##Table##dev##_8BPP[i][0]], 0, tbl##Table##dev##_8BPP[i][1])</span>
<span class="cp">#define LOAD_FIXED_STATE_15BPP(tbl,dev)                                 \</span>
<span class="cp">    for (i = 0; i &lt; sizeof(tbl##Table##dev##_15BPP)/8; i++)           \</span>
<span class="cp">        NV_WR32(&amp;chip-&gt;dev[tbl##Table##dev##_15BPP[i][0]], 0, tbl##Table##dev##_15BPP[i][1])</span>
<span class="cp">#define LOAD_FIXED_STATE_16BPP(tbl,dev)                                 \</span>
<span class="cp">    for (i = 0; i &lt; sizeof(tbl##Table##dev##_16BPP)/8; i++)           \</span>
<span class="cp">        NV_WR32(&amp;chip-&gt;dev[tbl##Table##dev##_16BPP[i][0]], 0, tbl##Table##dev##_16BPP[i][1])</span>
<span class="cp">#define LOAD_FIXED_STATE_32BPP(tbl,dev)                                 \</span>
<span class="cp">    for (i = 0; i &lt; sizeof(tbl##Table##dev##_32BPP)/8; i++)           \</span>
<span class="cp">        NV_WR32(&amp;chip-&gt;dev[tbl##Table##dev##_32BPP[i][0]], 0, tbl##Table##dev##_32BPP[i][1])</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">UpdateFifoState</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span>  <span class="o">*</span><span class="n">chip</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Architecture</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">NV_ARCH_04</span>:
            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">FIFO</span><span class="p">);</span>
            <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri05</span> <span class="o">=</span> <span class="p">(</span><span class="n">RivaTexturedTriangle05</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">NV_ARCH_10</span>:
        <span class="k">case</span> <span class="n">NV_ARCH_20</span>:
        <span class="k">case</span> <span class="n">NV_ARCH_30</span>:
            <span class="cm">/*</span>
<span class="cm">             * Initialize state for the RivaTriangle3D05 routines.</span>
<span class="cm">             */</span>
            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv10tri05</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">FIFO</span><span class="p">);</span>
            <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri05</span> <span class="o">=</span> <span class="p">(</span><span class="n">RivaTexturedTriangle05</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">LoadStateExt</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span>  <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="n">RIVA_HW_STATE</span> <span class="o">*</span><span class="n">state</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * Load HW fixed function state.</span>
<span class="cm">     */</span>
    <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">Riva</span><span class="p">,</span><span class="n">PMC</span><span class="p">);</span>
    <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">Riva</span><span class="p">,</span><span class="n">PTIMER</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Architecture</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">NV_ARCH_03</span>:
            <span class="cm">/*</span>
<span class="cm">             * Make sure frame buffer config gets set before loading PRAMIN.</span>
<span class="cm">             */</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000200</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv3</span><span class="p">,</span><span class="n">PFIFO</span><span class="p">);</span>
            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv3</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv3</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="mi">15</span>:
                <span class="k">case</span> <span class="mi">16</span>:
                    <span class="n">LOAD_FIXED_STATE_15BPP</span><span class="p">(</span><span class="n">nv3</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
                    <span class="n">LOAD_FIXED_STATE_15BPP</span><span class="p">(</span><span class="n">nv3</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="p">(</span><span class="n">RivaTexturedTriangle03</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">24</span>:
                <span class="k">case</span> <span class="mi">32</span>:
                    <span class="n">LOAD_FIXED_STATE_32BPP</span><span class="p">(</span><span class="n">nv3</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
                    <span class="n">LOAD_FIXED_STATE_32BPP</span><span class="p">(</span><span class="n">nv3</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">8</span>:
                <span class="nl">default:</span>
                    <span class="n">LOAD_FIXED_STATE_8BPP</span><span class="p">(</span><span class="n">nv3</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
                    <span class="n">LOAD_FIXED_STATE_8BPP</span><span class="p">(</span><span class="n">nv3</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x00000</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x00800</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMIN</span><span class="p">[</span><span class="mh">0x00000502</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000630</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000634</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset1</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000638</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset2</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000063C</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset3</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000650</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000654</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch1</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000658</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch2</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000065C</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch3</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">NV_ARCH_04</span>:
            <span class="cm">/*</span>
<span class="cm">             * Make sure frame buffer config gets set before loading PRAMIN.</span>
<span class="cm">             */</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000200</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">PFIFO</span><span class="p">);</span>
            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="mi">15</span>:
                    <span class="n">LOAD_FIXED_STATE_15BPP</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
                    <span class="n">LOAD_FIXED_STATE_15BPP</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="p">(</span><span class="n">RivaTexturedTriangle03</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">16</span>:
                    <span class="n">LOAD_FIXED_STATE_16BPP</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
                    <span class="n">LOAD_FIXED_STATE_16BPP</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="p">(</span><span class="n">RivaTexturedTriangle03</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">24</span>:
                <span class="k">case</span> <span class="mi">32</span>:
                    <span class="n">LOAD_FIXED_STATE_32BPP</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
                    <span class="n">LOAD_FIXED_STATE_32BPP</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">8</span>:
                <span class="nl">default:</span>
                    <span class="n">LOAD_FIXED_STATE_8BPP</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
                    <span class="n">LOAD_FIXED_STATE_8BPP</span><span class="p">(</span><span class="n">nv4</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000640</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000644</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset1</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000648</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset2</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000064C</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset3</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000670</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000674</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch1</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000678</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch2</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000067C</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch3</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">NV_ARCH_10</span>:
        <span class="k">case</span> <span class="n">NV_ARCH_20</span>:
        <span class="k">case</span> <span class="n">NV_ARCH_30</span>:
            <span class="k">if</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">twoHeads</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
               <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">crtcOwner</span><span class="p">);</span>
               <span class="n">chip</span><span class="o">-&gt;</span><span class="n">LockUnlock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">PFIFO</span><span class="p">);</span>
            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
            <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="mi">15</span>:
                    <span class="n">LOAD_FIXED_STATE_15BPP</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
                    <span class="n">LOAD_FIXED_STATE_15BPP</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="p">(</span><span class="n">RivaTexturedTriangle03</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">16</span>:
                    <span class="n">LOAD_FIXED_STATE_16BPP</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
                    <span class="n">LOAD_FIXED_STATE_16BPP</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="p">(</span><span class="n">RivaTexturedTriangle03</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">24</span>:
                <span class="k">case</span> <span class="mi">32</span>:
                    <span class="n">LOAD_FIXED_STATE_32BPP</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
                    <span class="n">LOAD_FIXED_STATE_32BPP</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">8</span>:
                <span class="nl">default:</span>
                    <span class="n">LOAD_FIXED_STATE_8BPP</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">PRAMIN</span><span class="p">);</span>
                    <span class="n">LOAD_FIXED_STATE_8BPP</span><span class="p">(</span><span class="n">nv10</span><span class="p">,</span><span class="n">PGRAPH</span><span class="p">);</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Architecture</span> <span class="o">==</span> <span class="n">NV_ARCH_10</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000640</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset0</span><span class="p">);</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000644</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset1</span><span class="p">);</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000648</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset2</span><span class="p">);</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000064C</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset3</span><span class="p">);</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000670</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch0</span><span class="p">);</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000674</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch1</span><span class="p">);</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000678</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch2</span><span class="p">);</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000067C</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch3</span><span class="p">);</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000680</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch3</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000820</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset0</span><span class="p">);</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000824</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset1</span><span class="p">);</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000828</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset2</span><span class="p">);</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000082C</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset3</span><span class="p">);</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000850</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch0</span><span class="p">);</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000854</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch1</span><span class="p">);</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000858</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch2</span><span class="p">);</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000085C</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch3</span><span class="p">);</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000860</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch3</span><span class="p">);</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000864</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch3</span><span class="p">);</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x000009A4</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000200</span><span class="p">));</span>
        <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x000009A8</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000204</span><span class="p">));</span>
        <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">twoHeads</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCRTC0</span><span class="p">,</span> <span class="mh">0x00000860</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
               <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCRTC0</span><span class="p">,</span> <span class="mh">0x00002860</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">head2</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC</span><span class="p">,</span> <span class="mh">0x00000404</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC</span><span class="p">,</span> <span class="mh">0x00000404</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">));</span>

            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x00008704</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x00008140</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x00008920</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x00008924</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x00008908</span><span class="p">,</span> <span class="mh">0x01ffffff</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x0000890C</span><span class="p">,</span> <span class="mh">0x01ffffff</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x00001588</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000240</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000250</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000260</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000270</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000280</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000290</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x000002A0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x000002B0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B00</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000240</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B04</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000244</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B08</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000248</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B0C</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x0000024C</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B10</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000250</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B14</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000254</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B18</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000258</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B1C</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x0000025C</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B20</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000260</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B24</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000264</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B28</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000268</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B2C</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x0000026C</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B30</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000270</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B34</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000274</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B38</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000278</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B3C</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x0000027C</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B40</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000280</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B44</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000284</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B48</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000288</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B4C</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x0000028C</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B50</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000290</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B54</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000294</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B58</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000298</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B5C</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x0000029C</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B60</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x000002A0</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B64</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x000002A4</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B68</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x000002A8</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B6C</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x000002AC</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B70</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x000002B0</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B74</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x000002B4</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B78</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x000002B8</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000B7C</span><span class="p">,</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x000002BC</span><span class="p">));</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F40</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F44</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000008</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00000200</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00000800</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F40</span><span class="p">,</span> <span class="mh">0x30000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F44</span><span class="p">,</span> <span class="mh">0x00000004</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00006400</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">59</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00006800</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">47</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00006C00</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00007000</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">19</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00007400</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00007800</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00004400</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F50</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000F54</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

            <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCRTC</span><span class="p">,</span> <span class="mh">0x00000810</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursorConfig</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">flatPanel</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span><span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Chipset</span> <span class="o">&amp;</span> <span class="mh">0x0ff0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0110</span><span class="p">)</span> <span class="p">{</span>
                   <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC</span><span class="p">,</span> <span class="mh">0x0528</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dither</span><span class="p">);</span>
               <span class="p">}</span> <span class="k">else</span> 
               <span class="k">if</span><span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Chipset</span> <span class="o">&amp;</span> <span class="mh">0x0ff0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x0170</span><span class="p">)</span> <span class="p">{</span>
                   <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC</span><span class="p">,</span> <span class="mh">0x083C</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dither</span><span class="p">);</span>
               <span class="p">}</span>
            
               <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">);</span>
               <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
               <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>
               <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
               <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
               <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
            <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">LOAD_FIXED_STATE</span><span class="p">(</span><span class="n">Riva</span><span class="p">,</span><span class="n">FIFO</span><span class="p">);</span>
    <span class="n">UpdateFifoState</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">     * Load HW mode state.</span>
<span class="cm">     */</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">repaint0</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">repaint1</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pixel</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">horiz</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration0</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration1</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor0</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor1</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor2</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">interlace</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">flatPanel</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">,</span> <span class="mh">0x00000508</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">vpll</span><span class="p">);</span>
       <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">,</span> <span class="mh">0x0000050C</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span><span class="p">);</span>
       <span class="k">if</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">twoHeads</span><span class="p">)</span>
          <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">,</span> <span class="mh">0x00000520</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">vpll2</span><span class="p">);</span>
    <span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
       <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC</span><span class="p">,</span> <span class="mh">0x00000848</span> <span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">);</span>
    <span class="p">}</span>  
    <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC</span><span class="p">,</span> <span class="mh">0x00000600</span> <span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">general</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     * Turn off VBlank enable and reset.</span>
<span class="cm">     */</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCRTC</span><span class="p">,</span> <span class="mh">0x00000140</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCRTC</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">VBlankBit</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">     * Set interrupt enable.</span>
<span class="cm">     */</span>    
    <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x00000140</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">EnableIRQ</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">     * Set current state pointer.</span>
<span class="cm">     */</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CurrentState</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * Reset FIFO free and empty counts.</span>
<span class="cm">     */</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">FifoFreeCount</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="cm">/* Free count from first subchannel */</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">FifoEmptyCount</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Rop</span><span class="o">-&gt;</span><span class="n">FifoFree</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">UnloadStateExt</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span>  <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="n">RIVA_HW_STATE</span> <span class="o">*</span><span class="n">state</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Save current HW state.</span>
<span class="cm">     */</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">repaint0</span>     <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">repaint1</span>     <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">screen</span>       <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">pixel</span>        <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">horiz</span>        <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration0</span> <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">arbitration1</span> <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor0</span>      <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor1</span>      <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursor2</span>      <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">interlace</span>    <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">vpll</span>         <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">,</span> <span class="mh">0x00000508</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">vpll2</span>        <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">,</span> <span class="mh">0x00000520</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span>       <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC0</span><span class="p">,</span> <span class="mh">0x0000050C</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">general</span>      <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC</span><span class="p">,</span> <span class="mh">0x00000600</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">scale</span>        <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC</span><span class="p">,</span> <span class="mh">0x00000848</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span>       <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000200</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Architecture</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">NV_ARCH_03</span>:
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset0</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000630</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset1</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000634</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset2</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000638</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset3</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000063C</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch0</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000650</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch1</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000654</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch2</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000658</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch3</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000065C</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">NV_ARCH_04</span>:
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset0</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000640</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset1</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000644</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset2</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000648</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset3</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000064C</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch0</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000670</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch1</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000674</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch2</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000678</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch3</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000067C</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">NV_ARCH_10</span>:
        <span class="k">case</span> <span class="n">NV_ARCH_20</span>:
        <span class="k">case</span> <span class="n">NV_ARCH_30</span>:
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset0</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000640</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset1</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000644</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset2</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000648</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">offset3</span>  <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000064C</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch0</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000670</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch1</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000674</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch2</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x00000678</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">pitch3</span>   <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PGRAPH</span><span class="p">,</span> <span class="mh">0x0000067C</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">twoHeads</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">state</span><span class="o">-&gt;</span><span class="n">head</span>     <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCRTC0</span><span class="p">,</span> <span class="mh">0x00000860</span><span class="p">);</span>
               <span class="n">state</span><span class="o">-&gt;</span><span class="n">head2</span>    <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCRTC0</span><span class="p">,</span> <span class="mh">0x00002860</span><span class="p">);</span>
               <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
               <span class="n">state</span><span class="o">-&gt;</span><span class="n">crtcOwner</span> <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D4</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x03D5</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">cursorConfig</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCRTC</span><span class="p">,</span> <span class="mh">0x00000810</span><span class="p">);</span>

            <span class="k">if</span><span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Chipset</span> <span class="o">&amp;</span> <span class="mh">0x0ff0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0110</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">state</span><span class="o">-&gt;</span><span class="n">dither</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC</span><span class="p">,</span> <span class="mh">0x0528</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span><span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Chipset</span> <span class="o">&amp;</span> <span class="mh">0x0ff0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x0170</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">state</span><span class="o">-&gt;</span><span class="n">dither</span> <span class="o">=</span> <span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMDAC</span><span class="p">,</span> <span class="mh">0x083C</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">SetStartAddress</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">unsigned</span>      <span class="n">start</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCRTC</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">SetStartAddress3</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">unsigned</span>      <span class="n">start</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">pan</span>    <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * Unlock extended registers.</span>
<span class="cm">     */</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">LockUnlock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">     * Set start address.</span>
<span class="cm">     */</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D4</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">);</span> <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
    <span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D4</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">);</span> <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
    <span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D4</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x01F</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">));</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D4</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">);</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3D5</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x60</span><span class="p">));</span>
    <span class="cm">/*</span>
<span class="cm">     * 4 pixel pan register.</span>
<span class="cm">     */</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">VGA_RD08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO</span> <span class="o">+</span> <span class="mh">0x0A</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3C0</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
    <span class="n">VGA_WR08</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PCIO</span><span class="p">,</span> <span class="mh">0x3C0</span><span class="p">,</span> <span class="n">pan</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv3SetSurfaces2D</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf0</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf1</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">RivaSurface</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">Surface</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">RivaSurface</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>

    <span class="n">RIVA_FIFO_FREE</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">,</span><span class="n">Tri03</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000003</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surface</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf0</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000004</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surface</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf1</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000013</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv4SetSurfaces2D</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf0</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf1</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">RivaSurface</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">Surface</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">RivaSurface</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>

    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000003</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surface</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf0</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000004</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surface</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf1</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000014</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv10SetSurfaces2D</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf0</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf1</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">RivaSurface</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">Surface</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">RivaSurface</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>

    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000003</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surface</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf0</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000004</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surface</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf1</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000014</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv3SetSurfaces3D</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf0</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf1</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">RivaSurface</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">Surface</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">RivaSurface</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>

    <span class="n">RIVA_FIFO_FREE</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">,</span><span class="n">Tri03</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000005</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surface</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf0</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000006</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surface</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf1</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000013</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv4SetSurfaces3D</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf0</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf1</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">RivaSurface</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">Surface</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">RivaSurface</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>

    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000005</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surface</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf0</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000006</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surface</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf1</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000014</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv10SetSurfaces3D</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf0</span><span class="p">,</span>
    <span class="kt">unsigned</span>     <span class="n">surf1</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">RivaSurface3D</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">Surfaces3D</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">RivaSurface3D</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>

    <span class="n">RIVA_FIFO_FREE</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">,</span><span class="n">Tri03</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000007</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surfaces3D</span><span class="o">-&gt;</span><span class="n">RenderBufferOffset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf0</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Surfaces3D</span><span class="o">-&gt;</span><span class="n">ZBufferOffset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf1</span><span class="p">);</span>
    <span class="n">NV_WR32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00003800</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80000014</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************\</span>
<span class="cm">*                                                                            *</span>
<span class="cm">*                      Probe RIVA Chip Configuration                         *</span>
<span class="cm">*                                                                            *</span>
<span class="cm">\****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv3GetConfig</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Fill in chip configuration.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">[</span><span class="mh">0x00000000</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000020</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(((</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span>
         <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x02</span><span class="p">))</span>
        <span class="p">{</span>        
            <span class="cm">/*</span>
<span class="cm">             * SDRAM 128 ZX.</span>
<span class="cm">             */</span>
            <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamBandwidthKBytesPerSec</span> <span class="o">=</span> <span class="mi">800000</span><span class="p">;</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="mi">2</span>:
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">1</span>:
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="nl">default:</span>
                    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>            
        <span class="k">else</span>            
        <span class="p">{</span>
            <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamBandwidthKBytesPerSec</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
            <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span>          <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>            
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * SGRAM 128.</span>
<span class="cm">         */</span>
        <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamBandwidthKBytesPerSec</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000003</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="mi">0</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">2</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="nl">default:</span>
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>        
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span>   <span class="o">=</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PEXTDEV</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">?</span> <span class="mi">14318</span> <span class="o">:</span> <span class="mi">13500</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CURSOR</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMIN</span><span class="p">[</span><span class="mh">0x00008000</span><span class="o">/</span><span class="mi">4</span> <span class="o">-</span> <span class="mh">0x0800</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">VBlankBit</span>        <span class="o">=</span> <span class="mh">0x00000100</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">MaxVClockFreqKHz</span> <span class="o">=</span> <span class="mi">256000</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * Set chip functions.</span>
<span class="cm">     */</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Busy</span>            <span class="o">=</span> <span class="n">nv3Busy</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ShowHideCursor</span>  <span class="o">=</span> <span class="n">ShowHideCursor</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">LoadStateExt</span>    <span class="o">=</span> <span class="n">LoadStateExt</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">UnloadStateExt</span>  <span class="o">=</span> <span class="n">UnloadStateExt</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">SetStartAddress</span> <span class="o">=</span> <span class="n">SetStartAddress3</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">SetSurfaces2D</span>   <span class="o">=</span> <span class="n">nv3SetSurfaces2D</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">SetSurfaces3D</span>   <span class="o">=</span> <span class="n">nv3SetSurfaces3D</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">LockUnlock</span>      <span class="o">=</span> <span class="n">nv3LockUnlock</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv4GetConfig</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Fill in chip configuration.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000100</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="p">((</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">2</span>
                              <span class="o">+</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000003</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="mi">0</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">1</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">2</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">3</span>:
            <span class="nl">default:</span>
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">switch</span> <span class="p">((</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000003</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="mi">3</span>:
            <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamBandwidthKBytesPerSec</span> <span class="o">=</span> <span class="mi">800000</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamBandwidthKBytesPerSec</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span>   <span class="o">=</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PEXTDEV</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">?</span> <span class="mi">14318</span> <span class="o">:</span> <span class="mi">13500</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CURSOR</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PRAMIN</span><span class="p">[</span><span class="mh">0x00010000</span><span class="o">/</span><span class="mi">4</span> <span class="o">-</span> <span class="mh">0x0800</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">VBlankBit</span>        <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">MaxVClockFreqKHz</span> <span class="o">=</span> <span class="mi">350000</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * Set chip functions.</span>
<span class="cm">     */</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Busy</span>            <span class="o">=</span> <span class="n">nv4Busy</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ShowHideCursor</span>  <span class="o">=</span> <span class="n">ShowHideCursor</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">LoadStateExt</span>    <span class="o">=</span> <span class="n">LoadStateExt</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">UnloadStateExt</span>  <span class="o">=</span> <span class="n">UnloadStateExt</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">SetStartAddress</span> <span class="o">=</span> <span class="n">SetStartAddress</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">SetSurfaces2D</span>   <span class="o">=</span> <span class="n">nv4SetSurfaces2D</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">SetSurfaces3D</span>   <span class="o">=</span> <span class="n">nv4SetSurfaces3D</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">LockUnlock</span>      <span class="o">=</span> <span class="n">nv4LockUnlock</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv10GetConfig</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chipset</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">amt</span><span class="p">;</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
    <span class="cm">/* turn on big endian register access */</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x00000004</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01000001</span><span class="p">))</span>
    	<span class="n">NV_WR32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PMC</span><span class="p">,</span> <span class="mh">0x00000004</span><span class="p">,</span> <span class="mh">0x01000001</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="cm">/*</span>
<span class="cm">     * Fill in chip configuration.</span>
<span class="cm">     */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">NV_CHIP_IGEFORCE2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amt</span><span class="p">);</span>
        <span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="p">(((</span><span class="n">amt</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">NV_CHIP_0x01F0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amt</span><span class="p">);</span>
        <span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="p">(((</span><span class="n">amt</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">((</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x0000020C</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="mh">0x02</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x04</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x08</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x10</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x20</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x40</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x80</span>:
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">128</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="nl">default:</span>
                <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">switch</span> <span class="p">((</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PFB</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000003</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="mi">3</span>:
            <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamBandwidthKBytesPerSec</span> <span class="o">=</span> <span class="mi">800000</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamBandwidthKBytesPerSec</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span> <span class="o">=</span> <span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PEXTDEV</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span> <span class="o">?</span>
	<span class="mi">14318</span> <span class="o">:</span> <span class="mi">13500</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="mh">0x0ff0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mh">0x0170</span>:
    <span class="k">case</span> <span class="mh">0x0180</span>:
    <span class="k">case</span> <span class="mh">0x01F0</span>:
    <span class="k">case</span> <span class="mh">0x0250</span>:
    <span class="k">case</span> <span class="mh">0x0280</span>:
    <span class="k">case</span> <span class="mh">0x0300</span>:
    <span class="k">case</span> <span class="mh">0x0310</span>:
    <span class="k">case</span> <span class="mh">0x0320</span>:
    <span class="k">case</span> <span class="mh">0x0330</span>:
    <span class="k">case</span> <span class="mh">0x0340</span>:
       <span class="k">if</span><span class="p">(</span><span class="n">NV_RD32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">PEXTDEV</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">))</span>
           <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CrystalFreqKHz</span> <span class="o">=</span> <span class="mi">27000</span><span class="p">;</span>
       <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
       <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CursorStart</span>      <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">RamAmountKBytes</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">CURSOR</span>           <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* can&#39;t set this here */</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">VBlankBit</span>        <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">MaxVClockFreqKHz</span> <span class="o">=</span> <span class="mi">350000</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * Set chip functions.</span>
<span class="cm">     */</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Busy</span>            <span class="o">=</span> <span class="n">nv10Busy</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ShowHideCursor</span>  <span class="o">=</span> <span class="n">ShowHideCursor</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">LoadStateExt</span>    <span class="o">=</span> <span class="n">LoadStateExt</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">UnloadStateExt</span>  <span class="o">=</span> <span class="n">UnloadStateExt</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">SetStartAddress</span> <span class="o">=</span> <span class="n">SetStartAddress</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">SetSurfaces2D</span>   <span class="o">=</span> <span class="n">nv10SetSurfaces2D</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">SetSurfaces3D</span>   <span class="o">=</span> <span class="n">nv10SetSurfaces3D</span><span class="p">;</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">LockUnlock</span>      <span class="o">=</span> <span class="n">nv4LockUnlock</span><span class="p">;</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="mh">0x0ff0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mh">0x0110</span>:
    <span class="k">case</span> <span class="mh">0x0170</span>:
    <span class="k">case</span> <span class="mh">0x0180</span>:
    <span class="k">case</span> <span class="mh">0x01F0</span>:
    <span class="k">case</span> <span class="mh">0x0250</span>:
    <span class="k">case</span> <span class="mh">0x0280</span>:
    <span class="k">case</span> <span class="mh">0x0300</span>:
    <span class="k">case</span> <span class="mh">0x0310</span>:
    <span class="k">case</span> <span class="mh">0x0320</span>:
    <span class="k">case</span> <span class="mh">0x0330</span>:
    <span class="k">case</span> <span class="mh">0x0340</span>:
        <span class="n">chip</span><span class="o">-&gt;</span><span class="n">twoHeads</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="n">chip</span><span class="o">-&gt;</span><span class="n">twoHeads</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">RivaGetConfig</span>
<span class="p">(</span>
    <span class="n">RIVA_HW_INST</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chipset</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Save this so future SW know whats it&#39;s dealing with.</span>
<span class="cm">     */</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Version</span> <span class="o">=</span> <span class="n">RIVA_SW_VERSION</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * Chip specific configuration.</span>
<span class="cm">     */</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Architecture</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">NV_ARCH_03</span>:
            <span class="n">nv3GetConfig</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">NV_ARCH_04</span>:
            <span class="n">nv4GetConfig</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">NV_ARCH_10</span>:
        <span class="k">case</span> <span class="n">NV_ARCH_20</span>:
        <span class="k">case</span> <span class="n">NV_ARCH_30</span>:
            <span class="n">nv10GetConfig</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chipset</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Chipset</span> <span class="o">=</span> <span class="n">chipset</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * Fill in FIFO pointers.</span>
<span class="cm">     */</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Rop</span>    <span class="o">=</span> <span class="p">(</span><span class="n">RivaRop</span> <span class="n">__iomem</span>         <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00000000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Clip</span>   <span class="o">=</span> <span class="p">(</span><span class="n">RivaClip</span> <span class="n">__iomem</span>        <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00002000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Patt</span>   <span class="o">=</span> <span class="p">(</span><span class="n">RivaPattern</span> <span class="n">__iomem</span>     <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00004000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Pixmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">RivaPixmap</span> <span class="n">__iomem</span>      <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00006000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Blt</span>    <span class="o">=</span> <span class="p">(</span><span class="n">RivaScreenBlt</span> <span class="n">__iomem</span>   <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x00008000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">RivaBitmap</span> <span class="n">__iomem</span>      <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000A000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Line</span>   <span class="o">=</span> <span class="p">(</span><span class="n">RivaLine</span> <span class="n">__iomem</span>        <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000C000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">Tri03</span>  <span class="o">=</span> <span class="p">(</span><span class="n">RivaTexturedTriangle03</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">FIFO</span><span class="p">[</span><span class="mh">0x0000E000</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Another concern, only for high pclks so don't do this
with video:
What happens if the latency to fetch the cbs is so large that
fifo empties.  In that case we need to have an alternate clwm value
based off the total burst fetch</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
