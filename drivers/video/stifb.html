<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › stifb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>stifb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/stifb.c - </span>
<span class="cm"> * Low level Frame buffer driver for HP workstations with </span>
<span class="cm"> * STI (standard text interface) video firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001-2006 Helge Deller &lt;deller@gmx.de&gt;</span>
<span class="cm"> * Portions Copyright (C) 2001 Thomas Bogendoerfer &lt;tsbogend@alpha.franken.de&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * Based on:</span>
<span class="cm"> * - linux/drivers/video/artistfb.c -- Artist frame buffer driver</span>
<span class="cm"> *	Copyright (C) 2000 Philipp Rumpf &lt;prumpf@tux.org&gt;</span>
<span class="cm"> *   - based on skeletonfb, which was</span>
<span class="cm"> *	Created 28 Dec 1997 by Geert Uytterhoeven</span>
<span class="cm"> * - HP Xhp cfb-based X11 window driver for XFree86</span>
<span class="cm"> *	(c)Copyright 1992 Hewlett-Packard Co.</span>
<span class="cm"> *</span>
<span class="cm"> * </span>
<span class="cm"> *  The following graphics display devices (NGLE family) are supported by this driver:</span>
<span class="cm"> *</span>
<span class="cm"> *  HPA4070A	known as &quot;HCRX&quot;, a 1280x1024 color device with 8 planes</span>
<span class="cm"> *  HPA4071A	known as &quot;HCRX24&quot;, a 1280x1024 color device with 24 planes,</span>
<span class="cm"> *		optionally available with a hardware accelerator as HPA4071A_Z</span>
<span class="cm"> *  HPA1659A	known as &quot;CRX&quot;, a 1280x1024 color device with 8 planes</span>
<span class="cm"> *  HPA1439A	known as &quot;CRX24&quot;, a 1280x1024 color device with 24 planes,</span>
<span class="cm"> *		optionally available with a hardware accelerator.</span>
<span class="cm"> *  HPA1924A	known as &quot;GRX&quot;, a 1280x1024 grayscale device with 8 planes</span>
<span class="cm"> *  HPA2269A	known as &quot;Dual CRX&quot;, a 1280x1024 color device with 8 planes,</span>
<span class="cm"> *		implements support for two displays on a single graphics card.</span>
<span class="cm"> *  HP710C	internal graphics support optionally available on the HP9000s710 SPU,</span>
<span class="cm"> *		supports 1280x1024 color displays with 8 planes.</span>
<span class="cm"> *  HP710G	same as HP710C, 1280x1024 grayscale only</span>
<span class="cm"> *  HP710L	same as HP710C, 1024x768 color only</span>
<span class="cm"> *  HP712	internal graphics support on HP9000s712 SPU, supports 640x480, </span>
<span class="cm"> *		1024x768 or 1280x1024 color displays on 8 planes (Artist)</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>

<span class="cm">/* TODO:</span>
<span class="cm"> *	- 1bpp mode is completely untested</span>
<span class="cm"> *	- add support for h/w acceleration</span>
<span class="cm"> *	- add hardware cursor</span>
<span class="cm"> *	- automatically disable double buffering (e.g. on RDI precisionbook laptop)</span>
<span class="cm"> */</span>


<span class="cm">/* on supported graphic devices you may:</span>
<span class="cm"> * #define FALLBACK_TO_1BPP to fall back to 1 bpp, or</span>
<span class="cm"> * #undef  FALLBACK_TO_1BPP to reject support for unsupported cards */</span>
<span class="cp">#undef FALLBACK_TO_1BPP</span>

<span class="cp">#undef DEBUG_STIFB_REGS		</span><span class="cm">/* debug sti register accesses */</span><span class="cp"></span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>

<span class="cp">#include &lt;asm/grfioctl.h&gt;	</span><span class="cm">/* for HP-UX compatibility */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;sticore.h&quot;</span>

<span class="cm">/* REGION_BASE(fb_info, index) returns the virtual address for region &lt;index&gt; */</span>
<span class="cp">#define REGION_BASE(fb_info, index) \</span>
<span class="cp">	F_EXTEND(fb_info-&gt;sti-&gt;glob_cfg-&gt;region_ptrs[index])</span>

<span class="cp">#define NGLEDEVDEPROM_CRT_REGION 1</span>

<span class="cp">#define NR_PALETTE 256</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">__s32</span>	<span class="n">video_config_reg</span><span class="p">;</span>
	<span class="n">__s32</span>	<span class="n">misc_video_start</span><span class="p">;</span>
	<span class="n">__s32</span>	<span class="n">horiz_timing_fmt</span><span class="p">;</span>
	<span class="n">__s32</span>	<span class="n">serr_timing_fmt</span><span class="p">;</span>
	<span class="n">__s32</span>	<span class="n">vert_timing_fmt</span><span class="p">;</span>
	<span class="n">__s32</span>	<span class="n">horiz_state</span><span class="p">;</span>
	<span class="n">__s32</span>	<span class="n">vert_state</span><span class="p">;</span>
	<span class="n">__s32</span>	<span class="n">vtg_state_elements</span><span class="p">;</span>
	<span class="n">__s32</span>	<span class="n">pipeline_delay</span><span class="p">;</span>
	<span class="n">__s32</span>	<span class="n">misc_video_end</span><span class="p">;</span>
<span class="p">}</span> <span class="n">video_setup_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>                  
	<span class="n">__s16</span>	<span class="n">sizeof_ngle_data</span><span class="p">;</span>
	<span class="n">__s16</span>	<span class="n">x_size_visible</span><span class="p">;</span>	    <span class="cm">/* visible screen dim in pixels  */</span>
	<span class="n">__s16</span>	<span class="n">y_size_visible</span><span class="p">;</span>
	<span class="n">__s16</span>	<span class="n">pad2</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="n">__s16</span>	<span class="n">cursor_pipeline_delay</span><span class="p">;</span>
	<span class="n">__s16</span>	<span class="n">video_interleaves</span><span class="p">;</span>
	<span class="n">__s32</span>	<span class="n">pad3</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="p">}</span> <span class="n">ngle_rom_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">stifb_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">ngle_rom_t</span> <span class="n">ngle_rom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sti_struct</span> <span class="o">*</span><span class="n">sti</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">deviceSpecificConfig</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">stifb_bpp_pref</span><span class="p">[</span><span class="n">MAX_STI_ROMS</span><span class="p">];</span>

<span class="cm">/* ------------------- chipset specific functions -------------------------- */</span>

<span class="cm">/* offsets to graphic-chip internal registers */</span>

<span class="cp">#define REG_1		0x000118</span>
<span class="cp">#define REG_2		0x000480</span>
<span class="cp">#define REG_3		0x0004a0</span>
<span class="cp">#define REG_4		0x000600</span>
<span class="cp">#define REG_6		0x000800</span>
<span class="cp">#define REG_8		0x000820</span>
<span class="cp">#define REG_9		0x000a04</span>
<span class="cp">#define REG_10		0x018000</span>
<span class="cp">#define REG_11		0x018004</span>
<span class="cp">#define REG_12		0x01800c</span>
<span class="cp">#define REG_13		0x018018</span>
<span class="cp">#define REG_14  	0x01801c</span>
<span class="cp">#define REG_15		0x200000</span>
<span class="cp">#define REG_15b0	0x200000</span>
<span class="cp">#define REG_16b1	0x200005</span>
<span class="cp">#define REG_16b3	0x200007</span>
<span class="cp">#define REG_21		0x200218</span>
<span class="cp">#define REG_22		0x0005a0</span>
<span class="cp">#define REG_23		0x0005c0</span>
<span class="cp">#define REG_26		0x200118</span>
<span class="cp">#define REG_27		0x200308</span>
<span class="cp">#define REG_32		0x21003c</span>
<span class="cp">#define REG_33		0x210040</span>
<span class="cp">#define REG_34		0x200008</span>
<span class="cp">#define REG_35		0x018010</span>
<span class="cp">#define REG_38		0x210020</span>
<span class="cp">#define REG_39		0x210120</span>
<span class="cp">#define REG_40		0x210130</span>
<span class="cp">#define REG_42		0x210028</span>
<span class="cp">#define REG_43		0x21002c</span>
<span class="cp">#define REG_44		0x210030</span>
<span class="cp">#define REG_45		0x210034</span>

<span class="cp">#define READ_BYTE(fb,reg)		gsc_readb((fb)-&gt;info.fix.mmio_start + (reg))</span>
<span class="cp">#define READ_WORD(fb,reg)		gsc_readl((fb)-&gt;info.fix.mmio_start + (reg))</span>


<span class="cp">#ifndef DEBUG_STIFB_REGS</span>
<span class="cp"># define  DEBUG_OFF()</span>
<span class="cp"># define  DEBUG_ON()</span>
<span class="cp"># define WRITE_BYTE(value,fb,reg)	gsc_writeb((value),(fb)-&gt;info.fix.mmio_start + (reg))</span>
<span class="cp"># define WRITE_WORD(value,fb,reg)	gsc_writel((value),(fb)-&gt;info.fix.mmio_start + (reg))</span>
<span class="cp">#else</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">debug_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp"># define  DEBUG_OFF() debug_on=0</span>
<span class="cp"># define  DEBUG_ON()  debug_on=1</span>
<span class="cp"># define WRITE_BYTE(value,fb,reg)	do { if (debug_on) \</span>
<span class="cp">						printk(KERN_DEBUG &quot;%30s: WRITE_BYTE(0x%06x) = 0x%02x (old=0x%02x)\n&quot;, \</span>
<span class="cp">							__func__, reg, value, READ_BYTE(fb,reg)); 		  \</span>
<span class="cp">					gsc_writeb((value),(fb)-&gt;info.fix.mmio_start + (reg)); } while (0)</span>
<span class="cp"># define WRITE_WORD(value,fb,reg)	do { if (debug_on) \</span>
<span class="cp">						printk(KERN_DEBUG &quot;%30s: WRITE_WORD(0x%06x) = 0x%08x (old=0x%08x)\n&quot;, \</span>
<span class="cp">							__func__, reg, value, READ_WORD(fb,reg)); 		  \</span>
<span class="cp">					gsc_writel((value),(fb)-&gt;info.fix.mmio_start + (reg)); } while (0)</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG_STIFB_REGS */</span><span class="cp"></span>


<span class="cp">#define ENABLE	1	</span><span class="cm">/* for enabling/disabling screen */</span><span class="cp">	</span>
<span class="cp">#define DISABLE 0</span>

<span class="cp">#define NGLE_LOCK(fb_info)	do { } while (0) </span>
<span class="cp">#define NGLE_UNLOCK(fb_info)	do { } while (0)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SETUP_HW</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">READ_BYTE</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">REG_15b0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">)</span>
	    		<span class="n">stat</span> <span class="o">=</span> <span class="n">READ_BYTE</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">REG_15b0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">stat</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SETUP_FB</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>	
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg10_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">CRT_ID_VISUALIZE_EG</span>:
		<span class="k">case</span> <span class="n">S9000_ID_ARTIST</span>:
		<span class="k">case</span> <span class="n">S9000_ID_A1659A</span>:
			<span class="n">reg10_value</span> <span class="o">=</span> <span class="mh">0x13601000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">S9000_ID_A1439A</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>						
				<span class="n">reg10_value</span> <span class="o">=</span> <span class="mh">0xBBA0A000</span><span class="p">;</span>
			<span class="k">else</span> 
				<span class="n">reg10_value</span> <span class="o">=</span> <span class="mh">0x13601000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">S9000_ID_HCRX</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
				<span class="n">reg10_value</span> <span class="o">=</span> <span class="mh">0xBBA0A000</span><span class="p">;</span>
			<span class="k">else</span>					
				<span class="n">reg10_value</span> <span class="o">=</span> <span class="mh">0x13602000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">S9000_ID_TIMBER</span>:
		<span class="k">case</span> <span class="n">CRX24_OVERLAY_PLANES</span>:
			<span class="n">reg10_value</span> <span class="o">=</span> <span class="mh">0x13602000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg10_value</span><span class="p">)</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">reg10_value</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_10</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x83000300</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_14</span><span class="p">);</span>
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">WRITE_BYTE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_16b1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">START_IMAGE_COLORMAP_ACCESS</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0xBBE0F000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_10</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x03000300</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_14</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_13</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">WRITE_IMAGE_COLOR</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">color</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(((</span><span class="mh">0x100</span><span class="o">+</span><span class="n">index</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">),</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_3</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">FINISH_IMAGE_COLORMAP_ACCESS</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span> 
<span class="p">{</span>		
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x400</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x83000100</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">S9000_ID_ARTIST</span> <span class="o">||</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">CRT_ID_VISUALIZE_EG</span><span class="p">)</span>
			<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x80000100</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_26</span><span class="p">);</span>
		<span class="k">else</span>							
			<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x80000100</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">SETUP_FB</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SETUP_RAMDAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x04000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="mh">0x1020</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0xff000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">CRX24_SETUP_RAMDAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x04000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x02000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="mh">0x1004</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0xff000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="mh">0x1008</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x05000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x02000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="mh">0x1004</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x03000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="mh">0x1008</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void </span>
<span class="c">HCRX_SETUP_RAMDAC(struct stifb_info *fb)</span>
<span class="c">{</span>
<span class="c">	WRITE_WORD(0xffffffff, fb, REG_32);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">CRX24_SET_OVLY_MASK</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x13a02000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_11</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x03000300</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_14</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x000017f0</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_3</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_13</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_22</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_23</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ENABLE_DISABLE_DISPLAY</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mh">0x43000000</span> <span class="o">:</span> <span class="mh">0x03000000</span><span class="p">;</span>
        <span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
        <span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x06000000</span><span class="p">,</span>	<span class="n">fb</span><span class="p">,</span> <span class="mh">0x1030</span><span class="p">);</span>
        <span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> 	<span class="n">fb</span><span class="p">,</span> <span class="mh">0x1038</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">CRX24_ENABLE_DISABLE_DISPLAY</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mh">0x10000000</span> <span class="o">:</span> <span class="mh">0x30000000</span><span class="p">;</span>
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x01000000</span><span class="p">,</span>	<span class="n">fb</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x02000000</span><span class="p">,</span>	<span class="n">fb</span><span class="p">,</span> <span class="mh">0x1004</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">value</span><span class="p">,</span>	<span class="n">fb</span><span class="p">,</span> <span class="mh">0x1008</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ARTIST_ENABLE_DISABLE_DISPLAY</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">DregsMiscVideo</span> <span class="o">=</span> <span class="n">REG_21</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">DregsMiscCtl</span> <span class="o">=</span> <span class="n">REG_27</span><span class="p">;</span>
	
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">READ_WORD</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">DregsMiscVideo</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0A000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">DregsMiscVideo</span><span class="p">);</span>
	  <span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">READ_WORD</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">DregsMiscCtl</span><span class="p">)</span>   <span class="o">|</span> <span class="mh">0x00800000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">DregsMiscCtl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	  <span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">READ_WORD</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">DregsMiscVideo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0A000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">DregsMiscVideo</span><span class="p">);</span>
	  <span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">READ_WORD</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">DregsMiscCtl</span><span class="p">)</span>   <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00800000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">DregsMiscCtl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define GET_ROMTABLE_INDEX(fb) \</span>
<span class="cp">	(READ_BYTE(fb, REG_16b3) - 1)</span>

<span class="cp">#define HYPER_CONFIG_PLANES_24 0x00000100</span>
	
<span class="cp">#define IS_24_DEVICE(fb) \</span>
<span class="cp">	(fb-&gt;deviceSpecificConfig &amp; HYPER_CONFIG_PLANES_24)</span>

<span class="cp">#define IS_888_DEVICE(fb) \</span>
<span class="cp">	(!(IS_24_DEVICE(fb)))</span>

<span class="cp">#define GET_FIFO_SLOTS(fb, cnt, numslots)	\</span>
<span class="cp">{	while (cnt &lt; numslots) 			\</span>
<span class="cp">		cnt = READ_WORD(fb, REG_34);	\</span>
<span class="cp">	cnt -= numslots;			\</span>
<span class="cp">}</span>

<span class="cp">#define	    IndexedDcd	0	</span><span class="cm">/* Pixel data is indexed (pseudo) color */</span><span class="cp"></span>
<span class="cp">#define	    Otc04	2	</span><span class="cm">/* Pixels in each longword transfer (4) */</span><span class="cp"></span>
<span class="cp">#define	    Otc32	5	</span><span class="cm">/* Pixels in each longword transfer (32) */</span><span class="cp"></span>
<span class="cp">#define	    Ots08	3	</span><span class="cm">/* Each pixel is size (8)d transfer (1) */</span><span class="cp"></span>
<span class="cp">#define	    OtsIndirect	6	</span><span class="cm">/* Each bit goes through FG/BG color(8) */</span><span class="cp"></span>
<span class="cp">#define	    AddrLong	5	</span><span class="cm">/* FB address is Long aligned (pixel) */</span><span class="cp"></span>
<span class="cp">#define	    BINovly	0x2	</span><span class="cm">/* 8 bit overlay */</span><span class="cp"></span>
<span class="cp">#define	    BINapp0I	0x0	</span><span class="cm">/* Application Buffer 0, Indexed */</span><span class="cp"></span>
<span class="cp">#define	    BINapp1I	0x1	</span><span class="cm">/* Application Buffer 1, Indexed */</span><span class="cp"></span>
<span class="cp">#define	    BINapp0F8	0xa	</span><span class="cm">/* Application Buffer 0, Fractional 8-8-8 */</span><span class="cp"></span>
<span class="cp">#define	    BINattr	0xd	</span><span class="cm">/* Attribute Bitmap */</span><span class="cp"></span>
<span class="cp">#define	    RopSrc 	0x3</span>
<span class="cp">#define	    BitmapExtent08  3	</span><span class="cm">/* Each write hits ( 8) bits in depth */</span><span class="cp"></span>
<span class="cp">#define	    BitmapExtent32  5	</span><span class="cm">/* Each write hits (32) bits in depth */</span><span class="cp"></span>
<span class="cp">#define	    DataDynamic	    0	</span><span class="cm">/* Data register reloaded by direct access */</span><span class="cp"></span>
<span class="cp">#define	    MaskDynamic	    1	</span><span class="cm">/* Mask register reloaded by direct access */</span><span class="cp"></span>
<span class="cp">#define	    MaskOtc	    0	</span><span class="cm">/* Mask contains Object Count valid bits */</span><span class="cp"></span>

<span class="cp">#define MaskAddrOffset(offset) (offset)</span>
<span class="cp">#define StaticReg(en) (en)</span>
<span class="cp">#define BGx(en) (en)</span>
<span class="cp">#define FGx(en) (en)</span>

<span class="cp">#define BAJustPoint(offset) (offset)</span>
<span class="cp">#define BAIndexBase(base) (base)</span>
<span class="cp">#define BA(F,C,S,A,J,B,I) \</span>
<span class="cp">	(((F)&lt;&lt;31)|((C)&lt;&lt;27)|((S)&lt;&lt;24)|((A)&lt;&lt;21)|((J)&lt;&lt;16)|((B)&lt;&lt;12)|(I))</span>

<span class="cp">#define IBOvals(R,M,X,S,D,L,B,F) \</span>
<span class="cp">	(((R)&lt;&lt;8)|((M)&lt;&lt;16)|((X)&lt;&lt;24)|((S)&lt;&lt;29)|((D)&lt;&lt;28)|((L)&lt;&lt;31)|((B)&lt;&lt;1)|(F))</span>

<span class="cp">#define NGLE_QUICK_SET_IMAGE_BITMAP_OP(fb, val) \</span>
<span class="cp">	WRITE_WORD(val, fb, REG_14)</span>

<span class="cp">#define NGLE_QUICK_SET_DST_BM_ACCESS(fb, val) \</span>
<span class="cp">	WRITE_WORD(val, fb, REG_11)</span>

<span class="cp">#define NGLE_QUICK_SET_CTL_PLN_REG(fb, val) \</span>
<span class="cp">	WRITE_WORD(val, fb, REG_12)</span>

<span class="cp">#define NGLE_REALLY_SET_IMAGE_PLANEMASK(fb, plnmsk32) \</span>
<span class="cp">	WRITE_WORD(plnmsk32, fb, REG_13)</span>

<span class="cp">#define NGLE_REALLY_SET_IMAGE_FG_COLOR(fb, fg32) \</span>
<span class="cp">	WRITE_WORD(fg32, fb, REG_35)</span>

<span class="cp">#define NGLE_SET_TRANSFERDATA(fb, val) \</span>
<span class="cp">	WRITE_WORD(val, fb, REG_8)</span>

<span class="cp">#define NGLE_SET_DSTXY(fb, val) \</span>
<span class="cp">	WRITE_WORD(val, fb, REG_6)</span>

<span class="cp">#define NGLE_LONG_FB_ADDRESS(fbaddrbase, x, y) (		\</span>
<span class="cp">	(u32) (fbaddrbase) +					\</span>
<span class="cp">	    (	(unsigned int)  ( (y) &lt;&lt; 13      ) |		\</span>
<span class="cp">		(unsigned int)  ( (x) &lt;&lt; 2       )	)	\</span>
<span class="cp">	)</span>

<span class="cp">#define NGLE_BINC_SET_DSTADDR(fb, addr) \</span>
<span class="cp">	WRITE_WORD(addr, fb, REG_3)</span>

<span class="cp">#define NGLE_BINC_SET_SRCADDR(fb, addr) \</span>
<span class="cp">	WRITE_WORD(addr, fb, REG_2)</span>

<span class="cp">#define NGLE_BINC_SET_DSTMASK(fb, mask) \</span>
<span class="cp">	WRITE_WORD(mask, fb, REG_22)</span>

<span class="cp">#define NGLE_BINC_WRITE32(fb, data32) \</span>
<span class="cp">	WRITE_WORD(data32, fb, REG_23)</span>

<span class="cp">#define START_COLORMAPLOAD(fb, cmapBltCtlData32) \</span>
<span class="cp">	WRITE_WORD((cmapBltCtlData32), fb, REG_38)</span>

<span class="cp">#define SET_LENXY_START_RECFILL(fb, lenxy) \</span>
<span class="cp">	WRITE_WORD(lenxy, fb, REG_9)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">HYPER_ENABLE_DISABLE_DISPLAY</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">DregsHypMiscVideo</span> <span class="o">=</span> <span class="n">REG_33</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">READ_WORD</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">DregsHypMiscVideo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x0A000000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0A000000</span><span class="p">;</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">DregsHypMiscVideo</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* BufferNumbers used by SETUP_ATTR_ACCESS() */</span>
<span class="cp">#define BUFF0_CMAP0	0x00001e02</span>
<span class="cp">#define BUFF1_CMAP0	0x02001e02</span>
<span class="cp">#define BUFF1_CMAP3	0x0c001e02</span>
<span class="cp">#define ARTIST_CMAP0	0x00000102</span>
<span class="cp">#define HYPER_CMAP8	0x00000100</span>
<span class="cp">#define HYPER_CMAP24	0x00000800</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SETUP_ATTR_ACCESS</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">BufferNumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x2EA0D000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_11</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x23000302</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_14</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">BufferNumber</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_12</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SET_ATTR_SIZE</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="cm">/* REG_6 seems to have special values when run on a </span>
<span class="cm">	   RDI precisionbook parisc laptop (INTERNAL_EG_DX1024 or</span>
<span class="cm">	   INTERNAL_EG_X1024).  The values are:</span>
<span class="cm">		0x2f0: internal (LCD) &amp; external display enabled</span>
<span class="cm">		0x2a0: external display only</span>
<span class="cm">		0x000: zero on standard artist graphic cards</span>
<span class="cm">	*/</span> 
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_6</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">((</span><span class="n">width</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">height</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_9</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x05000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_6</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x00040001</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_9</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">FINISH_ATTR_ACCESS</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_12</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">elkSetupPlanes</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SETUP_RAMDAC</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">SETUP_FB</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">ngleSetupAttrPlanes</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">BufferNumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SETUP_ATTR_ACCESS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">BufferNumber</span><span class="p">);</span>
	<span class="n">SET_ATTR_SIZE</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">);</span>
	<span class="n">FINISH_ATTR_ACCESS</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">SETUP_FB</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rattlerSetupPlanes</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">saved_id</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>

 	<span class="cm">/* Write RAMDAC pixel read mask register so all overlay</span>
<span class="cm">	 * planes are display-enabled.  (CRX24 uses Bt462 pixel</span>
<span class="cm">	 * read mask register for overlay planes, not image planes).</span>
<span class="cm">	 */</span>
	<span class="n">CRX24_SETUP_RAMDAC</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
    
	<span class="cm">/* change fb-&gt;id temporarily to fool SETUP_FB() */</span>
	<span class="n">saved_id</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">CRX24_OVERLAY_PLANES</span><span class="p">;</span>
	<span class="n">SETUP_FB</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">saved_id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span> <span class="o">++</span><span class="n">y</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span>
			<span class="mh">0xff</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>

	<span class="n">CRX24_SET_OVLY_MASK</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">SETUP_FB</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define HYPER_CMAP_TYPE				0</span>
<span class="cp">#define NGLE_CMAP_INDEXED0_TYPE			0</span>
<span class="cp">#define NGLE_CMAP_OVERLAY_TYPE			3</span>

<span class="cm">/* typedef of LUT (Colormap) BLT Control Register */</span>
<span class="k">typedef</span> <span class="k">union</span>	<span class="cm">/* Note assumption that fields are packed left-to-right */</span>
<span class="p">{</span>	<span class="n">u32</span> <span class="n">all</span><span class="p">;</span>
	<span class="k">struct</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">enable</span>              <span class="o">:</span>  <span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">waitBlank</span>           <span class="o">:</span>  <span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">reserved1</span>           <span class="o">:</span>  <span class="mi">4</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">lutOffset</span>           <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>   <span class="cm">/* Within destination LUT */</span>
		<span class="kt">unsigned</span> <span class="n">lutType</span>             <span class="o">:</span>  <span class="mi">2</span><span class="p">;</span>   <span class="cm">/* Cursor, image, overlay */</span>
		<span class="kt">unsigned</span> <span class="n">reserved2</span>           <span class="o">:</span>  <span class="mi">4</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">length</span>              <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">fields</span><span class="p">;</span>
<span class="p">}</span> <span class="n">NgleLutBltCtl</span><span class="p">;</span>


<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static NgleLutBltCtl</span>
<span class="c">setNgleLutBltCtl(struct stifb_info *fb, int offsetWithinLut, int length)</span>
<span class="c">{</span>
<span class="c">	NgleLutBltCtl lutBltCtl;</span>

<span class="c">	/* set enable, zero reserved fields */</span>
<span class="c">	lutBltCtl.all           = 0x80000000;</span>
<span class="c">	lutBltCtl.fields.length = length;</span>

<span class="c">	switch (fb-&gt;id) </span>
<span class="c">	{</span>
<span class="c">	case S9000_ID_A1439A:		/* CRX24 */</span>
<span class="c">		if (fb-&gt;var.bits_per_pixel == 8) {</span>
<span class="c">			lutBltCtl.fields.lutType = NGLE_CMAP_OVERLAY_TYPE;</span>
<span class="c">			lutBltCtl.fields.lutOffset = 0;</span>
<span class="c">		} else {</span>
<span class="c">			lutBltCtl.fields.lutType = NGLE_CMAP_INDEXED0_TYPE;</span>
<span class="c">			lutBltCtl.fields.lutOffset = 0 * 256;</span>
<span class="c">		}</span>
<span class="c">		break;</span>
<span class="c">		</span>
<span class="c">	case S9000_ID_ARTIST:</span>
<span class="c">		lutBltCtl.fields.lutType = NGLE_CMAP_INDEXED0_TYPE;</span>
<span class="c">		lutBltCtl.fields.lutOffset = 0 * 256;</span>
<span class="c">		break;</span>
<span class="c">		</span>
<span class="c">	default:</span>
<span class="c">		lutBltCtl.fields.lutType = NGLE_CMAP_INDEXED0_TYPE;</span>
<span class="c">		lutBltCtl.fields.lutOffset = 0;</span>
<span class="c">		break;</span>
<span class="c">	}</span>

<span class="c">	/* Offset points to start of LUT.  Adjust for within LUT */</span>
<span class="c">	lutBltCtl.fields.lutOffset += offsetWithinLut;</span>

<span class="c">	return lutBltCtl;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">NgleLutBltCtl</span>
<span class="nf">setHyperLutBltCtl</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offsetWithinLut</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">NgleLutBltCtl</span> <span class="n">lutBltCtl</span><span class="p">;</span>

	<span class="cm">/* set enable, zero reserved fields */</span>
	<span class="n">lutBltCtl</span><span class="p">.</span><span class="n">all</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>

	<span class="n">lutBltCtl</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">lutBltCtl</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">lutType</span> <span class="o">=</span> <span class="n">HYPER_CMAP_TYPE</span><span class="p">;</span>

	<span class="cm">/* Expect lutIndex to be 0 or 1 for image cmaps, 2 or 3 for overlay cmaps */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">lutBltCtl</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">lutOffset</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">256</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lutBltCtl</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">lutOffset</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="mi">256</span><span class="p">;</span>

	<span class="cm">/* Offset points to start of LUT.  Adjust for within LUT */</span>
	<span class="n">lutBltCtl</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">lutOffset</span> <span class="o">+=</span> <span class="n">offsetWithinLut</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">lutBltCtl</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hyperUndoITE</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nFreeFifoSlots</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fbAddr</span><span class="p">;</span>

	<span class="n">NGLE_LOCK</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

	<span class="n">GET_FIFO_SLOTS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">nFreeFifoSlots</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_32</span><span class="p">);</span>

	<span class="cm">/* Write overlay transparency mask so only entry 255 is transparent */</span>

	<span class="cm">/* Hardware setup for full-depth write to &quot;magic&quot; location */</span>
	<span class="n">GET_FIFO_SLOTS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">nFreeFifoSlots</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">NGLE_QUICK_SET_DST_BM_ACCESS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> 
		<span class="n">BA</span><span class="p">(</span><span class="n">IndexedDcd</span><span class="p">,</span> <span class="n">Otc04</span><span class="p">,</span> <span class="n">Ots08</span><span class="p">,</span> <span class="n">AddrLong</span><span class="p">,</span>
		<span class="n">BAJustPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">BINovly</span><span class="p">,</span> <span class="n">BAIndexBase</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
	<span class="n">NGLE_QUICK_SET_IMAGE_BITMAP_OP</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span>
		<span class="n">IBOvals</span><span class="p">(</span><span class="n">RopSrc</span><span class="p">,</span> <span class="n">MaskAddrOffset</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="n">BitmapExtent08</span><span class="p">,</span> <span class="n">StaticReg</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="n">DataDynamic</span><span class="p">,</span> <span class="n">MaskOtc</span><span class="p">,</span> <span class="n">BGx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">FGx</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>

	<span class="cm">/* Now prepare to write to the &quot;magic&quot; location */</span>
	<span class="n">fbAddr</span> <span class="o">=</span> <span class="n">NGLE_LONG_FB_ADDRESS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1532</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">NGLE_BINC_SET_DSTADDR</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">fbAddr</span><span class="p">);</span>
	<span class="n">NGLE_REALLY_SET_IMAGE_PLANEMASK</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">);</span>
	<span class="n">NGLE_BINC_SET_DSTMASK</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="cm">/* Finally, write a zero to clear the mask */</span>
	<span class="n">NGLE_BINC_WRITE32</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">NGLE_UNLOCK</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">ngleDepth8_ClearImagePlanes</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME! */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">ngleDepth24_ClearImagePlanes</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME! */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ngleResetAttrPlanes</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctlPlaneReg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nFreeFifoSlots</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">packed_dst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">packed_len</span><span class="p">;</span>

	<span class="n">NGLE_LOCK</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

	<span class="n">GET_FIFO_SLOTS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">nFreeFifoSlots</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">NGLE_QUICK_SET_DST_BM_ACCESS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> 
				     <span class="n">BA</span><span class="p">(</span><span class="n">IndexedDcd</span><span class="p">,</span> <span class="n">Otc32</span><span class="p">,</span> <span class="n">OtsIndirect</span><span class="p">,</span>
					<span class="n">AddrLong</span><span class="p">,</span> <span class="n">BAJustPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
					<span class="n">BINattr</span><span class="p">,</span> <span class="n">BAIndexBase</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
	<span class="n">NGLE_QUICK_SET_CTL_PLN_REG</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">ctlPlaneReg</span><span class="p">);</span>
	<span class="n">NGLE_SET_TRANSFERDATA</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="n">NGLE_QUICK_SET_IMAGE_BITMAP_OP</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span>
				       <span class="n">IBOvals</span><span class="p">(</span><span class="n">RopSrc</span><span class="p">,</span> <span class="n">MaskAddrOffset</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
					       <span class="n">BitmapExtent08</span><span class="p">,</span> <span class="n">StaticReg</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
					       <span class="n">DataDynamic</span><span class="p">,</span> <span class="n">MaskOtc</span><span class="p">,</span>
					       <span class="n">BGx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">FGx</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
	<span class="n">packed_dst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">packed_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">GET_FIFO_SLOTS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">nFreeFifoSlots</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">NGLE_SET_DSTXY</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">packed_dst</span><span class="p">);</span>
	<span class="n">SET_LENXY_START_RECFILL</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">packed_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * In order to work around an ELK hardware problem (Buffy doesn&#39;t</span>
<span class="cm">	 * always flush it&#39;s buffers when writing to the attribute</span>
<span class="cm">	 * planes), at least 4 pixels must be written to the attribute</span>
<span class="cm">	 * planes starting at (X == 1280) and (Y != to the last Y written</span>
<span class="cm">	 * by BIF):</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">S9000_ID_A1659A</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* ELK_DEVICE_ID */</span>
		<span class="cm">/* It&#39;s safe to use scanline zero: */</span>
		<span class="n">packed_dst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1280</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">GET_FIFO_SLOTS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">nFreeFifoSlots</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">NGLE_SET_DSTXY</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">packed_dst</span><span class="p">);</span>
		<span class="n">packed_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">SET_LENXY_START_RECFILL</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">packed_len</span><span class="p">);</span>
	<span class="p">}</span>   <span class="cm">/* ELK Hardware Kludge */</span>

	<span class="cm">/**** Finally, set the Control Plane Register back to zero: ****/</span>
	<span class="n">GET_FIFO_SLOTS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">nFreeFifoSlots</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">NGLE_QUICK_SET_CTL_PLN_REG</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	
	<span class="n">NGLE_UNLOCK</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
<span class="p">}</span>
    
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ngleClearOverlayPlanes</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nFreeFifoSlots</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">packed_dst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">packed_len</span><span class="p">;</span>
    
	<span class="n">NGLE_LOCK</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

	<span class="cm">/* Hardware setup */</span>
	<span class="n">GET_FIFO_SLOTS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">nFreeFifoSlots</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">NGLE_QUICK_SET_DST_BM_ACCESS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> 
				     <span class="n">BA</span><span class="p">(</span><span class="n">IndexedDcd</span><span class="p">,</span> <span class="n">Otc04</span><span class="p">,</span> <span class="n">Ots08</span><span class="p">,</span> <span class="n">AddrLong</span><span class="p">,</span>
					<span class="n">BAJustPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">BINovly</span><span class="p">,</span> <span class="n">BAIndexBase</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>

        <span class="n">NGLE_SET_TRANSFERDATA</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>  <span class="cm">/* Write foreground color */</span>

        <span class="n">NGLE_REALLY_SET_IMAGE_FG_COLOR</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
        <span class="n">NGLE_REALLY_SET_IMAGE_PLANEMASK</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
    
        <span class="n">packed_dst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">packed_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
        <span class="n">NGLE_SET_DSTXY</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">packed_dst</span><span class="p">);</span>
    
        <span class="cm">/* Write zeroes to overlay planes */</span>		       
	<span class="n">NGLE_QUICK_SET_IMAGE_BITMAP_OP</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span>
				       <span class="n">IBOvals</span><span class="p">(</span><span class="n">RopSrc</span><span class="p">,</span> <span class="n">MaskAddrOffset</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
					       <span class="n">BitmapExtent08</span><span class="p">,</span> <span class="n">StaticReg</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
					       <span class="n">DataDynamic</span><span class="p">,</span> <span class="n">MaskOtc</span><span class="p">,</span> <span class="n">BGx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">FGx</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
		       
        <span class="n">SET_LENXY_START_RECFILL</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">packed_len</span><span class="p">);</span>

	<span class="n">NGLE_UNLOCK</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">hyperResetPlanes</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">controlPlaneReg</span><span class="p">;</span>

	<span class="n">NGLE_LOCK</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_24_DEVICE</span><span class="p">(</span><span class="n">fb</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">controlPlaneReg</span> <span class="o">=</span> <span class="mh">0x04000F00</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">controlPlaneReg</span> <span class="o">=</span> <span class="mh">0x00000F00</span><span class="p">;</span>   <span class="cm">/* 0x00000800 should be enough, but lets clear all 4 bits */</span>
	<span class="k">else</span>
		<span class="n">controlPlaneReg</span> <span class="o">=</span> <span class="mh">0x00000F00</span><span class="p">;</span> <span class="cm">/* 0x00000100 should be enough, but lets clear all 4 bits */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENABLE</span>:
		<span class="cm">/* clear screen */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_24_DEVICE</span><span class="p">(</span><span class="n">fb</span><span class="p">))</span>
			<span class="n">ngleDepth24_ClearImagePlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ngleDepth8_ClearImagePlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

		<span class="cm">/* Paint attribute planes for default case.</span>
<span class="cm">		 * On Hyperdrive, this means all windows using overlay cmap 0. */</span>
		<span class="n">ngleResetAttrPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">controlPlaneReg</span><span class="p">);</span>

		<span class="cm">/* clear overlay planes */</span>
	        <span class="n">ngleClearOverlayPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>

		<span class="cm">/**************************************************</span>
<span class="cm">		 ** Also need to counteract ITE settings </span>
<span class="cm">		 **************************************************/</span>
		<span class="n">hyperUndoITE</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DISABLE</span>:
		<span class="cm">/* clear screen */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_24_DEVICE</span><span class="p">(</span><span class="n">fb</span><span class="p">))</span>
			<span class="n">ngleDepth24_ClearImagePlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ngleDepth8_ClearImagePlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="n">ngleResetAttrPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">controlPlaneReg</span><span class="p">);</span>
		<span class="n">ngleClearOverlayPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:	<span class="cm">/* RESET */</span>
		<span class="n">hyperUndoITE</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="n">ngleResetAttrPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">controlPlaneReg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
    	<span class="p">}</span>
	
	<span class="n">NGLE_UNLOCK</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return pointer to in-memory structure holding ELK device-dependent ROM values. */</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">ngleGetDeviceRomData</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">XXX: FIXME: !!!</span>
<span class="c">	int	*pBytePerLongDevDepData;/* data byte == LSB */</span>
<span class="c">	int 	*pRomTable;</span>
<span class="c">	NgleDevRomData	*pPackedDevRomData;</span>
<span class="c">	int	sizePackedDevRomData = sizeof(*pPackedDevRomData);</span>
<span class="c">	char	*pCard8;</span>
<span class="c">	int	i;</span>
<span class="c">	char	*mapOrigin = NULL;</span>
<span class="c">    </span>
<span class="c">	int romTableIdx;</span>

<span class="c">	pPackedDevRomData = fb-&gt;ngle_rom;</span>

<span class="c">	SETUP_HW(fb);</span>
<span class="c">	if (fb-&gt;id == S9000_ID_ARTIST) {</span>
<span class="c">		pPackedDevRomData-&gt;cursor_pipeline_delay = 4;</span>
<span class="c">		pPackedDevRomData-&gt;video_interleaves     = 4;</span>
<span class="c">	} else {</span>
<span class="c">		/* Get pointer to unpacked byte/long data in ROM */</span>
<span class="c">		pBytePerLongDevDepData = fb-&gt;sti-&gt;regions[NGLEDEVDEPROM_CRT_REGION];</span>

<span class="c">		/* Tomcat supports several resolutions: 1280x1024, 1024x768, 640x480 */</span>
<span class="c">		if (fb-&gt;id == S9000_ID_TOMCAT)</span>
<span class="c">	{</span>
<span class="c">	    /*  jump to the correct ROM table  */</span>
<span class="c">	    GET_ROMTABLE_INDEX(romTableIdx);</span>
<span class="c">	    while  (romTableIdx &gt; 0)</span>
<span class="c">	    {</span>
<span class="c">		pCard8 = (Card8 *) pPackedDevRomData;</span>
<span class="c">		pRomTable = pBytePerLongDevDepData;</span>
<span class="c">		/* Pack every fourth byte from ROM into structure */</span>
<span class="c">		for (i = 0; i &lt; sizePackedDevRomData; i++)</span>
<span class="c">		{</span>
<span class="c">		    *pCard8++ = (Card8) (*pRomTable++);</span>
<span class="c">		}</span>

<span class="c">		pBytePerLongDevDepData = (Card32 *)</span>
<span class="c">			((Card8 *) pBytePerLongDevDepData +</span>
<span class="c">			       pPackedDevRomData-&gt;sizeof_ngle_data);</span>

<span class="c">		romTableIdx--;</span>
<span class="c">	    }</span>
<span class="c">	}</span>

<span class="c">	pCard8 = (Card8 *) pPackedDevRomData;</span>

<span class="c">	/* Pack every fourth byte from ROM into structure */</span>
<span class="c">	for (i = 0; i &lt; sizePackedDevRomData; i++)</span>
<span class="c">	{</span>
<span class="c">	    *pCard8++ = (Card8) (*pBytePerLongDevDepData++);</span>
<span class="c">	}</span>
<span class="c">    }</span>

<span class="c">    SETUP_FB(fb);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cp">#define HYPERBOWL_MODE_FOR_8_OVER_88_LUT0_NO_TRANSPARENCIES	4</span>
<span class="cp">#define HYPERBOWL_MODE01_8_24_LUT0_TRANSPARENT_LUT1_OPAQUE	8</span>
<span class="cp">#define HYPERBOWL_MODE01_8_24_LUT0_OPAQUE_LUT1_OPAQUE		10</span>
<span class="cp">#define HYPERBOWL_MODE2_8_24					15</span>

<span class="cm">/* HCRX specific boot-time initialization */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">SETUP_HCRX</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">hyperbowl</span><span class="p">;</span>
        <span class="kt">int</span>	<span class="n">nFreeFifoSlots</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">S9000_ID_HCRX</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Initialize Hyperbowl registers */</span>
	<span class="n">GET_FIFO_SLOTS</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">nFreeFifoSlots</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_24_DEVICE</span><span class="p">(</span><span class="n">fb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hyperbowl</span> <span class="o">=</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">HYPERBOWL_MODE01_8_24_LUT0_TRANSPARENT_LUT1_OPAQUE</span> <span class="o">:</span>
			<span class="n">HYPERBOWL_MODE01_8_24_LUT0_OPAQUE_LUT1_OPAQUE</span><span class="p">;</span>

		<span class="cm">/* First write to Hyperbowl must happen twice (bug) */</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">hyperbowl</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_40</span><span class="p">);</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">hyperbowl</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_40</span><span class="p">);</span>
		
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">HYPERBOWL_MODE2_8_24</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_39</span><span class="p">);</span>
		
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x014c0148</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_42</span><span class="p">);</span> <span class="cm">/* Set lut 0 to be the direct color */</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x404c4048</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_43</span><span class="p">);</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x034c0348</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_44</span><span class="p">);</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x444c4448</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_45</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hyperbowl</span> <span class="o">=</span> <span class="n">HYPERBOWL_MODE_FOR_8_OVER_88_LUT0_NO_TRANSPARENCIES</span><span class="p">;</span>

		<span class="cm">/* First write to Hyperbowl must happen twice (bug) */</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">hyperbowl</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_40</span><span class="p">);</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="n">hyperbowl</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_40</span><span class="p">);</span>

		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_42</span><span class="p">);</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_43</span><span class="p">);</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_44</span><span class="p">);</span>
		<span class="n">WRITE_WORD</span><span class="p">(</span><span class="mh">0x444c4048</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">REG_45</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* ------------------- driver specific functions --------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">stifb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span>
	      <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">color</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">NR_PALETTE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">red</span>   <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">blue</span>  <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">DEBUG_OFF</span><span class="p">();</span>

	<span class="n">START_IMAGE_COLORMAP_ACCESS</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* gray = 0.30*R + 0.59*G + 0.11*B */</span>
		<span class="n">color</span> <span class="o">=</span> <span class="p">((</span><span class="n">red</span> <span class="o">*</span> <span class="mi">77</span><span class="p">)</span> <span class="o">+</span>
			 <span class="p">(</span><span class="n">green</span> <span class="o">*</span> <span class="mi">151</span><span class="p">)</span> <span class="o">+</span>
			 <span class="p">(</span><span class="n">blue</span> <span class="o">*</span> <span class="mi">28</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">color</span> <span class="o">=</span> <span class="p">((</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">blue</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">|</span>
				<span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">|</span>
				<span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WRITE_IMAGE_COLOR</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">S9000_ID_HCRX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NgleLutBltCtl</span> <span class="n">lutBltCtl</span><span class="p">;</span>

		<span class="n">lutBltCtl</span> <span class="o">=</span> <span class="n">setHyperLutBltCtl</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Offset w/i LUT */</span>
				<span class="mi">256</span><span class="p">);</span>	<span class="cm">/* Load entire LUT */</span>
		<span class="n">NGLE_BINC_SET_SRCADDR</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span>
				<span class="n">NGLE_LONG_FB_ADDRESS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span> 
				<span class="cm">/* 0x100 is same as used in WRITE_IMAGE_COLOR() */</span>
		<span class="n">START_COLORMAPLOAD</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">lutBltCtl</span><span class="p">.</span><span class="n">all</span><span class="p">);</span>
		<span class="n">SETUP_FB</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* cleanup colormap hardware */</span>
		<span class="n">FINISH_IMAGE_COLORMAP_ACCESS</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DEBUG_ON</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">stifb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">blank_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">ENABLE</span> <span class="o">:</span> <span class="n">DISABLE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S9000_ID_A1439A</span>:
		<span class="n">CRX24_ENABLE_DISABLE_DISPLAY</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CRT_ID_VISUALIZE_EG</span>:
	<span class="k">case</span> <span class="n">S9000_ID_ARTIST</span>:
		<span class="n">ARTIST_ENABLE_DISABLE_DISPLAY</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S9000_ID_HCRX</span>:
		<span class="n">HYPER_ENABLE_DISABLE_DISPLAY</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S9000_ID_A1659A</span>:	<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">S9000_ID_TIMBER</span>:
	<span class="k">case</span> <span class="n">CRX24_OVERLAY_PLANES</span>:
	<span class="nl">default:</span>
		<span class="n">ENABLE_DISABLE_DISPLAY</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">SETUP_FB</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">stifb_init_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">SETUP_FB</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

	<span class="cm">/* HCRX specific initialization */</span>
	<span class="n">SETUP_HCRX</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	
	<span class="cm">/*</span>
<span class="cm">	if (id == S9000_ID_HCRX)</span>
<span class="cm">		hyperInitSprite(fb);</span>
<span class="cm">	else</span>
<span class="cm">		ngleInitSprite(fb);</span>
<span class="cm">	*/</span>
	
	<span class="cm">/* Initialize the image planes. */</span> 
        <span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">case</span> <span class="n">S9000_ID_HCRX</span>:
	    <span class="n">hyperResetPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">ENABLE</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
	 <span class="k">case</span> <span class="n">S9000_ID_A1439A</span>:
	    <span class="n">rattlerSetupPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
	 <span class="k">case</span> <span class="n">S9000_ID_A1659A</span>:
	 <span class="k">case</span> <span class="n">S9000_ID_ARTIST</span>:
	 <span class="k">case</span> <span class="n">CRT_ID_VISUALIZE_EG</span>:
	    <span class="n">elkSetupPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear attribute planes on non HCRX devices. */</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">case</span> <span class="n">S9000_ID_A1659A</span>:
	 <span class="k">case</span> <span class="n">S9000_ID_A1439A</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">ngleSetupAttrPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">BUFF1_CMAP3</span><span class="p">);</span>
	    <span class="k">else</span> <span class="p">{</span>
		<span class="n">ngleSetupAttrPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">BUFF1_CMAP0</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">S9000_ID_A1439A</span><span class="p">)</span>
		<span class="n">ngleClearOverlayPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
	 <span class="k">case</span> <span class="n">S9000_ID_ARTIST</span>:
	 <span class="k">case</span> <span class="n">CRT_ID_VISUALIZE_EG</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">ngleSetupAttrPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">BUFF1_CMAP3</span><span class="p">);</span>
	    <span class="k">else</span> <span class="p">{</span>
		<span class="n">ngleSetupAttrPlanes</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">ARTIST_CMAP0</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">stifb_blank</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">fb</span><span class="p">);</span>	<span class="cm">/* 0=enable screen */</span>

	<span class="n">SETUP_FB</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------ Interfaces to hardware functions ------------ */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">stifb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">stifb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">stifb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> *  Initialization</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">stifb_init_fb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sti_struct</span> <span class="o">*</span><span class="n">sti</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp_pref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stifb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sti_rom_address</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">;</span>

	<span class="n">fb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fb</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;stifb: Could not allocate stifb structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>

	<span class="cm">/* set struct to a known state */</span>
	<span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>

	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span> <span class="o">=</span> <span class="n">sti</span><span class="p">;</span>
	<span class="cm">/* store upper 32bits of the graphics id */</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">graphics_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* only supported cards are allowed */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CRT_ID_VISUALIZE_EG</span>:
		<span class="cm">/* Visualize cards can run either in &quot;double buffer&quot; or</span>
<span class="cm"> 		  &quot;standard&quot; mode. Depending on the mode, the card reports</span>
<span class="cm">		  a different device name, e.g. &quot;INTERNAL_EG_DX1024&quot; in double</span>
<span class="cm">		  buffer mode and &quot;INTERNAL_EG_X1024&quot; in standard mode.</span>
<span class="cm">		  Since this driver only supports standard mode, we check</span>
<span class="cm">		  if the device name contains the string &quot;DX&quot; and tell the</span>
<span class="cm">		  user how to reconfigure the card. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">outptr</span><span class="p">.</span><span class="n">dev_name</span><span class="p">,</span> <span class="s">&quot;DX&quot;</span><span class="p">))</span> <span class="p">{</span>
		   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
<span class="s">&quot;WARNING: stifb framebuffer driver does not support &#39;%s&#39; in double-buffer mode.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;WARNING: Please disable the double-buffer mode in IPL menu (the PARISC-BIOS).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sti</span><span class="o">-&gt;</span><span class="n">outptr</span><span class="p">.</span><span class="n">dev_name</span><span class="p">);</span>
		   <span class="k">goto</span> <span class="n">out_err0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall though */</span>
	<span class="k">case</span> <span class="n">S9000_ID_ARTIST</span>:
	<span class="k">case</span> <span class="n">S9000_ID_HCRX</span>:
	<span class="k">case</span> <span class="n">S9000_ID_TIMBER</span>:
	<span class="k">case</span> <span class="n">S9000_ID_A1659A</span>:
	<span class="k">case</span> <span class="n">S9000_ID_A1439A</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;stifb: &#39;%s&#39; (id: 0x%08x) not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sti</span><span class="o">-&gt;</span><span class="n">outptr</span><span class="p">.</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err0</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* default to 8 bpp on most graphic chips */</span>
	<span class="n">bpp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">xres</span> <span class="o">=</span> <span class="n">sti_onscreen_x</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span><span class="p">);</span>
	<span class="n">yres</span> <span class="o">=</span> <span class="n">sti_onscreen_y</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span><span class="p">);</span>

	<span class="n">ngleGetDeviceRomData</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

	<span class="cm">/* get (virtual) io region base addr */</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">REGION_BASE</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span>   <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>

       	<span class="cm">/* Reject any device not in the NGLE family */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S9000_ID_A1659A</span>:	<span class="cm">/* CRX/A1659A */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S9000_ID_ELM</span>:	<span class="cm">/* GRX, grayscale but else same as A1659A */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">S9000_ID_A1659A</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S9000_ID_TIMBER</span>:	<span class="cm">/* HP9000/710 Any (may be a grayscale device) */</span>
		<span class="n">dev_name</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">outptr</span><span class="p">.</span><span class="n">dev_name</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="s">&quot;GRAYSCALE&quot;</span><span class="p">)</span> <span class="o">||</span> 
		    <span class="n">strstr</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="s">&quot;Grayscale&quot;</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">strstr</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="s">&quot;grayscale&quot;</span><span class="p">))</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S9000_ID_TOMCAT</span>:	<span class="cm">/* Dual CRX, behaves else like a CRX */</span>
		<span class="cm">/* FIXME: TomCat supports two heads:</span>
<span class="cm">		 * fb.iobase = REGION_BASE(fb_info,3);</span>
<span class="cm">		 * fb.screen_base = ioremap_nocache(REGION_BASE(fb_info,2),xxx);</span>
<span class="cm">		 * for now we only support the left one ! */</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">ngle_rom</span><span class="p">.</span><span class="n">x_size_visible</span><span class="p">;</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">ngle_rom</span><span class="p">.</span><span class="n">y_size_visible</span><span class="p">;</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">S9000_ID_A1659A</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S9000_ID_A1439A</span>:	<span class="cm">/* CRX24/A1439A */</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S9000_ID_HCRX</span>:	<span class="cm">/* Hyperdrive/HCRX */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">ngle_rom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">ngle_rom</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">regions_phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfc000000</span><span class="p">)</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">regions_phys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfc000000</span><span class="p">))</span>
			<span class="n">sti_rom_address</span> <span class="o">=</span> <span class="n">F_EXTEND</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">regions_phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">sti_rom_address</span> <span class="o">=</span> <span class="n">F_EXTEND</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">regions_phys</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">deviceSpecificConfig</span> <span class="o">=</span> <span class="n">gsc_readl</span><span class="p">(</span><span class="n">sti_rom_address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_24_DEVICE</span><span class="p">(</span><span class="n">fb</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bpp_pref</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">bpp_pref</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
				<span class="n">bpp</span> <span class="o">=</span> <span class="n">bpp_pref</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bpp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">READ_WORD</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">REG_15</span><span class="p">);</span>
		<span class="n">SETUP_HW</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CRT_ID_VISUALIZE_EG</span>:
	<span class="k">case</span> <span class="n">S9000_ID_ARTIST</span>:	<span class="cm">/* Artist */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> 
<span class="cp">#ifdef FALLBACK_TO_1BPP</span>
	       	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
			<span class="s">&quot;stifb: Unsupported graphics card (id=0x%08x) &quot;</span>
				<span class="s">&quot;- now trying 1bpp mode instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* default to 1 bpp */</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#else</span>
	       	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
			<span class="s">&quot;stifb: Unsupported graphics card (id=0x%08x) &quot;</span>
				<span class="s">&quot;- skipping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>


	<span class="cm">/* get framebuffer physical and virtual base addr &amp; len (64bit ready) */</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">F_EXTEND</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">regions_phys</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">region_desc</span><span class="p">.</span><span class="n">length</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">;</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">glob_cfg</span><span class="o">-&gt;</span><span class="n">total_x</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span><span class="p">)</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span> <span class="cm">/* default */</span>
	
	<span class="cm">/* limit fbsize to max visible screen size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">&gt;</span> <span class="n">yres</span><span class="o">*</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span><span class="p">)</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">yres</span><span class="o">*</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span><span class="p">;</span>
	
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PLANES</span><span class="p">;</span>	<span class="cm">/* well, sort of */</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_MONO10</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">8</span>:
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">32</span>:
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;stifb&quot;</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stifb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">REGION_BASE</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="cm">/* This has to be done !!! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">NR_PALETTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_err1</span><span class="p">;</span>
	<span class="n">stifb_init_display</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">,</span> <span class="s">&quot;stifb fb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;stifb: cannot reserve fb region 0x%04lx-0x%04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="o">+</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err2</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">,</span> <span class="s">&quot;stifb mmio&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;stifb: cannot reserve sti mmio region 0x%04lx-0x%04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="o">+</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err4</span><span class="p">;</span>

	<span class="n">sti</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span> <span class="cm">/* save for unregister_framebuffer() */</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> 
	    <span class="s">&quot;fb%d: %s %dx%d-%d frame buffer device, %s, id: %04x, mmio: 0x%04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> 
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> 
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span>
		<span class="n">sti</span><span class="o">-&gt;</span><span class="n">outptr</span><span class="p">.</span><span class="n">dev_name</span><span class="p">,</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> 
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


<span class="nl">out_err4:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">);</span>
<span class="nl">out_err3:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">);</span>
<span class="nl">out_err2:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">out_err1:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="nl">out_err0:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">stifb_disabled</span> <span class="n">__initdata</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">__init</span>
<span class="n">stifb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">stifb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sti_struct</span> <span class="o">*</span><span class="n">sti</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sti_struct</span> <span class="o">*</span><span class="n">def_sti</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;stifb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">stifb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stifb_disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;stifb: disabled by </span><span class="se">\&quot;</span><span class="s">stifb=off</span><span class="se">\&quot;</span><span class="s"> kernel parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">def_sti</span> <span class="o">=</span> <span class="n">sti_get_rom</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_sti</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MAX_STI_ROMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sti</span> <span class="o">=</span> <span class="n">sti_get_rom</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sti</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sti</span> <span class="o">==</span> <span class="n">def_sti</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stifb_init_fb</span><span class="p">(</span><span class="n">sti</span><span class="p">,</span> <span class="n">stifb_bpp_pref</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MAX_STI_ROMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sti</span> <span class="o">=</span> <span class="n">sti_get_rom</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sti</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sti</span> <span class="o">==</span> <span class="n">def_sti</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">stifb_init_fb</span><span class="p">(</span><span class="n">sti</span><span class="p">,</span> <span class="n">stifb_bpp_pref</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Cleanup</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">stifb_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sti_struct</span> <span class="o">*</span><span class="n">sti</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MAX_STI_ROMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sti</span> <span class="o">=</span> <span class="n">sti_get_rom</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sti</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">sti</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
			<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">sti</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
		        <span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
					<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
		        <span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
		        <span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sti</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span>
<span class="nf">stifb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stifb_disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">options</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;bpp&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">options</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_STI_ROMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">stifb_bpp_pref</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;stifb=&quot;</span><span class="p">,</span> <span class="n">stifb_setup</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">stifb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">stifb_cleanup</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Helge Deller &lt;deller@gmx.de&gt;, Thomas Bogendoerfer &lt;tsbogend@alpha.franken.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Framebuffer driver for HP&#39;s NGLE series graphics cards in HP PARISC machines&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
