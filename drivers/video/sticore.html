<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › sticore.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sticore.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef STICORE_H</span>
<span class="cp">#define STICORE_H</span>

<span class="cm">/* generic STI structures &amp; functions */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define DPRINTK(x)	printk x</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(x) </span>
<span class="cp">#endif</span>

<span class="cp">#define MAX_STI_ROMS 4		</span><span class="cm">/* max no. of ROMs which this driver handles */</span><span class="cp"></span>

<span class="cp">#define STI_REGION_MAX 8	</span><span class="cm">/* hardcoded STI constants */</span><span class="cp"></span>
<span class="cp">#define STI_DEV_NAME_LENGTH 32</span>
<span class="cp">#define STI_MONITOR_MAX 256</span>

<span class="cp">#define STI_FONT_HPROMAN8 1</span>
<span class="cp">#define STI_FONT_KANA8 2</span>

<span class="cm">/* The latency of the STI functions cannot really be reduced by setting</span>
<span class="cm"> * this to 0;  STI doesn&#39;t seem to be designed to allow calling a different</span>
<span class="cm"> * function (or the same function with different arguments) after a</span>
<span class="cm"> * function exited with 1 as return value.</span>
<span class="cm"> *</span>
<span class="cm"> * As all of the functions below could be called from interrupt context,</span>
<span class="cm"> * we have to spin_lock_irqsave around the do { ret = bla(); } while(ret==1)</span>
<span class="cm"> * block.  Really bad latency there.</span>
<span class="cm"> *</span>
<span class="cm"> * Probably the best solution to all this is have the generic code manage</span>
<span class="cm"> * the screen buffer and a kernel thread to call STI occasionally.</span>
<span class="cm"> * </span>
<span class="cm"> * Luckily, the frame buffer guys have the same problem so we can just wait</span>
<span class="cm"> * for them to fix it and steal their solution.   prumpf</span>
<span class="cm"> */</span>
 
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#define STI_WAIT 1</span>

<span class="cp">#define STI_PTR(p)	( virt_to_phys(p) )</span>
<span class="cp">#define PTR_STI(p)	( phys_to_virt((unsigned long)p) )</span>
<span class="cp">#define STI_CALL(func, flags, inptr, outptr, glob_cfg)	\</span>
<span class="cp">       ({						\</span>
<span class="cp">               pdc_sti_call( func, STI_PTR(flags),	\</span>
<span class="cp">				   STI_PTR(inptr),	\</span>
<span class="cp">				   STI_PTR(outptr),	\</span>
<span class="cp">				   STI_PTR(glob_cfg));	\</span>
<span class="cp">       })</span>


<span class="cp">#define sti_onscreen_x(sti) (sti-&gt;glob_cfg-&gt;onscreen_x)</span>
<span class="cp">#define sti_onscreen_y(sti) (sti-&gt;glob_cfg-&gt;onscreen_y)</span>

<span class="cm">/* sti_font_xy() use the native font ROM ! */</span>
<span class="cp">#define sti_font_x(sti) (PTR_STI(sti-&gt;font)-&gt;width)</span>
<span class="cp">#define sti_font_y(sti) (PTR_STI(sti-&gt;font)-&gt;height)</span>


<span class="cm">/* STI function configuration structs */</span>

<span class="k">typedef</span> <span class="k">union</span> <span class="n">region</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span> 
		<span class="n">u32</span> <span class="n">offset</span>	<span class="o">:</span> <span class="mi">14</span><span class="p">;</span>	<span class="cm">/* offset in 4kbyte page */</span>
		<span class="n">u32</span> <span class="n">sys_only</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* don&#39;t map to user space */</span>
		<span class="n">u32</span> <span class="n">cache</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* map to data cache */</span>
		<span class="n">u32</span> <span class="n">btlb</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* map to block tlb */</span>
		<span class="n">u32</span> <span class="n">last</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* last region in list */</span>
		<span class="n">u32</span> <span class="n">length</span>	<span class="o">:</span> <span class="mi">14</span><span class="p">;</span>	<span class="cm">/* length in 4kbyte page */</span>
	<span class="p">}</span> <span class="n">region_desc</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">region</span><span class="p">;</span>			<span class="cm">/* complete region value */</span>
<span class="p">}</span> <span class="n">region_t</span><span class="p">;</span>

<span class="cp">#define REGION_OFFSET_TO_PHYS( rt, hpa ) \</span>
<span class="cp">	(((rt).region_desc.offset &lt;&lt; 12) + (hpa))</span>

<span class="k">struct</span> <span class="n">sti_glob_cfg_ext</span> <span class="p">{</span>
	 <span class="n">u8</span> <span class="n">curr_mon</span><span class="p">;</span>			<span class="cm">/* current monitor configured */</span>
	 <span class="n">u8</span> <span class="n">friendly_boot</span><span class="p">;</span>		<span class="cm">/* in friendly boot mode */</span>
	<span class="n">s16</span> <span class="n">power</span><span class="p">;</span>			<span class="cm">/* power calculation (in Watts) */</span>
	<span class="n">s32</span> <span class="n">freq_ref</span><span class="p">;</span>			<span class="cm">/* frequency reference */</span>
	<span class="n">u32</span> <span class="n">sti_mem_addr</span><span class="p">;</span>		<span class="cm">/* pointer to global sti memory (size=sti_mem_request) */</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 		<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_glob_cfg</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">text_planes</span><span class="p">;</span>		<span class="cm">/* number of planes used for text */</span>
	<span class="n">s16</span> <span class="n">onscreen_x</span><span class="p">;</span>			<span class="cm">/* screen width in pixels */</span>
	<span class="n">s16</span> <span class="n">onscreen_y</span><span class="p">;</span>			<span class="cm">/* screen height in pixels */</span>
	<span class="n">s16</span> <span class="n">offscreen_x</span><span class="p">;</span>		<span class="cm">/* offset width in pixels */</span>
	<span class="n">s16</span> <span class="n">offscreen_y</span><span class="p">;</span>		<span class="cm">/* offset height in pixels */</span>
	<span class="n">s16</span> <span class="n">total_x</span><span class="p">;</span>			<span class="cm">/* frame buffer width in pixels */</span>
	<span class="n">s16</span> <span class="n">total_y</span><span class="p">;</span>			<span class="cm">/* frame buffer height in pixels */</span>
	<span class="n">u32</span> <span class="n">region_ptrs</span><span class="p">[</span><span class="n">STI_REGION_MAX</span><span class="p">];</span> <span class="cm">/* region pointers */</span>
	<span class="n">s32</span> <span class="n">reent_lvl</span><span class="p">;</span>			<span class="cm">/* storage for reentry level value */</span>
	<span class="n">u32</span> <span class="n">save_addr</span><span class="p">;</span>			<span class="cm">/* where to save or restore reentrant state */</span>
	<span class="n">u32</span> <span class="n">ext_ptr</span><span class="p">;</span>			<span class="cm">/* pointer to extended glob_cfg data structure */</span>
<span class="p">};</span>


<span class="cm">/* STI init function structs */</span>

<span class="k">struct</span> <span class="n">sti_init_flags</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">wait</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* should routine idle wait or not */</span>
	<span class="n">u32</span> <span class="n">reset</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* hard reset the device? */</span>
	<span class="n">u32</span> <span class="n">text</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* turn on text display planes? */</span>
	<span class="n">u32</span> <span class="n">nontext</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* turn on non-text display planes? */</span>
	<span class="n">u32</span> <span class="n">clear</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* clear text display planes? */</span>
	<span class="n">u32</span> <span class="n">cmap_blk</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* non-text planes cmap black? */</span>
	<span class="n">u32</span> <span class="n">enable_be_timer</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* enable bus error timer */</span>
	<span class="n">u32</span> <span class="n">enable_be_int</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* enable bus error timer interrupt */</span>
	<span class="n">u32</span> <span class="n">no_chg_tx</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* don&#39;t change text settings */</span>
	<span class="n">u32</span> <span class="n">no_chg_ntx</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* don&#39;t change non-text settings */</span>
	<span class="n">u32</span> <span class="n">no_chg_bet</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* don&#39;t change berr timer settings */</span>
	<span class="n">u32</span> <span class="n">no_chg_bei</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* don&#39;t change berr int settings */</span>
	<span class="n">u32</span> <span class="n">init_cmap_tx</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* initialize cmap for text planes */</span>
	<span class="n">u32</span> <span class="n">cmt_chg</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* change current monitor type */</span>
	<span class="n">u32</span> <span class="n">retain_ie</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* don&#39;t allow reset to clear int enables */</span>
	<span class="n">u32</span> <span class="n">caller_bootrom</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* set only by bootrom for each call */</span>
	<span class="n">u32</span> <span class="n">caller_kernel</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* set only by kernel for each call */</span>
	<span class="n">u32</span> <span class="n">caller_other</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* set only by non-[BR/K] caller */</span>
	<span class="n">u32</span> <span class="n">pad</span>	<span class="o">:</span> <span class="mi">14</span><span class="p">;</span>		<span class="cm">/* pad to word boundary */</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 	<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_init_inptr_ext</span> <span class="p">{</span>
	<span class="n">u8</span>  <span class="n">config_mon_type</span><span class="p">;</span>	<span class="cm">/* configure to monitor type */</span>
	<span class="n">u8</span>  <span class="n">pad</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>		<span class="cm">/* pad to word boundary */</span>
	<span class="n">u16</span> <span class="n">inflight_data</span><span class="p">;</span>	<span class="cm">/* inflight data possible on PCI */</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 	<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_init_inptr</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">text_planes</span><span class="p">;</span>	<span class="cm">/* number of planes to use for text */</span>
	<span class="n">u32</span> <span class="n">ext_ptr</span><span class="p">;</span>		<span class="cm">/* pointer to extended init_graph inptr data structure*/</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">sti_init_outptr</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">errno</span><span class="p">;</span>		<span class="cm">/* error number on failure */</span>
	<span class="n">s32</span> <span class="n">text_planes</span><span class="p">;</span>	<span class="cm">/* number of planes used for text */</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 	<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>



<span class="cm">/* STI configuration function structs */</span>

<span class="k">struct</span> <span class="n">sti_conf_flags</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">wait</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* should routine idle wait or not */</span>
	<span class="n">u32</span> <span class="n">pad</span> <span class="o">:</span> <span class="mi">31</span><span class="p">;</span>		<span class="cm">/* pad to word boundary */</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 	<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_conf_inptr</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 	<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_conf_outptr_ext</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">crt_config</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* hardware specific X11/OGL information */</span>	
	<span class="n">u32</span> <span class="n">crt_hdw</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_conf_outptr</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">errno</span><span class="p">;</span>		<span class="cm">/* error number on failure */</span>
	<span class="n">s16</span> <span class="n">onscreen_x</span><span class="p">;</span>		<span class="cm">/* screen width in pixels */</span>
	<span class="n">s16</span> <span class="n">onscreen_y</span><span class="p">;</span>		<span class="cm">/* screen height in pixels */</span>
	<span class="n">s16</span> <span class="n">offscreen_x</span><span class="p">;</span>	<span class="cm">/* offscreen width in pixels */</span>
	<span class="n">s16</span> <span class="n">offscreen_y</span><span class="p">;</span>	<span class="cm">/* offscreen height in pixels */</span>
	<span class="n">s16</span> <span class="n">total_x</span><span class="p">;</span>		<span class="cm">/* frame buffer width in pixels */</span>
	<span class="n">s16</span> <span class="n">total_y</span><span class="p">;</span>		<span class="cm">/* frame buffer height in pixels */</span>
	<span class="n">s32</span> <span class="n">bits_per_pixel</span><span class="p">;</span>	<span class="cm">/* bits/pixel device has configured */</span>
	<span class="n">s32</span> <span class="n">bits_used</span><span class="p">;</span>		<span class="cm">/* bits which can be accessed */</span>
	<span class="n">s32</span> <span class="n">planes</span><span class="p">;</span>		<span class="cm">/* number of fb planes in system */</span>
	 <span class="n">u8</span> <span class="n">dev_name</span><span class="p">[</span><span class="n">STI_DEV_NAME_LENGTH</span><span class="p">];</span> <span class="cm">/* null terminated product name */</span>
	<span class="n">u32</span> <span class="n">attributes</span><span class="p">;</span>		<span class="cm">/* flags denoting attributes */</span>
	<span class="n">u32</span> <span class="n">ext_ptr</span><span class="p">;</span>		<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_rom</span> <span class="p">{</span>
	 <span class="n">u8</span> <span class="n">type</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	 <span class="n">u8</span> <span class="n">res004</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">num_mons</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">revno</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">graphics_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">u32</span> <span class="n">font_start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">statesize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">region_list</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">reentsize</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">maxtime</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mon_tbl_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">user_data_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sti_mem_req</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">user_data_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">power</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">bus_support</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">ext_bus_support</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">alt_code_type</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">ext_dd_struct</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">cfb_addr</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">init_graph</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state_mgmt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">font_unpmv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">block_move</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">self_test</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">excep_hdlr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inq_conf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">set_cm_entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_ctrl</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">res040</span><span class="p">[</span><span class="mi">7</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>
	
	<span class="n">u32</span> <span class="n">init_graph_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state_mgmt_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">font_unp_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">block_move_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">self_test_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">excep_hdlr_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inq_conf_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">set_cm_entry_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">image_unpack_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pa_risx_addrs</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_rom_font</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">first_char</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">last_char</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">width</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">height</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">font_type</span><span class="p">;</span>		<span class="cm">/* language type */</span>
	 <span class="n">u8</span> <span class="n">bytes_per_char</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">next_font</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">underline_height</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">underline_pos</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">res008</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* sticore internal font handling */</span>

<span class="k">struct</span> <span class="n">sti_cooked_font</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">sti_rom_font</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sti_cooked_font</span> <span class="o">*</span><span class="n">next_font</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_cooked_rom</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">sti_rom</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sti_cooked_font</span> <span class="o">*</span><span class="n">font_start</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* STI font printing function structs */</span>

<span class="k">struct</span> <span class="n">sti_font_inptr</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">font_start_addr</span><span class="p">;</span>	<span class="cm">/* address of font start */</span>
	<span class="n">s16</span> <span class="n">index</span><span class="p">;</span>		<span class="cm">/* index into font table of character */</span>
	<span class="n">u8</span> <span class="n">fg_color</span><span class="p">;</span>		<span class="cm">/* foreground color of character */</span>
	<span class="n">u8</span> <span class="n">bg_color</span><span class="p">;</span>		<span class="cm">/* background color of character */</span>
	<span class="n">s16</span> <span class="n">dest_x</span><span class="p">;</span>		<span class="cm">/* X location of character upper left */</span>
	<span class="n">s16</span> <span class="n">dest_y</span><span class="p">;</span>		<span class="cm">/* Y location of character upper left */</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 	<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_font_flags</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">wait</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* should routine idle wait or not */</span>
	<span class="n">u32</span> <span class="n">non_text</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* font unpack/move in non_text planes =1, text =0 */</span>
	<span class="n">u32</span> <span class="n">pad</span> <span class="o">:</span> <span class="mi">30</span><span class="p">;</span>		<span class="cm">/* pad to word boundary */</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 	<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>
	
<span class="k">struct</span> <span class="n">sti_font_outptr</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">errno</span><span class="p">;</span>		<span class="cm">/* error number on failure */</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 	<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>

<span class="cm">/* STI blockmove structs */</span>

<span class="k">struct</span> <span class="n">sti_blkmv_flags</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">wait</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* should routine idle wait or not */</span>
	<span class="n">u32</span> <span class="n">color</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* change color during move? */</span>
	<span class="n">u32</span> <span class="n">clear</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* clear during move? */</span>
	<span class="n">u32</span> <span class="n">non_text</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* block move in non_text planes =1, text =0 */</span>
	<span class="n">u32</span> <span class="n">pad</span> <span class="o">:</span> <span class="mi">28</span><span class="p">;</span>		<span class="cm">/* pad to word boundary */</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 	<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_blkmv_inptr</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">fg_color</span><span class="p">;</span>		<span class="cm">/* foreground color after move */</span>
	<span class="n">u8</span> <span class="n">bg_color</span><span class="p">;</span>		<span class="cm">/* background color after move */</span>
	<span class="n">s16</span> <span class="n">src_x</span><span class="p">;</span>		<span class="cm">/* source upper left pixel x location */</span>
	<span class="n">s16</span> <span class="n">src_y</span><span class="p">;</span>		<span class="cm">/* source upper left pixel y location */</span>
	<span class="n">s16</span> <span class="n">dest_x</span><span class="p">;</span>		<span class="cm">/* dest upper left pixel x location */</span>
	<span class="n">s16</span> <span class="n">dest_y</span><span class="p">;</span>		<span class="cm">/* dest upper left pixel y location */</span>
	<span class="n">s16</span> <span class="n">width</span><span class="p">;</span>		<span class="cm">/* block width in pixels */</span>
	<span class="n">s16</span> <span class="n">height</span><span class="p">;</span>		<span class="cm">/* block height in pixels */</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 	<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sti_blkmv_outptr</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">errno</span><span class="p">;</span>		<span class="cm">/* error number on failure */</span>
	<span class="n">u32</span> <span class="n">future_ptr</span><span class="p">;</span> 	<span class="cm">/* pointer to future data */</span>
<span class="p">};</span>


<span class="cm">/* internal generic STI struct */</span>

<span class="k">struct</span> <span class="n">sti_struct</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
		
	<span class="cm">/* the following fields needs to be filled in by the word/byte routines */</span>
	<span class="kt">int</span> <span class="n">font_width</span><span class="p">;</span>	
	<span class="kt">int</span> <span class="n">font_height</span><span class="p">;</span>
	<span class="cm">/* char **mon_strings; */</span>
	<span class="kt">int</span> <span class="n">sti_mem_request</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">graphics_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">sti_cooked_rom</span> <span class="o">*</span><span class="n">rom</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">font_unpmv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block_move</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">init_graph</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">inq_conf</span><span class="p">;</span>

	<span class="cm">/* all following fields are initialized by the generic routines */</span>
	<span class="kt">int</span> <span class="n">text_planes</span><span class="p">;</span>
	<span class="n">region_t</span> <span class="n">regions</span><span class="p">[</span><span class="n">STI_REGION_MAX</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regions_phys</span><span class="p">[</span><span class="n">STI_REGION_MAX</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">sti_glob_cfg</span> <span class="o">*</span><span class="n">glob_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sti_cooked_font</span> <span class="o">*</span><span class="n">font</span><span class="p">;</span>	<span class="cm">/* ptr to selected font (cooked) */</span>

	<span class="k">struct</span> <span class="n">sti_conf_outptr</span> <span class="n">outptr</span><span class="p">;</span> <span class="cm">/* configuration */</span>
	<span class="k">struct</span> <span class="n">sti_conf_outptr_ext</span> <span class="n">outptr_ext</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>

	<span class="cm">/* PCI data structures (pg. 17ff from sti.pdf) */</span>
	<span class="n">u8</span> <span class="n">rm_entry</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="cm">/* pci region mapper array == pci config space offset */</span>

	<span class="cm">/* pointer to the fb_info where this STI device is used */</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* sticore interface functions */</span>

<span class="k">struct</span> <span class="n">sti_struct</span> <span class="o">*</span><span class="n">sti_get_rom</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">);</span> <span class="cm">/* 0: default sti */</span>

<span class="cm">/* functions to call the STI ROM directly */</span>

<span class="kt">void</span> <span class="n">sti_putc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sti_struct</span> <span class="o">*</span><span class="n">sti</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">sti_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">sti_struct</span> <span class="o">*</span><span class="n">sti</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_x</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">u8</span> <span class="n">color</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">sti_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">sti_struct</span> <span class="o">*</span><span class="n">sti</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_x</span><span class="p">,</span>
	       <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">sti_bmove</span><span class="p">(</span><span class="k">struct</span> <span class="n">sti_struct</span> <span class="o">*</span><span class="n">sti</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_x</span><span class="p">,</span>
	       <span class="kt">int</span> <span class="n">dst_y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">);</span>

<span class="cp">#endif	</span><span class="cm">/* STICORE_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
