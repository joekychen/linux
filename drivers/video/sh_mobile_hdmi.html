<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › sh_mobile_hdmi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sh_mobile_hdmi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SH-Mobile High-Definition Multimedia Interface (HDMI) driver</span>
<span class="cm"> * for SLISHDMI13T and SLIPHDMIT IP cores</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010, Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/soc-dapm.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#include &lt;video/sh_mobile_hdmi.h&gt;</span>
<span class="cp">#include &lt;video/sh_mobile_lcdc.h&gt;</span>

<span class="cp">#include &quot;sh_mobile_lcdcfb.h&quot;</span>

<span class="cm">/* HDMI Core Control Register (HTOP0) */</span>
<span class="cp">#define HDMI_SYSTEM_CTRL			0x00 </span><span class="cm">/* System control */</span><span class="cp"></span>
<span class="cp">#define HDMI_L_R_DATA_SWAP_CTRL_RPKT		0x01 </span><span class="cm">/* L/R data swap control,</span>
<span class="cm">							bits 19..16 of 20-bit N for Audio Clock Regeneration packet */</span><span class="cp"></span>
<span class="cp">#define HDMI_20_BIT_N_FOR_AUDIO_RPKT_15_8	0x02 </span><span class="cm">/* bits 15..8 of 20-bit N for Audio Clock Regeneration packet */</span><span class="cp"></span>
<span class="cp">#define HDMI_20_BIT_N_FOR_AUDIO_RPKT_7_0	0x03 </span><span class="cm">/* bits 7..0 of 20-bit N for Audio Clock Regeneration packet */</span><span class="cp"></span>
<span class="cp">#define HDMI_SPDIF_AUDIO_SAMP_FREQ_CTS		0x04 </span><span class="cm">/* SPDIF audio sampling frequency,</span>
<span class="cm">							bits 19..16 of Internal CTS */</span><span class="cp"></span>
<span class="cp">#define HDMI_INTERNAL_CTS_15_8			0x05 </span><span class="cm">/* bits 15..8 of Internal CTS */</span><span class="cp"></span>
<span class="cp">#define HDMI_INTERNAL_CTS_7_0			0x06 </span><span class="cm">/* bits 7..0 of Internal CTS */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_CTS_19_16			0x07 </span><span class="cm">/* External CTS */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_CTS_15_8			0x08 </span><span class="cm">/* External CTS */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_CTS_7_0			0x09 </span><span class="cm">/* External CTS */</span><span class="cp"></span>
<span class="cp">#define HDMI_AUDIO_SETTING_1			0x0A </span><span class="cm">/* Audio setting.1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_AUDIO_SETTING_2			0x0B </span><span class="cm">/* Audio setting.2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_I2S_AUDIO_SET			0x0C </span><span class="cm">/* I2S audio setting */</span><span class="cp"></span>
<span class="cp">#define HDMI_DSD_AUDIO_SET			0x0D </span><span class="cm">/* DSD audio setting */</span><span class="cp"></span>
<span class="cp">#define HDMI_DEBUG_MONITOR_1			0x0E </span><span class="cm">/* Debug monitor.1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_DEBUG_MONITOR_2			0x0F </span><span class="cm">/* Debug monitor.2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_I2S_INPUT_PIN_SWAP			0x10 </span><span class="cm">/* I2S input pin swap */</span><span class="cp"></span>
<span class="cp">#define HDMI_AUDIO_STATUS_BITS_SETTING_1	0x11 </span><span class="cm">/* Audio status bits setting.1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_AUDIO_STATUS_BITS_SETTING_2	0x12 </span><span class="cm">/* Audio status bits setting.2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CATEGORY_CODE			0x13 </span><span class="cm">/* Category code */</span><span class="cp"></span>
<span class="cp">#define HDMI_SOURCE_NUM_AUDIO_WORD_LEN		0x14 </span><span class="cm">/* Source number/Audio word length */</span><span class="cp"></span>
<span class="cp">#define HDMI_AUDIO_VIDEO_SETTING_1		0x15 </span><span class="cm">/* Audio/Video setting.1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_VIDEO_SETTING_1			0x16 </span><span class="cm">/* Video setting.1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_DEEP_COLOR_MODES			0x17 </span><span class="cm">/* Deep Color Modes */</span><span class="cp"></span>

<span class="cm">/* 12 16- and 10-bit Color space conversion parameters: 0x18..0x2f */</span>
<span class="cp">#define HDMI_COLOR_SPACE_CONVERSION_PARAMETERS	0x18</span>

<span class="cp">#define HDMI_EXTERNAL_VIDEO_PARAM_SETTINGS	0x30 </span><span class="cm">/* External video parameter settings */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_H_TOTAL_7_0		0x31 </span><span class="cm">/* External horizontal total (LSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_H_TOTAL_11_8		0x32 </span><span class="cm">/* External horizontal total (MSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_H_BLANK_7_0		0x33 </span><span class="cm">/* External horizontal blank (LSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_H_BLANK_9_8		0x34 </span><span class="cm">/* External horizontal blank (MSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_H_DELAY_7_0		0x35 </span><span class="cm">/* External horizontal delay (LSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_H_DELAY_9_8		0x36 </span><span class="cm">/* External horizontal delay (MSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_H_DURATION_7_0		0x37 </span><span class="cm">/* External horizontal duration (LSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_H_DURATION_9_8		0x38 </span><span class="cm">/* External horizontal duration (MSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_V_TOTAL_7_0		0x39 </span><span class="cm">/* External vertical total (LSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_V_TOTAL_9_8		0x3A </span><span class="cm">/* External vertical total (MSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_AUDIO_VIDEO_SETTING_2		0x3B </span><span class="cm">/* Audio/Video setting.2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_V_BLANK			0x3D </span><span class="cm">/* External vertical blank */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_V_DELAY			0x3E </span><span class="cm">/* External vertical delay */</span><span class="cp"></span>
<span class="cp">#define HDMI_EXTERNAL_V_DURATION		0x3F </span><span class="cm">/* External vertical duration */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_MANUAL_SEND_CONTROL	0x40 </span><span class="cm">/* Control packet manual send control */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_AUTO_SEND			0x41 </span><span class="cm">/* Control packet auto send with VSYNC control */</span><span class="cp"></span>
<span class="cp">#define HDMI_AUTO_CHECKSUM_OPTION		0x42 </span><span class="cm">/* Auto checksum option */</span><span class="cp"></span>
<span class="cp">#define HDMI_VIDEO_SETTING_2			0x45 </span><span class="cm">/* Video setting.2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_OUTPUT_OPTION			0x46 </span><span class="cm">/* Output option */</span><span class="cp"></span>
<span class="cp">#define HDMI_SLIPHDMIT_PARAM_OPTION		0x51 </span><span class="cm">/* SLIPHDMIT parameter option */</span><span class="cp"></span>
<span class="cp">#define HDMI_HSYNC_PMENT_AT_EMB_7_0		0x52 </span><span class="cm">/* HSYNC placement at embedded sync (LSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_HSYNC_PMENT_AT_EMB_15_8		0x53 </span><span class="cm">/* HSYNC placement at embedded sync (MSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_VSYNC_PMENT_AT_EMB_7_0		0x54 </span><span class="cm">/* VSYNC placement at embedded sync (LSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_VSYNC_PMENT_AT_EMB_14_8		0x55 </span><span class="cm">/* VSYNC placement at embedded sync (MSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_SLIPHDMIT_PARAM_SETTINGS_1		0x56 </span><span class="cm">/* SLIPHDMIT parameter settings.1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SLIPHDMIT_PARAM_SETTINGS_2		0x57 </span><span class="cm">/* SLIPHDMIT parameter settings.2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SLIPHDMIT_PARAM_SETTINGS_3		0x58 </span><span class="cm">/* SLIPHDMIT parameter settings.3 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SLIPHDMIT_PARAM_SETTINGS_5		0x59 </span><span class="cm">/* SLIPHDMIT parameter settings.5 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SLIPHDMIT_PARAM_SETTINGS_6		0x5A </span><span class="cm">/* SLIPHDMIT parameter settings.6 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SLIPHDMIT_PARAM_SETTINGS_7		0x5B </span><span class="cm">/* SLIPHDMIT parameter settings.7 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SLIPHDMIT_PARAM_SETTINGS_8		0x5C </span><span class="cm">/* SLIPHDMIT parameter settings.8 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SLIPHDMIT_PARAM_SETTINGS_9		0x5D </span><span class="cm">/* SLIPHDMIT parameter settings.9 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SLIPHDMIT_PARAM_SETTINGS_10	0x5E </span><span class="cm">/* SLIPHDMIT parameter settings.10 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_INDEX			0x5F </span><span class="cm">/* Control packet buffer index */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_HB0		0x60 </span><span class="cm">/* Control packet data buffer access window - HB0 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_HB1		0x61 </span><span class="cm">/* Control packet data buffer access window - HB1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_HB2		0x62 </span><span class="cm">/* Control packet data buffer access window - HB2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB0		0x63 </span><span class="cm">/* Control packet data buffer access window - PB0 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB1		0x64 </span><span class="cm">/* Control packet data buffer access window - PB1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB2		0x65 </span><span class="cm">/* Control packet data buffer access window - PB2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB3		0x66 </span><span class="cm">/* Control packet data buffer access window - PB3 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB4		0x67 </span><span class="cm">/* Control packet data buffer access window - PB4 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB5		0x68 </span><span class="cm">/* Control packet data buffer access window - PB5 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB6		0x69 </span><span class="cm">/* Control packet data buffer access window - PB6 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB7		0x6A </span><span class="cm">/* Control packet data buffer access window - PB7 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB8		0x6B </span><span class="cm">/* Control packet data buffer access window - PB8 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB9		0x6C </span><span class="cm">/* Control packet data buffer access window - PB9 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB10		0x6D </span><span class="cm">/* Control packet data buffer access window - PB10 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB11		0x6E </span><span class="cm">/* Control packet data buffer access window - PB11 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB12		0x6F </span><span class="cm">/* Control packet data buffer access window - PB12 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB13		0x70 </span><span class="cm">/* Control packet data buffer access window - PB13 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB14		0x71 </span><span class="cm">/* Control packet data buffer access window - PB14 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB15		0x72 </span><span class="cm">/* Control packet data buffer access window - PB15 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB16		0x73 </span><span class="cm">/* Control packet data buffer access window - PB16 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB17		0x74 </span><span class="cm">/* Control packet data buffer access window - PB17 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB18		0x75 </span><span class="cm">/* Control packet data buffer access window - PB18 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB19		0x76 </span><span class="cm">/* Control packet data buffer access window - PB19 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB20		0x77 </span><span class="cm">/* Control packet data buffer access window - PB20 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB21		0x78 </span><span class="cm">/* Control packet data buffer access window - PB21 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB22		0x79 </span><span class="cm">/* Control packet data buffer access window - PB22 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB23		0x7A </span><span class="cm">/* Control packet data buffer access window - PB23 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB24		0x7B </span><span class="cm">/* Control packet data buffer access window - PB24 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB25		0x7C </span><span class="cm">/* Control packet data buffer access window - PB25 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB26		0x7D </span><span class="cm">/* Control packet data buffer access window - PB26 */</span><span class="cp"></span>
<span class="cp">#define HDMI_CTRL_PKT_BUF_ACCESS_PB27		0x7E </span><span class="cm">/* Control packet data buffer access window - PB27 */</span><span class="cp"></span>
<span class="cp">#define HDMI_EDID_KSV_FIFO_ACCESS_WINDOW	0x80 </span><span class="cm">/* EDID/KSV FIFO access window */</span><span class="cp"></span>
<span class="cp">#define HDMI_DDC_BUS_ACCESS_FREQ_CTRL_7_0	0x81 </span><span class="cm">/* DDC bus access frequency control (LSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_DDC_BUS_ACCESS_FREQ_CTRL_15_8	0x82 </span><span class="cm">/* DDC bus access frequency control (MSB) */</span><span class="cp"></span>
<span class="cp">#define HDMI_INTERRUPT_MASK_1			0x92 </span><span class="cm">/* Interrupt mask.1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_INTERRUPT_MASK_2			0x93 </span><span class="cm">/* Interrupt mask.2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_INTERRUPT_STATUS_1			0x94 </span><span class="cm">/* Interrupt status.1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_INTERRUPT_STATUS_2			0x95 </span><span class="cm">/* Interrupt status.2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_INTERRUPT_MASK_3			0x96 </span><span class="cm">/* Interrupt mask.3 */</span><span class="cp"></span>
<span class="cp">#define HDMI_INTERRUPT_MASK_4			0x97 </span><span class="cm">/* Interrupt mask.4 */</span><span class="cp"></span>
<span class="cp">#define HDMI_INTERRUPT_STATUS_3			0x98 </span><span class="cm">/* Interrupt status.3 */</span><span class="cp"></span>
<span class="cp">#define HDMI_INTERRUPT_STATUS_4			0x99 </span><span class="cm">/* Interrupt status.4 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SOFTWARE_HDCP_CONTROL_1		0x9A </span><span class="cm">/* Software HDCP control.1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_FRAME_COUNTER			0x9C </span><span class="cm">/* Frame counter */</span><span class="cp"></span>
<span class="cp">#define HDMI_FRAME_COUNTER_FOR_RI_CHECK		0x9D </span><span class="cm">/* Frame counter for Ri check */</span><span class="cp"></span>
<span class="cp">#define HDMI_HDCP_CONTROL			0xAF </span><span class="cm">/* HDCP control */</span><span class="cp"></span>
<span class="cp">#define HDMI_RI_FRAME_COUNT_REGISTER		0xB2 </span><span class="cm">/* Ri frame count register */</span><span class="cp"></span>
<span class="cp">#define HDMI_DDC_BUS_CONTROL			0xB7 </span><span class="cm">/* DDC bus control */</span><span class="cp"></span>
<span class="cp">#define HDMI_HDCP_STATUS			0xB8 </span><span class="cm">/* HDCP status */</span><span class="cp"></span>
<span class="cp">#define HDMI_SHA0				0xB9 </span><span class="cm">/* sha0 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SHA1				0xBA </span><span class="cm">/* sha1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SHA2				0xBB </span><span class="cm">/* sha2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SHA3				0xBC </span><span class="cm">/* sha3 */</span><span class="cp"></span>
<span class="cp">#define HDMI_SHA4				0xBD </span><span class="cm">/* sha4 */</span><span class="cp"></span>
<span class="cp">#define HDMI_BCAPS_READ				0xBE </span><span class="cm">/* BCAPS read / debug */</span><span class="cp"></span>
<span class="cp">#define HDMI_AKSV_BKSV_7_0_MONITOR		0xBF </span><span class="cm">/* AKSV/BKSV[7:0] monitor */</span><span class="cp"></span>
<span class="cp">#define HDMI_AKSV_BKSV_15_8_MONITOR		0xC0 </span><span class="cm">/* AKSV/BKSV[15:8] monitor */</span><span class="cp"></span>
<span class="cp">#define HDMI_AKSV_BKSV_23_16_MONITOR		0xC1 </span><span class="cm">/* AKSV/BKSV[23:16] monitor */</span><span class="cp"></span>
<span class="cp">#define HDMI_AKSV_BKSV_31_24_MONITOR		0xC2 </span><span class="cm">/* AKSV/BKSV[31:24] monitor */</span><span class="cp"></span>
<span class="cp">#define HDMI_AKSV_BKSV_39_32_MONITOR		0xC3 </span><span class="cm">/* AKSV/BKSV[39:32] monitor */</span><span class="cp"></span>
<span class="cp">#define HDMI_EDID_SEGMENT_POINTER		0xC4 </span><span class="cm">/* EDID segment pointer */</span><span class="cp"></span>
<span class="cp">#define HDMI_EDID_WORD_ADDRESS			0xC5 </span><span class="cm">/* EDID word address */</span><span class="cp"></span>
<span class="cp">#define HDMI_EDID_DATA_FIFO_ADDRESS		0xC6 </span><span class="cm">/* EDID data FIFO address */</span><span class="cp"></span>
<span class="cp">#define HDMI_NUM_OF_HDMI_DEVICES		0xC7 </span><span class="cm">/* Number of HDMI devices */</span><span class="cp"></span>
<span class="cp">#define HDMI_HDCP_ERROR_CODE			0xC8 </span><span class="cm">/* HDCP error code */</span><span class="cp"></span>
<span class="cp">#define HDMI_100MS_TIMER_SET			0xC9 </span><span class="cm">/* 100ms timer setting */</span><span class="cp"></span>
<span class="cp">#define HDMI_5SEC_TIMER_SET			0xCA </span><span class="cm">/* 5sec timer setting */</span><span class="cp"></span>
<span class="cp">#define HDMI_RI_READ_COUNT			0xCB </span><span class="cm">/* Ri read count */</span><span class="cp"></span>
<span class="cp">#define HDMI_AN_SEED				0xCC </span><span class="cm">/* An seed */</span><span class="cp"></span>
<span class="cp">#define HDMI_MAX_NUM_OF_RCIVRS_ALLOWED		0xCD </span><span class="cm">/* Maximum number of receivers allowed */</span><span class="cp"></span>
<span class="cp">#define HDMI_HDCP_MEMORY_ACCESS_CONTROL_1	0xCE </span><span class="cm">/* HDCP memory access control.1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HDCP_MEMORY_ACCESS_CONTROL_2	0xCF </span><span class="cm">/* HDCP memory access control.2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HDCP_CONTROL_2			0xD0 </span><span class="cm">/* HDCP Control 2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HDCP_KEY_MEMORY_CONTROL		0xD2 </span><span class="cm">/* HDCP Key Memory Control */</span><span class="cp"></span>
<span class="cp">#define HDMI_COLOR_SPACE_CONV_CONFIG_1		0xD3 </span><span class="cm">/* Color space conversion configuration.1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_VIDEO_SETTING_3			0xD4 </span><span class="cm">/* Video setting.3 */</span><span class="cp"></span>
<span class="cp">#define HDMI_RI_7_0				0xD5 </span><span class="cm">/* Ri[7:0] */</span><span class="cp"></span>
<span class="cp">#define HDMI_RI_15_8				0xD6 </span><span class="cm">/* Ri[15:8] */</span><span class="cp"></span>
<span class="cp">#define HDMI_PJ					0xD7 </span><span class="cm">/* Pj */</span><span class="cp"></span>
<span class="cp">#define HDMI_SHA_RD				0xD8 </span><span class="cm">/* sha_rd */</span><span class="cp"></span>
<span class="cp">#define HDMI_RI_7_0_SAVED			0xD9 </span><span class="cm">/* Ri[7:0] saved */</span><span class="cp"></span>
<span class="cp">#define HDMI_RI_15_8_SAVED			0xDA </span><span class="cm">/* Ri[15:8] saved */</span><span class="cp"></span>
<span class="cp">#define HDMI_PJ_SAVED				0xDB </span><span class="cm">/* Pj saved */</span><span class="cp"></span>
<span class="cp">#define HDMI_NUM_OF_DEVICES			0xDC </span><span class="cm">/* Number of devices */</span><span class="cp"></span>
<span class="cp">#define HDMI_HOT_PLUG_MSENS_STATUS		0xDF </span><span class="cm">/* Hot plug/MSENS status */</span><span class="cp"></span>
<span class="cp">#define HDMI_BCAPS_WRITE			0xE0 </span><span class="cm">/* bcaps */</span><span class="cp"></span>
<span class="cp">#define HDMI_BSTAT_7_0				0xE1 </span><span class="cm">/* bstat[7:0] */</span><span class="cp"></span>
<span class="cp">#define HDMI_BSTAT_15_8				0xE2 </span><span class="cm">/* bstat[15:8] */</span><span class="cp"></span>
<span class="cp">#define HDMI_BKSV_7_0				0xE3 </span><span class="cm">/* bksv[7:0] */</span><span class="cp"></span>
<span class="cp">#define HDMI_BKSV_15_8				0xE4 </span><span class="cm">/* bksv[15:8] */</span><span class="cp"></span>
<span class="cp">#define HDMI_BKSV_23_16				0xE5 </span><span class="cm">/* bksv[23:16] */</span><span class="cp"></span>
<span class="cp">#define HDMI_BKSV_31_24				0xE6 </span><span class="cm">/* bksv[31:24] */</span><span class="cp"></span>
<span class="cp">#define HDMI_BKSV_39_32				0xE7 </span><span class="cm">/* bksv[39:32] */</span><span class="cp"></span>
<span class="cp">#define HDMI_AN_7_0				0xE8 </span><span class="cm">/* An[7:0] */</span><span class="cp"></span>
<span class="cp">#define HDMI_AN_15_8				0xE9 </span><span class="cm">/* An [15:8] */</span><span class="cp"></span>
<span class="cp">#define HDMI_AN_23_16				0xEA </span><span class="cm">/* An [23:16] */</span><span class="cp"></span>
<span class="cp">#define HDMI_AN_31_24				0xEB </span><span class="cm">/* An [31:24] */</span><span class="cp"></span>
<span class="cp">#define HDMI_AN_39_32				0xEC </span><span class="cm">/* An [39:32] */</span><span class="cp"></span>
<span class="cp">#define HDMI_AN_47_40				0xED </span><span class="cm">/* An [47:40] */</span><span class="cp"></span>
<span class="cp">#define HDMI_AN_55_48				0xEE </span><span class="cm">/* An [55:48] */</span><span class="cp"></span>
<span class="cp">#define HDMI_AN_63_56				0xEF </span><span class="cm">/* An [63:56] */</span><span class="cp"></span>
<span class="cp">#define HDMI_PRODUCT_ID				0xF0 </span><span class="cm">/* Product ID */</span><span class="cp"></span>
<span class="cp">#define HDMI_REVISION_ID			0xF1 </span><span class="cm">/* Revision ID */</span><span class="cp"></span>
<span class="cp">#define HDMI_TEST_MODE				0xFE </span><span class="cm">/* Test mode */</span><span class="cp"></span>

<span class="cm">/* HDMI Control Register (HTOP1) */</span>
<span class="cp">#define HDMI_HTOP1_TEST_MODE			0x0000 </span><span class="cm">/* Test mode */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_VIDEO_INPUT			0x0008 </span><span class="cm">/* VideoInput */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_CORE_RSTN			0x000C </span><span class="cm">/* CoreResetn */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_PLLBW			0x0018 </span><span class="cm">/* PLLBW */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_CLK_TO_PHY			0x001C </span><span class="cm">/* Clk to Phy */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_VIDEO_INPUT2			0x0020 </span><span class="cm">/* VideoInput2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_TISEMP0_1			0x0024 </span><span class="cm">/* tisemp0-1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_TISEMP2_C			0x0028 </span><span class="cm">/* tisemp2-c */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_TISIDRV			0x002C </span><span class="cm">/* tisidrv */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_TISEN			0x0034 </span><span class="cm">/* tisen */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_TISDREN			0x0038 </span><span class="cm">/* tisdren  */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_CISRANGE			0x003C </span><span class="cm">/* cisrange  */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_ENABLE_SELECTOR		0x0040 </span><span class="cm">/* Enable Selector */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_MACRO_RESET			0x0044 </span><span class="cm">/* Macro reset */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_PLL_CALIBRATION		0x0048 </span><span class="cm">/* PLL calibration */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_RE_CALIBRATION		0x004C </span><span class="cm">/* Re-calibration */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_CURRENT			0x0050 </span><span class="cm">/* Current */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_PLL_LOCK_DETECT		0x0054 </span><span class="cm">/* PLL lock detect */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_PHY_TEST_MODE		0x0058 </span><span class="cm">/* PHY Test Mode */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_CLK_SET			0x0080 </span><span class="cm">/* Clock Set */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_DDC_FAIL_SAFE		0x0084 </span><span class="cm">/* DDC fail safe */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_PRBS				0x0088 </span><span class="cm">/* PRBS */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_EDID_AINC_CONTROL		0x008C </span><span class="cm">/* EDID ainc Control */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_MODE		0x00FC </span><span class="cm">/* Deep Coloer Mode */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FRC_COEF0		0x0100 </span><span class="cm">/* Deep Color:FRC COEF0 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FRC_COEF1		0x0104 </span><span class="cm">/* Deep Color:FRC COEF1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FRC_COEF2		0x0108 </span><span class="cm">/* Deep Color:FRC COEF2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FRC_COEF3		0x010C </span><span class="cm">/* Deep Color:FRC COEF3 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FRC_COEF0_C		0x0110 </span><span class="cm">/* Deep Color:FRC COEF0C */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FRC_COEF1_C		0x0114 </span><span class="cm">/* Deep Color:FRC COEF1C */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FRC_COEF2_C		0x0118 </span><span class="cm">/* Deep Color:FRC COEF2C */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FRC_COEF3_C		0x011C </span><span class="cm">/* Deep Color:FRC COEF3C */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FRC_MODE		0x0120 </span><span class="cm">/* Deep Color:FRC Mode */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_RECT_START1		0x0124 </span><span class="cm">/* Deep Color:Rect Start1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_RECT_SIZE1		0x0128 </span><span class="cm">/* Deep Color:Rect Size1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_RECT_START2		0x012C </span><span class="cm">/* Deep Color:Rect Start2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_RECT_SIZE2		0x0130 </span><span class="cm">/* Deep Color:Rect Size2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_RECT_START3		0x0134 </span><span class="cm">/* Deep Color:Rect Start3 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_RECT_SIZE3		0x0138 </span><span class="cm">/* Deep Color:Rect Size3 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_RECT_START4		0x013C </span><span class="cm">/* Deep Color:Rect Start4 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_RECT_SIZE4		0x0140 </span><span class="cm">/* Deep Color:Rect Size4 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_Y1_1	0x0144 </span><span class="cm">/* Deep Color:Fil Para Y1_1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_Y1_2	0x0148 </span><span class="cm">/* Deep Color:Fil Para Y1_2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_CB1_1	0x014C </span><span class="cm">/* Deep Color:Fil Para CB1_1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_CB1_2	0x0150 </span><span class="cm">/* Deep Color:Fil Para CB1_2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_CR1_1	0x0154 </span><span class="cm">/* Deep Color:Fil Para CR1_1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_CR1_2	0x0158 </span><span class="cm">/* Deep Color:Fil Para CR1_2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_Y2_1	0x015C </span><span class="cm">/* Deep Color:Fil Para Y2_1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_Y2_2	0x0160 </span><span class="cm">/* Deep Color:Fil Para Y2_2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_CB2_1	0x0164 </span><span class="cm">/* Deep Color:Fil Para CB2_1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_CB2_2	0x0168 </span><span class="cm">/* Deep Color:Fil Para CB2_2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_CR2_1	0x016C </span><span class="cm">/* Deep Color:Fil Para CR2_1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_FIL_PARA_CR2_2	0x0170 </span><span class="cm">/* Deep Color:Fil Para CR2_2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_COR_PARA_Y1		0x0174 </span><span class="cm">/* Deep Color:Cor Para Y1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_COR_PARA_CB1	0x0178 </span><span class="cm">/* Deep Color:Cor Para CB1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_COR_PARA_CR1	0x017C </span><span class="cm">/* Deep Color:Cor Para CR1 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_COR_PARA_Y2		0x0180 </span><span class="cm">/* Deep Color:Cor Para Y2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_COR_PARA_CB2	0x0184 </span><span class="cm">/* Deep Color:Cor Para CB2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_HTOP_DCL_COR_PARA_CR2	0x0188 </span><span class="cm">/* Deep Color:Cor Para CR2 */</span><span class="cp"></span>
<span class="cp">#define HDMI_HTOP1_EDID_DATA_READ		0x0200 </span><span class="cm">/* EDID Data Read 128Byte:0x03FC */</span><span class="cp"></span>

<span class="k">enum</span> <span class="n">hotplug_state</span> <span class="p">{</span>
	<span class="n">HDMI_HOTPLUG_DISCONNECTED</span><span class="p">,</span>
	<span class="n">HDMI_HOTPLUG_CONNECTED</span><span class="p">,</span>
	<span class="n">HDMI_HOTPLUG_EDID_DONE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mobile_lcdc_entity</span> <span class="n">entity</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">htop1</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">hotplug_state</span> <span class="n">hp_state</span><span class="p">;</span>	<span class="cm">/* hot-plug status */</span>
	<span class="n">u8</span> <span class="n">preprogrammed_vic</span><span class="p">;</span>		<span class="cm">/* use a pre-programmed VIC or</span>
<span class="cm">					   the external mode */</span>
	<span class="n">u8</span> <span class="n">edid_block_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">edid_segment_nr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">edid_blocks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">hdmi_clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">edid_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="n">monspec</span><span class="p">;</span>

	<span class="cm">/* register access functions */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">u8</span> <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#define entity_to_sh_hdmi(e)	container_of(e, struct sh_hdmi, entity)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__hdmi_write8</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">__hdmi_read8</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__hdmi_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">__hdmi_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ioread32</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">hdmi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_bit_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="n">hdmi_read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdmi_htop1_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">htop1</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">hdmi_htop1_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">htop1</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	HDMI sound</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sh_hdmi_snd_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hdmi_read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_hdmi_snd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">sh_hdmi_dai</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sh_mobile_hdmi-hifi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;Playback&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_32000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_44100</span>  <span class="o">|</span>
			 <span class="n">SNDRV_PCM_RATE_48000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_88200</span>  <span class="o">|</span>
			 <span class="n">SNDRV_PCM_RATE_96000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_176400</span> <span class="o">|</span>
			 <span class="n">SNDRV_PCM_RATE_192000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S24_LE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_hdmi_snd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SH Mobile HDMI Audio Codec&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_codec_driver</span> <span class="n">soc_codec_dev_sh_hdmi</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sh_hdmi_snd_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">sh_hdmi_snd_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">sh_hdmi_snd_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	HDMI video</span>
<span class="cm"> */</span>

<span class="cm">/* External video parameter settings */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_hdmi_external_video_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">hblank</span><span class="p">,</span> <span class="n">hdelay</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">,</span> <span class="n">vblank</span><span class="p">,</span> <span class="n">vdelay</span><span class="p">,</span> <span class="n">voffset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">htotal</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">left_margin</span>
	       <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">hdelay</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">hblank</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">hdelay</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Vertical timing looks a bit different in Figure 18,</span>
<span class="cm">	 * but let&#39;s try the same first by setting offset = 0</span>
<span class="cm">	 */</span>
	<span class="n">vtotal</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span>
	       <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">vdelay</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">vblank</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">vdelay</span><span class="p">;</span>
	<span class="n">voffset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6U</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * [3]: VSYNC polarity: Positive</span>
<span class="cm">	 * [2]: HSYNC polarity: Positive</span>
<span class="cm">	 * [1]: Interlace/Progressive: Progressive</span>
<span class="cm">	 * [0]: External video settings enable: used.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
		<span class="n">sync</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
		<span class="n">sync</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;H: %u, %u, %u, %u; V: %u, %u, %u, %u; sync 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">htotal</span><span class="p">,</span> <span class="n">hblank</span><span class="p">,</span> <span class="n">hdelay</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">,</span>
		<span class="n">vtotal</span><span class="p">,</span> <span class="n">vblank</span><span class="p">,</span> <span class="n">vdelay</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">,</span> <span class="n">sync</span><span class="p">);</span>

	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">sync</span> <span class="o">|</span> <span class="p">(</span><span class="n">voffset</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">HDMI_EXTERNAL_VIDEO_PARAM_SETTINGS</span><span class="p">);</span>

	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_H_TOTAL_7_0</span><span class="p">);</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">htotal</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_H_TOTAL_11_8</span><span class="p">);</span>

	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">hblank</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_H_BLANK_7_0</span><span class="p">);</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">hblank</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_H_BLANK_9_8</span><span class="p">);</span>

	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">hdelay</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_H_DELAY_7_0</span><span class="p">);</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">hdelay</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_H_DELAY_9_8</span><span class="p">);</span>

	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_H_DURATION_7_0</span><span class="p">);</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_H_DURATION_9_8</span><span class="p">);</span>

	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_V_TOTAL_7_0</span><span class="p">);</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">vtotal</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_V_TOTAL_9_8</span><span class="p">);</span>

	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">vblank</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_V_BLANK</span><span class="p">);</span>

	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">vdelay</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_V_DELAY</span><span class="p">);</span>

	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">,</span> <span class="n">HDMI_EXTERNAL_V_DURATION</span><span class="p">);</span>

	<span class="cm">/* Set bit 0 of HDMI_EXTERNAL_VIDEO_PARAM_SETTINGS here for external mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span><span class="p">)</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">sync</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="n">voffset</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
			   <span class="n">HDMI_EXTERNAL_VIDEO_PARAM_SETTINGS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sh_hdmi_video_config()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_hdmi_video_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * [7:4]: Audio sampling frequency: 48kHz</span>
<span class="cm">	 * [3:1]: Input video format: RGB and YCbCr 4:4:4 (Y on Green)</span>
<span class="cm">	 * [0]: Internal/External DE select: internal</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">HDMI_AUDIO_VIDEO_SETTING_1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * [7:6]: Video output format: RGB 4:4:4</span>
<span class="cm">	 * [5:4]: Input video data width: 8 bit</span>
<span class="cm">	 * [3:1]: EAV/SAV location: channel 1</span>
<span class="cm">	 * [0]: Video input color space: RGB</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">HDMI_VIDEO_SETTING_1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * [7:6]: Together with bit [6] of HDMI_AUDIO_VIDEO_SETTING_2, which is</span>
<span class="cm">	 * left at 0 by default, this configures 24bpp and sets the Color Depth</span>
<span class="cm">	 * (CD) field in the General Control Packet</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">HDMI_DEEP_COLOR_MODES</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sh_hdmi_audio_config()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_hdmi_audio_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_mobile_hdmi_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * [7:4] L/R data swap control</span>
<span class="cm">	 * [3:0] appropriate N[19:16]</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_L_R_DATA_SWAP_CTRL_RPKT</span><span class="p">);</span>
	<span class="cm">/* appropriate N[15:8] */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">HDMI_20_BIT_N_FOR_AUDIO_RPKT_15_8</span><span class="p">);</span>
	<span class="cm">/* appropriate N[7:0] */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_20_BIT_N_FOR_AUDIO_RPKT_7_0</span><span class="p">);</span>

	<span class="cm">/* [7:4] 48 kHz	SPDIF not used */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">HDMI_SPDIF_AUDIO_SAMP_FREQ_CTS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * [6:5] set required down sampling rate if required</span>
<span class="cm">	 * [4:3] set required audio source</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDMI_SND_SRC_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">HDMI_SND_SRC_I2S</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDMI_SND_SRC_SPDIF</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDMI_SND_SRC_DSD</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDMI_SND_SRC_HBR</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">HDMI_AUDIO_SETTING_1</span><span class="p">);</span>

	<span class="cm">/* [3:0] set sending channel number for channel status */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">HDMI_AUDIO_SETTING_2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * [5:2] set valid I2S source input pin</span>
<span class="cm">	 * [1:0] set input I2S source mode</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">HDMI_I2S_AUDIO_SET</span><span class="p">);</span>

	<span class="cm">/* [7:4] set valid DSD source input pin */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_DSD_AUDIO_SET</span><span class="p">);</span>

	<span class="cm">/* [7:0] set appropriate I2S input pin swap settings if required */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_I2S_INPUT_PIN_SWAP</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * [7] set validity bit for channel status</span>
<span class="cm">	 * [3:0] set original sample frequency for channel status</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_AUDIO_STATUS_BITS_SETTING_1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * [7] set value for channel status</span>
<span class="cm">	 * [6] set value for channel status</span>
<span class="cm">	 * [5] set copyright bit for channel status</span>
<span class="cm">	 * [4:2] set additional information for channel status</span>
<span class="cm">	 * [1:0] set clock accuracy for channel status</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_AUDIO_STATUS_BITS_SETTING_2</span><span class="p">);</span>

	<span class="cm">/* [7:0] set category code for channel status */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CATEGORY_CODE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * [7:4] set source number for channel status</span>
<span class="cm">	 * [3:0] set word length for channel status</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_SOURCE_NUM_AUDIO_WORD_LEN</span><span class="p">);</span>

	<span class="cm">/* [7:4] set sample frequency for channel status */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">HDMI_AUDIO_VIDEO_SETTING_1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sh_hdmi_phy_config() - configure the HDMI PHY for the used video mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_hdmi_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for 1080p8bit 148MHz */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_1</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_2</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_3</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_5</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_6</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_7</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_8</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_9</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">&lt;</span> <span class="mi">30000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 720p, 8bit, 74.25MHz. Might need to be adjusted for other formats */</span>
		<span class="cm">/*</span>
<span class="cm">		 * [1:0]	Speed_A</span>
<span class="cm">		 * [3:2]	Speed_B</span>
<span class="cm">		 * [4]		PLLA_Bypass</span>
<span class="cm">		 * [6]		DRV_TEST_EN</span>
<span class="cm">		 * [7]		DRV_TEST_IN</span>
<span class="cm">		 */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_1</span><span class="p">);</span>
		<span class="cm">/* PLLB_CONFIG[17], PLLA_CONFIG[17] - not in PHY datasheet */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * [2:0]	BGR_I_OFFSET</span>
<span class="cm">		 * [6:4]	BGR_V_OFFSET</span>
<span class="cm">		 */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_3</span><span class="p">);</span>
		<span class="cm">/* PLLA_CONFIG[7:0]: VCO gain, VCO offset, LPF resistance[0] */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_5</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * PLLA_CONFIG[15:8]: regulator voltage[0], CP current,</span>
<span class="cm">		 * LPF capacitance, LPF resistance[1]</span>
<span class="cm">		 */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_6</span><span class="p">);</span>
		<span class="cm">/* PLLB_CONFIG[7:0]: LPF resistance[0], VCO offset, VCO gain */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_7</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * PLLB_CONFIG[15:8]: regulator voltage[0], CP current,</span>
<span class="cm">		 * LPF capacitance, LPF resistance[1]</span>
<span class="cm">		 */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_8</span><span class="p">);</span>
		<span class="cm">/* DRV_CONFIG, PE_CONFIG */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_9</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * [2:0]	AMON_SEL (4 == LPF voltage)</span>
<span class="cm">		 * [4]		PLLA_CONFIG[16]</span>
<span class="cm">		 * [5]		PLLB_CONFIG[16]</span>
<span class="cm">		 */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* for 480p8bit 27MHz */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_1</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_2</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_3</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_5</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_6</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_7</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_8</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_9</span><span class="p">);</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">HDMI_SLIPHDMIT_PARAM_SETTINGS_10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sh_hdmi_avi_infoframe_setup() - Auxiliary Video Information InfoFrame CONTROL PACKET</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_hdmi_avi_infoframe_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">vic</span><span class="p">;</span>

	<span class="cm">/* AVI InfoFrame */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_INDEX</span><span class="p">);</span>

	<span class="cm">/* Packet Type = 0x82 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_HB0</span><span class="p">);</span>

	<span class="cm">/* Version = 0x02 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_HB1</span><span class="p">);</span>

	<span class="cm">/* Length = 13 (0x0D) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_HB2</span><span class="p">);</span>

	<span class="cm">/* N. A. Checksum */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Y = RGB</span>
<span class="cm">	 * A0 = No Data</span>
<span class="cm">	 * B = Bar Data not valid</span>
<span class="cm">	 * S = No Data</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * [7:6] C = Colorimetry: no data</span>
<span class="cm">	 * [5:4] M = 2: 16:9, 1: 4:3 Picture Aspect Ratio</span>
<span class="cm">	 * [3:0] R = 8: Active Frame Aspect Ratio: same as picture aspect ratio</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ITC = No Data</span>
<span class="cm">	 * EC = xvYCC601</span>
<span class="cm">	 * Q = Default (depends on video format)</span>
<span class="cm">	 * SC = No Known non_uniform Scaling</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB3</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * VIC should be ignored if external config is used, so, we could just use 0,</span>
<span class="cm">	 * but play safe and use a valid value in any case just in case</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span><span class="p">)</span>
		<span class="n">vic</span> <span class="o">=</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vic</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">vic</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB4</span><span class="p">);</span>

	<span class="cm">/* PR = No Repetition */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB5</span><span class="p">);</span>

	<span class="cm">/* Line Number of End of Top Bar (lower 8 bits) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB6</span><span class="p">);</span>

	<span class="cm">/* Line Number of End of Top Bar (upper 8 bits) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB7</span><span class="p">);</span>

	<span class="cm">/* Line Number of Start of Bottom Bar (lower 8 bits) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB8</span><span class="p">);</span>

	<span class="cm">/* Line Number of Start of Bottom Bar (upper 8 bits) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB9</span><span class="p">);</span>

	<span class="cm">/* Pixel Number of End of Left Bar (lower 8 bits) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB10</span><span class="p">);</span>

	<span class="cm">/* Pixel Number of End of Left Bar (upper 8 bits) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB11</span><span class="p">);</span>

	<span class="cm">/* Pixel Number of Start of Right Bar (lower 8 bits) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB12</span><span class="p">);</span>

	<span class="cm">/* Pixel Number of Start of Right Bar (upper 8 bits) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB13</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sh_hdmi_audio_infoframe_setup() - Audio InfoFrame of CONTROL PACKET</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_hdmi_audio_infoframe_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Audio InfoFrame */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_INDEX</span><span class="p">);</span>

	<span class="cm">/* Packet Type = 0x84 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_HB0</span><span class="p">);</span>

	<span class="cm">/* Version Number = 0x01 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_HB1</span><span class="p">);</span>

	<span class="cm">/* 0 Length = 10 (0x0A) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_HB2</span><span class="p">);</span>

	<span class="cm">/* n. a. Checksum */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB0</span><span class="p">);</span>

	<span class="cm">/* Audio Channel Count = Refer to Stream Header */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB1</span><span class="p">);</span>

	<span class="cm">/* Refer to Stream Header */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB2</span><span class="p">);</span>

	<span class="cm">/* Format depends on coding type (i.e. CT0...CT3) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB3</span><span class="p">);</span>

	<span class="cm">/* Speaker Channel Allocation = Front Right + Front Left */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB4</span><span class="p">);</span>

	<span class="cm">/* Level Shift Value = 0 dB, Down - mix is permitted or no information */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB5</span><span class="p">);</span>

	<span class="cm">/* Reserved (0) */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB6</span><span class="p">);</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB7</span><span class="p">);</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB8</span><span class="p">);</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB9</span><span class="p">);</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_BUF_ACCESS_PB10</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sh_hdmi_configure() - Initialise HDMI for output</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_hdmi_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Configure video format */</span>
	<span class="n">sh_hdmi_video_config</span><span class="p">(</span><span class="n">hdmi</span><span class="p">);</span>

	<span class="cm">/* Configure audio format */</span>
	<span class="n">sh_hdmi_audio_config</span><span class="p">(</span><span class="n">hdmi</span><span class="p">);</span>

	<span class="cm">/* Configure PHY */</span>
	<span class="n">sh_hdmi_phy_config</span><span class="p">(</span><span class="n">hdmi</span><span class="p">);</span>

	<span class="cm">/* Auxiliary Video Information (AVI) InfoFrame */</span>
	<span class="n">sh_hdmi_avi_infoframe_setup</span><span class="p">(</span><span class="n">hdmi</span><span class="p">);</span>

	<span class="cm">/* Audio InfoFrame */</span>
	<span class="n">sh_hdmi_audio_infoframe_setup</span><span class="p">(</span><span class="n">hdmi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Control packet auto send with VSYNC control: auto send</span>
<span class="cm">	 * General control, Gamut metadata, ISRC, and ACP packets</span>
<span class="cm">	 */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="n">HDMI_CTRL_PKT_AUTO_SEND</span><span class="p">);</span>

	<span class="cm">/* FIXME */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* PS mode b-&gt;d, reset PLLA and PLLB */</span>
	<span class="n">hdmi_bit_set</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="n">HDMI_SYSTEM_CTRL</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">hdmi_bit_set</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">HDMI_SYSTEM_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sh_hdmi_rate_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">hdmi_rate</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">parent_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">target</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">rate_error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_mobile_hdmi_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="o">*</span><span class="n">hdmi_rate</span> <span class="o">=</span> <span class="n">clk_round_rate</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">hdmi_rate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hdmi_rate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">);</span>

	<span class="n">rate_error</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">hdmi_rate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">abs</span><span class="p">(</span><span class="o">*</span><span class="n">hdmi_rate</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">:</span> <span class="n">ULONG_MAX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_error</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_optimize_parent</span><span class="p">)</span>
		<span class="n">rate_error</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_optimize_parent</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">hdmi_rate</span><span class="p">,</span> <span class="n">parent_rate</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clk_get_parent</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">))</span>
		<span class="o">*</span><span class="n">parent_rate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">clk_get_parent</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%u-%u-%u-%u x %u-%u-%u-%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">,</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">@%lu(+/-%lu)Hz, e=%lu / 1000, r=%uHz, p=%luHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
		<span class="n">rate_error</span><span class="p">,</span> <span class="n">rate_error</span> <span class="o">?</span> <span class="mi">10000</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">target</span> <span class="o">/</span> <span class="n">rate_error</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">refresh</span><span class="p">,</span> <span class="o">*</span><span class="n">parent_rate</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rate_error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_hdmi_read_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">hdmi_rate</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">parent_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mobile_lcdc_chan</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">lcdc</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="o">*</span><span class="n">found</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">f_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">f_height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">f_refresh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">found_rate_error</span> <span class="o">=</span> <span class="n">ULONG_MAX</span><span class="p">;</span> <span class="cm">/* silly compiler... */</span>
	<span class="n">bool</span> <span class="n">scanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">preferred_bad</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">use_edid_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">edid</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">forced</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Read EDID */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Read back EDID code:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">htop1</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">hdmi_htop1_read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">HDMI_HTOP1_EDID_DATA_READ</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">:</span>
			<span class="n">hdmi_read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">HDMI_EDID_KSV_FIFO_ACCESS_WINDOW</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%02X | %02X&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">edid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %02X&quot;</span><span class="p">,</span> <span class="n">edid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_edid_to_monspecs</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">monspec</span><span class="p">);</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_blocks</span> <span class="o">=</span> <span class="n">edid</span><span class="p">[</span><span class="mi">126</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d main modes, %d extension blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">monspec</span><span class="p">.</span><span class="n">modedb_len</span><span class="p">,</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_blocks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Extension %u detected, DTD start %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">edid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edid</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">fb_edid_add_monspecs</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">monspec</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_blocks</span> <span class="o">&gt;</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_segment_nr</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
	    <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_block_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* More blocks to read */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_block_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_block_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_segment_nr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_block_addr</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Set EDID word address  */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_block_addr</span><span class="p">,</span> <span class="n">HDMI_EDID_WORD_ADDRESS</span><span class="p">);</span>
		<span class="cm">/* Enable EDID interrupt */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="n">HDMI_INTERRUPT_MASK_1</span><span class="p">);</span>
		<span class="cm">/* Set EDID segment pointer - starts reading EDID */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_segment_nr</span><span class="p">,</span> <span class="n">HDMI_EDID_SEGMENT_POINTER</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* All E-EDID blocks ready */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d main and extended modes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">monspec</span><span class="p">.</span><span class="n">modedb_len</span><span class="p">);</span>

	<span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;sh_mobile_lcdc&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">forced</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">forced</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">forced</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Only primitive parsing so far */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">forced</span><span class="p">,</span> <span class="s">&quot;%ux%u@%u&quot;</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">f_width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_height</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_refresh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">f_height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The user wants us to use the EDID data */</span>
			<span class="n">scanning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Forced mode %ux%u@%uHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">f_width</span><span class="p">,</span> <span class="n">f_height</span><span class="p">,</span> <span class="n">f_refresh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Walk monitor modes to find the best or the exact match */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">monspec</span><span class="p">.</span><span class="n">modedb</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">monspec</span><span class="p">.</span><span class="n">modedb_len</span> <span class="o">&amp;&amp;</span> <span class="n">scanning</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mode</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate_error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f_width</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">f_height</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * A parameter string &quot;video=sh_mobile_lcdc:0x0&quot; means</span>
<span class="cm">			 * use the preferred EDID mode. If it is rejected by</span>
<span class="cm">			 * .fb_check_var(), keep looking, until an acceptable</span>
<span class="cm">			 * one is found.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">FB_MODE_IS_FIRST</span><span class="p">)</span> <span class="o">||</span> <span class="n">preferred_bad</span><span class="p">)</span>
				<span class="n">scanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f_width</span> <span class="o">!=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">||</span> <span class="n">f_height</span> <span class="o">!=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No interest in unmatching modes */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rate_error</span> <span class="o">=</span> <span class="n">sh_hdmi_rate_error</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">hdmi_rate</span><span class="p">,</span> <span class="n">parent_rate</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scanning</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f_refresh</span> <span class="o">==</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">f_refresh</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rate_error</span><span class="p">))</span>
				<span class="cm">/*</span>
<span class="cm">				 * Exact match if either the refresh rate</span>
<span class="cm">				 * matches or it hasn&#39;t been specified and we&#39;ve</span>
<span class="cm">				 * found a mode, for which we can configure the</span>
<span class="cm">				 * clock precisely</span>
<span class="cm">				 */</span>
				<span class="n">scanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&amp;&amp;</span> <span class="n">found_rate_error</span> <span class="o">&lt;=</span> <span class="n">rate_error</span><span class="p">)</span>
				<span class="cm">/*</span>
<span class="cm">				 * We otherwise search for the closest matching</span>
<span class="cm">				 * clock rate - either if no refresh rate has</span>
<span class="cm">				 * been specified or we cannot find an exactly</span>
<span class="cm">				 * matching one</span>
<span class="cm">				 */</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check if supported: sufficient fb memory, supported clock-rate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">notify</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">SH_MOBILE_LCDC_EVENT_DISPLAY_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
			       <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">scanning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">preferred_bad</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">found</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">found_rate_error</span> <span class="o">=</span> <span class="n">rate_error</span><span class="p">;</span>
		<span class="n">use_edid_mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO 1: if no default mode is present, postpone running the config</span>
<span class="cm">	 * until after the LCDC channel is initialized.</span>
<span class="cm">	 * TODO 2: consider registering the HDMI platform device from the LCDC</span>
<span class="cm">	 * driver.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span> <span class="o">&amp;&amp;</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">def_mode</span><span class="p">.</span><span class="n">xres</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">found</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">def_mode</span><span class="p">;</span>
		<span class="n">found_rate_error</span> <span class="o">=</span> <span class="n">sh_hdmi_rate_error</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">hdmi_rate</span><span class="p">,</span>
						      <span class="n">parent_rate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* No cookie today */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">640</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">480</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">==</span> <span class="mi">60</span><span class="p">)</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">720</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">480</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">==</span> <span class="mi">60</span><span class="p">)</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">720</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">576</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">1280</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">720</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">==</span> <span class="mi">60</span><span class="p">)</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">1920</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">1080</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">1920</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">1080</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="mi">1920</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">==</span> <span class="mi">1080</span> <span class="o">&amp;&amp;</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">==</span> <span class="mi">60</span><span class="p">)</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Using %s %s mode %ux%u@%uHz (%luHz), &quot;</span>
		<span class="s">&quot;clock error %luHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">use_edid_mode</span> <span class="o">?</span> <span class="s">&quot;EDID&quot;</span> <span class="o">:</span> <span class="s">&quot;default&quot;</span><span class="p">,</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">preprogrammed_vic</span> <span class="o">?</span> <span class="s">&quot;VIC&quot;</span> <span class="o">:</span> <span class="s">&quot;external&quot;</span><span class="p">,</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span>
		<span class="n">found</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">found</span><span class="o">-&gt;</span><span class="n">refresh</span><span class="p">,</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
		<span class="n">found_rate_error</span><span class="p">);</span>

	<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="o">*</span><span class="n">found</span><span class="p">;</span>
	<span class="n">sh_hdmi_external_video_param</span><span class="p">(</span><span class="n">hdmi</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sh_hdmi_hotplug</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status1</span><span class="p">,</span> <span class="n">status2</span><span class="p">,</span> <span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">;</span>

	<span class="cm">/* mode_b and PLLA and PLLB reset */</span>
	<span class="n">hdmi_bit_set</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="n">HDMI_SYSTEM_CTRL</span><span class="p">);</span>

	<span class="cm">/* How long shall reset be held? */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* mode_b and PLLA and PLLB reset release */</span>
	<span class="n">hdmi_bit_set</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">HDMI_SYSTEM_CTRL</span><span class="p">);</span>

	<span class="n">status1</span> <span class="o">=</span> <span class="n">hdmi_read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">HDMI_INTERRUPT_STATUS_1</span><span class="p">);</span>
	<span class="n">status2</span> <span class="o">=</span> <span class="n">hdmi_read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">HDMI_INTERRUPT_STATUS_2</span><span class="p">);</span>

	<span class="n">mask1</span> <span class="o">=</span> <span class="n">hdmi_read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">HDMI_INTERRUPT_MASK_1</span><span class="p">);</span>
	<span class="n">mask2</span> <span class="o">=</span> <span class="n">hdmi_read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">HDMI_INTERRUPT_MASK_2</span><span class="p">);</span>

	<span class="cm">/* Correct would be to ack only set bits, but the datasheet requires 0xff */</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">HDMI_INTERRUPT_STATUS_1</span><span class="p">);</span>
	<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">HDMI_INTERRUPT_STATUS_2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ #%d: Status #1: 0x%x &amp; 0x%x, #2: 0x%x &amp; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">irq</span><span class="p">,</span> <span class="n">status1</span><span class="p">,</span> <span class="n">mask1</span><span class="p">,</span> <span class="n">status2</span><span class="p">,</span> <span class="n">mask2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">mask1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">mask2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">msens</span><span class="p">;</span>

		<span class="cm">/* Datasheet specifies 10ms... */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

		<span class="n">msens</span> <span class="o">=</span> <span class="n">hdmi_read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">HDMI_HOT_PLUG_MSENS_STATUS</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MSENS 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msens</span><span class="p">);</span>
		<span class="cm">/* Check, if hot plug &amp; MSENS pin status are both high */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">msens</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Display plug in */</span>
			<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_segment_nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_block_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hp_state</span> <span class="o">=</span> <span class="n">HDMI_HOTPLUG_CONNECTED</span><span class="p">;</span>

			<span class="cm">/* Set EDID word address  */</span>
			<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_EDID_WORD_ADDRESS</span><span class="p">);</span>
			<span class="cm">/* Enable EDID interrupt */</span>
			<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="n">HDMI_INTERRUPT_MASK_1</span><span class="p">);</span>
			<span class="cm">/* Set EDID segment pointer - starts reading EDID */</span>
			<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">HDMI_EDID_SEGMENT_POINTER</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Display unplug, beware multiple interrupts */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hp_state</span> <span class="o">!=</span> <span class="n">HDMI_HOTPLUG_DISCONNECTED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hp_state</span> <span class="o">=</span> <span class="n">HDMI_HOTPLUG_DISCONNECTED</span><span class="p">;</span>
				<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* display_off will switch back to mode_a */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* EDID error interrupt: retry */</span>
		<span class="cm">/* Set EDID word address  */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_block_addr</span><span class="p">,</span> <span class="n">HDMI_EDID_WORD_ADDRESS</span><span class="p">);</span>
		<span class="cm">/* Set EDID segment pointer */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_segment_nr</span><span class="p">,</span> <span class="n">HDMI_EDID_SEGMENT_POINTER</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable EDID interrupt */</span>
		<span class="n">hdmi_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="n">HDMI_INTERRUPT_MASK_1</span><span class="p">);</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_hdmi_display_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_lcdc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span> <span class="o">=</span> <span class="n">entity_to_sh_hdmi</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(%p): state %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hdmi</span><span class="p">,</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hp_state</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * hp_state can be set to</span>
<span class="cm">	 * HDMI_HOTPLUG_DISCONNECTED:	on monitor unplug</span>
<span class="cm">	 * HDMI_HOTPLUG_CONNECTED:	on monitor plug-in</span>
<span class="cm">	 * HDMI_HOTPLUG_EDID_DONE:	on EDID read completion</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hp_state</span> <span class="o">==</span> <span class="n">HDMI_HOTPLUG_EDID_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PS mode d-&gt;e. All functions are active */</span>
		<span class="n">hdmi_bit_set</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">HDMI_SYSTEM_CTRL</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HDMI running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hp_state</span> <span class="o">==</span> <span class="n">HDMI_HOTPLUG_DISCONNECTED</span>
		<span class="o">?</span> <span class="n">SH_MOBILE_LCDC_DISPLAY_DISCONNECTED</span>
		<span class="o">:</span> <span class="n">SH_MOBILE_LCDC_DISPLAY_CONNECTED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_hdmi_display_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_lcdc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span> <span class="o">=</span> <span class="n">entity_to_sh_hdmi</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hdmi</span><span class="p">);</span>
	<span class="cm">/* PS mode e-&gt;a */</span>
	<span class="n">hdmi_bit_set</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">HDMI_SYSTEM_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sh_mobile_lcdc_entity_ops</span> <span class="n">sh_hdmi_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">display_on</span> <span class="o">=</span> <span class="n">sh_hdmi_display_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">display_off</span> <span class="o">=</span> <span class="n">sh_hdmi_display_off</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * sh_hdmi_clk_configure() - set HDMI clock frequency and enable the clock</span>
<span class="cm"> * @hdmi:		driver context</span>
<span class="cm"> * @hdmi_rate:		HDMI clock frequency in Hz</span>
<span class="cm"> * @parent_rate:	if != 0 - set parent clock rate for optimal precision</span>
<span class="cm"> * return:		configured positive rate if successful</span>
<span class="cm"> *			0 if couldn&#39;t set the rate, but managed to enable the</span>
<span class="cm"> *			clock, negative error, if couldn&#39;t enable the clock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">sh_hdmi_clk_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hdmi_rate</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parent_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent_rate</span> <span class="o">&amp;&amp;</span> <span class="n">clk_get_parent</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_set_rate</span><span class="p">(</span><span class="n">clk_get_parent</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">),</span> <span class="n">parent_rate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot set parent rate %ld: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">parent_rate</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">hdmi_rate</span> <span class="o">=</span> <span class="n">clk_round_rate</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">,</span> <span class="n">hdmi_rate</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HDMI set parent frequency %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">parent_rate</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_set_rate</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">,</span> <span class="n">hdmi_rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot set rate %ld: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdmi_rate</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">hdmi_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HDMI set frequency %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdmi_rate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hdmi_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Hotplug interrupt occurred, read EDID */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_hdmi_edid_work_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sh_hdmi</span><span class="p">,</span> <span class="n">edid_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mobile_lcdc_chan</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">lcdc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(%p): begin, hotplug status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hdmi</span><span class="p">,</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hp_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hp_state</span> <span class="o">==</span> <span class="n">HDMI_HOTPLUG_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parent_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdmi_rate</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sh_hdmi_read_edid</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdmi_rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent_rate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hp_state</span> <span class="o">=</span> <span class="n">HDMI_HOTPLUG_EDID_DONE</span><span class="p">;</span>

		<span class="cm">/* Reconfigure the clock */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sh_hdmi_clk_configure</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">hdmi_rate</span><span class="p">,</span> <span class="n">parent_rate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">sh_hdmi_configure</span><span class="p">(</span><span class="n">hdmi</span><span class="p">);</span>
		<span class="cm">/* Switched to another (d) power-save mode */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">)</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">SH_MOBILE_LCDC_EVENT_DISPLAY_CONNECT</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">monspec</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">monspec</span><span class="p">.</span><span class="n">modedb_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fb_destroy_modedb</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">monspec</span><span class="p">.</span><span class="n">modedb</span><span class="p">);</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">monspec</span><span class="p">.</span><span class="n">modedb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">)</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">SH_MOBILE_LCDC_EVENT_DISPLAY_DISCONNECT</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hp_state</span> <span class="o">=</span> <span class="n">HDMI_HOTPLUG_DISCONNECTED</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(%p): end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hdmi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_hdmi_htop1_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_MODE</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x0000000b</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00006710</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FRC_MODE</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x01020406</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_Y1_1</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x07080806</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_Y1_2</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x01020406</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_CB1_1</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x07080806</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_CB1_2</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x01020406</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_CR1_1</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x07080806</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_CR1_2</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x01020406</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_Y2_1</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x07080806</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_Y2_2</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x01020406</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_CB2_1</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x07080806</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_CB2_2</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x01020406</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_CR2_1</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x07080806</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_FIL_PARA_CR2_2</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_COR_PARA_Y1</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_COR_PARA_CB1</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_COR_PARA_CR1</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_COR_PARA_Y2</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_COR_PARA_CB2</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_HTOP_DCL_COR_PARA_CR2</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000008</span><span class="p">,</span> <span class="n">HDMI_HTOP1_CURRENT</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_TISEMP0_1</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_TISEMP2_C</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_PHY_TEST_MODE</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000081</span><span class="p">,</span> <span class="n">HDMI_HTOP1_TISIDRV</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_PLLBW</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x0000000f</span><span class="p">,</span> <span class="n">HDMI_HTOP1_TISEN</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x0000000f</span><span class="p">,</span> <span class="n">HDMI_HTOP1_TISDREN</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">,</span> <span class="n">HDMI_HTOP1_ENABLE_SELECTOR</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">,</span> <span class="n">HDMI_HTOP1_MACRO_RESET</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000016</span><span class="p">,</span> <span class="n">HDMI_HTOP1_CISRANGE</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">,</span> <span class="n">HDMI_HTOP1_ENABLE_SELECTOR</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">,</span> <span class="n">HDMI_HTOP1_ENABLE_SELECTOR</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">,</span> <span class="n">HDMI_HTOP1_MACRO_RESET</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x0000000f</span><span class="p">,</span> <span class="n">HDMI_HTOP1_TISEN</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x0000000f</span><span class="p">,</span> <span class="n">HDMI_HTOP1_TISDREN</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_VIDEO_INPUT</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_CLK_TO_PHY</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HDMI_HTOP1_VIDEO_INPUT2</span><span class="p">);</span>
	<span class="n">hdmi_htop1_write</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x0000000a</span><span class="p">,</span> <span class="n">HDMI_HTOP1_CLK_SET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sh_hdmi_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mobile_hdmi_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">htop1_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">||</span> <span class="o">!</span><span class="n">pdata</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">htop1_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDMI_HAS_HTOP1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">htop1_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">htop1_res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;htop1 needs register base</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hdmi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdmi</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdmi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot allocate device data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_hdmi_ops</span><span class="p">;</span>

	<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ick&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to get clock: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">egetclk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* select register access functions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDMI_32BIT_REG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">write</span>	<span class="o">=</span> <span class="n">__hdmi_write32</span><span class="p">;</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">read</span>	<span class="o">=</span> <span class="n">__hdmi_read32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">write</span>	<span class="o">=</span> <span class="n">__hdmi_write8</span><span class="p">;</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">read</span>	<span class="o">=</span> <span class="n">__hdmi_read8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* An arbitrary relaxed pixclock just to get things started: from standard 480p */</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">clk_round_rate</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">,</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="mi">37037</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">sh_hdmi_clk_configure</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">erate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enable clock: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">erate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enabled HDMI clock at %luHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HDMI register region already claimed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ereqreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HDMI register region already claimed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">emap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_work</span><span class="p">,</span> <span class="n">sh_hdmi_edid_work_fn</span><span class="p">);</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* init interrupt polarity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDMI_OUTPUT_PUSH_PULL</span><span class="p">)</span>
		<span class="n">hdmi_bit_set</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">HDMI_SYSTEM_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDMI_OUTPUT_POLARITY_HI</span><span class="p">)</span>
		<span class="n">hdmi_bit_set</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">HDMI_SYSTEM_CTRL</span><span class="p">);</span>

	<span class="cm">/* enable htop1 register if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">htop1_res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">htop1</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">htop1_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">htop1_res</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">htop1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;control register region already claimed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">emap_htop1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sh_hdmi_htop1_init</span><span class="p">(</span><span class="n">hdmi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Product and revision IDs are 0 in sh-mobile version */</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detected HDMI controller 0x%x:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">hdmi_read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">HDMI_PRODUCT_ID</span><span class="p">),</span> <span class="n">hdmi_read</span><span class="p">(</span><span class="n">hdmi</span><span class="p">,</span> <span class="n">HDMI_REVISION_ID</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sh_hdmi_hotplug</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">hdmi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to request irq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ereqirq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_register_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">soc_codec_dev_sh_hdmi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh_hdmi_dai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;codec registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ecodec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">ecodec:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">hdmi</span><span class="p">);</span>
<span class="nl">ereqirq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">htop1</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">htop1</span><span class="p">);</span>
<span class="nl">emap_htop1:</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">emap:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
<span class="nl">ereqreg:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">);</span>
<span class="nl">erate:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">);</span>
<span class="nl">egetclk:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hdmi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">sh_hdmi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_hdmi</span> <span class="o">*</span><span class="n">hdmi</span> <span class="o">=</span> <span class="n">entity_to_sh_hdmi</span><span class="p">(</span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">snd_soc_unregister_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* No new work will be scheduled, wait for running ISR */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">hdmi</span><span class="p">);</span>
	<span class="cm">/* Wait for already scheduled work */</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">edid_work</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">hdmi_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">htop1</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">htop1</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hdmi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hdmi</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sh_hdmi_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">sh_hdmi_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;sh-mobile-hdmi&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sh_hdmi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh_hdmi_driver</span><span class="p">,</span> <span class="n">sh_hdmi_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">sh_hdmi_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sh_hdmi_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh_hdmi_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sh_hdmi_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SuperH / ARM-shmobile HDMI driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
