<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › aty › radeonfb.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>radeonfb.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef __RADEONFB_H__</span>
<span class="cp">#define __RADEONFB_H__</span>

<span class="cp">#ifdef CONFIG_FB_RADEON_DEBUG</span>
<span class="cp">#define DEBUG		1</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>


<span class="cp">#ifdef CONFIG_FB_RADEON_I2C</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-algo-bit.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#if defined(CONFIG_PPC_OF) || defined(CONFIG_SPARC)</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;video/radeon.h&gt;</span>

<span class="cm">/***************************************************************</span>
<span class="cm"> * Most of the definitions here are adapted right from XFree86 *</span>
<span class="cm"> ***************************************************************/</span>


<span class="cm">/*</span>
<span class="cm"> * Chip families. Must fit in the low 16 bits of a long word</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">radeon_family</span> <span class="p">{</span>
	<span class="n">CHIP_FAMILY_UNKNOW</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_LEGACY</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_RADEON</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_RV100</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_RS100</span><span class="p">,</span>    <span class="cm">/* U1 (IGP320M) or A3 (IGP320)*/</span>
	<span class="n">CHIP_FAMILY_RV200</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_RS200</span><span class="p">,</span>    <span class="cm">/* U2 (IGP330M/340M/350M) or A4 (IGP330/340/345/350),</span>
<span class="cm">				 RS250 (IGP 7000) */</span>
	<span class="n">CHIP_FAMILY_R200</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_RV250</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_RS300</span><span class="p">,</span>    <span class="cm">/* Radeon 9000 IGP */</span>
	<span class="n">CHIP_FAMILY_RV280</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_R300</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_R350</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_RV350</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_RV380</span><span class="p">,</span>    <span class="cm">/* RV370/RV380/M22/M24 */</span>
	<span class="n">CHIP_FAMILY_R420</span><span class="p">,</span>     <span class="cm">/* R420/R423/M18 */</span>
	<span class="n">CHIP_FAMILY_RC410</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_RS400</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_RS480</span><span class="p">,</span>
	<span class="n">CHIP_FAMILY_LAST</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define IS_RV100_VARIANT(rinfo) (((rinfo)-&gt;family == CHIP_FAMILY_RV100)  || \</span>
<span class="cp">				 ((rinfo)-&gt;family == CHIP_FAMILY_RV200)  || \</span>
<span class="cp">				 ((rinfo)-&gt;family == CHIP_FAMILY_RS100)  || \</span>
<span class="cp">				 ((rinfo)-&gt;family == CHIP_FAMILY_RS200)  || \</span>
<span class="cp">				 ((rinfo)-&gt;family == CHIP_FAMILY_RV250)  || \</span>
<span class="cp">				 ((rinfo)-&gt;family == CHIP_FAMILY_RV280)  || \</span>
<span class="cp">				 ((rinfo)-&gt;family == CHIP_FAMILY_RS300))</span>


<span class="cp">#define IS_R300_VARIANT(rinfo) (((rinfo)-&gt;family == CHIP_FAMILY_R300)  || \</span>
<span class="cp">				((rinfo)-&gt;family == CHIP_FAMILY_RV350) || \</span>
<span class="cp">				((rinfo)-&gt;family == CHIP_FAMILY_R350)  || \</span>
<span class="cp">				((rinfo)-&gt;family == CHIP_FAMILY_RV380) || \</span>
<span class="cp">				((rinfo)-&gt;family == CHIP_FAMILY_R420)  || \</span>
<span class="cp">                               ((rinfo)-&gt;family == CHIP_FAMILY_RC410) || \</span>
<span class="cp">                               ((rinfo)-&gt;family == CHIP_FAMILY_RS480))</span>

<span class="cm">/*</span>
<span class="cm"> * Chip flags</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">radeon_chip_flags</span> <span class="p">{</span>
	<span class="n">CHIP_FAMILY_MASK</span>	<span class="o">=</span> <span class="mh">0x0000ffffUL</span><span class="p">,</span>
	<span class="n">CHIP_FLAGS_MASK</span>		<span class="o">=</span> <span class="mh">0xffff0000UL</span><span class="p">,</span>
	<span class="n">CHIP_IS_MOBILITY</span>	<span class="o">=</span> <span class="mh">0x00010000UL</span><span class="p">,</span>
	<span class="n">CHIP_IS_IGP</span>		<span class="o">=</span> <span class="mh">0x00020000UL</span><span class="p">,</span>
	<span class="n">CHIP_HAS_CRTC2</span>		<span class="o">=</span> <span class="mh">0x00040000UL</span><span class="p">,</span>	
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Errata workarounds</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">radeon_errata</span> <span class="p">{</span>
	<span class="n">CHIP_ERRATA_R300_CG</span>		<span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>
	<span class="n">CHIP_ERRATA_PLL_DUMMYREADS</span>	<span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span>
	<span class="n">CHIP_ERRATA_PLL_DELAY</span>		<span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Monitor types</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">radeon_montype</span> <span class="p">{</span>
	<span class="n">MT_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MT_CRT</span><span class="p">,</span>		<span class="cm">/* CRT */</span>
	<span class="n">MT_LCD</span><span class="p">,</span>		<span class="cm">/* LCD */</span>
	<span class="n">MT_DFP</span><span class="p">,</span>		<span class="cm">/* DVI */</span>
	<span class="n">MT_CTV</span><span class="p">,</span>		<span class="cm">/* composite TV */</span>
	<span class="n">MT_STV</span>		<span class="cm">/* S-Video out */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * DDC i2c ports</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">ddc_type</span> <span class="p">{</span>
	<span class="n">ddc_none</span><span class="p">,</span>
	<span class="n">ddc_monid</span><span class="p">,</span>
	<span class="n">ddc_dvi</span><span class="p">,</span>
	<span class="n">ddc_vga</span><span class="p">,</span>
	<span class="n">ddc_crt2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Connector types</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">conn_type</span> <span class="p">{</span>
	<span class="n">conn_none</span><span class="p">,</span>
	<span class="n">conn_proprietary</span><span class="p">,</span>
	<span class="n">conn_crt</span><span class="p">,</span>
	<span class="n">conn_DVI_I</span><span class="p">,</span>
	<span class="n">conn_DVI_D</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * PLL infos</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pll_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ppll_max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ppll_min</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sclk</span><span class="p">,</span> <span class="n">mclk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ref_div</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ref_clk</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * This structure contains the various registers manipulated by this</span>
<span class="cm"> * driver for setting or restoring a mode. It&#39;s mostly copied from</span>
<span class="cm"> * XFree&#39;s RADEONSaveRec structure. A few chip settings might still be</span>
<span class="cm"> * tweaked without beeing reflected or saved in these registers though</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">radeon_regs</span> <span class="p">{</span>
	<span class="cm">/* Common registers */</span>
	<span class="n">u32</span>		<span class="n">ovr_clr</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">ovr_wid_left_right</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">ovr_wid_top_bottom</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">ov0_scale_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">mpp_tb_config</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">mpp_gp_config</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">subpic_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">viph_control</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">i2c_cntl_1</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">gen_int_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">cap0_trig_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">cap1_trig_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">bus_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">surface_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">bios_5_scratch</span><span class="p">;</span>

	<span class="cm">/* Other registers to save for VT switches or driver load/unload */</span>
	<span class="n">u32</span>		<span class="n">dp_datatype</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">rbbm_soft_reset</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">clock_cntl_index</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">amcgpio_en_reg</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">amcgpio_mask</span><span class="p">;</span>

	<span class="cm">/* Surface/tiling registers */</span>
	<span class="n">u32</span>		<span class="n">surf_lower_bound</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u32</span>		<span class="n">surf_upper_bound</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u32</span>		<span class="n">surf_info</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/* CRTC registers */</span>
	<span class="n">u32</span>		<span class="n">crtc_gen_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc_ext_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">dac_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc_h_total_disp</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc_h_sync_strt_wid</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc_v_total_disp</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc_v_sync_strt_wid</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc_offset</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc_offset_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc_pitch</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">disp_merge_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">grph_buffer_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc_more_cntl</span><span class="p">;</span>

	<span class="cm">/* CRTC2 registers */</span>
	<span class="n">u32</span>		<span class="n">crtc2_gen_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">dac2_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">disp_output_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">disp_hw_debug</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">disp2_merge_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">grph2_buffer_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc2_h_total_disp</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc2_h_sync_strt_wid</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc2_v_total_disp</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc2_v_sync_strt_wid</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc2_offset</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc2_offset_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">crtc2_pitch</span><span class="p">;</span>

	<span class="cm">/* Flat panel regs */</span>
	<span class="n">u32</span> 		<span class="n">fp_crtc_h_total_disp</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">fp_crtc_v_total_disp</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">fp_gen_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">fp2_gen_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">fp_h_sync_strt_wid</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">fp2_h_sync_strt_wid</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">fp_horz_stretch</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">fp_panel_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">fp_v_sync_strt_wid</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">fp2_v_sync_strt_wid</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">fp_vert_stretch</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">lvds_gen_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">lvds_pll_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">tmds_crc</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">tmds_transmitter_cntl</span><span class="p">;</span>

	<span class="cm">/* Computed values for PLL */</span>
	<span class="n">u32</span>		<span class="n">dot_clock_freq</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">feedback_div</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">post_div</span><span class="p">;</span>	

	<span class="cm">/* PLL registers */</span>
	<span class="n">u32</span>		<span class="n">ppll_div_3</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">ppll_ref_div</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">vclk_ecp_cntl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">clk_cntl_index</span><span class="p">;</span>

	<span class="cm">/* Computed values for PLL2 */</span>
	<span class="n">u32</span>		<span class="n">dot_clock_freq_2</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">feedback_div_2</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">post_div_2</span><span class="p">;</span>

	<span class="cm">/* PLL2 registers */</span>
	<span class="n">u32</span>		<span class="n">p2pll_ref_div</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">p2pll_div_0</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">htotal_cntl2</span><span class="p">;</span>

       	<span class="cm">/* Palette */</span>
	<span class="kt">int</span>		<span class="n">palette_valid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">panel_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">valid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hOver_plus</span><span class="p">,</span> <span class="n">hSync_width</span><span class="p">,</span> <span class="n">hblank</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vOver_plus</span><span class="p">,</span> <span class="n">vSync_width</span><span class="p">,</span> <span class="n">vblank</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hAct_high</span><span class="p">,</span> <span class="n">vAct_high</span><span class="p">,</span> <span class="n">interlaced</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pwr_delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">use_bios_dividers</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ref_divider</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">post_divider</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fbk_divider</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">radeonfb_info</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_RADEON_I2C</span>
<span class="k">struct</span> <span class="n">radeon_i2c_chan</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeonfb_info</span>		<span class="o">*</span><span class="n">rinfo</span><span class="p">;</span>
	<span class="n">u32</span>		 		<span class="n">ddc_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span>		<span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_algo_bit_data</span>	<span class="n">algo</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">enum</span> <span class="n">radeon_pm_mode</span> <span class="p">{</span>
	<span class="n">radeon_pm_none</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* Nothing supported */</span>
	<span class="n">radeon_pm_d2</span>	<span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>	<span class="cm">/* Can do D2 state */</span>
	<span class="n">radeon_pm_off</span>	<span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span>	<span class="cm">/* Can resume from D3 cold */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">reinit_function_ptr</span><span class="p">)(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span>		<span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">radeon_regs</span> 	<span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_regs</span>	<span class="n">init_state</span><span class="p">;</span>

	<span class="kt">char</span>			<span class="n">name</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">mmio_base_phys</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">fb_base_phys</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">mmio_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">fb_base</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">fb_local_base</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span>		<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_PPC_OF) || defined(CONFIG_SPARC)</span>
	<span class="k">struct</span> <span class="n">device_node</span>	<span class="o">*</span><span class="n">of_node</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">bios_seg</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">fp_bios_start</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="p">{</span> <span class="n">u8</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">pad</span><span class="p">;</span> <span class="p">}</span>
				<span class="n">palette</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="kt">int</span>			<span class="n">chipset</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">family</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">rev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">errata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">video_ram</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">mapped_vram</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">vram_width</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">vram_ddr</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">pitch</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">depth</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">has_CRTC2</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">is_mobility</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">is_IGP</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">reversed_DAC</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">reversed_TMDS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">panel_info</span>	<span class="n">panel_info</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">mon1_type</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">mon1_EDID</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span>	<span class="o">*</span><span class="n">mon1_modedb</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">mon1_dbsize</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">mon2_type</span><span class="p">;</span>
	<span class="n">u8</span>		        <span class="o">*</span><span class="n">mon2_EDID</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">dp_gui_master_cntl</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pll_info</span>		<span class="n">pll</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">mtrr_hdl</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">pm_reg</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">save_regs</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">asleep</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">lock_blank</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">dynclk</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">no_schedule</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">radeon_pm_mode</span>	<span class="n">pm_mode</span><span class="p">;</span>
	<span class="n">reinit_function_ptr</span>     <span class="n">reinit_func</span><span class="p">;</span>

	<span class="cm">/* Lock on register access */</span>
	<span class="n">spinlock_t</span>		<span class="n">reg_lock</span><span class="p">;</span>

	<span class="cm">/* Timer used for delayed LVDS operations */</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">lvds_timer</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">pending_lvds_gen_cntl</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_RADEON_I2C</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_chan</span> 	<span class="n">i2c</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="p">};</span>


<span class="cp">#define PRIMARY_MONITOR(rinfo)	(rinfo-&gt;mon1_type)</span>


<span class="cm">/*</span>
<span class="cm"> * IO macros</span>
<span class="cm"> */</span>

<span class="cm">/* Note about this function: we have some rare cases where we must not schedule,</span>
<span class="cm"> * this typically happen with our special &quot;wake up early&quot; hook which allows us to</span>
<span class="cm"> * wake up the graphic chip (and thus get the console back) before everything else</span>
<span class="cm"> * on some machines that support that mechanism. At this point, interrupts are off</span>
<span class="cm"> * and scheduling is not permitted</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_radeon_msleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">no_schedule</span> <span class="o">||</span> <span class="n">oops_in_progress</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define INREG8(addr)		readb((rinfo-&gt;mmio_base)+addr)</span>
<span class="cp">#define OUTREG8(addr,val)	writeb(val, (rinfo-&gt;mmio_base)+addr)</span>
<span class="cp">#define INREG16(addr)		readw((rinfo-&gt;mmio_base)+addr)</span>
<span class="cp">#define OUTREG16(addr,val)	writew(val, (rinfo-&gt;mmio_base)+addr)</span>
<span class="cp">#define INREG(addr)		readl((rinfo-&gt;mmio_base)+addr)</span>
<span class="cp">#define OUTREG(addr,val)	writel(val, (rinfo-&gt;mmio_base)+addr)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_OUTREGP</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define OUTREGP(addr,val,mask)	_OUTREGP(rinfo, addr, val,mask)</span>

<span class="cm">/*</span>
<span class="cm"> * Note about PLL register accesses:</span>
<span class="cm"> *</span>
<span class="cm"> * I have removed the spinlock on them on purpose. The driver now</span>
<span class="cm"> * expects that it will only manipulate the PLL registers in normal</span>
<span class="cm"> * task environment, where radeon_msleep() will be called, protected</span>
<span class="cm"> * by a semaphore (currently the console semaphore) so that no conflict</span>
<span class="cm"> * will happen on the PLL register index.</span>
<span class="cm"> *</span>
<span class="cm"> * With the latest changes to the VT layer, this is guaranteed for all</span>
<span class="cm"> * calls except the actual drawing/blits which aren&#39;t supposed to use</span>
<span class="cm"> * the PLL registers anyway</span>
<span class="cm"> *</span>
<span class="cm"> * This is very important for the workarounds to work properly. The only</span>
<span class="cm"> * possible exception to this rule is the call to unblank(), which may</span>
<span class="cm"> * be done at irq time if an oops is in progress.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">radeon_pll_errata_after_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">&amp;</span> <span class="n">CHIP_ERRATA_PLL_DUMMYREADS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">INREG</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">INREG</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">radeon_pll_errata_after_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">&amp;</span> <span class="n">CHIP_ERRATA_PLL_DELAY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we can&#39;t deal with posted writes here ... */</span>
		<span class="n">_radeon_msleep</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">&amp;</span> <span class="n">CHIP_ERRATA_R300_CG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">save</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">save</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">save</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3f</span> <span class="o">|</span> <span class="n">PLL_WR_EN</span><span class="p">);</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span><span class="p">);</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">__INPLL</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">OUTREG8</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x0000003f</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_index</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_data</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__OUTPLL</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">OUTREG8</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0x0000003f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00000080</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_index</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_data</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__OUTPLLP</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span>  <span class="o">=</span> <span class="n">__INPLL</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">__OUTPLL</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define INPLL(addr)			__INPLL(rinfo, addr)</span>
<span class="cp">#define OUTPLL(index, val)		__OUTPLL(rinfo, index, val)</span>
<span class="cp">#define OUTPLLP(index, val, mask)	__OUTPLLP(rinfo, index, val, mask)</span>


<span class="cp">#define BIOS_IN8(v)  	(readb(rinfo-&gt;bios_seg + (v)))</span>
<span class="cp">#define BIOS_IN16(v) 	(readb(rinfo-&gt;bios_seg + (v)) | \</span>
<span class="cp">			  (readb(rinfo-&gt;bios_seg + (v) + 1) &lt;&lt; 8))</span>
<span class="cp">#define BIOS_IN32(v) 	(readb(rinfo-&gt;bios_seg + (v)) | \</span>
<span class="cp">			  (readb(rinfo-&gt;bios_seg + (v) + 1) &lt;&lt; 8) | \</span>
<span class="cp">			  (readb(rinfo-&gt;bios_seg + (v) + 2) &lt;&lt; 16) | \</span>
<span class="cp">			  (readb(rinfo-&gt;bios_seg + (v) + 3) &lt;&lt; 24))</span>

<span class="cm">/*</span>
<span class="cm"> * Inline utilities</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">round_div</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">den</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="p">(</span><span class="n">den</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">den</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">var_to_depth</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="mi">15</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">radeon_get_dstbpp</span><span class="p">(</span><span class="n">u16</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
       	<span class="k">case</span> <span class="mi">8</span>:
       		<span class="k">return</span> <span class="n">DST_8BPP</span><span class="p">;</span>
       	<span class="k">case</span> <span class="mi">15</span>:
       		<span class="k">return</span> <span class="n">DST_15BPP</span><span class="p">;</span>
       	<span class="k">case</span> <span class="mi">16</span>:
       		<span class="k">return</span> <span class="n">DST_16BPP</span><span class="p">;</span>
       	<span class="k">case</span> <span class="mi">32</span>:
       		<span class="k">return</span> <span class="n">DST_32BPP</span><span class="p">;</span>
       	<span class="nl">default:</span>
       		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 2D Engine helper routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_radeon_fifo_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">2000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">INREG</span><span class="p">(</span><span class="n">RBBM_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">entries</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;radeonfb: FIFO Timeout !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">radeon_engine_flush</span> <span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Initiate flush */</span>
	<span class="n">OUTREGP</span><span class="p">(</span><span class="n">DSTCACHE_CTLSTAT</span><span class="p">,</span> <span class="n">RB2D_DC_FLUSH_ALL</span><span class="p">,</span>
	        <span class="o">~</span><span class="n">RB2D_DC_FLUSH_ALL</span><span class="p">);</span>

	<span class="cm">/* Ensure FIFO is empty, ie, make sure the flush commands</span>
<span class="cm">	 * has reached the cache</span>
<span class="cm">	 */</span>
	<span class="n">_radeon_fifo_wait</span> <span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="cm">/* Wait for the flush to complete */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">DSTCACHE_CTLSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RB2D_DC_BUSY</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;radeonfb: Flush Timeout !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_radeon_engine_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* ensure FIFO is empty before waiting for idle */</span>
	<span class="n">_radeon_fifo_wait</span> <span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">2000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">INREG</span><span class="p">(</span><span class="n">RBBM_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GUI_ACTIVE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_engine_flush</span> <span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;radeonfb: Idle Timeout !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define radeon_engine_idle()		_radeon_engine_idle(rinfo)</span>
<span class="cp">#define radeon_fifo_wait(entries)	_radeon_fifo_wait(rinfo,entries)</span>
<span class="cp">#define radeon_msleep(ms)		_radeon_msleep(rinfo,ms)</span>


<span class="cm">/* I2C Functions */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeon_create_i2c_busses</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeon_delete_i2c_busses</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">radeon_probe_i2c_connector</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">conn</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">out_edid</span><span class="p">);</span>

<span class="cm">/* PM Functions */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">radeonfb_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">radeonfb_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeonfb_pm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dynclk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore_devlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_sleep</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeonfb_pm_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">);</span>

<span class="cm">/* Monitor probe functions */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeon_probe_screens</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">monitor_layout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore_edid</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeon_check_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">radeon_match_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">src</span><span class="p">);</span>

<span class="cm">/* Accel functions */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeonfb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">region</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeonfb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeonfb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">radeonfb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeonfb_engine_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeonfb_engine_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">);</span>

<span class="cm">/* Other functions */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">radeon_screen_blank</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode_switch</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeon_write_mode</span> <span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_regs</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">reg_only</span><span class="p">);</span>

<span class="cm">/* Backlight functions */</span>
<span class="cp">#ifdef CONFIG_FB_RADEON_BACKLIGHT</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeonfb_bl_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeonfb_bl_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">radeonfb_bl_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">radeonfb_bl_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* __RADEONFB_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
