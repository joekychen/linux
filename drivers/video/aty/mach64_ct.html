<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › aty › mach64_ct.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mach64_ct.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  ATI Mach64 CT/VT/GT/LT Support</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;video/mach64.h&gt;</span>
<span class="cp">#include &quot;atyfb.h&quot;</span>
<span class="cp">#ifdef CONFIG_PPC</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#undef DEBUG</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">aty_valid_pll_ct</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vclk_per</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pll_ct</span> <span class="o">*</span><span class="n">pll</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty_dsp_gt</span>       <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bpp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pll_ct</span> <span class="o">*</span><span class="n">pll</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty_var_to_pll_ct</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vclk_per</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bpp</span><span class="p">,</span> <span class="k">union</span> <span class="n">aty_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">aty_pll_to_var_ct</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">union</span> <span class="n">aty_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">);</span>

<span class="n">u8</span> <span class="nf">aty_ld_pll_ct</span><span class="p">(</span><span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* write addr byte */</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">CLOCK_CNTL_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PLL_ADDR</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="cm">/* read the register value */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">aty_ld_8</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty_st_pll_ct</span><span class="p">(</span><span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* write addr byte */</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">CLOCK_CNTL_ADDR</span><span class="p">,</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PLL_ADDR</span><span class="p">)</span> <span class="o">|</span> <span class="n">PLL_WR_EN</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="cm">/* write the register value */</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">PLL_DATA</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">CLOCK_CNTL_ADDR</span><span class="p">,</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PLL_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PLL_WR_EN</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * by Daniel Mantione</span>
<span class="cm"> *                                  &lt;daniel.mantione@freepascal.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * ATI Mach64 CT clock synthesis description.</span>
<span class="cm"> *</span>
<span class="cm"> * All clocks on the Mach64 can be calculated using the same principle:</span>
<span class="cm"> *</span>
<span class="cm"> *       XTALIN * x * FB_DIV</span>
<span class="cm"> * CLK = ----------------------</span>
<span class="cm"> *       PLL_REF_DIV * POST_DIV</span>
<span class="cm"> *</span>
<span class="cm"> * XTALIN is a fixed speed clock. Common speeds are 14.31 MHz and 29.50 MHz.</span>
<span class="cm"> * PLL_REF_DIV can be set by the user, but is the same for all clocks.</span>
<span class="cm"> * FB_DIV can be set by the user for each clock individually, it should be set</span>
<span class="cm"> * between 128 and 255, the chip will generate a bad clock signal for too low</span>
<span class="cm"> * values.</span>
<span class="cm"> * x depends on the type of clock; usually it is 2, but for the MCLK it can also</span>
<span class="cm"> * be set to 4.</span>
<span class="cm"> * POST_DIV can be set by the user for each clock individually, Possible values</span>
<span class="cm"> * are 1,2,4,8 and for some clocks other values are available too.</span>
<span class="cm"> * CLK is of course the clock speed that is generated.</span>
<span class="cm"> *</span>
<span class="cm"> * The Mach64 has these clocks:</span>
<span class="cm"> *</span>
<span class="cm"> * MCLK			The clock rate of the chip</span>
<span class="cm"> * XCLK			The clock rate of the on-chip memory</span>
<span class="cm"> * VCLK0		First pixel clock of first CRT controller</span>
<span class="cm"> * VCLK1    Second pixel clock of first CRT controller</span>
<span class="cm"> * VCLK2		Third pixel clock of first CRT controller</span>
<span class="cm"> * VCLK3    Fourth pixel clock of first CRT controller</span>
<span class="cm"> * VCLK			Selected pixel clock, one of VCLK0, VCLK1, VCLK2, VCLK3</span>
<span class="cm"> * V2CLK		Pixel clock of the second CRT controller.</span>
<span class="cm"> * SCLK			Multi-purpose clock</span>
<span class="cm"> *</span>
<span class="cm"> * - MCLK and XCLK use the same FB_DIV</span>
<span class="cm"> * - VCLK0 .. VCLK3 use the same FB_DIV</span>
<span class="cm"> * - V2CLK is needed when the second CRTC is used (can be used for dualhead);</span>
<span class="cm"> *   i.e. CRT monitor connected to laptop has different resolution than built</span>
<span class="cm"> *   in LCD monitor.</span>
<span class="cm"> * - SCLK is not available on all cards; it is know to exist on the Rage LT-PRO,</span>
<span class="cm"> *   Rage XL and Rage Mobility. It is know not to exist on the Mach64 VT.</span>
<span class="cm"> * - V2CLK is not available on all cards, most likely only the Rage LT-PRO,</span>
<span class="cm"> *   the Rage XL and the Rage Mobility</span>
<span class="cm"> *</span>
<span class="cm"> * SCLK can be used to:</span>
<span class="cm"> * - Clock the chip instead of MCLK</span>
<span class="cm"> * - Replace XTALIN with a user defined frequency</span>
<span class="cm"> * - Generate the pixel clock for the LCD monitor (instead of VCLK)</span>
<span class="cm"> */</span>

 <span class="cm">/*</span>
<span class="cm">  * It can be quite hard to calculate XCLK and MCLK if they don&#39;t run at the</span>
<span class="cm">  * same frequency. Luckily, until now all cards that need asynchrone clock</span>
<span class="cm">  * speeds seem to have SCLK.</span>
<span class="cm">  * So this driver uses SCLK to clock the chip and XCLK to clock the memory.</span>
<span class="cm">  */</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> *  PLL programming (Mach64 CT family)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This procedure sets the display fifo. The display fifo is a buffer that</span>
<span class="cm"> * contains data read from the video memory that waits to be processed by</span>
<span class="cm"> * the CRT controller.</span>
<span class="cm"> *</span>
<span class="cm"> * On the more modern Mach64 variants, the chip doesn&#39;t calculate the</span>
<span class="cm"> * interval after which the display fifo has to be reloaded from memory</span>
<span class="cm"> * automatically, the driver has to do it instead.</span>
<span class="cm"> */</span>

<span class="cp">#define Maximum_DSP_PRECISION 7</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">postdividers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">3</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_dsp_gt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bpp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pll_ct</span> <span class="o">*</span><span class="n">pll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dsp_off</span><span class="p">,</span> <span class="n">dsp_on</span><span class="p">,</span> <span class="n">dsp_xclks</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">multiplier</span><span class="p">,</span> <span class="n">divider</span><span class="p">,</span> <span class="n">ras_multiplier</span><span class="p">,</span> <span class="n">ras_divider</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vshift</span><span class="p">,</span> <span class="n">xshift</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">dsp_precision</span><span class="p">;</span>

	<span class="n">multiplier</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">mclk_fb_div</span><span class="p">)</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_post_div_real</span><span class="p">;</span>
	<span class="n">divider</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_fb_div</span><span class="p">)</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">xclk_ref_div</span><span class="p">;</span>

	<span class="n">ras_multiplier</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">xclkmaxrasdelay</span><span class="p">;</span>
	<span class="n">ras_divider</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span><span class="o">&gt;=</span><span class="mi">8</span><span class="p">)</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="n">divider</span> <span class="o">*</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">vshift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">xclk_post_div</span><span class="p">;</span>	<span class="cm">/* FIFO is 64 bits wide in accelerator mode ... */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vshift</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/* ... but only 32 bits in VGA mode. */</span>

<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

		<span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_width</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="n">divider</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

		<span class="n">ras_multiplier</span> <span class="o">=</span> <span class="n">ras_multiplier</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_width</span><span class="p">;</span>
		<span class="n">ras_divider</span> <span class="o">=</span> <span class="n">ras_divider</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* If we don&#39;t do this, 32 bits for multiplier &amp; divider won&#39;t be</span>
<span class="cm">	enough in certain situations! */</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">multiplier</span> <span class="o">|</span> <span class="n">divider</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="n">divider</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Determine DSP precision first */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">multiplier</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">vshift</span><span class="p">)</span> <span class="o">/</span> <span class="n">divider</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dsp_precision</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>  <span class="n">tmp</span><span class="p">;</span>  <span class="n">dsp_precision</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_precision</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dsp_precision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsp_precision</span> <span class="o">&gt;</span> <span class="n">Maximum_DSP_PRECISION</span><span class="p">)</span>
		<span class="n">dsp_precision</span> <span class="o">=</span> <span class="n">Maximum_DSP_PRECISION</span><span class="p">;</span>

	<span class="n">xshift</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="n">dsp_precision</span><span class="p">;</span>
	<span class="n">vshift</span> <span class="o">+=</span> <span class="n">xshift</span><span class="p">;</span>

	<span class="cm">/* Move on to dsp_off */</span>
	<span class="n">dsp_off</span> <span class="o">=</span> <span class="p">((</span><span class="n">multiplier</span> <span class="o">*</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">vshift</span><span class="p">)</span> <span class="o">/</span> <span class="n">divider</span> <span class="o">-</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">vshift</span> <span class="o">-</span> <span class="n">xshift</span><span class="p">));</span>

<span class="cm">/*    if (bpp == 0)</span>
<span class="cm">        dsp_on = ((multiplier * 20 &lt;&lt; vshift) + divider) / divider;</span>
<span class="cm">    else */</span>
	<span class="p">{</span>
		<span class="n">dsp_on</span> <span class="o">=</span> <span class="p">((</span><span class="n">multiplier</span> <span class="o">&lt;&lt;</span> <span class="n">vshift</span><span class="p">)</span> <span class="o">+</span> <span class="n">divider</span><span class="p">)</span> <span class="o">/</span> <span class="n">divider</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">ras_multiplier</span> <span class="o">&lt;&lt;</span> <span class="n">xshift</span><span class="p">)</span> <span class="o">+</span> <span class="n">ras_divider</span><span class="p">)</span> <span class="o">/</span> <span class="n">ras_divider</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_on</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span>
		<span class="n">dsp_on</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">dsp_on</span> <span class="o">=</span> <span class="n">dsp_on</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">xclkpagefaultdelay</span> <span class="o">&lt;&lt;</span> <span class="n">xshift</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate rounding factor and apply it to dsp_on */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">Maximum_DSP_PRECISION</span> <span class="o">-</span> <span class="n">dsp_precision</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dsp_on</span> <span class="o">=</span> <span class="p">((</span><span class="n">dsp_on</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_on</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">dsp_off</span> <span class="o">/</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dsp_on</span> <span class="o">=</span> <span class="n">dsp_off</span> <span class="o">-</span> <span class="p">(</span><span class="n">multiplier</span> <span class="o">&lt;&lt;</span> <span class="n">vshift</span><span class="p">)</span> <span class="o">/</span> <span class="n">divider</span><span class="p">;</span>
		<span class="n">dsp_on</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp_on</span> <span class="o">/</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Last but not least:  dsp_xclks */</span>
	<span class="n">dsp_xclks</span> <span class="o">=</span> <span class="p">((</span><span class="n">multiplier</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">vshift</span> <span class="o">+</span> <span class="mi">5</span><span class="p">))</span> <span class="o">+</span> <span class="n">divider</span><span class="p">)</span> <span class="o">/</span> <span class="n">divider</span><span class="p">;</span>

	<span class="cm">/* Get register values. */</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">dsp_on_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp_on</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">dsp_off</span><span class="p">;</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">dsp_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp_precision</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">dsp_loop_latency</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">dsp_xclks</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atyfb(%s): dsp_config 0x%08x, dsp_on_off 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">dsp_config</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">dsp_on_off</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_valid_pll_ct</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vclk_per</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pll_ct</span> <span class="o">*</span><span class="n">pll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pllvclk</span><span class="p">;</span>

	<span class="cm">/* FIXME: use the VTB/GTB /{3,6,12} post dividers if they&#39;re better suited */</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_ref_div</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="n">vclk_per</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">*</span><span class="mi">8</span> <span class="o">||</span> <span class="n">q</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;atyfb: vclk out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_post_div</span>  <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_post_div</span> <span class="o">+=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">64</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_post_div</span> <span class="o">+=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">32</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_post_div_real</span> <span class="o">=</span> <span class="n">postdividers</span><span class="p">[</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_post_div</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>pll->vclk<em>post</em>div &lt;&lt;= 6;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_fb_div</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_post_div_real</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pllvclk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_fb_div</span><span class="p">)</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_ref_div</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atyfb(%s): pllvclk=%d MHz, vclk=%d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">pllvclk</span><span class="p">,</span> <span class="n">pllvclk</span> <span class="o">/</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_post_div_real</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_vclk_cntl</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* VCLK = PLL_VCLK/VCLKx_POST */</span>

	<span class="cm">/* Set ECP (scaler/overlay clock) divider */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">ecp_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ecp</span> <span class="o">=</span> <span class="n">pllvclk</span> <span class="o">/</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk_post_div_real</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ecp_div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">ecp</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">ecp_max</span> <span class="o">&amp;&amp;</span> <span class="n">ecp_div</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ecp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ecp_div</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_vclk_cntl</span> <span class="o">|=</span> <span class="n">ecp_div</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_var_to_pll_ct</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vclk_per</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bpp</span><span class="p">,</span> <span class="k">union</span> <span class="n">aty_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">aty_valid_pll_ct</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">vclk_per</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">GTB_DSP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">aty_dsp_gt</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/*aty_calc_pll_ct(info, &amp;pll-&gt;ct);*/</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">aty_pll_to_var_ct</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">union</span> <span class="n">aty_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_post_div_real</span> <span class="o">/</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_fb_div</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">*=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_width</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">/=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atyfb(%s): calculated 0x%08X(%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">aty_set_pll_ct</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">union</span> <span class="n">aty_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crtc_gen_cntl</span><span class="p">,</span> <span class="n">lcd_gen_cntrl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>

	<span class="n">lcd_gen_cntrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atyfb(%s): about to program:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;pll_ext_cntl=0x%02x pll_gen_cntl=0x%02x pll_vclk_cntl=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ext_cntl</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_gen_cntl</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_vclk_cntl</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atyfb(%s): setting clock %lu for FeedBackDivider %i, ReferenceDivider %i, PostDivider %i(%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_fb_div</span><span class="p">,</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_post_div</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_post_div_real</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* turn off LCD */</span>
		<span class="n">lcd_gen_cntrl</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">lcd_gen_cntrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCD_ON</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">CLOCK_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span> <span class="o">|</span> <span class="n">CLOCK_STROBE</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Temporarily switch to accelerator mode */</span>
	<span class="n">crtc_gen_cntl</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">crtc_gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_EXT_DISP_EN</span><span class="p">))</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">crtc_gen_cntl</span> <span class="o">|</span> <span class="n">CRTC_EXT_DISP_EN</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Reset VCLK generator */</span>
	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">PLL_VCLK_CNTL</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_vclk_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Set post-divider */</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">VCLK_POST_DIV</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03U</span> <span class="o">&lt;&lt;</span> <span class="n">tmp2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_post_div</span> <span class="o">&amp;</span> <span class="mh">0x03U</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">tmp2</span><span class="p">);</span>
	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">VCLK_POST_DIV</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Set extended post-divider */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">PLL_EXT_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x10U</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0xF0U</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ext_cntl</span><span class="p">;</span>
	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">PLL_EXT_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Set feedback divider */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">VCLK0_FB_DIV</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span><span class="p">;</span>
	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_fb_div</span> <span class="o">&amp;</span> <span class="mh">0xFFU</span><span class="p">),</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">PLL_GEN_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_gen_cntl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">PLL_OVERRIDE</span> <span class="o">|</span> <span class="n">PLL_MCLK_RST</span><span class="p">)))</span> <span class="o">|</span> <span class="n">OSC_EN</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* End VCLK generator reset */</span>
	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">PLL_VCLK_CNTL</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_vclk_cntl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PLL_VCLK_RST</span><span class="p">),</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">PLL_GEN_CNTL</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_gen_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">PLL_VCLK_CNTL</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_vclk_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Restore mode register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">crtc_gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_EXT_DISP_EN</span><span class="p">))</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">crtc_gen_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">GTB_DSP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">dll_cntl</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">XL_DLL</span><span class="p">))</span>
			<span class="n">dll_cntl</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span> <span class="o">&gt;=</span> <span class="n">SDRAM</span><span class="p">)</span>
			<span class="n">dll_cntl</span> <span class="o">=</span> <span class="mh">0xa6</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dll_cntl</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>
		<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">DLL_CNTL</span><span class="p">,</span> <span class="n">dll_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">VFC_CNTL</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DSP_CONFIG</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_config</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DSP_ON_OFF</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_on_off</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">DLL_CNTL</span><span class="p">,</span> <span class="n">dll_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">DLL_CNTL</span><span class="p">,</span> <span class="n">dll_cntl</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">DLL_CNTL</span><span class="p">,</span> <span class="n">dll_cntl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* restore LCD */</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">lcd_gen_cntrl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">aty_get_pll_ct</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="k">union</span> <span class="n">aty_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">clock</span><span class="p">;</span>

	<span class="n">clock</span> <span class="o">=</span> <span class="n">aty_ld_8</span><span class="p">(</span><span class="n">CLOCK_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03U</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">clock</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_post_div</span> <span class="o">=</span> <span class="p">(</span><span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">VCLK_POST_DIV</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03U</span><span class="p">;</span>

	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ext_cntl</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">PLL_EXT_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0FU</span><span class="p">;</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_fb_div</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">VCLK0_FB_DIV</span> <span class="o">+</span> <span class="n">clock</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFU</span><span class="p">;</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">PLL_REF_DIV</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_div</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">MCLK_FB_DIV</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_gen_cntl</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">PLL_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_vclk_cntl</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">PLL_VCLK_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">GTB_DSP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_config</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DSP_CONFIG</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_on_off</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DSP_ON_OFF</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">aty_init_pll_ct</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="k">union</span> <span class="n">aty_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mpost_div</span><span class="p">,</span> <span class="n">xpost_div</span><span class="p">,</span> <span class="n">sclk_post_div_real</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">q</span><span class="p">,</span> <span class="n">memcntl</span><span class="p">,</span> <span class="n">trp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dsp_config</span><span class="p">,</span> <span class="n">dsp_on_off</span><span class="p">,</span> <span class="n">vga_dsp_config</span><span class="p">,</span> <span class="n">vga_dsp_on_off</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">int</span> <span class="n">pllmclk</span><span class="p">,</span> <span class="n">pllsclk</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ext_cntl</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">PLL_EXT_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ext_cntl</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_ref_div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:  <span class="k">case</span> <span class="mi">1</span>:  <span class="k">case</span> <span class="mi">2</span>:  <span class="k">case</span> <span class="mi">3</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_ref_div</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;atyfb: Unsupported xclk source:  %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_mult</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ext_cntl</span> <span class="o">&amp;</span> <span class="n">PLL_MFB_TIMES_4_2B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_mult</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atyfb(%s): mclk_fb_mult=%d, xclk_post_div=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_mult</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">memcntl</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">trp</span> <span class="o">=</span> <span class="p">(</span><span class="n">memcntl</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkpagefaultdelay</span> <span class="o">=</span> <span class="p">((</span><span class="n">memcntl</span> <span class="o">&amp;</span> <span class="mh">0xc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">memcntl</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="n">trp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkmaxrasdelay</span> <span class="o">=</span> <span class="p">((</span><span class="n">memcntl</span> <span class="o">&amp;</span> <span class="mh">0x70000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">trp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">FIFO_32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkpagefaultdelay</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkmaxrasdelay</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRAM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="o">&lt;=</span><span class="n">ONE_MB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_loop_latency</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_loop_latency</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkpagefaultdelay</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EDO</span>:
	<span class="k">case</span> <span class="n">PSEUDO_EDO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="o">&lt;=</span><span class="n">ONE_MB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_loop_latency</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_loop_latency</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkpagefaultdelay</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SDRAM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="o">&lt;=</span><span class="n">ONE_MB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_loop_latency</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_loop_latency</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkpagefaultdelay</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SGRAM</span>:
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_loop_latency</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkpagefaultdelay</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_loop_latency</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkpagefaultdelay</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkmaxrasdelay</span> <span class="o">&lt;=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkpagefaultdelay</span><span class="p">)</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkmaxrasdelay</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclkpagefaultdelay</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Allow BIOS to override */</span>
	<span class="n">dsp_config</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DSP_CONFIG</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">dsp_on_off</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DSP_ON_OFF</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_dsp_config</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">VGA_DSP_CONFIG</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_dsp_on_off</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">VGA_DSP_ON_OFF</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_config</span><span class="p">)</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_loop_latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp_config</span> <span class="o">&amp;</span> <span class="n">DSP_LOOP_LATENCY</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	FIXME: is it relevant for us?</span>
<span class="c">	if ((!dsp_on_off &amp;&amp; !M64_HAS(RESET_3D)) ||</span>
<span class="c">		((dsp_on_off == vga_dsp_on_off) &amp;&amp;</span>
<span class="c">		(!dsp_config || !((dsp_config ^ vga_dsp_config) &amp; DSP_XCLKS_PER_QW)))) {</span>
<span class="c">		vga_dsp_on_off &amp;= VGA_DSP_OFF;</span>
<span class="c">		vga_dsp_config &amp;= VGA_DSP_XCLKS_PER_QW;</span>
<span class="c">		if (ATIDivide(vga_dsp_on_off, vga_dsp_config, 5, 1) &gt; 24)</span>
<span class="c">			pll-&gt;ct.fifo_size = 32;</span>
<span class="c">		else</span>
<span class="c">			pll-&gt;ct.fifo_size = 24;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Exit if the user does not want us to tamper with the clock</span>
<span class="cm">	rates of her chip. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mclk_per</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">mclk_fb_div</span><span class="p">,</span> <span class="n">pll_ext_cntl</span><span class="p">;</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">PLL_REF_DIV</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">pll_ext_cntl</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">PLL_EXT_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div_real</span> <span class="o">=</span> <span class="n">postdividers</span><span class="p">[</span><span class="n">pll_ext_cntl</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">];</span>
		<span class="n">mclk_fb_div</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">MCLK_FB_DIV</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pll_ext_cntl</span> <span class="o">&amp;</span> <span class="n">PLL_MFB_TIMES_4_2B</span><span class="p">)</span>
			<span class="n">mclk_fb_div</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_div</span> <span class="o">=</span> <span class="n">mclk_fb_div</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_per</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">255</span> <span class="o">/</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span><span class="p">;</span>

	<span class="cm">/* FIXME: use the VTB/GTB /3 post divider if it&#39;s better suited */</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_mult</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xclk_per</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">*</span><span class="mi">8</span> <span class="o">||</span> <span class="n">q</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;atxfb: xclk out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xpost_div</span>  <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">xpost_div</span> <span class="o">+=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">64</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">xpost_div</span> <span class="o">+=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">32</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div_real</span> <span class="o">=</span> <span class="n">postdividers</span><span class="p">[</span><span class="n">xpost_div</span><span class="p">];</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_div</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div_real</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Override PLL_EXT_CNTL &amp; 0x07. */</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div</span> <span class="o">=</span> <span class="n">xpost_div</span><span class="p">;</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_ref_div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">pllmclk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_mult</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_div</span><span class="p">)</span> <span class="o">/</span>
			<span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atyfb(%s): pllmclk=%d MHz, xclk=%d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">pllmclk</span><span class="p">,</span> <span class="n">pllmclk</span> <span class="o">/</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div_real</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">SDRAM_MAGIC_PLL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span> <span class="o">&gt;=</span> <span class="n">SDRAM</span><span class="p">))</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_gen_cntl</span> <span class="o">=</span> <span class="n">OSC_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_gen_cntl</span> <span class="o">=</span> <span class="n">OSC_EN</span> <span class="o">|</span> <span class="n">DLL_PWDN</span> <span class="cm">/* | FORCE_DCLK_TRI_STATE */</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">MAGIC_POSTDIV</span><span class="p">))</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ext_cntl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ext_cntl</span> <span class="o">=</span> <span class="n">xpost_div</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_mult</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ext_cntl</span> <span class="o">|=</span> <span class="n">PLL_MFB_TIMES_4_2B</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mclk_per</span> <span class="o">==</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xclk_per</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_gen_cntl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">xpost_div</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* mclk == xclk */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		* The chip clock is not equal to the memory clock.</span>
<span class="cm">		* Therefore we will use sclk to clock the chip.</span>
<span class="cm">		*/</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_gen_cntl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* mclk == sclk */</span>

		<span class="n">q</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mclk_per</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">*</span><span class="mi">8</span> <span class="o">||</span> <span class="n">q</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;atyfb: mclk out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpost_div</span>  <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
			<span class="n">mpost_div</span> <span class="o">+=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">64</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
			<span class="n">mpost_div</span> <span class="o">+=</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">32</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sclk_post_div_real</span> <span class="o">=</span> <span class="n">postdividers</span><span class="p">[</span><span class="n">mpost_div</span><span class="p">];</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">sclk_fb_div</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">sclk_post_div_real</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">spll_cntl2</span> <span class="o">=</span> <span class="n">mpost_div</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">pllsclk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">sclk_fb_div</span><span class="p">)</span> <span class="o">/</span>
			<span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atyfb(%s): use sclk, pllsclk=%d MHz, sclk=mclk=%d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">pllsclk</span><span class="p">,</span> <span class="n">pllsclk</span> <span class="o">/</span> <span class="n">sclk_post_div_real</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Disable the extra precision pixel clock controls since we do not use them. */</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">ext_vpll_cntl</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">EXT_VPLL_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">ext_vpll_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXT_VPLL_EN</span> <span class="o">|</span> <span class="n">EXT_VPLL_VGA_EN</span> <span class="o">|</span> <span class="n">EXT_VPLL_INSYNC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty_resume_pll_ct</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">aty_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mclk_per</span> <span class="o">!=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xclk_per</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		* This disables the sclk, crashes the computer as reported:</span>
<span class="cm">		* aty_st_pll_ct(SPLL_CNTL2, 3, info);</span>
<span class="cm">		*</span>
<span class="cm">		* So it seems the sclk must be enabled before it is used;</span>
<span class="cm">		* so PLL_GEN_CNTL must be programmed *after* the sclk.</span>
<span class="cm">		*/</span>
		<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">SCLK_FB_DIV</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">sclk_fb_div</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">SPLL_CNTL2</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">spll_cntl2</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * SCLK has been started. Wait for the PLL to lock. 5 ms</span>
<span class="cm">		 * should be enough according to mach64 programmer&#39;s guide.</span>
<span class="cm">		 */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">PLL_REF_DIV</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">PLL_GEN_CNTL</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_gen_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">MCLK_FB_DIV</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_div</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">PLL_EXT_CNTL</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ext_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_pll_ct</span><span class="p">(</span><span class="n">EXT_VPLL_CNTL</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">ext_vpll_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">aty_dac_ops</span> <span class="n">aty_dac_ct</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_dac</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dummy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">aty_pll_ops</span> <span class="n">aty_pll_ct</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">var_to_pll</span>	<span class="o">=</span> <span class="n">aty_var_to_pll_ct</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pll_to_var</span>	<span class="o">=</span> <span class="n">aty_pll_to_var_ct</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pll</span>	<span class="o">=</span> <span class="n">aty_set_pll_ct</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pll</span>	<span class="o">=</span> <span class="n">aty_get_pll_ct</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_pll</span>	<span class="o">=</span> <span class="n">aty_init_pll_ct</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume_pll</span>	<span class="o">=</span> <span class="n">aty_resume_pll_ct</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
