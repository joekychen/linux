<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › aty › radeon_pm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>radeon_pm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	drivers/video/aty/radeon_pm.c</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright 2003,2004 Ben. Herrenschmidt &lt;benh@kernel.crashing.org&gt;</span>
<span class="cm"> *	Copyright 2004 Paul Mackerras &lt;paulus@samba.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This is the power management code for ATI radeon chipsets. It contains</span>
<span class="cm"> *	some dynamic clock PM enable/disable code similar to what X.org does,</span>
<span class="cm"> *	some D2-state (APM-style) sleep/wakeup code for use on some PowerMacs,</span>
<span class="cm"> *	and the necessary bits to re-initialize from scratch a few chips found</span>
<span class="cm"> *	on PowerMacs as well. The later could be extended to more platforms</span>
<span class="cm"> *	provided the memory controller configuration code be made more generic,</span>
<span class="cm"> *	and you can get the proper mode register commands for your RAMs.</span>
<span class="cm"> *	Those things may be found in the BIOS image...</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;radeonfb.h&quot;</span>

<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/agp_backend.h&gt;</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_feature.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;ati_ids.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Workarounds for bugs in PC laptops:</span>
<span class="cm"> * - enable D2 sleep in some IBM Thinkpads</span>
<span class="cm"> * - special case for Samsung P35</span>
<span class="cm"> *</span>
<span class="cm"> * Whitelist by subsystem vendor/device because</span>
<span class="cm"> * its the subsystem vendor&#39;s fault!</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_PM) &amp;&amp; defined(CONFIG_X86)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">radeon_reinitialize_M10</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">radeon_device_id</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ident</span><span class="p">;</span>                     <span class="cm">/* (arbitrary) Name */</span>
        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">subsystem_vendor</span><span class="p">;</span> <span class="cm">/* Subsystem Vendor ID */</span>
        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">subsystem_device</span><span class="p">;</span> <span class="cm">/* Subsystem Device ID */</span>
	<span class="k">const</span> <span class="k">enum</span> <span class="n">radeon_pm_mode</span> <span class="n">pm_mode_modifier</span><span class="p">;</span> <span class="cm">/* modify pm_mode */</span>
	<span class="k">const</span> <span class="n">reinit_function_ptr</span> <span class="n">new_reinit_func</span><span class="p">;</span>   <span class="cm">/* changed reinit_func */</span>
<span class="p">};</span>

<span class="cp">#define BUGFIX(model, sv, sd, pm, fn) { \</span>
<span class="cp">	.ident = model, \</span>
<span class="cp">	.subsystem_vendor = sv, \</span>
<span class="cp">	.subsystem_device = sd, \</span>
<span class="cp">	.pm_mode_modifier = pm, \</span>
<span class="cp">	.new_reinit_func  = fn  \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">radeon_device_id</span> <span class="n">radeon_workaround_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;IBM Thinkpad R32&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="mh">0x1905</span><span class="p">,</span>
	       <span class="n">radeon_pm_d2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;IBM Thinkpad R40&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="mh">0x0526</span><span class="p">,</span>
	       <span class="n">radeon_pm_d2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;IBM Thinkpad R40&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="mh">0x0527</span><span class="p">,</span>
	       <span class="n">radeon_pm_d2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;IBM Thinkpad R50/R51/T40/T41&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="mh">0x0531</span><span class="p">,</span>
	       <span class="n">radeon_pm_d2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;IBM Thinkpad R51/T40/T41/T42&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="mh">0x0530</span><span class="p">,</span>
	       <span class="n">radeon_pm_d2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;IBM Thinkpad T30&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="mh">0x0517</span><span class="p">,</span>
	       <span class="n">radeon_pm_d2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;IBM Thinkpad T40p&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="mh">0x054d</span><span class="p">,</span>
	       <span class="n">radeon_pm_d2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;IBM Thinkpad T42&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="mh">0x0550</span><span class="p">,</span>
	       <span class="n">radeon_pm_d2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;IBM Thinkpad X31/X32&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="mh">0x052f</span><span class="p">,</span>
	       <span class="n">radeon_pm_d2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;Samsung P35&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_SAMSUNG</span><span class="p">,</span> <span class="mh">0xc00c</span><span class="p">,</span>
	       <span class="n">radeon_pm_off</span><span class="p">,</span> <span class="n">radeon_reinitialize_M10</span><span class="p">),</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;Acer Aspire 2010&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_AI</span><span class="p">,</span> <span class="mh">0x0061</span><span class="p">,</span>
	       <span class="n">radeon_pm_off</span><span class="p">,</span> <span class="n">radeon_reinitialize_M10</span><span class="p">),</span>
	<span class="n">BUGFIX</span><span class="p">(</span><span class="s">&quot;Acer Travelmate 290D/292LMi&quot;</span><span class="p">,</span>
	       <span class="n">PCI_VENDOR_ID_AI</span><span class="p">,</span> <span class="mh">0x005a</span><span class="p">,</span>
	       <span class="n">radeon_pm_off</span><span class="p">,</span> <span class="n">radeon_reinitialize_M10</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_apply_workarounds</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="n">radeon_workaround_list</span><span class="p">;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span> <span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* we found a device that requires workaround */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;radeonfb: %s detected&quot;</span>
			       <span class="s">&quot;, enabling workaround</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>

			<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">|=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">pm_mode_modifier</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">new_reinit_func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">reinit_func</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">new_reinit_func</span><span class="p">;</span>

			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* not found */</span>
<span class="p">}</span>

<span class="cp">#else  </span><span class="cm">/* defined(CONFIG_PM) &amp;&amp; defined(CONFIG_X86) */</span><span class="cp"></span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">radeon_apply_workarounds</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* defined(CONFIG_PM) &amp;&amp; defined(CONFIG_X86) */</span><span class="cp"></span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_disable_dynamic_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* RV100 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV100</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">has_CRTC2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCLK_CNTL__DYN_STOP_LAT_MASK</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SCLK_CNTL__CP_MAX_DYN_STOP_LAT</span> <span class="o">|</span> <span class="n">SCLK_CNTL__FORCEON_MASK</span><span class="p">;</span>
			<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MCLK_CNTL__FORCE_MCLKA</span> <span class="o">|</span>
		        <span class="n">MCLK_CNTL__FORCE_MCLKB</span> <span class="o">|</span>
		        <span class="n">MCLK_CNTL__FORCE_YCLKA</span> <span class="o">|</span>
		        <span class="n">MCLK_CNTL__FORCE_YCLKB</span> <span class="o">|</span>
			<span class="n">MCLK_CNTL__FORCE_AIC</span> <span class="o">|</span>
			<span class="n">MCLK_CNTL__FORCE_MC</span><span class="p">);</span>
                <span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* R100 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">has_CRTC2</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>
                <span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SCLK_CNTL__FORCE_CP</span>	<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_HDP</span>	<span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_DISP1</span>	<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_TOP</span>	<span class="o">|</span>
                        <span class="n">SCLK_CNTL__FORCE_E2</span>	<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_SE</span> 	<span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_IDCT</span>	<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_VIP</span>	<span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_RE</span>	<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_PB</span> 	<span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_TAM</span>	<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_TDM</span>	<span class="o">|</span>
                        <span class="n">SCLK_CNTL__FORCE_RB</span><span class="p">);</span>
                <span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* RV350 (M10/M11) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV350</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* for RV350/M10/M11, no delays are required. */</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL2</span><span class="p">);</span>
                <span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SCLK_CNTL2__R300_FORCE_TCL</span> <span class="o">|</span>
                        <span class="n">SCLK_CNTL2__R300_FORCE_GA</span>  <span class="o">|</span>
			<span class="n">SCLK_CNTL2__R300_FORCE_CBA</span><span class="p">);</span>
                <span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>
                <span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SCLK_CNTL__FORCE_DISP2</span>		<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_CP</span>		<span class="o">|</span>
                        <span class="n">SCLK_CNTL__FORCE_HDP</span>		<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_DISP1</span>	<span class="o">|</span>
                        <span class="n">SCLK_CNTL__FORCE_TOP</span>		<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_E2</span>		<span class="o">|</span>
                        <span class="n">SCLK_CNTL__R300_FORCE_VAP</span>	<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_IDCT</span>    	<span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_VIP</span>		<span class="o">|</span> <span class="n">SCLK_CNTL__R300_FORCE_SR</span>	<span class="o">|</span>
			<span class="n">SCLK_CNTL__R300_FORCE_PX</span>	<span class="o">|</span> <span class="n">SCLK_CNTL__R300_FORCE_TX</span>	<span class="o">|</span>
			<span class="n">SCLK_CNTL__R300_FORCE_US</span>	<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_TV_SCLK</span>	<span class="o">|</span>
                        <span class="n">SCLK_CNTL__R300_FORCE_SU</span>	<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_OV0</span><span class="p">);</span>
                <span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SCLK_MORE_CNTL__FORCE_DISPREGS</span>	<span class="o">|</span> <span class="n">SCLK_MORE_CNTL__FORCE_MC_GUI</span>	<span class="o">|</span>
			<span class="n">SCLK_MORE_CNTL__FORCE_MC_HOST</span><span class="p">);</span>
                <span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MCLK_CNTL__FORCE_MCLKA</span> <span class="o">|</span>
		        <span class="n">MCLK_CNTL__FORCE_MCLKB</span> <span class="o">|</span>
		        <span class="n">MCLK_CNTL__FORCE_YCLKA</span> <span class="o">|</span>
		        <span class="n">MCLK_CNTL__FORCE_YCLKB</span> <span class="o">|</span>
			<span class="n">MCLK_CNTL__FORCE_MC</span><span class="p">);</span>
                <span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">);</span>
                <span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VCLK_ECP_CNTL__PIXCLK_ALWAYS_ONb</span>  <span class="o">|</span>
                         <span class="n">VCLK_ECP_CNTL__PIXCLK_DAC_ALWAYS_ONb</span> <span class="o">|</span>
			 <span class="n">VCLK_ECP_CNTL__R300_DISP_DAC_PIXCLK_DAC_BLANK_OFF</span><span class="p">);</span>
                <span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">);</span>
                <span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PIXCLKS_CNTL__PIX2CLK_ALWAYS_ONb</span>		<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__PIX2CLK_DAC_ALWAYS_ONb</span>		<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__DISP_TVOUT_PIXCLK_TV_ALWAYS_ONb</span>	<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__R300_DVOCLK_ALWAYS_ONb</span>		<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__PIXCLK_BLEND_ALWAYS_ONb</span>		<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__PIXCLK_GV_ALWAYS_ONb</span>		<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__R300_PIXCLK_DVO_ALWAYS_ONb</span>	<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__PIXCLK_LVDS_ALWAYS_ONb</span>		<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__PIXCLK_TMDS_ALWAYS_ONb</span>		<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__R300_PIXCLK_TRANS_ALWAYS_ONb</span>	<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__R300_PIXCLK_TVO_ALWAYS_ONb</span>	<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__R300_P2G2CLK_ALWAYS_ONb</span>		<span class="o">|</span>
			 <span class="n">PIXCLKS_CNTL__R300_DISP_DAC_PIXCLK_DAC2_BLANK_OFF</span><span class="p">);</span>
                <span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* Default */</span>

	<span class="cm">/* Force Core Clocks */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SCLK_CNTL__FORCE_CP</span> <span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_E2</span><span class="p">);</span>

	<span class="cm">/* XFree doesn&#39;t do that case, but we had this code from Apple and it</span>
<span class="cm">	 * seem necessary for proper suspend/resume operations</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">|=</span> 	<span class="n">SCLK_CNTL__FORCE_HDP</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_DISP1</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_DISP2</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_TOP</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_SE</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_IDCT</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_VIP</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_PB</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_RE</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_TAM</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_TDM</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_RB</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_TV_SCLK</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_SUBPIC</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_OV0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_R300</span> <span class="o">||</span>
		   <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_R350</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">|=</span>  <span class="n">SCLK_CNTL__FORCE_HDP</span>   <span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_DISP1</span> <span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_DISP2</span> <span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_TOP</span>   <span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_IDCT</span>  <span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_VIP</span><span class="p">;</span>
	<span class="p">}</span>
    	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_R300</span> <span class="o">||</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_R350</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL2</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span>  <span class="n">SCLK_CNTL2__R300_FORCE_TCL</span> <span class="o">|</span>
			<span class="n">SCLK_CNTL2__R300_FORCE_GA</span>  <span class="o">|</span>
			<span class="n">SCLK_CNTL2__R300_FORCE_CBA</span><span class="p">;</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllCLK_PIN_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLK_PIN_CNTL__SCLK_DYN_START_CNTL</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllCLK_PIN_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_IGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Weird  ... X is _un_ forcing clocks here, I think it&#39;s</span>
<span class="cm">		 * doing backward. Imitate it for now...</span>
<span class="cm">		 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MCLK_CNTL__FORCE_MCLKA</span> <span class="o">|</span>
			 <span class="n">MCLK_CNTL__FORCE_YCLKA</span><span class="p">);</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Hrm... same shit, X doesn&#39;t do that but I have to */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MCLK_CNTL__FORCE_MCLKA</span> <span class="o">|</span>
			<span class="n">MCLK_CNTL__FORCE_MCLKB</span> <span class="o">|</span>
			<span class="n">MCLK_CNTL__FORCE_YCLKA</span> <span class="o">|</span>
			<span class="n">MCLK_CNTL__FORCE_YCLKB</span><span class="p">);</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_MISC</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> 	<span class="o">~</span><span class="p">(</span><span class="n">MCLK_MISC__MC_MCLK_MAX_DYN_STOP_LAT</span><span class="o">|</span>
			  <span class="n">MCLK_MISC__IO_MCLK_MAX_DYN_STOP_LAT</span><span class="o">|</span>
			  <span class="n">MCLK_MISC__MC_MCLK_DYN_ENABLE</span><span class="o">|</span>
			  <span class="n">MCLK_MISC__IO_MCLK_DYN_ENABLE</span><span class="p">);</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_MISC</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> 	<span class="n">SCLK_MORE_CNTL__FORCE_DISPREGS</span><span class="o">|</span>
			<span class="n">SCLK_MORE_CNTL__FORCE_MC_GUI</span><span class="o">|</span>
			<span class="n">SCLK_MORE_CNTL__FORCE_MC_HOST</span><span class="p">;</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PIXCLKS_CNTL__PIXCLK_GV_ALWAYS_ONb</span> <span class="o">|</span>
		 <span class="n">PIXCLKS_CNTL__PIXCLK_BLEND_ALWAYS_ONb</span><span class="o">|</span>
		 <span class="n">PIXCLKS_CNTL__PIXCLK_DIG_TMDS_ALWAYS_ONb</span> <span class="o">|</span>
		 <span class="n">PIXCLKS_CNTL__PIXCLK_LVDS_ALWAYS_ONb</span><span class="o">|</span>
		 <span class="n">PIXCLKS_CNTL__PIXCLK_TMDS_ALWAYS_ONb</span><span class="o">|</span>
		 <span class="n">PIXCLKS_CNTL__PIX2CLK_ALWAYS_ONb</span><span class="o">|</span>
		 <span class="n">PIXCLKS_CNTL__PIX2CLK_DAC_ALWAYS_ONb</span><span class="p">);</span>
 	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllVCLK_ECP_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VCLK_ECP_CNTL__PIXCLK_ALWAYS_ONb</span> <span class="o">|</span>
		 <span class="n">VCLK_ECP_CNTL__PIXCLK_DAC_ALWAYS_ONb</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllVCLK_ECP_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_enable_dynamic_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* R100 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">has_CRTC2</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">INREG</span><span class="p">(</span><span class="n">CNFG_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CFG_ATI_REV_ID_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CFG_ATI_REV_A13</span><span class="p">)</span>
                    <span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCLK_CNTL__FORCE_CP</span>	<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_RB</span><span class="p">);</span>
                <span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCLK_CNTL__FORCE_HDP</span>		<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_DISP1</span> <span class="o">|</span>
			 <span class="n">SCLK_CNTL__FORCE_TOP</span>		<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_SE</span>   <span class="o">|</span>
			 <span class="n">SCLK_CNTL__FORCE_IDCT</span>		<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_RE</span>   <span class="o">|</span>
			 <span class="n">SCLK_CNTL__FORCE_PB</span>		<span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_TAM</span>  <span class="o">|</span>
			 <span class="n">SCLK_CNTL__FORCE_TDM</span><span class="p">);</span>
                <span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* M10/M11 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV350</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL2</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCLK_CNTL2__R300_FORCE_TCL</span> <span class="o">|</span>
			 <span class="n">SCLK_CNTL2__R300_FORCE_GA</span>  <span class="o">|</span>
			 <span class="n">SCLK_CNTL2__R300_FORCE_CBA</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">SCLK_CNTL2__R300_TCL_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
			 <span class="n">SCLK_CNTL2__R300_GA_MAX_DYN_STOP_LAT</span>  <span class="o">|</span>
			 <span class="n">SCLK_CNTL2__R300_CBA_MAX_DYN_STOP_LAT</span><span class="p">);</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCLK_CNTL__FORCE_DISP2</span> <span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_CP</span>      <span class="o">|</span>
			 <span class="n">SCLK_CNTL__FORCE_HDP</span>   <span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_DISP1</span>   <span class="o">|</span>
			 <span class="n">SCLK_CNTL__FORCE_TOP</span>   <span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_E2</span>      <span class="o">|</span>
			 <span class="n">SCLK_CNTL__R300_FORCE_VAP</span> <span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_IDCT</span> <span class="o">|</span>
			 <span class="n">SCLK_CNTL__FORCE_VIP</span>   <span class="o">|</span> <span class="n">SCLK_CNTL__R300_FORCE_SR</span> <span class="o">|</span>
			 <span class="n">SCLK_CNTL__R300_FORCE_PX</span> <span class="o">|</span> <span class="n">SCLK_CNTL__R300_FORCE_TX</span> <span class="o">|</span>
			 <span class="n">SCLK_CNTL__R300_FORCE_US</span> <span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_TV_SCLK</span> <span class="o">|</span>
			 <span class="n">SCLK_CNTL__R300_FORCE_SU</span> <span class="o">|</span> <span class="n">SCLK_CNTL__FORCE_OV0</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SCLK_CNTL__DYN_STOP_LAT_MASK</span><span class="p">;</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCLK_MORE_CNTL__FORCEON</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span>  <span class="n">SCLK_MORE_CNTL__DISPREGS_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
			<span class="n">SCLK_MORE_CNTL__MC_GUI_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
			<span class="n">SCLK_MORE_CNTL__MC_HOST_MAX_DYN_STOP_LAT</span><span class="p">;</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VCLK_ECP_CNTL__PIXCLK_ALWAYS_ONb</span> <span class="o">|</span>
			<span class="n">VCLK_ECP_CNTL__PIXCLK_DAC_ALWAYS_ONb</span><span class="p">);</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PIXCLKS_CNTL__PIX2CLK_ALWAYS_ONb</span>         <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__PIX2CLK_DAC_ALWAYS_ONb</span>     <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__DISP_TVOUT_PIXCLK_TV_ALWAYS_ONb</span> <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__R300_DVOCLK_ALWAYS_ONb</span>            <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__PIXCLK_BLEND_ALWAYS_ONb</span>    <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__PIXCLK_GV_ALWAYS_ONb</span>       <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__R300_PIXCLK_DVO_ALWAYS_ONb</span>        <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__PIXCLK_LVDS_ALWAYS_ONb</span>     <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__PIXCLK_TMDS_ALWAYS_ONb</span>     <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__R300_PIXCLK_TRANS_ALWAYS_ONb</span>      <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__R300_PIXCLK_TVO_ALWAYS_ONb</span>        <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__R300_P2G2CLK_ALWAYS_ONb</span>           <span class="o">|</span>
			<span class="n">PIXCLKS_CNTL__R300_P2G2CLK_DAC_ALWAYS_ONb</span><span class="p">);</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_MISC</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MCLK_MISC__MC_MCLK_DYN_ENABLE</span> <span class="o">|</span>
			<span class="n">MCLK_MISC__IO_MCLK_DYN_ENABLE</span><span class="p">);</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_MISC</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MCLK_CNTL__FORCE_MCLKA</span> <span class="o">|</span> <span class="n">MCLK_CNTL__FORCE_MCLKB</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MCLK_CNTL__FORCE_YCLKA</span>  <span class="o">|</span>
			 <span class="n">MCLK_CNTL__FORCE_YCLKB</span>  <span class="o">|</span>
			 <span class="n">MCLK_CNTL__FORCE_MC</span><span class="p">);</span>

		<span class="cm">/* Some releases of vbios have set DISABLE_MC_MCLKA</span>
<span class="cm">		 * and DISABLE_MC_MCLKB bits in the vbios table.  Setting these</span>
<span class="cm">		 * bits will cause H/W hang when reading video memory with dynamic</span>
<span class="cm">		 * clocking enabled.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MCLK_CNTL__R300_DISABLE_MC_MCLKA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MCLK_CNTL__R300_DISABLE_MC_MCLKB</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* If both bits are set, then check the active channels */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">vram_width</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			    <span class="k">if</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">R300_MEM_USE_CD_CH_ONLY</span><span class="p">)</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCLK_CNTL__R300_DISABLE_MC_MCLKB</span><span class="p">;</span>
			    <span class="k">else</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCLK_CNTL__R300_DISABLE_MC_MCLKA</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			    <span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MCLK_CNTL__R300_DISABLE_MC_MCLKA</span> <span class="o">|</span>
				     <span class="n">MCLK_CNTL__R300_DISABLE_MC_MCLKB</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* R300 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_R300</span> <span class="o">||</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_R350</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCLK_CNTL__R300_FORCE_VAP</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SCLK_CNTL__FORCE_CP</span><span class="p">;</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL2</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCLK_CNTL2__R300_FORCE_TCL</span> <span class="o">|</span>
			 <span class="n">SCLK_CNTL2__R300_FORCE_GA</span>  <span class="o">|</span>
			 <span class="n">SCLK_CNTL2__R300_FORCE_CBA</span><span class="p">);</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Others */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllCLK_PWRMGT_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CLK_PWRMGT_CNTL__ACTIVE_HILO_LAT_MASK</span><span class="o">|</span>
		 <span class="n">CLK_PWRMGT_CNTL__DISP_DYN_STOP_LAT_MASK</span><span class="o">|</span>
		 <span class="n">CLK_PWRMGT_CNTL__DYN_STOP_MODE_MASK</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CLK_PWRMGT_CNTL__ENGINE_DYNCLK_MODE_MASK</span> <span class="o">|</span>
	       <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">CLK_PWRMGT_CNTL__ACTIVE_HILO_LAT__SHIFT</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllCLK_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllCLK_PIN_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CLK_PIN_CNTL__SCLK_DYN_START_CNTL</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllCLK_PIN_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

	<span class="cm">/* When DRI is enabled, setting DYN_STOP_LAT to zero can cause some R200</span>
<span class="cm">	 * to lockup randomly, leave them as set by BIOS.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCLK_CNTL__FORCEON_MASK</span><span class="p">;</span>

	<span class="cm">/*RAGE_6::A11 A12 A12N1 A13, RV250::A11 A12, R300*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV250</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">INREG</span><span class="p">(</span><span class="n">CNFG_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CFG_ATI_REV_ID_MASK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CFG_ATI_REV_A13</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV100</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">INREG</span><span class="p">(</span><span class="n">CNFG_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CFG_ATI_REV_ID_MASK</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">CFG_ATI_REV_A13</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SCLK_CNTL__FORCE_CP</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SCLK_CNTL__FORCE_VIP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV200</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV250</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV280</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCLK_MORE_CNTL__FORCEON</span><span class="p">;</span>

		<span class="cm">/* RV200::A11 A12 RV250::A11 A12 */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV200</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV250</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">INREG</span><span class="p">(</span><span class="n">CNFG_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CFG_ATI_REV_ID_MASK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CFG_ATI_REV_A13</span><span class="p">))</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SCLK_MORE_CNTL__FORCEON</span><span class="p">;</span>

		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>
	

	<span class="cm">/* RV200::A11 A12, RV250::A11 A12 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV200</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV250</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">INREG</span><span class="p">(</span><span class="n">CNFG_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CFG_ATI_REV_ID_MASK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CFG_ATI_REV_A13</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPLL_PWRMGT_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PLL_PWRMGT_CNTL__TCL_BYPASS_DISABLE</span><span class="p">;</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPLL_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span>  <span class="n">PIXCLKS_CNTL__PIX2CLK_ALWAYS_ONb</span> <span class="o">|</span>
		<span class="n">PIXCLKS_CNTL__PIX2CLK_DAC_ALWAYS_ONb</span><span class="o">|</span>
		<span class="n">PIXCLKS_CNTL__PIXCLK_BLEND_ALWAYS_ONb</span><span class="o">|</span>
		<span class="n">PIXCLKS_CNTL__PIXCLK_GV_ALWAYS_ONb</span><span class="o">|</span>
		<span class="n">PIXCLKS_CNTL__PIXCLK_DIG_TMDS_ALWAYS_ONb</span><span class="o">|</span>
		<span class="n">PIXCLKS_CNTL__PIXCLK_LVDS_ALWAYS_ONb</span><span class="o">|</span>
		<span class="n">PIXCLKS_CNTL__PIXCLK_TMDS_ALWAYS_ONb</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
		
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span>  <span class="n">VCLK_ECP_CNTL__PIXCLK_ALWAYS_ONb</span> <span class="o">|</span>
		<span class="n">VCLK_ECP_CNTL__PIXCLK_DAC_ALWAYS_ONb</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* X doesn&#39;t do that ... hrm, we do on mobility &amp;&amp; Macs */</span>
<span class="cp">#ifdef CONFIG_PPC_OF</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span>  <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MCLK_CNTL__FORCE_MCLKA</span> <span class="o">|</span>
			 <span class="n">MCLK_CNTL__FORCE_MCLKB</span> <span class="o">|</span>
			 <span class="n">MCLK_CNTL__FORCE_YCLKA</span> <span class="o">|</span>
			 <span class="n">MCLK_CNTL__FORCE_YCLKB</span><span class="p">);</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_MISC</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> 	<span class="n">MCLK_MISC__MC_MCLK_MAX_DYN_STOP_LAT</span><span class="o">|</span>
			<span class="n">MCLK_MISC__IO_MCLK_MAX_DYN_STOP_LAT</span><span class="o">|</span>
			<span class="n">MCLK_MISC__MC_MCLK_DYN_ENABLE</span><span class="o">|</span>
			<span class="n">MCLK_MISC__IO_MCLK_DYN_ENABLE</span><span class="p">;</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_MISC</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">radeon_msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_OF */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">OUTMC</span><span class="p">(</span> <span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">indx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MC_IND_INDEX</span><span class="p">,</span> <span class="n">indx</span> <span class="o">|</span> <span class="n">MC_IND_INDEX__MC_IND_WR_EN</span><span class="p">);</span>	
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MC_IND_DATA</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>		
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">INMC</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">indx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MC_IND_INDEX</span><span class="p">,</span> <span class="n">indx</span><span class="p">);</span>					
	<span class="k">return</span> <span class="n">INREG</span><span class="p">(</span> <span class="n">MC_IND_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_save_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">saving_for_d3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">PLL_PWRMGT_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">CLK_PWRMGT_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">MCLK_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">SCLK_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">CLK_PIN_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">VCLK_ECP_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">PIXCLKS_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">MCLK_MISC</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">P2PLL_CNTL</span><span class="p">);</span>
	
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DISP_MISC_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DISP_PWR_MAN</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CRTC_OFFSET_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">AGP_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfdffffff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04000000</span><span class="p">;</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">CRTC2_GEN_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfdffffff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04000000</span><span class="p">;</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">GPIOPAD_A</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">GPIOPAD_EN</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">GPIOPAD_MASK</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">ZV_LCDPAD_A</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">ZV_LCDPAD_EN</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">ZV_LCDPAD_MASK</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">GPIO_VGA_DDC</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">GPIO_DVI_DDC</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">GPIO_MONID</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">GPIO_CRT2_DDC</span><span class="p">);</span>

	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">SURFACE_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MC_FB_LOCATION</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DISPLAY_BASE_ADDR</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MC_AGP_LOCATION</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CRTC2_DISPLAY_BASE_ADDR</span><span class="p">);</span>

	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">SCLK_MORE_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MEM_SDRAM_MODE_REG</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">RBBM_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">HOST_PATH_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MPP_TB_CONFIG</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">FCP_CNTL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_PLL_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSSPLL_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSSPLL_REF_DIV</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSSPLL_DIV_0</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">90</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSS_INT_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">91</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSS_TST_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">81</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_FAMILY_RV200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MEM_REFRESH_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MC_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">47</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MC_INIT_GFX_LAT_TIMER</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MC_INIT_MISC_LAT_TIMER</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">49</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MC_TIMING_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MC_READ_CNTL_AB</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MC_IOPAD_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">52</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MC_CHIP_IO_OE_CNTL_AB</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MC_DEBUG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">54</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PAMAC0_DLY_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">55</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PAMAC1_DLY_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PAD_CTLR_MISC</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">FW_CNTL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_FAMILY_R300</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">58</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_MC_INIT_WR_LAT_TIMER</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">59</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_IMP_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">60</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_C0</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">61</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_C1</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">62</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_D0</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">63</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_D1</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_BIST_CNTL_3</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">65</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_A0</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">66</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_A1</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">67</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_B0</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">68</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_B1</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">69</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_DEBUG_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">70</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_DLL_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">71</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_IMP_CNTL_0</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">72</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_ELPIDA_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">96</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_READ_CNTL_CD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">59</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_IMP_CNTL</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">65</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_A0</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">66</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_A1</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">67</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_B0</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">68</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_B1</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">71</span><span class="p">]</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_IMP_CNTL_0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">73</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">74</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">75</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMPLL_AUX_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">76</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSPLL_AUX_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">77</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllM_SPLL_REF_FB_DIV</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">78</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllAGP_PLL_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">79</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PAMAC2_DLY_CNTL</span><span class="p">);</span>

	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">80</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">OV0_BASE_ADDR</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">82</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">FP_GEN_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">83</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">FP2_GEN_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">84</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">TMDS_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">85</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">TMDS_TRANSMITTER_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">86</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DISP_OUTPUT_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">87</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DISP_HW_DEBUG</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">88</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">TV_MASTER_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">89</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllP2PLL_REF_DIV</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">92</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPPLL_DIV_0</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">93</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPPLL_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">94</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">GRPH_BUFFER_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">95</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">GRPH2_BUFFER_CNTL</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">96</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">HDP_DEBUG</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">97</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMDLL_CKO</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">98</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKA</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">99</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKB</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_restore_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">P2PLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFE</span><span class="p">);</span> <span class="cm">/* First */</span>
	
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">PLL_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">CLK_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">MCLK_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">SCLK_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">CLK_PIN_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">VCLK_ECP_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">PIXCLKS_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">MCLK_MISC</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV350</span><span class="p">)</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">SCLK_MORE_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">34</span><span class="p">]);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">SURFACE_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">29</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_FB_LOCATION</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">30</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DISPLAY_BASE_ADDR</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">31</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_AGP_LOCATION</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">32</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CRTC2_DISPLAY_BASE_ADDR</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">33</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CNFG_MEMSIZE</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">video_ram</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DISP_MISC_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DISP_PWR_MAN</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_PLL_CNTL</span><span class="p">,</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CRTC_OFFSET_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">AGP_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CRTC2_GEN_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">18</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">P2PLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_A</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">19</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_EN</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_MASK</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">ZV_LCDPAD_A</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">22</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">ZV_LCDPAD_EN</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">23</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">ZV_LCDPAD_MASK</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">24</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIO_VGA_DDC</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">25</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIO_DVI_DDC</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">26</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIO_MONID</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">27</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIO_CRT2_DDC</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">28</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_disable_iopad</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>		
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_MASK</span><span class="p">,</span> <span class="mh">0x0001ffff</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_EN</span><span class="p">,</span> <span class="mh">0x00000400</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_A</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>		
        <span class="n">OUTREG</span><span class="p">(</span><span class="n">ZV_LCDPAD_MASK</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
        <span class="n">OUTREG</span><span class="p">(</span><span class="n">ZV_LCDPAD_EN</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
      	<span class="n">OUTREG</span><span class="p">(</span><span class="n">ZV_LCDPAD_A</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span> 	
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIO_VGA_DDC</span><span class="p">,</span> <span class="mh">0x00030000</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIO_DVI_DDC</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIO_MONID</span><span class="p">,</span> <span class="mh">0x00030000</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIO_CRT2_DDC</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_program_v2clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set v2clk to 65MHz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;=</span> <span class="n">CHIP_FAMILY_RV280</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">,</span>
			 <span class="n">__INPLL</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">pllPIXCLKS_CNTL</span><span class="p">)</span>
			 <span class="o">&amp;</span> <span class="o">~</span><span class="n">PIXCLKS_CNTL__PIX2CLK_SRC_SEL_MASK</span><span class="p">);</span>
	 
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllP2PLL_REF_DIV</span><span class="p">,</span> <span class="mh">0x0000000c</span><span class="p">);</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllP2PLL_CNTL</span><span class="p">,</span> <span class="mh">0x0000bf00</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllP2PLL_REF_DIV</span><span class="p">,</span> <span class="mh">0x0000000c</span><span class="p">);</span>
		<span class="n">INPLL</span><span class="p">(</span><span class="n">pllP2PLL_REF_DIV</span><span class="p">);</span>
		<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllP2PLL_CNTL</span><span class="p">,</span> <span class="mh">0x0000a700</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllP2PLL_DIV_0</span><span class="p">,</span> <span class="mh">0x00020074</span> <span class="o">|</span> <span class="n">P2PLL_DIV_0__P2PLL_ATOMIC_UPDATE_W</span><span class="p">);</span>
	
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllP2PLL_CNTL</span><span class="p">,</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllP2PLL_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">P2PLL_CNTL__P2PLL_SLEEP</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllP2PLL_CNTL</span><span class="p">,</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllP2PLL_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">P2PLL_CNTL__P2PLL_RESET</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span> <span class="mi">1</span><span class="p">);</span>

  	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">,</span>
  		<span class="p">(</span><span class="n">INPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PIXCLKS_CNTL__PIX2CLK_SRC_SEL_MASK</span><span class="p">)</span>
  		<span class="o">|</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="n">PIXCLKS_CNTL__PIX2CLK_SRC_SEL__SHIFT</span><span class="p">));</span>
	<span class="n">mdelay</span><span class="p">(</span> <span class="mi">1</span><span class="p">);</span>	
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_low_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span>  <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;=</span> <span class="n">CHIP_FAMILY_RV280</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BUS_CNTL1_MOBILE_PLATFORM_SEL_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">BUS_CNTL1_AGPCLK_VALID</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">BUS_CNTL1_MOBILE_PLATFORM_SEL_SHIFT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x4080</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	
	<span class="n">reg</span>  <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">PLL_PWRMGT_CNTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">PLL_PWRMGT_CNTL_SPLL_TURNOFF</span> <span class="o">|</span> <span class="n">PLL_PWRMGT_CNTL_PPLL_TURNOFF</span> <span class="o">|</span>
		<span class="n">PLL_PWRMGT_CNTL_P2PLL_TURNOFF</span> <span class="o">|</span> <span class="n">PLL_PWRMGT_CNTL_TVPLL_TURNOFF</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLL_PWRMGT_CNTL_SU_MCLK_USE_BCLK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLL_PWRMGT_CNTL_MOBILE_SU</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">PLL_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	
	<span class="n">reg</span>  <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TV_DAC_CNTL_BGADJ_MASK</span> <span class="o">|</span><span class="n">TV_DAC_CNTL_DACADJ_MASK</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span><span class="n">TV_DAC_CNTL_BGSLEEP</span> <span class="o">|</span> <span class="n">TV_DAC_CNTL_RDACPD</span> <span class="o">|</span> <span class="n">TV_DAC_CNTL_GDACPD</span> <span class="o">|</span>
		<span class="n">TV_DAC_CNTL_BDACPD</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">8</span><span class="o">&lt;&lt;</span><span class="n">TV_DAC_CNTL_BGADJ__SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8</span><span class="o">&lt;&lt;</span><span class="n">TV_DAC_CNTL_DACADJ__SHIFT</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	
	<span class="n">reg</span>  <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">TMDS_TRANSMITTER_CNTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TMDS_PLL_EN</span> <span class="o">|</span> <span class="n">TMDS_PLLRST</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">TMDS_TRANSMITTER_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAC_CMP_EN</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DAC2_CMP_EN</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	
	<span class="n">reg</span>  <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TV_DAC_CNTL_DETECT</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_setup_for_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u32</span> <span class="n">sclk_cntl</span><span class="p">,</span> <span class="n">mclk_cntl</span><span class="p">,</span> <span class="n">sclk_more_cntl</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pll_pwrmgt_cntl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clk_pwrmgt_cntl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clk_pin_cntl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vclk_ecp_cntl</span><span class="p">;</span> 
	<span class="n">u32</span> <span class="n">pixclks_cntl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">disp_mis_cntl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">disp_pwr_man</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	
	<span class="cm">/* Force Core Clocks */</span>
	<span class="n">sclk_cntl</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllSCLK_CNTL</span><span class="p">);</span>
	<span class="n">sclk_cntl</span> <span class="o">|=</span> 	<span class="n">SCLK_CNTL__IDCT_MAX_DYN_STOP_LAT</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__VIP_MAX_DYN_STOP_LAT</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__RE_MAX_DYN_STOP_LAT</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__PB_MAX_DYN_STOP_LAT</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__TAM_MAX_DYN_STOP_LAT</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__TDM_MAX_DYN_STOP_LAT</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__RB_MAX_DYN_STOP_LAT</span><span class="o">|</span>
			
			<span class="n">SCLK_CNTL__FORCE_DISP2</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_CP</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_HDP</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_DISP1</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_TOP</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_E2</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_SE</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_IDCT</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_VIP</span><span class="o">|</span>
			
			<span class="n">SCLK_CNTL__FORCE_PB</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_TAM</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_TDM</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_RB</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_TV_SCLK</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_SUBPIC</span><span class="o">|</span>
			<span class="n">SCLK_CNTL__FORCE_OV0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;=</span> <span class="n">CHIP_FAMILY_RV280</span><span class="p">)</span>
		<span class="n">sclk_cntl</span> <span class="o">|=</span> <span class="n">SCLK_CNTL__FORCE_RE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sclk_cntl</span> <span class="o">|=</span> <span class="n">SCLK_CNTL__SE_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
			<span class="n">SCLK_CNTL__E2_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
			<span class="n">SCLK_CNTL__TV_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
			<span class="n">SCLK_CNTL__HDP_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
			<span class="n">SCLK_CNTL__CP_MAX_DYN_STOP_LAT</span><span class="p">;</span>

	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">sclk_cntl</span><span class="p">);</span>

	<span class="n">sclk_more_cntl</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">);</span>
	<span class="n">sclk_more_cntl</span> <span class="o">|=</span> 	<span class="n">SCLK_MORE_CNTL__FORCE_DISPREGS</span> <span class="o">|</span>
				<span class="n">SCLK_MORE_CNTL__FORCE_MC_GUI</span> <span class="o">|</span>
				<span class="n">SCLK_MORE_CNTL__FORCE_MC_HOST</span><span class="p">;</span>

	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">,</span> <span class="n">sclk_more_cntl</span><span class="p">);</span>		

	
	<span class="n">mclk_cntl</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllMCLK_CNTL</span><span class="p">);</span>
	<span class="n">mclk_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span>	<span class="n">MCLK_CNTL__FORCE_MCLKA</span> <span class="o">|</span>
			<span class="n">MCLK_CNTL__FORCE_MCLKB</span> <span class="o">|</span>
			<span class="n">MCLK_CNTL__FORCE_YCLKA</span> <span class="o">|</span>
			<span class="n">MCLK_CNTL__FORCE_YCLKB</span> <span class="o">|</span>
			<span class="n">MCLK_CNTL__FORCE_MC</span>
		      <span class="p">);</span>	
    	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllMCLK_CNTL</span><span class="p">,</span> <span class="n">mclk_cntl</span><span class="p">);</span>
	
	<span class="cm">/* Force Display clocks	*/</span>
	<span class="n">vclk_ecp_cntl</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllVCLK_ECP_CNTL</span><span class="p">);</span>
	<span class="n">vclk_ecp_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VCLK_ECP_CNTL__PIXCLK_ALWAYS_ONb</span>
			   <span class="o">|</span> <span class="n">VCLK_ECP_CNTL__PIXCLK_DAC_ALWAYS_ONb</span><span class="p">);</span>
	<span class="n">vclk_ecp_cntl</span> <span class="o">|=</span> <span class="n">VCLK_ECP_CNTL__ECP_FORCE_ON</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllVCLK_ECP_CNTL</span><span class="p">,</span> <span class="n">vclk_ecp_cntl</span><span class="p">);</span>
	
	
	<span class="n">pixclks_cntl</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllPIXCLKS_CNTL</span><span class="p">);</span>
	<span class="n">pixclks_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span>	<span class="n">PIXCLKS_CNTL__PIXCLK_GV_ALWAYS_ONb</span> <span class="o">|</span> 
				<span class="n">PIXCLKS_CNTL__PIXCLK_BLEND_ALWAYS_ONb</span><span class="o">|</span>
				<span class="n">PIXCLKS_CNTL__PIXCLK_DIG_TMDS_ALWAYS_ONb</span> <span class="o">|</span>
				<span class="n">PIXCLKS_CNTL__PIXCLK_LVDS_ALWAYS_ONb</span><span class="o">|</span>
				<span class="n">PIXCLKS_CNTL__PIXCLK_TMDS_ALWAYS_ONb</span><span class="o">|</span>
				<span class="n">PIXCLKS_CNTL__PIX2CLK_ALWAYS_ONb</span><span class="o">|</span>
				<span class="n">PIXCLKS_CNTL__PIX2CLK_DAC_ALWAYS_ONb</span><span class="p">);</span>
						
 	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllPIXCLKS_CNTL</span><span class="p">,</span> <span class="n">pixclks_cntl</span><span class="p">);</span>

	<span class="cm">/* Switch off LVDS interface */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">)</span> <span class="o">&amp;</span>
	       <span class="o">~</span><span class="p">(</span><span class="n">LVDS_BLON</span> <span class="o">|</span> <span class="n">LVDS_EN</span> <span class="o">|</span> <span class="n">LVDS_ON</span> <span class="o">|</span> <span class="n">LVDS_DIGON</span><span class="p">));</span>

	<span class="cm">/* Enable System power management */</span>
	<span class="n">pll_pwrmgt_cntl</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllPLL_PWRMGT_CNTL</span><span class="p">);</span>
	
	<span class="n">pll_pwrmgt_cntl</span> <span class="o">|=</span> 	<span class="n">PLL_PWRMGT_CNTL__SPLL_TURNOFF</span> <span class="o">|</span>
				<span class="n">PLL_PWRMGT_CNTL__MPLL_TURNOFF</span><span class="o">|</span>
				<span class="n">PLL_PWRMGT_CNTL__PPLL_TURNOFF</span><span class="o">|</span>
				<span class="n">PLL_PWRMGT_CNTL__P2PLL_TURNOFF</span><span class="o">|</span>
				<span class="n">PLL_PWRMGT_CNTL__TVPLL_TURNOFF</span><span class="p">;</span>
						
	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllPLL_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">pll_pwrmgt_cntl</span><span class="p">);</span>
	
	<span class="n">clk_pwrmgt_cntl</span>	 <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllCLK_PWRMGT_CNTL</span><span class="p">);</span>
	
	<span class="n">clk_pwrmgt_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span>	<span class="n">CLK_PWRMGT_CNTL__MPLL_PWRMGT_OFF</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__SPLL_PWRMGT_OFF</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__PPLL_PWRMGT_OFF</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__P2PLL_PWRMGT_OFF</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__MCLK_TURNOFF</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__SCLK_TURNOFF</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__PCLK_TURNOFF</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__P2CLK_TURNOFF</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__TVPLL_PWRMGT_OFF</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__GLOBAL_PMAN_EN</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__ENGINE_DYNCLK_MODE</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__ACTIVE_HILO_LAT_MASK</span><span class="o">|</span>
				<span class="n">CLK_PWRMGT_CNTL__CG_NO1_DEBUG_MASK</span>
			<span class="p">);</span>
						
	<span class="n">clk_pwrmgt_cntl</span> <span class="o">|=</span> <span class="n">CLK_PWRMGT_CNTL__GLOBAL_PMAN_EN</span>
		<span class="o">|</span> <span class="n">CLK_PWRMGT_CNTL__DISP_PM</span><span class="p">;</span>
	
	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllCLK_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">clk_pwrmgt_cntl</span><span class="p">);</span>
	
	<span class="n">clk_pin_cntl</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllCLK_PIN_CNTL</span><span class="p">);</span>
	
	<span class="n">clk_pin_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLK_PIN_CNTL__ACCESS_REGS_IN_SUSPEND</span><span class="p">;</span>

	<span class="cm">/* because both INPLL and OUTPLL take the same lock, that&#39;s why. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllMCLK_MISC</span><span class="p">)</span> <span class="o">|</span> <span class="n">MCLK_MISC__EN_MCLK_TRISTATE_IN_SUSPEND</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllMCLK_MISC</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* BUS_CNTL1__MOBILE_PLATORM_SEL setting is northbridge chipset</span>
<span class="cm">	 * and radeon chip dependent. Thus we only enable it on Mac for</span>
<span class="cm">	 * now (until we get more info on how to compute the correct</span>
<span class="cm">	 * value for various X86 bridges).</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* AGP PLL control */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;=</span> <span class="n">CHIP_FAMILY_RV280</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">)</span> <span class="o">|</span>  <span class="n">BUS_CNTL1__AGPCLK_VALID</span><span class="p">);</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BUS_CNTL1__MOBILE_PLATFORM_SEL_MASK</span><span class="p">)</span>
			       <span class="o">|</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="n">BUS_CNTL1__MOBILE_PLATFORM_SEL__SHIFT</span><span class="p">));</span>	<span class="c1">// 440BX</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">));</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">,</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x4000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CRTC_OFFSET_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">CRTC_OFFSET_CNTL</span><span class="p">)</span>
				  <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRTC_OFFSET_CNTL__CRTC_STEREO_SYNC_OUT_EN</span><span class="p">));</span>
	
	<span class="n">clk_pin_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLK_PIN_CNTL__CG_CLK_TO_OUTPIN</span><span class="p">;</span>
	<span class="n">clk_pin_cntl</span> <span class="o">|=</span> <span class="n">CLK_PIN_CNTL__XTALIN_ALWAYS_ONb</span><span class="p">;</span>	
	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllCLK_PIN_CNTL</span><span class="p">,</span> <span class="n">clk_pin_cntl</span><span class="p">);</span>

	<span class="cm">/* Solano2M */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">AGP_CNTL</span><span class="p">,</span>
		<span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">AGP_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">AGP_CNTL__MAX_IDLE_CLK_MASK</span><span class="p">))</span>
		<span class="o">|</span> <span class="p">(</span><span class="mh">0x20</span><span class="o">&lt;&lt;</span><span class="n">AGP_CNTL__MAX_IDLE_CLK__SHIFT</span><span class="p">));</span>

	<span class="cm">/* ACPI mode */</span>
	<span class="cm">/* because both INPLL and OUTPLL take the same lock, that&#39;s why. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllPLL_PWRMGT_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PLL_PWRMGT_CNTL__PM_MODE_SEL</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllPLL_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>


	<span class="n">disp_mis_cntl</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DISP_MISC_CNTL</span><span class="p">);</span>
	
	<span class="n">disp_mis_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span>	<span class="n">DISP_MISC_CNTL__SOFT_RESET_GRPH_PP</span> <span class="o">|</span> 
				<span class="n">DISP_MISC_CNTL__SOFT_RESET_SUBPIC_PP</span> <span class="o">|</span> 
				<span class="n">DISP_MISC_CNTL__SOFT_RESET_OV0_PP</span> <span class="o">|</span>
				<span class="n">DISP_MISC_CNTL__SOFT_RESET_GRPH_SCLK</span><span class="o">|</span>
				<span class="n">DISP_MISC_CNTL__SOFT_RESET_SUBPIC_SCLK</span><span class="o">|</span>
				<span class="n">DISP_MISC_CNTL__SOFT_RESET_OV0_SCLK</span><span class="o">|</span>
				<span class="n">DISP_MISC_CNTL__SOFT_RESET_GRPH2_PP</span><span class="o">|</span>
				<span class="n">DISP_MISC_CNTL__SOFT_RESET_GRPH2_SCLK</span><span class="o">|</span>
				<span class="n">DISP_MISC_CNTL__SOFT_RESET_LVDS</span><span class="o">|</span>
				<span class="n">DISP_MISC_CNTL__SOFT_RESET_TMDS</span><span class="o">|</span>
				<span class="n">DISP_MISC_CNTL__SOFT_RESET_DIG_TMDS</span><span class="o">|</span>
				<span class="n">DISP_MISC_CNTL__SOFT_RESET_TV</span><span class="p">);</span>
	
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DISP_MISC_CNTL</span><span class="p">,</span> <span class="n">disp_mis_cntl</span><span class="p">);</span>
						
	<span class="n">disp_pwr_man</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DISP_PWR_MAN</span><span class="p">);</span>
	
	<span class="n">disp_pwr_man</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span>	<span class="n">DISP_PWR_MAN__DISP_PWR_MAN_D3_CRTC_EN</span>	<span class="o">|</span> 
				<span class="n">DISP_PWR_MAN__DISP2_PWR_MAN_D3_CRTC2_EN</span> <span class="o">|</span>
				<span class="n">DISP_PWR_MAN__DISP_PWR_MAN_DPMS_MASK</span><span class="o">|</span>
				<span class="n">DISP_PWR_MAN__DISP_D3_RST</span><span class="o">|</span>
				<span class="n">DISP_PWR_MAN__DISP_D3_REG_RST</span>
				<span class="p">);</span>
	
	<span class="n">disp_pwr_man</span> <span class="o">|=</span> <span class="n">DISP_PWR_MAN__DISP_D3_GRPH_RST</span><span class="o">|</span>
					<span class="n">DISP_PWR_MAN__DISP_D3_SUBPIC_RST</span><span class="o">|</span>
					<span class="n">DISP_PWR_MAN__DISP_D3_OV0_RST</span><span class="o">|</span>
					<span class="n">DISP_PWR_MAN__DISP_D1D2_GRPH_RST</span><span class="o">|</span>
					<span class="n">DISP_PWR_MAN__DISP_D1D2_SUBPIC_RST</span><span class="o">|</span>
					<span class="n">DISP_PWR_MAN__DISP_D1D2_OV0_RST</span><span class="o">|</span>
					<span class="n">DISP_PWR_MAN__DIG_TMDS_ENABLE_RST</span><span class="o">|</span>
					<span class="n">DISP_PWR_MAN__TV_ENABLE_RST</span><span class="o">|</span> </pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code>            DISP_PWR_MAN__AUTO_PWRUP_EN|
</code></pre></td><td class="code"><div class="highlight"><pre>					<span class="mi">0</span><span class="p">;</span>
	
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DISP_PWR_MAN</span><span class="p">,</span> <span class="n">disp_pwr_man</span><span class="p">);</span>					
							
	<span class="n">clk_pwrmgt_cntl</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllCLK_PWRMGT_CNTL</span><span class="p">);</span>
	<span class="n">pll_pwrmgt_cntl</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllPLL_PWRMGT_CNTL</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">clk_pin_cntl</span> 	<span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllCLK_PIN_CNTL</span><span class="p">);</span>
	<span class="n">disp_pwr_man</span>	<span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DISP_PWR_MAN</span><span class="p">);</span>
		
	
	<span class="cm">/* D2 */</span>
	<span class="n">clk_pwrmgt_cntl</span> <span class="o">|=</span> <span class="n">CLK_PWRMGT_CNTL__DISP_PM</span><span class="p">;</span>
	<span class="n">pll_pwrmgt_cntl</span> <span class="o">|=</span> <span class="n">PLL_PWRMGT_CNTL__MOBILE_SU</span> <span class="o">|</span> <span class="n">PLL_PWRMGT_CNTL__SU_SCLK_USE_BCLK</span><span class="p">;</span>
	<span class="n">clk_pin_cntl</span>	<span class="o">|=</span> <span class="n">CLK_PIN_CNTL__XTALIN_ALWAYS_ONb</span><span class="p">;</span>
	<span class="n">disp_pwr_man</span> 	<span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DISP_PWR_MAN__DISP_PWR_MAN_D3_CRTC_EN_MASK</span>
			     <span class="o">|</span> <span class="n">DISP_PWR_MAN__DISP2_PWR_MAN_D3_CRTC2_EN_MASK</span><span class="p">);</span>

	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllCLK_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">clk_pwrmgt_cntl</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllPLL_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">pll_pwrmgt_cntl</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllCLK_PIN_CNTL</span><span class="p">,</span> <span class="n">clk_pin_cntl</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DISP_PWR_MAN</span><span class="p">,</span> <span class="n">disp_pwr_man</span><span class="p">);</span>

	<span class="cm">/* disable display request &amp; disable display */</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span> <span class="n">CRTC_GEN_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRTC_GEN_CNTL__CRTC_EN</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">CRTC_GEN_CNTL__CRTC_DISP_REQ_EN_B</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">CRTC2_GEN_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span> <span class="n">CRTC2_GEN_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRTC2_GEN_CNTL__CRTC2_EN</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">CRTC2_GEN_CNTL__CRTC2_DISP_REQ_EN_B</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">17</span><span class="p">);</span>				   

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_yclk_mclk_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mc_chp_io_cntl_a1</span><span class="p">,</span> <span class="n">mc_chp_io_cntl_b1</span><span class="p">;</span>

	<span class="n">mc_chp_io_cntl_a1</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span> <span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_A1</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="o">~</span><span class="n">MC_CHP_IO_CNTL_A1__MEM_SYNC_ENA_MASK</span><span class="p">;</span>
	<span class="n">mc_chp_io_cntl_b1</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span> <span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_B1</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="o">~</span><span class="n">MC_CHP_IO_CNTL_B1__MEM_SYNC_ENB_MASK</span><span class="p">;</span>

	<span class="n">OUTMC</span><span class="p">(</span> <span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_A1</span><span class="p">,</span> <span class="n">mc_chp_io_cntl_a1</span>
	       <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MC_CHP_IO_CNTL_A1__MEM_SYNC_ENA__SHIFT</span><span class="p">));</span>
	<span class="n">OUTMC</span><span class="p">(</span> <span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_B1</span><span class="p">,</span> <span class="n">mc_chp_io_cntl_b1</span>
	       <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MC_CHP_IO_CNTL_B1__MEM_SYNC_ENB__SHIFT</span><span class="p">));</span>

	<span class="n">OUTMC</span><span class="p">(</span> <span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_A1</span><span class="p">,</span> <span class="n">mc_chp_io_cntl_a1</span><span class="p">);</span>
	<span class="n">OUTMC</span><span class="p">(</span> <span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_B1</span><span class="p">,</span> <span class="n">mc_chp_io_cntl_b1</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_yclk_mclk_sync_m10</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mc_chp_io_cntl_a1</span><span class="p">,</span> <span class="n">mc_chp_io_cntl_b1</span><span class="p">;</span>

	<span class="n">mc_chp_io_cntl_a1</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_A1</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="o">~</span><span class="n">MC_CHP_IO_CNTL_A1__MEM_SYNC_ENA_MASK</span><span class="p">;</span>
	<span class="n">mc_chp_io_cntl_b1</span> <span class="o">=</span> <span class="n">INMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_B1</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="o">~</span><span class="n">MC_CHP_IO_CNTL_B1__MEM_SYNC_ENB_MASK</span><span class="p">;</span>

	<span class="n">OUTMC</span><span class="p">(</span> <span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_A1</span><span class="p">,</span>
	       <span class="n">mc_chp_io_cntl_a1</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MC_CHP_IO_CNTL_A1__MEM_SYNC_ENA__SHIFT</span><span class="p">));</span>
	<span class="n">OUTMC</span><span class="p">(</span> <span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_B1</span><span class="p">,</span>
	       <span class="n">mc_chp_io_cntl_b1</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MC_CHP_IO_CNTL_B1__MEM_SYNC_ENB__SHIFT</span><span class="p">));</span>

	<span class="n">OUTMC</span><span class="p">(</span> <span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_A1</span><span class="p">,</span> <span class="n">mc_chp_io_cntl_a1</span><span class="p">);</span>
	<span class="n">OUTMC</span><span class="p">(</span> <span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_B1</span><span class="p">,</span> <span class="n">mc_chp_io_cntl_b1</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">delay_required</span><span class="p">)</span>
<span class="p">{</span>  
	<span class="n">u32</span> <span class="n">mem_sdram_mode</span><span class="p">;</span>

	<span class="n">mem_sdram_mode</span>  <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">);</span>

	<span class="n">mem_sdram_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MEM_SDRAM_MODE_REG__MEM_MODE_REG_MASK</span><span class="p">;</span>
	<span class="n">mem_sdram_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">value</span><span class="o">&lt;&lt;</span><span class="n">MEM_SDRAM_MODE_REG__MEM_MODE_REG__SHIFT</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MEM_SDRAM_MODE_REG__MEM_CFG_TYPE</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span> <span class="n">mem_sdram_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delay_required</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">mem_sdram_mode</span> <span class="o">|=</span>  <span class="n">MEM_SDRAM_MODE_REG__MEM_SDRAM_RESET</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span> <span class="n">mem_sdram_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delay_required</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">mem_sdram_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MEM_SDRAM_MODE_REG__MEM_SDRAM_RESET</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span> <span class="n">mem_sdram_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delay_required</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delay_required</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delay_required</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">INREG</span><span class="p">(</span><span class="n">MC_STATUS</span><span class="p">)</span>
			  <span class="o">&amp;</span> <span class="p">(</span><span class="n">MC_STATUS__MEM_PWRUP_COMPL_A</span> <span class="o">|</span>
			     <span class="n">MC_STATUS__MEM_PWRUP_COMPL_B</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_m10_program_mode_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">MC_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MC_STATUS__MEM_PWRUP_COMPL_A</span>
					<span class="o">|</span> <span class="n">MC_STATUS__MEM_PWRUP_COMPL_B</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_enable_dll</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>  
<span class="cp">#define DLL_RESET_DELAY 	5</span>
<span class="cp">#define DLL_SLEEP_DELAY		1</span>

	<span class="n">u32</span> <span class="n">cko</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMDLL_CKO</span><span class="p">)</span>   <span class="o">|</span> <span class="n">MDLL_CKO__MCKOA_SLEEP</span>
		<span class="o">|</span> <span class="n">MDLL_CKO__MCKOA_RESET</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cka</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKA</span><span class="p">)</span> <span class="o">|</span> <span class="n">MDLL_RDCKA__MRDCKA0_SLEEP</span>
		<span class="o">|</span> <span class="n">MDLL_RDCKA__MRDCKA1_SLEEP</span> <span class="o">|</span> <span class="n">MDLL_RDCKA__MRDCKA0_RESET</span>
		<span class="o">|</span> <span class="n">MDLL_RDCKA__MRDCKA1_RESET</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ckb</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKB</span><span class="p">)</span> <span class="o">|</span> <span class="n">MDLL_RDCKB__MRDCKB0_SLEEP</span>
		<span class="o">|</span> <span class="n">MDLL_RDCKB__MRDCKB1_SLEEP</span> <span class="o">|</span> <span class="n">MDLL_RDCKB__MRDCKB0_RESET</span>
		<span class="o">|</span> <span class="n">MDLL_RDCKB__MRDCKB1_RESET</span><span class="p">;</span>

	<span class="cm">/* Setting up the DLL range for write */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_CKO</span><span class="p">,</span>   	<span class="n">cko</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKA</span><span class="p">,</span>  	<span class="n">cka</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKB</span><span class="p">,</span>	<span class="n">ckb</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="n">DLL_RESET_DELAY</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">cko</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDLL_CKO__MCKOA_SLEEP</span> <span class="o">|</span> <span class="n">MDLL_CKO__MCKOB_SLEEP</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_CKO</span><span class="p">,</span> <span class="n">cko</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">DLL_SLEEP_DELAY</span><span class="p">);</span>
	<span class="n">cko</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDLL_CKO__MCKOA_RESET</span> <span class="o">|</span> <span class="n">MDLL_CKO__MCKOB_RESET</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_CKO</span><span class="p">,</span> <span class="n">cko</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">DLL_RESET_DELAY</span><span class="p">);</span>

	<span class="n">cka</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDLL_RDCKA__MRDCKA0_SLEEP</span> <span class="o">|</span> <span class="n">MDLL_RDCKA__MRDCKA1_SLEEP</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKA</span><span class="p">,</span> <span class="n">cka</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">DLL_SLEEP_DELAY</span><span class="p">);</span>
	<span class="n">cka</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDLL_RDCKA__MRDCKA0_RESET</span> <span class="o">|</span> <span class="n">MDLL_RDCKA__MRDCKA1_RESET</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKA</span><span class="p">,</span> <span class="n">cka</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">DLL_RESET_DELAY</span><span class="p">);</span>

	<span class="n">ckb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDLL_RDCKB__MRDCKB0_SLEEP</span> <span class="o">|</span> <span class="n">MDLL_RDCKB__MRDCKB1_SLEEP</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKB</span><span class="p">,</span> <span class="n">ckb</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">DLL_SLEEP_DELAY</span><span class="p">);</span>
	<span class="n">ckb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDLL_RDCKB__MRDCKB0_RESET</span> <span class="o">|</span> <span class="n">MDLL_RDCKB__MRDCKB1_RESET</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKB</span><span class="p">,</span> <span class="n">ckb</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">DLL_RESET_DELAY</span><span class="p">);</span>


<span class="cp">#undef DLL_RESET_DELAY</span>
<span class="cp">#undef DLL_SLEEP_DELAY</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_enable_dll_m10</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dll_value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dll_sleep_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dll_reset_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mc</span><span class="p">;</span>

<span class="cp">#define DLL_RESET_DELAY 	5</span>
<span class="cp">#define DLL_SLEEP_DELAY		1</span>

	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_DLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">70</span><span class="p">]);</span>
	<span class="n">mc</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MC_CNTL</span><span class="p">);</span>
	<span class="cm">/* Check which channels are enabled */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">dll_sleep_mask</span> <span class="o">|=</span> <span class="n">MDLL_R300_RDCK__MRDCKB_SLEEP</span><span class="p">;</span>
		<span class="n">dll_reset_mask</span> <span class="o">|=</span> <span class="n">MDLL_R300_RDCK__MRDCKB_RESET</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">dll_sleep_mask</span> <span class="o">|=</span> <span class="n">MDLL_R300_RDCK__MRDCKA_SLEEP</span><span class="p">;</span>
		<span class="n">dll_reset_mask</span> <span class="o">|=</span> <span class="n">MDLL_R300_RDCK__MRDCKA_RESET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">dll_sleep_mask</span> <span class="o">|=</span> <span class="n">MDLL_R300_RDCK__MRDCKD_SLEEP</span><span class="p">;</span>
		<span class="n">dll_reset_mask</span> <span class="o">|=</span> <span class="n">MDLL_R300_RDCK__MRDCKD_RESET</span><span class="p">;</span>
		<span class="n">dll_sleep_mask</span> <span class="o">|=</span> <span class="n">MDLL_R300_RDCK__MRDCKC_SLEEP</span><span class="p">;</span>
		<span class="n">dll_reset_mask</span> <span class="o">|=</span> <span class="n">MDLL_R300_RDCK__MRDCKC_RESET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dll_value</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKA</span><span class="p">);</span>

	<span class="cm">/* Power Up */</span>
	<span class="n">dll_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">dll_sleep_mask</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKA</span><span class="p">,</span> <span class="n">dll_value</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span> <span class="n">DLL_SLEEP_DELAY</span><span class="p">);</span>  		

	<span class="n">dll_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">dll_reset_mask</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKA</span><span class="p">,</span> <span class="n">dll_value</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span> <span class="n">DLL_RESET_DELAY</span><span class="p">);</span>  		

<span class="cp">#undef DLL_RESET_DELAY </span>
<span class="cp">#undef DLL_SLEEP_DELAY</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_full_reset_sdram</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">crtcGenCntl</span><span class="p">,</span> <span class="n">crtcGenCntl2</span><span class="p">,</span> <span class="n">memRefreshCntl</span><span class="p">,</span> <span class="n">crtc_more_cntl</span><span class="p">,</span>
		<span class="n">fp_gen_cntl</span><span class="p">,</span> <span class="n">fp2_gen_cntl</span><span class="p">;</span>
 
	<span class="n">crtcGenCntl</span>  <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span> <span class="n">CRTC_GEN_CNTL</span><span class="p">);</span>
	<span class="n">crtcGenCntl2</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span> <span class="n">CRTC2_GEN_CNTL</span><span class="p">);</span>

	<span class="n">crtc_more_cntl</span> 	<span class="o">=</span> <span class="n">INREG</span><span class="p">(</span> <span class="n">CRTC_MORE_CNTL</span><span class="p">);</span>
	<span class="n">fp_gen_cntl</span> 	<span class="o">=</span> <span class="n">INREG</span><span class="p">(</span> <span class="n">FP_GEN_CNTL</span><span class="p">);</span>
	<span class="n">fp2_gen_cntl</span> 	<span class="o">=</span> <span class="n">INREG</span><span class="p">(</span> <span class="n">FP2_GEN_CNTL</span><span class="p">);</span>
 

	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">CRTC_MORE_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">FP_GEN_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">FP2_GEN_CNTL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
 
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">CRTC_GEN_CNTL</span><span class="p">,</span>  <span class="p">(</span><span class="n">crtcGenCntl</span> <span class="o">|</span> <span class="n">CRTC_GEN_CNTL__CRTC_DISP_REQ_EN_B</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">CRTC2_GEN_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">crtcGenCntl2</span> <span class="o">|</span> <span class="n">CRTC2_GEN_CNTL__CRTC2_DISP_REQ_EN_B</span><span class="p">)</span> <span class="p">);</span>
  
	<span class="cm">/* This is the code for the Aluminium PowerBooks M10 / iBooks M11 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV350</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">sdram_mode_reg</span> <span class="o">=</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">35</span><span class="p">];</span>
		<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">default_mrtable</span><span class="p">[]</span> <span class="o">=</span>
			<span class="p">{</span> <span class="mh">0x21320032</span><span class="p">,</span>
			  <span class="mh">0x21321000</span><span class="p">,</span> <span class="mh">0xa1321000</span><span class="p">,</span> <span class="mh">0x21321000</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
			  <span class="mh">0x21320032</span><span class="p">,</span> <span class="mh">0xa1320032</span><span class="p">,</span> <span class="mh">0x21320032</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
			  <span class="mh">0x21321002</span><span class="p">,</span> <span class="mh">0xa1321002</span><span class="p">,</span> <span class="mh">0x21321002</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
			  <span class="mh">0x21320132</span><span class="p">,</span> <span class="mh">0xa1320132</span><span class="p">,</span> <span class="mh">0x21320132</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
			  <span class="mh">0x21320032</span><span class="p">,</span> <span class="mh">0xa1320032</span><span class="p">,</span> <span class="mh">0x21320032</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
			  <span class="mh">0x31320032</span> <span class="p">};</span>

		<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">mrtable</span> <span class="o">=</span> <span class="n">default_mrtable</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mrtable_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_mrtable</span><span class="p">);</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

		<span class="cm">/* Disable refresh */</span>
		<span class="n">memRefreshCntl</span> 	<span class="o">=</span> <span class="n">INREG</span><span class="p">(</span> <span class="n">MEM_REFRESH_CNTL</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="o">~</span><span class="n">MEM_REFRESH_CNTL__MEM_REFRESH_DIS</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MEM_REFRESH_CNTL</span><span class="p">,</span> <span class="n">memRefreshCntl</span>
			<span class="o">|</span> <span class="n">MEM_REFRESH_CNTL__MEM_REFRESH_DIS</span><span class="p">);</span>

		<span class="cm">/* Configure and enable M &amp; SPLLs */</span>
       		<span class="n">radeon_pm_enable_dll_m10</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
		<span class="n">radeon_pm_yclk_mclk_sync_m10</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC_OF</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">of_node</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

			<span class="n">mrtable</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;ATY,MRT&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mrtable</span><span class="p">)</span>
				<span class="n">mrtable_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mrtable</span> <span class="o">=</span> <span class="n">default_mrtable</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_OF */</span><span class="cp"></span>

		<span class="cm">/* Program the SDRAM */</span>
		<span class="n">sdram_mode_reg</span> <span class="o">=</span> <span class="n">mrtable</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span> <span class="n">sdram_mode_reg</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mrtable_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mrtable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffffu</span><span class="p">)</span>
				<span class="n">radeon_pm_m10_program_mode_wait</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">sdram_mode_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MEM_SDRAM_MODE_REG__MEM_MODE_REG_MASK</span>
						    <span class="o">|</span> <span class="n">MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE</span>
						    <span class="o">|</span> <span class="n">MEM_SDRAM_MODE_REG__MEM_SDRAM_RESET</span><span class="p">);</span>
				<span class="n">sdram_mode_reg</span> <span class="o">|=</span> <span class="n">mrtable</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

				<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span> <span class="n">sdram_mode_reg</span><span class="p">);</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Restore memory refresh */</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_REFRESH_CNTL</span><span class="p">,</span> <span class="n">memRefreshCntl</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="cm">/* Here come the desktop RV200 &quot;QW&quot; card */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span> <span class="o">&amp;&amp;</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV200</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable refresh */</span>
		<span class="n">memRefreshCntl</span> 	<span class="o">=</span> <span class="n">INREG</span><span class="p">(</span> <span class="n">MEM_REFRESH_CNTL</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="o">~</span><span class="n">MEM_REFRESH_CNTL__MEM_REFRESH_DIS</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_REFRESH_CNTL</span><span class="p">,</span> <span class="n">memRefreshCntl</span>
		       <span class="o">|</span> <span class="n">MEM_REFRESH_CNTL__MEM_REFRESH_DIS</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

		<span class="cm">/* Reset memory */</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span>
		       <span class="n">INREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE</span><span class="p">);</span>

		<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x2002</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x0132</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span>
		       <span class="n">INREG</span><span class="p">(</span><span class="n">MEM_SDRAM_MODE_REG</span><span class="p">)</span> <span class="o">|</span> <span class="n">MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE</span><span class="p">);</span>

		<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MEM_REFRESH_CNTL</span><span class="p">,</span> 	<span class="n">memRefreshCntl</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="cm">/* The M6 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span> <span class="o">&amp;&amp;</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV100</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable refresh */</span>
		<span class="n">memRefreshCntl</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">EXT_MEM_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
		<span class="n">OUTREG</span><span class="p">(</span> <span class="n">EXT_MEM_CNTL</span><span class="p">,</span> <span class="n">memRefreshCntl</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">));</span>
 
		<span class="cm">/* Reset memory */</span>
		<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span>
			<span class="n">INREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="o">~</span><span class="n">MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE</span><span class="p">);</span>

		<span class="cm">/* DLL */</span>
		<span class="n">radeon_pm_enable_dll</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

		<span class="cm">/* MLCK / YCLK sync */</span>
		<span class="n">radeon_pm_yclk_mclk_sync</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

		<span class="cm">/* Program Mode Register */</span>
		<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>   
		<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x2001</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>   
		<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x2002</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>   
		<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x0132</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>   
		<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> 

		<span class="cm">/* Complete &amp; re-enable refresh */</span>
		<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span>
			<span class="n">INREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">)</span> <span class="o">|</span> <span class="n">MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE</span><span class="p">);</span>

		<span class="n">OUTREG</span><span class="p">(</span><span class="n">EXT_MEM_CNTL</span><span class="p">,</span> <span class="n">memRefreshCntl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* And finally, the M7..M9 models, including M9+ (RV280) */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Disable refresh */</span>
		<span class="n">memRefreshCntl</span> 	<span class="o">=</span> <span class="n">INREG</span><span class="p">(</span> <span class="n">MEM_REFRESH_CNTL</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="o">~</span><span class="n">MEM_REFRESH_CNTL__MEM_REFRESH_DIS</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MEM_REFRESH_CNTL</span><span class="p">,</span> <span class="n">memRefreshCntl</span>
			<span class="o">|</span> <span class="n">MEM_REFRESH_CNTL__MEM_REFRESH_DIS</span><span class="p">);</span>

		<span class="cm">/* Reset memory */</span>
		<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span>
			<span class="n">INREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="o">~</span><span class="n">MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE</span><span class="p">);</span>

		<span class="cm">/* DLL */</span>
		<span class="n">radeon_pm_enable_dll</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

		<span class="cm">/* MLCK / YCLK sync */</span>
		<span class="n">radeon_pm_yclk_mclk_sync</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

		<span class="cm">/* M6, M7 and M9 so far ... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;=</span> <span class="n">CHIP_FAMILY_RV250</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x2001</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x2002</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x0132</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* M9+ (iBook G4) */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RV280</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x0132</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">radeon_pm_program_mode_reg</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Complete &amp; re-enable refresh */</span>
		<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span>
			<span class="n">INREG</span><span class="p">(</span> <span class="n">MEM_SDRAM_MODE_REG</span><span class="p">)</span> <span class="o">|</span> <span class="n">MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE</span><span class="p">);</span>

		<span class="n">OUTREG</span><span class="p">(</span> <span class="n">MEM_REFRESH_CNTL</span><span class="p">,</span> 	<span class="n">memRefreshCntl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> 		<span class="n">crtcGenCntl</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">CRTC2_GEN_CNTL</span><span class="p">,</span> 	<span class="n">crtcGenCntl2</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">FP_GEN_CNTL</span><span class="p">,</span> 		<span class="n">fp_gen_cntl</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">FP2_GEN_CNTL</span><span class="p">,</span> 		<span class="n">fp2_gen_cntl</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span> <span class="n">CRTC_MORE_CNTL</span><span class="p">,</span> 	<span class="n">crtc_more_cntl</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span> <span class="mi">15</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_reset_pad_ctlr_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

	<span class="cm">/* Reset the PAD_CTLR_STRENGTH &amp; wait for it to be stable */</span>
	<span class="n">INREG</span><span class="p">(</span><span class="n">PAD_CTLR_STRENGTH</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PAD_CTLR_STRENGTH</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PAD_CTLR_STRENGTH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAD_MANUAL_OVERRIDE</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PAD_CTLR_STRENGTH</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">65</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">tmp2</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PAD_CTLR_STRENGTH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">tmp2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;radeon: PAD_CTLR_STRENGTH doesn&#39;t &quot;</span>
				       <span class="s">&quot;stabilize !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_all_ppls_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllP2PLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllP2PLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_start_mclk_sclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Switch SPLL to PCI source */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCLK_CNTL__SCLK_SRC_SEL_MASK</span><span class="p">);</span>

	<span class="cm">/* Reconfigure SPLL charge pump, VCO gain, duty cycle */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTREG8</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">pllSPLL_CNTL</span> <span class="o">+</span> <span class="n">PLL_WR_EN</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_index</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="n">OUTREG8</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_data</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Set SPLL feedback divider */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllM_SPLL_REF_FB_DIV</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff00fffful</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">77</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000ul</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllM_SPLL_REF_FB_DIV</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Power up SPLL */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">INPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Release SPLL reset */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x2</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">INPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Select SCLK source  */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCLK_CNTL__SCLK_SRC_SEL_MASK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SCLK_CNTL__SCLK_SRC_SEL_MASK</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Reconfigure MPLL charge pump, VCO gain, duty cycle */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTREG8</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">pllMPLL_CNTL</span> <span class="o">+</span> <span class="n">PLL_WR_EN</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_index</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="n">OUTREG8</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_data</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Set MPLL feedback divider */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllM_SPLL_REF_FB_DIV</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff00fful</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">77</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00ul</span><span class="p">);</span>

	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllM_SPLL_REF_FB_DIV</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="cm">/* Power up MPLL */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x2</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">INPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Un-reset MPLL */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">INPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Select source for MCLK */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">INPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_m10_disable_spread_spectrum</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r2ec</span><span class="p">;</span>

	<span class="cm">/* GACK ! I though we didn&#39;t have a DDA on Radeon&#39;s anymore</span>
<span class="cm">	 * here we rewrite with the same value, ... I suppose we clear</span>
<span class="cm">	 * some bits that are already clear ? Or maybe this 0x2ec</span>
<span class="cm">	 * register is something new ?</span>
<span class="cm">	 */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">r2ec</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VGA_DDA_ON_OFF</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">VGA_DDA_ON_OFF</span><span class="p">,</span> <span class="n">r2ec</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Spread spectrum PLLL off */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSSPLL_CNTL</span><span class="p">,</span> <span class="mh">0xbf03</span><span class="p">);</span>

	<span class="cm">/* Spread spectrum disabled */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSS_INT_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">90</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* The trace shows read &amp; rewrite of LVDS_PLL_CNTL here with same</span>
<span class="cm">	 * value, not sure what for...</span>
<span class="cm">	 */</span>

	<span class="n">r2ec</span> <span class="o">|=</span> <span class="mh">0x3f0</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">VGA_DDA_ON_OFF</span><span class="p">,</span> <span class="n">r2ec</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_m10_enable_lvds_spread_spectrum</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r2ec</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* GACK (bis) ! I though we didn&#39;t have a DDA on Radeon&#39;s anymore</span>
<span class="cm">	 * here we rewrite with the same value, ... I suppose we clear/set</span>
<span class="cm">	 * some bits that are already clear/set ?</span>
<span class="cm">	 */</span>
	<span class="n">r2ec</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VGA_DDA_ON_OFF</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">VGA_DDA_ON_OFF</span><span class="p">,</span> <span class="n">r2ec</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable spread spectrum */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSSPLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">|</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSSPLL_REF_DIV</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">44</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSSPLL_DIV_0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">45</span><span class="p">]);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSSPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSSPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x2</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSSPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSSPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

       	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSS_INT_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">90</span><span class="p">]);</span>

	<span class="n">r2ec</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">VGA_DDA_ON_OFF</span><span class="p">,</span> <span class="n">r2ec</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Enable LVDS interface */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">LVDS_EN</span><span class="p">);</span>

	<span class="cm">/* Enable LVDS_PLL */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_PLL_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x30000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_PLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">34</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSS_TST_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">91</span><span class="p">]);</span>

	<span class="cm">/* The trace reads that one here, waiting for something to settle down ? */</span>
	<span class="n">INREG</span><span class="p">(</span><span class="n">RBBM_STATUS</span><span class="p">);</span>

	<span class="cm">/* Ugh ? SS_TST_DEC is supposed to be a read register in the</span>
<span class="cm">	 * R300 register spec at least...</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSS_TST_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x00400000</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSS_TST_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_restore_pixel_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">OUTREG8</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">pllHTOTAL_CNTL</span> <span class="o">+</span> <span class="n">PLL_WR_EN</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_index</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="n">OUTREG8</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_data</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPPLL_REF_DIV</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PPLL_REF_DIV_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_div</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPPLL_REF_DIV</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">INPLL</span><span class="p">(</span><span class="n">pllPPLL_REF_DIV</span><span class="p">);</span>

	<span class="cm">/* Reconfigure SPLL charge pump, VCO gain, duty cycle,</span>
<span class="cm">	 * probably useless since we already did it ...</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTREG8</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">pllSPLL_CNTL</span> <span class="o">+</span> <span class="n">PLL_WR_EN</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_index</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="n">OUTREG8</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_data</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Restore our &quot;reference&quot; PPLL divider set by firmware</span>
<span class="cm">	 * according to proper spread spectrum calculations</span>
<span class="cm">	 */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPPLL_DIV_0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">92</span><span class="p">]);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x2</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllPPLL_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Switch pixel clock to firmware default div 0 */</span>
	<span class="n">OUTREG8</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_index</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="n">radeon_pll_errata_after_data</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_m10_reconfigure_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">46</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_INIT_GFX_LAT_TIMER</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">47</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_INIT_MISC_LAT_TIMER</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">48</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span>
	       <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_TIMING_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">49</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_REFRESH_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">42</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_READ_CNTL_AB</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">50</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_CHIP_IO_OE_CNTL_AB</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">52</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_IOPAD_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">51</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_DEBUG</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">53</span><span class="p">]);</span>

	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_MC_INIT_WR_LAT_TIMER</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">58</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_IMP_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">59</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_C0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">60</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_C1</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">61</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_D0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">62</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_D1</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">63</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_BIST_CNTL_3</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">64</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_A0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">65</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_A1</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">66</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_B0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">67</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_CHP_IO_CNTL_B1</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">68</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_DEBUG_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">69</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_DLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">70</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_IMP_CNTL_0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">71</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_ELPIDA_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">72</span><span class="p">]);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_READ_CNTL_CD</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">96</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_IND_INDEX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_reinitialize_M10</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Restore a bunch of registers first */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_AGP_LOCATION</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">32</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DISPLAY_BASE_ADDR</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">31</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CRTC2_DISPLAY_BASE_ADDR</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">33</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_FB_LOCATION</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">30</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">OV0_BASE_ADDR</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">80</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CNFG_MEMSIZE</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">video_ram</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">36</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MPP_TB_CONFIG</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">37</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">FCP_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">38</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">RBBM_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">39</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">40</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_MACRO_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">DAC_MACRO_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x6</span><span class="p">)</span> <span class="o">|</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_MACRO_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">DAC_MACRO_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x6</span><span class="p">)</span> <span class="o">|</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Hrm... */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">)</span> <span class="o">|</span> <span class="n">DAC2_EXPAND_MODE</span><span class="p">);</span>

	<span class="cm">/* Reset the PAD CTLR */</span>
	<span class="n">radeon_pm_reset_pad_ctlr_strength</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Some PLLs are Read &amp; written identically in the trace here...</span>
<span class="cm">	 * I suppose it&#39;s actually to switch them all off &amp; reset,</span>
<span class="cm">	 * let&#39;s assume off is what we want. I&#39;m just doing that for all major PLLs now.</span>
<span class="cm">	 */</span>
	<span class="n">radeon_pm_all_ppls_off</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Clear tiling, reset swappers */</span>
	<span class="n">INREG</span><span class="p">(</span><span class="n">SURFACE_CNTL</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">SURFACE_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Some black magic with TV_DAC_CNTL, we should restore those from backups</span>
<span class="cm">	 * rather than hard coding...</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TV_DAC_CNTL_BGADJ_MASK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="n">TV_DAC_CNTL_BGADJ__SHIFT</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TV_DAC_CNTL_DACADJ_MASK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="n">TV_DAC_CNTL_DACADJ__SHIFT</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* More registers restored */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">AGP_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">HOST_PATH_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">41</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DISP_MISC_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>

	<span class="cm">/* Hrmmm ... What is that ? */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CLK_PWRMGT_CNTL__ACTIVE_HILO_LAT_MASK</span> <span class="o">|</span>
		    <span class="n">CLK_PWRMGT_CNTL__MC_BUSY</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllCLK_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PAD_CTLR_MISC</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">56</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">FW_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">57</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">HDP_DEBUG</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">96</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PAMAC0_DLY_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">54</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PAMAC1_DLY_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">55</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PAMAC2_DLY_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">79</span><span class="p">]);</span>

	<span class="cm">/* Restore Memory Controller configuration */</span>
	<span class="n">radeon_pm_m10_reconfigure_mc</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Make sure CRTC&#39;s dont touch memory */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">)</span>
	       <span class="o">|</span> <span class="n">CRTC_GEN_CNTL__CRTC_DISP_REQ_EN_B</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CRTC2_GEN_CNTL</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CRTC2_GEN_CNTL</span><span class="p">)</span>
	       <span class="o">|</span> <span class="n">CRTC2_GEN_CNTL__CRTC2_DISP_REQ_EN_B</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="cm">/* Disable SDRAM refresh */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_REFRESH_CNTL</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MEM_REFRESH_CNTL</span><span class="p">)</span>
	       <span class="o">|</span> <span class="n">MEM_REFRESH_CNTL__MEM_REFRESH_DIS</span><span class="p">);</span>

	<span class="cm">/* Restore XTALIN routing (CLK_PIN_CNTL) */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllCLK_PIN_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="cm">/* Switch MCLK, YCLK and SCLK PLLs to PCI source &amp; force them ON */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span>	<span class="n">MCLK_CNTL__FORCE_MCLKA</span> <span class="o">|</span>
		<span class="n">MCLK_CNTL__FORCE_MCLKB</span> <span class="o">|</span>
		<span class="n">MCLK_CNTL__FORCE_YCLKA</span> <span class="o">|</span>
		<span class="n">MCLK_CNTL__FORCE_YCLKB</span> <span class="o">|</span>
		<span class="n">MCLK_CNTL__FORCE_MC</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Force all clocks on in SCLK */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span>	<span class="n">SCLK_CNTL__FORCE_DISP2</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_CP</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_HDP</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_DISP1</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_TOP</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_E2</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_SE</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_IDCT</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_VIP</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_PB</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_TAM</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_TDM</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_RB</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_TV_SCLK</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_SUBPIC</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_OV0</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span>	<span class="n">SCLK_CNTL__CP_MAX_DYN_STOP_LAT</span>  <span class="o">|</span>
		<span class="n">SCLK_CNTL__HDP_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
		<span class="n">SCLK_CNTL__TV_MAX_DYN_STOP_LAT</span>  <span class="o">|</span>
		<span class="n">SCLK_CNTL__E2_MAX_DYN_STOP_LAT</span>  <span class="o">|</span>
		<span class="n">SCLK_CNTL__SE_MAX_DYN_STOP_LAT</span>  <span class="o">|</span>
		<span class="n">SCLK_CNTL__IDCT_MAX_DYN_STOP_LAT</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__VIP_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
		<span class="n">SCLK_CNTL__RE_MAX_DYN_STOP_LAT</span>  <span class="o">|</span>
		<span class="n">SCLK_CNTL__PB_MAX_DYN_STOP_LAT</span>  <span class="o">|</span>
		<span class="n">SCLK_CNTL__TAM_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
		<span class="n">SCLK_CNTL__TDM_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
		<span class="n">SCLK_CNTL__RB_MAX_DYN_STOP_LAT</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_MISC</span><span class="p">,</span>
	       <span class="n">MCLK_MISC__MC_MCLK_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
	       <span class="n">MCLK_MISC__IO_MCLK_MAX_DYN_STOP_LAT</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Restore the M_SPLL_REF_FB_DIV, MPLL_AUX_CNTL and SPLL_AUX_CNTL values */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllM_SPLL_REF_FB_DIV</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">77</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMPLL_AUX_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">75</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSPLL_AUX_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">76</span><span class="p">]);</span>

	<span class="cm">/* Now restore the major PLLs settings, keeping them off &amp; reset though */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPPLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">93</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllP2PLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">73</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">74</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="cm">/* Restore MC DLL state and switch it off/reset too  */</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixR300_MC_DLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">70</span><span class="p">]);</span>

	<span class="cm">/* Switch MDLL off &amp; reset */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKA</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">98</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Setup some black magic bits in PLL_PWRMGT_CNTL. Hrm... we saved</span>
<span class="cm">	 * 0xa1100007... and MacOS writes 0xa1000007 ..</span>
<span class="cm">	 */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPLL_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Restore more stuffs */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllHTOTAL_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllHTOTAL2_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* More PLL initial configuration */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL2</span><span class="p">);</span> <span class="cm">/* What for ? */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> 	<span class="n">SCLK_MORE_CNTL__FORCE_DISPREGS</span> <span class="o">|</span>	<span class="cm">/* a guess */</span>
		<span class="n">SCLK_MORE_CNTL__FORCE_MC_GUI</span> <span class="o">|</span>
		<span class="n">SCLK_MORE_CNTL__FORCE_MC_HOST</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Now we actually start MCLK and SCLK */</span>
	<span class="n">radeon_pm_start_mclk_sclk</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Full reset sdrams, this also re-inits the MDLL */</span>
	<span class="n">radeon_pm_full_reset_sdram</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Fill palettes */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">PALETTE_30_DATA</span><span class="p">,</span> <span class="mh">0x15555555</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">PALETTE_30_DATA</span><span class="p">,</span> <span class="mh">0x15555555</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* Restore TMDS */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">FP_GEN_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">82</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">FP2_GEN_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">83</span><span class="p">]);</span>

	<span class="cm">/* Set LVDS registers but keep interface &amp; pll down */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;</span>
	       <span class="o">~</span><span class="p">(</span><span class="n">LVDS_EN</span> <span class="o">|</span> <span class="n">LVDS_ON</span> <span class="o">|</span> <span class="n">LVDS_DIGON</span> <span class="o">|</span> <span class="n">LVDS_BLON</span> <span class="o">|</span> <span class="n">LVDS_BL_MOD_EN</span><span class="p">));</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_PLL_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf0000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20000</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DISP_OUTPUT_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">86</span><span class="p">]);</span>

	<span class="cm">/* Restore GPIOPAD state */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_A</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">19</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_EN</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_MASK</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>

	<span class="cm">/* write some stuff to the framebuffer... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">fb_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">LVDS_DIGON</span> <span class="o">|</span> <span class="n">LVDS_ON</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="cm">/* Restore a few more things */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GRPH_BUFFER_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">94</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GRPH2_BUFFER_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">95</span><span class="p">]);</span>

	<span class="cm">/* Take care of spread spectrum &amp; PPLLs now */</span>
	<span class="n">radeon_pm_m10_disable_spread_spectrum</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="n">radeon_pm_restore_pixel_pll</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* GRRRR... I can&#39;t figure out the proper LVDS power sequence, and the</span>
<span class="cm">	 * code I have for blank/unblank doesn&#39;t quite work on some laptop models</span>
<span class="cm">	 * it seems ... Hrm. What I have here works most of the time ...</span>
<span class="cm">	 */</span>
	<span class="n">radeon_pm_m10_enable_lvds_spread_spectrum</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC_OF</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_m9p_reconfigure_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">46</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_INIT_GFX_LAT_TIMER</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">47</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_INIT_MISC_LAT_TIMER</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">48</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_SDRAM_MODE_REG</span><span class="p">,</span>
	       <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MEM_SDRAM_MODE_REG__MC_INIT_COMPLETE</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_TIMING_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">49</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_READ_CNTL_AB</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">50</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_REFRESH_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">42</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_IOPAD_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">51</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_DEBUG</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">53</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_CHIP_IO_OE_CNTL_AB</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">52</span><span class="p">]);</span>

	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_IMP_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">59</span><span class="p">]</span> <span class="cm">/*0x00f460d6*/</span><span class="p">);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_A0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">65</span><span class="p">]</span> <span class="cm">/*0xfecfa666*/</span><span class="p">);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_A1</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">66</span><span class="p">]</span> <span class="cm">/*0x141555ff*/</span><span class="p">);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_B0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">67</span><span class="p">]</span> <span class="cm">/*0xfecfa666*/</span><span class="p">);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_CHP_IO_CNTL_B1</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">68</span><span class="p">]</span> <span class="cm">/*0x141555ff*/</span><span class="p">);</span>
	<span class="n">OUTMC</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">ixMC_IMP_CNTL_0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">71</span><span class="p">]</span> <span class="cm">/*0x00009249*/</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_IND_INDEX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CNFG_MEMSIZE</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">video_ram</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_reinitialize_M9P</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Restore a bunch of registers first */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">SURFACE_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">29</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_AGP_LOCATION</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">32</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DISPLAY_BASE_ADDR</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">31</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CRTC2_DISPLAY_BASE_ADDR</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">33</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MC_FB_LOCATION</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">30</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">OV0_BASE_ADDR</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">80</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">36</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MPP_TB_CONFIG</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">37</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">FCP_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">38</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">RBBM_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">39</span><span class="p">]);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">40</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">)</span> <span class="o">|</span> <span class="n">DAC2_EXPAND_MODE</span><span class="p">);</span>

	<span class="cm">/* Reset the PAD CTLR */</span>
	<span class="n">radeon_pm_reset_pad_ctlr_strength</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Some PLLs are Read &amp; written identically in the trace here...</span>
<span class="cm">	 * I suppose it&#39;s actually to switch them all off &amp; reset,</span>
<span class="cm">	 * let&#39;s assume off is what we want. I&#39;m just doing that for all major PLLs now.</span>
<span class="cm">	 */</span>
	<span class="n">radeon_pm_all_ppls_off</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Clear tiling, reset swappers */</span>
	<span class="n">INREG</span><span class="p">(</span><span class="n">SURFACE_CNTL</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">SURFACE_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Some black magic with TV_DAC_CNTL, we should restore those from backups</span>
<span class="cm">	 * rather than hard coding...</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TV_DAC_CNTL_BGADJ_MASK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="n">TV_DAC_CNTL_BGADJ__SHIFT</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TV_DAC_CNTL_DACADJ_MASK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="n">TV_DAC_CNTL_DACADJ__SHIFT</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllAGP_PLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">78</span><span class="p">]);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PAMAC0_DLY_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">54</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PAMAC1_DLY_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">55</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PAMAC2_DLY_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">79</span><span class="p">]);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">AGP_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">HOST_PATH_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">41</span><span class="p">]);</span> <span class="cm">/* MacOS sets that to 0 !!! */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DISP_MISC_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>

	<span class="n">tmp</span>  <span class="o">=</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CLK_PWRMGT_CNTL__ACTIVE_HILO_LAT_MASK</span> <span class="o">|</span>
		    <span class="n">CLK_PWRMGT_CNTL__MC_BUSY</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllCLK_PWRMGT_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">FW_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">57</span><span class="p">]);</span>

	<span class="cm">/* Disable SDRAM refresh */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">MEM_REFRESH_CNTL</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MEM_REFRESH_CNTL</span><span class="p">)</span>
	       <span class="o">|</span> <span class="n">MEM_REFRESH_CNTL__MEM_REFRESH_DIS</span><span class="p">);</span>

	<span class="cm">/* Restore XTALIN routing (CLK_PIN_CNTL) */</span>
       	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllCLK_PIN_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="cm">/* Force MCLK to be PCI sourced and forced ON */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span>	<span class="n">MCLK_CNTL__FORCE_MCLKA</span> <span class="o">|</span>
		<span class="n">MCLK_CNTL__FORCE_MCLKB</span> <span class="o">|</span>
		<span class="n">MCLK_CNTL__FORCE_YCLKA</span> <span class="o">|</span>
		<span class="n">MCLK_CNTL__FORCE_YCLKB</span> <span class="o">|</span>
		<span class="n">MCLK_CNTL__FORCE_MC</span>    <span class="o">|</span>
		<span class="n">MCLK_CNTL__FORCE_AIC</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Force SCLK to be PCI sourced with a bunch forced */</span>
	<span class="n">tmp</span> <span class="o">=</span>	<span class="mi">0</span> <span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_DISP2</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_CP</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_HDP</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_DISP1</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_TOP</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_E2</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_SE</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_IDCT</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_VIP</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_RE</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_PB</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_TAM</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_TDM</span><span class="o">|</span>
		<span class="n">SCLK_CNTL__FORCE_RB</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Clear VCLK_ECP_CNTL &amp; PIXCLKS_CNTL  */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllVCLK_ECP_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPIXCLKS_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Setup MCLK_MISC, non dynamic mode */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMCLK_MISC</span><span class="p">,</span>
	       <span class="n">MCLK_MISC__MC_MCLK_MAX_DYN_STOP_LAT</span> <span class="o">|</span>
	       <span class="n">MCLK_MISC__IO_MCLK_MAX_DYN_STOP_LAT</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Set back the default clock dividers */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllM_SPLL_REF_FB_DIV</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">77</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMPLL_AUX_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">75</span><span class="p">]);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSPLL_AUX_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">76</span><span class="p">]);</span>

	<span class="cm">/* PPLL and P2PLL default values &amp; off */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPPLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">93</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllP2PLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>

	<span class="cm">/* S and M PLLs are reset &amp; off, configure them */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMPLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">73</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSPLL_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">74</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="cm">/* Default values for MDLL ... fixme */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_CKO</span><span class="p">,</span> <span class="mh">0x9c009c</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKA</span><span class="p">,</span> <span class="mh">0x08830883</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllMDLL_RDCKB</span><span class="p">,</span> <span class="mh">0x08830883</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Restore PLL_PWRMGT_CNTL */</span> <span class="c1">// XXXX</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLL_PWRMGT_CNTL_SU_SCLK_USE_BCLK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PLL_PWRMGT_CNTL_SU_MCLK_USE_BCLK</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">PLL_PWRMGT_CNTL</span><span class="p">,</span>  <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Clear HTOTAL_CNTL &amp; HTOTAL2_CNTL */</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllHTOTAL_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllHTOTAL2_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* All outputs off */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="mh">0x04000000</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CRTC2_GEN_CNTL</span><span class="p">,</span> <span class="mh">0x04000000</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">FP_GEN_CNTL</span><span class="p">,</span> <span class="mh">0x00004008</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">FP2_GEN_CNTL</span><span class="p">,</span> <span class="mh">0x00000008</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="mh">0x08000008</span><span class="p">);</span>

	<span class="cm">/* Restore Memory Controller configuration */</span>
	<span class="n">radeon_pm_m9p_reconfigure_mc</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Now we actually start MCLK and SCLK */</span>
	<span class="n">radeon_pm_start_mclk_sclk</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Full reset sdrams, this also re-inits the MDLL */</span>
	<span class="n">radeon_pm_full_reset_sdram</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="cm">/* Fill palettes */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">PALETTE_30_DATA</span><span class="p">,</span> <span class="mh">0x15555555</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">PALETTE_30_DATA</span><span class="p">,</span> <span class="mh">0x15555555</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DAC_CNTL2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* Restore TV stuff, make sure TV DAC is down */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">TV_MASTER_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">88</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">TV_DAC_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x07000000</span><span class="p">);</span>

	<span class="cm">/* Restore GPIOS. MacOS does some magic here with one of the GPIO bits,</span>
<span class="cm">	 * possibly related to the weird PLL related workarounds and to the</span>
<span class="cm">	 * fact that CLK_PIN_CNTL is tweaked in ways I don&#39;t fully understand,</span>
<span class="cm">	 * but we keep things the simple way here</span>
<span class="cm">	 */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_A</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">19</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_EN</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GPIOPAD_MASK</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>

	<span class="cm">/* Now do things with SCLK_MORE_CNTL. Force bits are already set, copy</span>
<span class="cm">	 * high bits from backup</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SCLK_MORE_CNTL__FORCE_DISPREGS</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SCLK_MORE_CNTL__FORCE_DISPREGS</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSCLK_MORE_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;</span>
	       <span class="o">~</span><span class="p">(</span><span class="n">LVDS_EN</span> <span class="o">|</span> <span class="n">LVDS_ON</span> <span class="o">|</span> <span class="n">LVDS_DIGON</span> <span class="o">|</span> <span class="n">LVDS_BLON</span> <span class="o">|</span> <span class="n">LVDS_BL_MOD_EN</span><span class="p">));</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">LVDS_BLON</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_PLL_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf0000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20000</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* write some stuff to the framebuffer... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">fb_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="mh">0x2ec</span><span class="p">,</span> <span class="mh">0x6332a020</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSSPLL_REF_DIV</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span> <span class="cm">/*0x3f */</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSSPLL_DIV_0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="cm">/*0x000081bb */</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">pllSSPLL_CNTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSSPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSSPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSSPLL_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllSS_INT_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">90</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span><span class="cm">/*0x0020300c*/</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="mh">0x2ec</span><span class="p">,</span> <span class="mh">0x6332a3f0</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">17</span><span class="p">);</span>

	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPPLL_REF_DIV</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">ref_div</span><span class="p">);</span>
	<span class="n">OUTPLL</span><span class="p">(</span><span class="n">pllPPLL_DIV_0</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">92</span><span class="p">]);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">LVDS_DIGON</span> <span class="o">|</span> <span class="n">LVDS_ON</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="cm">/* Restore a few more things */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GRPH_BUFFER_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">94</span><span class="p">]);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">GRPH2_BUFFER_CNTL</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">95</span><span class="p">]);</span>

	<span class="cm">/* Restore PPLL, spread spectrum &amp; LVDS */</span>
	<span class="n">radeon_pm_m10_disable_spread_spectrum</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="n">radeon_pm_restore_pixel_pll</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="n">radeon_pm_m10_enable_lvds_spread_spectrum</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* Not ready yet */</span>
<span class="c">static void radeon_reinitialize_QW(struct radeonfb_info *rinfo)</span>
<span class="c">{</span>
<span class="c">	int i;</span>
<span class="c">	u32 tmp, tmp2;</span>
<span class="c">	u32 cko, cka, ckb;</span>
<span class="c">	u32 cgc, cec, c2gc;</span>

<span class="c">	OUTREG(MC_AGP_LOCATION, rinfo-&gt;save_regs[32]);</span>
<span class="c">	OUTREG(DISPLAY_BASE_ADDR, rinfo-&gt;save_regs[31]);</span>
<span class="c">	OUTREG(CRTC2_DISPLAY_BASE_ADDR, rinfo-&gt;save_regs[33]);</span>
<span class="c">	OUTREG(MC_FB_LOCATION, rinfo-&gt;save_regs[30]);</span>
<span class="c">	OUTREG(BUS_CNTL, rinfo-&gt;save_regs[36]);</span>
<span class="c">	OUTREG(RBBM_CNTL, rinfo-&gt;save_regs[39]);</span>

<span class="c">	INREG(PAD_CTLR_STRENGTH);</span>
<span class="c">	OUTREG(PAD_CTLR_STRENGTH, INREG(PAD_CTLR_STRENGTH) &amp; ~0x10000);</span>
<span class="c">	for (i = 0; i &lt; 65; ++i) {</span>
<span class="c">		mdelay(1);</span>
<span class="c">		INREG(PAD_CTLR_STRENGTH);</span>
<span class="c">	}</span>

<span class="c">	OUTREG(DISP_TEST_DEBUG_CNTL, INREG(DISP_TEST_DEBUG_CNTL) | 0x10000000);</span>
<span class="c">	OUTREG(OV0_FLAG_CNTRL, INREG(OV0_FLAG_CNTRL) | 0x100);</span>
<span class="c">	OUTREG(CRTC_GEN_CNTL, INREG(CRTC_GEN_CNTL));</span>
<span class="c">	OUTREG(DAC_CNTL, 0xff00410a);</span>
<span class="c">	OUTREG(CRTC2_GEN_CNTL, INREG(CRTC2_GEN_CNTL));</span>
<span class="c">	OUTREG(DAC_CNTL2, INREG(DAC_CNTL2) | 0x4000);</span>

<span class="c">	OUTREG(SURFACE_CNTL, rinfo-&gt;save_regs[29]);</span>
<span class="c">	OUTREG(AGP_CNTL, rinfo-&gt;save_regs[16]);</span>
<span class="c">	OUTREG(HOST_PATH_CNTL, rinfo-&gt;save_regs[41]);</span>
<span class="c">	OUTREG(DISP_MISC_CNTL, rinfo-&gt;save_regs[9]);</span>

<span class="c">	OUTMC(rinfo, ixMC_CHP_IO_CNTL_A0, 0xf7bb4433);</span>
<span class="c">	OUTREG(MC_IND_INDEX, 0);</span>
<span class="c">	OUTMC(rinfo, ixMC_CHP_IO_CNTL_B0, 0xf7bb4433);</span>
<span class="c">	OUTREG(MC_IND_INDEX, 0);</span>

<span class="c">	OUTREG(CRTC_MORE_CNTL, INREG(CRTC_MORE_CNTL));</span>

<span class="c">	tmp = INPLL(pllVCLK_ECP_CNTL);</span>
<span class="c">	OUTPLL(pllVCLK_ECP_CNTL, tmp);</span>
<span class="c">	tmp = INPLL(pllPIXCLKS_CNTL);</span>
<span class="c">	OUTPLL(pllPIXCLKS_CNTL, tmp);</span>

<span class="c">	OUTPLL(MCLK_CNTL, 0xaa3f0000);</span>
<span class="c">	OUTPLL(SCLK_CNTL, 0xffff0000);</span>
<span class="c">	OUTPLL(pllMPLL_AUX_CNTL, 6);</span>
<span class="c">	OUTPLL(pllSPLL_AUX_CNTL, 1);</span>
<span class="c">	OUTPLL(MDLL_CKO, 0x9f009f);</span>
<span class="c">	OUTPLL(MDLL_RDCKA, 0x830083);</span>
<span class="c">	OUTPLL(pllMDLL_RDCKB, 0x830083);</span>
<span class="c">	OUTPLL(PPLL_CNTL, 0xa433);</span>
<span class="c">	OUTPLL(P2PLL_CNTL, 0xa433);</span>
<span class="c">	OUTPLL(MPLL_CNTL, 0x0400a403);</span>
<span class="c">	OUTPLL(SPLL_CNTL, 0x0400a433);</span>

<span class="c">	tmp = INPLL(M_SPLL_REF_FB_DIV);</span>
<span class="c">	OUTPLL(M_SPLL_REF_FB_DIV, tmp);</span>
<span class="c">	tmp = INPLL(M_SPLL_REF_FB_DIV);</span>
<span class="c">	OUTPLL(M_SPLL_REF_FB_DIV, tmp | 0xc);</span>
<span class="c">	INPLL(M_SPLL_REF_FB_DIV);</span>

<span class="c">	tmp = INPLL(MPLL_CNTL);</span>
<span class="c">	OUTREG8(CLOCK_CNTL_INDEX, MPLL_CNTL + PLL_WR_EN);</span>
<span class="c">	radeon_pll_errata_after_index(rinfo);</span>
<span class="c">	OUTREG8(CLOCK_CNTL_DATA + 1, (tmp &gt;&gt; 8) &amp; 0xff);</span>
<span class="c">	radeon_pll_errata_after_data(rinfo);</span>

<span class="c">	tmp = INPLL(M_SPLL_REF_FB_DIV);</span>
<span class="c">	OUTPLL(M_SPLL_REF_FB_DIV, tmp | 0x5900);</span>

<span class="c">	tmp = INPLL(MPLL_CNTL);</span>
<span class="c">	OUTPLL(MPLL_CNTL, tmp &amp; ~0x2);</span>
<span class="c">	mdelay(1);</span>
<span class="c">	tmp = INPLL(MPLL_CNTL);</span>
<span class="c">	OUTPLL(MPLL_CNTL, tmp &amp; ~0x1);</span>
<span class="c">	mdelay(10);</span>

<span class="c">	OUTPLL(MCLK_CNTL, 0xaa3f1212);</span>
<span class="c">	mdelay(1);</span>

<span class="c">	INPLL(M_SPLL_REF_FB_DIV);</span>
<span class="c">	INPLL(MCLK_CNTL);</span>
<span class="c">	INPLL(M_SPLL_REF_FB_DIV);</span>

<span class="c">	tmp = INPLL(SPLL_CNTL);</span>
<span class="c">	OUTREG8(CLOCK_CNTL_INDEX, SPLL_CNTL + PLL_WR_EN);</span>
<span class="c">	radeon_pll_errata_after_index(rinfo);</span>
<span class="c">	OUTREG8(CLOCK_CNTL_DATA + 1, (tmp &gt;&gt; 8) &amp; 0xff);</span>
<span class="c">	radeon_pll_errata_after_data(rinfo);</span>

<span class="c">	tmp = INPLL(M_SPLL_REF_FB_DIV);</span>
<span class="c">	OUTPLL(M_SPLL_REF_FB_DIV, tmp | 0x780000);</span>

<span class="c">	tmp = INPLL(SPLL_CNTL);</span>
<span class="c">	OUTPLL(SPLL_CNTL, tmp &amp; ~0x1);</span>
<span class="c">	mdelay(1);</span>
<span class="c">	tmp = INPLL(SPLL_CNTL);</span>
<span class="c">	OUTPLL(SPLL_CNTL, tmp &amp; ~0x2);</span>
<span class="c">	mdelay(10);</span>

<span class="c">	tmp = INPLL(SCLK_CNTL);</span>
<span class="c">	OUTPLL(SCLK_CNTL, tmp | 2);</span>
<span class="c">	mdelay(1);</span>

<span class="c">	cko = INPLL(pllMDLL_CKO);</span>
<span class="c">	cka = INPLL(pllMDLL_RDCKA);</span>
<span class="c">	ckb = INPLL(pllMDLL_RDCKB);</span>

<span class="c">	cko &amp;= ~(MDLL_CKO__MCKOA_SLEEP | MDLL_CKO__MCKOB_SLEEP);</span>
<span class="c">	OUTPLL(pllMDLL_CKO, cko);</span>
<span class="c">	mdelay(1);</span>
<span class="c">	cko &amp;= ~(MDLL_CKO__MCKOA_RESET | MDLL_CKO__MCKOB_RESET);</span>
<span class="c">	OUTPLL(pllMDLL_CKO, cko);</span>
<span class="c">	mdelay(5);</span>

<span class="c">	cka &amp;= ~(MDLL_RDCKA__MRDCKA0_SLEEP | MDLL_RDCKA__MRDCKA1_SLEEP);</span>
<span class="c">	OUTPLL(pllMDLL_RDCKA, cka);</span>
<span class="c">	mdelay(1);</span>
<span class="c">	cka &amp;= ~(MDLL_RDCKA__MRDCKA0_RESET | MDLL_RDCKA__MRDCKA1_RESET);</span>
<span class="c">	OUTPLL(pllMDLL_RDCKA, cka);</span>
<span class="c">	mdelay(5);</span>

<span class="c">	ckb &amp;= ~(MDLL_RDCKB__MRDCKB0_SLEEP | MDLL_RDCKB__MRDCKB1_SLEEP);</span>
<span class="c">	OUTPLL(pllMDLL_RDCKB, ckb);</span>
<span class="c">	mdelay(1);</span>
<span class="c">	ckb &amp;= ~(MDLL_RDCKB__MRDCKB0_RESET | MDLL_RDCKB__MRDCKB1_RESET);</span>
<span class="c">	OUTPLL(pllMDLL_RDCKB, ckb);</span>
<span class="c">	mdelay(5);</span>

<span class="c">	OUTMC(rinfo, ixMC_CHP_IO_CNTL_A1, 0x151550ff);</span>
<span class="c">	OUTREG(MC_IND_INDEX, 0);</span>
<span class="c">	OUTMC(rinfo, ixMC_CHP_IO_CNTL_B1, 0x151550ff);</span>
<span class="c">	OUTREG(MC_IND_INDEX, 0);</span>
<span class="c">	mdelay(1);</span>
<span class="c">	OUTMC(rinfo, ixMC_CHP_IO_CNTL_A1, 0x141550ff);</span>
<span class="c">	OUTREG(MC_IND_INDEX, 0);</span>
<span class="c">	OUTMC(rinfo, ixMC_CHP_IO_CNTL_B1, 0x141550ff);</span>
<span class="c">	OUTREG(MC_IND_INDEX, 0);</span>
<span class="c">	mdelay(1);</span>

<span class="c">	OUTPLL(pllHTOTAL_CNTL, 0);</span>
<span class="c">	OUTPLL(pllHTOTAL2_CNTL, 0);</span>

<span class="c">	OUTREG(MEM_CNTL, 0x29002901);</span>
<span class="c">	OUTREG(MEM_SDRAM_MODE_REG, 0x45320032);	/* XXX use save_regs[35]? */</span>
<span class="c">	OUTREG(EXT_MEM_CNTL, 0x1a394333);</span>
<span class="c">	OUTREG(MEM_IO_CNTL_A1, 0x0aac0aac);</span>
<span class="c">	OUTREG(MEM_INIT_LATENCY_TIMER, 0x34444444);</span>
<span class="c">	OUTREG(MEM_REFRESH_CNTL, 0x1f1f7218);	/* XXX or save_regs[42]? */</span>
<span class="c">	OUTREG(MC_DEBUG, 0);</span>
<span class="c">	OUTREG(MEM_IO_OE_CNTL, 0x04300430);</span>

<span class="c">	OUTMC(rinfo, ixMC_IMP_CNTL, 0x00f460d6);</span>
<span class="c">	OUTREG(MC_IND_INDEX, 0);</span>
<span class="c">	OUTMC(rinfo, ixMC_IMP_CNTL_0, 0x00009249);</span>
<span class="c">	OUTREG(MC_IND_INDEX, 0);</span>

<span class="c">	OUTREG(CNFG_MEMSIZE, rinfo-&gt;video_ram);</span>

<span class="c">	radeon_pm_full_reset_sdram(rinfo);</span>

<span class="c">	INREG(FP_GEN_CNTL);</span>
<span class="c">	OUTREG(TMDS_CNTL, 0x01000000);	/* XXX ? */</span>
<span class="c">	tmp = INREG(FP_GEN_CNTL);</span>
<span class="c">	tmp |= FP_CRTC_DONT_SHADOW_HEND | FP_CRTC_DONT_SHADOW_VPAR | 0x200;</span>
<span class="c">	OUTREG(FP_GEN_CNTL, tmp);</span>

<span class="c">	tmp = INREG(DISP_OUTPUT_CNTL);</span>
<span class="c">	tmp &amp;= ~0x400;</span>
<span class="c">	OUTREG(DISP_OUTPUT_CNTL, tmp);</span>

<span class="c">	OUTPLL(CLK_PIN_CNTL, rinfo-&gt;save_regs[4]);</span>
<span class="c">	OUTPLL(CLK_PWRMGT_CNTL, rinfo-&gt;save_regs[1]);</span>
<span class="c">	OUTPLL(PLL_PWRMGT_CNTL, rinfo-&gt;save_regs[0]);</span>

<span class="c">	tmp = INPLL(MCLK_MISC);</span>
<span class="c">	tmp |= MCLK_MISC__MC_MCLK_DYN_ENABLE | MCLK_MISC__IO_MCLK_DYN_ENABLE;</span>
<span class="c">	OUTPLL(MCLK_MISC, tmp);</span>

<span class="c">	tmp = INPLL(SCLK_CNTL);</span>
<span class="c">	OUTPLL(SCLK_CNTL, tmp);</span>

<span class="c">	OUTREG(CRTC_MORE_CNTL, 0);</span>
<span class="c">	OUTREG8(CRTC_GEN_CNTL+1, 6);</span>
<span class="c">	OUTREG8(CRTC_GEN_CNTL+3, 1);</span>
<span class="c">	OUTREG(CRTC_PITCH, 32);</span>

<span class="c">	tmp = INPLL(VCLK_ECP_CNTL);</span>
<span class="c">	OUTPLL(VCLK_ECP_CNTL, tmp);</span>

<span class="c">	tmp = INPLL(PPLL_CNTL);</span>
<span class="c">	OUTPLL(PPLL_CNTL, tmp);</span>

<span class="c">	/* palette stuff and BIOS_1_SCRATCH... */</span>

<span class="c">	tmp = INREG(FP_GEN_CNTL);</span>
<span class="c">	tmp2 = INREG(TMDS_TRANSMITTER_CNTL);</span>
<span class="c">	tmp |= 2;</span>
<span class="c">	OUTREG(FP_GEN_CNTL, tmp);</span>
<span class="c">	mdelay(5);</span>
<span class="c">	OUTREG(FP_GEN_CNTL, tmp);</span>
<span class="c">	mdelay(5);</span>
<span class="c">	OUTREG(TMDS_TRANSMITTER_CNTL, tmp2);</span>
<span class="c">	OUTREG(CRTC_MORE_CNTL, 0);</span>
<span class="c">	mdelay(20);</span>

<span class="c">	tmp = INREG(CRTC_MORE_CNTL);</span>
<span class="c">	OUTREG(CRTC_MORE_CNTL, tmp);</span>

<span class="c">	cgc = INREG(CRTC_GEN_CNTL);</span>
<span class="c">	cec = INREG(CRTC_EXT_CNTL);</span>
<span class="c">	c2gc = INREG(CRTC2_GEN_CNTL);</span>

<span class="c">	OUTREG(CRTC_H_SYNC_STRT_WID, 0x008e0580);</span>
<span class="c">	OUTREG(CRTC_H_TOTAL_DISP, 0x009f00d2);</span>
<span class="c">	OUTREG8(CLOCK_CNTL_INDEX, HTOTAL_CNTL + PLL_WR_EN);</span>
<span class="c">	radeon_pll_errata_after_index(rinfo);</span>
<span class="c">	OUTREG8(CLOCK_CNTL_DATA, 0);</span>
<span class="c">	radeon_pll_errata_after_data(rinfo);</span>
<span class="c">	OUTREG(CRTC_V_SYNC_STRT_WID, 0x00830403);</span>
<span class="c">	OUTREG(CRTC_V_TOTAL_DISP, 0x03ff0429);</span>
<span class="c">	OUTREG(FP_CRTC_H_TOTAL_DISP, 0x009f0033);</span>
<span class="c">	OUTREG(FP_H_SYNC_STRT_WID, 0x008e0080);</span>
<span class="c">	OUTREG(CRT_CRTC_H_SYNC_STRT_WID, 0x008e0080);</span>
<span class="c">	OUTREG(FP_CRTC_V_TOTAL_DISP, 0x03ff002a);</span>
<span class="c">	OUTREG(FP_V_SYNC_STRT_WID, 0x00830004);</span>
<span class="c">	OUTREG(CRT_CRTC_V_SYNC_STRT_WID, 0x00830004);</span>
<span class="c">	OUTREG(FP_HORZ_VERT_ACTIVE, 0x009f03ff);</span>
<span class="c">	OUTREG(FP_HORZ_STRETCH, 0);</span>
<span class="c">	OUTREG(FP_VERT_STRETCH, 0);</span>
<span class="c">	OUTREG(OVR_CLR, 0);</span>
<span class="c">	OUTREG(OVR_WID_LEFT_RIGHT, 0);</span>
<span class="c">	OUTREG(OVR_WID_TOP_BOTTOM, 0);</span>

<span class="c">	tmp = INPLL(PPLL_REF_DIV);</span>
<span class="c">	tmp = (tmp &amp; ~PPLL_REF_DIV_MASK) | rinfo-&gt;pll.ref_div;</span>
<span class="c">	OUTPLL(PPLL_REF_DIV, tmp);</span>
<span class="c">	INPLL(PPLL_REF_DIV);</span>

<span class="c">	OUTREG8(CLOCK_CNTL_INDEX, PPLL_CNTL + PLL_WR_EN);</span>
<span class="c">	radeon_pll_errata_after_index(rinfo);</span>
<span class="c">	OUTREG8(CLOCK_CNTL_DATA + 1, 0xbc);</span>
<span class="c">	radeon_pll_errata_after_data(rinfo);</span>

<span class="c">	tmp = INREG(CLOCK_CNTL_INDEX);</span>
<span class="c">	radeon_pll_errata_after_index(rinfo);</span>
<span class="c">	OUTREG(CLOCK_CNTL_INDEX, tmp &amp; 0xff);</span>
<span class="c">	radeon_pll_errata_after_index(rinfo);</span>
<span class="c">	radeon_pll_errata_after_data(rinfo);</span>

<span class="c">	OUTPLL(PPLL_DIV_0, 0x48090);</span>

<span class="c">	tmp = INPLL(PPLL_CNTL);</span>
<span class="c">	OUTPLL(PPLL_CNTL, tmp &amp; ~0x2);</span>
<span class="c">	mdelay(1);</span>
<span class="c">	tmp = INPLL(PPLL_CNTL);</span>
<span class="c">	OUTPLL(PPLL_CNTL, tmp &amp; ~0x1);</span>
<span class="c">	mdelay(10);</span>

<span class="c">	tmp = INPLL(VCLK_ECP_CNTL);</span>
<span class="c">	OUTPLL(VCLK_ECP_CNTL, tmp | 3);</span>
<span class="c">	mdelay(1);</span>

<span class="c">	tmp = INPLL(VCLK_ECP_CNTL);</span>
<span class="c">	OUTPLL(VCLK_ECP_CNTL, tmp);</span>

<span class="c">	c2gc |= CRTC2_DISP_REQ_EN_B;</span>
<span class="c">	OUTREG(CRTC2_GEN_CNTL, c2gc);</span>
<span class="c">	cgc |= CRTC_EN;</span>
<span class="c">	OUTREG(CRTC_GEN_CNTL, cgc);</span>
<span class="c">	OUTREG(CRTC_EXT_CNTL, cec);</span>
<span class="c">	OUTREG(CRTC_PITCH, 0xa0);</span>
<span class="c">	OUTREG(CRTC_OFFSET, 0);</span>
<span class="c">	OUTREG(CRTC_OFFSET_CNTL, 0);</span>

<span class="c">	OUTREG(GRPH_BUFFER_CNTL, 0x20117c7c);</span>
<span class="c">	OUTREG(GRPH2_BUFFER_CNTL, 0x00205c5c);</span>

<span class="c">	tmp2 = INREG(FP_GEN_CNTL);</span>
<span class="c">	tmp = INREG(TMDS_TRANSMITTER_CNTL);</span>
<span class="c">	OUTREG(0x2a8, 0x0000061b);</span>
<span class="c">	tmp |= TMDS_PLL_EN;</span>
<span class="c">	OUTREG(TMDS_TRANSMITTER_CNTL, tmp);</span>
<span class="c">	mdelay(1);</span>
<span class="c">	tmp &amp;= ~TMDS_PLLRST;</span>
<span class="c">	OUTREG(TMDS_TRANSMITTER_CNTL, tmp);</span>
<span class="c">	tmp2 &amp;= ~2;</span>
<span class="c">	tmp2 |= FP_TMDS_EN;</span>
<span class="c">	OUTREG(FP_GEN_CNTL, tmp2);</span>
<span class="c">	mdelay(5);</span>
<span class="c">	tmp2 |= FP_FPON;</span>
<span class="c">	OUTREG(FP_GEN_CNTL, tmp2);</span>

<span class="c">	OUTREG(CUR_HORZ_VERT_OFF, CUR_LOCK | 1);</span>
<span class="c">	cgc = INREG(CRTC_GEN_CNTL);</span>
<span class="c">	OUTREG(CUR_HORZ_VERT_POSN, 0xbfff0fff);</span>
<span class="c">	cgc |= 0x10000;</span>
<span class="c">	OUTREG(CUR_OFFSET, 0);</span>
<span class="c">}</span>
<span class="cp">#endif /* 0 */</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_OF */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeonfb_whack_power_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">pci_power_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pwr_cmd</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_reg</span><span class="o">+</span><span class="n">PCI_PM_CTRL</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">pwr_cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pwr_cmd</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pwr_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">pwr_cmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_PM_CTRL_STATE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_reg</span><span class="o">+</span><span class="n">PCI_PM_CTRL</span><span class="p">,</span>
				      <span class="n">pwr_cmd</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_set_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">suspend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_reg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Set the chip into appropriate suspend mode (we use D2,</span>
<span class="cm">	 * D3 would require a compete re-initialization of the chip,</span>
<span class="cm">	 * including PCI config registers, clocks, AGP conf, ...)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;radeonfb (%s): switching to D2 state...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>

		<span class="cm">/* Disable dynamic power management of clocks for the</span>
<span class="cm">		 * duration of the suspend/resume process</span>
<span class="cm">		 */</span>
		<span class="n">radeon_pm_disable_dynamic_mode</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

		<span class="cm">/* Save some registers */</span>
		<span class="n">radeon_pm_save_regs</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Prepare mobility chips for suspend.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Program V2CLK */</span>
			<span class="n">radeon_pm_program_v2clk</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
		
			<span class="cm">/* Disable IO PADs */</span>
			<span class="n">radeon_pm_disable_iopad</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

			<span class="cm">/* Set low current */</span>
			<span class="n">radeon_pm_low_current</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

			<span class="cm">/* Prepare chip for power management */</span>
			<span class="n">radeon_pm_setup_for_suspend</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;=</span> <span class="n">CHIP_FAMILY_RV280</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Reset the MDLL */</span>
				<span class="cm">/* because both INPLL and OUTPLL take the same</span>
<span class="cm">				 * lock, that&#39;s why. */</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">INPLL</span><span class="p">(</span> <span class="n">pllMDLL_CKO</span><span class="p">)</span> <span class="o">|</span> <span class="n">MDLL_CKO__MCKOA_RESET</span>
					<span class="o">|</span> <span class="n">MDLL_CKO__MCKOB_RESET</span><span class="p">;</span>
				<span class="n">OUTPLL</span><span class="p">(</span> <span class="n">pllMDLL_CKO</span><span class="p">,</span> <span class="n">tmp</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Switch PCI power management to D2. */</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_save_state</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="cm">/* The chip seems to need us to whack the PM register</span>
<span class="cm">		 * repeatedly until it sticks. We do that -prior- to</span>
<span class="cm">		 * calling pci_set_power_state()</span>
<span class="cm">		 */</span>
		<span class="n">radeonfb_whack_power_state</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">PCI_D2</span><span class="p">);</span>
		<span class="n">__pci_complete_power_transition</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;radeonfb (%s): switching to D0 state...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;=</span> <span class="n">CHIP_FAMILY_RV250</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Reset the SDRAM controller  */</span>
			<span class="n">radeon_pm_full_reset_sdram</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

			<span class="cm">/* Restore some registers */</span>
			<span class="n">radeon_pm_restore_regs</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Restore registers first */</span>
			<span class="n">radeon_pm_restore_regs</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
			<span class="cm">/* init sdram controller */</span>
			<span class="n">radeon_pm_full_reset_sdram</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeonfb_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;radeonfb (%s): suspending for event: %d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">mesg</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>

	<span class="cm">/* For suspend-to-disk, we cheat here. We don&#39;t suspend anything and</span>
<span class="cm">	 * let fbcon continue drawing until we are all set. That shouldn&#39;t</span>
<span class="cm">	 * really cause any problem at this point, provided that the wakeup</span>
<span class="cm">	 * code knows that any state in memory may not match the HW</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_EVENT_FREEZE</span>:		<span class="cm">/* about to take snapshot */</span>
	<span class="k">case</span> <span class="n">PM_EVENT_PRETHAW</span>:		<span class="cm">/* before restoring snapshot */</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">console_lock</span><span class="p">();</span>

	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Make sure engine is reset */</span>
		<span class="n">radeon_engine_idle</span><span class="p">();</span>
		<span class="n">radeonfb_engine_reset</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
		<span class="n">radeon_engine_idle</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Blank display and LCD */</span>
	<span class="n">radeon_screen_blank</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">FB_BLANK_POWERDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Sleep */</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">asleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">lock_blank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">lvds_timer</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="cm">/* On powermac, we have hooks to properly suspend/resume AGP now,</span>
<span class="cm">	 * use them here. We&#39;ll ultimately need some generic support here,</span>
<span class="cm">	 * but the generic code isn&#39;t quite ready for that yet</span>
<span class="cm">	 */</span>
	<span class="n">pmac_suspend_agp_for_card</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>

	<span class="cm">/* It&#39;s unclear whether or when the generic code will do that, so let&#39;s</span>
<span class="cm">	 * do it ourselves. We save state before we do any power management</span>
<span class="cm">	 */</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* If we support wakeup from poweroff, we save all regs we can including cfg</span>
<span class="cm">	 * space</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">&amp;</span> <span class="n">radeon_pm_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Always disable dynamic clocks or weird things are happening when</span>
<span class="cm">		 * the chip goes off (basically the panel doesn&#39;t shut down properly</span>
<span class="cm">		 * and we crash on wakeup),</span>
<span class="cm">		 * also, we want the saved regs context to have no dynamic clocks in</span>
<span class="cm">		 * it, we&#39;ll restore the dynamic clocks state on wakeup</span>
<span class="cm">		 */</span>
		<span class="n">radeon_pm_disable_dynamic_mode</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">radeon_pm_save_regs</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">&amp;</span> <span class="n">radeon_pm_d2</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Switch off LVDS interface */</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LVDS_BL_MOD_EN</span><span class="p">));</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LVDS_EN</span> <span class="o">|</span> <span class="n">LVDS_ON</span><span class="p">));</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_PLL_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_PLL_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">30000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20000</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LVDS_DIGON</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* If we support D2, we go to it (should be fixed later with a flag forcing</span>
<span class="cm">	 * D3 only for some laptops)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">&amp;</span> <span class="n">radeon_pm_d2</span><span class="p">)</span>
		<span class="n">radeon_set_suspend</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">console_unlock</span><span class="p">();</span>

 <span class="nl">done:</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">mesg</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_check_power_loss</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">CLK_PIN_CNTL</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">MCLK_CNTL</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">INPLL</span><span class="p">(</span><span class="n">SCLK_CNTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeonfb_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_ON</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">no_schedule</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">console_trylock</span><span class="p">())</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">console_lock</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;radeonfb (%s): resuming from state: %d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>

	<span class="cm">/* PCI state will have been restored by the core, so</span>
<span class="cm">	 * we should be in D0 now with our config space fully</span>
<span class="cm">	 * restored</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wakeup chip */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">&amp;</span> <span class="n">radeon_pm_off</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">radeon_check_power_loss</span><span class="p">(</span><span class="n">rinfo</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">reinit_func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">reinit_func</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;radeonfb (%s): can&#39;t resume radeon from&quot;</span>
				       <span class="s">&quot; D3 cold, need softboot !&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* If we support D2, try to resume... we should check what was our</span>
<span class="cm">		 * state though... (were we really in D2 state ?). Right now, this code</span>
<span class="cm">		 * is only enable on Macs so it&#39;s fine.</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">&amp;</span> <span class="n">radeon_pm_d2</span><span class="p">)</span>
			<span class="n">radeon_set_suspend</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">asleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">radeon_engine_idle</span><span class="p">();</span>

	<span class="cm">/* Restore display &amp; engine */</span>
	<span class="n">radeon_write_mode</span> <span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">))</span>
		<span class="n">radeonfb_engine_init</span> <span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="n">fb_pan_display</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
	<span class="n">fb_set_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Refresh */</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Unblank */</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">lock_blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">radeon_screen_blank</span><span class="p">(</span><span class="n">rinfo</span><span class="p">,</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="cm">/* On powermac, we have hooks to properly suspend/resume AGP now,</span>
<span class="cm">	 * use them here. We&#39;ll ultimately need some generic support here,</span>
<span class="cm">	 * but the generic code isn&#39;t quite ready for that yet</span>
<span class="cm">	 */</span>
	<span class="n">pmac_resume_agp_for_card</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>


	<span class="cm">/* Check status of dynclk */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dynclk</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">radeon_pm_enable_dynamic_mode</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dynclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">radeon_pm_disable_dynamic_mode</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">PMSG_ON</span><span class="p">;</span>

 <span class="nl">bail:</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC_OF__disabled</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeonfb_early_resume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">no_schedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">radeonfb_pci_resume</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">no_schedule</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_OF */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">radeonfb_pm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dynclk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore_devlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_sleep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Find PM registers in config space if any*/</span>
	<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_reg</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PM</span><span class="p">);</span>

	<span class="cm">/* Enable/Disable dynamic clocks: TODO add sysfs access */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_FAMILY_RS480</span><span class="p">)</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dynclk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dynclk</span> <span class="o">=</span> <span class="n">dynclk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dynclk</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_pm_enable_dynamic_mode</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;radeonfb: Dynamic Clock Power Management enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dynclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_pm_disable_dynamic_mode</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;radeonfb: Dynamic Clock Power Management disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if defined(CONFIG_PM)</span>
<span class="cp">#if defined(CONFIG_PPC_PMAC)</span>
	<span class="cm">/* Check if we can power manage on suspend/resume. We can do</span>
<span class="cm">	 * D2 on M6, M7 and M9, and we can resume from D3 cold a few other</span>
<span class="cm">	 * &quot;Mac&quot; cards, but that&#39;s all. We need more infos about what the</span>
<span class="cm">	 * BIOS does tho. Right now, all this PM stuff is pmac-only for that</span>
<span class="cm">	 * reason. --BenH</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">is_mobility</span> <span class="o">&amp;&amp;</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_reg</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;=</span> <span class="n">CHIP_FAMILY_RV250</span><span class="p">)</span>
			<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">|=</span> <span class="n">radeon_pm_d2</span><span class="p">;</span>

		<span class="cm">/* We can restart Jasper (M10 chip in albooks), BlueStone (7500 chip</span>
<span class="cm">		 * in some desktop G4s), Via (M9+ chip on iBook G4) and</span>
<span class="cm">		 * Snowy (M11 chip on iBook G4 manufactured after July 2005)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ATY,JasperParent&quot;</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ATY,SnowyParent&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">reinit_func</span> <span class="o">=</span> <span class="n">radeon_reinitialize_M10</span><span class="p">;</span>
			<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">|=</span> <span class="n">radeon_pm_off</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"> /* Not ready yet */</span>
<span class="c">		if (!strcmp(rinfo-&gt;of_node-&gt;name, &quot;ATY,BlueStoneParent&quot;)) {</span>
<span class="c">			rinfo-&gt;reinit_func = radeon_reinitialize_QW;</span>
<span class="c">			rinfo-&gt;pm_mode |= radeon_pm_off;</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ATY,ViaParent&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">reinit_func</span> <span class="o">=</span> <span class="n">radeon_reinitialize_M9P</span><span class="p">;</span>
			<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">|=</span> <span class="n">radeon_pm_off</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If any of the above is set, we assume the machine can sleep/resume.</span>
<span class="cm">		 * It&#39;s a bit of a &quot;shortcut&quot; but will work fine. Ideally, we need infos</span>
<span class="cm">		 * from the platform about what happens to the chip...</span>
<span class="cm">		 * Now we tell the platform about our capability</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">!=</span> <span class="n">radeon_pm_none</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pmac_call_feature</span><span class="p">(</span><span class="n">PMAC_FTR_DEVICE_CAN_WAKE</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"> /* Disable the early video resume hack for now as it&#39;s causing problems, among</span>
<span class="c">       * others we now rely on the PCI core restoring the config space for us, which</span>
<span class="c">       * isn&#39;t the case with that hack, and that code path causes various things to</span>
<span class="c">       * be called with interrupts off while they shouldn&#39;t. I&#39;m leaving the code in</span>
<span class="c">       * as it can be useful for debugging purposes</span>
<span class="c">       */</span>
<span class="c">			pmac_set_early_video_resume(radeonfb_early_resume, rinfo);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/* Power down TV DAC, that saves a significant amount of power,</span>
<span class="c">		 * we&#39;ll have something better once we actually have some TVOut</span>
<span class="c">		 * support</span>
<span class="c">		 */</span>
<span class="c">		OUTREG(TV_DAC_CNTL, INREG(TV_DAC_CNTL) | 0x07000000);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* defined(CONFIG_PPC_PMAC) */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* defined(CONFIG_PM) */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ignore_devlist</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;radeonfb: skipping test for device workarounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">radeon_apply_workarounds</span><span class="p">(</span><span class="n">rinfo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force_sleep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;radeonfb: forcefully enabling D2 sleep mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">|=</span> <span class="n">radeon_pm_d2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeonfb_pm_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeonfb_info</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_PM) &amp;&amp; defined(CONFIG_PPC_PMAC)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">!=</span> <span class="n">radeon_pm_none</span><span class="p">)</span>
		<span class="n">pmac_set_early_video_resume</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
