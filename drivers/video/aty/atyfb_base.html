<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › aty › atyfb_base.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>atyfb_base.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  ATI Frame Buffer Device Driver Core</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 2004  Alex Kern &lt;alex.kern@gmx.de&gt;</span>
<span class="cm"> *	Copyright (C) 1997-2001  Geert Uytterhoeven</span>
<span class="cm"> *	Copyright (C) 1998  Bernd Harries</span>
<span class="cm"> *	Copyright (C) 1998  Eddie C. Dost  (ecd@skynet.be)</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver supports the following ATI graphics chips:</span>
<span class="cm"> *    - ATI Mach64</span>
<span class="cm"> *</span>
<span class="cm"> *  To do: add support for</span>
<span class="cm"> *    - ATI Rage128 (from aty128fb.c)</span>
<span class="cm"> *    - ATI Radeon (from radeonfb.c)</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is partly based on the PowerMac console driver:</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 1996 Paul Mackerras</span>
<span class="cm"> *</span>
<span class="cm"> *  and on the PowerMac ATI/mach64 display driver:</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 1997 Michael AK Tesch</span>
<span class="cm"> *</span>
<span class="cm"> *	      with work by Jon Howell</span>
<span class="cm"> *			   Harry AC Eaton</span>
<span class="cm"> *			   Anthony Tong &lt;atong@uiuc.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Generic LCD support written by Daniel Mantione, ported from 2.4.20 by Alex Kern</span>
<span class="cm"> *  Many Thanks to Ville Syrjälä for patches and fixing nasting 16 bit color bug.</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> *  License. See the file COPYING in the main directory of this archive for</span>
<span class="cm"> *  more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  Many thanks to Nitya from ATI devrel for support and patience !</span>
<span class="cm"> */</span>

<span class="cm">/******************************************************************************</span>

<span class="cm">  TODO:</span>

<span class="cm">    - cursor support on all cards and all ramdacs.</span>
<span class="cm">    - cursor parameters controlable via ioctl()s.</span>
<span class="cm">    - guess PLL and MCLK based on the original PLL register values initialized</span>
<span class="cm">      by Open Firmware (if they are initialized). BIOS is done</span>

<span class="cm">    (Anyone with Mac to help with this?)</span>

<span class="cm">******************************************************************************/</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;video/mach64.h&gt;</span>
<span class="cp">#include &quot;atyfb.h&quot;</span>
<span class="cp">#include &quot;ati_ids.h&quot;</span>

<span class="cp">#ifdef __powerpc__</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &quot;../macmodes.h&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef __sparc__</span>
<span class="cp">#include &lt;asm/fbio.h&gt;</span>
<span class="cp">#include &lt;asm/oplib.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_ADB_PMU</span>
<span class="cp">#include &lt;linux/adb.h&gt;</span>
<span class="cp">#include &lt;linux/pmu.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BOOTX_TEXT</span>
<span class="cp">#include &lt;asm/btext.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PMAC_BACKLIGHT</span>
<span class="cp">#include &lt;asm/backlight.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Debug flags.</span>
<span class="cm"> */</span>
<span class="cp">#undef DEBUG</span>
<span class="cm">/*#define DEBUG*/</span>

<span class="cm">/* Make sure n * PAGE_SIZE is protected at end of Aperture for GUI-regs */</span>
<span class="cm">/*  - must be large enough to catch all GUI-Regs   */</span>
<span class="cm">/*  - must be aligned to a PAGE boundary           */</span>
<span class="cp">#define GUI_RESERVE	(1 * PAGE_SIZE)</span>

<span class="cm">/* FIXME: remove the FAIL definition */</span>
<span class="cp">#define FAIL(msg) do { \</span>
<span class="cp">	if (!(var-&gt;activate &amp; FB_ACTIVATE_TEST)) \</span>
<span class="cp">		printk(KERN_CRIT &quot;atyfb: &quot; msg &quot;\n&quot;); \</span>
<span class="cp">	return -EINVAL; \</span>
<span class="cp">} while (0)</span>
<span class="cp">#define FAIL_MAX(msg, x, _max_) do { \</span>
<span class="cp">	if (x &gt; _max_) { \</span>
<span class="cp">		if (!(var-&gt;activate &amp; FB_ACTIVATE_TEST)) \</span>
<span class="cp">			printk(KERN_CRIT &quot;atyfb: &quot; msg &quot; %x(%x)\n&quot;, x, _max_); \</span>
<span class="cp">		return -EINVAL; \</span>
<span class="cp">	} \</span>
<span class="cp">} while (0)</span>
<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DPRINTK(fmt, args...)	printk(KERN_DEBUG &quot;atyfb: &quot; fmt, ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(fmt, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#define PRINTKI(fmt, args...)	printk(KERN_INFO &quot;atyfb: &quot; fmt, ## args)</span>
<span class="cp">#define PRINTKE(fmt, args...)	printk(KERN_ERR &quot;atyfb: &quot; fmt, ## args)</span>

<span class="cp">#if defined(CONFIG_PM) || defined(CONFIG_PMAC_BACKLIGHT) || \</span>
<span class="cp">defined (CONFIG_FB_ATY_GENERIC_LCD) || defined(CONFIG_FB_ATY_BACKLIGHT)</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">lt_lcd_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CNFG_PANEL_LG</span><span class="p">,</span>
	<span class="n">LCD_GEN_CNTL_LG</span><span class="p">,</span>
	<span class="n">DSTN_CONTROL_LG</span><span class="p">,</span>
	<span class="n">HFB_PITCH_ADDR_LG</span><span class="p">,</span>
	<span class="n">HORZ_STRETCHING_LG</span><span class="p">,</span>
	<span class="n">VERT_STRETCHING_LG</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="cm">/* EXT_VERT_STRETCH */</span>
	<span class="n">LT_GIO_LG</span><span class="p">,</span>
	<span class="n">POWER_MANAGEMENT_LG</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">aty_st_lcd</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">LT_LCD_REGS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">lt_lcd_regs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">temp</span><span class="p">;</span>

		<span class="cm">/* write addr byte */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">LCD_INDEX</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LCD_INDEX</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCD_INDEX_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">index</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* write the register value */</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LCD_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">aty_ld_lcd</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">LT_LCD_REGS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">lt_lcd_regs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">temp</span><span class="p">;</span>

		<span class="cm">/* write addr byte */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">LCD_INDEX</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LCD_INDEX</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCD_INDEX_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">index</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* read the register value */</span>
		<span class="k">return</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">LCD_DATA</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* defined(CONFIG_PM) || defined(CONFIG_PMAC_BACKLIGHT) || defined (CONFIG_FB_ATY_GENERIC_LCD) */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
<span class="cm">/*</span>
<span class="cm"> * ATIReduceRatio --</span>
<span class="cm"> *</span>
<span class="cm"> * Reduce a fraction by factoring out the largest common divider of the</span>
<span class="cm"> * fraction&#39;s numerator and denominator.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ATIReduceRatio</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">Numerator</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">Denominator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">Multiplier</span><span class="p">,</span> <span class="n">Divider</span><span class="p">,</span> <span class="n">Remainder</span><span class="p">;</span>

	<span class="n">Multiplier</span> <span class="o">=</span> <span class="o">*</span><span class="n">Numerator</span><span class="p">;</span>
	<span class="n">Divider</span> <span class="o">=</span> <span class="o">*</span><span class="n">Denominator</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">Remainder</span> <span class="o">=</span> <span class="n">Multiplier</span> <span class="o">%</span> <span class="n">Divider</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">Multiplier</span> <span class="o">=</span> <span class="n">Divider</span><span class="p">;</span>
		<span class="n">Divider</span> <span class="o">=</span> <span class="n">Remainder</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">Numerator</span> <span class="o">/=</span> <span class="n">Divider</span><span class="p">;</span>
	<span class="o">*</span><span class="n">Denominator</span> <span class="o">/=</span> <span class="n">Divider</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm"> * The Hardware parameters for each card</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">pci_mmap_map</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">voff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">poff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prot_flag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prot_mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">atyfb_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="s">&quot;ATY Mach64&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span>		<span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpanstep</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Frame buffer device API</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atyfb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atyfb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atyfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atyfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atyfb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			   <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atyfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atyfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atyfb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">);</span>
<span class="cp">#ifdef __sparc__</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atyfb_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atyfb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Internal routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">aty_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">aty_get_crtc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">struct</span> <span class="n">crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">aty_set_crtc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty_var_to_crtc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty_crtc_to_var</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_off_pitch</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PPC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">read_aty_sense</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">reboot_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">reboot_info</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Interface used by the world</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">default_var</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 640x480, 60 Hz, Non-Interlaced (25.175 MHz dotclock) */</span>
	<span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">39722</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">defmode</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 640x480 @ 60 Hz, 31.5 kHz hsync */</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">39721</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">atyfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>	<span class="o">=</span> <span class="n">atyfb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>	<span class="o">=</span> <span class="n">atyfb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">atyfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">atyfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">atyfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">atyfb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">atyfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span>	<span class="o">=</span> <span class="n">atyfb_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">atyfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">atyfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">atyfb_imageblit</span><span class="p">,</span>
<span class="cp">#ifdef __sparc__</span>
	<span class="p">.</span><span class="n">fb_mmap</span>	<span class="o">=</span> <span class="n">atyfb_mmap</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">fb_sync</span>	<span class="o">=</span> <span class="n">atyfb_sync</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">noaccel</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nomtrr</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vram</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pll</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mclk</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">xclk</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">comp_sync</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PMAC_BACKLIGHT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">backlight</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">backlight</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PPC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_vmode</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="n">VMODE_CHOOSE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_cmode</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="n">CMODE_CHOOSE</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">vmode</span><span class="p">,</span> <span class="n">default_vmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vmode</span><span class="p">,</span> <span class="s">&quot;int: video mode for mac&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">cmode</span><span class="p">,</span> <span class="n">default_cmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cmode</span><span class="p">,</span> <span class="s">&quot;int: color mode for mac&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_ATARI</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mach64_count</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_vmembase</span><span class="p">[</span><span class="n">FB_MAX</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_size</span><span class="p">[</span><span class="n">FB_MAX</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_guiregbase</span><span class="p">[</span><span class="n">FB_MAX</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* top -&gt; down is an evolution of mach64 chipset, any corrections? */</span>
<span class="cp">#define ATI_CHIP_88800GX   (M64F_GX)</span>
<span class="cp">#define ATI_CHIP_88800CX   (M64F_GX)</span>

<span class="cp">#define ATI_CHIP_264CT     (M64F_CT | M64F_INTEGRATED | M64F_CT_BUS | M64F_MAGIC_FIFO)</span>
<span class="cp">#define ATI_CHIP_264ET     (M64F_CT | M64F_INTEGRATED | M64F_CT_BUS | M64F_MAGIC_FIFO)</span>

<span class="cp">#define ATI_CHIP_264VT     (M64F_VT | M64F_INTEGRATED | M64F_VT_BUS | M64F_MAGIC_FIFO)</span>
<span class="cp">#define ATI_CHIP_264GT     (M64F_GT | M64F_INTEGRATED               | M64F_MAGIC_FIFO | M64F_EXTRA_BRIGHT)</span>

<span class="cp">#define ATI_CHIP_264VTB    (M64F_VT | M64F_INTEGRATED | M64F_VT_BUS | M64F_GTB_DSP)</span>
<span class="cp">#define ATI_CHIP_264VT3    (M64F_VT | M64F_INTEGRATED | M64F_VT_BUS | M64F_GTB_DSP | M64F_SDRAM_MAGIC_PLL)</span>
<span class="cp">#define ATI_CHIP_264VT4    (M64F_VT | M64F_INTEGRATED               | M64F_GTB_DSP)</span>

<span class="cm">/* FIXME what is this chip? */</span>
<span class="cp">#define ATI_CHIP_264LT     (M64F_GT | M64F_INTEGRATED               | M64F_GTB_DSP)</span>

<span class="cm">/* make sets shorter */</span>
<span class="cp">#define ATI_MODERN_SET     (M64F_GT | M64F_INTEGRATED               | M64F_GTB_DSP | M64F_EXTRA_BRIGHT)</span>

<span class="cp">#define ATI_CHIP_264GTB    (ATI_MODERN_SET | M64F_SDRAM_MAGIC_PLL)</span>
<span class="cm">/*#define ATI_CHIP_264GTDVD  ?*/</span>
<span class="cp">#define ATI_CHIP_264LTG    (ATI_MODERN_SET | M64F_SDRAM_MAGIC_PLL)</span>

<span class="cp">#define ATI_CHIP_264GT2C   (ATI_MODERN_SET | M64F_SDRAM_MAGIC_PLL | M64F_HW_TRIPLE)</span>
<span class="cp">#define ATI_CHIP_264GTPRO  (ATI_MODERN_SET | M64F_SDRAM_MAGIC_PLL | M64F_HW_TRIPLE | M64F_FIFO_32 | M64F_RESET_3D)</span>
<span class="cp">#define ATI_CHIP_264LTPRO  (ATI_MODERN_SET | M64F_HW_TRIPLE | M64F_FIFO_32 | M64F_RESET_3D)</span>

<span class="cp">#define ATI_CHIP_264XL     (ATI_MODERN_SET | M64F_HW_TRIPLE | M64F_FIFO_32 | M64F_RESET_3D | M64F_XL_DLL | M64F_MFB_FORCE_4 | M64F_XL_MEM)</span>
<span class="cp">#define ATI_CHIP_MOBILITY  (ATI_MODERN_SET | M64F_HW_TRIPLE | M64F_FIFO_32 | M64F_RESET_3D | M64F_XL_DLL | M64F_MFB_FORCE_4 | M64F_XL_MEM | M64F_MOBIL_BUS)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">pci_id</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pll</span><span class="p">,</span> <span class="n">mclk</span><span class="p">,</span> <span class="n">xclk</span><span class="p">,</span> <span class="n">ecp_max</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span> <span class="n">aty_chips</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GX</span>
	<span class="cm">/* Mach64 GX */</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GX</span><span class="p">,</span> <span class="s">&quot;ATI888GX00 (Mach64 GX)&quot;</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATI_CHIP_88800GX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64CX</span><span class="p">,</span> <span class="s">&quot;ATI888CX00 (Mach64 CX)&quot;</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATI_CHIP_88800CX</span> <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_GX */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_FB_ATY_CT</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64CT</span><span class="p">,</span> <span class="s">&quot;ATI264CT (Mach64 CT)&quot;</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATI_CHIP_264CT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64ET</span><span class="p">,</span> <span class="s">&quot;ATI264ET (Mach64 ET)&quot;</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATI_CHIP_264ET</span> <span class="p">},</span>

	<span class="cm">/* FIXME what is this chip? */</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64LT</span><span class="p">,</span> <span class="s">&quot;ATI264LT (Mach64 LT)&quot;</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATI_CHIP_264LT</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64VT</span><span class="p">,</span> <span class="s">&quot;ATI264VT (Mach64 VT)&quot;</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">ATI_CHIP_264VT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GT</span><span class="p">,</span> <span class="s">&quot;3D RAGE (Mach64 GT)&quot;</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">ATI_CHIP_264GT</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64VU</span><span class="p">,</span> <span class="s">&quot;ATI264VT3 (Mach64 VU)&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">ATI_CHIP_264VT3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GU</span><span class="p">,</span> <span class="s">&quot;3D RAGE II+ (Mach64 GU)&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ATI_CHIP_264GTB</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64LG</span><span class="p">,</span> <span class="s">&quot;3D RAGE LT (Mach64 LG)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ATI_CHIP_264LTG</span> <span class="o">|</span> <span class="n">M64F_LT_LCD_REGS</span> <span class="o">|</span> <span class="n">M64F_G3_PB_1024x768</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64VV</span><span class="p">,</span> <span class="s">&quot;ATI264VT4 (Mach64 VV)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ATI_CHIP_264VT4</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GV</span><span class="p">,</span> <span class="s">&quot;3D RAGE IIC (Mach64 GV, PCI)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ATI_CHIP_264GT2C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GW</span><span class="p">,</span> <span class="s">&quot;3D RAGE IIC (Mach64 GW, AGP)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ATI_CHIP_264GT2C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GY</span><span class="p">,</span> <span class="s">&quot;3D RAGE IIC (Mach64 GY, PCI)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ATI_CHIP_264GT2C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GZ</span><span class="p">,</span> <span class="s">&quot;3D RAGE IIC (Mach64 GZ, AGP)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ATI_CHIP_264GT2C</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GB</span><span class="p">,</span> <span class="s">&quot;3D RAGE PRO (Mach64 GB, BGA, AGP)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="n">ATI_CHIP_264GTPRO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GD</span><span class="p">,</span> <span class="s">&quot;3D RAGE PRO (Mach64 GD, BGA, AGP 1x)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="n">ATI_CHIP_264GTPRO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GI</span><span class="p">,</span> <span class="s">&quot;3D RAGE PRO (Mach64 GI, BGA, PCI)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="n">ATI_CHIP_264GTPRO</span> <span class="o">|</span> <span class="n">M64F_MAGIC_VRAM_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GP</span><span class="p">,</span> <span class="s">&quot;3D RAGE PRO (Mach64 GP, PQFP, PCI)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="n">ATI_CHIP_264GTPRO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GQ</span><span class="p">,</span> <span class="s">&quot;3D RAGE PRO (Mach64 GQ, PQFP, PCI, limited 3D)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="n">ATI_CHIP_264GTPRO</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64LB</span><span class="p">,</span> <span class="s">&quot;3D RAGE LT PRO (Mach64 LB, AGP)&quot;</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_264LTPRO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64LD</span><span class="p">,</span> <span class="s">&quot;3D RAGE LT PRO (Mach64 LD, AGP)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_264LTPRO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64LI</span><span class="p">,</span> <span class="s">&quot;3D RAGE LT PRO (Mach64 LI, PCI)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_264LTPRO</span> <span class="o">|</span> <span class="n">M64F_G3_PB_1_1</span> <span class="o">|</span> <span class="n">M64F_G3_PB_1024x768</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64LP</span><span class="p">,</span> <span class="s">&quot;3D RAGE LT PRO (Mach64 LP, PCI)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_264LTPRO</span> <span class="o">|</span> <span class="n">M64F_G3_PB_1024x768</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64LQ</span><span class="p">,</span> <span class="s">&quot;3D RAGE LT PRO (Mach64 LQ, PCI)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_264LTPRO</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GM</span><span class="p">,</span> <span class="s">&quot;3D RAGE XL (Mach64 GM, AGP 2x)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_264XL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GN</span><span class="p">,</span> <span class="s">&quot;3D RAGE XC (Mach64 GN, AGP 2x)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_264XL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GO</span><span class="p">,</span> <span class="s">&quot;3D RAGE XL (Mach64 GO, PCI-66)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_264XL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GL</span><span class="p">,</span> <span class="s">&quot;3D RAGE XC (Mach64 GL, PCI-66)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_264XL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GR</span><span class="p">,</span> <span class="s">&quot;3D RAGE XL (Mach64 GR, PCI-33)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_264XL</span> <span class="o">|</span> <span class="n">M64F_SDRAM_MAGIC_PLL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64GS</span><span class="p">,</span> <span class="s">&quot;3D RAGE XC (Mach64 GS, PCI-33)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_264XL</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64LM</span><span class="p">,</span> <span class="s">&quot;3D RAGE Mobility P/M (Mach64 LM, AGP 2x)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_MOBILITY</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64LN</span><span class="p">,</span> <span class="s">&quot;3D RAGE Mobility L (Mach64 LN, AGP 2x)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_MOBILITY</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64LR</span><span class="p">,</span> <span class="s">&quot;3D RAGE Mobility P/M (Mach64 LR, PCI)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_MOBILITY</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_CHIP_MACH64LS</span><span class="p">,</span> <span class="s">&quot;3D RAGE Mobility L (Mach64 LS, PCI)&quot;</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">ATI_CHIP_MOBILITY</span> <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_CT */</span><span class="cp"></span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">correct_chipset</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chip_id</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aty_chips</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pci_id</span> <span class="o">==</span> <span class="n">aty_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">name</span> <span class="o">=</span> <span class="n">aty_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span> <span class="o">=</span> <span class="n">aty_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pll</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">aty_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mclk</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="n">aty_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xclk</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">ecp_max</span> <span class="o">=</span> <span class="n">aty_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ecp_max</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">aty_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">features</span><span class="p">;</span>

	<span class="n">chip_id</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CNFG_CHIP_ID</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">chip_id</span> <span class="o">&amp;</span> <span class="n">CFG_CHIP_TYPE</span><span class="p">;</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">&amp;</span> <span class="n">CFG_CHIP_REV</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pci_id</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GX</span>
	<span class="k">case</span> <span class="n">PCI_CHIP_MACH64GX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="mh">0x00d7</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_CHIP_MACH64CX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="mh">0x0057</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_ATY_CT</span>
	<span class="k">case</span> <span class="n">PCI_CHIP_MACH64VT</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x00</span>:
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ATI264VT (A3) (Mach64 VT)&quot;</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span> <span class="o">=</span> <span class="mi">170</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">ecp_max</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">ATI_CHIP_264VT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x40</span>:
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ATI264VT2 (A4) (Mach64 VT)&quot;</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">ecp_max</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">ATI_CHIP_264VT</span> <span class="o">|</span> <span class="n">M64F_MAGIC_POSTDIV</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ATI264VT3 (B1) (Mach64 VT)&quot;</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">ecp_max</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">ATI_CHIP_264VTB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ATI264VT3 (B2) (Mach64 VT)&quot;</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">ecp_max</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">ATI_CHIP_264VT3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_CHIP_MACH64GT</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;3D RAGE II (Mach64 GT)&quot;</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span> <span class="o">=</span> <span class="mi">170</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">ecp_max</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">ATI_CHIP_264GTB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;3D RAGE II+ (Mach64 GT)&quot;</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">ecp_max</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">ATI_CHIP_264GTB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;%s [0x%04x rev 0x%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">ram_dram</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;DRAM&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ram_resv</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;RESV&quot;</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GX</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ram_vram</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;VRAM&quot;</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_GX */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_FB_ATY_CT</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ram_edo</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;EDO&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ram_sdram</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;SDRAM (1:1)&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ram_sgram</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;SGRAM (1:1)&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ram_sdram32</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;SDRAM (2:1) (32-bit)&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ram_wram</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;WRAM&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ram_off</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;OFF&quot;</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_CT */</span><span class="cp"></span>


<span class="cp">#ifdef CONFIG_FB_ATY_GX</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aty_gx_ram</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ram_dram</span><span class="p">,</span> <span class="n">ram_vram</span><span class="p">,</span> <span class="n">ram_vram</span><span class="p">,</span> <span class="n">ram_dram</span><span class="p">,</span>
	<span class="n">ram_dram</span><span class="p">,</span> <span class="n">ram_vram</span><span class="p">,</span> <span class="n">ram_vram</span><span class="p">,</span> <span class="n">ram_resv</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_GX */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_FB_ATY_CT</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aty_ct_ram</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ram_off</span><span class="p">,</span> <span class="n">ram_dram</span><span class="p">,</span> <span class="n">ram_edo</span><span class="p">,</span> <span class="n">ram_edo</span><span class="p">,</span>
	<span class="n">ram_sdram</span><span class="p">,</span> <span class="n">ram_sgram</span><span class="p">,</span> <span class="n">ram_wram</span><span class="p">,</span> <span class="n">ram_resv</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aty_xl_ram</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ram_off</span><span class="p">,</span> <span class="n">ram_dram</span><span class="p">,</span> <span class="n">ram_edo</span><span class="p">,</span> <span class="n">ram_edo</span><span class="p">,</span>
	<span class="n">ram_sdram</span><span class="p">,</span> <span class="n">ram_sgram</span><span class="p">,</span> <span class="n">ram_sdram32</span><span class="p">,</span> <span class="n">ram_resv</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_CT */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">atyfb_get_pixclock</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pixclock</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="n">u32</span> <span class="n">lcd_on_off</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">ct</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lcd_on_off</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lcd_on_off</span> <span class="o">&amp;</span> <span class="n">LCD_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">ct</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
			<span class="n">pixclock</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_pixclock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">pixclock</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_PPC)</span>

<span class="cm">/*</span>
<span class="cm"> * Apple monitor sense</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">read_aty_sense</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sense</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="mh">0x31003100</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* drive outputs high */</span>
	<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* turn off outputs */</span>
	<span class="n">__delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* get primary sense value */</span>
	<span class="n">sense</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">);</span>

	<span class="cm">/* drive each sense line low in turn and collect the other 2 */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="mh">0x20000000</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* drive A low */</span>
	<span class="n">__delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">sense</span> <span class="o">|=</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="mh">0x20002000</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* drive A high again */</span>
	<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* drive B low */</span>
	<span class="n">__delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">sense</span> <span class="o">|=</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="mh">0x10001000</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* drive B high again */</span>
	<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="mh">0x01000000</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* drive C low */</span>
	<span class="n">__delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">sense</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GP_IO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* turn off outputs */</span>
	<span class="k">return</span> <span class="n">sense</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* defined(CONFIG_PPC) */</span><span class="cp"></span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * CRTC programming</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty_get_crtc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">struct</span> <span class="n">crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">LT_LCD_REGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_index</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">LCD_INDEX</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LCD_INDEX</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_index</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_config_panel</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">CNFG_PANEL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>


		<span class="cm">/* switch to non shadow registers */</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;</span>
			   <span class="o">~</span><span class="p">(</span><span class="n">CRTC_RW_SELECT</span> <span class="o">|</span> <span class="n">SHADOW_EN</span> <span class="o">|</span> <span class="n">SHADOW_RW_EN</span><span class="p">),</span> <span class="n">par</span><span class="p">);</span>

		<span class="cm">/* save stretching */</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horz_stretching</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">HORZ_STRETCHING</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_stretching</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">VERT_STRETCHING</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">LT_LCD_REGS</span><span class="p">))</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">ext_vert_stretch</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">EXT_VERT_STRETCH</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_tot_disp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_H_TOTAL_DISP</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_H_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_tot_disp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_V_TOTAL_DISP</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_V_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vline_crnt_vline</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_VLINE_CRNT_VLINE</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">off_pitch</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_OFF_PITCH</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* switch to shadow registers */</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRTC_RW_SELECT</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">SHADOW_EN</span> <span class="o">|</span> <span class="n">SHADOW_RW_EN</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_h_tot_disp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_H_TOTAL_DISP</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_h_sync_strt_wid</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_H_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_v_tot_disp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_V_TOTAL_DISP</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_v_sync_strt_wid</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_V_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_GENERIC_LCD */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty_set_crtc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* stop CRTC */</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">&amp;</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">CRTC_EXT_DISP_EN</span> <span class="o">|</span> <span class="n">CRTC_EN</span><span class="p">),</span> <span class="n">par</span><span class="p">);</span>

		<span class="cm">/* update non-shadow registers first */</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">CNFG_PANEL</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_config_panel</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;</span>
			   <span class="o">~</span><span class="p">(</span><span class="n">CRTC_RW_SELECT</span> <span class="o">|</span> <span class="n">SHADOW_EN</span> <span class="o">|</span> <span class="n">SHADOW_RW_EN</span><span class="p">),</span> <span class="n">par</span><span class="p">);</span>

		<span class="cm">/* temporarily disable stretching */</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">HORZ_STRETCHING</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horz_stretching</span> <span class="o">&amp;</span>
			   <span class="o">~</span><span class="p">(</span><span class="n">HORZ_STRETCH_MODE</span> <span class="o">|</span> <span class="n">HORZ_STRETCH_EN</span><span class="p">),</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">VERT_STRETCHING</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_stretching</span> <span class="o">&amp;</span>
			   <span class="o">~</span><span class="p">(</span><span class="n">VERT_STRETCH_RATIO1</span> <span class="o">|</span> <span class="n">VERT_STRETCH_RATIO2</span> <span class="o">|</span>
			     <span class="n">VERT_STRETCH_USE0</span> <span class="o">|</span> <span class="n">VERT_STRETCH_EN</span><span class="p">),</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* turn off CRT */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRTC_EN</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;setting up CRTC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;set primary CRT to %ix%i %c%c composite %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">((((</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_tot_disp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
		<span class="p">(((</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_tot_disp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
		<span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">&amp;</span> <span class="mh">0x200000</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;N&#39;</span> <span class="o">:</span> <span class="sc">&#39;P&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span> <span class="o">&amp;</span> <span class="mh">0x200000</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;N&#39;</span> <span class="o">:</span> <span class="sc">&#39;P&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_CSYNC_EN</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;P&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CRTC_H_TOTAL_DISP: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_tot_disp</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CRTC_H_SYNC_STRT_WID: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CRTC_V_TOTAL_DISP: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_tot_disp</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CRTC_V_SYNC_STRT_WID: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CRTC_OFF_PITCH: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">off_pitch</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CRTC_VLINE_CRNT_VLINE: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vline_crnt_vline</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CRTC_GEN_CNTL: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span><span class="p">);</span>

	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_H_TOTAL_DISP</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_tot_disp</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_H_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_V_TOTAL_DISP</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_tot_disp</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_V_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_OFF_PITCH</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">off_pitch</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_VLINE_CRNT_VLINE</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vline_crnt_vline</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	FIXME</span>
<span class="c">	if (par-&gt;accel_flags &amp; FB_ACCELF_TEXT)</span>
<span class="c">		aty_init_engine(par, info);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="cm">/* after setting the CRTC registers we should set the LCD registers. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* switch to shadow registers */</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRTC_RW_SELECT</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">SHADOW_EN</span> <span class="o">|</span> <span class="n">SHADOW_RW_EN</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;set shadow CRT to %ix%i %c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">((((</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_h_tot_disp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
			<span class="p">(((</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_v_tot_disp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
			<span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_h_sync_strt_wid</span> <span class="o">&amp;</span> <span class="mh">0x200000</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;N&#39;</span> <span class="o">:</span> <span class="sc">&#39;P&#39;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_v_sync_strt_wid</span> <span class="o">&amp;</span> <span class="mh">0x200000</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;N&#39;</span> <span class="o">:</span> <span class="sc">&#39;P&#39;</span><span class="p">);</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;SHADOW CRTC_H_TOTAL_DISP: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_h_tot_disp</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;SHADOW CRTC_H_SYNC_STRT_WID: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_h_sync_strt_wid</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;SHADOW CRTC_V_TOTAL_DISP: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_v_tot_disp</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;SHADOW CRTC_V_SYNC_STRT_WID: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_v_sync_strt_wid</span><span class="p">);</span>

		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_H_TOTAL_DISP</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_h_tot_disp</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_H_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_h_sync_strt_wid</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_V_TOTAL_DISP</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_v_tot_disp</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_V_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_v_sync_strt_wid</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="cm">/* restore CRTC selection &amp; shadow state and enable stretching */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;LCD_GEN_CNTL: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;HORZ_STRETCHING: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horz_stretching</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;VERT_STRETCHING: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_stretching</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">LT_LCD_REGS</span><span class="p">))</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXT_VERT_STRETCH: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">ext_vert_stretch</span><span class="p">);</span>

		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">HORZ_STRETCHING</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horz_stretching</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">VERT_STRETCHING</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_stretching</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">LT_LCD_REGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">EXT_VERT_STRETCH</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">ext_vert_stretch</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">LCD_INDEX</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LCD_INDEX</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_index</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_GENERIC_LCD */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">calc_line_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">line_length</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span> <span class="o">==</span> <span class="n">SGRAM</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">XL_MEM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span> <span class="o">==</span> <span class="n">WRAM</span><span class="p">))</span>
		<span class="n">line_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">line_length</span> <span class="o">+</span> <span class="mi">63</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">63</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">line_length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_var_to_crtc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">,</span> <span class="n">xoffset</span><span class="p">,</span> <span class="n">yoffset</span><span class="p">,</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sync</span><span class="p">,</span> <span class="n">vmode</span><span class="p">,</span> <span class="n">vdisplay</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">h_total</span><span class="p">,</span> <span class="n">h_disp</span><span class="p">,</span> <span class="n">h_sync_strt</span><span class="p">,</span> <span class="n">h_sync_end</span><span class="p">,</span> <span class="n">h_sync_dly</span><span class="p">,</span> <span class="n">h_sync_wid</span><span class="p">,</span> <span class="n">h_sync_pol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v_total</span><span class="p">,</span> <span class="n">v_disp</span><span class="p">,</span> <span class="n">v_sync_strt</span><span class="p">,</span> <span class="n">v_sync_end</span><span class="p">,</span> <span class="n">v_sync_wid</span><span class="p">,</span> <span class="n">v_sync_pol</span><span class="p">,</span> <span class="n">c_sync</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pix_width</span><span class="p">,</span> <span class="n">dp_pix_width</span><span class="p">,</span> <span class="n">dp_chain_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">line_length</span><span class="p">;</span>

	<span class="cm">/* input */</span>
	<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">vxres</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">xoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="mi">15</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">sync</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">;</span>
	<span class="n">vmode</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span><span class="p">;</span>

	<span class="cm">/* convert (and round up) and validate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vxres</span> <span class="o">&lt;</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">)</span>
		<span class="n">vxres</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">;</span>
	<span class="n">h_disp</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vyres</span> <span class="o">&lt;</span> <span class="n">yres</span> <span class="o">+</span> <span class="n">yoffset</span><span class="p">)</span>
		<span class="n">vyres</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">+</span> <span class="n">yoffset</span><span class="p">;</span>
	<span class="n">v_disp</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">pix_width</span> <span class="o">=</span> <span class="n">CRTC_PIX_WIDTH_8BPP</span><span class="p">;</span>
		<span class="n">dp_pix_width</span> <span class="o">=</span> <span class="n">HOST_8BPP</span> <span class="o">|</span> <span class="n">SRC_8BPP</span> <span class="o">|</span> <span class="n">DST_8BPP</span> <span class="o">|</span>
			<span class="n">BYTE_ORDER_LSB_TO_MSB</span><span class="p">;</span>
		<span class="n">dp_chain_mask</span> <span class="o">=</span> <span class="n">DP_CHAIN_8BPP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">pix_width</span> <span class="o">=</span> <span class="n">CRTC_PIX_WIDTH_15BPP</span><span class="p">;</span>
		<span class="n">dp_pix_width</span> <span class="o">=</span> <span class="n">HOST_15BPP</span> <span class="o">|</span> <span class="n">SRC_15BPP</span> <span class="o">|</span> <span class="n">DST_15BPP</span> <span class="o">|</span>
			<span class="n">BYTE_ORDER_LSB_TO_MSB</span><span class="p">;</span>
		<span class="n">dp_chain_mask</span> <span class="o">=</span> <span class="n">DP_CHAIN_15BPP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">pix_width</span> <span class="o">=</span> <span class="n">CRTC_PIX_WIDTH_16BPP</span><span class="p">;</span>
		<span class="n">dp_pix_width</span> <span class="o">=</span> <span class="n">HOST_16BPP</span> <span class="o">|</span> <span class="n">SRC_16BPP</span> <span class="o">|</span> <span class="n">DST_16BPP</span> <span class="o">|</span>
			<span class="n">BYTE_ORDER_LSB_TO_MSB</span><span class="p">;</span>
		<span class="n">dp_chain_mask</span> <span class="o">=</span> <span class="n">DP_CHAIN_16BPP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">24</span> <span class="o">&amp;&amp;</span> <span class="n">M64_HAS</span><span class="p">(</span><span class="n">INTEGRATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">pix_width</span> <span class="o">=</span> <span class="n">CRTC_PIX_WIDTH_24BPP</span><span class="p">;</span>
		<span class="n">dp_pix_width</span> <span class="o">=</span> <span class="n">HOST_8BPP</span> <span class="o">|</span> <span class="n">SRC_8BPP</span> <span class="o">|</span> <span class="n">DST_8BPP</span> <span class="o">|</span>
			<span class="n">BYTE_ORDER_LSB_TO_MSB</span><span class="p">;</span>
		<span class="n">dp_chain_mask</span> <span class="o">=</span> <span class="n">DP_CHAIN_24BPP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">pix_width</span> <span class="o">=</span> <span class="n">CRTC_PIX_WIDTH_32BPP</span><span class="p">;</span>
		<span class="n">dp_pix_width</span> <span class="o">=</span> <span class="n">HOST_32BPP</span> <span class="o">|</span> <span class="n">SRC_32BPP</span> <span class="o">|</span> <span class="n">DST_32BPP</span> <span class="o">|</span>
			<span class="n">BYTE_ORDER_LSB_TO_MSB</span><span class="p">;</span>
		<span class="n">dp_chain_mask</span> <span class="o">=</span> <span class="n">DP_CHAIN_32BPP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;invalid bpp&quot;</span><span class="p">);</span>

	<span class="n">line_length</span> <span class="o">=</span> <span class="n">calc_line_length</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vyres</span> <span class="o">*</span> <span class="n">line_length</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;not enough video RAM&quot;</span><span class="p">);</span>

	<span class="n">h_sync_pol</span> <span class="o">=</span> <span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v_sync_pol</span> <span class="o">=</span> <span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="mi">1600</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="mi">1200</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;MACH64 chips are designed for max 1600x1200</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;select anoter resolution.&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">h_sync_strt</span> <span class="o">=</span> <span class="n">h_disp</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">h_sync_end</span> <span class="o">=</span> <span class="n">h_sync_strt</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">h_sync_dly</span>  <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">h_total</span> <span class="o">=</span> <span class="n">h_sync_end</span> <span class="o">+</span> <span class="n">h_sync_dly</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>

	<span class="n">v_sync_strt</span> <span class="o">=</span> <span class="n">v_disp</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">v_sync_end</span> <span class="o">=</span> <span class="n">v_sync_strt</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">v_total</span> <span class="o">=</span> <span class="n">v_sync_end</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">LT_LCD_REGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">lcd_index</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">LCD_INDEX</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_index</span> <span class="o">=</span> <span class="n">lcd_index</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="n">LCD_INDEX_MASK</span> <span class="o">|</span> <span class="n">LCD_DISPLAY_DIS</span> <span class="o">|</span>
				  <span class="n">LCD_SRC_SEL</span> <span class="o">|</span> <span class="n">CRTC2_DISPLAY_DIS</span><span class="p">);</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LCD_INDEX</span><span class="p">,</span> <span class="n">lcd_index</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">MOBIL_BUS</span><span class="p">))</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_index</span> <span class="o">|=</span> <span class="n">CRTC2_DISPLAY_DIS</span><span class="p">;</span>

		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_config_panel</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">CNFG_PANEL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x4000</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRTC_RW_SELECT</span><span class="p">;</span>

		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="p">(</span><span class="n">HORZ_DIVBY2_EN</span> <span class="o">|</span> <span class="n">DIS_HOR_CRT_DIVBY2</span> <span class="o">|</span> <span class="n">TVCLK_PM_EN</span> <span class="o">|</span>
			<span class="cm">/*VCLK_DAC_PM_EN | USE_SHADOWED_VEND |*/</span>
			<span class="n">USE_SHADOWED_ROWCUR</span> <span class="o">|</span> <span class="n">SHADOW_EN</span> <span class="o">|</span> <span class="n">SHADOW_RW_EN</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">|=</span> <span class="n">DONT_SHADOW_VPAR</span> <span class="o">|</span> <span class="n">LOCK_8DOT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;</span> <span class="n">LCD_ON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_width</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_height</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We cannot display the mode on the LCD. If the CRT is</span>
<span class="cm">			 * enabled we can turn off the LCD.</span>
<span class="cm">			 * If the CRT is off, it isn&#39;t a good idea to switch it</span>
<span class="cm">			 * on; we don&#39;t know if one is connected. So it&#39;s better</span>
<span class="cm">			 * to fail then.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRT_ON</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_TEST</span><span class="p">))</span>
					<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;Disable LCD panel, because video mode does not fit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LCD_ON</span><span class="p">;</span>
				<span class="cm">/*aty_st_lcd(LCD_GEN_CNTL, crtc-&gt;lcd_gen_cntl, par);*/</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_TEST</span><span class="p">))</span>
					<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;Video mode exceeds size of LCD panel.</span><span class="se">\n</span><span class="s">Connect this computer to a conventional monitor if you really need this mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;</span> <span class="n">LCD_ON</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">VScan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* bpp -&gt; bytespp, 1,4 -&gt; 0; 8 -&gt; 2; 15,16 -&gt; 1; 24 -&gt; 6; 32 -&gt; 5</span>
<span class="cm">		const u8 DFP_h_sync_dly_LT[] = { 0, 2, 1, 6, 5 };</span>
<span class="cm">		const u8 ADD_to_strt_wid_and_dly_LT_DAC[] = { 0, 5, 6, 9, 9, 12, 12 };  */</span>

		<span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FB_VMODE_DOUBLE</span> <span class="o">|</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * This is horror! When we simulate, say 640x480 on an 800x600</span>
<span class="cm">		 * LCD monitor, the CRTC should be programmed 800x600 values for</span>
<span class="cm">		 * the non visible part, but 640x480 for the visible part.</span>
<span class="cm">		 * This code has been tested on a laptop with it&#39;s 1400x1050 LCD</span>
<span class="cm">		 * monitor and a conventional monitor both switched on.</span>
<span class="cm">		 * Tested modes: 1280x1024, 1152x864, 1024x768, 800x600,</span>
<span class="cm">		 * works with little glitches also with DOUBLESCAN modes</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_height</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">VScan</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_height</span> <span class="o">/</span> <span class="n">yres</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">VScan</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">VScan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">h_sync_strt</span> <span class="o">=</span> <span class="n">h_disp</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_right_margin</span><span class="p">;</span>
		<span class="n">h_sync_end</span> <span class="o">=</span> <span class="n">h_sync_strt</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_len</span><span class="p">;</span>
		<span class="n">h_sync_dly</span> <span class="o">=</span> <span class="cm">/*DFP_h_sync_dly[ ( bpp + 1 ) / 3 ]; */</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_dly</span><span class="p">;</span>
		<span class="n">h_total</span> <span class="o">=</span> <span class="n">h_disp</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hblank_len</span><span class="p">;</span>

		<span class="n">v_sync_strt</span> <span class="o">=</span> <span class="n">v_disp</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_lower_margin</span> <span class="o">/</span> <span class="n">VScan</span><span class="p">;</span>
		<span class="n">v_sync_end</span> <span class="o">=</span> <span class="n">v_sync_strt</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vsync_len</span> <span class="o">/</span> <span class="n">VScan</span><span class="p">;</span>
		<span class="n">v_total</span> <span class="o">=</span> <span class="n">v_disp</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vblank_len</span> <span class="o">/</span> <span class="n">VScan</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_GENERIC_LCD */</span><span class="cp"></span>

	<span class="n">h_disp</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_disp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">h_sync_strt</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_sync_strt</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">h_sync_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_sync_end</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">h_total</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_total</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">h_sync_wid</span> <span class="o">=</span> <span class="n">h_sync_end</span> <span class="o">-</span> <span class="n">h_sync_strt</span><span class="p">;</span>

	<span class="n">FAIL_MAX</span><span class="p">(</span><span class="s">&quot;h_disp too large&quot;</span><span class="p">,</span> <span class="n">h_disp</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">FAIL_MAX</span><span class="p">(</span><span class="s">&quot;h_sync_strt too large&quot;</span><span class="p">,</span> <span class="n">h_sync_strt</span><span class="p">,</span> <span class="mh">0x1ff</span><span class="p">);</span>
	<span class="cm">/*FAIL_MAX(&quot;h_sync_wid too large&quot;, h_sync_wid, 0x1f);*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_sync_wid</span> <span class="o">&gt;</span> <span class="mh">0x1f</span><span class="p">)</span>
		<span class="n">h_sync_wid</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">FAIL_MAX</span><span class="p">(</span><span class="s">&quot;h_total too large&quot;</span><span class="p">,</span> <span class="n">h_total</span><span class="p">,</span> <span class="mh">0x1ff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v_disp</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">v_sync_strt</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">v_sync_end</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">v_total</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdisplay</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;</span> <span class="n">LCD_ON</span><span class="p">))</span>
		<span class="n">vdisplay</span>  <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_height</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">v_disp</span><span class="o">--</span><span class="p">;</span>
	<span class="n">v_sync_strt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">v_sync_end</span><span class="o">--</span><span class="p">;</span>
	<span class="n">v_total</span><span class="o">--</span><span class="p">;</span>
	<span class="n">v_sync_wid</span> <span class="o">=</span> <span class="n">v_sync_end</span> <span class="o">-</span> <span class="n">v_sync_strt</span><span class="p">;</span>

	<span class="n">FAIL_MAX</span><span class="p">(</span><span class="s">&quot;v_disp too large&quot;</span><span class="p">,</span> <span class="n">v_disp</span><span class="p">,</span> <span class="mh">0x7ff</span><span class="p">);</span>
	<span class="n">FAIL_MAX</span><span class="p">(</span><span class="s">&quot;v_sync_stsrt too large&quot;</span><span class="p">,</span> <span class="n">v_sync_strt</span><span class="p">,</span> <span class="mh">0x7ff</span><span class="p">);</span>
	<span class="cm">/*FAIL_MAX(&quot;v_sync_wid too large&quot;, v_sync_wid, 0x1f);*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v_sync_wid</span> <span class="o">&gt;</span> <span class="mh">0x1f</span><span class="p">)</span>
		<span class="n">v_sync_wid</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">FAIL_MAX</span><span class="p">(</span><span class="s">&quot;v_total too large&quot;</span><span class="p">,</span> <span class="n">v_total</span><span class="p">,</span> <span class="mh">0x7ff</span><span class="p">);</span>

	<span class="n">c_sync</span> <span class="o">=</span> <span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">?</span> <span class="n">CRTC_CSYNC_EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* output */</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vxres</span> <span class="o">=</span> <span class="n">vxres</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">=</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">xoffset</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">yoffset</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">off_pitch</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">line_length</span> <span class="o">+</span> <span class="n">xoffset</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">line_length</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vline_crnt_vline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_tot_disp</span> <span class="o">=</span> <span class="n">h_total</span> <span class="o">|</span> <span class="p">(</span><span class="n">h_disp</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_sync_strt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">h_sync_dly</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">h_sync_strt</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">h_sync_wid</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">h_sync_pol</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_tot_disp</span> <span class="o">=</span> <span class="n">v_total</span> <span class="o">|</span> <span class="p">(</span><span class="n">v_disp</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span> <span class="o">=</span> <span class="n">v_sync_strt</span> <span class="o">|</span> <span class="p">(</span><span class="n">v_sync_wid</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">v_sync_pol</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>

	<span class="cm">/* crtc-&gt;gen_cntl = aty_ld_le32(CRTC_GEN_CNTL, par) &amp; CRTC_PRESERVED_MASK; */</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">=</span> <span class="n">CRTC_EXT_DISP_EN</span> <span class="o">|</span> <span class="n">CRTC_EN</span> <span class="o">|</span> <span class="n">pix_width</span> <span class="o">|</span> <span class="n">c_sync</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">|=</span> <span class="n">CRTC_VGA_LINEAR</span><span class="p">;</span>

	<span class="cm">/* Enable doublescan mode if requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">|=</span> <span class="n">CRTC_DBL_SCAN_EN</span><span class="p">;</span>
	<span class="cm">/* Enable interlaced mode if requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">|=</span> <span class="n">CRTC_INTERLACE_EN</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vdisplay</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
			<span class="n">vdisplay</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CRTC2_EN</span> <span class="o">|</span> <span class="n">CRTC2_PIX_WIDTH</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HORZ_DIVBY2_EN</span> <span class="o">|</span> <span class="n">DIS_HOR_CRT_DIVBY2</span> <span class="o">|</span>
					<span class="cm">/*TVCLK_PM_EN | VCLK_DAC_PM_EN |*/</span>
					<span class="n">USE_SHADOWED_VEND</span> <span class="o">|</span>
					<span class="n">USE_SHADOWED_ROWCUR</span> <span class="o">|</span>
					<span class="n">SHADOW_EN</span> <span class="o">|</span> <span class="n">SHADOW_RW_EN</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">|=</span> <span class="n">DONT_SHADOW_VPAR</span><span class="cm">/* | LOCK_8DOT*/</span><span class="p">;</span>

		<span class="cm">/* MOBILITY M1 tested, FIXME: LT */</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horz_stretching</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">HORZ_STRETCHING</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">LT_LCD_REGS</span><span class="p">))</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">ext_vert_stretch</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">EXT_VERT_STRETCH</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="n">AUTO_VERT_RATIO</span> <span class="o">|</span> <span class="n">VERT_STRETCH_MODE</span> <span class="o">|</span> <span class="n">VERT_STRETCH_RATIO3</span><span class="p">);</span>

		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horz_stretching</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HORZ_STRETCH_RATIO</span> <span class="o">|</span>
					   <span class="n">HORZ_STRETCH_LOOP</span> <span class="o">|</span> <span class="n">AUTO_HORZ_RATIO</span> <span class="o">|</span>
					   <span class="n">HORZ_STRETCH_MODE</span> <span class="o">|</span> <span class="n">HORZ_STRETCH_EN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_width</span> <span class="o">&amp;&amp;</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;</span> <span class="n">LCD_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * The horizontal blender misbehaves when</span>
<span class="cm">				 * HDisplay is less than a certain threshold</span>
<span class="cm">				 * (440 for a 1024-wide panel).  It doesn&#39;t</span>
<span class="cm">				 * stretch such modes enough.  Use pixel</span>
<span class="cm">				 * replication instead of blending to stretch</span>
<span class="cm">				 * modes that can be made to exactly fit the</span>
<span class="cm">				 * panel width.  The undocumented &quot;NoLCDBlend&quot;</span>
<span class="cm">				 * option allows the pixel-replicated mode to</span>
<span class="cm">				 * be slightly wider or narrower than the</span>
<span class="cm">				 * panel width.  It also causes a mode that is</span>
<span class="cm">				 * exactly half as wide as the panel to be</span>
<span class="cm">				 * pixel-replicated, rather than blended.</span>
<span class="cm">				 */</span>
				<span class="kt">int</span> <span class="n">HDisplay</span>  <span class="o">=</span> <span class="n">xres</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">nStretch</span>  <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_width</span> <span class="o">/</span> <span class="n">HDisplay</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">Remainder</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_width</span> <span class="o">%</span> <span class="n">HDisplay</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">Remainder</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">nStretch</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">||</span>
				    <span class="p">(((</span><span class="n">HDisplay</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_width</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">StretchLoops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>
					<span class="kt">int</span> <span class="n">horz_stretch_loop</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">BestRemainder</span><span class="p">;</span>
					<span class="kt">int</span> <span class="n">Numerator</span> <span class="o">=</span> <span class="n">HDisplay</span><span class="p">,</span> <span class="n">Denominator</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_width</span><span class="p">;</span>
					<span class="kt">int</span> <span class="n">Index</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
					<span class="n">ATIReduceRatio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Numerator</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Denominator</span><span class="p">);</span>

					<span class="n">BestRemainder</span> <span class="o">=</span> <span class="p">(</span><span class="n">Numerator</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="n">Denominator</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">Index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">Remainder</span> <span class="o">=</span> <span class="p">((</span><span class="n">Denominator</span> <span class="o">-</span> <span class="n">Numerator</span><span class="p">)</span> <span class="o">*</span> <span class="n">StretchLoops</span><span class="p">[</span><span class="n">Index</span><span class="p">])</span> <span class="o">%</span>
							<span class="n">Denominator</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">Remainder</span> <span class="o">&lt;</span> <span class="n">BestRemainder</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">horz_stretch_loop</span> <span class="o">=</span> <span class="n">Index</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">BestRemainder</span> <span class="o">=</span> <span class="n">Remainder</span><span class="p">))</span>
								<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">((</span><span class="n">horz_stretch_loop</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BestRemainder</span><span class="p">)</span> <span class="p">{</span>
						<span class="kt">int</span> <span class="n">horz_stretch_ratio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Accumulator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="kt">int</span> <span class="n">reuse_previous</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">Index</span> <span class="o">=</span> <span class="n">StretchLoops</span><span class="p">[</span><span class="n">horz_stretch_loop</span><span class="p">];</span>

						<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">Index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">Accumulator</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
								<span class="n">horz_stretch_ratio</span> <span class="o">|=</span> <span class="n">reuse_previous</span><span class="p">;</span>
							<span class="k">else</span>
								<span class="n">Accumulator</span> <span class="o">+=</span> <span class="n">Denominator</span><span class="p">;</span>
							<span class="n">Accumulator</span> <span class="o">-=</span> <span class="n">Numerator</span><span class="p">;</span>
							<span class="n">reuse_previous</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span>

						<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horz_stretching</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HORZ_STRETCH_EN</span> <span class="o">|</span>
							<span class="p">((</span><span class="n">horz_stretch_loop</span> <span class="o">&amp;</span> <span class="n">HORZ_STRETCH_LOOP</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
							<span class="p">(</span><span class="n">horz_stretch_ratio</span> <span class="o">&amp;</span> <span class="n">HORZ_STRETCH_RATIO</span><span class="p">));</span>
						<span class="k">break</span><span class="p">;</span>      <span class="cm">/* Out of the do { ... } while (0) */</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horz_stretching</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HORZ_STRETCH_MODE</span> <span class="o">|</span> <span class="n">HORZ_STRETCH_EN</span> <span class="o">|</span>
					<span class="p">(((</span><span class="n">HDisplay</span> <span class="o">*</span> <span class="p">(</span><span class="n">HORZ_STRETCH_BLEND</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HORZ_STRETCH_BLEND</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vdisplay</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_height</span> <span class="o">&amp;&amp;</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">lcd_gen_cntl</span> <span class="o">&amp;</span> <span class="n">LCD_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_stretching</span> <span class="o">=</span> <span class="p">(</span><span class="n">VERT_STRETCH_USE0</span> <span class="o">|</span> <span class="n">VERT_STRETCH_EN</span> <span class="o">|</span>
				<span class="p">(((</span><span class="n">vdisplay</span> <span class="o">*</span> <span class="p">(</span><span class="n">VERT_STRETCH_RATIO0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_height</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VERT_STRETCH_RATIO0</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">LT_LCD_REGS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">xres</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">MOBIL_BUS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1024</span> <span class="o">:</span> <span class="mi">800</span><span class="p">))</span>
				<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">ext_vert_stretch</span> <span class="o">|=</span> <span class="n">VERT_STRETCH_MODE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Don&#39;t use vertical blending if the mode is too wide</span>
<span class="cm">			 * or not vertically stretched.</span>
<span class="cm">			 */</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_stretching</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* copy to shadow crtc */</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_h_tot_disp</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_tot_disp</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_h_sync_strt_wid</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_v_tot_disp</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_tot_disp</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">shadow_v_sync_strt_wid</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_GENERIC_LCD */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">MAGIC_FIFO</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* FIXME: display FIFO low watermark values */</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CRTC_FIFO_LWM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dp_pix_width</span> <span class="o">=</span> <span class="n">dp_pix_width</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dp_chain_mask</span> <span class="o">=</span> <span class="n">dp_chain_mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_crtc_to_var</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">hslen</span><span class="p">,</span> <span class="n">vslen</span><span class="p">,</span> <span class="n">sync</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">h_total</span><span class="p">,</span> <span class="n">h_disp</span><span class="p">,</span> <span class="n">h_sync_strt</span><span class="p">,</span> <span class="n">h_sync_dly</span><span class="p">,</span> <span class="n">h_sync_wid</span><span class="p">,</span> <span class="n">h_sync_pol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v_total</span><span class="p">,</span> <span class="n">v_disp</span><span class="p">,</span> <span class="n">v_sync_strt</span><span class="p">,</span> <span class="n">v_sync_wid</span><span class="p">,</span> <span class="n">v_sync_pol</span><span class="p">,</span> <span class="n">c_sync</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pix_width</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">double_scan</span><span class="p">,</span> <span class="n">interlace</span><span class="p">;</span>

	<span class="cm">/* input */</span>
	<span class="n">h_total</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_tot_disp</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">;</span>
	<span class="n">h_disp</span> <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_tot_disp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">h_sync_strt</span> <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">h_sync_dly</span> <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">h_sync_wid</span> <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">h_sync_pol</span> <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">v_total</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_tot_disp</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
	<span class="n">v_disp</span> <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_tot_disp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
	<span class="n">v_sync_strt</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
	<span class="n">v_sync_wid</span> <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">v_sync_pol</span> <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">c_sync</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_CSYNC_EN</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pix_width</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_PIX_WIDTH_MASK</span><span class="p">;</span>
	<span class="n">double_scan</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_DBL_SCAN_EN</span><span class="p">;</span>
	<span class="n">interlace</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_INTERLACE_EN</span><span class="p">;</span>

	<span class="cm">/* convert */</span>
	<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_disp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">yres</span> <span class="o">=</span> <span class="n">v_disp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_total</span> <span class="o">-</span> <span class="n">h_sync_strt</span> <span class="o">-</span> <span class="n">h_sync_wid</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">h_sync_dly</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_sync_strt</span> <span class="o">-</span> <span class="n">h_disp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">h_sync_dly</span><span class="p">;</span>
	<span class="n">hslen</span> <span class="o">=</span> <span class="n">h_sync_wid</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">upper</span> <span class="o">=</span> <span class="n">v_total</span> <span class="o">-</span> <span class="n">v_sync_strt</span> <span class="o">-</span> <span class="n">v_sync_wid</span><span class="p">;</span>
	<span class="n">lower</span> <span class="o">=</span> <span class="n">v_sync_strt</span> <span class="o">-</span> <span class="n">v_disp</span><span class="p">;</span>
	<span class="n">vslen</span> <span class="o">=</span> <span class="n">v_sync_wid</span><span class="p">;</span>
	<span class="n">sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_sync_pol</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">v_sync_pol</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">c_sync</span> <span class="o">?</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pix_width</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	case CRTC_PIX_WIDTH_4BPP:</span>
<span class="c">		bpp = 4;</span>
<span class="c">		var-&gt;red.offset = 0;</span>
<span class="c">		var-&gt;red.length = 8;</span>
<span class="c">		var-&gt;green.offset = 0;</span>
<span class="c">		var-&gt;green.length = 8;</span>
<span class="c">		var-&gt;blue.offset = 0;</span>
<span class="c">		var-&gt;blue.length = 8;</span>
<span class="c">		var-&gt;transp.offset = 0;</span>
<span class="c">		var-&gt;transp.length = 0;</span>
<span class="c">		break;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">CRTC_PIX_WIDTH_8BPP</span>:
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CRTC_PIX_WIDTH_15BPP</span>:	<span class="cm">/* RGB 555 */</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CRTC_PIX_WIDTH_16BPP</span>:	<span class="cm">/* RGB 565 */</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CRTC_PIX_WIDTH_24BPP</span>:	<span class="cm">/* RGB 888 */</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CRTC_PIX_WIDTH_32BPP</span>:	<span class="cm">/* ARGB 8888 */</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;Invalid pixel width</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* output */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vxres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vyres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">upper</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">lower</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">hslen</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">vslen</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="n">sync</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * In double scan mode, the vertical parameters are doubled,</span>
<span class="cm">	 * so we need to halve them to get the right values.</span>
<span class="cm">	 * In interlaced mode the values are already correct,</span>
<span class="cm">	 * so no correction is necessary.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interlace</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">double_scan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">pixclock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">debug</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pixclock_in_ps</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">asleep</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">aty_var_to_crtc</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pixclock</span> <span class="o">=</span> <span class="n">atyfb_get_pixclock</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixclock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;Invalid pixclock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">var_to_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">pixclock</span><span class="p">,</span>
					       <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span><span class="p">;</span> <span class="cm">/* hack */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span> <span class="o">=</span> <span class="n">atyfb_sync</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">blitter_may_be_busy</span><span class="p">)</span>
		<span class="n">wait_for_idle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">aty_set_crtc</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_ops</span><span class="o">-&gt;</span><span class="n">set_dac</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">,</span>
			      <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">accel_flags</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">set_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">pll_to_var</span><span class="p">)</span>
		<span class="n">pixclock_in_ps</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">pll_to_var</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pixclock_in_ps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pixclock_in_ps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;ALERT ops-&gt;pll_to_var get 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pixclock_in_ps</span> <span class="o">=</span> <span class="n">pixclock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">debug</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aty_crtc_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">hSync</span><span class="p">,</span> <span class="n">vRefresh</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">h_disp</span><span class="p">,</span> <span class="n">h_sync_strt</span><span class="p">,</span> <span class="n">h_sync_end</span><span class="p">,</span> <span class="n">h_total</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">v_disp</span><span class="p">,</span> <span class="n">v_sync_strt</span><span class="p">,</span> <span class="n">v_sync_end</span><span class="p">,</span> <span class="n">v_total</span><span class="p">;</span>

		<span class="n">h_disp</span> <span class="o">=</span> <span class="n">debug</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
		<span class="n">h_sync_strt</span> <span class="o">=</span> <span class="n">h_disp</span> <span class="o">+</span> <span class="n">debug</span><span class="p">.</span><span class="n">right_margin</span><span class="p">;</span>
		<span class="n">h_sync_end</span> <span class="o">=</span> <span class="n">h_sync_strt</span> <span class="o">+</span> <span class="n">debug</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">;</span>
		<span class="n">h_total</span> <span class="o">=</span> <span class="n">h_sync_end</span> <span class="o">+</span> <span class="n">debug</span><span class="p">.</span><span class="n">left_margin</span><span class="p">;</span>
		<span class="n">v_disp</span> <span class="o">=</span> <span class="n">debug</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">v_sync_strt</span> <span class="o">=</span> <span class="n">v_disp</span> <span class="o">+</span> <span class="n">debug</span><span class="p">.</span><span class="n">lower_margin</span><span class="p">;</span>
		<span class="n">v_sync_end</span> <span class="o">=</span> <span class="n">v_sync_strt</span> <span class="o">+</span> <span class="n">debug</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">;</span>
		<span class="n">v_total</span> <span class="o">=</span> <span class="n">v_sync_end</span> <span class="o">+</span> <span class="n">debug</span><span class="p">.</span><span class="n">upper_margin</span><span class="p">;</span>

		<span class="n">hSync</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="p">(</span><span class="n">pixclock_in_ps</span> <span class="o">*</span> <span class="n">h_total</span><span class="p">);</span>
		<span class="n">vRefresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">hSync</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">v_total</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_INTERLACE_EN</span><span class="p">)</span>
			<span class="n">vRefresh</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_DBL_SCAN_EN</span><span class="p">)</span>
			<span class="n">vRefresh</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;atyfb_set_par</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot; Set Visible Mode to %ix%i-%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot; Virtual resolution %ix%i, &quot;</span>
			<span class="s">&quot;pixclock_in_ps %i (calculated %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span>
			<span class="n">pixclock</span><span class="p">,</span> <span class="n">pixclock_in_ps</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot; Dot clock:           %i MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="mi">1000000</span> <span class="o">/</span> <span class="n">pixclock_in_ps</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot; Horizontal sync:     %i kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hSync</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot; Vertical refresh:    %i Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vRefresh</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot; x  style: %i.%03i %i %i %i %i   %i %i %i %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="mi">1000000</span> <span class="o">/</span> <span class="n">pixclock_in_ps</span><span class="p">,</span> <span class="mi">1000000</span> <span class="o">%</span> <span class="n">pixclock_in_ps</span><span class="p">,</span>
			<span class="n">h_disp</span><span class="p">,</span> <span class="n">h_sync_strt</span><span class="p">,</span> <span class="n">h_sync_end</span><span class="p">,</span> <span class="n">h_total</span><span class="p">,</span>
			<span class="n">v_disp</span><span class="p">,</span> <span class="n">v_sync_strt</span><span class="p">,</span> <span class="n">v_sync_end</span><span class="p">,</span> <span class="n">v_total</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot; fb style: %i  %i %i %i %i %i %i %i %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pixclock_in_ps</span><span class="p">,</span>
			<span class="n">debug</span><span class="p">.</span><span class="n">left_margin</span><span class="p">,</span> <span class="n">h_disp</span><span class="p">,</span> <span class="n">debug</span><span class="p">.</span><span class="n">right_margin</span><span class="p">,</span> <span class="n">debug</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">,</span>
			<span class="n">debug</span><span class="p">.</span><span class="n">upper_margin</span><span class="p">,</span> <span class="n">v_disp</span><span class="p">,</span> <span class="n">debug</span><span class="p">.</span><span class="n">lower_margin</span><span class="p">,</span> <span class="n">debug</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">INTEGRATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t forget MEM_CNTL */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0ffffff</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x02000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x03000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x06000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf00fffff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">MAGIC_POSTDIV</span><span class="p">))</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_refresh_rate</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">case</span> <span class="mi">24</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x04000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x08000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">CT_BUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="mh">0x87010184</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span> <span class="mh">0x680000f9</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">VT_BUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="mh">0x87010184</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span> <span class="mh">0x680000f9</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">MOBIL_BUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="mh">0x80010102</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span> <span class="mh">0x7b33a040</span> <span class="o">|</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span> <span class="o">?</span> <span class="n">BUS_APER_REG_DIS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* GT */</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="mh">0x86010102</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span> <span class="mh">0x7b23a040</span> <span class="o">|</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span> <span class="o">?</span> <span class="n">BUS_APER_REG_DIS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">EXT_MEM_CNTL</span><span class="p">,</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">EXT_MEM_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x5000001</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">DAC_MASK</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">calc_line_length</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span>
						 <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">8</span> <span class="o">?</span>
		<span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">;</span>

	<span class="cm">/* Initialize the graphics engine */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">&amp;</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">)</span>
		<span class="n">aty_init_engine</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_BOOTX_TEXT</span>
	<span class="n">btext_update_display</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
		<span class="p">(((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">h_tot_disp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">v_tot_disp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">vxres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_BOOTX_TEXT */</span><span class="cp"></span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* switch to accelerator mode */</span>
<span class="c">	if (!(par-&gt;crtc.gen_cntl &amp; CRTC_EXT_DISP_EN))</span>
<span class="c">		aty_st_le32(CRTC_GEN_CNTL, par-&gt;crtc.gen_cntl | CRTC_EXT_DISP_EN, par);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DEBUG</span>
<span class="p">{</span>
	<span class="cm">/* dump non shadow CRTC, pll, LCD registers */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="n">u32</span> <span class="n">base</span><span class="p">;</span>

	<span class="cm">/* CRTC registers */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;debug atyfb: Mach64 non-shadow register values:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">debug atyfb: 0x%04X: &quot;</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08X&quot;</span><span class="p">,</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_ATY_CT</span>
	<span class="cm">/* PLL registers */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;debug atyfb: Mach64 PLL register values:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">debug atyfb: 0x%02X: &quot;</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02X&quot;</span><span class="p">,</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_FB_ATY_CT */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* LCD registers */</span>
		<span class="n">base</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;debug atyfb: LCD register values:&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">LT_LCD_REGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">POWER_MANAGEMENT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">EXT_VERT_STRETCH</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">debug atyfb: 0x%04X: &quot;</span><span class="p">,</span>
				       <span class="n">lt_lcd_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08X&quot;</span><span class="p">,</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">debug atyfb: 0x%02X: &quot;</span><span class="p">,</span>
					       <span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08X&quot;</span><span class="p">,</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_GENERIC_LCD */</span><span class="cp"></span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crtc</span> <span class="n">crtc</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">aty_pll</span> <span class="n">pll</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pixclock</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pll</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pll</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">aty_var_to_crtc</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pixclock</span> <span class="o">=</span> <span class="n">atyfb_get_pixclock</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixclock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_TEST</span><span class="p">))</span>
			<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;Invalid pixclock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">var_to_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">pixclock</span><span class="p">,</span>
					       <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">&amp;</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">aty_crtc_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crtc</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">pll_to_var</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_off_pitch</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">xoffset</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">yoffset</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">off_pitch</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">line_length</span> <span class="o">+</span> <span class="n">xoffset</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">line_length</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Open/Release the frame buffer device</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">open</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef __sparc__</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmaped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">aty_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_cntl</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>

	<span class="n">int_cntl</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_INT_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_VBLANK_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear interrupt */</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_INT_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">int_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_INT_EN_MASK</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">CRTC_VBLANK_INT_AK</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">.</span><span class="n">pan_display</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">.</span><span class="n">pan_display</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_OFF_PITCH</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">off_pitch</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reenable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">int_cntl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">aty_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;atyfb&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
		<span class="n">int_cntl</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_INT_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CRTC_INT_EN_MASK</span><span class="p">;</span>
		<span class="cm">/* clear interrupt */</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_INT_CNTL</span><span class="p">,</span> <span class="n">int_cntl</span> <span class="o">|</span> <span class="n">CRTC_VBLANK_INT_AK</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* enable interrupt */</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_INT_CNTL</span><span class="p">,</span> <span class="n">int_cntl</span> <span class="o">|</span> <span class="n">CRTC_VBLANK_INT_EN</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reenable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
		<span class="n">int_cntl</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_INT_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CRTC_INT_EN_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">int_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_VBLANK_INT_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atyfb: someone disabled IRQ [%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">int_cntl</span><span class="p">);</span>
			<span class="cm">/* re-enable interrupt */</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_INT_CNTL</span><span class="p">,</span> <span class="n">int_cntl</span> <span class="o">|</span>
				    <span class="n">CRTC_VBLANK_INT_EN</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_disable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">int_cntl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">.</span><span class="n">pan_display</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">.</span><span class="n">pan_display</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_OFF_PITCH</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">off_pitch</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
		<span class="n">int_cntl</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_INT_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CRTC_INT_EN_MASK</span><span class="p">;</span>
		<span class="cm">/* disable interrupt */</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_INT_CNTL</span><span class="p">,</span> <span class="n">int_cntl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRTC_VBLANK_INT_EN</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef __sparc__</span>
	<span class="kt">int</span> <span class="n">was_mmaped</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">open</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">wait_for_idle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef __sparc__</span>
	<span class="n">was_mmaped</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmaped</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmaped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_mmaped</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">var</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Now reset the default display config, we have</span>
<span class="cm">		 * no idea what the program(s) which mmap&#39;d the</span>
<span class="cm">		 * chip did to the configuration, nor whether it</span>
<span class="cm">		 * restored it correctly.</span>
<span class="cm">		 */</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">default_var</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">noaccel</span><span class="p">)</span>
			<span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">|=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">==</span> <span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">videoram</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">-</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">videoram</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">)</span>
				<span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">aty_disable_irq</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Pan or Wrap the Display</span>
<span class="cm"> *</span>
<span class="cm"> * This call looks only at xoffset, yoffset and the FB_VMODE_YWRAP flag</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">xoffset</span><span class="p">,</span> <span class="n">yoffset</span><span class="p">;</span>

	<span class="n">xres</span> <span class="o">=</span> <span class="p">(((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">h_tot_disp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">yres</span> <span class="o">=</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">v_tot_disp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_DBL_SCAN_EN</span><span class="p">)</span>
		<span class="n">yres</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">xoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">xres</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">vxres</span> <span class="o">||</span>
	    <span class="n">yoffset</span> <span class="o">+</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">xoffset</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">yoffset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">asleep</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_off_pitch</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_VBL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">aty_enable_irq</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">.</span><span class="n">pan_display</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">.</span><span class="n">pan_display</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_OFF_PITCH</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">off_pitch</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_waitforvblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aty_interrupt</span> <span class="o">*</span><span class="n">vbl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">vbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">aty_enable_irq</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">vbl</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">vbl</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
					       <span class="n">count</span> <span class="o">!=</span> <span class="n">vbl</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aty_enable_irq</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define ATYIO_CLKR		0x41545900	</span><span class="cm">/* ATY\00 */</span><span class="cp"></span>
<span class="cp">#define ATYIO_CLKW		0x41545901	</span><span class="cm">/* ATY\01 */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">atyclk</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">ref_clk_per</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pll_ref_div</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mclk_fb_div</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mclk_post_div</span><span class="p">;</span>	<span class="cm">/* 1,2,3,4,8 */</span>
	<span class="n">u8</span> <span class="n">mclk_fb_mult</span><span class="p">;</span>	<span class="cm">/* 2 or 4 */</span>
	<span class="n">u8</span> <span class="n">xclk_post_div</span><span class="p">;</span>	<span class="cm">/* 1,2,3,4,8 */</span>
	<span class="n">u8</span> <span class="n">vclk_fb_div</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vclk_post_div</span><span class="p">;</span>	<span class="cm">/* 1,2,3,4,6,8,12 */</span>
	<span class="n">u32</span> <span class="n">dsp_xclks_per_row</span><span class="p">;</span>	<span class="cm">/* 0-16383 */</span>
	<span class="n">u32</span> <span class="n">dsp_loop_latency</span><span class="p">;</span>	<span class="cm">/* 0-15 */</span>
	<span class="n">u32</span> <span class="n">dsp_precision</span><span class="p">;</span>	<span class="cm">/* 0-7 */</span>
	<span class="n">u32</span> <span class="n">dsp_on</span><span class="p">;</span>		<span class="cm">/* 0-2047 */</span>
	<span class="n">u32</span> <span class="n">dsp_off</span><span class="p">;</span>		<span class="cm">/* 0-2047 */</span>
<span class="p">};</span>

<span class="cp">#define ATYIO_FEATR		0x41545902	</span><span class="cm">/* ATY\02 */</span><span class="cp"></span>
<span class="cp">#define ATYIO_FEATW		0x41545903	</span><span class="cm">/* ATY\03 */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef __sparc__</span>
	<span class="k">struct</span> <span class="n">fbtype</span> <span class="n">fbtyp</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef __sparc__</span>
	<span class="k">case</span> <span class="n">FBIOGTYPE</span>:
		<span class="n">fbtyp</span><span class="p">.</span><span class="n">fb_type</span> <span class="o">=</span> <span class="n">FBTYPE_PCI_GENERIC</span><span class="p">;</span>
		<span class="n">fbtyp</span><span class="p">.</span><span class="n">fb_width</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">vxres</span><span class="p">;</span>
		<span class="n">fbtyp</span><span class="p">.</span><span class="n">fb_height</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">vyres</span><span class="p">;</span>
		<span class="n">fbtyp</span><span class="p">.</span><span class="n">fb_depth</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">fbtyp</span><span class="p">.</span><span class="n">fb_cmsize</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="n">fbtyp</span><span class="p">.</span><span class="n">fb_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="k">struct</span> <span class="n">fbtype</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbtyp</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">fbtyp</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* __sparc__ */</span><span class="cp"></span>

	<span class="k">case</span> <span class="n">FBIO_WAITFORVSYNC</span>:
		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">crtc</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="p">(</span><span class="n">__u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">aty_waitforvblank</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#if defined(DEBUG) &amp;&amp; defined(CONFIG_FB_ATY_CT)</span>
	<span class="k">case</span> <span class="n">ATYIO_CLKR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">INTEGRATED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">atyclk</span> <span class="n">clk</span><span class="p">;</span>
			<span class="k">union</span> <span class="n">aty_pll</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">dsp_config</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_config</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">dsp_on_off</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_on_off</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">ref_clk_per</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">pll_ref_div</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">mclk_fb_div</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_div</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">mclk_post_div</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_post_div_real</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">mclk_fb_mult</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_mult</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">xclk_post_div</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div_real</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">vclk_fb_div</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_fb_div</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">vclk_post_div</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_post_div_real</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">dsp_xclks_per_row</span> <span class="o">=</span> <span class="n">dsp_config</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">dsp_loop_latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp_config</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">dsp_precision</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp_config</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">dsp_off</span> <span class="o">=</span> <span class="n">dsp_on_off</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
			<span class="n">clk</span><span class="p">.</span><span class="n">dsp_on</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp_on_off</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="k">struct</span> <span class="n">atyclk</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">clk</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATYIO_CLKW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">INTEGRATED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">atyclk</span> <span class="n">clk</span><span class="p">;</span>
			<span class="k">union</span> <span class="n">aty_pll</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyclk</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">clk</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span> <span class="o">=</span> <span class="n">clk</span><span class="p">.</span><span class="n">ref_clk_per</span><span class="p">;</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">pll_ref_div</span> <span class="o">=</span> <span class="n">clk</span><span class="p">.</span><span class="n">pll_ref_div</span><span class="p">;</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_div</span> <span class="o">=</span> <span class="n">clk</span><span class="p">.</span><span class="n">mclk_fb_div</span><span class="p">;</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_post_div_real</span> <span class="o">=</span> <span class="n">clk</span><span class="p">.</span><span class="n">mclk_post_div</span><span class="p">;</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">mclk_fb_mult</span> <span class="o">=</span> <span class="n">clk</span><span class="p">.</span><span class="n">mclk_fb_mult</span><span class="p">;</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">xclk_post_div_real</span> <span class="o">=</span> <span class="n">clk</span><span class="p">.</span><span class="n">xclk_post_div</span><span class="p">;</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_fb_div</span> <span class="o">=</span> <span class="n">clk</span><span class="p">.</span><span class="n">vclk_fb_div</span><span class="p">;</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">vclk_post_div_real</span> <span class="o">=</span> <span class="n">clk</span><span class="p">.</span><span class="n">vclk_post_div</span><span class="p">;</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">clk</span><span class="p">.</span><span class="n">dsp_xclks_per_row</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">clk</span><span class="p">.</span><span class="n">dsp_loop_latency</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">clk</span><span class="p">.</span><span class="n">dsp_precision</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">dsp_on_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">clk</span><span class="p">.</span><span class="n">dsp_off</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">clk</span><span class="p">.</span><span class="n">dsp_on</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="cm">/*aty_calc_pll_ct(info, &amp;pll-&gt;ct);*/</span>
			<span class="n">aty_set_pll_ct</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">pll</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATYIO_FEATR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATYIO_FEATW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG &amp;&amp; CONFIG_FB_ATY_CT */</span><span class="cp"></span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">blitter_may_be_busy</span><span class="p">)</span>
		<span class="n">wait_for_idle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef __sparc__</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">map_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">map_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>

	<span class="cm">/* To stop the swapper from even considering these pages. */</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VM_IO</span> <span class="o">|</span> <span class="n">VM_RESERVED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">off</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">PAGE_SIZE</span><span class="p">)))</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="mh">0x8000000000000000UL</span><span class="p">;</span>

	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>	<span class="cm">/* propagate off changes */</span>

	<span class="cm">/* Each page, see which map applies */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">map_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">voff</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">off</span> <span class="o">+</span> <span class="n">page</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">offset</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">map_size</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">-</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
			<span class="n">map_offset</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">poff</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">map_size</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">map_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>

		<span class="n">pgprot_val</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prot_mask</span><span class="p">);</span>
		<span class="n">pgprot_val</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">)</span> <span class="o">|=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prot_flag</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">+</span> <span class="n">page</span><span class="p">,</span>
			<span class="n">map_offset</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">map_size</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

		<span class="n">page</span> <span class="o">+=</span> <span class="n">map_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmaped</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmaped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* __sparc__ */</span><span class="cp"></span>



<span class="cp">#if defined(CONFIG_PM) &amp;&amp; defined(CONFIG_PCI)</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
<span class="cm">/* Power management routines. Those are used for PowerBook sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_power_mgmt</span><span class="p">(</span><span class="kt">int</span> <span class="n">sleep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">pm</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">pm</span> <span class="o">=</span> <span class="p">(</span><span class="n">pm</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PWR_MGT_MODE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">PWR_MGT_MODE_REG</span><span class="p">;</span>
	<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">pm</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleep</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Sleep */</span>
		<span class="n">pm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PWR_MGT_ON</span><span class="p">;</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">pm</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">pm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PWR_BLON</span> <span class="o">|</span> <span class="n">AUTO_PWR_UP</span><span class="p">);</span>
		<span class="n">pm</span> <span class="o">|=</span> <span class="n">SUSPEND_NOW</span><span class="p">;</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">pm</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">pm</span> <span class="o">|=</span> <span class="n">PWR_MGT_ON</span><span class="p">;</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">pm</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">pm</span> <span class="o">&amp;</span> <span class="n">PWR_MGT_STATUS_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PWR_MGT_STATUS_SUSPEND</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Wakeup */</span>
		<span class="n">pm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PWR_MGT_ON</span><span class="p">;</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">pm</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">pm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SUSPEND_NOW</span><span class="p">;</span>
		<span class="n">pm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PWR_BLON</span> <span class="o">|</span> <span class="n">AUTO_PWR_UP</span><span class="p">);</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">pm</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">pm</span> <span class="o">|=</span> <span class="n">PWR_MGT_ON</span><span class="p">;</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">pm</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">pm</span> <span class="o">&amp;</span> <span class="n">PWR_MGT_STATUS_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">timeout</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>

	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Idle &amp; reset engine */</span>
	<span class="n">wait_for_idle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">aty_reset_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Blank display and LCD */</span>
	<span class="n">atyfb_blank</span><span class="p">(</span><span class="n">FB_BLANK_POWERDOWN</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">asleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">lock_blank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Because we may change PCI D state ourselves, we need to</span>
<span class="cm">	 * first save the config space content so the core can</span>
<span class="cm">	 * restore it properly on resume.</span>
<span class="cm">	 */</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="cm">/* Set chip to &quot;suspend&quot; mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">aty_power_mgmt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">asleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">lock_blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">atyfb_blank</span><span class="p">(</span><span class="n">FB_BLANK_UNBLANK</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">console_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty_resume_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">resume_pll</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">resume_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span><span class="p">)</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span>
			<span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span> <span class="n">BUS_APER_REG_DIS</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_ON</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * PCI state will have been restored by the core, so</span>
<span class="cm">	 * we should be in D0 now with our config space fully</span>
<span class="cm">	 * restored</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_SUSPEND</span><span class="p">)</span>
		<span class="n">aty_power_mgmt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">aty_resume_chip</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">asleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Restore display */</span>
	<span class="n">atyfb_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Refresh */</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Unblank */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">lock_blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atyfb_blank</span><span class="p">(</span><span class="n">FB_BLANK_UNBLANK</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">PMSG_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/*  defined(CONFIG_PM) &amp;&amp; defined(CONFIG_PCI) */</span><span class="cp"></span>

<span class="cm">/* Backlight */</span>
<span class="cp">#ifdef CONFIG_FB_ATY_BACKLIGHT</span>
<span class="cp">#define MAX_LEVEL 0xFF</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_bl_get_level_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">atylevel</span><span class="p">;</span>

	<span class="cm">/* Get and convert the value */</span>
	<span class="cm">/* No locking of bl_curve since we read a single value */</span>
	<span class="n">atylevel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bl_curve</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">*</span> <span class="n">FB_BACKLIGHT_MAX</span> <span class="o">/</span> <span class="n">MAX_LEVEL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atylevel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">atylevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atylevel</span> <span class="o">&gt;</span> <span class="n">MAX_LEVEL</span><span class="p">)</span>
		<span class="n">atylevel</span> <span class="o">=</span> <span class="n">MAX_LEVEL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">atylevel</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_bl_update_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">bl_get_data</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">LCD_MISC_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">!=</span> <span class="n">FB_BLANK_UNBLANK</span> <span class="o">||</span>
	    <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">fb_blank</span> <span class="o">!=</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span>
		<span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">level</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BLMOD_EN</span> <span class="o">|</span> <span class="n">BIASMOD_EN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIAS_MOD_LEVEL_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aty_bl_get_level_brightness</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">BIAS_MOD_LEVEL_SHIFT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIAS_MOD_LEVEL_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aty_bl_get_level_brightness</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">BIAS_MOD_LEVEL_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">LCD_MISC_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_bl_get_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">backlight_ops</span> <span class="n">aty_bl_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="n">aty_bl_get_brightness</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_status</span>	<span class="o">=</span> <span class="n">aty_bl_update_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty_bl_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="n">props</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

<span class="cp">#ifdef CONFIG_PMAC_BACKLIGHT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmac_has_backlight_type</span><span class="p">(</span><span class="s">&quot;ati&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;atybl%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_properties</span><span class="p">));</span>
	<span class="n">props</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BACKLIGHT_RAW</span><span class="p">;</span>
	<span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="n">FB_BACKLIGHT_LEVELS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bd</span> <span class="o">=</span> <span class="n">backlight_device_register</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aty_bl_data</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">props</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bl_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aty: Backlight registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">bl_dev</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>
	<span class="n">fb_bl_default_curve</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="mh">0x3F</span> <span class="o">*</span> <span class="n">FB_BACKLIGHT_MAX</span> <span class="o">/</span> <span class="n">MAX_LEVEL</span><span class="p">,</span>
			    <span class="mh">0xFF</span> <span class="o">*</span> <span class="n">FB_BACKLIGHT_MAX</span> <span class="o">/</span> <span class="n">MAX_LEVEL</span><span class="p">);</span>

	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span><span class="p">;</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">;</span>
	<span class="n">backlight_update_status</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;aty: Backlight initialized (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty_bl_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;aty: Backlight unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_BACKLIGHT */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">aty_calc_mem_refresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xclk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">ragepro_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">44</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">ragexl_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">50</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span>
		<span class="mi">110</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">166</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">refresh_tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">XL_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">refresh_tbl</span> <span class="o">=</span> <span class="n">ragexl_tbl</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ragexl_tbl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">refresh_tbl</span> <span class="o">=</span> <span class="n">ragepro_tbl</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ragepro_tbl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xclk</span> <span class="o">&lt;</span> <span class="n">refresh_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_refresh_rate</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialisation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#if defined(__i386__) &amp;&amp; defined(CONFIG_FB_ATY_GENERIC_LCD)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">atyfb_get_timings_from_lcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LCD_ON</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="n">default_var</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hdisp</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_right_margin</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hblank_len</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_right_margin</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_dly</span> <span class="o">+</span>
			 <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_len</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_len</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_dly</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vdisp</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_lower_margin</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vblank_len</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_lower_margin</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vsync_len</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vsync_len</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_pixclock</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* defined(__i386__) &amp;&amp; defined(CONFIG_FB_ATY_GENERIC_LCD) */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">aty_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ramname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">xtal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gtb_memsize</span><span class="p">,</span> <span class="n">has_var</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_ATY_GX</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">INTEGRATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">stat0</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">dac_type</span><span class="p">,</span> <span class="n">dac_subtype</span><span class="p">,</span> <span class="n">clk_type</span><span class="p">;</span>
		<span class="n">stat0</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CNFG_STAT0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="n">ramname</span> <span class="o">=</span> <span class="n">aty_gx_ram</span><span class="p">[</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span><span class="p">];</span>
		<span class="cm">/* FIXME: clockchip/RAMDAC probing? */</span>
		<span class="n">dac_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ATARI</span>
		<span class="n">clk_type</span> <span class="o">=</span> <span class="n">CLK_ATI18818_1</span><span class="p">;</span>
		<span class="n">dac_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dac_type</span> <span class="o">==</span> <span class="mh">0x07</span><span class="p">)</span>
			<span class="n">dac_subtype</span> <span class="o">=</span> <span class="n">DAC_ATT20C408</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dac_subtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">aty_ld_8</span><span class="p">(</span><span class="n">SCRATCH_REG1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span> <span class="n">dac_type</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">dac_type</span> <span class="o">=</span> <span class="n">DAC_IBMRGB514</span><span class="p">;</span>
		<span class="n">dac_subtype</span> <span class="o">=</span> <span class="n">DAC_IBMRGB514</span><span class="p">;</span>
		<span class="n">clk_type</span> <span class="o">=</span> <span class="n">CLK_IBMRGB514</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dac_subtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DAC_IBMRGB514</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aty_dac_ibm514</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ATARI</span>
		<span class="k">case</span> <span class="n">DAC_ATI68860_B</span>:
		<span class="k">case</span> <span class="n">DAC_ATI68860_C</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aty_dac_ati68860b</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC_ATT20C408</span>:
		<span class="k">case</span> <span class="n">DAC_ATT21C498</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aty_dac_att21c498</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="nl">default:</span>
			<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;aty_init: DAC type not implemented yet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aty_dac_unsupported</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">clk_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ATARI</span>
		<span class="k">case</span> <span class="n">CLK_ATI18818_1</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aty_pll_ati18818_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">case</span> <span class="n">CLK_IBMRGB514</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aty_pll_ibm514</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span><span class="c"> /* dead code */</span>
<span class="c">		case CLK_STG1703:</span>
<span class="c">			par-&gt;pll_ops = &amp;aty_pll_stg1703;</span>
<span class="c">			break;</span>
<span class="c">		case CLK_CH8398:</span>
<span class="c">			par-&gt;pll_ops = &amp;aty_pll_ch8398;</span>
<span class="c">			break;</span>
<span class="c">		case CLK_ATT20C408:</span>
<span class="c">			par-&gt;pll_ops = &amp;aty_pll_att20c408;</span>
<span class="c">			break;</span>
<span class="cp">#endif</span>
		<span class="nl">default:</span>
			<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;aty_init: CLK type not implemented yet!&quot;</span><span class="p">);</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aty_pll_unsupported</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_GX */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_FB_ATY_CT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">INTEGRATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aty_dac_ct</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aty_pll_ct</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">PCI</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CNFG_STAT0</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">XL_MEM</span><span class="p">))</span>
			<span class="n">ramname</span> <span class="o">=</span> <span class="n">aty_xl_ram</span><span class="p">[</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">ramname</span> <span class="o">=</span> <span class="n">aty_ct_ram</span><span class="p">[</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span><span class="p">];</span>
		<span class="cm">/* for many chips, the mclk is 67 MHz for SDRAM, 63 MHz otherwise */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">==</span> <span class="mi">67</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span> <span class="o">&lt;</span> <span class="n">SDRAM</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="cm">/* Mobility + 32bit memory interface need halved XCLK. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">MOBIL_BUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ram_type</span> <span class="o">==</span> <span class="n">SDRAM32</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="cm">/*</span>
<span class="cm">	 * The Apple iBook1 uses non-standard memory frequencies.</span>
<span class="cm">	 * We detect it and set the frequency manually.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook2,1&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="mi">53</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Allow command line to override clocks. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pll</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span> <span class="o">=</span> <span class="n">pll</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mclk</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">mclk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xclk</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="n">xclk</span><span class="p">;</span>

	<span class="n">aty_calc_mem_refresh</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_per</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">/</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mclk_per</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">/</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">xclk_per</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">/</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span> <span class="o">=</span> <span class="mi">1000000000000ULL</span> <span class="o">/</span> <span class="mi">14318180</span><span class="p">;</span>
	<span class="n">xtal</span> <span class="o">=</span> <span class="s">&quot;14.31818&quot;</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_ATY_CT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">GTB_DSP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">pll_ref_div</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">PLL_REF_DIV</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pll_ref_div</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">diff1</span><span class="p">,</span> <span class="n">diff2</span><span class="p">;</span>
			<span class="n">diff1</span> <span class="o">=</span> <span class="mi">510</span> <span class="o">*</span> <span class="mi">14</span> <span class="o">/</span> <span class="n">pll_ref_div</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span><span class="p">;</span>
			<span class="n">diff2</span> <span class="o">=</span> <span class="mi">510</span> <span class="o">*</span> <span class="mi">29</span> <span class="o">/</span> <span class="n">pll_ref_div</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diff1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">diff1</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diff2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">diff2</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diff2</span> <span class="o">&lt;</span> <span class="n">diff1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_clk_per</span> <span class="o">=</span> <span class="mi">1000000000000ULL</span> <span class="o">/</span> <span class="mi">29498928</span><span class="p">;</span>
				<span class="n">xtal</span> <span class="o">=</span> <span class="s">&quot;29.498928&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_CT */</span><span class="cp"></span>

	<span class="cm">/* save previous video mode */</span>
	<span class="n">aty_get_crtc</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">saved_crtc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">get_pll</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">get_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">saved_pll</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">gtb_memsize</span> <span class="o">=</span> <span class="n">M64_HAS</span><span class="p">(</span><span class="n">GTB_DSP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gtb_memsize</span><span class="p">)</span>
		<span class="cm">/* 0xF used instead of MEM_SIZE_ALIAS */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_512K</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x80000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_1M</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x100000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_2M_GTB</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x200000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_4M_GTB</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_6M_GTB</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x600000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_8M_GTB</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x800000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x80000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span> <span class="o">&amp;</span> <span class="n">MEM_SIZE_ALIAS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_512K</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x80000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_1M</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x100000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_2M</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x200000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_4M</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_6M</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x600000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_SIZE_8M</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x800000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x80000</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">MAGIC_VRAM_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CNFG_STAT1</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">+=</span> <span class="mh">0x400000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">vram</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">gtb_memsize</span> <span class="o">?</span> <span class="mh">0xF</span> <span class="o">:</span> <span class="n">MEM_SIZE_ALIAS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&lt;=</span> <span class="mh">0x80000</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span> <span class="o">|=</span> <span class="n">MEM_SIZE_512K</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&lt;=</span> <span class="mh">0x100000</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span> <span class="o">|=</span> <span class="n">MEM_SIZE_1M</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&lt;=</span> <span class="mh">0x200000</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span> <span class="o">|=</span> <span class="n">gtb_memsize</span> <span class="o">?</span> <span class="n">MEM_SIZE_2M_GTB</span> <span class="o">:</span> <span class="n">MEM_SIZE_2M</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&lt;=</span> <span class="mh">0x400000</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span> <span class="o">|=</span> <span class="n">gtb_memsize</span> <span class="o">?</span> <span class="n">MEM_SIZE_4M_GTB</span> <span class="o">:</span> <span class="n">MEM_SIZE_4M</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&lt;=</span> <span class="mh">0x600000</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span> <span class="o">|=</span> <span class="n">gtb_memsize</span> <span class="o">?</span> <span class="n">MEM_SIZE_6M_GTB</span> <span class="o">:</span> <span class="n">MEM_SIZE_6M</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span> <span class="o">|=</span> <span class="n">gtb_memsize</span> <span class="o">?</span> <span class="n">MEM_SIZE_8M_GTB</span> <span class="o">:</span> <span class="n">MEM_SIZE_8M</span><span class="p">;</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mem_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reg Block 0 (CT-compatible block) is at mmio_start</span>
<span class="cm">	 * Reg Block 1 (multimedia extensions) is at mmio_start - 0x400</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">GX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_ATI_MACH64GX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">CT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_ATI_MACH64CT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">VT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">-=</span> <span class="mh">0x400</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_ATI_MACH64VT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="cm">/* GT */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">-=</span> <span class="mh">0x400</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_ATI_MACH64GT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;%d%c %s, %s MHz XTAL, %d MHz PLL, %d Mhz MCLK, %d MHz XCLK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">==</span> <span class="mh">0x80000</span> <span class="o">?</span> <span class="mi">512</span> <span class="o">:</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="p">),</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">==</span> <span class="mh">0x80000</span> <span class="o">?</span> <span class="sc">&#39;K&#39;</span> <span class="o">:</span> <span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="n">ramname</span><span class="p">,</span> <span class="n">xtal</span><span class="p">,</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span><span class="p">,</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span><span class="p">);</span>

<span class="cp">#if defined(DEBUG) &amp;&amp; defined(CONFIG_FB_ATY_CT)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">INTEGRATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;debug atyfb: BUS_CNTL DAC_CNTL MEM_CNTL &quot;</span>
		       <span class="s">&quot;EXT_MEM_CNTL CRTC_GEN_CNTL DSP_CONFIG &quot;</span>
		       <span class="s">&quot;DSP_ON_OFF CLOCK_CNTL</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;debug atyfb: %08x %08x %08x &quot;</span>
		       <span class="s">&quot;%08x     %08x      %08x   &quot;</span>
		       <span class="s">&quot;%08x   %08x</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;debug atyfb: PLL&quot;</span><span class="p">,</span>
		       <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">),</span>
		       <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">),</span>
		       <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">),</span>
		       <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">EXT_MEM_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">),</span>
		       <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">),</span>
		       <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DSP_CONFIG</span><span class="p">,</span> <span class="n">par</span><span class="p">),</span>
		       <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DSP_ON_OFF</span><span class="p">,</span> <span class="n">par</span><span class="p">),</span>
		       <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CLOCK_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">init_pll</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">init_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">resume_pll</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">resume_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Last page of 8 MB (4 MB on ISA) aperture is MMIO,</span>
<span class="cm">	 * unless the auxiliary register aperture is used.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">==</span> <span class="mh">0x800000</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">ISA</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">==</span> <span class="mh">0x400000</span><span class="p">)))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">-=</span> <span class="n">GUI_RESERVE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable register access through the linear aperture</span>
<span class="cm">	 * if the auxiliary aperture is used so we can access</span>
<span class="cm">	 * the full 8 MB of video RAM on 8 MB boards.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span><span class="p">)</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">BUS_APER_REG_DIS</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_aper</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nomtrr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Cover the whole resource. */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_aper</span> <span class="o">=</span> <span class="n">mtrr_add</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">res_start</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res_size</span><span class="p">,</span>
					  <span class="n">MTRR_TYPE_WRCOMB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_aper</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Make a hole for mmio. */</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span> <span class="o">=</span> <span class="n">mtrr_add</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">res_start</span> <span class="o">+</span> <span class="mh">0x800000</span> <span class="o">-</span>
						 <span class="n">GUI_RESERVE</span><span class="p">,</span> <span class="n">GUI_RESERVE</span><span class="p">,</span>
						 <span class="n">MTRR_TYPE_UNCACHABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mtrr_del</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_aper</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_aper</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atyfb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span>           <span class="o">|</span>
		      <span class="n">FBINFO_HWACCEL_IMAGEBLIT</span> <span class="o">|</span>
		      <span class="n">FBINFO_HWACCEL_FILLRECT</span>  <span class="o">|</span>
		      <span class="n">FBINFO_HWACCEL_COPYAREA</span>  <span class="o">|</span>
		      <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PMAC_BACKLIGHT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">G3_PB_1_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook1,1&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * these bits let the 101 powerbook</span>
<span class="cm">		 * wake up from sleep -- paulus</span>
<span class="cm">		 */</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">USE_F32KHZ</span> <span class="o">|</span> <span class="n">TRISTATE_MEM_EN</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">MOBIL_BUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">backlight</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_ATY_BACKLIGHT</span>
		<span class="n">aty_bl_init</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">var</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_PPC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: The NVRAM stuff should be put in a Mac-specific file,</span>
<span class="cm">		 *        as it applies to all Mac video cards</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mac_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
				<span class="n">has_var</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">default_vmode</span> <span class="o">==</span> <span class="n">VMODE_CHOOSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">sense</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">G3_PB_1024x768</span><span class="p">))</span>
					<span class="cm">/* G3 PowerBook with 1024x768 LCD */</span>
					<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_1024_768_60</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;iMac&quot;</span><span class="p">))</span>
					<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_1024_768_75</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook2,1&quot;</span><span class="p">))</span>
					<span class="cm">/* iBook with 800x600 LCD */</span>
					<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_800_600_60</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_640_480_67</span><span class="p">;</span>
				<span class="n">sense</span> <span class="o">=</span> <span class="n">read_aty_sense</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
				<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;monitor sense=%x, mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">sense</span><span class="p">,</span>  <span class="n">mac_map_monitor_sense</span><span class="p">(</span><span class="n">sense</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">default_vmode</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">default_vmode</span> <span class="o">&gt;</span> <span class="n">VMODE_MAX</span><span class="p">)</span>
				<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_640_480_60</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">default_cmode</span> <span class="o">&lt;</span> <span class="n">CMODE_8</span> <span class="o">||</span> <span class="n">default_cmode</span> <span class="o">&gt;</span> <span class="n">CMODE_32</span><span class="p">)</span>
				<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac_vmode_to_var</span><span class="p">(</span><span class="n">default_vmode</span><span class="p">,</span> <span class="n">default_cmode</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">var</span><span class="p">))</span>
				<span class="n">has_var</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* !CONFIG_PPC */</span><span class="cp"></span>

<span class="cp">#if defined(__i386__) &amp;&amp; defined(CONFIG_FB_ATY_GENERIC_LCD)</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atyfb_get_timings_from_lcd</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">))</span>
		<span class="n">has_var</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">defmode</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">has_var</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_var</span><span class="p">)</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">default_var</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">noaccel</span><span class="p">)</span>
		<span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">|=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comp_sync</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">comp_sync</span><span class="p">)</span>
			<span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_SYNC_COMP_HIGH_ACT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">==</span> <span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">videoram</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">-</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="p">((</span><span class="n">videoram</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">/</span> <span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">)</span>
			<span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">atyfb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;can&#39;t set default video mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">aty_init_exit</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_ATY_CT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">noaccel</span> <span class="o">&amp;&amp;</span> <span class="n">M64_HAS</span><span class="p">(</span><span class="n">INTEGRATED</span><span class="p">))</span>
		<span class="n">aty_init_cursor</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_CT */</span><span class="cp"></span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">aty_init_exit</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">aty_init_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_list</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;fb%d: %s frame buffer device on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">ISA</span> <span class="o">?</span> <span class="s">&quot;ISA&quot;</span> <span class="o">:</span> <span class="s">&quot;PCI&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">aty_init_exit:</span>
	<span class="cm">/* restore video mode */</span>
	<span class="n">aty_set_crtc</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">saved_crtc</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">set_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">saved_pll</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_aper</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_aper</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_aper</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_ATARI) &amp;&amp; !defined(MODULE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">store_video_par</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">video_str</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">m64_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vmembase</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">guiregbase</span><span class="p">;</span>

	<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;store_video_par() &#39;%s&#39; </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">video_str</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video_str</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mach64_invalid</span><span class="p">;</span>
	<span class="n">vmembase</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video_str</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mach64_invalid</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video_str</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mach64_invalid</span><span class="p">;</span>
	<span class="n">guiregbase</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">phys_vmembase</span><span class="p">[</span><span class="n">m64_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmembase</span><span class="p">;</span>
	<span class="n">phys_size</span><span class="p">[</span><span class="n">m64_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">phys_guiregbase</span><span class="p">[</span><span class="n">m64_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">guiregbase</span><span class="p">;</span>
	<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;stored them all: $%08lX $%08lX $%08lX </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vmembase</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		<span class="n">guiregbase</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">mach64_invalid:</span>
	<span class="n">phys_vmembase</span><span class="p">[</span><span class="n">m64_num</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ATARI &amp;&amp; !MODULE */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Blank the display.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gen_cntl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock_blank</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">asleep</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">&amp;&amp;</span> <span class="n">blank</span> <span class="o">&gt;</span> <span class="n">FB_BLANK_NORMAL</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LCD_ON</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">pm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PWR_BLON</span><span class="p">;</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">gen_cntl</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">gen_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x400004c</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="n">gen_cntl</span> <span class="o">|=</span> <span class="mh">0x4000040</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="n">gen_cntl</span> <span class="o">|=</span> <span class="mh">0x4000048</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="n">gen_cntl</span> <span class="o">|=</span> <span class="mh">0x4000044</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="n">gen_cntl</span> <span class="o">|=</span> <span class="mh">0x400004c</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">gen_cntl</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">&amp;&amp;</span> <span class="n">blank</span> <span class="o">&lt;=</span> <span class="n">FB_BLANK_NORMAL</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">LCD_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LCD_ON</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">aty_ld_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">pm</span> <span class="o">|=</span> <span class="n">PWR_BLON</span><span class="p">;</span>
		<span class="n">aty_st_lcd</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty_st_pal</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">DAC_W_INDEX</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">DAC_DATA</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">DAC_DATA</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">DAC_DATA</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set a single color register. The values supplied are already</span>
<span class="cm"> * rounded down to the hardware&#39;s capabilities (according to the</span>
<span class="cm"> * entries in the var structure). Return != 0 for invalid regno.</span>
<span class="cm"> * !! 4 &amp; 8 =  PSEUDO, &gt; 8 = DIRECTCOLOR</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			   <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">depth</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="n">depth</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="mi">15</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">asleep</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">].</span><span class="n">red</span> <span class="o">=</span> <span class="n">red</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">].</span><span class="n">green</span> <span class="o">=</span> <span class="n">green</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">].</span><span class="n">blue</span> <span class="o">=</span> <span class="n">blue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">15</span>:
			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>:
			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">aty_ld_8</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">EXTRA_BRIGHT</span><span class="p">))</span>
		<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="cm">/* DAC_CNTL | 0x2 turns off the extra brightness for gt */</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">DAC_MASK</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">INTEGRATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
				<span class="n">aty_st_pal</span><span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span>
					   <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">].</span><span class="n">green</span><span class="p">,</span>
					   <span class="n">blue</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">red</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">].</span><span class="n">red</span><span class="p">;</span>
			<span class="n">blue</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">].</span><span class="n">blue</span><span class="p">;</span>
			<span class="n">regno</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regno</span> <span class="o">&lt;&lt;=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">aty_st_pal</span><span class="p">(</span><span class="n">regno</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">aty_st_pal</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>

<span class="cp">#ifdef __sparc__</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">atyfb_setup_sparc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mem</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Map memory-mapped registers.</span>
<span class="cm">	 */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x7ffc00UL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x7ffc00UL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Map in big-endian aperture.</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x800000UL</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x800000UL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Figure mmap addresses from PCI config space.</span>
<span class="cm">	 * Split Framebuffer in big- and little-endian halfs.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="cm">/* nothing */</span> <span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;atyfb_setup_sparc() can&#39;t alloc mmap_map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">io</span><span class="p">,</span> <span class="n">breg</span> <span class="o">=</span> <span class="n">PCI_BASE_ADDRESS_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">pbase</span><span class="p">;</span>

		<span class="n">base</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

		<span class="n">io</span> <span class="o">=</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">);</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">breg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbase</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Map the framebuffer a second time, this time without</span>
<span class="cm">		 * the braindead _PAGE_IE setting. This is used by the</span>
<span class="cm">		 * fixed Xserver, but we need to maintain the old mapping</span>
<span class="cm">		 * to stay compatible with older ones...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">voff</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbase</span> <span class="o">+</span> <span class="mh">0x10000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">poff</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">prot_mask</span> <span class="o">=</span> <span class="n">_PAGE_CACHE</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">prot_flag</span> <span class="o">=</span> <span class="n">_PAGE_E</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Here comes the old framebuffer mapping with _PAGE_IE</span>
<span class="cm">		 * set for the big endian half of the framebuffer...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">voff</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbase</span> <span class="o">+</span> <span class="mh">0x800000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">poff</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x800000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x800000</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">prot_mask</span> <span class="o">=</span> <span class="n">_PAGE_CACHE</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">prot_flag</span> <span class="o">=</span> <span class="n">_PAGE_E</span> <span class="o">|</span> <span class="n">_PAGE_IE</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="mh">0x800000</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">voff</span> <span class="o">=</span> <span class="n">pbase</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">poff</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">prot_mask</span> <span class="o">=</span> <span class="n">_PAGE_CACHE</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">prot_flag</span> <span class="o">=</span> <span class="n">_PAGE_E</span><span class="p">;</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">correct_chipset</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_XL</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fix PROMs idea of MEM_CNTL settings...</span>
<span class="cm">		 */</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">chip_id</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CNFG_CHIP_ID</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">chip_id</span> <span class="o">&amp;</span> <span class="n">CFG_CHIP_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">VT_CHIP_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="n">chip_id</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">mem</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">))</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">))</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">9</span>:
				<span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">))</span> <span class="o">|</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">11</span>:
				<span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">))</span> <span class="o">|</span> <span class="mi">5</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CNFG_STAT0</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SDRAM</span><span class="p">)</span>
				<span class="n">mem</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x00700000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mem</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xcf80e000</span><span class="p">);</span>	<span class="cm">/* Turn off all undocumented bits. */</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="o">==</span> <span class="n">of_console_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">default_var</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">N</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">v_total</span><span class="p">,</span> <span class="n">h_total</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">crtc</span> <span class="n">crtc</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">pll_regs</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">clock_cntl</span><span class="p">;</span>

		<span class="n">crtc</span><span class="p">.</span><span class="n">vxres</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;width&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">crtc</span><span class="p">.</span><span class="n">vyres</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;height&quot;</span><span class="p">,</span> <span class="mi">768</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;depth&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crtc</span><span class="p">.</span><span class="n">h_tot_disp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_H_TOTAL_DISP</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">crtc</span><span class="p">.</span><span class="n">h_sync_strt_wid</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_H_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">crtc</span><span class="p">.</span><span class="n">v_tot_disp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_V_TOTAL_DISP</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">crtc</span><span class="p">.</span><span class="n">v_sync_strt_wid</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_V_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">crtc</span><span class="p">.</span><span class="n">gen_cntl</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">aty_crtc_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crtc</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>

		<span class="n">h_total</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
		<span class="n">v_total</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Read the PLL to figure actual Refresh Rate.</span>
<span class="cm">		 */</span>
		<span class="n">clock_cntl</span> <span class="o">=</span> <span class="n">aty_ld_8</span><span class="p">(</span><span class="n">CLOCK_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* DPRINTK(&quot;CLOCK_CNTL %02x\n&quot;, clock_cntl); */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pll_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aty_ld_pll_ct</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * PLL Reference Divider M:</span>
<span class="cm">		 */</span>
		<span class="n">M</span> <span class="o">=</span> <span class="n">pll_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * PLL Feedback Divider N (Dependent on CLOCK_CNTL):</span>
<span class="cm">		 */</span>
		<span class="n">N</span> <span class="o">=</span> <span class="n">pll_regs</span><span class="p">[</span><span class="mi">7</span> <span class="o">+</span> <span class="p">(</span><span class="n">clock_cntl</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)];</span>

		<span class="cm">/*</span>
<span class="cm">		 * PLL Post Divider P (Dependent on CLOCK_CNTL):</span>
<span class="cm">		 */</span>
		<span class="n">P</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pll_regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">clock_cntl</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * PLL Divider Q:</span>
<span class="cm">		 */</span>
		<span class="n">Q</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">P</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Target Frequency:</span>
<span class="cm">		 *</span>
<span class="cm">		 *      T * M</span>
<span class="cm">		 * Q = -------</span>
<span class="cm">		 *      2 * R</span>
<span class="cm">		 *</span>
<span class="cm">		 * where R is XTALIN (= 14318 or 29498 kHz).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_XL</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
			<span class="n">R</span> <span class="o">=</span> <span class="mi">29498</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">R</span> <span class="o">=</span> <span class="mi">14318</span><span class="p">;</span>

		<span class="n">T</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">R</span> <span class="o">/</span> <span class="n">M</span><span class="p">;</span>

		<span class="n">default_var</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">T</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* __sparc__ */</span><span class="cp"></span>

<span class="cp">#ifdef __i386__</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">aty_init_lcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bios_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">driv_inf_tab</span><span class="p">,</span> <span class="n">sig</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lcd_ofs</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * To support an LCD panel, we should know it&#39;s dimensions and</span>
<span class="cm">	 *  it&#39;s desired pixel clock.</span>
<span class="cm">	 * There are two ways to do it:</span>
<span class="cm">	 *  - Check the startup video mode and calculate the panel</span>
<span class="cm">	 *    size from it. This is unreliable.</span>
<span class="cm">	 *  - Read it from the driver information table in the video BIOS.</span>
<span class="cm">	 */</span>
	<span class="cm">/* Address of driver information table is at offset 0x78. */</span>
	<span class="n">driv_inf_tab</span> <span class="o">=</span> <span class="n">bios_base</span> <span class="o">+</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">bios_base</span><span class="o">+</span><span class="mh">0x78</span><span class="p">));</span>

	<span class="cm">/* Check for the driver information table signature. */</span>
	<span class="n">sig</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">driv_inf_tab</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sig</span> <span class="o">==</span> <span class="mh">0x54504c24</span><span class="p">)</span> <span class="o">||</span> <span class="cm">/* Rage LT pro */</span>
	    <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="mh">0x544d5224</span><span class="p">)</span> <span class="o">||</span> <span class="cm">/* Rage mobility */</span>
	    <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="mh">0x54435824</span><span class="p">)</span> <span class="o">||</span> <span class="cm">/* Rage XC */</span>
	    <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="mh">0x544c5824</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Rage XL */</span>
		<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;BIOS contains driver information table.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lcd_ofs</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">driv_inf_tab</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lcd_ofs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">=</span> <span class="n">bios_base</span> <span class="o">+</span> <span class="n">lcd_ofs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">model</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
		<span class="kt">char</span> <span class="n">strbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="kt">char</span> <span class="n">refresh_rates_buf</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">tech</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">default_refresh_rate</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">txtcolour</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">txtmonitor</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">txtdual</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">txtformat</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">panel_type</span><span class="p">,</span> <span class="n">refresh_rates</span><span class="p">;</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">lcdmodeptr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">format</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">lcd_refresh_rates</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span>
					     <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">200</span> <span class="p">};</span>
		<span class="cm">/*</span>
<span class="cm">		 * The most important information is the panel size at</span>
<span class="cm">		 * offset 25 and 27, but there&#39;s some other nice information</span>
<span class="cm">		 * which we print to the screen.</span>
<span class="cm">		 */</span>
		<span class="n">id</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">model</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">width</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_width</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span><span class="o">+</span><span class="mi">25</span><span class="p">);</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_height</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span><span class="o">+</span><span class="mi">27</span><span class="p">);</span>
		<span class="n">panel_type</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span><span class="o">+</span><span class="mi">29</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">panel_type</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">txtcolour</span> <span class="o">=</span> <span class="s">&quot;colour&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">txtcolour</span> <span class="o">=</span> <span class="s">&quot;monochrome&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">panel_type</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">txtdual</span> <span class="o">=</span> <span class="s">&quot;dual (split) &quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">txtdual</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="n">tech</span> <span class="o">=</span> <span class="p">(</span><span class="n">panel_type</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tech</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">txtmonitor</span> <span class="o">=</span> <span class="s">&quot;passive matrix&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">txtmonitor</span> <span class="o">=</span> <span class="s">&quot;active matrix&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">txtmonitor</span> <span class="o">=</span> <span class="s">&quot;active addressed STN&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">txtmonitor</span> <span class="o">=</span> <span class="s">&quot;EL&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">txtmonitor</span> <span class="o">=</span> <span class="s">&quot;plasma&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">txtmonitor</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">format</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span><span class="o">+</span><span class="mi">57</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tech</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tech</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">format</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">txtformat</span> <span class="o">=</span> <span class="s">&quot;12 bit interface&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">txtformat</span> <span class="o">=</span> <span class="s">&quot;16 bit interface&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">txtformat</span> <span class="o">=</span> <span class="s">&quot;24 bit interface&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">txtformat</span> <span class="o">=</span> <span class="s">&quot;unknown format&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">format</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">txtformat</span> <span class="o">=</span> <span class="s">&quot;8 colours&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">txtformat</span> <span class="o">=</span> <span class="s">&quot;512 colours&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">txtformat</span> <span class="o">=</span> <span class="s">&quot;4096 colours&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">txtformat</span> <span class="o">=</span> <span class="s">&quot;262144 colours (LT mode)&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">txtformat</span> <span class="o">=</span> <span class="s">&quot;16777216 colours&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">txtformat</span> <span class="o">=</span> <span class="s">&quot;262144 colours (FDPI-2 mode)&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">txtformat</span> <span class="o">=</span> <span class="s">&quot;unknown format&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;%s%s %s monitor detected: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">txtdual</span><span class="p">,</span> <span class="n">txtcolour</span><span class="p">,</span> <span class="n">txtmonitor</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>
		<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;       id=%d, %dx%d pixels, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">id</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">txtformat</span><span class="p">);</span>
		<span class="n">refresh_rates_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">refresh_rates</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span><span class="o">+</span><span class="mi">62</span><span class="p">);</span>
		<span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">refresh_rates</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span>
						<span class="n">lcd_refresh_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="n">f</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span> <span class="s">&quot;,%d&quot;</span><span class="p">,</span>
						<span class="n">lcd_refresh_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="p">}</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">refresh_rates_buf</span><span class="p">,</span> <span class="n">strbuf</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">default_refresh_rate</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span><span class="o">+</span><span class="mi">61</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;       supports refresh rates [%s], default %d Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">refresh_rates_buf</span><span class="p">,</span> <span class="n">lcd_refresh_rates</span><span class="p">[</span><span class="n">default_refresh_rate</span><span class="p">]);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_refreshrate</span> <span class="o">=</span> <span class="n">lcd_refresh_rates</span><span class="p">[</span><span class="n">default_refresh_rate</span><span class="p">];</span>
		<span class="cm">/*</span>
<span class="cm">		 * We now need to determine the crtc parameters for the</span>
<span class="cm">		 * LCD monitor. This is tricky, because they are not stored</span>
<span class="cm">		 * individually in the BIOS. Instead, the BIOS contains a</span>
<span class="cm">		 * table of display modes that work for this monitor.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The idea is that we search for a mode of the same dimensions</span>
<span class="cm">		 * as the dimensions of the LCD monitor. Say our LCD monitor</span>
<span class="cm">		 * is 800x600 pixels, we search for a 800x600 monitor.</span>
<span class="cm">		 * The CRTC parameters we find here are the ones that we need</span>
<span class="cm">		 * to use to simulate other resolutions on the LCD screen.</span>
<span class="cm">		 */</span>
		<span class="n">lcdmodeptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_table</span> <span class="o">+</span> <span class="mi">64</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">lcdmodeptr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">modeptr</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">mwidth</span><span class="p">,</span> <span class="n">mheight</span><span class="p">,</span> <span class="n">lcd_hsync_start</span><span class="p">,</span> <span class="n">lcd_vsync_start</span><span class="p">;</span>
			<span class="n">modeptr</span> <span class="o">=</span> <span class="n">bios_base</span> <span class="o">+</span> <span class="o">*</span><span class="n">lcdmodeptr</span><span class="p">;</span>

			<span class="n">mwidth</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">0</span><span class="p">));</span>
			<span class="n">mheight</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">2</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mwidth</span> <span class="o">==</span> <span class="n">width</span> <span class="o">&amp;&amp;</span> <span class="n">mheight</span> <span class="o">==</span> <span class="n">height</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_pixclock</span> <span class="o">=</span> <span class="mi">100000000</span> <span class="o">/</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">9</span><span class="p">));</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_htotal</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">17</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">511</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hdisp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">19</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">511</span><span class="p">;</span>
				<span class="n">lcd_hsync_start</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">21</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">511</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_dly</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">21</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_len</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">23</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">;</span>

				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vtotal</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">24</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">2047</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vdisp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">26</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">2047</span><span class="p">;</span>
				<span class="n">lcd_vsync_start</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">28</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">2047</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">modeptr</span><span class="o">+</span><span class="mi">28</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">;</span>

				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_htotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_htotal</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hdisp</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hdisp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">lcd_hsync_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">lcd_hsync_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_len</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vtotal</span><span class="o">++</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vdisp</span><span class="o">++</span><span class="p">;</span>
				<span class="n">lcd_vsync_start</span><span class="o">++</span><span class="p">;</span>

				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_right_margin</span> <span class="o">=</span> <span class="n">lcd_hsync_start</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hdisp</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_lower_margin</span> <span class="o">=</span> <span class="n">lcd_vsync_start</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vdisp</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hblank_len</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_htotal</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hdisp</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vblank_len</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vtotal</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vdisp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">lcdmodeptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">lcdmodeptr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;LCD monitor CRTC parameters not found!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* To do: Switch to CRT if possible. */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;       LCD CRTC parameters: %d.%d  %d %d %d %d  %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="mi">1000000</span> <span class="o">/</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_pixclock</span><span class="p">,</span> <span class="mi">1000000</span> <span class="o">%</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_pixclock</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hdisp</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hdisp</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_right_margin</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hdisp</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_right_margin</span>
					<span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_dly</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_len</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_htotal</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vdisp</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vdisp</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_lower_margin</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vdisp</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_lower_margin</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vsync_len</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vtotal</span><span class="p">);</span>
			<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;                          : %d %d %d %d %d %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_pixclock</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hblank_len</span> <span class="o">-</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_right_margin</span> <span class="o">+</span>
					<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_dly</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_len</span><span class="p">),</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hdisp</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_right_margin</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_hsync_len</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vblank_len</span> <span class="o">-</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_lower_margin</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vsync_len</span><span class="p">),</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vdisp</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_lower_margin</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_vsync_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_GENERIC_LCD */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">init_from_bios</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bios_base</span><span class="p">,</span> <span class="n">rom_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rom_addr</span> <span class="o">=</span> <span class="mh">0xc0000</span> <span class="o">+</span> <span class="p">((</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">SCRATCH_REG1</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">bios_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">rom_addr</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>

	<span class="cm">/* The BIOS starts with 0xaa55. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">bios_base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa55</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">u8</span> <span class="o">*</span><span class="n">bios_ptr</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rom_table_offset</span><span class="p">,</span> <span class="n">freq_table_offset</span><span class="p">;</span>
		<span class="n">PLL_BLOCK_MACH64</span> <span class="n">pll_block</span><span class="p">;</span>

		<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;Mach64 BIOS is located at %x, mapped at %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rom_addr</span><span class="p">,</span> <span class="n">bios_base</span><span class="p">);</span>

		<span class="cm">/* check for frequncy table */</span>
		<span class="n">bios_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">bios_base</span><span class="p">;</span>
		<span class="n">rom_table_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">bios_ptr</span><span class="p">[</span><span class="mh">0x48</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">bios_ptr</span><span class="p">[</span><span class="mh">0x49</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">freq_table_offset</span> <span class="o">=</span> <span class="n">bios_ptr</span><span class="p">[</span><span class="n">rom_table_offset</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">bios_ptr</span><span class="p">[</span><span class="n">rom_table_offset</span> <span class="o">+</span> <span class="mi">17</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pll_block</span><span class="p">,</span> <span class="n">bios_ptr</span> <span class="o">+</span> <span class="n">freq_table_offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PLL_BLOCK_MACH64</span><span class="p">));</span>

		<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;BIOS frequency table:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;PCLK_min_freq %d, PCLK_max_freq %d, ref_freq %d, ref_divider %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pll_block</span><span class="p">.</span><span class="n">PCLK_min_freq</span><span class="p">,</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">PCLK_max_freq</span><span class="p">,</span>
			<span class="n">pll_block</span><span class="p">.</span><span class="n">ref_freq</span><span class="p">,</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">ref_divider</span><span class="p">);</span>
		<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;MCLK_pwd %d, MCLK_max_freq %d, XCLK_max_freq %d, SCLK_freq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pll_block</span><span class="p">.</span><span class="n">MCLK_pwd</span><span class="p">,</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">MCLK_max_freq</span><span class="p">,</span>
			<span class="n">pll_block</span><span class="p">.</span><span class="n">XCLK_max_freq</span><span class="p">,</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">SCLK_freq</span><span class="p">);</span>

		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_min</span> <span class="o">=</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">PCLK_min_freq</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">pll_max</span> <span class="o">=</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">PCLK_max_freq</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">ref_clk</span> <span class="o">=</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">ref_freq</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">ref_div</span> <span class="o">=</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">ref_divider</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">sclk</span> <span class="o">=</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">SCLK_freq</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">MCLK_max_freq</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">mclk_pm</span> <span class="o">=</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">MCLK_pwd</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_limits</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="n">pll_block</span><span class="p">.</span><span class="n">XCLK_max_freq</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GENERIC_LCD</span>
		<span class="n">aty_init_lcd</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">bios_base</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;no BIOS frequency table found, use parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bios_base</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* __i386__ */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">atyfb_setup_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">raddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">rrp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">raddr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x7ff000UL</span><span class="p">;</span>
	<span class="n">rrp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rrp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">request_mem_region</span><span class="p">(</span><span class="n">rrp</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">rrp</span><span class="p">),</span> <span class="s">&quot;atyfb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span> <span class="o">=</span> <span class="n">rrp</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">rrp</span><span class="p">);</span>
		<span class="n">raddr</span> <span class="o">=</span> <span class="n">rrp</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;using auxiliary register aperture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">raddr</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span> <span class="o">?</span> <span class="mh">0x400</span> <span class="o">:</span> <span class="mh">0xc00</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span> <span class="o">?</span> <span class="mh">0x400</span> <span class="o">:</span> <span class="mh">0xc00</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable memory-space accesses using config-space</span>
<span class="cm">	 * command register.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_MEMORY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_MEMORY</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="cm">/* Use the big-endian aperture */</span>
	<span class="n">addr</span> <span class="o">+=</span> <span class="mh">0x800000</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Map in frame buffer */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mh">0x800000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">atyfb_setup_generic_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">correct_chipset</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">atyfb_setup_generic_fail</span><span class="p">;</span>
<span class="cp">#ifdef __i386__</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_from_bios</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">atyfb_setup_generic_fail</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CRTC_EXT_DISP_EN</span><span class="p">))</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">R_GENMO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0CU</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span> <span class="o">=</span> <span class="n">aty_ld_8</span><span class="p">(</span><span class="n">CLOCK_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03U</span><span class="p">;</span>

	<span class="cm">/* according to ATI, we should use clock 3 for acelerated mode */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">atyfb_setup_generic_fail:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* !__sparc__ */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">atyfb_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">res_start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Enable device in PCI config */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;Cannot enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find which resource to use */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Reserve space */</span>
	<span class="n">res_start</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">res_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res_start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">,</span> <span class="s">&quot;atyfb&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Allocate framebuffer */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;atyfb_pci_probe() can&#39;t alloc fb_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">atyfb_fix</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pci_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">res_start</span> <span class="o">=</span> <span class="n">res_start</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">res_size</span> <span class="o">=</span> <span class="n">res_size</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* Setup &quot;info&quot; structure */</span>
<span class="cp">#ifdef __sparc__</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">atyfb_setup_sparc</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">atyfb_setup_generic</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_release_mem</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Init chip &amp; register framebuffer */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">aty_init</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_release_io</span><span class="p">;</span>

<span class="cp">#ifdef __sparc__</span>
	<span class="cm">/*</span>
<span class="cm">	 * Add /dev/fb mmap values.</span>
<span class="cm">	 */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voff</span> <span class="o">=</span> <span class="mh">0x8000000000000000UL</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">poff</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prot_mask</span> <span class="o">=</span> <span class="n">_PAGE_CACHE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prot_flag</span> <span class="o">=</span> <span class="n">_PAGE_E</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">voff</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voff</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">poff</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">prot_mask</span> <span class="o">=</span> <span class="n">_PAGE_CACHE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">prot_flag</span> <span class="o">=</span> <span class="n">_PAGE_E</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* __sparc__ */</span><span class="cp"></span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reboot_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reboot_info</span><span class="p">)</span>
		<span class="n">reboot_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reboot_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_release_io:</span>
<span class="cp">#ifdef __sparc__</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">err_release_mem:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_size</span><span class="p">);</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">res_start</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res_size</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ATARI</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">atyfb_atari_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m64_num</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clock_r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">m64_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m64_num</span> <span class="o">&lt;</span> <span class="n">mach64_count</span><span class="p">;</span> <span class="n">m64_num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phys_vmembase</span><span class="p">[</span><span class="n">m64_num</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">phys_size</span><span class="p">[</span><span class="n">m64_num</span><span class="p">]</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">phys_guiregbase</span><span class="p">[</span><span class="n">m64_num</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">PRINTKI</span><span class="p">(</span><span class="s">&quot;phys_*[%d] parameters not set =&gt; &quot;</span>
				<span class="s">&quot;returning early. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m64_num</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PRINTKE</span><span class="p">(</span><span class="s">&quot;atyfb_atari_probe() can&#39;t alloc fb_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">atyfb_fix</span><span class="p">;</span>

		<span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* something invalid */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Map the video memory (physical address given)</span>
<span class="cm">		 * to somewhere in the kernel address space.</span>
<span class="cm">		 */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">phys_vmembase</span><span class="p">[</span><span class="n">m64_num</span><span class="p">],</span> <span class="n">phys_size</span><span class="p">[</span><span class="n">m64_num</span><span class="p">]);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">;</span> <span class="cm">/* Fake! */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">phys_guiregbase</span><span class="p">[</span><span class="n">m64_num</span><span class="p">],</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">+</span>
						<span class="mh">0xFC00ul</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span><span class="p">;</span> <span class="cm">/* Fake! */</span>

		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CLOCK_CNTL</span><span class="p">,</span> <span class="mh">0x12345678</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">clock_r</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CLOCK_CNTL</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">clock_r</span> <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x12</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/*  */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x34</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Medusa ST-IO ISA Adapter etc. */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x16</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/*  */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x38</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_wr_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Panther 1 ISA Adapter (Gerald) */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Fake pci_id for correct_chipset() */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CNFG_CHIP_ID</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CFG_CHIP_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00d7</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pci_id</span> <span class="o">=</span> <span class="n">PCI_CHIP_MACH64GX</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0057</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pci_id</span> <span class="o">=</span> <span class="n">PCI_CHIP_MACH64CX</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">correct_chipset</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="o">||</span> <span class="n">aty_init</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span><span class="p">);</span>
			<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">num_found</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">num_found</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_ATARI */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PCI</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">atyfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="cm">/* restore video mode */</span>
	<span class="n">aty_set_crtc</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">saved_crtc</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">set_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">saved_pll</span><span class="p">);</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_ATY_BACKLIGHT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">M64_HAS</span><span class="p">(</span><span class="n">MOBIL_BUS</span><span class="p">))</span>
		<span class="n">aty_bl_exit</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bl_dev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_aper</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_aper</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_aper</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef __sparc__</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ati_regbase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sprite</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sprite</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef __sparc__</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmap_map</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_start</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">aux_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">res_start</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">res_start</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res_size</span><span class="p">);</span>

	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">atyfb_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reboot_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reboot_info</span> <span class="o">==</span> <span class="n">info</span><span class="p">)</span>
		<span class="n">reboot_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reboot_lock</span><span class="p">);</span>

	<span class="n">atyfb_remove</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">atyfb_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_ATY_GX</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GX</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64CX</span><span class="p">)</span> <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_GX */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_FB_ATY_CT</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64CT</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64ET</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64LT</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64VT</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GT</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64VU</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GU</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64LG</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64VV</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GV</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GW</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GY</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GZ</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GB</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GD</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GI</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GP</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GQ</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64LB</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64LD</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64LI</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64LP</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64LQ</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GM</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GN</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GO</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GL</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GR</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64GS</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64LM</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64LN</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64LR</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_CHIP_MACH64LS</span><span class="p">)</span> <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY_CT */</span><span class="cp"></span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">atyfb_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">atyfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atyfb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">atyfb_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">atyfb_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">atyfb_pci_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">atyfb_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">atyfb_pci_resume</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">atyfb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;noaccel&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">noaccel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nomtrr&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nomtrr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vram:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">vram</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;pll:&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">pll</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mclk:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">mclk</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;xclk:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">xclk</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;comp_sync:&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
			<span class="n">comp_sync</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;backlight:&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
			<span class="n">backlight</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PPC</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vmode:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vmode</span> <span class="o">=</span>
			    <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">vmode</span> <span class="o">&lt;=</span> <span class="n">VMODE_MAX</span><span class="p">)</span>
				<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">vmode</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;cmode:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmode</span> <span class="o">=</span>
			    <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">15</span>:
			<span class="k">case</span> <span class="mi">16</span>:
				<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">24</span>:
			<span class="k">case</span> <span class="mi">32</span>:
				<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATARI</span>
		<span class="cm">/*</span>
<span class="cm">		 * Why do we need this silly Mach64 argument?</span>
<span class="cm">		 * We are already here because of mach64= so its redundant.</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_ATARI</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;Mach64:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">m64_num</span><span class="p">;</span>
			<span class="k">static</span> <span class="kt">char</span> <span class="n">mach64_str</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">mach64_str</span><span class="p">,</span> <span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mach64_str</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">store_video_par</span><span class="p">(</span><span class="n">mach64_str</span><span class="p">,</span> <span class="n">m64_num</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">m64_num</span><span class="o">++</span><span class="p">;</span>
				<span class="n">mach64_count</span> <span class="o">=</span> <span class="n">m64_num</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">else</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="cm">/*  MODULE  */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atyfb_reboot_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atyfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">!=</span> <span class="n">SYS_RESTART</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reboot_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reboot_info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">reboot_info</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">reboot_info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * HP OmniBook 500&#39;s BIOS doesn&#39;t like the state of the</span>
<span class="cm">	 * hardware after atyfb has been used. Restore the hardware</span>
<span class="cm">	 * to the original state to allow successful reboots.</span>
<span class="cm">	 */</span>
	<span class="n">aty_set_crtc</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">saved_crtc</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_ops</span><span class="o">-&gt;</span><span class="n">set_pll</span><span class="p">(</span><span class="n">reboot_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">saved_pll</span><span class="p">);</span>

	<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">reboot_info</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reboot_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">atyfb_reboot_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">atyfb_reboot_notify</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">atyfb_reboot_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HP OmniBook 500&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;HP OmniBook PC&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_VERSION</span><span class="p">,</span> <span class="s">&quot;HP OmniBook 500 FA&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">atyfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">err2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;atyfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">atyfb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">err1</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atyfb_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATARI</span>
	<span class="n">err2</span> <span class="o">=</span> <span class="n">atyfb_atari_probe</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err1</span> <span class="o">&amp;&amp;</span> <span class="n">err2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">atyfb_reboot_ids</span><span class="p">))</span>
		<span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atyfb_reboot_notifier</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">atyfb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">atyfb_reboot_ids</span><span class="p">))</span>
		<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atyfb_reboot_notifier</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atyfb_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">atyfb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">atyfb_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;FBDev driver for ATI Mach64 cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="s">&quot;bool: disable acceleration&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vram</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vram</span><span class="p">,</span> <span class="s">&quot;int: override size of video ram&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pll</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pll</span><span class="p">,</span> <span class="s">&quot;int: override video clock&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mclk</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mclk</span><span class="p">,</span> <span class="s">&quot;int: override memory clock&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">xclk</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">xclk</span><span class="p">,</span> <span class="s">&quot;int: override accelerated engine clock&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">comp_sync</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">comp_sync</span><span class="p">,</span> <span class="s">&quot;Set composite sync signal to low (0) or high (1)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;Specify resolution as </span><span class="se">\&quot;</span><span class="s">&lt;xres&gt;x&lt;yres&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]</span><span class="se">\&quot;</span><span class="s"> &quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nomtrr</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nomtrr</span><span class="p">,</span> <span class="s">&quot;bool: disable use of MTRR registers&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
