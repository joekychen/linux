<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › aty › aty128fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>aty128fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: aty128fb.c,v 1.1.1.1.36.1 1999/12/11 09:03:05 Exp $</span>
<span class="cm"> *  linux/drivers/video/aty128fb.c -- Frame buffer device for ATI Rage128</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1999-2003, Brad Douglas &lt;brad@neruo.com&gt;</span>
<span class="cm"> *  Copyright (C) 1999, Anthony Tong &lt;atong@uiuc.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *                Ani Joshi / Jeff Garzik</span>
<span class="cm"> *                      - Code cleanup</span>
<span class="cm"> *</span>
<span class="cm"> *                Michel Danzer &lt;michdaen@iiic.ethz.ch&gt;</span>
<span class="cm"> *                      - 15/16 bit cleanup</span>
<span class="cm"> *                      - fix panning</span>
<span class="cm"> *</span>
<span class="cm"> *                Benjamin Herrenschmidt</span>
<span class="cm"> *                      - pmac-specific PM stuff</span>
<span class="cm"> *			- various fixes &amp; cleanups</span>
<span class="cm"> *</span>
<span class="cm"> *                Andreas Hundt &lt;andi@convergence.de&gt;</span>
<span class="cm"> *                      - FB_ACTIVATE fixes</span>
<span class="cm"> *</span>
<span class="cm"> *		  Paul Mackerras &lt;paulus@samba.org&gt;</span>
<span class="cm"> *			- Convert to new framebuffer API,</span>
<span class="cm"> *			  fix colormap setting at 16 bits/pixel (565)</span>
<span class="cm"> *</span>
<span class="cm"> *		  Paul Mundt </span>
<span class="cm"> *		  	- PCI hotplug</span>
<span class="cm"> *</span>
<span class="cm"> *		  Jon Smirl &lt;jonsmirl@yahoo.com&gt;</span>
<span class="cm"> * 			- PCI ID update</span>
<span class="cm"> * 			- replace ROM BIOS search</span>
<span class="cm"> *</span>
<span class="cm"> *  Based off of Geert&#39;s atyfb.c and vfb.c.</span>
<span class="cm"> *</span>
<span class="cm"> *  TODO:</span>
<span class="cm"> *		- monitor sensing (DDC)</span>
<span class="cm"> *              - virtual display</span>
<span class="cm"> *		- other platform support (only ppc/x86 supported)</span>
<span class="cm"> *		- hardware cursor support</span>
<span class="cm"> *</span>
<span class="cm"> *    Please cc: your patches to brad@neruo.com.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * A special note of gratitude to ATI&#39;s devrel for providing documentation,</span>
<span class="cm"> * example code and hardware. Thanks Nitya.	-atong and brad</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_feature.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#include &quot;../macmodes.h&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PMAC_BACKLIGHT</span>
<span class="cp">#include &lt;asm/backlight.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BOOTX_TEXT</span>
<span class="cp">#include &lt;asm/btext.h&gt;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_BOOTX_TEXT */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;video/aty128.h&gt;</span>

<span class="cm">/* Debug flag */</span>
<span class="cp">#undef DEBUG</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DBG(fmt, args...)		printk(KERN_DEBUG &quot;aty128fb: %s &quot; fmt, __func__, ##args);</span>
<span class="cp">#else</span>
<span class="cp">#define DBG(fmt, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_PPC_PMAC</span>
<span class="cm">/* default mode */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">default_var</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 640x480, 60 Hz, Non-Interlaced (25.175 MHz dotclock) */</span>
	<span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">39722</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span>
<span class="p">};</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>
<span class="cm">/* default to 1024x768 at 75Hz on PPC - this will work</span>
<span class="cm"> * on the iMac, the usual 640x480 @ 60Hz doesn&#39;t. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">default_var</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 1024x768, 75 Hz, Non-Interlaced (78.75 MHz dotclock) */</span>
	<span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12699</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">FB_SYNC_HOR_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
	<span class="n">FB_VMODE_NONINTERLACED</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>

<span class="cm">/* default modedb mode */</span>
<span class="cm">/* 640x480, 60 Hz, Non-Interlaced (25.172 MHz dotclock) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">defaultmode</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">refresh</span> <span class="o">=</span>	<span class="mi">60</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres</span> <span class="o">=</span>		<span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span> <span class="o">=</span>		<span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span>	<span class="mi">39722</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span> <span class="o">=</span>	<span class="mi">48</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span> <span class="o">=</span>	<span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span> <span class="o">=</span>	<span class="mi">33</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span> <span class="o">=</span>	<span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsync_len</span> <span class="o">=</span>	<span class="mi">96</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span> <span class="o">=</span>	<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vmode</span> <span class="o">=</span>	<span class="n">FB_VMODE_NONINTERLACED</span>
<span class="p">};</span>

<span class="cm">/* Chip generations */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">rage_128</span><span class="p">,</span>
	<span class="n">rage_128_pci</span><span class="p">,</span>
	<span class="n">rage_128_pro</span><span class="p">,</span>
	<span class="n">rage_128_pro_pci</span><span class="p">,</span>
	<span class="n">rage_M3</span><span class="p">,</span>
	<span class="n">rage_M3_pci</span><span class="p">,</span>
	<span class="n">rage_M4</span><span class="p">,</span>
	<span class="n">rage_128_ultra</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Must match above enum */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">r128_family</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;AGP&quot;</span><span class="p">,</span>
	<span class="s">&quot;PCI&quot;</span><span class="p">,</span>
	<span class="s">&quot;PRO AGP&quot;</span><span class="p">,</span>
	<span class="s">&quot;PRO PCI&quot;</span><span class="p">,</span>
	<span class="s">&quot;M3 AGP&quot;</span><span class="p">,</span>
	<span class="s">&quot;M3 PCI&quot;</span><span class="p">,</span>
	<span class="s">&quot;M4 AGP&quot;</span><span class="p">,</span>
	<span class="s">&quot;Ultra AGP&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * PCI driver prototypes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
                               <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aty128_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128_do_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="cm">/* supported Rage128 chipsets */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">aty128_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_LE</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_M3_pci</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_LF</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_M3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_MF</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_M4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_ML</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_M4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PA</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PB</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PC</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PD</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro_pci</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PE</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PF</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PG</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PH</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PI</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PJ</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PK</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PL</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PM</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PN</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PO</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PP</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro_pci</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PQ</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PR</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro_pci</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PS</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PT</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PU</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PV</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PW</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_PX</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pro</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_RE</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pci</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_RF</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_RG</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_RK</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pci</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_RL</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_SE</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_SF</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_pci</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_SG</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_SH</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_SK</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_SL</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_SM</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_SN</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_TF</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_ultra</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_TL</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_ultra</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_TR</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_ultra</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_TS</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_ultra</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_TT</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_ultra</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATI_RAGE128_TU</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rage_128_ultra</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">aty128_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">aty128fb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;aty128fb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">aty128_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">aty128_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">aty128_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">aty128_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">aty128_pci_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* packed BIOS settings */</span>
<span class="cp">#ifndef CONFIG_PPC</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">clock_chip_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">struct_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">accelerator_entry</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">VGA_entry</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">VGA_table_offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">POST_table_offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">XCLK</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">MCLK</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_PLL_blocks</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">size_PLL_blocks</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">PCLK_ref_freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">PCLK_ref_divider</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">PCLK_min_freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">PCLK_max_freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">MCLK_ref_freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">MCLK_ref_divider</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">MCLK_min_freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">MCLK_max_freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">XCLK_ref_freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">XCLK_ref_divider</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">XCLK_min_freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">XCLK_max_freq</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">PLL_BLOCK</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_PPC */</span><span class="cp"></span>

<span class="cm">/* onboard memory information */</span>
<span class="k">struct</span> <span class="n">aty128_meminfo</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">ML</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">MB</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">Trcd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">Trp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">Twr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">CL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">Tr2w</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">LoopLatency</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">DspOn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">Rloop</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* various memory configurations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_meminfo</span> <span class="n">sdr_128</span>   <span class="o">=</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;128-bit SDR SGRAM (1:1)&quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_meminfo</span> <span class="n">sdr_64</span>    <span class="o">=</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="s">&quot;64-bit SDR SGRAM (1:1)&quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_meminfo</span> <span class="n">sdr_sgram</span> <span class="o">=</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;64-bit SDR SGRAM (2:1)&quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_meminfo</span> <span class="n">ddr_sgram</span> <span class="o">=</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;64-bit DDR SGRAM&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">aty128fb_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="s">&quot;ATY Rage128&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span>		<span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpanstep</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmio_len</span>	<span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span>		<span class="o">=</span> <span class="n">FB_ACCEL_ATI_RAGE128</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_vmode</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="n">VMODE_1024_768_60</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_cmode</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="n">CMODE_8</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">default_crt_on</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_lcd_on</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">mtrr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PMAC_BACKLIGHT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">backlight</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">backlight</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* PLL constants */</span>
<span class="k">struct</span> <span class="n">aty128_constants</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">ref_clk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ppll_min</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ppll_max</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ref_divider</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xclk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fifo_width</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fifo_depth</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">aty128_crtc</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">gen_cntl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">h_total</span><span class="p">,</span> <span class="n">h_sync_strt_wid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v_total</span><span class="p">,</span> <span class="n">v_sync_strt_wid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pitch</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset_cntl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xoffset</span><span class="p">,</span> <span class="n">yoffset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">depth</span><span class="p">,</span> <span class="n">bpp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">aty128_pll</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">post_divider</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">feedback_divider</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vclk</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">aty128_ddafifo</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">dda_config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dda_on_off</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* register values for a specific mode */</span>
<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">aty128_crtc</span> <span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aty128_pll</span> <span class="n">pll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aty128_ddafifo</span> <span class="n">fifo_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">accel_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aty128_constants</span> <span class="n">constants</span><span class="p">;</span>  <span class="cm">/* PLL and others      */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regbase</span><span class="p">;</span>              <span class="cm">/* remapped mmio       */</span>
	<span class="n">u32</span> <span class="n">vram_size</span><span class="p">;</span>                      <span class="cm">/* onboard video ram   */</span>
	<span class="kt">int</span> <span class="n">chip_gen</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_meminfo</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>   <span class="cm">/* onboard mem info    */</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">struct</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">vram</span><span class="p">;</span> <span class="kt">int</span> <span class="n">vram_valid</span><span class="p">;</span> <span class="p">}</span> <span class="n">mtrr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">blitter_may_be_busy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_slots</span><span class="p">;</span>                 <span class="cm">/* free slots in FIFO (64 max) */</span>

	<span class="kt">int</span>	<span class="n">pm_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">crt_on</span><span class="p">,</span> <span class="n">lcd_on</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">asleep</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">lock_blank</span><span class="p">;</span>

	<span class="n">u8</span>	<span class="n">red</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>		<span class="cm">/* see aty128fb_setcolreg */</span>
	<span class="n">u8</span>	<span class="n">green</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">blue</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u32</span>	<span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>	<span class="cm">/* used for TRUECOLOR */</span>
<span class="p">};</span>


<span class="cp">#define round_div(n, d) ((n+(d/2))/d)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128fb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128fb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			      <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128fb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128fb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128fb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     *  Internal routines</span>
<span class="cm">     */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128_encode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
                             <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aty128_decode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
                             <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void __devinit aty128_get_pllinfo(struct aty128fb_par *par,</span>
<span class="c">				      void __iomem *bios);</span>
<span class="c">static void __devinit __iomem *aty128_map_ROM(struct pci_dev *pdev, const struct aty128fb_par *par);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aty128_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aty128_init_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aty128_reset_engine</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aty128_flush_pixel_cache</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">do_wait_for_fifo</span><span class="p">(</span><span class="n">u16</span> <span class="n">entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">wait_for_fifo</span><span class="p">(</span><span class="n">u16</span> <span class="n">entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">wait_for_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">depth_to_dst</span><span class="p">(</span><span class="n">u32</span> <span class="n">depth</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_ATY128_BACKLIGHT</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aty128_bl_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">power</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#define BIOS_IN8(v)  	(readb(bios + (v)))</span>
<span class="cp">#define BIOS_IN16(v) 	(readb(bios + (v)) | \</span>
<span class="cp">			  (readb(bios + (v) + 1) &lt;&lt; 8))</span>
<span class="cp">#define BIOS_IN32(v) 	(readb(bios + (v)) | \</span>
<span class="cp">			  (readb(bios + (v) + 1) &lt;&lt; 8) | \</span>
<span class="cp">			  (readb(bios + (v) + 2) &lt;&lt; 16) | \</span>
<span class="cp">			  (readb(bios + (v) + 3) &lt;&lt; 24))</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">aty128fb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">aty128fb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">aty128fb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">aty128fb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">aty128fb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">aty128fb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span>	<span class="o">=</span> <span class="n">aty128fb_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_sync</span>	<span class="o">=</span> <span class="n">aty128fb_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
<span class="p">};</span>

    <span class="cm">/*</span>
<span class="cm">     * Functions to read from/write to the mmio registers</span>
<span class="cm">     *	- endian conversions may possibly be avoided by</span>
<span class="cm">     *    using the other register aperture. TODO.</span>
<span class="cm">     */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_aty_ld_le32</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regindex</span><span class="p">,</span> 
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">+</span> <span class="n">regindex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_aty_st_le32</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regindex</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> 
				<span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">+</span> <span class="n">regindex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">_aty_ld_8</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regindex</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">+</span> <span class="n">regindex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_aty_st_8</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regindex</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">+</span> <span class="n">regindex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define aty_ld_le32(regindex)		_aty_ld_le32(regindex, par)</span>
<span class="cp">#define aty_st_le32(regindex, val)	_aty_st_le32(regindex, val, par)</span>
<span class="cp">#define aty_ld_8(regindex)		_aty_ld_8(regindex, par)</span>
<span class="cp">#define aty_st_8(regindex, val)		_aty_st_8(regindex, val, par)</span>

    <span class="cm">/*</span>
<span class="cm">     * Functions to read from/write to the pll registers</span>
<span class="cm">     */</span>

<span class="cp">#define aty_ld_pll(pll_index)		_aty_ld_pll(pll_index, par)</span>
<span class="cp">#define aty_st_pll(pll_index, val)	_aty_st_pll(pll_index, val, par)</span>


<span class="k">static</span> <span class="n">u32</span> <span class="nf">_aty_ld_pll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pll_index</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>       
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">pll_index</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span><span class="p">);</span>
<span class="p">}</span>

    
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_aty_st_pll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pll_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="p">(</span><span class="n">pll_index</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">|</span> <span class="n">PLL_WR_EN</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CLOCK_CNTL_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* return true when the PLL has completed an atomic update */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty_pll_readupdate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">aty_ld_pll</span><span class="p">(</span><span class="n">PPLL_REF_DIV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PPLL_ATOMIC_UPDATE_R</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty_pll_wait_readupdate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span> <span class="c1">// should be more than enough</span>
	<span class="kt">int</span> <span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aty_pll_readupdate</span><span class="p">(</span><span class="n">par</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>	<span class="cm">/* reset engine?? */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aty128fb: PLL write timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* tell PLL to update */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty_pll_writeupdate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aty_pll_wait_readupdate</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">PPLL_REF_DIV</span><span class="p">,</span>
		   <span class="n">aty_ld_pll</span><span class="p">(</span><span class="n">PPLL_REF_DIV</span><span class="p">)</span> <span class="o">|</span> <span class="n">PPLL_ATOMIC_UPDATE_W</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* write to the scratch register to test r/w functionality */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">register_test</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">BIOS_0_SCRATCH</span><span class="p">);</span>

	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">BIOS_0_SCRATCH</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">BIOS_0_SCRATCH</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x55555555</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">BIOS_0_SCRATCH</span><span class="p">,</span> <span class="mh">0xAAAAAAAA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">BIOS_0_SCRATCH</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xAAAAAAAA</span><span class="p">)</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
	<span class="p">}</span>

	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">BIOS_0_SCRATCH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>	<span class="c1">// restore value</span>
	<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Accelerator engine functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_wait_for_fifo</span><span class="p">(</span><span class="n">u16</span> <span class="n">entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">fifo_slots</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">GUI_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fifo_slots</span> <span class="o">&gt;=</span> <span class="n">entries</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">aty128_reset_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_for_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">do_wait_for_fifo</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">GUI_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">aty128_flush_pixel_cache</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">blitter_may_be_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">aty128_reset_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_for_fifo</span><span class="p">(</span><span class="n">u16</span> <span class="n">entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fifo_slots</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">)</span>
		<span class="n">do_wait_for_fifo</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">fifo_slots</span> <span class="o">-=</span> <span class="n">entries</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_flush_pixel_cache</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">PC_NGUI_CTLSTAT</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x00ff</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x00ff</span><span class="p">;</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">PC_NGUI_CTLSTAT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">PC_NGUI_CTLSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PC_BUSY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_reset_engine</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gen_reset_cntl</span><span class="p">,</span> <span class="n">clock_cntl_index</span><span class="p">,</span> <span class="n">mclk_cntl</span><span class="p">;</span>

	<span class="n">aty128_flush_pixel_cache</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">clock_cntl_index</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">);</span>
	<span class="n">mclk_cntl</span> <span class="o">=</span> <span class="n">aty_ld_pll</span><span class="p">(</span><span class="n">MCLK_CNTL</span><span class="p">);</span>

	<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">MCLK_CNTL</span><span class="p">,</span> <span class="n">mclk_cntl</span> <span class="o">|</span> <span class="mh">0x00030000</span><span class="p">);</span>

	<span class="n">gen_reset_cntl</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">GEN_RESET_CNTL</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GEN_RESET_CNTL</span><span class="p">,</span> <span class="n">gen_reset_cntl</span> <span class="o">|</span> <span class="n">SOFT_RESET_GUI</span><span class="p">);</span>
	<span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">GEN_RESET_CNTL</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GEN_RESET_CNTL</span><span class="p">,</span> <span class="n">gen_reset_cntl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SOFT_RESET_GUI</span><span class="p">));</span>
	<span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">GEN_RESET_CNTL</span><span class="p">);</span>

	<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">MCLK_CNTL</span><span class="p">,</span> <span class="n">mclk_cntl</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">clock_cntl_index</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GEN_RESET_CNTL</span><span class="p">,</span> <span class="n">gen_reset_cntl</span><span class="p">);</span>

	<span class="cm">/* use old pio mode */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">PM4_BUFFER_CNTL</span><span class="p">,</span> <span class="n">PM4_BUFFER_CNTL_NONPM4</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;engine reset&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_init_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pitch_value</span><span class="p">;</span>

	<span class="n">wait_for_idle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="cm">/* 3D scaler not spoken here */</span>
	<span class="n">wait_for_fifo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">SCALE_3D_CNTL</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">aty128_reset_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">pitch_value</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">pitch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pitch_value</span> <span class="o">=</span> <span class="n">pitch_value</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_for_fifo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="cm">/* setup engine offset registers */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DEFAULT_OFFSET</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="cm">/* setup engine pitch registers */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DEFAULT_PITCH</span><span class="p">,</span> <span class="n">pitch_value</span><span class="p">);</span>

	<span class="cm">/* set the default scissor register to max dimensions */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DEFAULT_SC_BOTTOM_RIGHT</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1FFF</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1FFF</span><span class="p">);</span>

	<span class="cm">/* set the drawing controls registers */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DP_GUI_MASTER_CNTL</span><span class="p">,</span>
		    <span class="n">GMC_SRC_PITCH_OFFSET_DEFAULT</span>		<span class="o">|</span>
		    <span class="n">GMC_DST_PITCH_OFFSET_DEFAULT</span>		<span class="o">|</span>
		    <span class="n">GMC_SRC_CLIP_DEFAULT</span>			<span class="o">|</span>
		    <span class="n">GMC_DST_CLIP_DEFAULT</span>			<span class="o">|</span>
		    <span class="n">GMC_BRUSH_SOLIDCOLOR</span>			<span class="o">|</span>
		    <span class="p">(</span><span class="n">depth_to_dst</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>	<span class="o">|</span>
		    <span class="n">GMC_SRC_DSTCOLOR</span>			<span class="o">|</span>
		    <span class="n">GMC_BYTE_ORDER_MSB_TO_LSB</span>		<span class="o">|</span>
		    <span class="n">GMC_DP_CONVERSION_TEMP_6500</span>		<span class="o">|</span>
		    <span class="n">ROP3_PATCOPY</span>				<span class="o">|</span>
		    <span class="n">GMC_DP_SRC_RECT</span>				<span class="o">|</span>
		    <span class="n">GMC_3D_FCN_EN_CLR</span>			<span class="o">|</span>
		    <span class="n">GMC_DST_CLR_CMP_FCN_CLEAR</span>		<span class="o">|</span>
		    <span class="n">GMC_AUX_CLIP_CLEAR</span>			<span class="o">|</span>
		    <span class="n">GMC_WRITE_MASK_SET</span><span class="p">);</span>

	<span class="n">wait_for_fifo</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="cm">/* clear the line drawing registers */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DST_BRES_ERR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DST_BRES_INC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DST_BRES_DEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* set brush color registers */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DP_BRUSH_FRGD_CLR</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span> <span class="cm">/* white */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DP_BRUSH_BKGD_CLR</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span> <span class="cm">/* black */</span>

	<span class="cm">/* set source color registers */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DP_SRC_FRGD_CLR</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>   <span class="cm">/* white */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DP_SRC_BKGD_CLR</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>   <span class="cm">/* black */</span>

	<span class="cm">/* default write mask */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DP_WRITE_MASK</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

	<span class="cm">/* Wait for all the writes to be completed before returning */</span>
	<span class="n">wait_for_idle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* convert depth values to their register representation */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">depth_to_dst</span><span class="p">(</span><span class="n">u32</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DST_8BPP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DST_15BPP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DST_16BPP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">24</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DST_24BPP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DST_32BPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PLL informations retreival</span>
<span class="cm"> */</span>


<span class="cp">#ifndef __sparc__</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">aty128_map_ROM</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dptr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rom_type</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bios</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rom_size</span><span class="p">;</span>

    	<span class="cm">/* Fix from ATI for problem with Rage128 hardware not leaving ROM enabled */</span>
    	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">RAGE128_MPP_TB_CONFIG</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="mh">0x00ffffffu</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x04</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">RAGE128_MPP_TB_CONFIG</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">RAGE128_MPP_TB_CONFIG</span><span class="p">);</span>

	<span class="n">bios</span> <span class="o">=</span> <span class="n">pci_map_rom</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rom_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bios</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: ROM failed to map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Very simple test to make sure it appeared */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BIOS_IN16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xaa55</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aty128fb: Invalid ROM signature %x should &quot;</span>
			<span class="s">&quot; be 0xaa55</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BIOS_IN16</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Look for the PCI data to check the ROM type */</span>
	<span class="n">dptr</span> <span class="o">=</span> <span class="n">BIOS_IN16</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>

	<span class="cm">/* Check the PCI data signature. If it&#39;s wrong, we still assume a normal x86 ROM</span>
<span class="cm">	 * for now, until I&#39;ve verified this works everywhere. The goal here is more</span>
<span class="cm">	 * to phase out Open Firmware images.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Currently, we only look at the first PCI data, we could iteratre and deal with</span>
<span class="cm">	 * them all, and we should use fb_bios_start relative to start of image and not</span>
<span class="cm">	 * relative start of ROM, but so far, I never found a dual-image ATI card</span>
<span class="cm">	 *</span>
<span class="cm">	 * typedef struct {</span>
<span class="cm">	 * 	u32	signature;	+ 0x00</span>
<span class="cm">	 * 	u16	vendor;		+ 0x04</span>
<span class="cm">	 * 	u16	device;		+ 0x06</span>
<span class="cm">	 * 	u16	reserved_1;	+ 0x08</span>
<span class="cm">	 * 	u16	dlen;		+ 0x0a</span>
<span class="cm">	 * 	u8	drevision;	+ 0x0c</span>
<span class="cm">	 * 	u8	class_hi;	+ 0x0d</span>
<span class="cm">	 * 	u16	class_lo;	+ 0x0e</span>
<span class="cm">	 * 	u16	ilen;		+ 0x10</span>
<span class="cm">	 * 	u16	irevision;	+ 0x12</span>
<span class="cm">	 * 	u8	type;		+ 0x14</span>
<span class="cm">	 * 	u8	indicator;	+ 0x15</span>
<span class="cm">	 * 	u16	reserved_2;	+ 0x16</span>
<span class="cm">	 * } pci_data_t;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BIOS_IN32</span><span class="p">(</span><span class="n">dptr</span><span class="p">)</span> <span class="o">!=</span>  <span class="p">((</span><span class="sc">&#39;R&#39;</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="sc">&#39;I&#39;</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="sc">&#39;C&#39;</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="sc">&#39;P&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aty128fb: PCI DATA signature in ROM incorrect: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">BIOS_IN32</span><span class="p">(</span><span class="n">dptr</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">anyway</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rom_type</span> <span class="o">=</span> <span class="n">BIOS_IN8</span><span class="p">(</span><span class="n">dptr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">rom_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aty128fb: Found Intel x86 BIOS ROM Image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aty128fb: Found Open Firmware ROM Image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aty128fb: Found HP PA-RISC ROM Image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aty128fb: Found unknown type %d ROM Image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rom_type</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">anyway:</span>
	<span class="k">return</span> <span class="n">bios</span><span class="p">;</span>

 <span class="nl">failed:</span>
	<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bios</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">aty128_get_pllinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bios_hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bios_pll</span><span class="p">;</span>

	<span class="n">bios_hdr</span> <span class="o">=</span> <span class="n">BIOS_IN16</span><span class="p">(</span><span class="mh">0x48</span><span class="p">);</span>
	<span class="n">bios_pll</span> <span class="o">=</span> <span class="n">BIOS_IN16</span><span class="p">(</span><span class="n">bios_hdr</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>
	
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ppll_max</span> <span class="o">=</span> <span class="n">BIOS_IN32</span><span class="p">(</span><span class="n">bios_pll</span> <span class="o">+</span> <span class="mh">0x16</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ppll_min</span> <span class="o">=</span> <span class="n">BIOS_IN32</span><span class="p">(</span><span class="n">bios_pll</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="n">BIOS_IN16</span><span class="p">(</span><span class="n">bios_pll</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_divider</span> <span class="o">=</span> <span class="n">BIOS_IN16</span><span class="p">(</span><span class="n">bios_pll</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_clk</span> <span class="o">=</span> <span class="n">BIOS_IN16</span><span class="p">(</span><span class="n">bios_pll</span> <span class="o">+</span> <span class="mh">0x0e</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;ppll_max %d ppll_min %d xclk %d ref_divider %d ref clock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ppll_max</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ppll_min</span><span class="p">,</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">xclk</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_divider</span><span class="p">,</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_clk</span><span class="p">);</span>

<span class="p">}</span>           

<span class="cp">#ifdef CONFIG_X86</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span>  <span class="n">__devinit</span> <span class="nf">aty128_find_mem_vbios</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* I simplified this code as we used to miss the signatures in</span>
<span class="cm">	 * a lot of case. It&#39;s now closer to XFree, we just don&#39;t check</span>
<span class="cm">	 * for signatures at all... Something better will have to be done</span>
<span class="cm">	 * if we end up having conflicts</span>
<span class="cm">	 */</span>
        <span class="n">u32</span>  <span class="n">segstart</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rom_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                                                
        <span class="k">for</span> <span class="p">(</span><span class="n">segstart</span><span class="o">=</span><span class="mh">0x000c0000</span><span class="p">;</span> <span class="n">segstart</span><span class="o">&lt;</span><span class="mh">0x000f0000</span><span class="p">;</span> <span class="n">segstart</span><span class="o">+=</span><span class="mh">0x00001000</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">rom_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">segstart</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rom_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">rom_base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x55</span> <span class="o">&amp;&amp;</span> <span class="n">readb</span><span class="p">(</span><span class="n">rom_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa</span><span class="p">)</span>
	                <span class="k">break</span><span class="p">;</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">rom_base</span><span class="p">);</span>
		<span class="n">rom_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">return</span> <span class="n">rom_base</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* ndef(__sparc__) */</span><span class="cp"></span>

<span class="cm">/* fill in known card constants if pll_block is not available */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">aty128_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_OF</span>
	<span class="cm">/* instead of a table lookup, assume OF has properly</span>
<span class="cm">	 * setup the PLL registers and use their values</span>
<span class="cm">	 * to set the XCLK values and reference divider values */</span>

	<span class="n">u32</span> <span class="n">x_mpll_ref_fb_div</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xclk_cntl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">M</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">PostDivSet</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">12</span> <span class="p">};</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_clk</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_clk</span> <span class="o">=</span> <span class="mi">2950</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC_OF</span>
	<span class="n">x_mpll_ref_fb_div</span> <span class="o">=</span> <span class="n">aty_ld_pll</span><span class="p">(</span><span class="n">X_MPLL_REF_FB_DIV</span><span class="p">);</span>
	<span class="n">xclk_cntl</span> <span class="o">=</span> <span class="n">aty_ld_pll</span><span class="p">(</span><span class="n">XCLK_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">Nx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_mpll_ref_fb_div</span> <span class="o">&amp;</span> <span class="mh">0x00ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">M</span>  <span class="o">=</span> <span class="n">x_mpll_ref_fb_div</span> <span class="o">&amp;</span> <span class="mh">0x0000ff</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="n">round_div</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Nx</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_clk</span><span class="p">),</span>
					<span class="p">(</span><span class="n">M</span> <span class="o">*</span> <span class="n">PostDivSet</span><span class="p">[</span><span class="n">xclk_cntl</span><span class="p">]));</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_divider</span> <span class="o">=</span>
		<span class="n">aty_ld_pll</span><span class="p">(</span><span class="n">PPLL_REF_DIV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PPLL_REF_DIV_MASK</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_divider</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_divider</span> <span class="o">=</span> <span class="mh">0x3b</span><span class="p">;</span>

		<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">X_MPLL_REF_FB_DIV</span><span class="p">,</span> <span class="mh">0x004c4c1e</span><span class="p">);</span>
		<span class="n">aty_pll_writeupdate</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">PPLL_REF_DIV</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_divider</span><span class="p">);</span>
	<span class="n">aty_pll_writeupdate</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="cm">/* from documentation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ppll_min</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ppll_min</span> <span class="o">=</span> <span class="mi">12500</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ppll_max</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ppll_max</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">;</span>    <span class="cm">/* 23000 on some cards? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">xclk</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">xclk</span> <span class="o">=</span> <span class="mh">0x1d4d</span><span class="p">;</span>	     <span class="cm">/* same as mclk */</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">fifo_width</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">fifo_depth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">MEM_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdr_128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdr_sgram</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ddr_sgram</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdr_sgram</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * CRTC programming</span>
<span class="cm"> */</span>

<span class="cm">/* Program the CRTC registers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_set_crtc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_GEN_CNTL</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_H_TOTAL_DISP</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_total</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_H_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_V_TOTAL_DISP</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_total</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_V_SYNC_STRT_WID</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_PITCH</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_OFFSET</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_OFFSET_CNTL</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">offset_cntl</span><span class="p">);</span>
	<span class="cm">/* Disable ATOMIC updating.  Is this the right place? */</span>
	<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">PPLL_CNTL</span><span class="p">,</span> <span class="n">aty_ld_pll</span><span class="p">(</span><span class="n">PPLL_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x00030000</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_var_to_crtc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">aty128_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">,</span> <span class="n">xoffset</span><span class="p">,</span> <span class="n">yoffset</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">hslen</span><span class="p">,</span> <span class="n">vslen</span><span class="p">,</span> <span class="n">sync</span><span class="p">,</span> <span class="n">vmode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">h_total</span><span class="p">,</span> <span class="n">h_disp</span><span class="p">,</span> <span class="n">h_sync_strt</span><span class="p">,</span> <span class="n">h_sync_wid</span><span class="p">,</span> <span class="n">h_sync_pol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v_total</span><span class="p">,</span> <span class="n">v_disp</span><span class="p">,</span> <span class="n">v_sync_strt</span><span class="p">,</span> <span class="n">v_sync_wid</span><span class="p">,</span> <span class="n">v_sync_pol</span><span class="p">,</span> <span class="n">c_sync</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">depth</span><span class="p">,</span> <span class="n">bytpp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode_bytpp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">};</span>

	<span class="cm">/* input */</span>
	<span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">vxres</span>   <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span>   <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="n">bpp</span>   <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">left</span>  <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">upper</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">lower</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">hslen</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">vslen</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">sync</span>  <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">;</span>
	<span class="n">vmode</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span>

	<span class="cm">/* check for mode eligibility</span>
<span class="cm">	 * accept only non interlaced modes */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* convert (and round up) and validate */</span>
	<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">xoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">xoffset</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vxres</span> <span class="o">&lt;</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">)</span>
		<span class="n">vxres</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vyres</span> <span class="o">&lt;</span> <span class="n">yres</span> <span class="o">+</span> <span class="n">yoffset</span><span class="p">)</span>
		<span class="n">vyres</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">+</span> <span class="n">yoffset</span><span class="p">;</span>

	<span class="cm">/* convert depth into ATI register depth */</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">depth_to_dst</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: Invalid depth or RGBA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* convert register depth to bytes per pixel */</span>
	<span class="n">bytpp</span> <span class="o">=</span> <span class="n">mode_bytpp</span><span class="p">[</span><span class="n">dst</span><span class="p">];</span>

	<span class="cm">/* make sure there is enough video ram for the mode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">vxres</span> <span class="o">*</span> <span class="n">vyres</span> <span class="o">*</span> <span class="n">bytpp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: Not enough memory for mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h_disp</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">h_total</span> <span class="o">=</span> <span class="p">(((</span><span class="n">xres</span> <span class="o">+</span> <span class="n">right</span> <span class="o">+</span> <span class="n">hslen</span> <span class="o">+</span> <span class="n">left</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFL</span><span class="p">;</span>

	<span class="n">v_disp</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v_total</span> <span class="o">=</span> <span class="p">(</span><span class="n">yres</span> <span class="o">+</span> <span class="n">upper</span> <span class="o">+</span> <span class="n">vslen</span> <span class="o">+</span> <span class="n">lower</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFL</span><span class="p">;</span>

	<span class="cm">/* check to make sure h_total and v_total are in range */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">h_total</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x1ff</span> <span class="o">||</span> <span class="p">(</span><span class="n">v_total</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x7FF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: invalid width ranges</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h_sync_wid</span> <span class="o">=</span> <span class="p">(</span><span class="n">hslen</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_sync_wid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">h_sync_wid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h_sync_wid</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span>        <span class="cm">/* 0x3f = max hwidth */</span>
		<span class="n">h_sync_wid</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="n">h_sync_strt</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_disp</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">right</span><span class="p">;</span>

	<span class="n">v_sync_wid</span> <span class="o">=</span> <span class="n">vslen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v_sync_wid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">v_sync_wid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v_sync_wid</span> <span class="o">&gt;</span> <span class="mh">0x1f</span><span class="p">)</span>        <span class="cm">/* 0x1f = max vwidth */</span>
		<span class="n">v_sync_wid</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
    
	<span class="n">v_sync_strt</span> <span class="o">=</span> <span class="n">v_disp</span> <span class="o">+</span> <span class="n">lower</span><span class="p">;</span>

	<span class="n">h_sync_pol</span> <span class="o">=</span> <span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v_sync_pol</span> <span class="o">=</span> <span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    
	<span class="n">c_sync</span> <span class="o">=</span> <span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">=</span> <span class="mh">0x3000000L</span> <span class="o">|</span> <span class="n">c_sync</span> <span class="o">|</span> <span class="p">(</span><span class="n">dst</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_total</span> <span class="o">=</span> <span class="n">h_total</span> <span class="o">|</span> <span class="p">(</span><span class="n">h_disp</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_total</span> <span class="o">=</span> <span class="n">v_total</span> <span class="o">|</span> <span class="p">(</span><span class="n">v_disp</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">=</span> <span class="n">h_sync_strt</span> <span class="o">|</span> <span class="p">(</span><span class="n">h_sync_wid</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
	        <span class="p">(</span><span class="n">h_sync_pol</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span> <span class="o">=</span> <span class="n">v_sync_strt</span> <span class="o">|</span> <span class="p">(</span><span class="n">v_sync_wid</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
                <span class="p">(</span><span class="n">v_sync_pol</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">)</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">offset_cntl</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">offset_cntl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vxres</span> <span class="o">=</span> <span class="n">vxres</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">=</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">xoffset</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">yoffset</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_pix_width_to_var</span><span class="p">(</span><span class="kt">int</span> <span class="n">pix_width</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* fill in pixel info */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pix_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CRTC_PIX_WIDTH_8BPP</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CRTC_PIX_WIDTH_15BPP</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CRTC_PIX_WIDTH_16BPP</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CRTC_PIX_WIDTH_24BPP</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CRTC_PIX_WIDTH_32BPP</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: Invalid pixel width</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_crtc_to_var</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">hslen</span><span class="p">,</span> <span class="n">vslen</span><span class="p">,</span> <span class="n">sync</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">h_total</span><span class="p">,</span> <span class="n">h_disp</span><span class="p">,</span> <span class="n">h_sync_strt</span><span class="p">,</span> <span class="n">h_sync_dly</span><span class="p">,</span> <span class="n">h_sync_wid</span><span class="p">,</span> <span class="n">h_sync_pol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v_total</span><span class="p">,</span> <span class="n">v_disp</span><span class="p">,</span> <span class="n">v_sync_strt</span><span class="p">,</span> <span class="n">v_sync_wid</span><span class="p">,</span> <span class="n">v_sync_pol</span><span class="p">,</span> <span class="n">c_sync</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pix_width</span><span class="p">;</span>

	<span class="cm">/* fun with masking */</span>
	<span class="n">h_total</span>     <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_total</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">;</span>
	<span class="n">h_disp</span>      <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_total</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">h_sync_strt</span> <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">;</span>
	<span class="n">h_sync_dly</span>  <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">h_sync_wid</span>  <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">h_sync_pol</span>  <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">h_sync_strt_wid</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">v_total</span>     <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_total</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
	<span class="n">v_disp</span>      <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_total</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
	<span class="n">v_sync_strt</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
	<span class="n">v_sync_wid</span>  <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">v_sync_pol</span>  <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">v_sync_strt_wid</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">c_sync</span>      <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_CSYNC_EN</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pix_width</span>   <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gen_cntl</span> <span class="o">&amp;</span> <span class="n">CRTC_PIX_WIDTH_MASK</span><span class="p">;</span>

	<span class="cm">/* do conversions */</span>
	<span class="n">xres</span>  <span class="o">=</span> <span class="p">(</span><span class="n">h_disp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">yres</span>  <span class="o">=</span> <span class="n">v_disp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">left</span>  <span class="o">=</span> <span class="p">((</span><span class="n">h_total</span> <span class="o">-</span> <span class="n">h_sync_strt</span> <span class="o">-</span> <span class="n">h_sync_wid</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">h_sync_dly</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="p">((</span><span class="n">h_sync_strt</span> <span class="o">-</span> <span class="n">h_disp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">h_sync_dly</span><span class="p">;</span>
	<span class="n">hslen</span> <span class="o">=</span> <span class="n">h_sync_wid</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">upper</span> <span class="o">=</span> <span class="n">v_total</span> <span class="o">-</span> <span class="n">v_sync_strt</span> <span class="o">-</span> <span class="n">v_sync_wid</span><span class="p">;</span>
	<span class="n">lower</span> <span class="o">=</span> <span class="n">v_sync_strt</span> <span class="o">-</span> <span class="n">v_disp</span><span class="p">;</span>
	<span class="n">vslen</span> <span class="o">=</span> <span class="n">v_sync_wid</span><span class="p">;</span>
	<span class="n">sync</span>  <span class="o">=</span> <span class="p">(</span><span class="n">h_sync_pol</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">v_sync_pol</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">c_sync</span> <span class="o">?</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">aty128_pix_width_to_var</span><span class="p">(</span><span class="n">pix_width</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vxres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vyres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span>  <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">upper</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">lower</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">hslen</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">vslen</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span>  <span class="o">=</span> <span class="n">sync</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_set_crt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_EXT_CNTL</span><span class="p">,</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_EXT_CNTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">CRT_CRTC_ON</span><span class="p">);</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">DAC_PALETTE2_SNOOP_EN</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_EXT_CNTL</span><span class="p">,</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC_EXT_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRT_CRTC_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_set_lcd_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_ATY128_BACKLIGHT</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LVDS_ON</span> <span class="o">|</span> <span class="n">LVDS_EN</span> <span class="o">|</span> <span class="n">LVDS_BLON</span> <span class="o">|</span> <span class="n">LVDS_DIGION</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LVDS_DISPLAY_DIS</span><span class="p">;</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_FB_ATY128_BACKLIGHT</span>
		<span class="n">aty128_bl_set_power</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">);</span>
<span class="cp">#endif	</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_ATY128_BACKLIGHT</span>
		<span class="n">aty128_bl_set_power</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">FB_BLANK_POWERDOWN</span><span class="p">);</span>
<span class="cp">#endif	</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LVDS_DISPLAY_DIS</span><span class="p">;</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LVDS_ON</span> <span class="cm">/*| LVDS_EN*/</span><span class="p">);</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_set_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">div3</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">post_conv</span><span class="p">[]</span> <span class="o">=</span>	<span class="cm">/* register values for post dividers */</span>
        <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span>

	<span class="cm">/* select PPLL_DIV_3 */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CLOCK_CNTL_INDEX</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* reset PLL */</span>
	<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">PPLL_CNTL</span><span class="p">,</span>
		   <span class="n">aty_ld_pll</span><span class="p">(</span><span class="n">PPLL_CNTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">PPLL_RESET</span> <span class="o">|</span> <span class="n">PPLL_ATOMIC_UPDATE_EN</span><span class="p">);</span>

	<span class="cm">/* write the reference divider */</span>
	<span class="n">aty_pll_wait_readupdate</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">PPLL_REF_DIV</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">ref_divider</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">);</span>
	<span class="n">aty_pll_writeupdate</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">div3</span> <span class="o">=</span> <span class="n">aty_ld_pll</span><span class="p">(</span><span class="n">PPLL_DIV_3</span><span class="p">);</span>
	<span class="n">div3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PPLL_FB3_DIV_MASK</span><span class="p">;</span>
	<span class="n">div3</span> <span class="o">|=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">feedback_divider</span><span class="p">;</span>
	<span class="n">div3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PPLL_POST3_DIV_MASK</span><span class="p">;</span>
	<span class="n">div3</span> <span class="o">|=</span> <span class="n">post_conv</span><span class="p">[</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">post_divider</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* write feedback and post dividers */</span>
	<span class="n">aty_pll_wait_readupdate</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">PPLL_DIV_3</span><span class="p">,</span> <span class="n">div3</span><span class="p">);</span>
	<span class="n">aty_pll_writeupdate</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">aty_pll_wait_readupdate</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">HTOTAL_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* no horiz crtc adjustment */</span>
	<span class="n">aty_pll_writeupdate</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="cm">/* clear the reset, just in case */</span>
	<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">PPLL_CNTL</span><span class="p">,</span> <span class="n">aty_ld_pll</span><span class="p">(</span><span class="n">PPLL_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PPLL_RESET</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_var_to_pll</span><span class="p">(</span><span class="n">u32</span> <span class="n">period_in_ps</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aty128_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_constants</span> <span class="n">c</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">post_dividers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">output_freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vclk</span><span class="p">;</span>        <span class="cm">/* in .01 MHz */</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">vclk</span> <span class="o">=</span> <span class="mi">100000000</span> <span class="o">/</span> <span class="n">period_in_ps</span><span class="p">;</span>	<span class="cm">/* convert units to 10 kHz */</span>

	<span class="cm">/* adjust pixel clock if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vclk</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">ppll_max</span><span class="p">)</span>
		<span class="n">vclk</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">ppll_max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vclk</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">.</span><span class="n">ppll_min</span><span class="p">)</span>
		<span class="n">vclk</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">ppll_min</span><span class="o">/</span><span class="mi">12</span><span class="p">;</span>

	<span class="cm">/* now, find an acceptable divider */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">post_dividers</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">output_freq</span> <span class="o">=</span> <span class="n">post_dividers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">vclk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">output_freq</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="p">.</span><span class="n">ppll_min</span> <span class="o">&amp;&amp;</span> <span class="n">output_freq</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="p">.</span><span class="n">ppll_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pll</span><span class="o">-&gt;</span><span class="n">post_divider</span> <span class="o">=</span> <span class="n">post_dividers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">post_dividers</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* calculate feedback divider */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">ref_divider</span> <span class="o">*</span> <span class="n">output_freq</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">ref_clk</span><span class="p">;</span>

	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">feedback_divider</span> <span class="o">=</span> <span class="n">round_div</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk</span> <span class="o">=</span> <span class="n">vclk</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;post %d feedback %d vlck %d output %d ref_divider %d &quot;</span>
	    <span class="s">&quot;vclk_per: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">post_divider</span><span class="p">,</span>
	    <span class="n">pll</span><span class="o">-&gt;</span><span class="n">feedback_divider</span><span class="p">,</span> <span class="n">vclk</span><span class="p">,</span> <span class="n">output_freq</span><span class="p">,</span>
	    <span class="n">c</span><span class="p">.</span><span class="n">ref_divider</span><span class="p">,</span> <span class="n">period_in_ps</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_pll_to_var</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">100000000</span> <span class="o">/</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_set_fifo</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_ddafifo</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DDA_CONFIG</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dda_config</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DDA_ON_OFF</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dda_on_off</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_ddafifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128_ddafifo</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">depth</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">aty128_meminfo</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xclk</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">xclk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fifo_width</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">fifo_width</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fifo_depth</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">constants</span><span class="p">.</span><span class="n">fifo_depth</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ron</span><span class="p">,</span> <span class="n">roff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="cm">/* round up to multiple of 8 */</span>
	<span class="n">bpp</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">xclk</span> <span class="o">*</span> <span class="n">fifo_width</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vclk</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">round_div</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>

	<span class="n">ron</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">MB</span> <span class="o">+</span>
		<span class="mi">3</span> <span class="o">*</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">Trcd</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">Trcd</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="mi">2</span> <span class="o">*</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">Trp</span> <span class="o">+</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">Twr</span> <span class="o">+</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">CL</span> <span class="o">+</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">Tr2w</span> <span class="o">+</span>
		<span class="n">x</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>

	<span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">b</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ron</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">p</span><span class="p">);</span>

	<span class="n">n</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">round_div</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="n">roff</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">fifo_depth</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ron</span> <span class="o">+</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">Rloop</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">roff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: Mode out of range!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;p: %x rloop: %x x: %x ron: %x roff: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">Rloop</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ron</span><span class="p">,</span> <span class="n">roff</span><span class="p">);</span>

	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dda_config</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">Rloop</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span> <span class="o">|</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dda_on_off</span> <span class="o">=</span> <span class="n">ron</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">roff</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This actually sets the video mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128fb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span> 
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">aty128_decode_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">par</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">blitter_may_be_busy</span><span class="p">)</span>
		<span class="n">wait_for_idle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="cm">/* clear all registers that may interfere with mode setting */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">OVR_CLR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">OVR_WID_LEFT_RIGHT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">OVR_WID_TOP_BOTTOM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">OV0_SCALE_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">MPP_TB_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">MPP_GP_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">SUBPIC_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">VIPH_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">I2C_CNTL_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>         <span class="cm">/* turn off i2c */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">GEN_INT_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* turn off interrupts */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CAP0_TRIG_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CAP1_TRIG_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">CRTC_EXT_CNTL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* turn video off */</span>

	<span class="n">aty128_set_crtc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty128_set_pll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">aty128_set_fifo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fifo_reg</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CNFG_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

<span class="cp">#if defined(__BIG_ENDIAN)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">config</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* make aperture do 32 bit swapping */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">config</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* make aperture do 16 bit swapping */</span>
<span class="cp">#endif</span>

	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CNFG_CNTL</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">CRTC_EXT_CNTL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* turn the video back on */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">vxres</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">bpp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>
		<span class="o">:</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_gen</span> <span class="o">==</span> <span class="n">rage_M3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aty128_set_crt_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crt_on</span><span class="p">);</span>
		<span class="n">aty128_set_lcd_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_on</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">&amp;</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">)</span>
		<span class="n">aty128_init_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_BOOTX_TEXT</span>
	<span class="n">btext_update_display</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
			     <span class="p">(((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">h_total</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span>
			     <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">v_total</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
			     <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">bpp</span><span class="p">,</span>
			     <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">vxres</span><span class="o">*</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">bpp</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_BOOTX_TEXT */</span><span class="cp"></span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  encode/decode the User Defined Part of the Display</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_decode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aty128_crtc</span> <span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aty128_pll</span> <span class="n">pll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aty128_ddafifo</span> <span class="n">fifo_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">aty128_var_to_crtc</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crtc</span><span class="p">,</span> <span class="n">par</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">aty128_var_to_pll</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll</span><span class="p">,</span> <span class="n">par</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">aty128_ddafifo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll</span><span class="p">,</span> <span class="n">crtc</span><span class="p">.</span><span class="n">depth</span><span class="p">,</span> <span class="n">par</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span> <span class="o">=</span> <span class="n">pll</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">fifo_reg</span> <span class="o">=</span> <span class="n">fifo_reg</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_encode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">aty128_crtc_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">,</span> <span class="n">var</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">aty128_pll_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">,</span> <span class="n">var</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">accel_flags</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>           


<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">par</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">aty128_decode_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">aty128_encode_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Pan or Wrap the Display</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128fb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xoffset</span><span class="p">,</span> <span class="n">yoffset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">;</span>

	<span class="n">xres</span> <span class="o">=</span> <span class="p">(((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">h_total</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">yres</span> <span class="o">=</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">v_total</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">xoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xoffset</span><span class="o">+</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">vxres</span> <span class="o">||</span> <span class="n">yoffset</span><span class="o">+</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">xoffset</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">yoffset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">vxres</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="mi">3</span><span class="p">);</span> <span class="cm">/* Must be multiple of 8 and 3 */</span>

	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC_OFFSET</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Helper function to store a single palette register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_st_pal</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_gen</span> <span class="o">==</span> <span class="n">rage_M3</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/* Note: For now, on M3, we set palette on both heads, which may</span>
<span class="c">		 * be useless. Can someone with a M3 check this ?</span>
<span class="c">		 * </span>
<span class="c">		 * This code would still be useful if using the second CRTC to </span>
<span class="c">		 * do mirroring</span>
<span class="c">		 */</span>

<span class="c">		aty_st_le32(DAC_CNTL, aty_ld_le32(DAC_CNTL) | DAC_PALETTE_ACCESS_CNTL);</span>
<span class="c">		aty_st_8(PALETTE_INDEX, regno);</span>
<span class="c">		aty_st_le32(PALETTE_DATA, (red&lt;&lt;16)|(green&lt;&lt;8)|blue);</span>
<span class="cp">#endif</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DAC_PALETTE_ACCESS_CNTL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">PALETTE_INDEX</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">PALETTE_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">red</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">green</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">blue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128fb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">blitter_may_be_busy</span><span class="p">)</span>
		<span class="n">wait_for_idle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">aty128fb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;lcd:&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">default_lcd_on</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;crt:&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">default_crt_on</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;backlight:&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">backlight</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nomtrr&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mtrr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
		<span class="cm">/* vmode and cmode deprecated */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vmode:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vmode</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">vmode</span> <span class="o">&lt;=</span> <span class="n">VMODE_MAX</span><span class="p">)</span>
				<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">vmode</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;cmode:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmode</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">15</span>:
			<span class="k">case</span> <span class="mi">16</span>:
				<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">24</span>:
			<span class="k">case</span> <span class="mi">32</span>:
				<span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>
		<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="cm">/*  MODULE  */</span><span class="cp"></span>

<span class="cm">/* Backlight */</span>
<span class="cp">#ifdef CONFIG_FB_ATY128_BACKLIGHT</span>
<span class="cp">#define MAX_LEVEL 0xFF</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_bl_get_level_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">atylevel</span><span class="p">;</span>

	<span class="cm">/* Get and convert the value */</span>
	<span class="cm">/* No locking of bl_curve since we read a single value */</span>
	<span class="n">atylevel</span> <span class="o">=</span> <span class="n">MAX_LEVEL</span> <span class="o">-</span>
		<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bl_curve</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">*</span> <span class="n">FB_BACKLIGHT_MAX</span> <span class="o">/</span> <span class="n">MAX_LEVEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atylevel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">atylevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atylevel</span> <span class="o">&gt;</span> <span class="n">MAX_LEVEL</span><span class="p">)</span>
		<span class="n">atylevel</span> <span class="o">=</span> <span class="n">MAX_LEVEL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">atylevel</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We turn off the LCD completely instead of just dimming the backlight.</span>
<span class="cm"> * This provides greater power saving and the display is useless without</span>
<span class="cm"> * backlight anyway</span>
<span class="cm"> */</span>
<span class="cp">#define BACKLIGHT_LVDS_OFF</span>
<span class="cm">/* That one prevents proper CRT output with LCD off */</span>
<span class="cp">#undef BACKLIGHT_DAC_OFF</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_bl_update_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">bl_get_data</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">!=</span> <span class="n">FB_BLANK_UNBLANK</span> <span class="o">||</span>
	    <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">fb_blank</span> <span class="o">!=</span> <span class="n">FB_BLANK_UNBLANK</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_on</span><span class="p">)</span>
		<span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">level</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">|=</span> <span class="n">LVDS_BL_MOD_EN</span> <span class="o">|</span> <span class="n">LVDS_BLON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LVDS_DIGION</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">LVDS_ON</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LVDS_BLON</span><span class="p">;</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">LVDS_BLON</span><span class="p">;</span>
			<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LVDS_BL_MOD_LEVEL_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aty128_bl_get_level_brightness</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">LVDS_BL_MOD_LEVEL_SHIFT</span><span class="p">);</span>
<span class="cp">#ifdef BACKLIGHT_LVDS_OFF</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LVDS_ON</span> <span class="o">|</span> <span class="n">LVDS_EN</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LVDS_DISPLAY_DIS</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="cp">#ifdef BACKLIGHT_DAC_OFF</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">DAC_PDWN</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LVDS_BL_MOD_LEVEL_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aty128_bl_get_level_brightness</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">LVDS_BL_MOD_LEVEL_SHIFT</span><span class="p">);</span>
<span class="cp">#ifdef BACKLIGHT_LVDS_OFF</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LVDS_DISPLAY_DIS</span><span class="p">;</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LVDS_ON</span> <span class="o">|</span> <span class="n">LVDS_EN</span> <span class="o">|</span> <span class="n">LVDS_BLON</span> <span class="o">|</span> <span class="n">LVDS_DIGION</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">LVDS_GEN_CNTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="cp">#ifdef BACKLIGHT_DAC_OFF</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">DAC_PDWN</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_bl_get_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">backlight_ops</span> <span class="n">aty128_bl_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_brightness</span>	<span class="o">=</span> <span class="n">aty128_bl_get_brightness</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_status</span>	<span class="o">=</span> <span class="n">aty128_bl_update_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_bl_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bl_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bl_dev</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">power</span><span class="p">;</span>
		<span class="n">backlight_update_status</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bl_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_bl_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="n">props</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

	<span class="cm">/* Could be extended to Rage128Pro LVDS output too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_gen</span> <span class="o">!=</span> <span class="n">rage_M3</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PMAC_BACKLIGHT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmac_has_backlight_type</span><span class="p">(</span><span class="s">&quot;ati&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;aty128bl%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_properties</span><span class="p">));</span>
	<span class="n">props</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BACKLIGHT_RAW</span><span class="p">;</span>
	<span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="n">FB_BACKLIGHT_LEVELS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bd</span> <span class="o">=</span> <span class="n">backlight_device_register</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aty128_bl_data</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">props</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bl_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aty128: Backlight registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">bl_dev</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>
	<span class="n">fb_bl_default_curve</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="mi">63</span> <span class="o">*</span> <span class="n">FB_BACKLIGHT_MAX</span> <span class="o">/</span> <span class="n">MAX_LEVEL</span><span class="p">,</span>
		<span class="mi">219</span> <span class="o">*</span> <span class="n">FB_BACKLIGHT_MAX</span> <span class="o">/</span> <span class="n">MAX_LEVEL</span><span class="p">);</span>

	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span><span class="p">;</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">;</span>
	<span class="n">backlight_update_status</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;aty128: Backlight initialized (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_bl_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;aty128: Backlight unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_ATY128_BACKLIGHT */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *  Initialisation</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC__disabled</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_early_resume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">console_trylock</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">aty128_do_resume</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">aty128_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">var</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">video_card</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">chip_rev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dac</span><span class="p">;</span>

	<span class="cm">/* Get the chip revision */</span>
	<span class="n">chip_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CNFG_CNTL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">video_card</span><span class="p">,</span> <span class="s">&quot;Rage128 XX &quot;</span><span class="p">);</span>
	<span class="n">video_card</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">video_card</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="cm">/* range check to make sure */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">r128_family</span><span class="p">))</span>
	    <span class="n">strlcat</span><span class="p">(</span><span class="n">video_card</span><span class="p">,</span> <span class="n">r128_family</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">video_card</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aty128fb: %s [chip rev 0x%x] &quot;</span><span class="p">,</span> <span class="n">video_card</span><span class="p">,</span> <span class="n">chip_rev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%dM %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%dk %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_gen</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="cm">/* fill in info */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aty128fb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_on</span> <span class="o">=</span> <span class="n">default_lcd_on</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crt_on</span> <span class="o">=</span> <span class="n">default_crt_on</span><span class="p">;</span>

	<span class="n">var</span> <span class="o">=</span> <span class="n">default_var</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Indicate sleep capability */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_gen</span> <span class="o">==</span> <span class="n">rage_M3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pmac_call_feature</span><span class="p">(</span><span class="n">PMAC_FTR_DEVICE_CAN_WAKE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"> /* Disable the early video resume hack for now as it&#39;s causing problems, among</span>
<span class="c">       * others we now rely on the PCI core restoring the config space for us, which</span>
<span class="c">       * isn&#39;t the case with that hack, and that code path causes various things to</span>
<span class="c">       * be called with interrupts off while they shouldn&#39;t. I&#39;m leaving the code in</span>
<span class="c">       * as it can be useful for debugging purposes</span>
<span class="c">       */</span>
<span class="c">			pmac_set_early_video_resume(aty128_early_resume, par);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="cm">/* Find default mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode_option</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
				<span class="n">var</span> <span class="o">=</span> <span class="n">default_var</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">default_vmode</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">default_vmode</span> <span class="o">&gt;</span> <span class="n">VMODE_MAX</span><span class="p">)</span>
				<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_1024_768_60</span><span class="p">;</span>

			<span class="cm">/* iMacs need that resolution</span>
<span class="cm">			 * PowerMac2,1 first r128 iMacs</span>
<span class="cm">			 * PowerMac2,2 summer 2000 iMacs</span>
<span class="cm">			 * PowerMac4,1 january 2001 iMacs &quot;flower power&quot;</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac2,1&quot;</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac2,2&quot;</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac4,1&quot;</span><span class="p">))</span>
				<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_1024_768_75</span><span class="p">;</span>

			<span class="cm">/* iBook SE */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook2,2&quot;</span><span class="p">))</span>
				<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_800_600_60</span><span class="p">;</span>

			<span class="cm">/* PowerBook Firewire (Pismo), iBook Dual USB */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook3,1&quot;</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook4,1&quot;</span><span class="p">))</span>
				<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_1024_768_60</span><span class="p">;</span>

			<span class="cm">/* PowerBook Titanium */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook3,2&quot;</span><span class="p">))</span>
				<span class="n">default_vmode</span> <span class="o">=</span> <span class="n">VMODE_1152_768_60</span><span class="p">;</span>
	
			<span class="k">if</span> <span class="p">(</span><span class="n">default_cmode</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> 
			    <span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_32</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">default_cmode</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> 
			    <span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_16</span><span class="p">;</span>
			<span class="k">else</span> 
			    <span class="n">default_cmode</span> <span class="o">=</span> <span class="n">CMODE_8</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mac_vmode_to_var</span><span class="p">(</span><span class="n">default_vmode</span><span class="p">,</span> <span class="n">default_cmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">))</span>
				<span class="n">var</span> <span class="o">=</span> <span class="n">default_var</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode_option</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> 
					 <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">defaultmode</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">var</span> <span class="o">=</span> <span class="n">default_var</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_ACCELF_TEXT</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>var.accel<em>flags |= FB</em>ACCELF_TEXT;/* FIXME Will add accel later */</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">aty128fb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: Cannot set default mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup the DAC the way we like it */</span>
	<span class="n">dac</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">);</span>
	<span class="n">dac</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DAC_8BIT_EN</span> <span class="o">|</span> <span class="n">DAC_RANGE_CNTL</span><span class="p">);</span>
	<span class="n">dac</span> <span class="o">|=</span> <span class="n">DAC_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_gen</span> <span class="o">==</span> <span class="n">rage_M3</span><span class="p">)</span>
		<span class="n">dac</span> <span class="o">|=</span> <span class="n">DAC_PALETTE2_SNOOP_EN</span><span class="p">;</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">DAC_CNTL</span><span class="p">,</span> <span class="n">dac</span><span class="p">);</span>

	<span class="cm">/* turn off bus mastering, just in case */</span>
	<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">,</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">BUS_CNTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">BUS_MASTER_DIS</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">;</span>
	<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>

	<span class="n">aty128_init_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pm_reg</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PM</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">asleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">lock_blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_ATY128_BACKLIGHT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">backlight</span><span class="p">)</span>
		<span class="n">aty128_bl_init</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">video_card</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* success! */</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cm">/* register a card    ++ajoshi */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">aty128_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fb_addr</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#ifndef __sparc__</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bios</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Enable device in PCI config */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: Cannot enable PCI device: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">fb_addr</span><span class="p">,</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="s">&quot;aty128fb FB&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: cannot reserve frame &quot;</span>
				<span class="s">&quot;buffer memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">,</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
				<span class="s">&quot;aty128fb MMIO&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: cannot reserve MMIO region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_fb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We have the resources. Now virtualize them */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: can&#39;t alloc fb_info_aty128</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_mmio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="cm">/* Virtualize mmio region */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_info</span><span class="p">;</span>

	<span class="cm">/* Grab memory size from the card */</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>How does this relate to the resource length from the PCI hardware?</p></td><td class="code"><div class="highlight"><pre>	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span> <span class="o">=</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CNFG_MEMSIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03FFFFFF</span><span class="p">;</span>

	<span class="cm">/* Virtualize the framebuffer */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">fb_addr</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unmap_out</span><span class="p">;</span>

	<span class="cm">/* Set up info-&gt;fix */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">aty128fb_fix</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">fb_addr</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">reg_addr</span><span class="p">;</span>

	<span class="cm">/* If we can&#39;t test scratch registers, something is seriously wrong */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">register_test</span><span class="p">(</span><span class="n">par</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aty128fb: Can&#39;t write to video register!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef __sparc__</span>
	<span class="n">bios</span> <span class="o">=</span> <span class="n">aty128_map_ROM</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_X86</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bios</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">bios</span> <span class="o">=</span> <span class="n">aty128_find_mem_vbios</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bios</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aty128fb: BIOS not located, guessing timings.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aty128fb: Rage128 BIOS located</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">aty128_get_pllinfo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">bios</span><span class="p">);</span>
		<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bios</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* __sparc__ */</span><span class="cp"></span>

	<span class="n">aty128_timings</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aty128_init</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ent</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtrr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr</span><span class="p">.</span><span class="n">vram</span> <span class="o">=</span> <span class="n">mtrr_add</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">,</span> <span class="n">MTRR_TYPE_WRCOMB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr</span><span class="p">.</span><span class="n">vram_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* let there be speed */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aty128fb: Rage128 MTRR set to ON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MTRR */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="nl">err_unmap_out:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">);</span>
<span class="nl">err_free_info:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="nl">err_free_mmio:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
<span class="nl">err_free_fb:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">aty128_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_ATY128_BACKLIGHT</span>
	<span class="n">aty128_bl_exit</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bl_dev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr</span><span class="p">.</span><span class="n">vram_valid</span><span class="p">)</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr</span><span class="p">.</span><span class="n">vram</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
			 <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MTRR */</span><span class="cp"></span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>



    <span class="cm">/*</span>
<span class="cm">     *  Blank the display.</span>
<span class="cm">     */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock_blank</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">asleep</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
	<span class="nl">default:</span>
		<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">aty_st_8</span><span class="p">(</span><span class="n">CRTC_EXT_CNTL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_gen</span> <span class="o">==</span> <span class="n">rage_M3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aty128_set_crt_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crt_on</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">blank</span><span class="p">);</span>
		<span class="n">aty128_set_lcd_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_on</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">blank</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Set a single color register. The values supplied are already</span>
<span class="cm"> *  rounded down to the hardware&#39;s capabilities (according to the</span>
<span class="cm"> *  entries in the var structure). Return != 0 for invalid regno.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128fb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			      <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">15</span>:
			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>:
			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * With the 5-6-5 split of bits for RGB at 16 bits/pixel, we</span>
<span class="cm">		 * have 32 slots for R and B values but 64 slots for G values.</span>
<span class="cm">		 * Thus the R and B values go in one slot but the G value</span>
<span class="cm">		 * goes in a different slot, and we have to avoid disturbing</span>
<span class="cm">		 * the other fields in the slots we touch.</span>
<span class="cm">		 */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">green</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">red</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">blue</span><span class="p">;</span>
			<span class="n">aty128_st_pal</span><span class="p">(</span><span class="n">regno</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">[</span><span class="n">regno</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span>
				      <span class="n">blue</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">[</span><span class="n">regno</span><span class="o">/</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">blue</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">[</span><span class="n">regno</span><span class="o">/</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">regno</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">regno</span> <span class="o">&lt;&lt;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">aty128_st_pal</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ATY_MIRROR_LCD_ON	0x00000001</span>
<span class="cp">#define ATY_MIRROR_CRT_ON	0x00000002</span>

<span class="cm">/* out param: u32*	backlight value: 0 to 15 */</span>
<span class="cp">#define FBIO_ATY128_GET_MIRROR	_IOR(&#39;@&#39;, 1, __u32)</span>
<span class="cm">/* in param: u32*	backlight value: 0 to 15 */</span>
<span class="cp">#define FBIO_ATY128_SET_MIRROR	_IOW(&#39;@&#39;, 2, __u32)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128fb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
    
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FBIO_ATY128_SET_MIRROR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_gen</span> <span class="o">!=</span> <span class="n">rage_M3</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">__u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_on</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">crt_on</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crt_on</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_on</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">aty128_set_crt_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crt_on</span><span class="p">);</span>	
		<span class="n">aty128_set_lcd_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_on</span><span class="p">);</span>	
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIO_ATY128_GET_MIRROR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip_gen</span> <span class="o">!=</span> <span class="n">rage_M3</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crt_on</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_on</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">__u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    /*</span>
<span class="c">     *  Accelerated functions</span>
<span class="c">     */</span>

<span class="c">static inline void aty128_rectcopy(int srcx, int srcy, int dstx, int dsty,</span>
<span class="c">				   u_int width, u_int height,</span>
<span class="c">				   struct fb_info_aty128 *par)</span>
<span class="c">{</span>
<span class="c">    u32 save_dp_datatype, save_dp_cntl, dstval;</span>

<span class="c">    if (!width || !height)</span>
<span class="c">        return;</span>

<span class="c">    dstval = depth_to_dst(par-&gt;current_par.crtc.depth);</span>
<span class="c">    if (dstval == DST_24BPP) {</span>
<span class="c">        srcx *= 3;</span>
<span class="c">        dstx *= 3;</span>
<span class="c">        width *= 3;</span>
<span class="c">    } else if (dstval == -EINVAL) {</span>
<span class="c">        printk(&quot;aty128fb: invalid depth or RGBA\n&quot;);</span>
<span class="c">        return;</span>
<span class="c">    }</span>

<span class="c">    wait_for_fifo(2, par);</span>
<span class="c">    save_dp_datatype = aty_ld_le32(DP_DATATYPE);</span>
<span class="c">    save_dp_cntl     = aty_ld_le32(DP_CNTL);</span>

<span class="c">    wait_for_fifo(6, par);</span>
<span class="c">    aty_st_le32(SRC_Y_X, (srcy &lt;&lt; 16) | srcx);</span>
<span class="c">    aty_st_le32(DP_MIX, ROP3_SRCCOPY | DP_SRC_RECT);</span>
<span class="c">    aty_st_le32(DP_CNTL, DST_X_LEFT_TO_RIGHT | DST_Y_TOP_TO_BOTTOM);</span>
<span class="c">    aty_st_le32(DP_DATATYPE, save_dp_datatype | dstval | SRC_DSTCOLOR);</span>

<span class="c">    aty_st_le32(DST_Y_X, (dsty &lt;&lt; 16) | dstx);</span>
<span class="c">    aty_st_le32(DST_HEIGHT_WIDTH, (height &lt;&lt; 16) | width);</span>

<span class="c">    par-&gt;blitter_may_be_busy = 1;</span>

<span class="c">    wait_for_fifo(2, par);</span>
<span class="c">    aty_st_le32(DP_DATATYPE, save_dp_datatype);</span>
<span class="c">    aty_st_le32(DP_CNTL, save_dp_cntl); </span>
<span class="c">}</span>


<span class="c">    /*</span>
<span class="c">     * Text mode accelerated functions</span>
<span class="c">     */</span>

<span class="c">static void fbcon_aty128_bmove(struct display *p, int sy, int sx, int dy, int dx,</span>
<span class="c">			int height, int width)</span>
<span class="c">{</span>
<span class="c">    sx     *= fontwidth(p);</span>
<span class="c">    sy     *= fontheight(p);</span>
<span class="c">    dx     *= fontwidth(p);</span>
<span class="c">    dy     *= fontheight(p);</span>
<span class="c">    width  *= fontwidth(p);</span>
<span class="c">    height *= fontheight(p);</span>

<span class="c">    aty128_rectcopy(sx, sy, dx, dy, width, height,</span>
<span class="c">			(struct fb_info_aty128 *)p-&gt;fb_info);</span>
<span class="c">}</span>
<span class="cp">#endif /* 0 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aty128_set_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">suspend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">pmgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pm_reg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
		
	<span class="cm">/* Set the chip into the appropriate suspend mode (we use D2,</span>
<span class="cm">	 * D3 would require a complete re-initialisation of the chip,</span>
<span class="cm">	 * including PCI config registers, clocks, AGP configuration, ...)</span>
<span class="cm">	 *</span>
<span class="cm">	 * For resume, the core will have already brought us back to D0</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure CRTC2 is reset. Remove that the day we decide to</span>
<span class="cm">		 * actually use CRTC2 and replace it with real code for disabling</span>
<span class="cm">		 * the CRTC2 output during sleep</span>
<span class="cm">		 */</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">CRTC2_GEN_CNTL</span><span class="p">,</span> <span class="n">aty_ld_le32</span><span class="p">(</span><span class="n">CRTC2_GEN_CNTL</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">CRTC2_EN</span><span class="p">));</span>

		<span class="cm">/* Set the power management mode to be PCI based */</span>
		<span class="cm">/* Use this magic value for now */</span>
		<span class="n">pmgt</span> <span class="o">=</span> <span class="mh">0x0c005407</span><span class="p">;</span>
		<span class="n">aty_st_pll</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">,</span> <span class="n">pmgt</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">aty_ld_pll</span><span class="p">(</span><span class="n">POWER_MANAGEMENT</span><span class="p">);</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">BUS_CNTL1</span><span class="p">,</span> <span class="mh">0x00000010</span><span class="p">);</span>
		<span class="n">aty_st_le32</span><span class="p">(</span><span class="n">MEM_POWER_MISC</span><span class="p">,</span> <span class="mh">0x0c830000</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="cm">/* Switch PCI power management to D2 */</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="cm">/* Because we may change PCI D state ourselves, we need to</span>
<span class="cm">	 * first save the config space content so the core can</span>
<span class="cm">	 * restore it properly on resume.</span>
<span class="cm">	 */</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* We don&#39;t do anything but D2, for now we return 0, but</span>
<span class="cm">	 * we may want to change that. How do we know if the BIOS</span>
<span class="cm">	 * can properly take care of D3 ? Also, with swsusp, we</span>
<span class="cm">	 * know we&#39;ll be rebooted, ...</span>
<span class="cm">	 */</span>
<span class="cp">#ifndef CONFIG_PPC_PMAC</span>
	<span class="cm">/* HACK ALERT ! Once I find a proper way to say to each driver</span>
<span class="cm">	 * individually what will happen with it&#39;s PCI slot, I&#39;ll change</span>
<span class="cm">	 * that. On laptops, the AGP slot is just unclocked, so D2 is</span>
<span class="cm">	 * expected, while on desktops, the card is powered off</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>
	 
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aty128fb: suspending...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	
	<span class="n">console_lock</span><span class="p">();</span>

	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Make sure engine is reset */</span>
	<span class="n">wait_for_idle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">aty128_reset_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">wait_for_idle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Blank display and LCD */</span>
	<span class="n">aty128fb_blank</span><span class="p">(</span><span class="n">FB_BLANK_POWERDOWN</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Sleep */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">asleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">lock_blank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="cm">/* On powermac, we have hooks to properly suspend/resume AGP now,</span>
<span class="cm">	 * use them here. We&#39;ll ultimately need some generic support here,</span>
<span class="cm">	 * but the generic code isn&#39;t quite ready for that yet</span>
<span class="cm">	 */</span>
	<span class="n">pmac_suspend_agp_for_card</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>

	<span class="cm">/* We need a way to make sure the fbdev layer will _not_ touch the</span>
<span class="cm">	 * framebuffer before we put the chip to suspend state. On 2.4, I</span>
<span class="cm">	 * used dummy fb ops, 2.5 need proper support for this at the</span>
<span class="cm">	 * fbdev level</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span> <span class="o">!=</span> <span class="n">PM_EVENT_ON</span><span class="p">)</span>
		<span class="n">aty128_set_suspend</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_do_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aty128fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_ON</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* PCI state will have been restored by the core, so</span>
<span class="cm">	 * we should be in D0 now with our config space fully</span>
<span class="cm">	 * restored</span>
<span class="cm">	 */</span>

	<span class="cm">/* Wakeup chip */</span>
	<span class="n">aty128_set_suspend</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">asleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Restore display &amp; engine */</span>
	<span class="n">aty128_reset_engine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">wait_for_idle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">aty128fb_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">fb_pan_display</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
	<span class="n">fb_set_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Refresh */</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Unblank */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">lock_blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">aty128fb_blank</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="cm">/* On powermac, we have hooks to properly suspend/resume AGP now,</span>
<span class="cm">	 * use them here. We&#39;ll ultimately need some generic support here,</span>
<span class="cm">	 * but the generic code isn&#39;t quite ready for that yet</span>
<span class="cm">	 */</span>
	<span class="n">pmac_resume_agp_for_card</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">PMSG_ON</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aty128fb: resumed !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aty128_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">aty128_do_resume</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">aty128fb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;aty128fb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">aty128fb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aty128fb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">aty128fb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aty128fb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">aty128fb_init</span><span class="p">);</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">aty128fb_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;(c)1999-2003 Brad Douglas &lt;brad@neruo.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;FBDev driver for ATI Rage128 / Pro cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="s">&quot;Specify resolution as </span><span class="se">\&quot;</span><span class="s">&lt;xres&gt;x&lt;yres&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]</span><span class="se">\&quot;</span><span class="s"> &quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">nomtrr</span><span class="p">,</span> <span class="n">mtrr</span><span class="p">,</span> <span class="n">invbool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nomtrr</span><span class="p">,</span> <span class="s">&quot;bool: Disable MTRR support (0 or 1=disabled) (default=0)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
