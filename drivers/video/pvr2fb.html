<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › pvr2fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pvr2fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/video/pvr2fb.c</span>
<span class="cm"> *</span>
<span class="cm"> * Frame buffer and fbcon support for the NEC PowerVR2 found within the Sega</span>
<span class="cm"> * Dreamcast.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001 M. R. Brown &lt;mrbrown@0xd6.org&gt;</span>
<span class="cm"> * Copyright (c) 2001 - 2008  Paul Mundt &lt;lethal@linux-sh.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is mostly based on the excellent amifb and vfb sources.  It uses</span>
<span class="cm"> * an odd scheme for converting hardware values to/from framebuffer values,</span>
<span class="cm"> * here are some hacked-up formulas:</span>
<span class="cm"> *</span>
<span class="cm"> *  The Dreamcast has screen offsets from each side of its four borders and</span>
<span class="cm"> *  the start offsets of the display window.  I used these values to calculate</span>
<span class="cm"> *  &#39;pseudo&#39; values (think of them as placeholders) for the fb video mode, so</span>
<span class="cm"> *  that when it came time to convert these values back into their hardware</span>
<span class="cm"> *  values, I could just add mode- specific offsets to get the correct mode</span>
<span class="cm"> *  settings:</span>
<span class="cm"> *</span>
<span class="cm"> *      left_margin = diwstart_h - borderstart_h;</span>
<span class="cm"> *      right_margin = borderstop_h - (diwstart_h + xres);</span>
<span class="cm"> *      upper_margin = diwstart_v - borderstart_v;</span>
<span class="cm"> *      lower_margin = borderstop_v - (diwstart_h + yres);</span>
<span class="cm"> *</span>
<span class="cm"> *      hsync_len = borderstart_h + (hsync_total - borderstop_h);</span>
<span class="cm"> *      vsync_len = borderstart_v + (vsync_total - borderstop_v);</span>
<span class="cm"> *</span>
<span class="cm"> *  Then, when it&#39;s time to convert back to hardware settings, the only</span>
<span class="cm"> *  constants are the borderstart_* offsets, all other values are derived from</span>
<span class="cm"> *  the fb video mode:</span>
<span class="cm"> *</span>
<span class="cm"> *      // PAL</span>
<span class="cm"> *      borderstart_h = 116;</span>
<span class="cm"> *      borderstart_v = 44;</span>
<span class="cm"> *      ...</span>
<span class="cm"> *      borderstop_h = borderstart_h + hsync_total - hsync_len;</span>
<span class="cm"> *      ...</span>
<span class="cm"> *      diwstart_v = borderstart_v - upper_margin;</span>
<span class="cm"> *</span>
<span class="cm"> *  However, in the current implementation, the borderstart values haven&#39;t had</span>
<span class="cm"> *  the benefit of being fully researched, so some modes may be broken.</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cp">#ifdef CONFIG_SH_DREAMCAST</span>
<span class="cp">#include &lt;asm/machvec.h&gt;</span>
<span class="cp">#include &lt;mach-dreamcast/mach/sysasic.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PVR2_DMA</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;mach/dma.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SH_STORE_QUEUES</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;cpu/sq.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef PCI_DEVICE_ID_NEC_NEON250</span>
<span class="cp">#  define PCI_DEVICE_ID_NEC_NEON250	0x0067</span>
<span class="cp">#endif</span>

<span class="cm">/* 2D video registers */</span>
<span class="cp">#define DISP_BASE	par-&gt;mmio_base</span>
<span class="cp">#define DISP_BRDRCOLR (DISP_BASE + 0x40)</span>
<span class="cp">#define DISP_DIWMODE (DISP_BASE + 0x44)</span>
<span class="cp">#define DISP_DIWADDRL (DISP_BASE + 0x50)</span>
<span class="cp">#define DISP_DIWADDRS (DISP_BASE + 0x54)</span>
<span class="cp">#define DISP_DIWSIZE (DISP_BASE + 0x5c)</span>
<span class="cp">#define DISP_SYNCCONF (DISP_BASE + 0xd0)</span>
<span class="cp">#define DISP_BRDRHORZ (DISP_BASE + 0xd4)</span>
<span class="cp">#define DISP_SYNCSIZE (DISP_BASE + 0xd8)</span>
<span class="cp">#define DISP_BRDRVERT (DISP_BASE + 0xdc)</span>
<span class="cp">#define DISP_DIWCONF (DISP_BASE + 0xe8)</span>
<span class="cp">#define DISP_DIWHSTRT (DISP_BASE + 0xec)</span>
<span class="cp">#define DISP_DIWVSTRT (DISP_BASE + 0xf0)</span>
<span class="cp">#define DISP_PIXDEPTH (DISP_BASE + 0x108)</span>

<span class="cm">/* Pixel clocks, one for TV output, doubled for VGA output */</span>
<span class="cp">#define TV_CLK 74239</span>
<span class="cp">#define VGA_CLK 37119</span>

<span class="cm">/* This is for 60Hz - the VTOTAL is doubled for interlaced modes */</span>
<span class="cp">#define PAL_HTOTAL 863</span>
<span class="cp">#define PAL_VTOTAL 312</span>
<span class="cp">#define NTSC_HTOTAL 857</span>
<span class="cp">#define NTSC_VTOTAL 262</span>

<span class="cm">/* Supported cable types */</span>
<span class="k">enum</span> <span class="p">{</span> <span class="n">CT_VGA</span><span class="p">,</span> <span class="n">CT_NONE</span><span class="p">,</span> <span class="n">CT_RGB</span><span class="p">,</span> <span class="n">CT_COMPOSITE</span> <span class="p">};</span>

<span class="cm">/* Supported video output types */</span>
<span class="k">enum</span> <span class="p">{</span> <span class="n">VO_PAL</span><span class="p">,</span> <span class="n">VO_NTSC</span><span class="p">,</span> <span class="n">VO_VGA</span> <span class="p">};</span>

<span class="cm">/* Supported palette types */</span>
<span class="k">enum</span> <span class="p">{</span> <span class="n">PAL_ARGB1555</span><span class="p">,</span> <span class="n">PAL_RGB565</span><span class="p">,</span> <span class="n">PAL_ARGB4444</span><span class="p">,</span> <span class="n">PAL_ARGB8888</span> <span class="p">};</span>

<span class="k">struct</span> <span class="n">pvr2_params</span> <span class="p">{</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pvr2_params</span> <span class="n">cables</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">CT_VGA</span><span class="p">,</span> <span class="s">&quot;VGA&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="n">CT_RGB</span><span class="p">,</span> <span class="s">&quot;RGB&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="n">CT_COMPOSITE</span><span class="p">,</span> <span class="s">&quot;COMPOSITE&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pvr2_params</span> <span class="n">outputs</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">VO_PAL</span><span class="p">,</span> <span class="s">&quot;PAL&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="n">VO_NTSC</span><span class="p">,</span> <span class="s">&quot;NTSC&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="n">VO_VGA</span><span class="p">,</span> <span class="s">&quot;VGA&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This describes the current video mode</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hsync_total</span><span class="p">;</span>	<span class="cm">/* Clocks/line */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vsync_total</span><span class="p">;</span>	<span class="cm">/* Lines/field */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">borderstart_h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">borderstop_h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">borderstart_v</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">borderstop_v</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">diwstart_h</span><span class="p">;</span>	<span class="cm">/* Horizontal offset of the display field */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">diwstart_v</span><span class="p">;</span>	<span class="cm">/* Vertical offset of the display field, for</span>
<span class="cm">				   interlaced modes, this is the long field */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">disp_start</span><span class="p">;</span>	<span class="cm">/* Address of image within VRAM */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">is_interlaced</span><span class="p">;</span>	<span class="cm">/* Is the display interlaced? */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">is_doublescan</span><span class="p">;</span>	<span class="cm">/* Are scanlines output twice? (doublescan) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">is_lowres</span><span class="p">;</span>	<span class="cm">/* Is horizontal pixel-doubling enabled? */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmio_base</span><span class="p">;</span>	<span class="cm">/* MMIO base */</span>
	<span class="n">u32</span> <span class="n">palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="o">*</span><span class="n">currentpar</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">pvr2_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span>		<span class="s">&quot;NEC PowerVR2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span>		<span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span> <span class="o">=</span>	<span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span> <span class="o">=</span>	<span class="n">FB_ACCEL_NONE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">pvr2_var</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xres</span> <span class="o">=</span>		<span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span> <span class="o">=</span>		<span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span>	<span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bits_per_pixel</span>	<span class="o">=</span><span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">red</span> <span class="o">=</span>		<span class="p">{</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">green</span> <span class="o">=</span>	<span class="p">{</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">blue</span> <span class="o">=</span>		<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">activate</span> <span class="o">=</span>	<span class="n">FB_ACTIVATE_NOW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span> <span class="o">=</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span> <span class="o">=</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vmode</span> <span class="o">=</span>	<span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cable_type</span> <span class="o">=</span> <span class="n">CT_VGA</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_output</span> <span class="o">=</span> <span class="n">VO_VGA</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nopan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nowrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * We do all updating, blanking, etc. during the vertical retrace period</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">do_vmode_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Change the video mode */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">do_vmode_pan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Update the video mode */</span>
<span class="k">static</span> <span class="kt">short</span> <span class="n">do_blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* (Un)Blank the screen */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_blanked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Is the screen blanked? */</span>

<span class="cp">#ifdef CONFIG_SH_STORE_QUEUES</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pvr2fb_map</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PVR2_DMA</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shdma</span> <span class="o">=</span> <span class="n">PVR2_CASCADE_CHAN</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pvr2dma</span> <span class="o">=</span> <span class="n">ONCHIP_NR_DMA_CHANNELS</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2fb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
                            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">get_line_length</span><span class="p">(</span><span class="kt">int</span> <span class="n">xres_virtual</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_color_bitfields</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2fb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pvr2_update_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pvr2_init_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pvr2_do_blank</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">pvr2fb_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_init_cable</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_get_param</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pvr2_params</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
                            <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PVR2_DMA</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">pvr2fb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">pvr2fb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">pvr2fb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">pvr2fb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">pvr2fb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">pvr2fb_set_par</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PVR2_DMA</span>
	<span class="p">.</span><span class="n">fb_write</span>	<span class="o">=</span> <span class="n">pvr2fb_write</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">pvr2_modedb</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Broadcast video modes (PAL and NTSC).  I&#39;m unfamiliar with</span>
<span class="cm">     * PAL-M and PAL-N, but from what I&#39;ve read both modes parallel PAL and</span>
<span class="cm">     * NTSC, so it shouldn&#39;t be a problem (I hope).</span>
<span class="cm">     */</span>

    <span class="p">{</span>
	<span class="cm">/* 640x480 @ 60Hz interlaced (NTSC) */</span>
	<span class="s">&quot;ntsc_640x480i&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="n">TV_CLK</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>
	<span class="n">FB_SYNC_BROADCAST</span><span class="p">,</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
    <span class="p">},</span> <span class="p">{</span>
	<span class="cm">/* 640x240 @ 60Hz (NTSC) */</span>
	<span class="cm">/* XXX: Broken! Don&#39;t use... */</span>
	<span class="s">&quot;ntsc_640x240&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="n">TV_CLK</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span>
	<span class="n">FB_SYNC_BROADCAST</span><span class="p">,</span> <span class="n">FB_VMODE_YWRAP</span>
    <span class="p">},</span> <span class="p">{</span>
	<span class="cm">/* 640x480 @ 60hz (VGA) */</span>
	<span class="s">&quot;vga_640x480&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="n">VGA_CLK</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_YWRAP</span>
    <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define NUM_TOTAL_MODES  ARRAY_SIZE(pvr2_modedb)</span>

<span class="cp">#define DEFMODE_NTSC	0</span>
<span class="cp">#define DEFMODE_PAL	0</span>
<span class="cp">#define DEFMODE_VGA	2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">defmode</span> <span class="o">=</span> <span class="n">DEFMODE_NTSC</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pvr2fb_set_pal_type</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">fb_writel</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="mh">0x108</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pvr2fb_set_pal_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="mh">0x1000</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">regno</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_blank</span> <span class="o">=</span> <span class="n">blank</span> <span class="o">?</span> <span class="n">blank</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_line_length</span><span class="p">(</span><span class="kt">int</span> <span class="n">xres_virtual</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)((((</span><span class="n">xres_virtual</span><span class="o">*</span><span class="n">bpp</span><span class="p">)</span><span class="o">+</span><span class="mi">31</span><span class="p">)</span><span class="o">&amp;~</span><span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_color_bitfields</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="mi">16</span>:        <span class="cm">/* RGB 565 */</span>
		<span class="n">pvr2fb_set_pal_type</span><span class="p">(</span><span class="n">PAL_RGB565</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>    <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>   <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">24</span>:        <span class="cm">/* RGB 888 */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>    <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>   <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">32</span>:        <span class="cm">/* ARGB 8888 */</span>
		<span class="n">pvr2fb_set_pal_type</span><span class="p">(</span><span class="n">PAL_ARGB8888</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>    <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>   <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2fb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
                            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We only support the hardware palette for 16 and 32bpp. It&#39;s also</span>
<span class="cm">	 * expected that the palette format has been set by the time we get</span>
<span class="cm">	 * here, so we don&#39;t waste time setting it again.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="mi">16</span>: <span class="cm">/* RGB 565 */</span>
		<span class="n">tmp</span> <span class="o">=</span>  <span class="p">(</span><span class="n">red</span>   <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span>       <span class="o">|</span>
		      <span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">((</span><span class="n">blue</span>  <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>

		<span class="n">pvr2fb_set_pal_entry</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">24</span>: <span class="cm">/* RGB 888 */</span>
		<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">blue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">32</span>: <span class="cm">/* ARGB 8888 */</span>
		<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">transp</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">blue</span><span class="p">;</span>

		<span class="n">pvr2fb_set_pal_entry</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="nl">default:</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Invalid bit depth %d?!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="p">((</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2fb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">line_length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vtotal</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX: It&#39;s possible that a user could use a VGA box, change the cable</span>
<span class="cm">	 * type in hardware (i.e. switch from VGA&lt;-&gt;composite), then change</span>
<span class="cm">	 * modes (i.e. switching to another VT).  If that happens we should</span>
<span class="cm">	 * automagically change the output format to cope, but currently I</span>
<span class="cm">	 * don&#39;t have a VGA box to make sure this works properly.</span>
<span class="cm">	 */</span>
	<span class="n">cable_type</span> <span class="o">=</span> <span class="n">pvr2_init_cable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cable_type</span> <span class="o">==</span> <span class="n">CT_VGA</span> <span class="o">&amp;&amp;</span> <span class="n">video_output</span> <span class="o">!=</span> <span class="n">VO_VGA</span><span class="p">)</span>
		<span class="n">video_output</span> <span class="o">=</span> <span class="n">VO_VGA</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="n">FB_VMODE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">&amp;&amp;</span> <span class="n">video_output</span> <span class="o">!=</span> <span class="n">VO_VGA</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">is_interlaced</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * XXX: Need to be more creative with this (i.e. allow doublecan for</span>
<span class="cm">	 * PAL/NTSC output).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span> <span class="o">&amp;&amp;</span> <span class="n">video_output</span> <span class="o">==</span> <span class="n">VO_VGA</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">is_doublescan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hsync_total</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span>
	                   <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_total</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span>
	                   <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_BROADCAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vtotal</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_total</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">is_interlaced</span><span class="p">)</span>
			<span class="n">vtotal</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAL_VTOTAL</span> <span class="o">+</span> <span class="n">NTSC_VTOTAL</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* XXX: Check for start values here... */</span>
			<span class="cm">/* XXX: Check hardware for PAL-compatibility */</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_h</span> <span class="o">=</span> <span class="mi">116</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_v</span> <span class="o">=</span> <span class="mi">44</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* NTSC video output */</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_h</span> <span class="o">=</span> <span class="mi">126</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_v</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* VGA mode */</span>
		<span class="cm">/* XXX: What else needs to be checked? */</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX: We have a little freedom in VGA modes, what ranges</span>
<span class="cm">		 * should be here (i.e. hsync/vsync totals, etc.)?</span>
<span class="cm">		 */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_h</span> <span class="o">=</span> <span class="mi">126</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_v</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate the remainding offsets */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstart_h</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_h</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstart_v</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_v</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstop_h</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstart_h</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span>
			    <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstop_v</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstart_v</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span>
			    <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">is_interlaced</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstop_v</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="mi">640</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">is_lowres</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">line_length</span> <span class="o">=</span> <span class="n">get_line_length</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">disp_start</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">)</span> <span class="o">*</span> <span class="n">line_length</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">line_length</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vtotal</span><span class="p">,</span> <span class="n">hsync_total</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">line_length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">!=</span> <span class="n">TV_CLK</span> <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">!=</span> <span class="n">VGA_CLK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Invalid pixclock value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="mi">320</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="mi">240</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">set_color_bitfields</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">||</span>
			    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">||</span>
			    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX: Need to be more creative with this (i.e. allow doublecan for</span>
<span class="cm">	 * PAL/NTSC output).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="mi">480</span> <span class="o">&amp;&amp;</span> <span class="n">video_output</span> <span class="o">==</span> <span class="n">VO_VGA</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video_output</span> <span class="o">!=</span> <span class="n">VO_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_BROADCAST</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_SYNC_BROADCAST</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_INTERLACED</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FB_ACTIVATE_TEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstop_h</span> <span class="o">-</span>
				   <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstart_h</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span>  <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstart_h</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_h</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span>    <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_h</span> <span class="o">+</span>
		                   <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hsync_total</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstop_h</span><span class="p">);</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstart_v</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_v</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstop_v</span> <span class="o">-</span>
				   <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstart_v</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span>    <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstop_v</span> <span class="o">+</span>
				   <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_total</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstop_v</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hsync_total</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span>
		      <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">vtotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span>
		 <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_BROADCAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
			<span class="n">vtotal</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAL_VTOTAL</span> <span class="o">+</span> <span class="n">NTSC_VTOTAL</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PAL video output */</span>
			<span class="cm">/* XXX: Should be using a range here ... ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hsync_total</span> <span class="o">!=</span> <span class="n">PAL_HTOTAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid hsync total for PAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* NTSC video output */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hsync_total</span> <span class="o">!=</span> <span class="n">NTSC_HTOTAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid hsync total for NTSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check memory sizes */</span>
	<span class="n">line_length</span> <span class="o">=</span> <span class="n">get_line_length</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_update_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>

	<span class="cm">/* Update the start address of the display image */</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">disp_start</span><span class="p">,</span> <span class="n">DISP_DIWADDRL</span><span class="p">);</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">disp_start</span> <span class="o">+</span>
		  <span class="n">get_line_length</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="o">+</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">),</span>
	          <span class="n">DISP_DIWADDRS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the video mode.  Currently, the 16bpp and 24bpp modes aren&#39;t</span>
<span class="cm"> * very stable.  It&#39;s probably due to the fact that a lot of the 2D video</span>
<span class="cm"> * registers are still undocumented.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_init_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">diw_height</span><span class="p">,</span> <span class="n">diw_width</span><span class="p">,</span> <span class="n">diw_modulo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytesperpixel</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* hsync and vsync totals */</span>
	<span class="n">fb_writel</span><span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_total</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hsync_total</span><span class="p">,</span> <span class="n">DISP_SYNCSIZE</span><span class="p">);</span>

	<span class="cm">/* column height, modulo, row width */</span>
	<span class="cm">/* since we&#39;re &quot;panning&quot; within vram, we need to offset things based</span>
<span class="cm">	 * on the offset from the virtual x start to our real gfx. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_output</span> <span class="o">!=</span> <span class="n">VO_VGA</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">is_interlaced</span><span class="p">)</span>
		<span class="n">diw_modulo</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">diw_height</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">is_interlaced</span> <span class="o">?</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
	<span class="n">diw_width</span> <span class="o">=</span> <span class="n">get_line_length</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">fb_writel</span><span class="p">((</span><span class="n">diw_modulo</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">--</span><span class="n">diw_height</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="o">--</span><span class="n">diw_width</span><span class="p">,</span>
	          <span class="n">DISP_DIWSIZE</span><span class="p">);</span>

	<span class="cm">/* display address, long and short fields */</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">disp_start</span><span class="p">,</span> <span class="n">DISP_DIWADDRL</span><span class="p">);</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">disp_start</span> <span class="o">+</span>
	          <span class="n">get_line_length</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="o">+</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">),</span>
	          <span class="n">DISP_DIWADDRS</span><span class="p">);</span>

	<span class="cm">/* border horizontal, border vertical, border color */</span>
	<span class="n">fb_writel</span><span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_h</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstop_h</span><span class="p">,</span> <span class="n">DISP_BRDRHORZ</span><span class="p">);</span>
	<span class="n">fb_writel</span><span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstart_v</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">borderstop_v</span><span class="p">,</span> <span class="n">DISP_BRDRVERT</span><span class="p">);</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DISP_BRDRCOLR</span><span class="p">);</span>

	<span class="cm">/* display window start position */</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstart_h</span><span class="p">,</span> <span class="n">DISP_DIWHSTRT</span><span class="p">);</span>
	<span class="n">fb_writel</span><span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstart_v</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstart_v</span><span class="p">,</span> <span class="n">DISP_DIWVSTRT</span><span class="p">);</span>

	<span class="cm">/* misc. settings */</span>
	<span class="n">fb_writel</span><span class="p">((</span><span class="mh">0x16</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">is_lowres</span><span class="p">,</span> <span class="n">DISP_DIWCONF</span><span class="p">);</span>

	<span class="cm">/* clock doubler (for VGA), scan doubler, display enable */</span>
	<span class="n">fb_writel</span><span class="p">(((</span><span class="n">video_output</span> <span class="o">==</span> <span class="n">VO_VGA</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span>
	          <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">is_doublescan</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DISP_DIWMODE</span><span class="p">);</span>

	<span class="cm">/* bits per pixel */</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="n">fb_readl</span><span class="p">(</span><span class="n">DISP_DIWMODE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">--</span><span class="n">bytesperpixel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">DISP_DIWMODE</span><span class="p">);</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">DISP_PIXDEPTH</span><span class="p">);</span>

	<span class="cm">/* video enable, color sync, interlace,</span>
<span class="cm">	 * hsync and vsync polarity (currently unused) */</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="mh">0x100</span> <span class="o">|</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">is_interlaced</span> <span class="cm">/*|4*/</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">DISP_SYNCCONF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Simulate blanking by making the border cover the entire screen */</span>

<span class="cp">#define BLANK_BIT (1&lt;&lt;3)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_do_blank</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">currentpar</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">diwconf</span><span class="p">;</span>

	<span class="n">diwconf</span> <span class="o">=</span> <span class="n">fb_readl</span><span class="p">(</span><span class="n">DISP_DIWCONF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_blank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fb_writel</span><span class="p">(</span><span class="n">diwconf</span> <span class="o">|</span> <span class="n">BLANK_BIT</span><span class="p">,</span> <span class="n">DISP_DIWCONF</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fb_writel</span><span class="p">(</span><span class="n">diwconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BLANK_BIT</span><span class="p">,</span> <span class="n">DISP_DIWCONF</span><span class="p">);</span>

	<span class="n">is_blanked</span> <span class="o">=</span> <span class="n">do_blank</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">do_blank</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pvr2fb_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_vmode_pan</span> <span class="o">||</span> <span class="n">do_vmode_full</span><span class="p">)</span>
		<span class="n">pvr2_update_display</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_vmode_full</span><span class="p">)</span>
		<span class="n">pvr2_init_display</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_vmode_pan</span><span class="p">)</span>
		<span class="n">do_vmode_pan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_vmode_full</span><span class="p">)</span>
		<span class="n">do_vmode_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_do_blank</span><span class="p">();</span>
		<span class="n">do_blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Determine the cable type and initialize the cable output format.  Don&#39;t do</span>
<span class="cm"> * anything if the cable type has been overidden (via &quot;cable:XX&quot;).</span>
<span class="cm"> */</span>

<span class="cp">#define PCTRA 0xff80002c</span>
<span class="cp">#define PDTRA 0xff800030</span>
<span class="cp">#define VOUTC 0xa0702c00</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_init_cable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cable_type</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_writel</span><span class="p">((</span><span class="n">fb_readl</span><span class="p">(</span><span class="n">PCTRA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff0ffff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000a0000</span><span class="p">,</span>
	                  <span class="n">PCTRA</span><span class="p">);</span>
		<span class="n">cable_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">fb_readw</span><span class="p">(</span><span class="n">PDTRA</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now select the output format (either composite or other) */</span>
	<span class="cm">/* XXX: Save the previous val first, as this reg is also AICA</span>
<span class="cm">	  related */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cable_type</span> <span class="o">==</span> <span class="n">CT_COMPOSITE</span><span class="p">)</span>
		<span class="n">fb_writel</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">VOUTC</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cable_type</span> <span class="o">==</span> <span class="n">CT_RGB</span><span class="p">)</span>
		<span class="n">fb_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span> <span class="n">VOUTC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fb_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VOUTC</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cable_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PVR2_DMA</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pvr2fb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dst</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nr_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">pages</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">nr_pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pages</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_user_pages</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span>
			     <span class="n">nr_pages</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_configure_channel</span><span class="p">(</span><span class="n">shdma</span><span class="p">,</span> <span class="mh">0x12c1</span><span class="p">);</span>

	<span class="n">dst</span>   <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">page_address</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">end</span>   <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">page_address</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">nr_pages</span><span class="p">]);</span>
	<span class="n">len</span>   <span class="o">=</span> <span class="n">nr_pages</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Half-assed contig check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">len</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* As we do this in one shot, it&#39;s either all or nothing.. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppos</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dma_write</span><span class="p">(</span><span class="n">shdma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">dma_write</span><span class="p">(</span><span class="n">pvr2dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">dma_wait_for_completion</span><span class="p">(</span><span class="n">pvr2dma</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Not contiguous, writeout per-page instead.. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">dst</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppos</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dma_write_page</span><span class="p">(</span><span class="n">shdma</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">page_address</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dma_write_page</span><span class="p">(</span><span class="n">pvr2dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
		<span class="n">dma_wait_for_completion</span><span class="p">(</span><span class="n">pvr2dma</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">out_unmap:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pages</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PVR2_DMA */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * pvr2fb_common_init</span>
<span class="cm"> *</span>
<span class="cm"> * Common init code for the PVR2 chips.</span>
<span class="cm"> *</span>
<span class="cm"> * This mostly takes care of the common aspects of the fb setup and</span>
<span class="cm"> * registration. It&#39;s expected that the board-specific init code has</span>
<span class="cm"> * already setup pvr2_fix with something meaningful at this point.</span>
<span class="cm"> *</span>
<span class="cm"> * Device info reporting is also done here, as well as picking a sane</span>
<span class="cm"> * default from the modedb. For board-specific modelines, simply define</span>
<span class="cm"> * a per-board modedb.</span>
<span class="cm"> *</span>
<span class="cm"> * Also worth noting is that the cable and video output types are likely</span>
<span class="cm"> * always going to be VGA for the PCI-based PVR2 boards, but we leave this</span>
<span class="cm"> * in for flexibility anyways. Who knows, maybe someone has tv-out on a</span>
<span class="cm"> * PCI-based version of these things ;-)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pvr2fb_common_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">currentpar</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">modememused</span><span class="p">,</span> <span class="n">rev</span><span class="p">;</span>

	<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pvr2_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
					       <span class="n">pvr2_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pvr2fb: Failed to remap smem space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pvr2_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span>
							<span class="n">pvr2_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pvr2fb: Failed to remap mmio space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_memset</span><span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pvr2_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>

	<span class="n">pvr2_fix</span><span class="p">.</span><span class="n">ypanstep</span>	<span class="o">=</span> <span class="n">nopan</span>  <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pvr2_fix</span><span class="p">.</span><span class="n">ywrapstep</span>	<span class="o">=</span> <span class="n">nowrap</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fbops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pvr2fb_ops</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fix</span>		<span class="o">=</span> <span class="n">pvr2_fix</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">par</span>		<span class="o">=</span> <span class="n">currentpar</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span>	<span class="o">=</span> <span class="n">currentpar</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video_output</span> <span class="o">==</span> <span class="n">VO_VGA</span><span class="p">)</span>
		<span class="n">defmode</span> <span class="o">=</span> <span class="n">DEFMODE_VGA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_option</span><span class="p">)</span>
		<span class="n">mode_option</span> <span class="o">=</span> <span class="s">&quot;640x480@60&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="n">pvr2_modedb</span><span class="p">,</span>
	                  <span class="n">NUM_TOTAL_MODES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvr2_modedb</span><span class="p">[</span><span class="n">defmode</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">pvr2_var</span><span class="p">;</span>

	<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">fb_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="cm">/*Must write PIXDEPTH to register before anything is displayed - so force init */</span>
	<span class="n">pvr2_init_display</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>

	<span class="n">modememused</span> <span class="o">=</span> <span class="n">get_line_length</span><span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">,</span>
				      <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="n">modememused</span> <span class="o">*=</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="n">rev</span> <span class="o">=</span> <span class="n">fb_readl</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fb%d: %s (rev %ld.%ld) frame buffer device, using %ldk/%ldk of video memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>
	       <span class="n">modememused</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fb%d: Mode %dx%d-%d pitch = %ld cable: %s video output: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span>
	       <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
	       <span class="n">get_line_length</span><span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">),</span>
	       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pvr2_get_param</span><span class="p">(</span><span class="n">cables</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cable_type</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pvr2_get_param</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">video_output</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_SH_STORE_QUEUES</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;fb%d: registering with SQ API</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="n">pvr2fb_map</span> <span class="o">=</span> <span class="n">sq_remap</span><span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
			      <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">PAGE_SHARED</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;fb%d: Mapped video memory to SQ addr 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">pvr2fb_map</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SH_DREAMCAST</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pvr2fb_dc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mach_is_dreamcast</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Make a guess at the monitor based on the attached cable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvr2_init_cable</span><span class="p">()</span> <span class="o">==</span> <span class="n">CT_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="mi">70000</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Not VGA, using a TV (taken from acornfb) */</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="mi">15469</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="mi">15781</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="mi">49</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="mi">51</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX: This needs to pull default video output via BIOS or other means</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_output</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cable_type</span> <span class="o">==</span> <span class="n">CT_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">video_output</span> <span class="o">=</span> <span class="n">VO_VGA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">video_output</span> <span class="o">=</span> <span class="n">VO_NTSC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Nothing exciting about the DC PVR2 .. only a measly 8MiB.</span>
<span class="cm">	 */</span>
	<span class="n">pvr2_fix</span><span class="p">.</span><span class="n">smem_start</span>	<span class="o">=</span> <span class="mh">0xa5000000</span><span class="p">;</span>	<span class="cm">/* RAM starts here */</span>
	<span class="n">pvr2_fix</span><span class="p">.</span><span class="n">smem_len</span>	<span class="o">=</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>

	<span class="n">pvr2_fix</span><span class="p">.</span><span class="n">mmio_start</span>	<span class="o">=</span> <span class="mh">0xa05f8000</span><span class="p">;</span>	<span class="cm">/* registers start here */</span>
	<span class="n">pvr2_fix</span><span class="p">.</span><span class="n">mmio_len</span>	<span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">HW_EVENT_VSYNC</span><span class="p">,</span> <span class="n">pvr2fb_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
	                <span class="s">&quot;pvr2 VBL handler&quot;</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PVR2_DMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">pvr2dma</span><span class="p">,</span> <span class="s">&quot;pvr2&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">HW_EVENT_VSYNC</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">pvr2fb_common_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pvr2fb_dc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">currentpar</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">currentpar</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>
		<span class="n">currentpar</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">HW_EVENT_VSYNC</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PVR2_DMA</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">pvr2dma</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SH_DREAMCAST */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pvr2fb_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pvr2fb: PCI enable failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;pvr2fb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pvr2fb: PCI request regions failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Slightly more exciting than the DC PVR2 .. 16MiB!</span>
<span class="cm">	 */</span>
	<span class="n">pvr2_fix</span><span class="p">.</span><span class="n">smem_start</span>	<span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pvr2_fix</span><span class="p">.</span><span class="n">smem_len</span>	<span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pvr2_fix</span><span class="p">.</span><span class="n">mmio_start</span>	<span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pvr2_fix</span><span class="p">.</span><span class="n">mmio_len</span>	<span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">device</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pvr2fb_common_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">pvr2fb_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">currentpar</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">currentpar</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>
		<span class="n">currentpar</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pvr2fb_pci_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_NEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NEC_NEON250</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pvr2fb_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">pvr2fb_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pvr2fb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pvr2fb_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pvr2fb_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pvr2fb_pci_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pvr2fb_pci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvr2fb_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pvr2fb_pci_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvr2fb_pci_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pvr2_get_param</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pvr2_params</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
                                   <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse command arguments.  Supported arguments are:</span>
<span class="cm"> *    inverse                             Use inverse color maps</span>
<span class="cm"> *    cable:composite|rgb|vga             Override the video cable type</span>
<span class="cm"> *    output:NTSC|PAL|VGA                 Override the video output format</span>
<span class="cm"> *</span>
<span class="cm"> *    &lt;xres&gt;x&lt;yres&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]   or,</span>
<span class="cm"> *    &lt;name&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]          Startup using this video mode</span>
<span class="cm"> */</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pvr2fb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cable_arg</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">output_arg</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;inverse&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fb_invert_cmaps</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;cable:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">cable_arg</span><span class="p">,</span> <span class="n">this_opt</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;output:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">output_arg</span><span class="p">,</span> <span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nopan&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nopan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nowrap&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nowrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cable_arg</span><span class="p">)</span>
		<span class="n">cable_type</span> <span class="o">=</span> <span class="n">pvr2_get_param</span><span class="p">(</span><span class="n">cables</span><span class="p">,</span> <span class="n">cable_arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">output_arg</span><span class="p">)</span>
		<span class="n">video_output</span> <span class="o">=</span> <span class="n">pvr2_get_param</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">output_arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pvr2_board</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">exit</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">board_driver</span><span class="p">[]</span> <span class="n">__refdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SH_DREAMCAST</span>
	<span class="p">{</span> <span class="n">pvr2fb_dc_init</span><span class="p">,</span> <span class="n">pvr2fb_dc_exit</span><span class="p">,</span> <span class="s">&quot;Sega DC PVR2&quot;</span> <span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="p">{</span> <span class="n">pvr2fb_pci_init</span><span class="p">,</span> <span class="n">pvr2fb_pci_exit</span><span class="p">,</span> <span class="s">&quot;PCI PVR2&quot;</span> <span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pvr2fb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;pvr2fb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">pvr2fb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2fb_par</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="n">fb_info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2fb_par</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to allocate memory for fb_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">currentpar</span> <span class="o">=</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">board_driver</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pvr2_board</span> <span class="o">*</span><span class="n">pvr_board</span> <span class="o">=</span> <span class="n">board_driver</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvr_board</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr_board</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pvr2fb: Failed init of %s device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pvr_board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pvr2fb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">board_driver</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pvr2_board</span> <span class="o">*</span><span class="n">pvr_board</span> <span class="o">=</span> <span class="n">board_driver</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pvr_board</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
			<span class="n">pvr_board</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">();</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SH_STORE_QUEUES</span>
	<span class="n">sq_unmap</span><span class="p">(</span><span class="n">pvr2fb_map</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pvr2fb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pvr2fb_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Paul Mundt &lt;lethal@linux-sh.org&gt;, M. R. Brown &lt;mrbrown@0xd6.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Framebuffer driver for NEC PowerVR 2 based graphics boards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
