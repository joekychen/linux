<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › mb862xx › mb862xxfbdrv.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mb862xxfbdrv.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/mb862xx/mb862xxfb.c</span>
<span class="cm"> *</span>
<span class="cm"> * Fujitsu Carmine/Coral-P(A)/Lime framebuffer driver</span>
<span class="cm"> *</span>
<span class="cm"> * (C) 2008 Anatolij Gustschin &lt;agust@denx.de&gt;</span>
<span class="cm"> * DENX Software Engineering</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#if defined(CONFIG_OF)</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &quot;mb862xxfb.h&quot;</span>
<span class="cp">#include &quot;mb862xx_reg.h&quot;</span>

<span class="cp">#define NR_PALETTE		256</span>
<span class="cp">#define MB862XX_MEM_SIZE	0x1000000</span>
<span class="cp">#define CORALP_MEM_SIZE		0x2000000</span>
<span class="cp">#define CARMINE_MEM_SIZE	0x8000000</span>
<span class="cp">#define DRV_NAME		&quot;mb862xxfb&quot;</span>

<span class="cp">#if defined(CONFIG_SOCRATES)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mb862xx_gc_mode</span> <span class="n">socrates_gc_mode</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Mode for Prime View PM070WL4 TFT LCD Panel */</span>
	<span class="p">{</span> <span class="s">&quot;800x480&quot;</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">40000</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* 16 bits/pixel, 16MB, 133MHz, SDRAM memory mode value */</span>
	<span class="mi">16</span><span class="p">,</span> <span class="mh">0x1000000</span><span class="p">,</span> <span class="n">GC_CCF_COT_133</span><span class="p">,</span> <span class="mh">0x4157ba63</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* Helpers */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">h_total</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">v_total</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">vsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">d_pitch</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">chan_to_field</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">fb_bitfield</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mb862xxfb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span>  <span class="o">=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">red</span><span class="p">,</span>   <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">);</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0PAL0</span> <span class="o">+</span> <span class="p">(</span><span class="n">regno</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* unsupported type */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mb862xxfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* check if these values fit into the registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h_total</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="o">||</span> <span class="n">v_total</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * can cope with 8,16 or 24/32bpp if resulting</span>
<span class="cm">	 * pitch is divisible by 64 without remainder</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d_pitch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">)</span> <span class="o">%</span> <span class="n">GC_L0M_L0W_UNIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">d_pitch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">)</span> <span class="o">%</span> <span class="n">GC_L0M_L0W_UNIT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d_pitch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">)</span> <span class="o">%</span> <span class="n">GC_L0M_L0W_UNIT</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* line length is going to be 128 bit aligned */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* set r/g/b positions and validate bpp */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set display parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mb862xxfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span> <span class="n">sc</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BT_CORALP</span><span class="p">)</span>
		<span class="n">mb862xxfb_init_accel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pre_init</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* disp off */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GC_DCM01_DEN</span><span class="p">;</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* set display reference clock div. */</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">refclk</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GC_DCM01_CKS</span> <span class="o">|</span> <span class="n">GC_DCM01_RESV</span> <span class="o">|</span> <span class="n">GC_DCM01_SC</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">sc</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SC 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sc</span><span class="p">);</span>

	<span class="cm">/* disp dimension, format */</span>
	<span class="n">reg</span> <span class="o">=</span>  <span class="n">pack</span><span class="p">(</span><span class="n">d_pitch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">)</span> <span class="o">/</span> <span class="n">GC_L0M_L0W_UNIT</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">GC_L0M_L0C_16</span><span class="p">;</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0M</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0EM</span><span class="p">);</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0EM</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">GC_L0EM_L0EC_24</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_WY_WX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_WH_WW</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0OA0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0DA0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0DY_L0DX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0WY_L0WX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0WH_L0WW</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* both HW-cursors off */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_CPM_CUTC</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GC_CPM_CEN0</span> <span class="o">|</span> <span class="n">GC_CPM_CEN1</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_CPM_CUTC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* timings */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_HDB_HDP</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">pack</span><span class="p">((</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">vsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">));</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_VDP_VSP</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">((</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
	      <span class="n">pack</span><span class="p">((</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">hsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">));</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_VSW_HSW_HSP</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_HTP</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="n">h_total</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_VTR</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="n">v_total</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* display on */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">GC_DCM01_DEN</span> <span class="o">|</span> <span class="n">GC_DCM01_L0E</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GC_DCM01_ESY</span><span class="p">;</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mb862xxfb_pan</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0WY_L0WX</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0WH_L0WW</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mb862xxfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span>  <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;blank mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GC_DCM01_DEN</span><span class="p">;</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">GC_DCM01_DEN</span><span class="p">;</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mb862xxfb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mb862xx_l1_cfg</span> <span class="o">*</span><span class="n">l1_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_cfg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l1em</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MB862XX_L1_GET_CFG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">l1_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">l1_cfg</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MB862XX_L1_SET_CFG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">l1_cfg</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">l1_cfg</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sw</span> <span class="o">&gt;=</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">&gt;=</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dh</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* downscaling */</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_CSC</span><span class="p">,</span>
				<span class="n">pack</span><span class="p">((</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">/</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dh</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sw</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">/</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">));</span>
			<span class="n">l1em</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L1EM</span><span class="p">);</span>
			<span class="n">l1em</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GC_L1EM_DM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sw</span> <span class="o">&lt;=</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">&lt;=</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dh</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* upscaling */</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_CSC</span><span class="p">,</span>
				<span class="n">pack</span><span class="p">((</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">/</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dh</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sw</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">/</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">));</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_CMSS</span><span class="p">,</span>
				<span class="n">pack</span><span class="p">(</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sw</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">));</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_CMDS</span><span class="p">,</span>
				<span class="n">pack</span><span class="p">(</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dw</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dh</span><span class="p">));</span>
			<span class="n">l1em</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L1EM</span><span class="p">);</span>
			<span class="n">l1em</span> <span class="o">|=</span> <span class="n">GC_L1EM_DM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">mirror</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_CBM</span><span class="p">,</span>
				<span class="n">inreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_CBM</span><span class="p">)</span> <span class="o">|</span> <span class="n">GC_CBM_HRV</span><span class="p">);</span>
			<span class="n">l1em</span> <span class="o">|=</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dw</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_CBM</span><span class="p">,</span>
				<span class="n">inreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_CBM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GC_CBM_HRV</span><span class="p">);</span>
			<span class="n">l1em</span> <span class="o">&amp;=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L1EM</span><span class="p">,</span> <span class="n">l1em</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MB862XX_L1_ENABLE</span>:
		<span class="n">enable</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L1DA</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cap_buf</span><span class="p">);</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_IMG_START</span><span class="p">,</span>
				<span class="n">pack</span><span class="p">(</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sx</span><span class="p">));</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_IMG_END</span><span class="p">,</span>
				<span class="n">pack</span><span class="p">(</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">,</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">sw</span><span class="p">));</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L1M</span><span class="p">,</span> <span class="n">GC_L1M_16</span> <span class="o">|</span> <span class="n">GC_L1M_YC</span> <span class="o">|</span> <span class="n">GC_L1M_CS</span> <span class="o">|</span>
					     <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_stride</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L1WY_L1WX</span><span class="p">,</span>
				<span class="n">pack</span><span class="p">(</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">));</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L1WH_L1WW</span><span class="p">,</span>
				<span class="n">pack</span><span class="p">(</span><span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l1_cfg</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">));</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DLS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_VCM</span><span class="p">,</span>
				<span class="n">GC_VCM_VIE</span> <span class="o">|</span> <span class="n">GC_VCM_CM</span> <span class="o">|</span> <span class="n">GC_VCM_VS_PAL</span><span class="p">);</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">,</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">)</span> <span class="o">|</span>
					      <span class="n">GC_DCM1_DEN</span> <span class="o">|</span> <span class="n">GC_DCM1_L1E</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_VCM</span><span class="p">,</span>
				<span class="n">inreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_VCM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GC_VCM_VIE</span><span class="p">);</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">,</span>
				<span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GC_DCM1_L1E</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MB862XX_L1_CAP_CTL</span>:
		<span class="n">enable</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_VCM</span><span class="p">,</span>
				<span class="n">inreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_VCM</span><span class="p">)</span> <span class="o">|</span> <span class="n">GC_VCM_VIE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_VCM</span><span class="p">,</span>
				<span class="n">inreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_VCM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GC_VCM_VIE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* framebuffer ops */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">mb862xxfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">mb862xxfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">mb862xxfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">mb862xxfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">mb862xxfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">mb862xxfb_pan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span>	<span class="o">=</span> <span class="n">mb862xxfb_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* initialize fb_info data */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mb862xxfb_init_fbinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mb862xx_gc_mode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">gc_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stride</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mb862xxfb_ops</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">GC_DCM01_DEN</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">GC_DCM01_L0E</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get the disp mode from active display cfg */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sc</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">GC_DCM01_SC</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hsp</span><span class="p">,</span> <span class="n">vsp</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">vt</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using bootloader&#39;s disp. mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">/</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">refclk</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_HDB_HDP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_VDP_VSP</span><span class="p">);</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vsp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0EM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">GC_L0EM_L0EC_24</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_L0M</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">GC_L0M_L0C_16</span><span class="p">)</span>
				<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_VSW_HSW_HSP</span><span class="p">);</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x3f000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hsp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ht</span> <span class="o">=</span> <span class="p">((</span><span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_HTP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">hsp</span> <span class="o">-</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">ht</span> <span class="o">-</span> <span class="n">hsp</span> <span class="o">-</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">;</span>
		<span class="n">vt</span> <span class="o">=</span> <span class="p">((</span><span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_VTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">vsp</span> <span class="o">-</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">vt</span> <span class="o">-</span> <span class="n">vsp</span> <span class="o">-</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using supplied mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fb_videomode_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="p">)</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">def_bpp</span> <span class="o">?</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">def_bpp</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">fbi</span><span class="p">,</span> <span class="s">&quot;640x480-16@60&quot;</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to get initial mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
		     <span class="n">FBINFO_FOREIGN_ENDIAN</span> <span class="o">|</span>
<span class="cp">#endif</span>
		     <span class="n">FBINFO_HWACCEL_XPAN</span> <span class="o">|</span>
		     <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>

	<span class="cm">/* check and possibly fix bpp */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_check_var</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">fbi</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;check_var() failed on initial setup?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span>
			 <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span>
				<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * reserve space for capture buffers and two cursors</span>
<span class="cm">	 * at the end of vram: 720x576 * 2 * 2.2 + 64x64 * 16.</span>
<span class="cm">	 */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cap_buf</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span> <span class="o">-</span> <span class="mh">0x1bd800</span> <span class="o">-</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cap_len</span> <span class="o">=</span> <span class="mh">0x1bd800</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_cfg</span><span class="p">.</span><span class="n">sx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_cfg</span><span class="p">.</span><span class="n">sy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_cfg</span><span class="p">.</span><span class="n">sw</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_cfg</span><span class="p">.</span><span class="n">sh</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_cfg</span><span class="p">.</span><span class="n">dx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_cfg</span><span class="p">.</span><span class="n">dy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_cfg</span><span class="p">.</span><span class="n">dw</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_cfg</span><span class="p">.</span><span class="n">dh</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
	<span class="n">stride</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_cfg</span><span class="p">.</span><span class="n">sw</span> <span class="o">*</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_stride</span> <span class="o">=</span> <span class="n">stride</span> <span class="o">/</span> <span class="mi">64</span> <span class="o">+</span> <span class="p">((</span><span class="n">stride</span> <span class="o">%</span> <span class="mi">64</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_CBM</span><span class="p">,</span> <span class="n">GC_CBM_OO</span> <span class="o">|</span> <span class="n">GC_CBM_CBST</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">l1_stride</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_CBOA</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cap_buf</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">GC_CAP_CBLA</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cap_buf</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cap_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * show some display controller and cursor registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mb862xxfb_show_dispregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="n">GC_DCM0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">GC_L0DY_L0DX</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;%08x = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="n">GC_CPM_CUTC</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">GC_CUY1_CUX1</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;%08x = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="n">GC_DCM1</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">GC_L0WH_L0WW</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;%08x = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x410</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;geo %08x = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">inreg</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x410</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;draw %08x = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">inreg</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mh">0x440</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x450</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;draw %08x = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">inreg</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">dispregs</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">mb862xxfb_show_dispregs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mb862xx_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_ist</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BT_CARMINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get Interrupt Status */</span>
		<span class="n">reg_ist</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">GC_CTRL_STATUS</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">GC_CTRL_INT_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_ist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="n">reg_ist</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_ist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="cm">/* Clear interrupt status */</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">reg_ist</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Get status */</span>
		<span class="n">reg_ist</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_IST</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_IMASK</span><span class="p">);</span>

		<span class="n">reg_ist</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_ist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="cm">/* Clear status */</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_IST</span><span class="p">,</span> <span class="o">~</span><span class="n">reg_ist</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_FB_MB862XX_LIME)</span>
<span class="cm">/*</span>
<span class="cm"> * GDC (Lime, Coral(B/Q), Mint, ...) on host bus</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mb862xx_gdc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ccf</span><span class="p">,</span> <span class="n">mmr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ver</span><span class="p">,</span> <span class="n">rev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_FB_PRE_INIT_FB)</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pre_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_I2C_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">disp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_DISP_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_CAP_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">draw</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_DRAW_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">geo</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_GEO_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pio</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_PIO_BASE</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">refclk</span> <span class="o">=</span> <span class="n">GC_DISP_REFCLK_400</span><span class="p">;</span>

	<span class="n">ver</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_CID</span><span class="p">);</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">pio</span><span class="p">,</span> <span class="n">GC_REVISION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ver</span> <span class="o">==</span> <span class="mh">0x303</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x20050100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fujitsu Lime v1.%d found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">BT_LIME</span><span class="p">;</span>
		<span class="n">ccf</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">gc_mode</span> <span class="o">?</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">gc_mode</span><span class="o">-&gt;</span><span class="n">ccf</span> <span class="o">:</span> <span class="n">GC_CCF_COT_100</span><span class="p">;</span>
		<span class="n">mmr</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">gc_mode</span> <span class="o">?</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">gc_mode</span><span class="o">-&gt;</span><span class="n">mmr</span> <span class="o">:</span> <span class="mh">0x414fb7f2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;? GDC, CID/Rev.: 0x%lx/0x%lx </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pre_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_CCF</span><span class="p">,</span> <span class="n">ccf</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_MMR</span><span class="p">,</span> <span class="n">mmr</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* interrupt status */</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_IST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_IMASK</span><span class="p">,</span> <span class="n">GC_INT_EN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">of_platform_mb862xx_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">res_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mb862xxfb_par</span><span class="p">),</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot allocate framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to map irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fbrel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot claim framebuffer/mmio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">irqdisp</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if defined(CONFIG_SOCRATES)</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">gc_mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socrates_gc_mode</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">MB862XX_MMIO_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">MB862XX_MMIO_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">gc_mode</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">gc_mode</span><span class="o">-&gt;</span><span class="n">max_vram</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span> <span class="o">=</span> <span class="n">MB862XX_MEM_SIZE</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot map framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot map registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fb_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fb phys 0x%llx 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mmio phys 0x%llx 0x%lx, (irq = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mb862xx_gdc_init</span><span class="p">(</span><span class="n">par</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">io_unmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mb862xx_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">DRV_NAME</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot request irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">io_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mb862xxfb_init_fbinfo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">NR_PALETTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not allocate cmap for fb_info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_set_par</span><span class="p">)(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set_var() failed on initial setup?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_cmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dispregs</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t create sysfs regdump file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">rel_cmap:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">free_irq:</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_IMASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="p">);</span>
<span class="nl">io_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>
<span class="nl">fb_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base</span><span class="p">);</span>
<span class="nl">rel_reg:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">);</span>
<span class="nl">irqdisp:</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="nl">fbrel:</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">of_platform_mb862xx_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">res_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/* display off */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GC_DCM01_DEN</span> <span class="o">|</span> <span class="n">GC_DCM01_L0E</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_IMASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="p">);</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dispregs</span><span class="p">);</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * common types</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">__devinitdata</span> <span class="n">of_platform_mb862xx_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fujitsu,MB86276&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fujitsu,lime&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fujitsu,MB86277&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fujitsu,mint&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fujitsu,MB86293&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fujitsu,MB86294&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fujitsu,coral&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* end */</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">of_platform_mb862xxfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">of_platform_mb862xx_tbl</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">of_platform_mb862xx_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">of_platform_mb862xx_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_FB_MB862XX_PCI_GDC)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">coralp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cn</span><span class="p">,</span> <span class="n">ver</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_I2C_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">disp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_DISP_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_CAP_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">draw</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_DRAW_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">geo</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_GEO_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pio</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB862XX_PIO_BASE</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">refclk</span> <span class="o">=</span> <span class="n">GC_DISP_REFCLK_400</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span> <span class="o">&gt;=</span> <span class="mh">0x2000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* relocate gdc registers space */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base</span> <span class="o">+</span> <span class="n">MB862XX_MMIO_BASE</span> <span class="o">+</span> <span class="n">GC_RSW</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* wait at least 20 bus cycles */</span>
	<span class="p">}</span>

	<span class="n">ver</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_CID</span><span class="p">);</span>
	<span class="n">cn</span> <span class="o">=</span> <span class="p">(</span><span class="n">ver</span> <span class="o">&amp;</span> <span class="n">GC_CID_CNAME_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ver</span> <span class="o">=</span> <span class="n">ver</span> <span class="o">&amp;</span> <span class="n">GC_CID_VERSION_MSK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cn</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fujitsu Coral-%s GDC Rev.%d found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>\
			 <span class="p">(</span><span class="n">ver</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;P&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">ver</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;PA&quot;</span> <span class="o">:</span> <span class="s">&quot;?&quot;</span><span class="p">,</span>
			 <span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">GC_DCM01_DEN</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">GC_DCM01_L0E</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pre_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pre_init</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_CCF</span><span class="p">,</span> <span class="n">GC_CCF_CGE_166</span> <span class="o">|</span> <span class="n">GC_CCF_COT_133</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
			<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_MMR</span><span class="p">,</span> <span class="n">GC_MMR_CORALP_EVB_VAL</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Clear interrupt status */</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_IST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mb862xx_i2c_init</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_dram_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set io mode first! Spec. says IC may be destroyed</span>
<span class="cm">	 * if not set to SSTL2/LVCMOS before init.</span>
<span class="cm">	 */</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">dram_ctrl</span><span class="p">,</span> <span class="n">GC_DCTL_IOCONT1_IOCONT0</span><span class="p">,</span> <span class="n">GC_EVB_DCTL_IOCONT1_IOCONT0</span><span class="p">);</span>

	<span class="cm">/* DRAM init */</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">dram_ctrl</span><span class="p">,</span> <span class="n">GC_DCTL_MODE_ADD</span><span class="p">,</span> <span class="n">GC_EVB_DCTL_MODE_ADD</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">dram_ctrl</span><span class="p">,</span> <span class="n">GC_DCTL_SETTIME1_EMODE</span><span class="p">,</span> <span class="n">GC_EVB_DCTL_SETTIME1_EMODE</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">dram_ctrl</span><span class="p">,</span> <span class="n">GC_DCTL_REFRESH_SETTIME2</span><span class="p">,</span>
	       <span class="n">GC_EVB_DCTL_REFRESH_SETTIME2</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">dram_ctrl</span><span class="p">,</span> <span class="n">GC_DCTL_RSV2_RSV1</span><span class="p">,</span> <span class="n">GC_EVB_DCTL_RSV2_RSV1</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">dram_ctrl</span><span class="p">,</span> <span class="n">GC_DCTL_DDRIF2_DDRIF1</span><span class="p">,</span> <span class="n">GC_EVB_DCTL_DDRIF2_DDRIF1</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">dram_ctrl</span><span class="p">,</span> <span class="n">GC_DCTL_RSV0_STATES</span><span class="p">,</span> <span class="n">GC_EVB_DCTL_RSV0_STATES</span><span class="p">);</span>

	<span class="cm">/* DLL reset done? */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">inreg</span><span class="p">(</span><span class="n">dram_ctrl</span><span class="p">,</span> <span class="n">GC_DCTL_RSV0_STATES</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GC_DCTL_STATES_MSK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">GC_DCTL_INIT_WAIT_INTERVAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">GC_DCTL_INIT_WAIT_CNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VRAM init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">dram_ctrl</span><span class="p">,</span> <span class="n">GC_DCTL_MODE_ADD</span><span class="p">,</span> <span class="n">GC_EVB_DCTL_MODE_ADD_AFT_RST</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">dram_ctrl</span><span class="p">,</span> <span class="n">GC_DCTL_RSV0_STATES</span><span class="p">,</span> <span class="n">GC_EVB_DCTL_RSV0_STATES_AFT_RST</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carmine_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB86297_CTRL_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB86297_I2C_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">disp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB86297_DISP0_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">disp1</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB86297_DISP1_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB86297_CAP0_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cap1</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB86297_CAP1_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">draw</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB86297_DRAW_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dram_ctrl</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB86297_DRAMCTRL_BASE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">wrback</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MB86297_WRBACK_BASE</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">refclk</span> <span class="o">=</span> <span class="n">GC_DISP_REFCLK_533</span><span class="p">;</span>

	<span class="cm">/* warm up */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">GC_CTRL_CLK_EN_DRAM</span> <span class="o">|</span> <span class="n">GC_CTRL_CLK_EN_2D3D</span> <span class="o">|</span> <span class="n">GC_CTRL_CLK_EN_DISP0</span><span class="p">;</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">GC_CTRL_CLK_ENABLE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* check for engine module revision */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inreg</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">GC_2D3D_REV</span><span class="p">)</span> <span class="o">==</span> <span class="n">GC_RE_REVISION</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fujitsu Carmine GDC Rev.%d found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GC_CTRL_CLK_EN_2D3D</span><span class="p">;</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">GC_CTRL_CLK_ENABLE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* set up vram */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_dram_ctrl</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>

	<span class="n">outreg</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">GC_CTRL_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_init:</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">GC_CTRL_CLK_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mb862xx_pci_gdc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BT_CORALP</span>:
		<span class="k">return</span> <span class="n">coralp_init</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BT_CARMINE</span>:
		<span class="k">return</span> <span class="n">carmine_init</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define CHIP_ID(id)	\</span>
<span class="cp">	{ PCI_DEVICE(PCI_VENDOR_ID_FUJITSU_LIMITED, id) }</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">mb862xx_pci_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MB86295/MB86296 */</span>
	<span class="n">CHIP_ID</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_FUJITSU_CORALP</span><span class="p">),</span>
	<span class="n">CHIP_ID</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_FUJITSU_CORALPA</span><span class="p">),</span>
	<span class="cm">/* MB86297 */</span>
	<span class="n">CHIP_ID</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_FUJITSU_CARMINE</span><span class="p">),</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">mb862xx_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mb862xx_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mb862xxfb_par</span><span class="p">),</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;framebuffer alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">dis_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot reserve region(s) for PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_fb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_FUJITSU_CORALP</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_FUJITSU_CORALPA</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span> <span class="o">=</span> <span class="n">CORALP_MEM_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span> <span class="o">&gt;=</span> <span class="mh">0x2000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span> <span class="o">+</span>
					      <span class="n">MB862XX_MMIO_HIGH_BASE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span> <span class="o">+</span>
					      <span class="n">MB862XX_MMIO_BASE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">MB862XX_MMIO_SIZE</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">BT_CORALP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_FUJITSU_CARMINE</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span> <span class="o">=</span> <span class="n">CARMINE_MEM_SIZE</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">BT_CARMINE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* should never occur */</span>
		<span class="k">goto</span> <span class="n">rel_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot map framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot map registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fb_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fb phys 0x%llx 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base_phys</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mapped_vram</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mmio phys 0x%llx 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mb862xx_pci_gdc_init</span><span class="p">(</span><span class="n">par</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">io_unmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mb862xx_intr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">DRV_NAME</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot request irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">io_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mb862xxfb_init_fbinfo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">NR_PALETTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not allocate cmap for fb_info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_set_par</span><span class="p">)(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set_var() failed on initial setup?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_cmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dispregs</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t create sysfs regdump file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BT_CARMINE</span><span class="p">)</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">GC_CTRL_INT_MASK</span><span class="p">,</span> <span class="n">GC_CARMINE_INT_EN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_IMASK</span><span class="p">,</span> <span class="n">GC_INT_EN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">rel_cmap:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="p">);</span>
<span class="nl">io_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>
<span class="nl">fb_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base</span><span class="p">);</span>
<span class="nl">rel_reg:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">rel_fb:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="nl">dis_dev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">mb862xx_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mb862xxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/* display off */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GC_DCM01_DEN</span> <span class="o">|</span> <span class="n">GC_DCM01_L0E</span><span class="p">);</span>
	<span class="n">outreg</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">GC_DCM1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">BT_CARMINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">GC_CTRL_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">GC_CTRL_CLK_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outreg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">GC_IMASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mb862xx_i2c_exit</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dispregs</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb_base</span><span class="p">);</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">mb862xxfb_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">mb862xx_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mb862xx_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mb862xx_pci_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mb862xxfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_FB_MB862XX_LIME)</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">of_platform_mb862xxfb_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_FB_MB862XX_PCI_GDC)</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb862xxfb_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">mb862xxfb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_FB_MB862XX_LIME)</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">of_platform_mb862xxfb_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_FB_MB862XX_PCI_GDC)</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb862xxfb_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mb862xxfb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mb862xxfb_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Fujitsu MB862xx Framebuffer driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Anatolij Gustschin &lt;agust@denx.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
